
; /* Start:"a:4:{s:4:"full";s:97:"/bitrix/components/bitrix/main.interface.buttons/templates/.default/script.min.js?157530074640309";s:6:"source";s:77:"/bitrix/components/bitrix/main.interface.buttons/templates/.default/script.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
BX.namespace("BX.Main");if(typeof BX.Main.interfaceButtons==="undefined"){BX.Main.interfaceButtons=function(t,e){this.classItem="main-buttons-item";this.classItemSublink="main-buttons-item-sublink";this.classItemText="main-buttons-item-text";this.classItemCounter="main-buttons-item-counter";this.classItemIcon="main-buttons-item-icon";this.classItemMore="main-buttons-item-more";this.classOnDrag="main-buttons-drag";this.classDropzone="main-buttons-submenu-dropzone";this.classSeporator="main-buttons-submenu-separator";this.classHiddenLabel="main-buttons-hidden-label";this.classSubmenuItem="main-buttons-submenu-item";this.classItemDisabled="main-buttons-disabled";this.classItemOver="over";this.classItemActive="main-buttons-item-active";this.classSubmenu="main-buttons-submenu";this.classSecret="secret";this.classItemLocked="locked";this.submenuIdPrefix="main_buttons_popup_";this.childMenuIdPrefix="main_buttons_popup_child_";this.submenuWindowIdPrefix="menu-popup-";this.classSettingMenuItem="main-buttons-submenu-setting";this.classEditState="main-buttons-edit";this.classEditItemButton="main-buttons-item-edit-button";this.classDragItemButton="main-buttons-item-drag-button";this.classSettingsApplyButton="main-buttons-submenu-settings-apply";this.classSettingsResetButton="main-buttons-submenu-settings-reset";this.classSetHome="main-buttons-set-home";this.classSetHide="main-buttons-set-hide";this.classManage="main-buttons-manage";this.classContainer="main-buttons";this.classSubmenuNoHiddenItem="main-buttons-submenu-item-no-hidden";this.classDefaultSubmenuItem="menu-popup-item";this.classInner="main-buttons-inner-container";this.listContainer=null;this.pinContainer=null;this.dragItem=null;this.overItem=null;this.moreButton=null;this.messages=null;this.licenseParams=null;this.isSubmenuShown=false;this.isSubmenuShownOnDragStart=false;this.isSettingsEnabled=true;this.containerId=e.containerId;this.tmp={};this.init(t,e);return{getItemById:BX.delegate(this.getItemById,this),getAllItems:BX.delegate(this.getAllItems,this),getHiddenItems:BX.delegate(this.getHiddenItems,this),getVisibleItems:BX.delegate(this.getVisibleItems,this),getDisabledItems:BX.delegate(this.getDisabledItems,this),getMoreButton:BX.delegate(this.getMoreButton,this),adjustMoreButtonPosition:BX.delegate(this.adjustMoreButtonPosition,this),showSubmenu:BX.delegate(this.showSubmenu,this),closeSubmenu:BX.delegate(this.closeSubmenu,this),refreshSubmenu:BX.delegate(this.refreshSubmenu,this),getCurrentSettings:BX.delegate(this.getCurrentSettings,this),saveSettings:BX.delegate(this.saveSettings,this),setCounterValueByItemId:BX.delegate(this.setCounterValueByItemId,this),getCounterValueByItemId:BX.delegate(this.getCounterValueByItemId,this),updateCounter:BX.delegate(this.updateCounter,this),getActive:BX.delegate(this.getActive,this),isEditEnabled:BX.delegate(this.isEditEnabled,this),isActiveInMoreMenu:BX.delegate(this.isActiveInMoreMenu,this),isSettingsEnabled:this.isSettingsEnabled,classes:{item:this.classItem,itemText:this.classItemText,itemCounter:this.classItemCounter,itemIcon:this.classItemIcon,itemDisabled:this.classItemDisabled,itemOver:this.classItemOver,itemActive:this.classItemActive,itemLocked:this.classItemLocked,submenu:this.classSubmenu,submenuItem:this.classSubmenuItem,containerOnDrag:this.classOnDrag,classSettingMenuItem:this.classSettingMenuItem},itemsContainer:this.listContainer,itemsContainerId:this.listContainer.id}};BX.Main.interfaceButtons.prototype={init:function(t,e){this.listContainer=BX(this.getId());if(!BX.type.isPlainObject(e)){throw"BX.MainButtons: params is not Object"}if(!("containerId"in e)||!BX.type.isNotEmptyString(e.containerId)){throw"BX.MainButtons: containerId not set in params"}if(!BX.type.isDomNode(this.listContainer)){throw"BX.MainButtons: #"+e.containerId+" is not dom node"}if("classes"in e&&BX.type.isPlainObject(e.classes)){this.setCustomClasses(e.classes)}if("messages"in e&&BX.type.isPlainObject(e.messages)){this.setMessages(e.messages)}if("licenseWindow"in e&&BX.type.isPlainObject(e.licenseWindow)){this.setLicenseWindowParams(e.licenseWindow)}if("disableSettings"in e&&e.disableSettings==="true"){this.isSettingsEnabled=false;this.visibleControlMoreButton()}this.moreButton=this.getMoreButton();this.listChildItems={};if(this.isSettingsEnabled){this.dragAndDropInit()}this.adjustMoreButtonPosition();this.bindOnClickOnMoreButton();this.bindOnScrollWindow();this.setContainerHeight();BX.bind(this.getContainer(),"click",BX.delegate(this._onDocumentClick,this));BX.addCustomEvent("onPullEvent-main",BX.delegate(this._onPush,this));this.updateMoreButtonCounter();if(this.isActiveInMoreMenu()){this.activateItem(this.moreButton)}var i=this.getVisibleItems();var s=BX.type.isArray(i)&&i.length>0?i[0]:null;var n=BX.Buttons.Utils.getByTag(s,"a");if(!BX.type.isDomNode(n)){return}var a=n.getAttribute("href");if(a.charAt(0)==="?"){a=n.pathname+n.search}if(!this.lastHomeLink){this.lastHomeLink=a}this.bindOnResizeFrame()},_onDocumentClick:function(t){var e=this.getItem(t);var i,s,n,a,o,u;if(this.isDragButton(t.target)){t.preventDefault();t.stopPropagation()}if(BX.type.isDomNode(e)){if(this.isSettings(e)){this.enableEdit();BX.hide(this.getSettingsButton());BX.show(this.getSettingsApplyButton());return false}if(this.isApplySettingsButton(e)){t.preventDefault();t.stopPropagation();this.disableEdit();BX.show(this.getSettingsButton());BX.hide(this.getSettingsApplyButton());return false}if(this.isResetSettingsButton(e)){this.resetSettings();return false}if(this.isLocked(e)){t.preventDefault();this.showLicenseWindow();return false}if(this.isEditButton(t.target)){var r,h;t.preventDefault();t.stopPropagation();if(this.isSubmenuItem(e)){e=this.getItemAlias(e)}try{r=JSON.parse(BX.data(e,"item"))}catch(t){}h=this.getItemEditMenu();if(h&&h.popupWindow.isShown()&&this.lastEditNode===e){h.popupWindow.close()}else{this.showItemEditMenu(r,t.target)}this.lastEditNode=e;return false}if(this.isSetHide(e)){o=this.getVisibleItems();u=BX.type.isArray(o)?o.length:null;a=this.editItemData.ID.replace(this.listContainer.id+"_","");s=this.getItemById(a);n=this.getItemAlias(s);s=this.isVisibleItem(s)?s:n;if(this.isDisabled(n)){this.enableItem(n)}else if(!this.isDisabled(n)&&u>2){this.disableItem(n)}if(u===2){BX.onCustomEvent(window,"BX.Main.InterfaceButtons:onHideLastVisibleItem",[s,this])}this.refreshSubmenu();this.saveSettings();this.adjustMoreButtonPosition();if(this.isEditEnabled()){this.enableEdit();BX.hide(this.getSettingsButton());BX.show(this.getSettingsApplyButton())}this.editMenu.popupWindow.close();return false}if(this.isSetHome(e)){a=this.editItemData.ID.replace(this.listContainer.id+"_","");s=this.getItemById(a);n=this.getItemAlias(s);if(this.isDisabled(n)){this.enableItem(n)}this.listContainer.insertBefore(s,BX.firstChild(this.listContainer));this.adjustMoreButtonPosition();this.refreshSubmenu();this.saveSettings();if(this.isEditEnabled()){this.enableEdit();BX.hide(this.getSettingsButton());BX.show(this.getSettingsApplyButton())}this.editMenu.popupWindow.close();return false}if(!this.isSublink(t.target)){i=this.dataValue(e,"onclick");if(BX.type.isNotEmptyString(i)){t.preventDefault();this.execScript(i)}}}if(this.isEditEnabled()){this.getSubmenu().popupWindow.setAutoHide(false)}},isActiveInMoreMenu:function(){var t=this.getHiddenItems();var e=this.getDisabledItems();var i=t.concat(e);return i.some(function(t){var e;try{e=JSON.parse(BX.data(t,"item"))}catch(t){}return BX.type.isPlainObject(e)&&("IS_ACTIVE"in e&&e.IS_ACTIVE===true||e.IS_ACTIVE==="true"||e.IS_ACTIVE==="Y")},this)},_onPush:function(t,e){if(t==="user_counter"&&e&&BX.message("SITE_ID")in e){var i=e[BX.message("SITE_ID")];for(var s in i){if(i.hasOwnProperty(s)){this.updateCounter(s,i[s])}}}},bindOnScrollWindow:function(){BX.bind(window,"scroll",BX.delegate(this._onScroll,this))},getActive:function(){var t=this.getAllItems();var e,i;var s=null;if(BX.type.isArray(t)){t.forEach(function(t){try{e=JSON.parse(BX.data(t,"item"))}catch(t){e=null}if(BX.type.isPlainObject(e)&&"IS_ACTIVE"in e&&(e.IS_ACTIVE===true||e.IS_ACTIVE==="true"||e.IS_ACTIVE==="Y")){s=e}},this)}if(BX.type.isPlainObject(s)){i=BX(s.ID);if(BX.type.isDomNode(i)){s.NODE=i}else{s.NODE=null}}return s},isSetHome:function(t){return BX.hasClass(t,this.classSetHome)},isSetHide:function(t){return BX.hasClass(t,this.classSetHide)},getSettingsButton:function(){return BX.Buttons.Utils.getByClass(this.getSubmenuContainer(),this.classSettingMenuItem)},getSettingsApplyButton:function(){return BX.Buttons.Utils.getByClass(this.getSubmenuContainer(),this.classSettingsApplyButton)},isApplySettingsButton:function(t){return BX.hasClass(t,this.classSettingsApplyButton)},enableEdit:function(){var t=this.getSubmenu();if(t&&"popupWindow"in t){t.popupWindow.setAutoHide(false)}BX.addClass(this.listContainer,this.classEditState);BX.addClass(this.getSubmenuContainer(),this.classEditState);this.isEditEnabledState=true},disableEdit:function(){var t=this.getSubmenu();if(t&&"popupWindow"in t){t.popupWindow.setAutoHide(true)}BX.removeClass(this.listContainer,this.classEditState);BX.removeClass(this.getSubmenuContainer(),this.classEditState);this.isEditEnabledState=false},isEditEnabled:function(){return this.isEditEnabledState},showItemEditMenu:function(t,e){if(BX.type.isPlainObject(t)&&"ID"in t){var i=[this.listContainer.id,"_edit_item"].join("");var s=BX.PopupMenu.getMenuById(i);if(s){BX.PopupMenu.destroy(i)}s=this.createItemEditMenu(t,i,e);s.popupWindow.show()}},getContainer:function(){if(!BX.type.isDomNode(this.container)){this.container=BX(this.containerId).parentNode}return this.container},getItemEditMenu:function(){return BX.PopupMenu.getMenuById([this.listContainer.id,"_edit_item"].join(""))},createItemEditMenu:function(t,e,i){var s;var n=[{text:this.message("MIB_SET_HOME"),className:"main-buttons-set-home menu-popup-no-icon"}];var a=t.ID.replace(this.listContainer.id+"_","");var o=this.getItemById(a);if(this.isDisabled(o)){n.push({text:this.message("MIB_SET_SHOW"),className:"main-buttons-set-hide menu-popup-no-icon"})}else{n.push({text:this.message("MIB_SET_HIDE"),className:"main-buttons-set-hide menu-popup-no-icon"})}var u=BX.pos(i);var r={menuId:e,anchor:i,menuItems:n,settings:{autoHide:true,offsetTop:0,offsetLeft:u.width/2,zIndex:20,angle:{position:"top",offset:u.width/2}}};s=BX.PopupMenu.create(r.menuId,r.anchor,r.menuItems,r.settings);if(this.isVisibleItem(o)){t.NODE=o}else{t.NODE=this.getItemAlias(o)}this.editItemData=t;if("menuItems"in s&&BX.type.isArray(s.menuItems)){s.menuItems.forEach(function(t){BX.bind(t.layout.item,"click",BX.delegate(this._onDocumentClick,this))},this)}BX.onCustomEvent(window,"BX.Main.InterfaceButtons:onBeforeCreateEditMenu",[s,t,this]);this.editMenu=s;return s},setHome:function(){var t=this.getVisibleItems();var e=BX.type.isArray(t)&&t.length>0?t[0]:null;var i=BX.Buttons.Utils.getByTag(e,"a");if(!BX.type.isDomNode(i)){return}var s=i.getAttribute("href");if(s.charAt(0)==="?"){s=i.pathname+i.search}if(!this.lastHomeLink){this.lastHomeLink=s}if(this.lastHomeLink!==s){BX.userOptions.save("ui",this.listContainer.id,"firstPageLink",s);BX.onCustomEvent("BX.Main.InterfaceButtons:onFirstItemChange",[s,e])}this.lastHomeLink=s},isEditButton:function(t){return BX.hasClass(t,this.classEditItemButton)},isDragButton:function(t){return BX.hasClass(t,this.classDragItemButton)},isResetSettingsButton:function(t){return BX.hasClass(t,this.classSettingsResetButton)},getContainerHeight:function(){var t=this.getAllItems().map(function(t){var e=getComputedStyle(t);return BX.height(t)+parseInt(e.marginTop)+parseInt(e.marginBottom)});return Math.max.apply(Math,t)},setContainerHeight:function(){var t=this.getContainerHeight();var e=8;BX.height(this.listContainer,t-e)},setLicenseWindowParams:function(t){this.licenseParams=t||{}},message:function(t){var e;try{e=this.messages[t]}catch(t){e=""}return e},setCustomClasses:function(t){if(!BX.type.isPlainObject(t)){return}this.classItem=t.item||this.classItem;this.classItemSublink=t.itemSublink||this.classItemSublink;this.classItemText=t.itemText||this.classItemText;this.classItemCounter=t.itemCounter||this.classItemCounter;this.classItemIcon=t.itemIcon||this.classItemIcon;this.classItemMore=t.itemMore||this.classItemMore;this.classItemOver=t.itemOver||this.classItemOver;this.classItemActive=t.itemActive||this.classItemActive;this.classItemDisabled=t.itemDisabled||this.classItemDisabled;this.classOnDrag=t.onDrag||this.classOnDrag;this.classDropzone=t.dropzone||this.classDropzone;this.classSeporator=t.separator||this.classSeporator;this.classSubmenuItem=t.submenuItem||this.classSubmenuItem;this.classSubmenu=t.submenu||this.classSubmenu;this.classSecret=t.secret||this.classSecret;this.classItemLocked=t.itemLocked||this.classItemLocked},setMessages:function(t){if(!BX.type.isPlainObject(t)){return}this.messages=t},makeFullItemId:function(t){if(!BX.type.isNotEmptyString(t)){return}return[this.listContainer.id,t.replace("-","_")].join("_")},getItemById:function(t){var e=null;var i;if(BX.type.isNotEmptyString(t)){i=this.makeFullItemId(t);e=BX.Buttons.Utils.getBySelector(this.listContainer,"#"+i)}return e},getItemCounterObject:function(t){var e=null;if(BX.type.isDomNode(t)){e=BX.Buttons.Utils.getByClass(t,this.classItemCounter)}return e},setCounterValue:function(t,e){var i=this.getItemCounterObject(t);if(BX.type.isDomNode(i)){i.innerText=e>99?"99+":e>0?e:"";t.dataset.counter=e}this.updateMoreButtonCounter()},updateCounter:function(t,e){if(t.indexOf("crm")===0&&e<0){return}var i,s,n;var a=null;var o=this.getAllItems();if(BX.type.isArray(o)){o.forEach(function(e){try{s=JSON.parse(BX.data(e,"item"))}catch(t){s={}}if(BX.type.isPlainObject(s)&&"COUNTER_ID"in s&&s.COUNTER_ID===t){a=e}},this)}i=this.getItemCounterObject(a);if(BX.type.isDomNode(i)){a=this.getItem(i);i.innerText=e>99?"99+":e>0?e:"";a.dataset.counter=e}n=this.getItemAlias(a);if(BX.type.isDomNode(n)){i=this.getItemCounterObject(n);if(BX.type.isDomNode(i)){i.innerText=e>99?"99+":e>0?e:"";n.dataset.counter=e}}this.updateMoreButtonCounter()},setCounterValueByItemId:function(t,e){var i=e!==null?parseFloat(e):null;var s,n;if(!BX.type.isNotEmptyString(t)){throw"Bad first arg. Need string as item id"}if(i!==null&&!BX.type.isNumber(i)){throw"Bad two arg. Need number counter value - Integer, Float or string with number"}s=this.getItemById(t);if(!BX.type.isDomNode(s)){console.info("Not found node with id #"+t);return}n=this.getItemAlias(s);this.setCounterValue(s,i);this.setCounterValue(n,i)},getCounterValueByItemId:function(t){var e,i;var s=NaN;if(!BX.type.isNotEmptyString(t)){throw"Bad first arg. Need string item id"}else{e=this.getItemById(t);s=this.dataValue(e,"counter");s=parseFloat(s);if(!BX.type.isNumber(s)){i=this.getItemCounterObject(e);s=parseFloat(i.innerText)}}return s},setMoreButtonCounter:function(t){var e=this.getItemCounterObject(this.moreButton);var i=t>99?"99+":t>0?t:"";i=parseInt(i);i=BX.type.isNumber(i)?i:"";e.innerText=i},bindOnClickOnMoreButton:function(){BX.bind(this.moreButton,"click",BX.delegate(this._onClickMoreButton,this))},bindOnResizeFrame:function(){window.frames["maininterfacebuttonstmpframe-"+this.getId()].onresize=BX.throttle(this._onResizeHandler,20,this)},getId:function(){return BX.Buttons.Utils.getByClass(this.getContainer(),this.classInner).id},getAllItems:function(){return BX.Buttons.Utils.getByClass(this.listContainer,this.classItem,true)},getVisibleItems:function(){var t=this.getAllItems();var e=this;var i=[];if(t&&t.length){i=t.filter(function(t){return e.isVisibleItem(t)&&!e.isDisabled(t)})}return i},getHiddenItems:function(){var t=this.getAllItems();var e=[];var i=this;if(t&&t.length){e=t.filter(function(t){return!i.isVisibleItem(t)&&!i.isDisabled(t)})}return e},getDisabledItems:function(){return this.getAllItems().filter(function(t){return this.isDisabled(t)},this)},getMoreButton:function(){var t=null;this.getAllItems().forEach(function(e){!t&&BX.hasClass(e,this.classItemMore)&&(t=e)},this);return t},getLastVisibleItem:function(){var t=this.getVisibleItems();var e=null;if(BX.type.isArray(t)&&t.length){e=t[t.length-1]}if(!BX.type.isDomNode(e)){e=null}return e},adjustMoreButtonPosition:function(){var t=this.getLastVisibleItem();var e=this.isMoreButton(t);if(!e){this.listContainer.insertBefore(this.moreButton,t)}this.updateMoreButtonCounter()},getSubmenuId:function(t){var e="";if(BX.type.isDomNode(this.listContainer)&&BX.type.isNotEmptyString(this.listContainer.id)){e=this.submenuIdPrefix+this.listContainer.id}if(t){e=this.submenuWindowIdPrefix+e}return e},getChildMenuId:function(){var t="";if(BX.type.isDomNode(this.listContainer)&&BX.type.isNotEmptyString(this.listContainer.id)){t=this.childMenuIdPrefix+this.listContainer.id}return t},getSubmenuItemText:function(t){var e,i,s;if(!BX.type.isDomNode(t)){return null}e=this.findChildrenByClassName(t,this.classItemText);i=this.findChildrenByClassName(t,this.classItemCounter);if(BX.type.isDomNode(i)&&BX.type.isDomNode(e)){i.dataset.counter=this.dataValue(t,"counter");s=e.outerHTML+i.outerHTML}else{e=this.dataValue(t,"text");i=this.dataValue(t,"counter");s=e}return s},getChildMenuItemText:function(t){var e,i,s;if(!BX.type.isDomNode(t)){return null}e=this.findChildrenByClassName(t,this.classItemText);i=this.findChildrenByClassName(t,this.classItemCounter);if(BX.type.isDomNode(i)&&BX.type.isDomNode(e)){i.dataset.counter=this.dataValue(t,"counter");s=e.outerHTML+i.outerHTML}else{e=this.dataValue(t,"text");s=e}return s},getLockedClass:function(t){var e="";if(BX.type.isDomNode(t)&&this.isLocked(t)){e=this.classItemLocked}return e},getSubmenuItems:function(){var t=this.getAllItems();var e=this.getHiddenItems();var i=this.getDisabledItems();var s=[];var n,a;if(t.length){t.forEach(function(t){if(e.indexOf(t)===-1&&i.indexOf(t)===-1){s.push({text:this.getSubmenuItemText(t),href:this.dataValue(t,"url"),onclick:this.dataValue(t,"onclick"),title:t.getAttribute("title"),className:[this.classSubmenuItem,this.getIconClass(t),this.classSecret,this.getAliasLink(t),this.getLockedClass(t)].join(" ")})}},this)}if(e.length){e.forEach(function(t){try{n=JSON.parse(this.dataValue(t,"item"))}catch(t){n=null}a=[this.classSubmenuItem,this.getIconClass(t),this.getAliasLink(t),this.getLockedClass(t)];if(BX.type.isPlainObject(n)&&("IS_ACTIVE"in n&&n.IS_ACTIVE===true||n.IS_ACTIVE==="true"||n.IS_ACTIVE==="Y")){a.push(this.classItemActive)}s.push({text:this.getSubmenuItemText(t),href:this.dataValue(t,"url"),onclick:this.dataValue(t,"onclick"),title:t.getAttribute("title"),className:a.join(" "),items:this.getChildMenuItems(t)})},this)}if(this.isSettingsEnabled){s.push({text:"<span>"+this.message("MIB_HIDDEN")+"</span>",className:[this.classSeporator,this.classSubmenuItem,this.classHiddenLabel].join(" ")});if(!i.length){s.push({text:"<span>"+this.message("MIB_NO_HIDDEN")+"</span>",className:[this.classSubmenuItem,this.classSubmenuNoHiddenItem].join(" ")})}if(i.length){i.forEach(function(t){try{n=JSON.parse(this.dataValue(t,"item"))}catch(t){n=null}a=[this.classSubmenuItem,this.classItemDisabled,this.getIconClass(t),this.getAliasLink(t),this.getLockedClass(t)];if(BX.type.isPlainObject(n)&&("IS_ACTIVE"in n&&n.IS_ACTIVE===true||n.IS_ACTIVE==="true"||n.IS_ACTIVE==="Y")){a.push(this.classItemActive)}s.push({text:this.getSubmenuItemText(t),href:this.dataValue(t,"url"),onclick:this.dataValue(t,"onclick"),title:t.getAttribute("title"),className:a.join(" "),items:this.getChildMenuItems(t)})},this)}s.push({text:"<span>"+this.message("MIB_MANAGE")+"</span>",className:[this.classSeporator,this.classSubmenuItem,this.classHiddenLabel,this.classManage].join(" ")});s.push({text:this.message("MIB_SETTING_MENU_ITEM"),className:[this.classSettingMenuItem,this.classSubmenuItem].join(" ")});s.push({text:this.message("MIB_APPLY_SETTING_MENU_ITEM"),className:[this.classSettingsApplyButton,this.classSubmenuItem].join(" ")});s.push({text:this.message("MIB_RESET_SETTINGS"),className:[this.classSettingsResetButton,this.classSubmenuItem].join(" ")})}return s},getChildMenuItems:function(t){var e;try{e=JSON.parse(this.dataValue(t,"item"))}catch(t){e=null}if(!BX.type.isPlainObject(e)){return[]}if(!BX.type.isArray(this.listChildItems[t.id])){var i={};this.setListAllItems(i,e);var s=this.getListItems(i,"");if(s.length){this.listChildItems[t.id]=BX.type.isArray(s[0].items)?s[0].items:[]}}return this.listChildItems[t.id]},setListAllItems:function(t,e){var i=[];if(BX.type.isPlainObject(e)){i.push(e)}else{i=e}i.forEach(function(e){t[e["ID"].replace(this.containerId+"_","")]=e;if(BX.type.isArray(e["ITEMS"])){this.setListAllItems(t,e["ITEMS"])}},this)},getListItems:function(t,e){var i=[];for(var s in t){if(!t.hasOwnProperty(s)){continue}var n=t[s];if(n["PARENT_ID"]===e){var a,o={text:n["TEXT"],href:n["URL"],onclick:n["ON_CLICK"],title:n["TITLE"]};a=this.getListItems(t,s);if(a.length){o.items=a}i.push(o);delete t[s]}}return i},getSubmenuArgs:function(){var t=this.getSubmenuId();var e=this.moreButton;var i=BX.pos(e);var s=this.getSubmenuItems();var n={autoHide:true,offsetLeft:i.width/2-80,angle:{position:"top",offset:100},zIndex:0,events:{onPopupClose:BX.delegate(this._onSubmenuClose,this)}};return[t,e,s,n]},getChildMenuArgs:function(t){var e=this.getChildMenuId();var i=this.getChildMenuItems(t);if(!i||BX.type.isArray(i)&&!i.length){return[]}var s={autoHide:true,angle:true,offsetLeft:t.getBoundingClientRect().width/2};return[e,t,i,s]},visibleControlMoreButton:function(){var t=this.getHiddenItems();if(!t.length||t.length===1&&this.isMoreButton(t[0])){this.getMoreButton().style.display="none"}else{this.getMoreButton().style.display=""}},createSubmenu:function(){var t=BX.PopupMenu.create.apply(BX.PopupMenu,this.getSubmenuArgs());if(this.isSettingsEnabled){this.dragAndDropInitInSubmenu()}t.menuItems.forEach(function(t){BX.bind(t.layout.item,"click",BX.delegate(this._onDocumentClick,this))},this);return t},createChildMenu:function(t){return BX.PopupMenu.create.apply(BX.PopupMenu,this.getChildMenuArgs(t))},showSubmenu:function(){var t=this.getSubmenu();if(t!==null){t.popupWindow.show()}else{this.destroySubmenu();t=this.createSubmenu();t.popupWindow.show()}this.setSubmenuShown(true);this.activateItem(this.moreButton);if(this.isEditEnabled()){t.popupWindow.setAutoHide(false)}},showChildMenu:function(t){var e=BX.PopupMenu.getMenuById(this.getChildMenuId()),i=null;if(e&&e.bindElement){if(e.bindElement.id!==t.id){this.destroyChildMenu(t);i=this.createChildMenu(t);i.popupWindow.show()}else{e.popupWindow.show()}}else{this.destroyChildMenu(t);i=this.createChildMenu(t);i.popupWindow.show()}},closeSubmenu:function(){var t=this.getSubmenu();if(t===null){return}t.popupWindow.close();if(!this.isActiveInMoreMenu()){this.deactivateItem(this.moreButton)}this.setSubmenuShown(false)},closeChildMenu:function(t){var e=this.getChildMenu(t);if(e===null){return}e.popupWindow.close()},getSubmenu:function(){return BX.PopupMenu.getMenuById(this.getSubmenuId())},getChildMenu:function(){return BX.PopupMenu.getMenuById(this.getChildMenuId())},destroySubmenu:function(){BX.PopupMenu.destroy(this.getSubmenuId())},destroyChildMenu:function(){BX.PopupMenu.destroy(this.getChildMenuId())},refreshSubmenu:function(){var t=this.getSubmenu();var e;if(t===null){return}e=this.getSubmenuArgs();if(BX.type.isArray(e)){this.destroySubmenu();this.createSubmenu();this.showSubmenu()}},setSubmenuShown:function(t){this.isSubmenuShown=false;if(BX.type.isBoolean(t)){this.isSubmenuShown=t}},activateItem:function(t){if(!BX.type.isDomNode(t)){return}if(!BX.hasClass(t,this.classItemActive)){BX.addClass(t,this.classItemActive)}},deactivateItem:function(t){if(!BX.type.isDomNode(t)){return}if(BX.hasClass(t,this.classItemActive)){BX.removeClass(t,this.classItemActive)}},getCurrentSettings:function(){var t={};this.getAllItems().forEach(function(e,i){t[e.id]={sort:i,isDisabled:this.isDisabled(e)}},this);return t},saveSettings:function(){var t=this.getCurrentSettings();var e="settings";var i;if(!BX.type.isPlainObject(t)){return}if(BX.type.isDomNode(this.listContainer)){if("id"in this.listContainer){i=this.listContainer.id;t=JSON.stringify(t);BX.userOptions.save("ui",i,e,t);this.setHome()}}},resetSettings:function(){var t=null;var e=BX.PopupWindowManager.create(this.listContainer.id+"_reset_popup",null,{content:this.message("MIB_RESET_ALERT"),autoHide:false,overlay:true,closeByEsc:true,closeIcon:true,draggable:{restrict:true},titleBar:this.message("MIB_RESET_SETTINGS"),buttons:[t=new BX.PopupWindowButton({text:this.message("MIB_RESET_BUTTON"),className:"popup-window-button-create",events:{click:function(){if(BX.hasClass(t.buttonNode,"popup-window-button-wait")){return}BX.addClass(t.buttonNode,"popup-window-button-wait");this.handleResetSettings(function(i){if(i){BX.removeClass(t.buttonNode,"popup-window-button-wait");e.setContent(i)}else{var s="settings";BX.userOptions.save("ui",this.listContainer.id,s,JSON.stringify({}));BX.userOptions.save("ui",this.listContainer.id,"firstPageLink","");window.location.reload()}}.bind(this))}.bind(this)}}),new BX.PopupWindowButtonLink({text:this.message("MIB_CANCEL_BUTTON"),className:"popup-window-button-link-cancel",events:{click:function(){this.popupWindow.close()}}})]});e.show()},handleResetSettings:function(t){var e=[];BX.onCustomEvent("BX.Main.InterfaceButtons:onBeforeResetMenu",[e,this]);var i=new BX.Promise;var s=i;for(var n=0;n<e.length;n++){i=i.then(e[n])}i.then(function(e){t(null,e)},function(e){t(e,null)});s.fulfill()},moveButtonAlias:function(t){var e,i;if(!t||!this.dragItem){return}e=this.getItemAlias(this.dragItem);i=this.getItemAlias(t);if(this.isListItem(e)){if(!i){this.listContainer.appendChild(e)}else{this.listContainer.insertBefore(e,i)}}},moveButton:function(t){var e;if(!BX.type.isDomNode(t)||!BX.type.isDomNode(this.dragItem)){return}if(this.isListItem(t)){if(this.isDisabled(this.dragItem)){this.dragItem.dataset.disabled="false"}if(BX.type.isDomNode(t)){this.listContainer.insertBefore(this.dragItem,t)}else{this.listContainer.appendChild(this.dragItem)}}if(this.isSubmenuItem(t)){if(this.isDisabled(this.dragItem)&&!this.isDisabled(t)){this.enableItem(this.dragItem)}e=this.getSubmenuContainer();e.insertBefore(this.dragItem,t)}},getSubmenuContainer:function(){var t=this.getSubmenu();var e=null;if(t!==null){e=t.itemsContainer}return e},findNextSiblingByClass:function(t,e){var i=t;for(;!!t;t=t.nextElementSibling){if(e){if(BX.hasClass(t,e)&&t!==i){return t}}else{return null}}},findParentByClassName:function(t,e){for(;t&&t!==document;t=t.parentNode){if(e){if(BX.hasClass(t,e)){return t}}else{return null}}},findChildrenByClassName:function(t,e){var i=null;if(BX.type.isDomNode(t)&&BX.type.isNotEmptyString(e)){i=BX.Buttons.Utils.getByClass(t,e)}return i},dragAndDropInit:function(){this.getAllItems().forEach(function(t,e){if(!this.isSeparator(t)&&!this.isSettings(t)&&!this.isApplySettingsButton(t)&&!this.isResetSettingsButton(t)){t.setAttribute("draggable","true");t.setAttribute("tabindex","-1");t.dataset.link="item"+e;BX.bind(t,"dragstart",BX.delegate(this._onDragStart,this));BX.bind(t,"dragend",BX.delegate(this._onDragEnd,this));BX.bind(t,"dragenter",BX.delegate(this._onDragEnter,this));BX.bind(t,"dragover",BX.delegate(this._onDragOver,this));BX.bind(t,"dragleave",BX.delegate(this._onDragLeave,this));BX.bind(t,"drop",BX.delegate(this._onDrop,this))}BX.bind(t,"mouseover",BX.delegate(this._onMouse,this));BX.bind(t,"mouseout",BX.delegate(this._onMouse,this))},this)},dragAndDropInitInSubmenu:function(){var t=this.getSubmenu();var e=t.menuItems;e.forEach(function(t){if(!this.isSeparator(t.layout.item)&&!this.isSettings(t.layout.item)&&!this.isApplySettingsButton(t.layout.item)&&!this.isResetSettingsButton(t.layout.item)){t.layout.item.draggable=true;t.layout.item.dataset.sortable=true;BX.bind(t.layout.item,"dragstart",BX.delegate(this._onDragStart,this));BX.bind(t.layout.item,"dragenter",BX.delegate(this._onDragEnter,this));BX.bind(t.layout.item,"dragover",BX.delegate(this._onDragOver,this));BX.bind(t.layout.item,"dragleave",BX.delegate(this._onDragLeave,this));BX.bind(t.layout.item,"dragend",BX.delegate(this._onDragEnd,this));BX.bind(t.layout.item,"drop",BX.delegate(this._onDrop,this))}if(BX.hasClass(t.layout.item,this.classHiddenLabel)&&!BX.hasClass(t.layout.item,this.classManage)){BX.bind(t.layout.item,"dragover",BX.delegate(this._onDragOver,this))}},this)},getItem:function(t){if(!BX.type.isDomNode(t)){if(!t||!BX.type.isDomNode(t.target)){return null}}else{t={target:t}}var e=this.findParentByClassName(t.target,this.classItem);if(!BX.type.isDomNode(e)){e=this.findParentByClassName(t.target,this.classDefaultSubmenuItem)}return e},setOpacity:function(t){if(!BX.type.isDomNode(t)){return}BX.style(t,"opacity",".1")},unsetOpacity:function(t){if(!BX.type.isDomNode(t)){return}BX.style(t,"opacity","1")},setDragStyles:function(){BX.addClass(this.listContainer,this.classOnDrag);BX.addClass(BX(this.getSubmenuId(true)),this.classOnDrag);this.setOpacity(this.dragItem)},unsetDragStyles:function(){var t=this.getSubmenu();this.getAllItems().forEach(function(t){this.unsetOpacity(t);BX.removeClass(t,"over")},this);if(t&&"menuItems"in t&&BX.type.isArray(t.menuItems)&&t.menuItems.length){t.menuItems.forEach(function(t){this.unsetOpacity(t);BX.removeClass(t.layout.item,"over")},this)}BX.removeClass(this.listContainer,this.classOnDrag);BX.removeClass(BX(this.getSubmenuId(true)),this.classOnDrag)},getIconClass:function(t){var e="";if(BX.type.isDomNode(t)&&"dataset"in t&&"class"in t.dataset&&BX.type.isNotEmptyString(t.dataset.class)){e=t.dataset.class}return e},disableItem:function(t){var e=this.getItemAlias(t);if(t&&"dataset"in t){t.dataset.disabled="true";if(e){e.dataset.disabled="true"}}},enableItem:function(t){var e;if(!BX.type.isDomNode(t)){return}if(this.isSubmenuItem(t)){BX.removeClass(t,this.classItemDisabled);e=this.getItemAlias(t);if(BX.type.isDomNode(e)){e.dataset.disabled="false"}}},getAliasLink:function(t){return this.dataValue(t,"link")||""},getItemAlias:function(t){var e=null;if(!BX.type.isDomNode(t)){return e}var i=this.getAllItems();var s=this.isSubmenuItem(t);var n=this.isListItem(t);if(!s&&!n){return e}if(s){i.forEach(function(i){BX.hasClass(t,this.getAliasLink(i))&&(e=i)},this)}if(n){e=BX.Buttons.Utils.getByClass(document,this.getAliasLink(t))}return e},hideItem:function(t){!!t&&BX.addClass(t,this.classSecret)},showItem:function(t){!!t&&BX.removeClass(t,this.classSecret)},fakeDragItem:function(){var t=null;if(!BX.type.isDomNode(this.dragItem)||!BX.type.isDomNode(this.overItem)){return}if(this.isDragToSubmenu()){t=this.getItemAlias(this.dragItem);if(t!==this.dragItem){this.listContainer.appendChild(this.dragItem);this.dragItem=t;this.showItem(this.dragItem);this.adjustMoreButtonPosition();this.updateSubmenuItems();this.tmp.moved=false;this.tmp.movetToSubmenu=true;this.setOpacity(this.dragItem)}}if(this.isDragToList()&&!this.tmp.movetToSubmenu){t=this.getItemAlias(this.dragItem);if(t!==this.dragItem){this.hideItem(this.dragItem);this.dragItem=t;this.adjustMoreButtonPosition();this.updateSubmenuItems();this.setOpacity(this.dragItem)}}this.tmp.movetToSubmenu=false},updateSubmenuItems:function(){var t=this.getHiddenItems();var e=this.getDisabledItems();var i=this;var s=[];var n,a,o;n=this.getSubmenu();if(n===null){return}a=n.menuItems;if(!BX.type.isArray(a)||!a.length){return}s=e.concat(t);a.forEach(function(t){o=[].some.call(s,function(e){return BX.hasClass(t.layout.item,i.dataValue(e,"link"))||i.isDisabled(t.layout.item)||i.isSeparator(t.layout.item)||i.isDropzone(t.layout.item)});if(o||(i.isSettings(t.layout.item)||i.isApplySettingsButton(t.layout.item)||i.isResetSettingsButton(t.layout.item)||i.isNotHiddenItem(t.layout.item)||i.isSeparator(t.layout.item)||t.layout.item===i.dragItem)&&!i.isMoreButton(t.layout.item)){i.showItem(t.layout.item)}else{i.hideItem(t.layout.item)}})},isNotHiddenItem:function(t){return BX.hasClass(t,this.classSubmenuNoHiddenItem)},getNotHidden:function(){return BX.Buttons.Utils.getByClass(this.getSubmenuContainer(),this.classSubmenuNoHiddenItem)},setOverStyles:function(t){if(BX.type.isDomNode(t)&&!BX.hasClass(t,this.classItemOver)){BX.addClass(t,this.classItemOver)}},unsetOverStyles:function(t){if(BX.type.isDomNode(t)&&BX.hasClass(t,this.classItemOver)){BX.removeClass(t,this.classItemOver)}},dataValue:function(t,e){var i="";var s;if(BX.type.isDomNode(t)){s=BX.data(t,e);if(typeof s!=="undefined"){i=s}}return i},execScript:function(script){if(BX.type.isNotEmptyString(script)){eval(script)}},showLicenseWindow:function(){var t;if(!B24.licenseInfoPopup){return}t=B24.licenseInfoPopup;t.init({B24_LICENSE_BUTTON_TEXT:this.message("MIB_LICENSE_BUY_BUTTON"),B24_TRIAL_BUTTON_TEXT:this.message("MIB_LICENSE_TRIAL_BUTTON"),IS_FULL_DEMO_EXISTS:this.licenseParams.isFullDemoExists,HOST_NAME:this.licenseParams.hostname,AJAX_URL:this.licenseParams.ajaxUrl,LICENSE_ALL_PATH:this.licenseParams.licenseAllPath,LICENSE_DEMO_PATH:this.licenseParams.licenseDemoPath,FEATURE_GROUP_NAME:this.licenseParams.featureGroupName,AJAX_ACTIONS_URL:this.licenseParams.ajaxActionsUrl,B24_FEATURE_TRIAL_SUCCESS_TEXT:this.message("MIB_LICENSE_WINDOW_TRIAL_SUCCESS_TEXT")});t.show("main-buttons",this.message("MIB_LICENSE_WINDOW_HEADER_TEXT"),this.message("MIB_LICENSE_WINDOW_TEXT"))},_onDragStart:function(t){var e=this.getVisibleItems();var i=BX.type.isArray(e)?e.length:null;this.dragItem=this.getItem(t);if(!BX.type.isDomNode(this.dragItem)){return}if(i===2&&this.isListItem(this.dragItem)){t.preventDefault();BX.onCustomEvent(window,"BX.Main.InterfaceButtons:onHideLastVisibleItem",[this.dragItem,this]);return}if(this.isMoreButton(this.dragItem)||this.isSeparator(this.dragItem)||this.isNotHiddenItem(this.dragItem)){t.preventDefault();return}this.isSubmenuShownOnDragStart=!!this.isSubmenuShown;if(this.isListItem(this.dragItem)){this.showSubmenu()}this.setDragStyles();if(!this.isEditEnabled()){this.enableEdit()}},_onDragEnd:function(t){t.preventDefault();var e=this.getItem(t);var i,s;if(!BX.type.isDomNode(e)){return}this.unsetDragStyles();if(!this.isSubmenuShownOnDragStart){this.refreshSubmenu();if(!this.isEditEnabled()){this.closeSubmenu()}}else{this.refreshSubmenu()}i=BX.findNextSibling(this.dragItem,BX.delegate(function(t){return this.isVisibleItem(t)},this));s=BX.findPreviousSibling(this.dragItem,BX.delegate(function(t){return this.isVisibleItem(t)},this));if(BX.type.isDomNode(s)&&(BX.hasClass(s,this.classHiddenLabel)||this.isDisabled(s)&&this.isSubmenuItem(s))||(BX.type.isDomNode(i)&&BX.hasClass(i,this.classManage)||this.isDisabled(i)&&this.isSubmenuItem(i))){this.disableItem(this.dragItem);this.refreshSubmenu()}if(this.isEditEnabled()){this.enableEdit();BX.show(this.getSettingsApplyButton());BX.hide(this.getSettingsButton())}else{this.disableEdit();BX.hide(this.getSettingsApplyButton());BX.show(this.getSettingsButton())}this.updateMoreButtonCounter();this.saveSettings();this.dragItem=null;this.overItem=null;this.tmp.moved=false},updateMoreButtonCounter:function(){var t,e,i,s;t=this.getHiddenItems();s=this.getDisabledItems();t=t.concat(s);e=0;if(BX.type.isArray(t)){t.forEach(function(t){e+=parseInt(this.dataValue(t,"counter"))||0},this)}if(BX.type.isNumber(e)){this.setMoreButtonCounter(e)}},_onDragEnter:function(t){var e=this.getItem(t);if(BX.type.isDomNode(e)&&this.isNotHiddenItem(e)){this.setOverStyles(e)}},_onDragOver:function(t){t.preventDefault();var e=null;this.overItem=this.getItem(t);if(!BX.type.isDomNode(this.overItem)||!BX.type.isDomNode(this.dragItem)||this.overItem===this.dragItem||this.isNotHiddenItem(this.overItem)){return}this.fakeDragItem();if(this.isNext(t)&&this.isGoodPosition(t)&&!this.isMoreButton(this.overItem)){e=this.findNextSiblingByClass(this.overItem,this.classItem);if(this.isMoreButton(e)&&!this.tmp.moved){e=e.previousElementSibling;this.tmp.moved=true}if(!BX.type.isDomNode(e)){e=this.findNextSiblingByClass(this.overItem,this.classSubmenuItem)}if(BX.type.isDomNode(e)){this.moveButton(e);this.moveButtonAlias(e);this.adjustMoreButtonPosition();this.updateSubmenuItems()}}if(!this.isNext(t)&&this.isGoodPosition(t)&&!this.isMoreButton(this.overItem)||!this.isGoodPosition(t)&&this.isMoreButton(this.overItem)&&this.getVisibleItems().length===1){this.moveButton(this.overItem);this.moveButtonAlias(this.overItem);this.adjustMoreButtonPosition();this.updateSubmenuItems()}},_onDragLeave:function(t){var e=this.getItem(t);if(BX.type.isDomNode(e)){this.unsetOverStyles(t.target)}},_onDrop:function(t){var e=this.getItem(t);if(!BX.type.isDomNode(e)){return}if(this.isNotHiddenItem(e)||this.isDisabled(e)){this.disableItem(this.dragItem);this.adjustMoreButtonPosition()}this.unsetDragStyles();t.preventDefault()},getIndex:function(t,e){return[].indexOf.call(t||[],e)},_onSubmenuClose:function(){this.setSubmenuShown(false);if(this.isEditEnabled()){this.activateItem(this.moreButton)}else{if(!this.isActiveInMoreMenu()){this.deactivateItem(this.moreButton)}}},_onResizeHandler:function(){this.adjustMoreButtonPosition();this.updateSubmenuItems();if(!this.isSettingsEnabled){this.visibleControlMoreButton()}},_onClickMoreButton:function(t){t.preventDefault();this.showSubmenu()},_onMouse:function(t){var e=this.getItem(t);if(t.type==="mouseover"&&!BX.hasClass(e,this.classItemOver)){if(!BX.hasClass(e,this.classItemMore)){this.showChildMenu(e)}BX.addClass(e,this.classItemOver)}if(t.type==="mouseout"&&BX.hasClass(e,this.classItemOver)){BX.removeClass(e,this.classItemOver)}},getSettingsResetButton:function(){return BX.Buttons.Utils.getByClass(this.getSubmenuContainer(),this.classSettingsResetButton)},_onScroll:function(){if(BX.style(this.pinContainer,"position")==="fixed"){this.closeSubmenu()}},isDisabled:function(t){var e=false;if(BX.type.isDomNode(t)){e=this.dataValue(t,"disabled")==="true"||BX.hasClass(t,this.classItemDisabled)}return e},isSettings:function(t){var e=false;if(BX.type.isDomNode(t)){e=BX.hasClass(t,this.classSettingMenuItem)}return e},isLocked:function(t){var e=false;if(BX.type.isDomNode(t)){e=this.dataValue(t,"locked")==="true"||BX.hasClass(t,this.classItemLocked)}return e},isDropzone:function(t){return BX.hasClass(t,this.classDropzone)},isNext:function(t){var e=this.dragItem.getBoundingClientRect();var i=this.overItem.getBoundingClientRect();var s=getComputedStyle(this.dragItem);var n=parseInt(s.marginRight.replace("px",""));var a=null;if(this.isListItem(this.overItem)){a=t.clientX>i.left-n&&t.clientX>e.right}if(this.isSubmenuItem(this.overItem)){a=t.clientY>e.top}return a},isGoodPosition:function(t){var e=this.overItem;var i,s;if(!BX.type.isDomNode(e)){return false}i=e.getBoundingClientRect();if(this.isListItem(e)){s=this.isNext(t)&&t.clientX>=i.left+i.width/2||!this.isNext(t)&&t.clientX<=i.left+i.width/2}if(this.isSubmenuItem(e)){s=this.isNext(t)&&t.clientY>=i.top+i.height/2||!this.isNext(t)&&t.clientY<=i.top+i.height/2}return s},isSubmenuItem:function(t){return BX.hasClass(t,this.classSubmenuItem)},isVisibleItem:function(t){if(!BX.type.isDomNode(t)){return false}return t.offsetTop===0},isMoreButton:function(t){var e=false;if(BX.type.isDomNode(t)&&BX.hasClass(t,this.classItemMore)){e=true}return e},isListItem:function(t){var e=false;if(BX.type.isDomNode(t)&&BX.hasClass(t,this.classItem)){e=true}return e},isSublink:function(t){var e=false;if(BX.type.isDomNode(t)){e=BX.hasClass(t,this.classItemSublink)}return e},isSeparator:function(t){var e=false;if(BX.type.isDomNode(t)){e=BX.hasClass(t,this.classSeporator)}return e},isDragToSubmenu:function(){return!this.isSubmenuItem(this.dragItem)&&this.isSubmenuItem(this.overItem)},isDragToList:function(){return this.isSubmenuItem(this.dragItem)&&!this.isSubmenuItem(this.overItem)}}}if(typeof BX.Main.interfaceButtonsManager==="undefined"){BX.Main.interfaceButtonsManager={data:{},init:function(t){var e=null;if(!BX.type.isPlainObject(t)||!("containerId"in t)){throw"BX.Main.interfaceButtonsManager: containerId not set in params Object"}e=BX(t.containerId);if(BX.type.isDomNode(e)){this.data[t.containerId]=new BX.Main.interfaceButtons(e,t)}else{BX(BX.delegate(function(){e=BX(t.containerId);if(!BX.type.isDomNode(e)){throw"BX.Main.interfaceButtonsManager: container is not dom node"}this.data[t.containerId]=new BX.Main.interfaceButtons(e,t)},this))}},getById:function(t){var e=null;if(BX.type.isString(t)&&BX.type.isNotEmptyString(t)){try{e=this.data[t]}catch(t){}}return e},getObjects:function(){return this.data}}}
/* End */
;
; /* Start:"a:4:{s:4:"full";s:94:"/bitrix/components/bitrix/main.interface.buttons/templates/.default/utils.min.js?1575300746575";s:6:"source";s:76:"/bitrix/components/bitrix/main.interface.buttons/templates/.default/utils.js";s:3:"min";s:80:"/bitrix/components/bitrix/main.interface.buttons/templates/.default/utils.min.js";s:3:"map";s:80:"/bitrix/components/bitrix/main.interface.buttons/templates/.default/utils.map.js";}"*/
(function(){"use strict";BX.namespace("BX.Buttons");BX.Buttons.Utils={getByClass:function(e,t,l){var n=[];if(t){n=(e||document.body).getElementsByClassName(t);if(!l){n=n.length?n[0]:null}else{n=[].slice.call(n)}}return n},getByTag:function(e,t,l){var n=[];if(t){n=(e||document.body).getElementsByTagName(t);if(!l){n=n.length?n[0]:null}else{n=[].slice.call(n)}}return n},getBySelector:function(e,t,l){var n=[];if(t){if(!l){n=(e||document.body).querySelector(t)}else{n=(e||document.body).querySelectorAll(t);n=[].slice.call(n)}}return n}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:98:"/bitrix/components/bitrix/crm.entity.counter.panel/templates/.default/script.min.js?15753007515274";s:6:"source";s:79:"/bitrix/components/bitrix/crm.entity.counter.panel/templates/.default/script.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
if(typeof BX.CrmEntityCounterPanel==="undefined"){BX.CrmEntityCounterPanel=function(){this._id="";this._settings={};this._userId=0;this._userName="";this._entityTypeId=0;this._extras=null;this._codes=null;this._data=null;this._totalInfo=null;this._items=null;this._counterManager=null;this._container=null;this._valueContainer=null;this._stubContainer=null};BX.CrmEntityCounterPanel.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._userId=BX.prop.getInteger(this._settings,"userId",0);this._userName=BX.prop.getString(this._settings,"userName",this._userId);this._entityTypeId=BX.prop.getInteger(this._settings,"entityTypeId",0);this._extras=BX.prop.getObject(this._settings,"extras",{});this._codes=BX.prop.getArray(this._settings,"codes",[]);if(BX.CrmEntityType.isDefined(this._entityTypeId)){this._counterManager=BX.Crm.EntityCounterManager.create(this._id,{entityTypeId:this._entityTypeId,codes:this._codes,extras:this._extras,serviceUrl:BX.prop.getString(this._settings,"serviceUrl","")})}this._data=BX.prop.getObject(this._settings,"data",{});this._totalInfo=BX.prop.getObject(this._settings,"totalInfo",{});this._container=BX(this.getSetting("containerId",""));if(!BX.type.isElementNode(this._container)){throw"BX.CrmEntityCounterPanel: Could not find container."}this._valueContainer=BX(BX.prop.getString(this._settings,"valueContainerId"));if(!BX.type.isElementNode(this._valueContainer)){throw"BX.CrmEntityCounterPanel: Could not find valueContainer."}this._stubContainer=BX(BX.prop.getString(this._settings,"stubContainerId"));if(!BX.type.isElementNode(this._stubContainer)){throw"BX.CrmEntityCounterPanel: Could not find stubContainer."}this._items=[];var n=this._valueContainer.querySelectorAll("a.crm-counter-container");for(var i=0,r=n.length;i<r;i++){var s=n[i];var a=s.getAttribute("data-entity-counter-code");if(!BX.type.isNotEmptyString(a)){continue}var o=BX.prop.getObject(this._data,a,null);if(!o){continue}this._items.push(BX.CrmEntityCounterPanelItem.create(a,{parent:this,data:o,container:s}))}BX.addCustomEvent("onPullEvent-main",BX.delegate(this.onPullEvent,this))},getId:function(){return this._id},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},processItemSelection:function(t){var e=t.getTypeId();if(e>0){var n={userId:this._userId.toString(),userName:this._userName,counterTypeId:e.toString(),cancel:false};BX.onCustomEvent(window,"BX.CrmEntityCounterPanel:applyFilter",[this,n]);if(n.cancel){return false}}return true},onPullEvent:function(t,e){if(t!=="user_counter"){return}var n=false;var i=BX.prop.getObject(e,BX.message("SITE_ID"),{});for(var r in i){if(!i.hasOwnProperty(r)){continue}if(!(r.indexOf("crm")===0&&i[r]>=0)){continue}if(!this._data.hasOwnProperty(r)){continue}if(this._data[r].hasOwnProperty("VALUE")&&BX.convert.toNumber(this._data[r]["VALUE"])===BX.convert.toNumber(i[r])){continue}this._data[r]["VALUE"]=i[r];if(!n){n=true}}if(n){this.prepareTotalInfo();this.refreshLayout()}},prepareTotalInfo:function(){var t=0;for(var e=0,n=this._items.length;e<n;e++){t+=this._items[e].getValue()}var i=BX.CrmMessageHelper.getCurrent().prepareEntityNumberDeclension(t,BX.prop.getObject(this._settings,"entityNumberDeclensions",{}));this._totalInfo={value:t,caption:i}},refreshLayout:function(){var t=BX.prop.getInteger(this._totalInfo,"value",0);if(t>0){if(this._stubContainer.style.display!=="none"){this._stubContainer.style.display="none"}if(this._valueContainer.style.display!==""){this._valueContainer.style.display=""}for(var e=0,n=this._items.length;e<n;e++){this._items[e].refreshLayout()}}else{if(this._valueContainer.style.display!=="none"){this._valueContainer.style.display="none"}if(this._stubContainer.style.display!==""){this._stubContainer.style.display=""}}}};BX.CrmEntityCounterPanel.create=function(t,e){var n=new BX.CrmEntityCounterPanel;n.initialize(t,e);return n}}if(typeof BX.CrmEntityCounterPanelItem==="undefined"){BX.CrmEntityCounterPanelItem=function(){this._id="";this._settings={};this._parent=null;this._container=null;this._data=null;this._clickHandler=BX.delegate(this.onClick,this)};BX.CrmEntityCounterPanelItem.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._parent=BX.prop.get(this._settings,"parent");if(!this._parent){throw"BX.CrmEntityCounterPanelItem: Could not find parent."}this._data=BX.prop.getObject(this._settings,"data",{});this._container=BX.prop.getElementNode(this._settings,"container");if(!this._container){throw"BX.CrmEntityCounterPanelItem: Could not find container."}BX.bind(this._container,"click",this._clickHandler)},getId:function(){return this._id},getTypeId:function(){return BX.prop.getInteger(this._data,"TYPE_ID",0)},getValue:function(){return BX.prop.getInteger(this._data,"VALUE",0)},refreshLayout:function(){var t=this.getValue();var e=this._container.querySelector(".crm-counter-number");if(e){e.innerHTML=t}this._container.style.display=t>0?"":"none"},onClick:function(t){if(!this._parent.processItemSelection(this)){return BX.PreventDefault(t)}}};BX.CrmEntityCounterPanelItem.create=function(t,e){var n=new BX.CrmEntityCounterPanelItem;n.initialize(t,e);return n}}
/* End */
;
; /* Start:"a:4:{s:4:"full";s:82:"/bitrix/components/bitrix/crm.lead.menu/templates/.default/script.js?1575300750481";s:6:"source";s:68:"/bitrix/components/bitrix/crm.lead.menu/templates/.default/script.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/

function lead_delete(title, message, btnTitle, path)
{
	var d;
	d = new BX.CDialog({
		title: title,
		head: '',
		content: message,
		resizable: false,
		draggable: true,
		height: 70,
		width: 300
	});
	
	var _BTN = [	
		{
			title: btnTitle,
			id: 'crmOk',
			'action': function () 
			{
				window.location.href = path;
				BX.WindowManager.Get().Close();
			}
		},
		BX.CDialog.btnCancel
	];	
	d.ClearButtons();
	d.SetButtons(_BTN);
	d.Show();
}
/* End */
;
; /* Start:"a:4:{s:4:"full";s:92:"/bitrix/components/bitrix/crm.interface.toolbar/templates/title/script.min.js?15753007512568";s:6:"source";s:73:"/bitrix/components/bitrix/crm.interface.toolbar/templates/title/script.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
if(typeof BX.InterfaceToolBar==="undefined"){BX.InterfaceToolBar=function(){this._id="";this._settings=null;this._container=null;this._menuButton=null;this._menuPopup=null;this._isMenuOpened=false;this._autoClose=false};BX.InterfaceToolBar.prototype={initialize:function(e,t){this._id=e;this._settings=t?t:BX.CrmParamBag.create(null);this._menuButton=this._container=BX(this.getSetting("buttonId",""));this._bindElement=BX(this.getSetting("bindElementId",""))||this._menuButton;if(this._menuButton){BX.bind(this._menuButton,"click",BX.delegate(this.onMenuButtonClick,this))}this._autoClose=this._settings.getBooleanParam("autoClose",false)},getId:function(){return this._id},getSetting:function(e,t){return this._settings.getParam(e,t)},openMenu:function(e){if(this._isMenuOpened){this.closeMenu();return}var t=this.getSetting("items",null);if(!BX.type.isArray(t)){return}var n=/return\s+false(\s*;)?\s*$/;var i=/;\s*$/;var o=[];for(var u=0;u<t.length;u++){var s=t[u];var p=typeof s["SEPARATOR"]!=="undefined"?s["SEPARATOR"]:false;if(p){o.push({SEPARATOR:true,delimiter:true});continue}var a=typeof s["LINK"]!=="undefined"?s["LINK"]:"";var l=typeof s["ONCLICK"]!=="undefined"?s["ONCLICK"]:"";if(a!==""){var r='window.location.href = "'+a+'";';l=l!==""?r+" "+l:r}if(l!==""){if(!n.test(l)){if(!i.test(l)){l+=";"}if(!this._autoClose){l+=" return false;"}}}o.push({text:typeof s["TEXT"]!=="undefined"?s["TEXT"]:"",onclick:this._autoClose?this.onMenuItemClick.bind(this,l):l,className:typeof s["CLASS_NAME"]!=="undefined"?s["CLASS_NAME"]:"",disabled:typeof s["DISABLED"]!=="undefined"?s["DISABLED"]:false})}this._menuId=this._id.toLowerCase()+"_menu";BX.PopupMenu.show(this._menuId,this._bindElement,o,{autoHide:true,closeByEsc:true,offsetTop:0,offsetLeft:0,events:{onPopupShow:BX.delegate(this.onPopupShow,this),onPopupClose:BX.delegate(this.onPopupClose,this),onPopupDestroy:BX.delegate(this.onPopupDestroy,this)}});this._menuPopup=BX.PopupMenu.currentItem},closeMenu:function(){if(this._menuPopup){if(this._menuPopup.popupWindow){this._menuPopup.popupWindow.destroy()}}},onMenuButtonClick:function(e){this.openMenu()},onMenuItemClick:function(script){eval(script);if(this._menuPopup){this._menuPopup.close()}},onPopupShow:function(){this._isMenuOpened=true},onPopupClose:function(){this.closeMenu()},onPopupDestroy:function(){this._isMenuOpened=false;this._menuPopup=null;if(typeof BX.PopupMenu.Data[this._menuId]!=="undefined"){delete BX.PopupMenu.Data[this._menuId]}}};BX.InterfaceToolBar.create=function(e,t){var n=new BX.InterfaceToolBar;n.initialize(e,t);return n}}
/* End */
;
; /* Start:"a:4:{s:4:"full";s:91:"/bitrix/components/bitrix/crm.interface.filter/templates/title/script.min.js?15753007512949";s:6:"source";s:72:"/bitrix/components/bitrix/crm.interface.filter/templates/title/script.js";s:3:"min";s:76:"/bitrix/components/bitrix/crm.interface.filter/templates/title/script.min.js";s:3:"map";s:76:"/bitrix/components/bitrix/crm.interface.filter/templates/title/script.map.js";}"*/
if(typeof BX.InterfaceGridFilterNavigationBar==="undefined"){BX.InterfaceGridFilterNavigationBar=function(){this._id="";this._settings=null;this._binding=null;this._items=null;this._activeItem=null};BX.InterfaceGridFilterNavigationBar.prototype={initialize:function(t,i){this._id=t;this._settings=i?i:BX.CrmParamBag.create(null);this._binding=this.getSetting("binding",null);this._items=[];var e=this.getSetting("items",[]);for(var n=0;n<e.length;n++){var r=e[n];var a=BX.type.isNotEmptyString(r["id"])?r["id"]:n;r["parent"]=this;var s=BX.InterfaceGridFilterNavigationBarItem.create(a,BX.CrmParamBag.create(r));if(this._activeItem===null&&s.isActive()){this._activeItem=s}this._items.push(s)}},getId:function(){return this._id},getSetting:function(t,i){return this._settings.getParam(t,i)},getBinding:function(){return this._binding},processMenuItemClick:function(t){if(!t.isActive()){t.openUrl()}}};BX.InterfaceGridFilterNavigationBar.create=function(t,i){var e=new BX.InterfaceGridFilterNavigationBar;e.initialize(t,i);return e}}if(typeof BX.InterfaceGridFilterNavigationBarItem==="undefined"){BX.InterfaceGridFilterNavigationBarItem=function(){this._id="";this._settings=null;this._parent=null;this._element=null;this._name="";this._isActive=false;this._elementClickHandler=BX.delegate(this.onElementClick,this)};BX.InterfaceGridFilterNavigationBarItem.prototype={initialize:function(t,i){this._id=t;this._settings=i?i:BX.CrmParamBag.create(null);this._name=this.getSetting("name","");this._parent=this.getSetting("parent");if(!this._parent){throw"InterfaceGridFilterNavigationBarItem: The parameter 'parent' is not found."}this._element=BX(this.getSetting("elementId"));if(!BX.type.isElementNode(this._element)){throw"InterfaceGridFilterNavigationBarItem: The parameter 'element' is not found."}BX.bind(this._element,"click",this._elementClickHandler);this._isActive=this.getSetting("active",false)},getId:function(){return this._id},getSetting:function(t,i){return this._settings.getParam(t,i)},getName:function(){return this._name},getElement:function(){return this._element},isActive:function(){return this._isActive},openUrl:function(){var t=this.getSetting("url","");if(t===""){return}var i=this._parent.getBinding();if(i){var e=BX.type.isNotEmptyString(i["category"])?i["category"]:"";var n=BX.type.isNotEmptyString(i["name"])?i["name"]:"";var r=BX.type.isNotEmptyString(i["key"])?i["key"]:"";if(e!==""&&n!==""&&r!==""){var a=new Date;var s=a.getFullYear().toString();var l=a.getMonth()+1;l=l>=10?l.toString():"0"+l.toString();var g=a.getDate();g=g>=10?g.toString():"0"+g.toString();var o=this._id+":"+s+l+g;BX.userOptions.save(e,n,r,o,false)}}setTimeout(function(){window.location.href=t},150)},onElementClick:function(t){this._parent.processMenuItemClick(this)}};BX.InterfaceGridFilterNavigationBarItem.create=function(t,i){var e=new BX.InterfaceGridFilterNavigationBarItem;e.initialize(t,i);return e}}
/* End */
;
; /* Start:"a:4:{s:4:"full";s:91:"/bitrix/components/bitrix/main.ui.selector/templates/.default/script.min.js?157530074613009";s:6:"source";s:71:"/bitrix/components/bitrix/main.ui.selector/templates/.default/script.js";s:3:"min";s:75:"/bitrix/components/bitrix/main.ui.selector/templates/.default/script.min.js";s:3:"map";s:75:"/bitrix/components/bitrix/main.ui.selector/templates/.default/script.map.js";}"*/
(function(){"use strict";BX.namespace("BX.Main");BX.Main.selectorManagerV2={getById:function(t){if(typeof this.controls[t]!="undefined"){return this.controls[t]}return null},controls:{}};BX.Main.SelectorV2=function(){this.initialized=false;this.blockInit=false;this.id="";this.apiVersion=2;this.fieldName=null;this.inputId=null;this.input=null;this.tagId=null;this.tag=null;this.options=null;this.callback=null;this.callbackBefore=null;this.items=null;this.entities=null;this.mainPopupWindow=null;this.entitiesSet=["users","emails","crmemails","groups","sonetgroups","department","departmentRelation","contacts","companies","leads","deals"];this.entityTypes={};this.auxObject=null;this.selectorInstance=null};BX.Main.SelectorV2.controls={};BX.Main.SelectorV2.create=function(t){if(typeof t.id=="undefined"||!t.id){t.id=BX.util.hashCode(Math.random().toString())}else if(typeof BX.Main.selectorManagerV2.controls[t.id]!="undefined"){var e=BX.Main.selectorManagerV2.controls[t.id];if(e.bindNode&&!document.body.contains(e.bindNode)){delete BX.Main.selectorManagerV2.controls[t.id]}else{return BX.Main.selectorManagerV2.controls[t.id]}}var i=new BX.Main.SelectorV2;BX.Main.selectorManagerV2.controls[t.id]=i;i.init(t);return i};BX.Main.SelectorV2.proxyCallback=function(t,e){t(e)};BX.Main.SelectorV2.prototype={init:function(t){this.id=t.id;this.apiVersion=t.apiVersion&&parseInt(t.apiVersion)>=2?parseInt(t.apiVersion):2;this.fieldName=t.fieldName?t.fieldName:null;this.inputId=t.inputId?t.inputId:null;this.input=t.inputId&&BX(t.inputId)?BX(t.inputId):null;this.inputBox=t.inputBoxId&&BX(t.inputBoxId)?BX(t.inputBoxId):null;this.inputItemsContainer=t.inputContainerId&&BX(t.inputContainerId)?BX(t.inputContainerId):null;this.containerNode=t.containerId&&BX(t.containerId)?BX(t.containerId):null;this.bindNode=t.bindId&&BX(t.bindId)?BX(t.bindId):this.containerNode;this.tagId=t.tagId?t.tagId:null;this.tag=t.tagId&&BX(t.tagId)?BX(t.tagId):null;this.openDialogWhenInit=typeof t.openDialogWhenInit=="undefined"||!!t.openDialogWhenInit;this.options=t.options||{};this.callback=t.callback||null;this.callbackBefore=t.callbackBefore||null;this.items=t.items||null;this.entities=t.entities||null;this.entityTypes={};BX.onCustomEvent("BX.Main.SelectorV2:onGetEntityTypes",[{selector:this}]);this.selectorInstance=BX.UI.Selector.create({id:this.id,fieldName:this.fieldName,type:"xxx",pathToAjax:BX.type.isNotEmptyString(t.pathToAjax)?t.pathToAjax:null,input:this.input||null,tag:this.tag||null,inputBox:this.inputBox||null,inputItemsContainer:this.inputItemsContainer||null,entities:BX.clone(this.entityTypes),itemsSelected:BX.clone(this.items.selected)||{},itemsUndeletable:BX.clone(this.items.undeletable)||[],options:{multiple:this.getOption("multiple"),useSearch:this.getOption("useSearch"),useContainer:this.getOption("useContainer")=="Y"?"Y":"N",userNameTemplate:this.getOption("userNameTemplate"),siteDepartmentId:this.getOption("siteDepartmentId"),showCloseIcon:"Y",last:{disable:this.getOption("disableLast")=="Y"?"Y":"N"},search:{useAjax:this.getOption("sendAjaxSearch")!="N"?"Y":"N",useClientDatabase:this.getOption("useClientDatabase")=="Y"?"Y":"N"},focusInputOnSelectItem:this.getOption("focusInputOnSelectItem")!="N"?"Y":"N",focusInputOnSwitchTab:this.getOption("focusInputOnSwitchTab")!="N"?"Y":"N",isCrmFeed:this.getOption("isCrmFeed")=="Y"?"Y":"N",tagLink1:this.getOption("tagLink1"),tagLink2:this.getOption("tagLink2")},bindOptions:{node:this.bindNode,offsetTop:5,offsetLeft:15},callback:this.callback,callbackBefore:this.callbackBefore});BX.addCustomEvent("BX.UI.SelectorManager:getTreeItemRelation",function(t){if(this.id==t.selectorId){this.getTreeItemRelation(t)}}.bind(this));BX.addCustomEvent("BX.UI.SelectorManager:loadAll",function(t){this.loadAll(t)}.bind(this));BX.addCustomEvent("BX.Main.SelectorV2:initDialog",function(t){if(this.id==t.selectorId){if(!!t.openDialogWhenInit){this.openDialogWhenInit=true}this.initDialog()}}.bind(this));BX.addCustomEvent("BX.Main.SelectorV2:reInitDialog",function(t){if(this.id==t.selectorId){this.initialized=false;this.items.selected=BX.type.isNotEmptyObject(t.selectedItems)?t.selectedItems:{};this.items.undeletable=BX.type.isNotEmptyObject(t.undeletableItems)?t.undeletableItems:{};var e=BX.UI.SelectorManager.instances[t.selectorId],i=null,n=null,s=0;if(e){for(var o in e.itemsSelected){if(e.itemsSelected.hasOwnProperty(o)){i=e.itemsSelected[o].toUpperCase();n=BX.UI.SelectorManager.getEntityTypeFullList(i);for(s=0;s<n.length;s++){if(BX.type.isNotEmptyObject(e.entities[n[s]])&&BX.type.isNotEmptyObject(e.entities[n[s]].items)&&BX.type.isNotEmptyObject(e.entities[n[s]].items[o])){e.unselectItem({itemNode:e.entities[n[s]].items[o],itemId:o,entityType:n[s],mode:"reinit"})}}}}e.itemsSelected=this.items.selected;e.itemsUndeletable=this.items.undeletable}this.initDialog()}}.bind(this));BX.addCustomEvent("BX.UI.SelectorManager:searchRequest",function(t){if(this.id==t.selectorInstance.id){t.selectorInstance.timeouts.search=setTimeout(function(){this.searchRequest(t)}.bind(this),1e3)}}.bind(this));BX.addCustomEvent("BX.UI.Selector:onSelectItem",function(t){if(this.apiVersion>=3&&BX.type.isNotEmptyObject(t)&&this.id==t.selectorId&&BX.type.isNotEmptyString(t.itemId)){this.saveDestination({itemId:t.itemId})}}.bind(this));if(!BX.type.isNotEmptyString(this.getOption("lheName"))){var e=BX("div"+this.getOption("lheName"));if(e){BX.addCustomEvent(e,"OnShowLHE",function(t){if(!t){this.selectorInstance.closeAllPopups()}}.bind(this))}}if(this.getOption("useContainer")!="Y"&&this.input){if(this.getOption("lazyLoad")!="Y"||BX.type.isNotEmptyObject(this.items.selected)){if(BX.type.isNotEmptyObject(this.items.selected)){this.openDialogWhenInit=false}this.initDialog()}if(this.tag){BX.bind(this.tag,"focus",BX.delegate(function(t){this.initDialog({realParams:true,bByFocusEvent:true});return t.preventDefault()},this));this.selectorInstance.setTagTitle()}BX.bind(this.input,"keydown",function(t){this.selectorInstance.getSearchInstance().beforeSearchHandler({event:t})}.bind(this));BX.bind(this.input,"bxchange",function(e){setTimeout(function(){this.selectorInstance.getSearchInstance().searchHandler({event:e,tagInputName:t.tagId})}.bind(this),0)}.bind(this));this.input.setAttribute("data-bxchangehandler","Y")}else if(this.getOption("useContainer")=="Y"&&(this.getOption("lazyLoad")!="Y"||this.getOption("useContainer")=="Y")){this.initDialog()}if(this.items.hidden){for(var i in this.items.hidden){if(this.items.hidden.hasOwnProperty(i)){this.callback.select.apply({id:(typeof this.items.hidden[i]["PREFIX"]!="undefined"?this.items.hidden[i]["PREFIX"]:"SG")+this.items.hidden[i]["ID"],name:this.items.hidden[i]["NAME"]},typeof this.items.hidden[i]["TYPE"]!="undefined"?this.items.hidden[i]["TYPE"]:"sonetgroups","",true,"","init")}}}},show:function(){this.initDialog()},initDialog:function(t){if(typeof t=="undefined"||typeof t.realParams=="undefined"){t=null}if(this.blockInit){return}var e={id:this.id};if(!this.initialized){BX.onCustomEvent(window,"BX.Main.SelectorV2:beforeInitDialog",[e])}setTimeout(BX.delegate(function(){if(typeof e.blockInit=="undefined"||e.blockInit!==true){if(this.initialized){if(!this.mainPopupWindow||!this.mainPopupWindow.isShown()){if(this.input){this.input.style.display="inline-block"}if(this.inputBox){this.inputBox.style.display="inline-block"}this.openDialog(t)}}else{this.getData(BX.delegate(function(e){if(!!this.openDialogWhenInit){if(this.input){this.input.style.display="inline-block"}if(this.inputBox){this.inputBox.style.display="inline-block"}this.openDialog(t)}BX.onCustomEvent(window,"BX.Main.SelectorV2:afterInitDialog",[{id:this.id}]);if(typeof this.options.eventOpen!="undefined"){BX.addCustomEvent(window,this.options.eventOpen,function(t){if(typeof t.id=="undefined"||t.id!=this.id){return}if(this.options.multiple!="Y"&&this.inputItemsContainer&&this.inputItemsContainer.children.length>0){return}if(this.mainPopupWindow&&this.mainPopupWindow.isShown()){return}if(this.input){this.input.style.display="inline-block"}if(this.inputBox){this.inputBox.style.display="inline-block"}var e=BX.type.isNotEmptyObject(t)&&t.bindNode?t.bindNode:this.bindNode;var i=BX.type.isNotEmptyObject(t)&&BX.type.isNotEmptyObject(t.bindPosition)?t.bindPosition:false;if(e){var n=BX.findChild(e,{tagName:"input",attr:{type:"text"}},true);if(n){this.selectorInstance.nodes.input=n;var s=this.tag||BX(t.tagId);if(s){this.selectorInstance.nodes.tag=s}if(n.getAttribute("data-bxchangehandler")!=="Y"){BX.bind(n,"keydown",function(t){this.selectorInstance.getSearchInstance().beforeSearchHandler({event:t})}.bind(this));BX.bind(n,"bxchange",function(t){this.selectorInstance.getSearchInstance().searchHandler({event:t})}.bind(this));n.setAttribute("data-bxchangehandler","Y")}}}if(i||e){if(!this.initialized){this.selectorInstance.itemsSelected={}}if(typeof t.value!="undefined"){this.selectorInstance.itemsSelected=t.value}this.openDialog({bindNode:e,bindPosition:i})}}.bind(this))}},this))}}},this),1)},openDialog:function(t){if(BX.type.isNotEmptyObject(t)){if(typeof t.bindNode!="undefined"){this.selectorInstance.bindOptions.node=t.bindNode}if(typeof t.bindPosition!="undefined"){this.selectorInstance.bindOptions.position=t.bindPosition}}this.selectorInstance.openDialog();this.mainPopupWindow=this.getOption("useContainer")=="Y"?this.selectorInstance.popups.container:this.selectorInstance.popups.main},closeDialog:function(){this.selectorInstance.closeDialog()},getData:function(t){this.blockInit=true;BX.onCustomEvent("BX.Main.SelectorV2:onGetDataStart",[this.id]);BX.ajax.runComponentAction("bitrix:main.ui.selector","getData",{mode:"ajax",data:{options:this.options,entityTypes:this.entityTypes,selectedItems:this.items.selected||{}}}).then(function(e){if(BX.type.isNotEmptyObject(e.data)){this.blockInit=false;BX.onCustomEvent("BX.Main.SelectorV2:onGetDataFinish",[this.id]);this.addData(e.data,t);this.initialized=true}}.bind(this),function(t){this.blockInit=false;BX.onCustomEvent("BX.Main.SelectorV2:onGetDataFinish",[this.id])}.bind(this))},loadAll:function(t){if(BX.type.isNotEmptyObject(t)&&BX.type.isFunction(t.callback)&&(BX.type.isNotEmptyString(t.entity)||t.entity=="users")){BX.ajax.runComponentAction("bitrix:main.ui.selector","loadAll",{mode:"ajax",data:{entityType:BX.type.isNotEmptyString(t.entity)?t.entity.toUpperCase():""}}).then(function(e){if(BX.type.isNotEmptyObject(e.data)){for(var i in e.data){if(e.data.hasOwnProperty(i)){BX.onCustomEvent("onFinderAjaxLoadAll",[e.data[i],BX.UI.SelectorManager,i.toLowerCase()])}}t.callback()}}.bind(this),function(t){}.bind(this))}},searchRequest:function(t){this.blockInit=true;if(this.selectorInstance.timeouts.search){clearTimeout(this.selectorInstance.timeouts.search)}var e=new Date;this.selectorInstance.searchRequestId=e.getTime();BX.ajax.runComponentAction("bitrix:main.ui.selector","doSearch",{mode:"ajax",data:{searchString:t.searchString,searchStringConverted:BX.message("LANGUAGE_ID")=="ru"&&BX.correctText?BX.correctText(t.searchString):"",currentTimestamp:this.selectorInstance.searchRequestId,options:this.options,entityTypes:this.entityTypes,additionalData:BX.type.isNotEmptyObject(t.additionalData)?t.additionalData:{}},onrequeststart:function(t){this.selectorInstance.searchXhr=t}.bind(this)}).then(function(e){this.blockInit=false;if(BX.type.isNotEmptyObject(e.data)&&e.data.currentTimestamp&&e.data.currentTimestamp==this.selectorInstance.searchRequestId&&BX.type.isNotEmptyObject(t.callback)&&BX.type.isFunction(t.callback.success)){t.callback.success(e.data,{searchString:t.searchString,searchStringOriginal:BX.type.isNotEmptyObject(t.searchStringOriginal)?t.searchStringOriginal:t.searchString})}}.bind(this),function(e){this.blockInit=false;if(BX.type.isNotEmptyObject(t.callback)&&BX.type.isFunction(t.callback.failure)){t.callback.failure(BX.type.isNotEmptyObject(e.data)?e.data:{})}}.bind(this))},getTreeItemRelation:function(t){BX.ajax.runComponentAction("bitrix:main.ui.selector","getTreeItemRelation",{mode:"ajax",data:{entityType:t.entityType,categoryId:t.categoryId}}).then(function(e){if(BX.type.isNotEmptyObject(e.data)&&typeof t.callback!="undefined"){t.callback({selectorInstanceId:this.selectorInstance.id,entityType:t.entityType,categoryId:t.categoryId,data:e.data})}}.bind(this),function(t){})},addData:function(t,e){BX.onCustomEvent("BX.Main.SelectorV2:onAddData",[this.id,t]);if(typeof t.ENTITIES.CRM!="undefined"&&typeof t.ENTITIES.CRM.ITEMS_LAST!="undefined"&&BX.type.isNotEmptyObject(t.ENTITIES.CRM.ITEMS_LAST)){}e.apply(this,t)},getId:function(){return this.id},getOption:function(t){return typeof this.options[t]!="undefined"?this.options[t]:null},saveDestination:function(t){if(BX.type.isNotEmptyObject(t)&&BX.type.isNotEmptyString(t.itemId)){var e=this.getOption("context");if(BX.type.isNotEmptyString(e)){BX.ajax.runComponentAction("bitrix:main.ui.selector","saveDestination",{mode:"ajax",data:{context:e,itemId:t.itemId}}).then(function(t){},function(t){})}}}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:90:"/bitrix/components/bitrix/main.ui.filter/templates/.default/script.min.js?1575300746147320";s:6:"source";s:69:"/bitrix/components/bitrix/main.ui.filter/templates/.default/script.js";s:3:"min";s:73:"/bitrix/components/bitrix/main.ui.filter/templates/.default/script.min.js";s:3:"map";s:73:"/bitrix/components/bitrix/main.ui.filter/templates/.default/script.map.js";}"*/
this.BX=this.BX||{};(function(e,t){"use strict";(function(){BX.namespace("BX.Main.ui.block");BX.Main.ui.block["date-group"]=function(e){var t,i,s,n,a;t={block:"main-ui-control-field-group",name:e.name+"_datesel",mix:"mix"in e?e.mix:null,attrs:{"data-type":"type"in e?e.type:"","data-name":"name"in e?e.name:"","data-time":e.enableTime},content:[]};if("label"in e&&BX.type.isNotEmptyString(e.label)){n={block:"main-ui-control-field-label",tag:"span",attrs:{title:e.label},content:e.label};t.content.push(n)}i={block:"main-ui-control-field",dragButton:false,content:{block:"main-ui-select",tabindex:"tabindex"in e?e.tabindex:"",value:"value"in e?e.value:"",items:"items"in e?e.items:"",name:"name"in e?e.name+"_datesel":"",params:"params"in e?e.params:"",valueDelete:false}};t.content.push(i);if("content"in e&&BX.type.isArray(e.content)){e.content.forEach(function(e){t.content.push(e)})}if("content"in e&&(BX.type.isPlainObject(e.content)||BX.type.isNotEmptyString(e.content))){t.content.push(e.content)}s={block:"main-ui-item-icon-container",content:{block:"main-ui-item-icon",mix:["main-ui-delete","main-ui-filter-field-delete"],tag:"span",attrs:{title:"deleteTitle"in e&&e.deleteTitle?e.deleteTitle:""}}};t.content.push(s);if(!("dragButton"in e)||e.dragButton!==false){a={block:"main-ui-filter-icon-grab",mix:["main-ui-item-icon"],tag:"span",attrs:{title:"dragTitle"in e&&e.dragTitle?e.dragTitle:""}};t.content.push(a)}return t}})();(function(){BX.namespace("BX.Main.ui.block");BX.Main.ui.block["main-ui-control-field"]=function(e){var t,i,s,n,a;t={block:"main-ui-control-field",mix:"mix"in e?e.mix:null,attrs:{"data-type":"type"in e?e.type:"","data-name":"name"in e?e.name:""},content:[]};if("label"in e&&BX.type.isNotEmptyString(e.label)){n={block:"main-ui-control-field-label",tag:"span",attrs:{title:e.label},content:e.label};t.content.push(n)}if(BX.type.isArray(e.content)){e.content.forEach(function(e){t.content.push(e)})}else if(BX.type.isPlainObject(e.content)||BX.type.isNotEmptyString(e.content)){t.content.push(e.content)}if("valueDelete"in e&&e.valueDelete===true){s={block:"main-ui-control-value-delete",content:{block:"main-ui-control-value-delete-item",tag:"span"}};t.content.push(s)}if("deleteButton"in e&&e.deleteButton===true){i={block:"main-ui-item-icon-container",content:{block:"main-ui-item-icon",mix:["main-ui-delete","main-ui-filter-field-delete"],tag:"span",attrs:{title:"deleteTitle"in e&&e.deleteTitle?e.deleteTitle:""}}};t.content.push(i)}if(!("dragButton"in e)||e.dragButton!==false){a={block:"main-ui-filter-icon-grab",mix:["main-ui-item-icon"],tag:"span",attrs:{title:"dragTitle"in e&&e.dragTitle?e.dragTitle:""}};t.content.push(a)}return t}})();(function(){BX.namespace("BX.Main.ui.block");BX.Main.ui.block["main-ui-control-field-group"]=function(e){var t,i,s,n;t={block:"main-ui-control-field-group",mix:"mix"in e?e.mix:null,attrs:{"data-type":"type"in e?e.type:"","data-name":"name"in e?e.name:""},content:[]};if("label"in e&&BX.type.isNotEmptyString(e.label)){s={block:"main-ui-control-field-label",tag:"span",attrs:{title:e.label},content:e.label};t.content.push(s)}if(BX.type.isArray(e.content)){e.content.forEach(function(e){t.content.push(e)})}else if(BX.type.isPlainObject(e.content)||BX.type.isNotEmptyString(e.content)){t.content.push(e.content)}if("deleteButton"in e&&e.deleteButton===true){i={block:"main-ui-item-icon-container",content:{block:"main-ui-item-icon",mix:["main-ui-delete","main-ui-filter-field-delete"],tag:"span",attrs:{title:"deleteTitle"in e&&e.deleteTitle?e.deleteTitle:""}}};t.content.push(i)}if(!("dragButton"in e)||e.dragButton!==false){n={block:"main-ui-filter-icon-grab",mix:["main-ui-item-icon"],tag:"span",attrs:{title:"dragTitle"in e&&e.dragTitle?e.dragTitle:""}};t.content.push(n)}return t}})();(function(){BX.namespace("BX.Main.ui.block");BX.Main.ui.block["main-ui-control-string"]=function(e){return{block:"main-ui-control-string",mix:["main-ui-control"],tag:"input",attrs:{type:"type"in e?e.type:"text",name:"name"in e?e.name:"",placeholder:"placeholder"in e?e.placeholder:"",tabindex:"tabindex"in e?e.tabindex:"",value:"value"in e?e.value:""}}}})();(function(){BX.namespace("BX.Main.ui.block");BX.Main.ui.block["main-ui-control-textarea"]=function(e){return{block:"main-ui-control-string",mix:["main-ui-control main-ui-control-textarea"],tag:"textarea",attrs:{name:"name"in e?e.name:"",placeholder:"placeholder"in e?e.placeholder:"",tabindex:"tabindex"in e?e.tabindex:""},content:"value"in e?e.value:""}}})();(function(){BX.namespace("BX.Main.ui.block");BX.Main.ui.block["main-ui-filter-field-list-item"]=function(e){var t={block:"main-ui-select-inner-label",content:"label"in e?e.label:""};var i={block:"main-ui-filter-field-list-item",mix:"main-ui-select-inner-item",attrs:{"data-id":e.id,"data-name":e.name,"data-item":"item"in e?JSON.stringify(e.item):{}},events:{click:"onClick"in e?e.onClick:""},content:t};return i}})();(function(){BX.namespace("BX.Main.ui.block");BX.Main.ui.block["main-ui-filter-info"]=function(e){return{block:"main-ui-filter-info",tag:"span",content:e.content,attrs:{title:e.title}}}})();(function(){BX.namespace("BX.Main.ui.block");BX.Main.ui.block["main-ui-number"]=function(e){var t,i,s;t={block:"main-ui-number",mix:["main-ui-control"],content:[]};if("mix"in e&&BX.type.isArray(e.mix)){e.mix.forEach(function(e){t.mix.push(e)})}i={block:"main-ui-number-input",mix:["main-ui-control-input"],tag:"input",attrs:{type:"number",name:"name"in e?e.name:"",tabindex:"tabindex"in e?e.tabindex:"",value:"value"in e?e.value:"",placeholder:"placeholder"in e?e.placeholder:"",autocomplete:"off"}};t.content.push(i);if("valueDelete"in e&&e.valueDelete===true){s={block:"main-ui-control-value-delete",content:{block:"main-ui-control-value-delete-item",tag:"span"}};t.content.push(s)}return t}})();(function(){BX.namespace("BX.Main.ui.block");BX.Main.ui.block["main-ui-search-square"]=function(e){var t=["main-ui-filter-search-square"];if("isPreset"in e&&e.isPreset){t.push("main-ui-filter-search-square-preset")}return{block:"main-ui-square",mix:t,attrs:{"data-item":"item"in e?JSON.stringify(e.item):"",title:"title"in e?e.title:""},content:[{block:"main-ui-square-item",content:"name"in e?BX.util.htmlspecialcharsback(e.name):""},{block:"main-ui-square-delete",mix:["main-ui-item-icon"]}]}}})();(function(){BX.namespace("BX.Main.ui.block");BX.Main.ui.block["number-group"]=function(e){var t,i,s,n,a;t={block:"main-ui-control-field-group",name:"name"in e?e.name+"_numsel":"",mix:"mix"in e?e.mix:null,attrs:{"data-type":"type"in e?e.type:"","data-name":"name"in e?e.name:""},content:[]};if("label"in e&&BX.type.isNotEmptyString(e.label)){n={block:"main-ui-control-field-label",tag:"span",attrs:{title:e.label},content:e.label};t.content.push(n)}i={block:"main-ui-control-field",dragButton:false,content:{block:"main-ui-select",tabindex:"tabindex"in e?e.tabindex:"",value:"value"in e?e.value:"",items:"items"in e?e.items:"",name:"name"in e?e.name+"_numsel":"",params:"params"in e?e.params:"",valueDelete:false}};t.content.push(i);if("content"in e&&BX.type.isArray(e.content)){e.content.forEach(function(e){t.content.push(e)})}if("content"in e&&(BX.type.isPlainObject(e.content)||BX.type.isNotEmptyString(e.content))){t.content.push(e.content)}s={block:"main-ui-item-icon-container",content:{block:"main-ui-item-icon",mix:["main-ui-delete","main-ui-filter-field-delete"],tag:"span",attrs:{title:"deleteTitle"in e&&e.deleteTitle?e.deleteTitle:""}}};t.content.push(s);if(!("dragButton"in e)||e.dragButton!==false){a={block:"main-ui-filter-icon-grab",mix:["main-ui-item-icon"],tag:"span",attrs:{title:"dragTitle"in e&&e.dragTitle?e.dragTitle:""}};t.content.push(a)}return t}})();(function(){BX.namespace("BX.Main.ui.block");BX.Main.ui.block["sidebar-item"]=function(e){return{block:"main-ui-filter-sidebar-item"+("pinned"in e&&e.pinned?" main-ui-item-pin":""),attrs:{"data-id":"id"in e?e.id:""},content:[{block:"main-ui-filter-icon-grab",tag:"span",mix:["main-ui-item-icon"],attrs:{title:"dragTitle"in e&&e.dragTitle?e.dragTitle:""}},{block:"main-ui-filter-sidebar-item-text-container",tag:"span",content:[{block:"main-ui-filter-sidebar-item-input",tag:"input",attrs:{type:"text",placeholder:"placeholder"in e?e.placeholder:"",value:"text"in e?BX.util.htmlspecialchars(BX.util.htmlspecialcharsback(e.text)):""}},{block:"main-ui-filter-sidebar-item-text",tag:"span",content:"text"in e?e.text:""},{block:"main-ui-filter-icon-pin",tag:"span",mix:["main-ui-item-icon"],attrs:{title:"noEditPinTitle"in e&&e.noEditPinTitle?e.noEditPinTitle:""}}]},{block:"main-ui-filter-icon-edit",tag:"span",mix:["main-ui-item-icon"],attrs:{title:"editNameTitle"in e&&e.editNameTitle?e.editNameTitle:""}},{block:"main-ui-delete",tag:"span",mix:["main-ui-item-icon"],attrs:{title:"removeTitle"in e&&e.removeTitle?e.removeTitle:""}},{block:"main-ui-filter-icon-pin",tag:"span",mix:["main-ui-item-icon"],attrs:{title:"editPinTitle"in e&&e.editPinTitle?e.editPinTitle:""}},{block:"main-ui-filter-edit-mask"}]}}})();(function(){BX.namespace("BX.Filter");BX.Filter.Utils={cache:{},styleForEach:function e(t,i){var s;i=BX.type.isPlainObject(i)?i:null;s=Object.keys(i);[].forEach.call(t||[],function(e){s.forEach(function(t){BX.style(e,t,i[t])})})},closestParent:function e(t,i){if(t){if(!i){return t.parentNode||null}else{return BX.findParent(t,{className:i})}}},closestChilds:function e(t){return!!t?t.children:null},getNext:function e(t){return!!t?t.nextElementSibling:null},getPrev:function e(t){return!!t?t.previousElementSibling:null},collectionSort:function e(t,i){var s,n,a,r,l;if(t&&i&&t!==i&&t.parentNode===i.parentNode){s=this.closestParent(i);n=this.closestChilds(s);a=n.length;r=this.getIndex(n,t);l=this.getIndex(n,i);if(a===l){s.appendChild(i)}if(r>l){s.insertBefore(t,i)}if(r<l&&a!==l){s.insertBefore(t,this.getNext(i))}}},getIndex:function e(t,i){return[].indexOf.call(t||[],i)},getByClass:function e(t,i,s){var n=[];if(i){n=(t||document.body).getElementsByClassName(i);if(!s){n=n.length?n[0]:null}else{n=[].slice.call(n)}}return n},getByTag:function e(t,i,s){var n=[];if(i){n=(t||document.body).getElementsByTagName(i);if(!s){n=n.length?n[0]:null}else{n=[].slice.call(n)}}return n},getBySelector:function e(t,i,s){var n=[];if(i){if(!s){n=(t||document.body).querySelector(i)}else{n=(t||document.body).querySelectorAll(i);n=[].slice.call(n)}}return n},requestAnimationFrame:function e(){var t=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame||window.oRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)};t.apply(window,arguments)},sortObject:function e(t){var i={};Object.keys(t).sort().forEach(function(e){i[e]=t[e]});return i},objectsIsEquals:function e(t,i){return JSON.stringify(t)===JSON.stringify(i)},isKey:function e(t,i){var s={8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",27:"escape",32:"space",37:"leftArrow",38:"upArrow",39:"rightArrow",40:"downArrow",46:"delete",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",65:"a"};var n=!!t?"keyCode"in t?t.keyCode:"which"in t?t.which:0:0;return n in s&&s[n]===i}}})();(function(){BX.namespace("BX.Filter");BX.Filter.DestinationSelectorManager={fields:[],controls:{},onSelect:function e(t,i,s){if(!BX.type.isNotEmptyObject(s)||!BX.type.isNotEmptyObject(s.item)||!BX.type.isNotEmptyString(s.selectorId)){return}var n=s.selectorId,a=s.item;var r=BX.Filter.DestinationSelectorManager.controls[n];if(r){var l=a.id;if(BX.type.isNotEmptyString(t)&&t=="Y"&&BX.type.isNotEmptyString(i)){var o=new RegExp("^"+i+"(\\d+)$");var u=l.match(o);if(BX.type.isArray(u)){l=u[1]}}else{var c={};BX.onCustomEvent(window,"BX.Filter.DestinationSelector:convert",[{selectorId:n,value:l},c]);if(BX.type.isNotEmptyString(c.value)){l=c.value}}r.setData(BX.util.htmlspecialcharsback(a.name),l);r.getLabelNode().value="";r.getLabelNode().blur()}},onDialogOpen:function e(t){if(typeof t=="undefined"||!BX.type.isNotEmptyString(t.selectorId)){return}var i=t.selectorId;var s=BX.Filter.DestinationSelector.items[i];if(s){s.onDialogOpen()}},onDialogClose:function e(t){if(typeof t=="undefined"||!BX.type.isNotEmptyString(t.selectorId)){return}var i=t.selectorId;var s=BX.Filter.DestinationSelector.items[i];if(s){s.onDialogClose()}}};BX.Filter.DestinationSelector=function(){this.id="";this.filterId="";this.settings={};this.fieldId="";this.control=null;this.inited=null};BX.Filter.DestinationSelector.items={};BX.Filter.DestinationSelector.create=function(e,t){if(typeof this.items[e]!="undefined"){return this.items[e]}var i=new BX.Filter.DestinationSelector(e,t);i.initialize(e,t);this.items[e]=i;BX.onCustomEvent(window,"BX.Filter.DestinationSelector:create",[e]);return i};BX.Filter.DestinationSelector.prototype.getSetting=function(e,t){return this.settings.hasOwnProperty(e)?this.settings[e]:t};BX.Filter.DestinationSelector.prototype.getSearchInput=function(){return this.control?this.control.getLabelNode():null};BX.Filter.DestinationSelector.prototype.initialize=function(e,t){this.id=e;this.settings=t?t:{};this.fieldId=this.getSetting("fieldId","");this.filterId=this.getSetting("filterId","");this.inited=false;this.opened=null;var i=this.getSetting("initialValue",false);if(!!i){var s={};s[this.fieldId]=i.itemId;s[this.fieldId+"_label"]=i.itemName;BX.Main.filterManager.getById(this.filterId).getApi().setFields(s)}BX.addCustomEvent(window,"BX.Main.Filter:customEntityFocus",BX.delegate(this.onCustomEntitySelectorOpen,this));BX.addCustomEvent(window,"BX.Main.Filter:customEntityBlur",BX.delegate(this.onCustomEntitySelectorClose,this));BX.addCustomEvent(window,"BX.Main.Filter:onGetStopBlur",BX.delegate(this.onGetStopBlur,this));BX.addCustomEvent(window,"BX.Main.SelectorV2:beforeInitDialog",BX.delegate(this.onBeforeInitDialog,this));BX.addCustomEvent(window,"BX.Main.Filter:customEntityRemove",BX.delegate(this.onCustomEntityRemove,this))};BX.Filter.DestinationSelector.prototype.open=function(){var e=this.id;if(!this.inited){var t=this.getSearchInput();t.id=t.name;BX.addCustomEvent(window,"BX.Main.SelectorV2:afterInitDialog",BX.delegate(function(e){if(typeof e.id!="undefined"||e.id!=this.id){return}this.opened=true},this));BX.addCustomEvent(window,"BX.UI.SelectorManager:onCreate",BX.delegate(function(e){if(!BX.type.isNotEmptyString(e)||e!=this.id){return}BX.onCustomEvent(window,"BX.Filter.DestinationSelector:setSelected",[{selectorId:e,current:this.control.getCurrentValues()}])},this));BX.onCustomEvent(window,"BX.Filter.DestinationSelector:openInit",[{id:this.id,inputId:t.id,containerId:t.id}])}else{var i={};i[this.currentUser.entityId]="users";BX.onCustomEvent(window,"BX.Filter.DestinationSelector:open",[{id:this.id,bindNode:this.control.getField(),value:i}]);this.opened=true}};BX.Filter.DestinationSelector.prototype.close=function(){if(typeof BX.Main.selectorManagerV2.controls[this.id]!=="undefined"){BX.Main.selectorManagerV2.controls[this.id].closeDialog()}};BX.Filter.DestinationSelector.prototype.onCustomEntitySelectorOpen=function(e){var t=e.getId();if(this.fieldId!==t){this.control=null}else{this.control=e;if(this.control){var i=this.control.getCurrentValues();this.currentUser={entityId:i["value"]}}BX.Filter.DestinationSelectorManager.controls[this.id]=this.control;if(!this.opened){this.open()}else{this.close()}}};BX.Filter.DestinationSelector.prototype.onCustomEntitySelectorClose=function(e){if(this.fieldId===e.getId()&&this.inited===true&&this.opened===true){this.control=null;window.setTimeout(BX.delegate(this.close,this),0)}};BX.Filter.DestinationSelector.prototype.onGetStopBlur=function(e,t){if(BX.findParent(e.target,{className:"bx-lm-box"})){t.stopBlur=true}};BX.Filter.DestinationSelector.prototype.onCustomEntityRemove=function(e){if(this.fieldId===e.getId()){var t=BX.UI.SelectorManager.instances[e.getId()];if(t&&typeof e.hiddenInput!="undefined"&&typeof e.hiddenInput.value!="undefined"&&BX.type.isNotEmptyObject(t.itemsSelected)&&typeof t.itemsSelected[e.hiddenInput.value]!="undefined"){delete t.itemsSelected[e.hiddenInput.value]}}};BX.Filter.DestinationSelector.prototype.onBeforeInitDialog=function(e){if(typeof e.id=="undefined"||e.id!=this.id){return}this.inited=true;if(!this.control){e.blockInit=true}};BX.Filter.DestinationSelector.prototype.onDialogOpen=function(){this.opened=true};BX.Filter.DestinationSelector.prototype.onDialogClose=function(){this.opened=false}})();(function(){BX.namespace("BX.Filter");BX.Filter.FieldController=function(e,t){this.field=null;this.parent=null;this.type=null;this.input=null;this.deleteButton=null;this.init(e,t)};BX.Filter.FieldController.prototype={init:function e(t,i){if(!BX.type.isDomNode(t)){throw"BX.Filter.FieldController.init: field isn't dom node"}if(!(i instanceof BX.Main.Filter)){throw"BX.Filter.FieldController.init: parent not instance of BX.Main.ui.Filter"}this.field=t;this.parent=i;this.bind();this.isShowDelete()?this.showDelete():this.hideDelete()},isShowDelete:function e(){var t=this.getSquares();return this.getInputValue()||BX.type.isArray(t)&&t.length},getField:function e(){return this.field},getInput:function e(){var t,i;if(!BX.type.isDomNode(this.input)){t=this.getType();i=this.parent.types;if(t===i.DATE){this.input=BX.Filter.Utils.getByClass(this.getField(),this.parent.settings.classDateInput)}if(t===i.NUMBER||t==="number"){this.input=BX.Filter.Utils.getByClass(this.getField(),this.parent.settings.classNumberInput)}if(t===i.STRING){this.input=BX.Filter.Utils.getByClass(this.getField(),this.parent.settings.classStringInput)}if(t===i.CUSTOM_ENTITY){this.input=BX.Filter.Utils.getBySelector(this.getField(),'input[type="hidden"]')}}return this.input},getDeleteButton:function e(){if(!BX.type.isDomNode(this.deleteButton)){this.deleteButton=BX.Filter.Utils.getByClass(this.getField(),this.parent.settings.classValueDelete)}return this.deleteButton},getSquares:function e(){return BX.Filter.Utils.getByClass(this.getField(),this.parent.settings.classSquare)},bind:function e(){if(this.getType()!==this.parent.types.MULTI_SELECT&&this.getType()!==this.parent.types.SELECT){BX.bind(this.getDeleteButton(),"click",BX.delegate(this._onDeleteClick,this));BX.bind(this.getInput(),"input",BX.delegate(this._onInput,this))}},clearInput:function e(){var t=this.getInput();if(BX.type.isDomNode(t)){t.value=""}},hideDelete:function e(){var t=this.getDeleteButton();if(BX.type.isDomNode(t)){BX.addClass(t,this.parent.settings.classHide)}},showDelete:function e(){var t=this.getDeleteButton();if(BX.type.isDomNode(t)){BX.removeClass(t,this.parent.settings.classHide)}},removeSquares:function e(){var t=this.getSquares();if(BX.type.isArray(t)&&t.length){t.forEach(function(e){BX.remove(e)})}},_onDeleteClick:function e(){this.removeSquares();this.clearInput();this.hideDelete()},_onInput:function e(){this.getInputValue()?this.showDelete():this.hideDelete()},getInputValue:function e(){var t="";var i=this.getInput();if(BX.type.isDomNode(i)){t=i.value}return t},getType:function e(){if(!BX.type.isNotEmptyString(this.type)){this.type=BX.data(this.getField(),"type")}return this.type}}})();(function(){BX.namespace("BX.Main.ui");BX.Main.ui.CustomEntity=function(){this.field=null;this.labelInput=null;this.hiddenInput=null;this.popupContainer=null;this.inputClass="main-ui-control-string";this.squareClass="main-ui-square";this.multiple=null};BX.Main.ui.CustomEntity.isMultiple=function(e){if(!!e&&!BX.hasClass(e,"main-ui-control-entity")){e=BX.Filter.Utils.getByClass(e,"main-ui-control-entity")}return!!e&&JSON.parse(BX.data(e,"multiple"))};BX.Main.ui.CustomEntity.prototype={setField:function e(t){if(this.field!==t){this.field=t;this.reset()}},isMultiple:function e(){return BX.Main.ui.CustomEntity.isMultiple(this.getField())},reset:function e(){this.labelInput=null;this.hiddenInput=null},getField:function e(){return this.field},getId:function e(){var t=this.getHiddenNode();var i=null;if(BX.type.isDomNode(t)){i=t.name}return i},getLabelNode:function e(){if(!BX.type.isDomNode(this.labelInput)){this.labelInput=BX.Filter.Utils.getBySelector(this.getField(),"."+this.inputClass+'[type="text"]')}return this.labelInput},getHiddenNode:function e(){if(!BX.type.isDomNode(this.hiddenInput)){this.hiddenInput=BX.Filter.Utils.getBySelector(this.getField(),"."+this.inputClass+'[type="hidden"]')}return this.hiddenInput},getSquareByValue:function e(t){return BX.Filter.Utils.getBySelector(this.getField(),['[data-item*=":'+BX.util.jsencode(t)+'}"]','[data-item*=":\\"'+BX.util.jsencode(t)+'\\"}"]'].join(", "))},getSquares:function e(){return BX.Filter.Utils.getByClass(this.getField(),this.squareClass,true)},removeSquares:function e(){this.getSquares().forEach(BX.remove)},setSquare:function e(t,i){var s=this.getField();var n={block:"main-ui-square",name:t,item:{_label:t,_value:i}};var a=BX.decl(n);var r=this.getSquares();if(!r.length){BX.prepend(a,s)}else{BX.insertAfter(a,r[r.length-1])}},getCurrentValues:function e(){var t=this.getSquares();var i,s;if(this.isMultiple()){s=[];for(var n=0,a=t.length;n<a;n++){try{i=JSON.parse(BX.data(t[n],"item"));s.push({label:i._label,value:i._value})}catch(e){}}}else{if(t.length===0){s={label:"",value:""}}else{try{i=JSON.parse(BX.data(t[0],"item"));s={label:i._label,value:i._value}}catch(e){s={label:"",value:""}}}}return s},setData:function e(t,i){return this.isMultiple()?this.setMultipleData(t,i):this.setSingleData(t,i)},setSingleData:function e(t,i){var s=this.getHiddenNode();this.removeSquares();this.setSquare(t,i);if(BX.type.isDomNode(s)){s.value=i;BX.fireEvent(s,"input")}},setMultipleData:function e(t,i){var s=[];var n=this.getHiddenNode();if(BX.type.isArray(t)){this.removeSquares();if(BX.type.isArray(t)){t.forEach(function(e){s.push(e.value);this.setSquare(e.label,e.value)},this);if(BX.type.isDomNode(n)){n.value=JSON.stringify(s);BX.fireEvent(n,"input")}}}if(!BX.type.isArray(t)&&i!==null){if(!this.getSquareByValue(i)){this.setSquare(t,i);this.getSquares().forEach(function(e){var t=JSON.parse(BX.data(e,"item"));if(BX.type.isPlainObject(t)){s.push(t._value)}});n.value=JSON.stringify(s);BX.fireEvent(n,"input")}}},setPopupContainer:function e(t){if(BX.type.isDomNode(t)){this.popupContainer=t}},getPopupContainer:function e(){return this.popupContainer}}})();(function(){BX.namespace("BX.Filter");BX.Filter.Search=function(e){this.parent=null;this.container=null;this.input=null;this.preset=null;this.buttonsContainer=null;this.delay=800;this.timeout=null;this.init(e)};BX.Filter.Search.prototype={init:function e(t){this.parent=t;BX.bind(this.getInput(),"input",BX.delegate(this._onInputWithoutDebounce,this));if(this.parent.getParam("ENABLE_LIVE_SEARCH")){BX.bind(this.getInput(),"input",BX.debounce(this._onInput,this.delay,this))}BX.bind(this.getInput(),"keydown",BX.delegate(this._onKeyDown,this));BX.bind(this.getFindButton(),"click",BX.delegate(this._onSearchClick,this));BX.bind(this.getContainer(),"click",BX.delegate(this._onSearchContainerClick,this));this.removeAutofocus();this.firstInit=true},removeAutofocus:function e(){var t=this.getInput();if(!!t){t.blur();t.autofocus=null}},getFindButton:function e(){if(!BX.type.isDomNode(this.findButton)){this.findButton=BX.Filter.Utils.getByClass(this.getContainer(),this.parent.settings.classSearchButton)}return this.findButton},_onSearchClick:function e(){this.apply()},selectSquare:function e(t){!!t&&BX.addClass(t,this.parent.settings.classSquareSelected)},selectSquares:function e(){this.getSquares().forEach(this.selectSquare,this)},unselectSquare:function e(t){!!t&&BX.removeClass(t,this.parent.settings.classSquareSelected)},unselectSquares:function e(){this.getSquares().forEach(this.unselectSquare,this)},removeSquares:function e(){this.getSquares().forEach(this.removeSquare,this)},isSquaresSelected:function e(){var t=this.getSquares();return t.length&&t.every(this.isSquareSelected,this)},isSquareSelected:function e(t){return!!t&&BX.hasClass(t,this.parent.settings.classSquareSelected)},getLastSquare:function e(){var t=this.getSquares();return!!t?t[t.length-1]:null},isTextSelected:function e(){var t=this.getSearchString().length;var i=this.getInput();var s=i.selectionStart;var n=i.selectionEnd;return s===0&&n!==0&&n===t},isSelectionStart:function e(){var t=this.getInput();var i=t.selectionStart;var s=t.selectionEnd;return i===0&&s===0},isSquareRemoveButton:function e(t){return!!t&&BX.hasClass(t,this.parent.settings.classSquareDelete)},isClearButton:function e(t){return!!t&&BX.hasClass(t,this.parent.settings.classClearSearchValueButton)},getClearButton:function e(){return this.getContainer().querySelector("."+this.parent.settings.classClearSearchValueButton)},isSearchButton:function e(t){return!!t&&BX.hasClass(t,this.parent.settings.classSearchButton)},adjustFocus:function e(){if(!BX.browser.IsMobile()){var t=this.getInput();if(document.activeElement!==t&&window.scrollY<BX.pos(t).top){t.value=t.value;t.blur();t.focus()}}},findSquareByChild:function e(t){return BX.findParent(t,{className:this.parent.settings.classSquare},true,false)},getSquareData:function e(t){var i=BX.data(t,"item");return!!t&&!!i?JSON.parse(i):null},isSquareControl:function e(t){var i=this.getSquareData(t);return!!i&&(i.type==="control"||BX.type.isArray(i))},onPresetSquareRemove:function e(){var t=this.parent;var i=t.getPreset();var s=i.getCurrentPresetId();var n=t.getParam("RESET_TO_DEFAULT_MODE");var a=t.getParam("VALUE_REQUIRED");var r=i.isPinned(s);var l=this.getSquares();if(l.length===1){if(a&&r){this.parent.showPopup();this.adjustPlaceholder();this.parent.getPreset().deactivateAllPresets()}else{if(n&&r||!n){var o=true;this.lastPromise=t.resetFilter(o);t.closePopup()}}if(n&&!r){this.lastPromise=t.getPreset().applyPinnedPreset()}}if(l.length>1){var u=i.getPreset(i.getCurrentPresetId());var c=i.getPreset("tmp_filter");c.FIELDS=BX.clone(u.ADDITIONAL);u.ADDITIONAL=[];i.deactivateAllPresets();i.applyPreset("tmp_filter");t.applyFilter()}},onControlSquareRemove:function e(t){var i=this.parent;var s=i.getPreset();var n=i.getParam("RESET_TO_DEFAULT_MODE");var a=i.getParam("VALUE_REQUIRED");var r;if(n&&this.getSquares().length===1){if(a){r=this.getSquareData(t);i.clearControls(r);this.parent.showPopup();this.adjustPlaceholder();this.parent.getPreset().deactivateAllPresets()}else{this.lastPromise=i.getPreset().applyPinnedPreset()}}else{r=this.getSquareData(t);i.clearControls(r);i.closePopup();if(BX.type.isArray(r)){r.forEach(function(e){s.removeAdditionalField(e.name)})}if(BX.type.isPlainObject(r)){s.removeAdditionalField(r.name)}this.apply()}},onValueRequiredSquareRemove:function e(){var t=this.parent;t.getPreset().deactivateAllPresets();t.showPopup();this.adjustPlaceholder()},complexSquareRemove:function e(t){var i=this.parent.getParam("VALUE_REQUIRED_MODE");var s=!this.isSquareControl(t);if(i){this.onValueRequiredSquareRemove()}else{if(s){this.onPresetSquareRemove()}else{this.onControlSquareRemove(t)}}this.removeSquare(t);this.adjustClearButton()},adjustClearButton:function e(){!!this.getLastSquare()?this.showClearButton():this.hideClearButton()},removeSquare:function e(t){!!t&&BX.remove(t)},_onSearchContainerClick:function e(t){var i=this.parent;if(this.isClearButton(t.target)){if(!i.getParam("VALUE_REQUIRED")){if(!i.getParam("VALUE_REQUIRED_MODE")){if(i.getParam("RESET_TO_DEFAULT_MODE")){this.clearInput();this.lastPromise=i.getPreset().applyPinnedPreset()}else{i.resetFilter()}i.closePopup();this.adjustFocus()}else{this.removeSquares();i.showPopup();this.adjustPlaceholder();this.hideClearButton();i.getPreset().deactivateAllPresets()}}else{var s=i.getPreset().isPinned(i.getPreset().getCurrentPresetId());if(s||i.getPreset().getCurrentPresetId()==="tmp_filter"){var n=i.getPreset().getPreset(i.getPreset().getCurrentPresetId());if(n.ADDITIONAL.length){n.ADDITIONAL=[];this.lastPromise=i.getPreset().applyPreset(i.getPreset().getCurrentPresetId());this.apply()}else{this.removeSquares();i.showPopup();this.adjustPlaceholder();this.hideClearButton();i.getPreset().deactivateAllPresets()}}else{if(i.getParam("RESET_TO_DEFAULT_MODE")){this.lastPromise=i.getPreset().applyPinnedPreset()}else{i.resetFilter()}i.closePopup();this.adjustFocus()}this.clearInput()}}else if(this.isSearchButton(t.target)){this.apply();this.adjustFocus()}else if(this.isSquareRemoveButton(t.target)){var a=this.findSquareByChild(t.target);this.complexSquareRemove(a);this.adjustFocus()}else{if(!i.getPopup().isShown()){i.showPopup()}else{var r=this.getInput();var l=r.selectionStart;var o=r.selectionEnd;var u=this.getSearchString().length;if(!(u&&l===0&&o===u)){if(i.getParam("VALUE_REQUIRED")){if(!this.getSquares().length){this.lastPromise=i.getPreset().applyPinnedPreset()}else{i.closePopup()}}else{i.closePopup();if(i.getParam("VALUE_REQUIRED_MODE")){i.restoreRemovedPreset()}}}}}},_onKeyDown:function e(t){var i=BX.Filter.Utils;var s=this.parent;if(i.isKey(t,"enter")){if(s.getParam("VALUE_REQUIRED")){if(!this.getSquares().length){this.parent.getPreset().applyPinnedPreset()}else{this.apply();this.firstInit=false;this.lastSearchString=this.getSearchString()}}else{this.apply();this.firstInit=false;this.lastSearchString=this.getSearchString()}s.closePopup()}if(i.isKey(t,"tab")||i.isKey(t,"downArrow")){s.showPopup();s.adjustFocus();this.unselectSquares()}if(i.isKey(t,"upArrow")){s.closePopup();if(s.getParam("VALUE_REQUIRED_MODE")){this.parent.restoreRemovedPreset()}if(s.getParam("VALUE_REQUIRED")){if(!this.getSquares().length){this.parent.getPreset().applyPinnedPreset()}}}if(i.isKey(t,"a")&&t.metaKey||i.isKey(t,"a")&&t.ctrlKey){this.selectSquares()}if(i.isKey(t,"backspace")&&this.isTextSelected()&&this.isSquaresSelected()){clearTimeout(this.timeout);if(this.parent.getParam("VALUE_REQUIRED")){var n=this.parent.getPreset().isPinned(this.parent.getPreset().getCurrentPresetId());if(n){this.removeSquares();this.parent.showPopup();this.adjustPlaceholder();this.hideClearButton();this.parent.getPreset().deactivateAllPresets()}else{if(this.parent.getParam("RESET_TO_DEFAULT_MODE")){this.lastPromise=this.parent.getPreset().applyPinnedPreset()}else{this.parent.resetFilter()}this.parent.closePopup();this.adjustFocus()}this.clearInput()}else{if(this.parent.getParam("RESET_TO_DEFAULT_MODE")){this.lastPromise=this.parent.getPreset().applyPinnedPreset()}else{this.lastPromise=this.parent.resetFilter()}this.parent.closePopup()}}if(i.isKey(t,"backspace")&&this.isSelectionStart()){clearTimeout(this.timeout);var a=this.getLastSquare();this.isSquareSelected(a)?this.complexSquareRemove(a):this.selectSquare(a)}if(!i.isKey(t,"backspace")&&!t.metaKey&&this.isSquaresSelected()){this.unselectSquares()}},getSearchString:function e(){var t=this.getInput();return!!t?t.value:""},getSquares:function e(){return BX.Filter.Utils.getByClass(this.getContainer(),this.parent.settings.classSquare,true)},adjustPlaceholder:function e(){if(this.parent.getParam("LIMITS_ENABLED")){this.setInputPlaceholder(this.parent.getParam("MAIN_UI_FILTER__PLACEHOLDER_LIMITS_EXCEEDED"))}else if(this.parent.getParam("DISABLE_SEARCH")||!this.parent.settings.get("SEARCH")){this.setInputPlaceholder(this.parent.getParam("MAIN_UI_FILTER__PLACEHOLDER"))}else{this.setInputPlaceholder(this.parent.getParam("MAIN_UI_FILTER__PLACEHOLDER_DEFAULT"))}},isResolvedRequest:function e(){return!this.lastPromise||!!this.lastPromise&&this.lastPromise.state},apply:function e(){if(this.isResolvedRequest()){this.lastPromise=this.parent._onFindButtonClick()}return this.lastPromise},reset:function e(){if(this.isResolvedRequest()){this.parent.getSearch().removePreset();this.parent.getPreset().deactivateAllPresets();this.parent.getPreset().resetPreset(true);this.timeout=setTimeout(BX.delegate(function(){this.lastPromise=this.parent.resetFilter()},this),this.delay)}return this.lastPromise},_onInputWithoutDebounce:function e(){clearTimeout(this.timeout);var t=this.getSearchString();this.lastSearchString=!!this.lastSearchString?this.lastSearchString:t;if(t!==this.lastSearchString&&(!this.parent.isIe()||!this.firstInit)){if(this.parent.getParam("ENABLE_LIVE_SEARCH")){this.parent.showGridAnimation();BX.onCustomEvent(window,"BX.Filter.Search:input",[this.parent.params.FILTER_ID,t])}this.parent.getPopup().isShown()&&this.parent.closePopup()}if(t){this.showClearButton()}else{if(!this.getSquares().length&&this.lastSearchString!==t){this.hideClearButton();this.adjustPlaceholder()}}},_onInput:function e(){var t=this.getSearchString();if(t!==this.lastSearchString&&(!this.parent.isIe()||!this.firstInit)){this.apply()}this.firstInit=false;this.lastSearchString=t},getButtonsContainer:function e(){if(!BX.type.isDomNode(this.buttonsContainer)){this.buttonsContainer=BX.Filter.Utils.getByClass(this.getContainer(),this.parent.settings.classSearchButtonsContainer)}return this.buttonsContainer},showClearButton:function e(){BX.addClass(this.getButtonsContainer(),this.parent.settings.classShow)},hideClearButton:function e(){BX.removeClass(this.getButtonsContainer(),this.parent.settings.classShow)},getInput:function e(){var t;if(!BX.type.isDomNode(this.input)){t=[this.parent.getParam("FILTER_ID",""),"_search"].join("");this.input=BX(t)}return this.input},getContainer:function e(){var t;if(!BX.type.isDomNode(this.container)){t=[this.parent.getParam("FILTER_ID"),"_search_container"].join("");this.container=BX(t)}return this.container},setInputPlaceholder:function e(t){var i=this.getInput();i.placeholder=t},clearInput:function e(){var t=this.getInput();if(BX.type.isDomNode(t)){t.value=null}},clearForm:function e(){this.clearInput();this.removePreset()},makeSquares:function e(t,i,s){var n;var a=null;var r=this.getContainer();var l={squares:[],moreSquares:[]};t.forEach(function(e,t){if(t<i){n=BX.decl(e);a=a||n;if(!s){if(t===0){BX.prepend(n,r)}else{BX.insertAfter(n,a)}}else{var o=BX.Filter.Utils.getByClass(this.getContainer(),this.parent.settings.classSquare);if(o){BX.insertAfter(n,o)}else{BX.prepend(n,r)}}a=n;l.squares.push(n)}else{l.moreSquares.push({type:"control",name:e.value,title:e.title})}},this);return l},squares:function e(t,i,s){var n,a,r,l,o;var e=BX.Filter.Utils.getByClass(this.getContainer(),this.parent.settings.classSquare,true);if(s){e.forEach(function(e){var t=BX.data(e,"item");if(t){BX.remove(e)}})}else{e.forEach(BX.remove)}n=this.prepareSquaresData(t);a=this.makeSquares(n,i,s);l=0;o={squaresData:n,width:0};if(a.moreSquares.length){r={block:"main-ui-search-square",name:this.parent.getParam("MAIN_UI_FILTER__AND")+" "+this.parent.getParam("MAIN_UI_FILTER__MORE")+" "+a.moreSquares.length,item:a.moreSquares,title:a.moreSquares.map(function(e){return e.title}).join(", \n")};r=BX.decl(r);a.squares.push(r);BX.insertAfter(r,a.squares[a.squares.length-2]);l=a.squares.reduce(function(e,t){return e+BX.width(t)+(parseFloat(BX.style(t,"margin-right"))||0)},0)}o.width=l;return o},setPreset:function e(t){var i=this.getContainer();var s,n;var a;if(BX.type.isPlainObject(t)){n=BX.Filter.Utils.getByClass(i,this.parent.settings.classSquare,true);n.forEach(BX.remove);t=BX.clone(t);t.ADDITIONAL=t.ADDITIONAL||[];BX.onCustomEvent(window,"BX.Filter.Search:beforeSquaresUpdate",[t,this]);if(t.ID!=="default_filter"&&t.ID!=="tmp_filter"){s=BX.decl({block:"main-ui-search-square",name:t.TITLE,value:t.ID,isPreset:true});BX.prepend(s,i);if("ADDITIONAL"in t&&BX.type.isArray(t.ADDITIONAL)&&t.ADDITIONAL.length){a=this.squares(t.ADDITIONAL,1,true);if(BX.width(i)-a.width<100){a=this.squares(t.ADDITIONAL,0,true)}}}else{if("ADDITIONAL"in t&&BX.type.isArray(t.ADDITIONAL)&&t.ADDITIONAL.length){t.ADDITIONAL.forEach(function(e,i){if(!("ID"in e)){e.ID="ADDITIONAL_ID_"+i}if(!("NAME"in e)){e.NAME="ADDITIONAL_NAME_"+i}if(!("TYPE"in e)){e.TYPE="STRING"}if("LABEL"in e&&"LABEL"in e){t.FIELDS.push(e)}})}if(BX.type.isArray(t.FIELDS)&&t.FIELDS.length){a=this.squares(t.FIELDS,2);if(BX.width(i)-a.width<100){a=this.squares(t.FIELDS,1)}}}if(a&&BX.type.isArray(a.squaresData)&&a.squaresData.length||t.ID!=="default_filter"&&t.ID!=="tmp_filter"){if(this.parent.getParam("LIMITS_ENABLED")){this.setInputPlaceholder(this.parent.getParam("MAIN_UI_FILTER__PLACEHOLDER_LIMITS_EXCEEDED"))}else{this.setInputPlaceholder(this.parent.getParam("MAIN_UI_FILTER__PLACEHOLDER_WITH_FILTER"))}this.showClearButton()}else{this.adjustPlaceholder()}if(BX.type.isNotEmptyString(this.parent.getSearch().getInput().value)){this.showClearButton()}}},prepareSquaresData:function e(t){var i,s,n;var a=[];t=t.filter(function(e){return!!e&&this.parent.params.FIELDS.some(function(t){return e.NAME===t.NAME})},this);t.map(function(e){i=null;switch(e.TYPE){case this.parent.types.DATE:{i=e.LABEL+": "+e.SUB_TYPE.NAME;if(e.SUB_TYPE.VALUE===this.parent.dateTypes.QUARTER&&BX.type.isNotEmptyString(e.VALUES._quarter)){var t=e.QUARTERS.filter(function(t){return t.VALUE==e.VALUES._quarter}).map(function(e){return e.NAME});t=t.length?t.join(""):"";i=e.LABEL+": "+t+" "+this.parent.getParam("MAIN_UI_FILTER__QUARTER").toLocaleLowerCase()+" "+e.VALUES._year}if(e.SUB_TYPE.VALUE===this.parent.dateTypes.YEAR&&BX.type.isNotEmptyString(e.VALUES._year)){i=e.LABEL+": "+e.VALUES._year}if(e.SUB_TYPE.VALUE===this.parent.dateTypes.MONTH&&BX.type.isNotEmptyString(e.VALUES._month)){var r=e.MONTHS.filter(function(t){return t.VALUE==e.VALUES._month}).map(function(e){return e.NAME});r=r.length?r.join(""):"";i=e.LABEL+": "+r+" "+e.VALUES._year}if(e.SUB_TYPE.VALUE===this.parent.dateTypes.EXACT&&BX.type.isNotEmptyString(e.VALUES._from)){i=e.LABEL+": "+e.VALUES._from}if(e.SUB_TYPE.VALUE===this.parent.dateTypes.RANGE){if(BX.type.isNotEmptyString(e.VALUES._from)&&BX.type.isNotEmptyString(e.VALUES._to)){i=e.LABEL+": "+e.VALUES._from+"-"+e.VALUES._to}else if(!BX.type.isNotEmptyString(e.VALUES._from)&&BX.type.isNotEmptyString(e.VALUES._to)){i=e.LABEL+": "+this.parent.getParam("MAIN_UI_FILTER__BEFORE")+" "+e.VALUES._to}else if(BX.type.isNotEmptyString(e.VALUES._from)&&!BX.type.isNotEmptyString(e.VALUES._to)){i=e.LABEL+": "+this.parent.getParam("MAIN_UI_FILTER__AFTER")+" "+e.VALUES._from}}if((e.SUB_TYPE.VALUE===this.parent.dateTypes.NEXT_DAYS||e.SUB_TYPE.VALUE===this.parent.dateTypes.PREV_DAYS)&&!BX.type.isNumber(parseInt(e.VALUES._days))){i=null}if(e.SUB_TYPE.VALUE===this.parent.dateTypes.NEXT_DAYS&&BX.type.isNumber(parseInt(e.VALUES._days))){i=e.LABEL+": "+this.parent.getParam("MAIN_UI_FILTER__DATE_NEXT_DAYS_LABEL").replace("#N#",e.VALUES._days)}if(e.SUB_TYPE.VALUE===this.parent.dateTypes.PREV_DAYS&&BX.type.isNumber(parseInt(e.VALUES._days))){i=e.LABEL+": "+this.parent.getParam("MAIN_UI_FILTER__DATE_PREV_DAYS_LABEL").replace("#N#",e.VALUES._days)}if(e.SUB_TYPE.VALUE===this.parent.dateTypes.NONE){i=null}break}case this.parent.types.CUSTOM_DATE:{if(BX.type.isArray(e.VALUE.days)&&e.VALUE.days.length||BX.type.isArray(e.VALUE.months)&&e.VALUE.months.length||BX.type.isArray(e.VALUE.years)&&e.VALUE.years.length){i=e.LABEL}break}case this.parent.types.SELECT:{if(BX.type.isPlainObject(e.VALUE)&&e.VALUE.VALUE||e.STRICT){i=e.LABEL+": "+e.VALUE.NAME}break}case this.parent.types.MULTI_SELECT:{if(BX.type.isArray(e.VALUE)&&e.VALUE.length){s=[];i=e.LABEL+": ";e.VALUE.forEach(function(e,t){if(t<2){s.push(e.NAME)}});i+=s.join(", ");if(e.VALUE.length>2){n=[];e.VALUE.forEach(function(e){n.push(e.NAME)});i=n.join(", ")}}break}case this.parent.types.NUMBER:{if(e.SUB_TYPE.VALUE==="exact"){if(BX.type.isNotEmptyString(e.VALUES._from)){i=e.LABEL+": "+e.VALUES._from}else{i=null}}if(e.SUB_TYPE.VALUE==="range"){if(BX.type.isNotEmptyString(e.VALUES._from)&&BX.type.isNotEmptyString(e.VALUES._to)){i=e.LABEL+": "+e.VALUES._from+"-"+e.VALUES._to}else if(!BX.type.isNotEmptyString(e.VALUES._from)&&BX.type.isNotEmptyString(e.VALUES._to)){i=e.LABEL+": "+this.parent.getParam("MAIN_UI_FILTER__NUMBER_LESS")+" "+e.VALUES._to}else if(BX.type.isNotEmptyString(e.VALUES._from)&&!BX.type.isNotEmptyString(e.VALUES._to)){i=e.LABEL+": "+this.parent.getParam("MAIN_UI_FILTER__NUMBER_MORE")+" "+e.VALUES._from}else{i=null}}if(e.SUB_TYPE.VALUE==="more"){if(BX.type.isNotEmptyString(e.VALUES._from)){i=e.LABEL+": > ";i+=e.VALUES._from}}if(e.SUB_TYPE.VALUE==="less"){if(BX.type.isNotEmptyString(e.VALUES._to)){i=e.LABEL+": < ";i+=e.VALUES._to}}break}case this.parent.types.CUSTOM_ENTITY:case this.parent.types.DEST_SELECTOR:{if(e.MULTIPLE){var l=!!e.VALUES._label?e.VALUES._label:[];if(BX.type.isPlainObject(l)){l=Object.keys(l).map(function(e){return l[e]})}if(!BX.type.isArray(l)){l=[l]}if(l.length>0){i=e.LABEL+": ";i+=l.join(", ")}}else{if(BX.type.isNotEmptyString(e.VALUES._value)&&BX.type.isNotEmptyString(e.VALUES._label)){i=e.LABEL+": ";i+=e.VALUES._label}}break}case this.parent.types.CUSTOM:{i="_VALUE"in e&&BX.type.isNotEmptyString(e._VALUE)?e.LABEL:null;break}default:{if(BX.type.isNotEmptyString(e.VALUE)){i=e.LABEL+": "+e.VALUE}break}}if(i!==null){a.push({block:"main-ui-search-square",name:i,value:e.NAME,item:{type:"control",name:e.NAME},title:i})}},this);return a},getPreset:function e(){var t=this.getContainer();var i=this.parent.settings.classSquare;var s=null;if(BX.type.isDomNode(t)){s=BX.Filter.Utils.getByClass(t,i)}return s},removePreset:function e(){var t=this.getPreset();if(BX.type.isDomNode(t)){BX.remove(t);this.adjustPlaceholder()}this.hideClearButton()},updatePreset:function e(t){this.removePreset();this.setPreset(t)}}})();(function(){BX.namespace("BX.Filter");BX.Filter.Settings=function(e,t){this.classField="main-ui-control-field";this.classFieldGroup="main-ui-control-field-group";this.classFieldLine="main-ui-filter-field-line";this.classFieldDelete="main-ui-filter-field-delete";this.classFieldLabel="main-ui-control-field-label";this.classFieldWithLabel="main-ui-filter-wield-with-label";this.classPresetName="main-ui-filter-sidebar-item-text";this.classControl="main-ui-control";this.classDateInput="main-ui-date-input";this.classHide="main-ui-hide";this.classNumberInput="main-ui-number-input";this.classSelect="main-ui-select";this.classMultiSelect="main-ui-multi-select";this.classValueDelete="main-ui-control-value-delete";this.classStringInput="main-ui-control-string";this.classAddField="main-ui-filter-field-add-item";this.classAddPresetField="main-ui-filter-new-filter";this.classAddPresetFieldInput="main-ui-filter-sidebar-edit-control";this.classAddPresetButton="main-ui-filter-add-item";this.classButtonsContainer="main-ui-filter-field-button-container";this.classSaveButton="main-ui-filter-save";this.classCancelButton="main-ui-filter-cancel";this.classMenuItem="main-ui-select-inner-item";this.classMenuItemText="main-ui-select-inner-item-element";this.classMenuMultiItemText="main-ui-select-inner-label";this.classMenuItemChecked="main-ui-checked";this.classSearchContainer="main-ui-filter-search";this.classDefaultPopup="popup-window";this.classPopupFieldList="main-ui-filter-popup-field-list";this.classPopupFieldList1Column="main-ui-filter-field-list-1-column";this.classPopupFieldList2Column="main-ui-filter-field-list-2-column";this.classPopupFieldList3Column="main-ui-filter-field-list-3-column";this.classFieldListItem="main-ui-filter-field-list-item";this.classEditButton="main-ui-filter-add-edit";this.classPresetEdit="main-ui-filter-edit";this.classPresetNameEdit="main-ui-filter-edit-text";this.classPresetDeleteButton="main-ui-delete";this.classPresetDragButton="main-ui-filter-icon-grab";this.classPresetEditButton="main-ui-filter-icon-edit";this.classPresetEditInput="main-ui-filter-sidebar-item-input";this.classPresetOndrag="main-ui-filter-sidebar-item-ondrag";this.classSquare="main-ui-square";this.classSquareDelete="main-ui-square-delete";this.classSquareSelected="main-ui-square-selected";this.classPresetsContainer="main-ui-filter-sidebar-item-container";this.classPreset="main-ui-filter-sidebar-item";this.classPresetCurrent="main-ui-filter-current-item";this.classFilterContainer="main-ui-filter-wrapper";this.classFileldControlList="main-ui-filter-field-container-list";this.classRestoreFieldsButton="main-ui-filter-field-restore-items";this.classClearSearchValueButton="main-ui-delete";this.classSearchButtonsContainer="main-ui-item-icon-block";this.classSearchButton="main-ui-search";this.classDisabled="main-ui-disable";this.classAnimationShow="main-ui-popup-show-animation";this.classAnimationClose="main-ui-popup-close-animation";this.classLimitsAnimation="main-ui-filter-field-limits-animate";this.classSidebarControlsContainer="main-ui-filter-add-container";this.searchContainerPostfix="_search_container";this.classPresetButtonsContainer="main-ui-filter-field-preset-button-container";this.classFindButton="main-ui-filter-find";this.classResetButton="main-ui-filter-reset";this.classDefaultFilter="main-ui-filter-default-preset";this.classRestoreButton="main-ui-filter-reset-link";this.classPinButton="main-ui-filter-icon-pin";this.classPopupOverlay="popup-window-overlay";this.classPinnedPreset="main-ui-item-pin";this.classWaitButtonClass="ui-btn-clock";this.classForAllCheckbox="main-ui-filter-save-for-all";this.classShow="main-ui-show";this.classFocus="main-ui-focus";this.classPresetField="main-ui-filter-preset-field";this.numberPostfix="_numsel";this.datePostfix="_datesel";this.toPostfix="_to";this.fromPostfix="_from";this.daysPostfix="_days";this.monthPostfix="_month";this.quarterPostfix="_quarter";this.yearPostfix="_year";this.generalTemplateId="";this.init(e,t)};BX.Filter.Settings.prototype={init:function e(t,i){this.generalTemplateId=i.getParam("FILTER_ID")+"_GENERAL_template";this.mergeSettings(t)},get:function e(t,i){return t&&t in this&&!BX.type.isFunction(this[t])?this[t]:i},mergeSettings:function e(t){if(BX.type.isPlainObject(t)){Object.keys(t).forEach(function(e){if(!BX.type.isFunction(this[e])){this[e]=t[e]}},this)}}}})();(function(){BX.namespace("BX.Main");BX.Main.Filter=function(e,t,i,s,n,a){this.params=e;this.search=null;this.popup=null;this.presets=null;this.fields=null;this.types=i;this.dateTypes=s;this.additionalDateTypes=a;this.numberTypes=n;this.settings=new BX.Filter.Settings(t,this);this.filter=null;this.api=null;this.isAddPresetModeState=false;this.firstInit=true;this.emitter=new BX.Event.EventEmitter;this.init()};function e(e){if(BX.type.isString(e)){e=e.toLowerCase();e=e.replace(/[\-_\s]+(.)?/g,function(e,t){return t?t.toUpperCase():""});return e.substr(0,1).toLowerCase()+e.substr(1)}return e}BX.Main.Filter.prototype={init:function e(){BX.bind(document,"mousedown",BX.delegate(this._onDocumentClick,this));BX.bind(document,"keydown",BX.delegate(this._onDocumentKeydown,this));BX.bind(window,"load",BX.delegate(this.onWindowLoad,this));BX.addCustomEvent("Grid::ready",BX.delegate(this._onGridReady,this));this.getSearch().updatePreset(this.getParam("CURRENT_PRESET"))},getEmitter:function e(){return this.emitter},onWindowLoad:function e(){this.settings.get("AUTOFOCUS")&&this.adjustFocus()},clearGet:function e(){if("history"in window){var t=window.location.toString();var i=BX.util.remove_url_param(t,"apply_filter");window.history.replaceState(null,"",i)}},adjustFocus:function e(){this.getSearch().adjustFocus()},_onAddPresetKeydown:function e(t){if(BX.Filter.Utils.isKey(t,"enter")){this._onSaveButtonClick()}},_onDocumentKeydown:function e(t){if(BX.Filter.Utils.isKey(t,"escape")){if(this.getPopup().isShown()){BX.onCustomEvent(window,"BX.Main.Filter:blur",[this]);this.closePopup();if(this.getParam("VALUE_REQUIRED_MODE")){this.restoreRemovedPreset()}if(this.getParam("VALUE_REQUIRED")){if(!this.getSearch().getSquares().length){this.getPreset().applyPinnedPreset()}}}}},getApi:function e(){if(!(this.api instanceof BX.Filter.Api)){this.api=new BX.Filter.Api(this)}return this.api},addSidebarItem:function e(t,i,s){var n=this.getPreset();var a=n.getContainer();var r=n.createSidebarItem(t,i,s);var l=n.getPresetNodeById(t);if(BX.type.isDomNode(l)){BX.remove(l);BX.prepend(r,a)}else{a&&a.insertBefore(r,n.getAddPresetField())}BX.bind(r,"click",BX.delegate(n._onPresetClick,n))},saveUserSettings:function e(t){var i={FILTER_ID:this.getParam("FILTER_ID"),GRID_ID:this.getParam("GRID_ID"),action:"SET_FILTER_ARRAY"};var s=this.getPreset();var n=s.getCurrentPresetId();var a={};this.params["PRESETS"]=BX.clone(this.editablePresets);a.current_preset=n;s.getPresets().forEach(function(e,i){var n=s.getPresetId(e);if(n&&n!=="tmp_filter"){var r=s.getPreset(n);r.TITLE=BX.util.htmlspecialchars(BX.util.htmlspecialcharsback(r.TITLE));r.SORT=i;s.updatePresetName(e,r.TITLE);a[n]={sort:i,name:r.TITLE,fields:this.preparePresetSettingsFields(r.FIELDS),for_all:t&&!BX.type.isBoolean(r.FOR_ALL)||t&&r.FOR_ALL===true}}},this);this.saveOptions(a,i,null,t)},isForAll:function e(t){var i=this.getForAllCheckbox();return BX.type.isBoolean(t)&&t||!!i&&!!i.checked},getForAllCheckbox:function e(){if(!this.forAllCheckbox){this.forAllCheckbox=BX.Filter.Utils.getByClass(this.getFilter(),this.settings.classForAllCheckbox)}return this.forAllCheckbox},preparePresetSettingsFields:function e(t){var i={};var s;(t||[]).forEach(function(e){switch(e.TYPE){case this.types.STRING:{i[e.NAME]=e.VALUE;break}case this.types.TEXTAREA:{i[e.NAME]=e.VALUE;break}case this.types.SELECT:{i[e.NAME]="VALUE"in e.VALUE?e.VALUE.VALUE:"";break}case this.types.MULTI_SELECT:{if(BX.type.isArray(e.VALUE)&&e.VALUE.length){e.VALUE.forEach(function(t,s){i[e.NAME]=BX.type.isPlainObject(i[e.NAME])?i[e.NAME]:{};i[e.NAME][s]=t.VALUE},this)}break}case this.types.CHECKBOX:{if(BX.type.isArray(e.VALUE)&&e.VALUE.length){e.VALUE.forEach(function(t,s){i[e.NAME]=BX.type.isPlainObject(i[e.NAME])?i[e.NAME]:{};i[e.NAME][s]=t.VALUE},this)}break}case this.types.DATE:{if(BX.type.isPlainObject(e.VALUES)){s=Object.keys(e.VALUES);i[e.NAME+"_datesel"]=e.SUB_TYPE.VALUE;s.forEach(function(t){i[e.NAME+t]=e.VALUES[t]},this)}break}case this.types.NUMBER:{if(BX.type.isPlainObject(e.VALUES)){s=Object.keys(e.VALUES);i[e.NAME+"_numsel"]=e.SUB_TYPE.VALUE;s.forEach(function(t){i[e.NAME+t]=e.VALUES[t]},this)}break}case this.types.DEST_SELECTOR:{if(BX.type.isPlainObject(e.VALUES)){i[e.NAME]=e.VALUES._value;i[e.NAME+"_label"]=e.VALUES._label}break}case this.types.CUSTOM_ENTITY:{if(BX.type.isPlainObject(e.VALUES)){i[e.NAME]=e.VALUES._value;i[e.NAME+"_label"]=e.VALUES._label}break}default:{break}}},this);return i},savePreset:function e(){var t="filter_"+ +new Date;var i=BX.util.htmlspecialcharsback(this.getPreset().getAddPresetFieldInput().value);this.updatePreset(t,i,null,true,null,null,true);this.addSidebarItem(t,i);this.getPreset().applyPreset(t);this.getPreset().activatePreset(t);this.applyFilter()},updatePreset:function e(t,i,s,n,a,r,l){var o=this.getFilterFieldsValues();var u=this.getPreset().getFields().map(function(e){return BX.data(e,"name")});var c=this.getPreset().getCurrentPresetData();var h={FILTER_ID:this.getParam("FILTER_ID"),GRID_ID:this.getParam("GRID_ID"),action:"SET_FILTER"};var d,p,f,m,E;var g={};g.additional={};if(t!=="tmp_filter"&&t!=="default_filter"&&!l){var B=BX.type.isArray(c.ADDITIONAL)?c.ADDITIONAL:[];B.forEach(function(e){Object.keys(o).forEach(function(t){if(t.indexOf(e.NAME)!==-1){g.additional[t]=o[t];delete o[t]}})})}d=Object.keys(o);if(!s){g.apply_filter="Y"}else{g.clear_filter="Y"}g.save="Y";g.fields=o;g.rows=u.join(",");g.preset_id=t||c.ID;if(BX.type.isNotEmptyString(i)){g.name=BX.util.htmlspecialchars(i)}else{f=this.getPreset().getPresetNodeById(g.preset_id);m=this.getPreset().getPresetInput(f);if(BX.type.isDomNode(m)&&BX.type.isNotEmptyString(m.value)){g.name=m.value}else{g.name=c.TITLE}}if((!("sort"in g)||!BX.type.isNumber(g.sort))&&n){E=this.getParam("PRESETS");g.sort=E.length+2}if(!s){d.forEach(function(e){if(BX.type.isArray(g.fields[e])){p=g.fields[e].length?{}:"";g.fields[e].forEach(function(e,t){p[t]=e},this);if(p||BX.type.isNumber(p)||BX.type.isBoolean(p)){g.fields[e]=p}}},this)}if(g.preset_id==="tmp_filter"||this.isAddPresetEnabled()||s){this.updateParams(g)}if(BX.type.isFunction(a)){a()}var y=new BX.Promise(null,this);y.setAutoResolve("fulfill",0);y.then(function(){var e=new BX.Promise(null,this);this.saveOptions(g,h,BX.proxy(e.fulfill,e));return e}).then(function(){!!r&&r()});return y},saveFieldsSort:function e(){var t={FILTER_ID:this.getParam("FILTER_ID"),GRID_ID:this.getParam("GRID_ID"),action:"SET_FILTER"};var i=this.getPreset().getFields();var s={};s.preset_id="default_filter";if(BX.type.isArray(i)){s.rows=i.map(function(e){return BX.data(e,"name")});s.rows=s.rows.join(",")}this.updateParams(s);this.saveOptions(s,t)},updateParams:function e(t){var i,s;if(BX.type.isPlainObject(t)&&"preset_id"in t){i=this.getPreset().getPreset(t.preset_id);if(BX.type.isPlainObject(i)){if("name"in t&&BX.type.isNotEmptyString(t.name)){i.TITLE=t.name}if("rows"in t&&!("fields"in t)){t.fields={};t.rows.split(",").forEach(function(e){t.fields[e]=""})}if("fields"in t){i.FIELDS=this.preparePresetFields(t.fields,t.rows)}if("additional"in t&&i.ID!=="tmp_filter"){i.ADDITIONAL=this.preparePresetFields(t.additional,t.rows)}}else{s=this.getParam("PRESETS");i={ID:t.preset_id,TITLE:t.name,SORT:s.length+2,FIELDS:this.preparePresetFields(t.fields,t.rows)};s.push(i)}}},preparePresetFields:function e(t,i){var s,n;var a=[];if(BX.type.isPlainObject(t)){i=BX.type.isNotEmptyString(i)?i.split(","):[];s=i.length?i:Object.keys(t);s.forEach(function(e){e=e.replace("_datesel","").replace("_numsel","");n=BX.clone(this.getFieldByName(e));if(BX.type.isPlainObject(n)){if(n.TYPE===this.types.STRING){n.VALUE=t[e]}if(n.TYPE===this.types.TEXTAREA){n.VALUE=t[e]}if(n.TYPE===this.types.MULTI_SELECT){n.VALUE=this.prepareMultiSelectValue(t[e],n.ITEMS)}if(n.TYPE===this.types.SELECT||n.TYPE===this.types.CHECKBOX){n.VALUE=this.prepareSelectValue(t[e],n.ITEMS)}if(n.TYPE===this.types.DATE){n.SUB_TYPE=this.prepareSelectValue(t[e+"_datesel"],n.SUB_TYPES);n.VALUES={_from:t[e+"_from"],_to:t[e+"_to"],_days:t[e+"_days"],_month:t[e+"_month"],_quarter:t[e+"_quarter"],_year:t[e+"_year"],_allow_year:t[e+"_allow_year"]}}if(n.TYPE===this.types.CUSTOM_DATE){n.VALUE={days:Object.keys(t[e+"_days"]||{}).map(function(i){return t[e+"_days"][i]}),months:Object.keys(t[e+"_months"]||{}).map(function(i){return t[e+"_months"][i]}),years:Object.keys(t[e+"_years"]||{}).map(function(i){return t[e+"_years"][i]})}}if(n.TYPE===this.types.NUMBER){n.SUB_TYPE=this.prepareSelectValue(t[e+"_numsel"],n.SUB_TYPES);n.VALUES={_from:t[e+"_from"],_to:t[e+"_to"]}}if(n.TYPE===this.types.DEST_SELECTOR){if(typeof t[e+"_label"]!=="undefined"){n.VALUES._label=t[e+"_label"]}if(typeof t[e]!=="undefined"){n.VALUES._value=t[e]}}if(n.TYPE===this.types.CUSTOM_ENTITY){if(typeof t[e+"_label"]!=="undefined"){n.VALUES._label=t[e+"_label"]}if(typeof t[e]!=="undefined"){n.VALUES._value=t[e]}}if(n.TYPE===this.types.CUSTOM){n._VALUE=t[e]}a.push(n)}},this)}return a},prepareSelectValue:function e(t,i){var s={};var n;if(BX.type.isNotEmptyString(t)&&BX.type.isArray(i)){n=this.prepareMultiSelectValue({0:t},i);s=n.length>0?n[0]:{}}else{s=i[0]}return s},prepareMultiSelectValue:function e(t,i){var s=[];if(BX.type.isPlainObject(t)&&BX.type.isArray(i)){var n=Object.keys(t);var a=n.map(function(e){return t[e]});s=i.filter(function(e){return a.some(function(t){return t===e.VALUE})},this)}return s},getFieldByName:function e(t){var i=this.getParam("FIELDS");var s=i.find(function(e){return e.NAME===t});if(s){return s}var n=this.getFieldListContainer().querySelector('[data-name="'+t+'"]');s=BX.Filter.Field.instances.get(n);if(s){return s.options}return null},confirmSaveForAll:function e(){return new Promise(function(e){var t={CONFIRM:true,CONFIRM_MESSAGE:this.getParam("MAIN_UI_FILTER__CONFIRM_MESSAGE_FOR_ALL"),CONFIRM_APPLY_BUTTON:this.getParam("MAIN_UI_FILTER__CONFIRM_APPLY_FOR_ALL"),CONFIRM_CANCEL_BUTTON:this.getParam("CONFIRM_CANCEL")};this.confirmDialog(t,e)}.bind(this))},saveOptions:function t(i,s,n,a){s.action=e(s.action);s.forAll=this.isForAll(a);s.commonPresetsId=this.getParam("COMMON_PRESETS_ID");s.apply_filter=i.apply_filter||"N";s.clear_filter=i.clear_filter||"N";s.with_preset=i.with_preset||"N";s.save=i.save||"N";var r={params:s,data:i};delete i.apply_filter;delete i.save;delete i.clear_filter;delete i.with_preset;if(s.forAll&&s.action==="setFilterArray"){return this.confirmSaveForAll().then(function(){return this.backend(s.action,r)}.bind(this)).then(function(){this.disableEdit();this.disableAddPreset()}.bind(this))}return this.backend(s.action,r).then(function(){BX.removeClass(this.getFindButton(),this.settings.classWaitButtonClass);BX.type.isFunction(n)&&n()}.bind(this))},backend:function e(t,i){return BX.ajax.runComponentAction("bitrix:main.ui.filter",t,{mode:"ajax",data:i,analyticsLabel:{FILTER_ID:this.getParam("FILTER_ID"),GRID_ID:this.getParam("GRID_ID")}})},prepareEvent:function e(t){var i,s;if(!("path"in t)||!t.path.length){t.path=[t.target];i=0;while((s=t.path[i++].parentNode)!==null){t.path.push(s)}}return t},restoreRemovedPreset:function e(){if(this.getParam("VALUE_REQUIRED_MODE")){var t=this.getParam("CURRENT_PRESET");if(BX.type.isPlainObject(t)){var i=t.ID;var s=this.getPreset().getPresetNodeById(i);this.getPreset().applyPreset(i);this.getPreset().activatePreset(s)}}},hasScrollClick:function e(t){var i="clientX"in t?t.clientX:"x"in t?t.x:0;return i>=document.documentElement.offsetWidth},isUseCommonPresets:function e(){return!!this.getParam("COMMON_PRESETS_ID")},isInsideFilterEvent:function e(t){t=this.prepareEvent(t);return(t.path||[]).some(function(e){return BX.type.isDomNode(e)&&(BX.hasClass(e,this.settings.classFilterContainer)||BX.hasClass(e,this.settings.classSearchContainer)||BX.hasClass(e,this.settings.classDefaultPopup)||BX.hasClass(e,this.settings.classPopupOverlay))},this)},_onDocumentClick:function e(t){var i=this.getPopup();if(!this.isInsideFilterEvent(t)&&!this.hasScrollClick(t)){if(i&&i.isShown()){this.closePopup();if(this.getParam("VALUE_REQUIRED_MODE")){this.restoreRemovedPreset()}if(this.getParam("VALUE_REQUIRED")){if(!this.getSearch().getSquares().length){this.getPreset().applyPinnedPreset()}}}BX.onCustomEvent(window,"BX.Main.Filter:blur",[this])}},_onAddFieldClick:function e(t){var i=this.getFieldsPopup();t.stopPropagation();t.preventDefault();if(i&&!i.isShown()){this.showFieldsPopup();this.syncFields()}else{this.closeFieldListPopup()}},syncFields:function e(t){if(BX.type.isPlainObject(t)){if(t.cache===false){this.fieldsPopupItems=null}}var i=this.getPreset().getFields();var s=this.getFieldsPopupItems();var n,a;if(BX.type.isArray(s)&&s.length){s.forEach(function(e){n=BX.data(e,"name").replace("_datesel","").replace("_numsel","");a=i.some(function(e){return BX.data(e,"name")===n});if(a){BX.addClass(e,this.settings.classMenuItemChecked)}else{BX.removeClass(e,this.settings.classMenuItemChecked)}},this)}},getFieldsPopupItems:function e(){if(!BX.type.isArray(this.fieldsPopupItems)){var t=this.getFieldsPopup();if("contentContainer"in t&&BX.type.isDomNode(t.contentContainer)){this.fieldsPopupItems=BX.Filter.Utils.getByClass(t.contentContainer,this.settings.classMenuItem,true)}}return this.fieldsPopupItems},getFieldListContainerClassName:function e(t){var i=this.settings.classPopupFieldList1Column;if(t>6&&t<12){i=this.settings.classPopupFieldList2Column}if(t>12){i=this.settings.classPopupFieldList3Column}return i},prepareFieldsDecl:function e(t){return(t||[]).map(function(e){return{block:"main-ui-filter-field-list-item",label:"LABEL"in e?e.LABEL:"",id:"ID"in e?e.ID:"",name:"NAME"in e?e.NAME:"",item:e,onClick:BX.delegate(this._clickOnFieldListItem,this)}},this)},getLazyLoadFields:function e(){var t=new BX.Promise;BX.ajax({method:"GET",url:this.getParam("LAZY_LOAD")["GET_LIST"],dataType:"json",onsuccess:function e(i){t.fulfill(i)}});return t},getFieldsListPopupContent:function e(){var t=new BX.Promise;var i=this.getParam("FIELDS");var s=BX.type.isArray(i)?i.length:0;if(this.getParam("LAZY_LOAD")){var n=function(e){var i={block:this.settings.classPopupFieldList,mix:this.getFieldListContainerClassName(e.length),content:this.prepareFieldsDecl(e)};t.fulfill(BX.decl(i))}.bind(this);if(BX.type.isNotEmptyObject(this.getParam("LAZY_LOAD")["CONTROLLER"])){var a=this.getParam("LAZY_LOAD")["CONTROLLER"]["componentName"];var r=this.getParam("LAZY_LOAD")["CONTROLLER"]["signedParameters"];BX.ajax.runAction(this.getParam("LAZY_LOAD")["CONTROLLER"]["getList"],{data:{filterId:this.getParam("FILTER_ID"),componentName:BX.type.isNotEmptyString(a)?a:"",signedParameters:BX.type.isNotEmptyString(r)?r:""}}).then(function(e){n(e.data)}.bind(this),function(e){})}else{this.getLazyLoadFields().then(n)}return t}var l={block:this.settings.classPopupFieldList,mix:this.getFieldListContainerClassName(s),content:this.prepareFieldsDecl(i)};t.fulfill(BX.decl(l));return t},getFieldLoader:function e(){if(!this.fieldLoader){this.fieldLoader=new BX.Loader({mode:"custom",size:18,offset:{left:"5px",top:"5px"}})}return this.fieldLoader},_clickOnFieldListItem:function e(t){var i=t.target;var s;if(!BX.hasClass(i,this.settings.classFieldListItem)){i=BX.findParent(i,{className:this.settings.classFieldListItem},true,false)}if(BX.type.isDomNode(i)){try{s=JSON.parse(BX.data(i,"item"))}catch(e){}var n=new BX.Promise;if(this.getParam("LAZY_LOAD")){this.getFieldLoader().show(i);var a=i.querySelector(".main-ui-select-inner-label");if(a){a.classList.add("main-ui-no-before")}var r=function(e){n.fulfill(e);this.getFieldLoader().hide();if(a){a.classList.remove("main-ui-no-before")}}.bind(this);if(BX.type.isNotEmptyObject(this.getParam("LAZY_LOAD")["CONTROLLER"])){var l=this.getParam("LAZY_LOAD")["CONTROLLER"]["componentName"];var o=this.getParam("LAZY_LOAD")["CONTROLLER"]["signedParameters"];BX.ajax.runAction(this.getParam("LAZY_LOAD")["CONTROLLER"]["getField"],{data:{filterId:this.getParam("FILTER_ID"),id:s.NAME,componentName:BX.type.isNotEmptyString(l)?l:"",signedParameters:BX.type.isNotEmptyString(o)?o:""}}).then(function(e){r(e.data)}.bind(this),function(e){})}else{this.getLazyLoadField(s.NAME).then(r)}}else{n.fulfill(s)}n.then(function(e){this.params.FIELDS.push(e);if(BX.hasClass(i,this.settings.classMenuItemChecked)){BX.removeClass(i,this.settings.classMenuItemChecked);this.getPreset().removeField(e)}else{if(BX.type.isPlainObject(e)){this.getPreset().addField(e);BX.addClass(i,this.settings.classMenuItemChecked);if(BX.type.isString(e.HTML)){var t=BX.create("div");this.getHiddenElement().appendChild(t);BX.html(t,e.HTML)}}}this.syncFields()}.bind(this))}},getHiddenElement:function e(){if(!this.hiddenElement){this.hiddenElement=BX.create("div");document.body.appendChild(this.hiddenElement)}return this.hiddenElement},getLazyLoadField:function e(t){var i=new BX.Promise;BX.ajax({method:"get",url:BX.util.add_url_param(this.getParam("LAZY_LOAD")["GET_FIELD"],{id:t}),dataType:"json",onsuccess:function e(t){i.fulfill(t)}});return i},showFieldsPopup:function e(){var t=this.getFieldsPopup();this.adjustFieldListPopupPosition();t.show()},closeFieldListPopup:function e(){var t=this.getFieldsPopup();t.close()},adjustFieldListPopupPosition:function e(){var t=this.getFieldsPopup();var i=BX.pos(this.getAddField());i.forceBindPosition=true;t.adjustPosition(i)},getFieldsPopup:function e(){var t=this.getAddField();if(!this.fieldsPopup){this.fieldsPopup=new BX.PopupWindow(this.getParam("FILTER_ID")+"_fields_popup",t,{autoHide:true,offsetTop:4,offsetLeft:0,lightShadow:true,closeIcon:false,closeByEsc:false,noAllPaddings:true,zIndex:13});this.fieldsPopupLoader=new BX.Loader({target:this.fieldsPopup.contentContainer});this.fieldsPopupLoader.show();this.fieldsPopup.contentContainer.style.width="630px";this.fieldsPopup.contentContainer.style.height="330px";this.getFieldsListPopupContent().then(function(e){this.fieldsPopup.contentContainer.removeAttribute("style");this.fieldsPopupLoader.hide();this.fieldsPopup.setContent(e);this.syncFields({cache:false})}.bind(this))}return this.fieldsPopup},_onAddPresetClick:function e(){this.enableAddPreset()},enableWaitSate:function e(t){!!t&&BX.addClass(t,this.settings.classWaitButtonClass)},disableWaitState:function e(t){!!t&&BX.removeClass(t,this.settings.classWaitButtonClass)},_onSaveButtonClick:function e(){var t=!!this.getSaveForAllCheckbox()&&this.getSaveForAllCheckbox().checked;var i=this.getPreset().getAddPresetFieldInput();var s=i.parentNode.querySelector(".main-ui-filter-edit-mask");var n;function a(e){if(e.animationName==="fieldError"){e.currentTarget.removeEventListener("animationend",a);e.currentTarget.removeEventListener("oAnimationEnd",a);e.currentTarget.removeEventListener("webkitAnimationEnd",a);e.currentTarget.classList.remove("main-ui-filter-error")}}function r(e){e.addEventListener("animationend",a);e.addEventListener("oAnimationEnd",a);e.addEventListener("webkitAnimationEnd",a);e.classList.add("main-ui-filter-error");var t=new BX.Promise;t.fulfill(true);return t}this.enableWaitSate(this.getFindButton());if(this.isAddPresetEnabled()&&!t){n=i.value;if(n.length){this.savePreset();this.disableAddPreset()}else{r(s).then(function(){i.focus()})}}if(this.isEditEnabled()){var l=this.getPreset();var o=l.getPresetNodeById(l.getCurrentPresetId());var u=l.getPresetInput(o);if(u.value.length){l.updateEditablePreset(l.getCurrentPresetId());this.saveUserSettings(t);!t&&this.disableEdit()}else{var c=o.querySelector(".main-ui-filter-edit-mask");r(c).then(function(){u.focus()})}}},_onCancelButtonClick:function e(){this.disableAddPreset();this.getPreset().clearAddPresetFieldInput();this.disableEdit();!!this.getSaveForAllCheckbox()&&(this.getSaveForAllCheckbox().checked=null)},_onGridReady:function e(t){if(!this.grid&&t.getContainerId()===this.getParam("GRID_ID")){this.grid=t}},_onFilterMousedown:function e(t){var i=t.target;if(this.getFields().isDragButton(i)){var s=BX.Filter.Utils.getByTag(i.parentNode,"input",true);(s||[]).forEach(function(e){BX.fireEvent(e,"blur")});BX.fireEvent(this.getFilter(),"click")}},_onFilterClick:function e(t){var i=this.getFields();var s=this.getPreset();var n;if(i.isFieldDelete(t.target)){n=i.getField(t.target);s.removeField(n)}if(i.isFieldValueDelete(t.target)){n=i.getField(t.target);i.clearFieldValue(n)}},getButtonsContainer:function e(){return BX.Filter.Utils.getByClass(this.getFilter(),this.settings.classButtonsContainer)},getSaveButton:function e(){return BX.Filter.Utils.getByClass(this.getFilter(),this.settings.classSaveButton)},getCancelButton:function e(){return BX.Filter.Utils.getByClass(this.getFilter(),this.settings.classCancelButton)},getFindButton:function e(){return BX.Filter.Utils.getByClass(this.getFilter(),this.settings.classFindButton)},getResetButton:function e(){return BX.Filter.Utils.getByClass(this.getFilter(),this.settings.classResetButton)},getAddPresetButton:function e(){return BX.Filter.Utils.getByClass(this.getFilter(),this.settings.classAddPresetButton)},isAddPresetEnabled:function e(){return this.isAddPresetModeState},enableAddPreset:function e(){var t=this.getPreset();var i=t.getAddPresetField();var s=t.getAddPresetFieldInput();var n=this.getButtonsContainer();BX.show(i);BX.show(n);BX.hide(this.getPresetButtonsContainer());this.hideForAllCheckbox();if(BX.type.isDomNode(s)){s.focus()}BX.addClass(this.getSidebarControlsContainer(),this.settings.classDisabled);this.isAddPresetModeState=true},disableAddPreset:function e(){var t=this.getPreset();var i=t.getAddPresetField();var s=this.getButtonsContainer();BX.hide(i);BX.hide(s);BX.show(this.getPresetButtonsContainer());this.showForAllCheckbox();t.getAddPresetFieldInput().value="";BX.removeClass(this.getSidebarControlsContainer(),this.settings.classDisabled);this.isAddPresetModeState=false},getControls:function e(){var t=this.getFieldListContainer();var i=null;if(BX.type.isDomNode(t)){i=BX.Filter.Utils.getByClass(t,this.settings.classControl,true)}return i},getFilterFields:function e(){var t=this.getFieldListContainer();var i=[];var s=[];if(BX.type.isDomNode(t)){i=BX.Filter.Utils.getByClass(t,this.settings.classField,true);s=BX.Filter.Utils.getByClass(t,this.settings.classFieldGroup,true);if(!BX.type.isArray(i)){i=[]}if(BX.type.isArray(s)){s.forEach(function(e){i.push(e)})}}return i},getFilterFieldsValues:function e(){var t=this.getPreset().getFields();var i=this.getSearch();var s={};var n,a;s["FIND"]=i.getInput().value;if(BX.type.isArray(t)&&t.length){t.forEach(function(e){n=BX.data(e,"type");a=BX.data(e,"name");switch(n){case this.types.STRING:{this.prepareControlStringValue(s,e);break}case this.types.TEXTAREA:{this.prepareControlTextareaValue(s,e);break}case this.types.NUMBER:{this.prepareControlNumberValue(s,a,e);break}case this.types.DATE:{this.prepareControlDateValue(s,a,e);break}case this.types.CUSTOM_DATE:{this.prepareControlCustomDateValue(s,a,e);break}case this.types.SELECT:{this.prepareControlSelectValue(s,a,e);break}case this.types.MULTI_SELECT:{this.prepareControlMultiselectValue(s,a,e);break}case this.types.DEST_SELECTOR:{this.prepareControlCustomEntityValue(s,a,e);break}case this.types.CUSTOM:{this.prepareControlCustomValue(s,a,e);break}case this.types.CUSTOM_ENTITY:{this.prepareControlCustomEntityValue(s,a,e);break}default:{break}}},this)}return s},prepareControlCustomEntityValue:function e(t,i,s){var n=this.fetchSquares(s);var a=this.fetchSquaresData(n);var r=BX.Main.ui.CustomEntity.isMultiple(s);t[i]="";t[i+"_label"]="";if(r){t[i]=[];t[i+"_label"]=[];!!a&&a.forEach(function(e){t[i].push(e._value.toString());t[i+"_label"].push(e._label.toString())})}else{if(a.length){t[i]=a[0]._value.toString();t[i+"_label"]=a[0]._label.toString()}}},fetchSquares:function e(t){return!!t?BX.Filter.Utils.getByClass(t,this.settings.classSquare,true):[]},fetchSquaresData:function e(t){return t.map(function(e){return JSON.parse(BX.data(e,"item"))},this)},prepareControlCustomValue:function e(t,i,s){var n=BX.Filter.Utils.getByTag(s,"input",true);t[i]="";if(BX.type.isArray(n)){n.forEach(function(e){if(BX.type.isNotEmptyString(e.name)){t[e.name]=e.value}})}},prepareControlMultiselectValue:function e(t,i,s){var n=BX.Filter.Utils.getByClass(s,this.settings.classMultiSelect);var a=JSON.parse(BX.data(n,"value"));t[i]="";if(BX.type.isArray(a)&&a.length){t[i]={};a.forEach(function(e,s){t[i][s]=e.VALUE})}},prepareControlSelectValue:function e(t,i,s){var n=BX.Filter.Utils.getByClass(s,this.settings.classSelect);var a=JSON.parse(BX.data(n,"value"));t[i]=a.VALUE},prepareControlCustomDateValue:function e(t,i,s){var n=s.querySelector('[data-name="'+i+"_days"+'"]');if(n){var a=JSON.parse(n.dataset.value);t[i+"_days"]=a.map(function(e){return e.VALUE})}var r=s.querySelector('[data-name="'+i+"_months"+'"]');if(r){var l=JSON.parse(r.dataset.value);t[i+"_months"]=l.map(function(e){return e.VALUE})}var o=s.querySelector('[data-name="'+i+"_years"+'"]');if(o){var u=JSON.parse(o.dataset.value);t[i+"_years"]=u.map(function(e){return e.VALUE})}},prepareControlDateValue:function e(t,i,s,n){var a=s.querySelector(".main-ui-filter-additional-fields-container");if(a&&!n){BX.remove(a)}var r=BX.Filter.Utils.getByClass(s,this.settings.classSelect);var l=s.querySelector('.main-ui-select[data-name*="_allow_year"]');var o=i+this.settings.datePostfix;var u=i+this.settings.fromPostfix;var c=i+this.settings.toPostfix;var h=i+this.settings.daysPostfix;var d=i+this.settings.monthPostfix;var p=i+this.settings.quarterPostfix;var f=i+this.settings.yearPostfix;var m=i+"_allow_year";var E,g,B,y,v;t[o]="";t[u]="";t[c]="";t[h]="";t[d]="";t[p]="";t[f]="";var A=s.querySelector(".main-ui-date-input");if(A&&A.dataset.isValid==="false"){return}E=JSON.parse(BX.data(r,"value"));t[o]=E.VALUE;if(l){v=JSON.parse(BX.data(l,"value"));t[m]=v.VALUE}switch(E.VALUE){case this.dateTypes.EXACT:{g=BX.Filter.Utils.getByClass(s,this.settings.classDateInput);t[u]=g.value;t[c]=g.value;break}case this.dateTypes.QUARTER:{B=BX.Filter.Utils.getByClass(s,this.settings.classControl,true);if(BX.type.isArray(B)){B.forEach(function(e){y=BX.data(e,"name");if(y&&y.indexOf("_quarter")!==-1){t[p]=JSON.parse(BX.data(e,"value")).VALUE}if(y&&y.endsWith("_year")&&!y.endsWith("_allow_year")){t[f]=JSON.parse(BX.data(e,"value")).VALUE}},this)}break}case this.dateTypes.YEAR:{B=BX.Filter.Utils.getByClass(s,this.settings.classControl,true);if(BX.type.isArray(B)){B.forEach(function(e){y=BX.data(e,"name");if(y&&y.endsWith("_year")&&!y.endsWith("_allow_year")){t[f]=JSON.parse(BX.data(e,"value")).VALUE}},this)}break}case this.dateTypes.MONTH:{B=BX.Filter.Utils.getByClass(s,this.settings.classControl,true);if(BX.type.isArray(B)){B.forEach(function(e){y=BX.data(e,"name");if(y&&y.indexOf("_month")!==-1){t[d]=JSON.parse(BX.data(e,"value")).VALUE}if(y&&y.endsWith("_year")&&!y.endsWith("_allow_year")){t[f]=JSON.parse(BX.data(e,"value")).VALUE}},this)}break}case this.additionalDateTypes.PREV_DAY:case this.additionalDateTypes.NEXT_DAY:case this.additionalDateTypes.MORE_THAN_DAYS_AGO:case this.additionalDateTypes.AFTER_DAYS:case this.dateTypes.NEXT_DAYS:case this.dateTypes.PREV_DAYS:{var P=BX.Filter.Utils.getByClass(s,this.settings.classNumberInput);if(!!P&&P.name===h){t[h]=P.value}break}case this.dateTypes.RANGE:{g=BX.Filter.Utils.getByClass(s,this.settings.classDateInput,true);g.forEach(function(e){if(e.name===u){t[u]=e.value}else if(e.name===c){t[c]=e.value}},this);break}case"CUSTOM_DATE":{var _={};this.prepareControlCustomDateValue(_,i,s);t[i+"_days"]=_[i+"_days"];t[d]=_[i+"_months"];t[f]=_[i+"_years"];break}default:{break}}if(a&&!n){BX.append(a,s)}var S=Array.from(s.querySelectorAll('.main-ui-filter-additional-fields-container > [data-type="DATE"]'));if(S){S.forEach(function(e){var i=e.dataset.name;this.prepareControlDateValue(t,i,e,true)},this)}},prepareControlNumberValue:function e(t,i,s){var n=BX.Filter.Utils.getByClass(s,this.settings.classNumberInput,true);var a=BX.Filter.Utils.getByClass(s,this.settings.classSelect);var r=i+this.settings.numberPostfix;var l=i+this.settings.fromPostfix;var o=i+this.settings.toPostfix;var u;t[l]="";t[o]="";u=JSON.parse(BX.data(a,"value"));t[r]=u.VALUE;n.forEach(function(e){if(e.name.indexOf(this.settings.fromPostfix)!==-1){t[l]=e.value||"";if(t[r]==="exact"){t[o]=e.value||""}}else if(e.name.indexOf(this.settings.toPostfix)!==-1){t[o]=e.value||""}},this)},prepareControlStringValue:function e(t,i){var s=BX.Filter.Utils.getByClass(i,this.settings.classStringInput);var n;if(BX.type.isDomNode(s)){n=s.name;t[n]=s.value}},prepareControlTextareaValue:function e(t,i){var s=BX.Filter.Utils.getByClass(i,this.settings.classStringInput);var n;if(BX.type.isDomNode(s)){n=s.name;t[n]=s.value}},showGridAnimation:function e(){this.grid&&this.grid.tableFade()},hideGridAnimation:function e(){this.grid&&this.grid.tableUnfade()},getPresetId:function e(t,i){var s=this.getPreset().getCurrentPresetId();if(!this.isEditEnabled()&&!this.isAddPresetEnabled()&&!i||s==="default_filter"&&!t){s="tmp_filter"}return s},applyFilter:function e(t,i){var s=this.getPresetId(t,i);var n=this.getParam("FILTER_ID");var a=new BX.Promise(null,this);var r=this.getPreset();var l=this.getSearch();var o={autoResolve:!this.grid};var u=this;this.clearGet();this.showGridAnimation();var c=t?"clear":"apply";BX.onCustomEvent(window,"BX.Main.Filter:beforeApply",[n,{action:c},this,a]);this.updatePreset(s,null,t,null).then(function(){l.updatePreset(r.getPreset(s));if(u.getParam("VALUE_REQUIRED")){if(!l.getSquares().length){u.lastPromise=r.applyPinnedPreset()}}}).then(function(){var e={apply_filter:"Y",clear_nav:"Y"};var t=BX.delegate(a.fulfill,a);var i=BX.delegate(a.reject,a);u.grid&&u.grid.reloadTable("POST",e,t,i);BX.onCustomEvent(window,"BX.Main.Filter:apply",[n,{action:c},u,a,o]);o.autoResolve&&a.fulfill()});return a},getAddField:function e(){return BX.Filter.Utils.getByClass(this.getFilter(),this.settings.classAddField)},getFieldListContainer:function e(){return BX.Filter.Utils.getByClass(this.getFilter(),this.settings.classFileldControlList)},getFields:function e(){if(!(this.fields instanceof BX.Filter.Fields)){this.fields=new BX.Filter.Fields(this)}return this.fields},getPreset:function e(){if(!(this.presets instanceof BX.Filter.Presets)){this.presets=new BX.Filter.Presets(this)}return this.presets},resetControlData:function e(t){if(BX.type.isPlainObject(t)){switch(t.TYPE){case this.types.MULTI_SELECT:{t.VALUE=[];break}case this.types.SELECT:{t.VALUE=t.ITEMS[0];break}case this.types.DATE:{t.SUB_TYPE=t.SUB_TYPES[0];t.VALUES={_from:"",_to:"",_days:"",_quarter:"",_year:""};break}case this.types.CUSTOM_DATE:{t.VALUES={days:[],months:[],years:[]};break}case this.types.NUMBER:{t.SUB_TYPE=t.SUB_TYPES[0];t.VALUES={_from:"",_to:""};break}case this.types.DEST_SELECTOR:{t.VALUES={_label:"",_value:""};break}case this.types.CUSTOM_ENTITY:{t.VALUES={_label:"",_value:""};break}case this.types.CUSTOM:{t._VALUE="";break}default:{t.VALUE=""}}}return t},clearControl:function e(t){var i=this.getPreset().getField({NAME:t});var s,n;if(BX.type.isDomNode(i)){s=this.getFieldByName(t);s=this.resetControlData(s);n=this.getPreset().createControl(s);BX.insertAfter(n,i);BX.remove(i)}},clearControls:function e(t){if(BX.type.isArray(t)){t.forEach(function(e){"name"in e&&this.clearControl(e.name)},this)}else if(BX.type.isPlainObject(t)&&"name"in t){this.clearControl(t.name)}},getTemplate:function e(){return BX.html(BX(this.settings.generalTemplateId))},isIe:function e(){if(!BX.type.isBoolean(this.ie)){this.ie=BX.hasClass(document.documentElement,"bx-ie")}return this.ie},closePopup:function e(){var t=this.getPopup();var i=t.popupContainer;var s=this.settings.get("FILTER_CLOSE_DELAY");var n;setTimeout(BX.delegate(function(){if(!this.isIe()){BX.removeClass(i,this.settings.classAnimationShow);BX.addClass(i,this.settings.classAnimationClose);n=parseFloat(BX.style(i,"animation-duration"));if(BX.type.isNumber(n)){n=n*1e3}setTimeout(function(){t.close()},n)}else{t.close()}},this),s);if(this.getParam("LIMITS_ENABLED")){BX.removeClass(this.getFilter(),this.settings.classLimitsAnimation)}this.closeFieldListPopup();this.adjustFocus()},showPopup:function e(){var t=this.getPopup();var i;if(!t.isShown()){this.isOpened=true;var s=this.settings.get("FILTER_SHOW_DELAY");setTimeout(BX.delegate(function(){t.show();if(!this.isIe()){i=t.popupContainer;BX.removeClass(i,this.settings.classAnimationClose);BX.addClass(i,this.settings.classAnimationShow);BX.onCustomEvent(window,"BX.Main.Filter:show",[this])}var e=[].slice.call(this.getFieldListContainer().querySelectorAll("textarea"));e.forEach(function(e){BX.style(e,"height",e.scrollHeight+"px")})},this),s)}},getSaveForAllCheckbox:function e(){if(!this.saveForAllCheckbox&&!!this.getSaveForAllCheckboxContainer()){this.saveForAllCheckbox=BX.Filter.Utils.getBySelector(this.getSaveForAllCheckboxContainer(),'input[type="checkbox"]')}return this.saveForAllCheckbox},getSaveForAllCheckboxContainer:function e(){if(!this.saveForAllCheckboxContainer){this.saveForAllCheckboxContainer=BX.Filter.Utils.getByClass(this.getFilter(),this.settings.classForAllCheckbox)}return this.saveForAllCheckboxContainer},showForAllCheckbox:function e(){!!this.getSaveForAllCheckboxContainer()&&BX.removeClass(this.getSaveForAllCheckboxContainer(),this.settings.classHide)},hideForAllCheckbox:function e(){!!this.getSaveForAllCheckboxContainer()&&BX.addClass(this.getSaveForAllCheckboxContainer(),this.settings.classHide)},getPopupBindElement:function e(){if(!this.popupBindElement){var t=this.settings.get("POPUP_BIND_ELEMENT_SELECTOR");var i=null;if(BX.type.isNotEmptyString(t)){i=BX.Filter.Utils.getBySelector(document,t)}this.popupBindElement=!!i?i:this.getSearch().getContainer()}return this.popupBindElement},getPopup:function e(){if(!(this.popup instanceof BX.PopupWindow)){this.popup=new BX.PopupWindow(this.getParam("FILTER_ID")+this.settings.searchContainerPostfix,this.getPopupBindElement(),{autoHide:false,offsetTop:parseInt(this.settings.get("POPUP_OFFSET_TOP")),offsetLeft:parseInt(this.settings.get("POPUP_OFFSET_LEFT")),lightShadow:true,closeIcon:false,closeByEsc:false,noAllPaddings:true,zIndex:12});this.popup.setContent(this.getTemplate());BX.bind(this.getFieldListContainer(),"keydown",BX.delegate(this._onFieldsContainerKeydown,this));BX.bind(this.getFilter(),"click",BX.delegate(this._onFilterClick,this));BX.bind(this.getAddPresetButton(),"click",BX.delegate(this._onAddPresetClick,this));BX.bind(this.getPreset().getAddPresetFieldInput(),"keydown",BX.delegate(this._onAddPresetKeydown,this));BX.bind(this.getPreset().getContainer(),"keydown",BX.delegate(this._onPresetInputKeydown,this));BX.bind(this.getSaveButton(),"click",BX.delegate(this._onSaveButtonClick,this));BX.bind(this.getCancelButton(),"click",BX.delegate(this._onCancelButtonClick,this));BX.bind(this.getFindButton(),"click",BX.delegate(this._onFindButtonClick,this));BX.bind(this.getResetButton(),"click",BX.delegate(this._onResetButtonClick,this));BX.bind(this.getAddField(),"click",BX.delegate(this._onAddFieldClick,this));BX.bind(this.getEditButton(),"click",BX.delegate(this._onEditButtonClick,this));BX.bind(this.getRestoreButton(),"click",BX.delegate(this._onRestoreButtonClick,this));BX.bind(this.getRestoreFieldsButton(),"click",BX.delegate(this._onRestoreFieldsButtonClick,this));this.getFilter().addEventListener("mousedown",BX.delegate(this._onFilterMousedown,this),true);this.getPreset().showCurrentPresetFields();this.getPreset().bindOnPresetClick()}return this.popup},_onRestoreFieldsButtonClick:function e(){this.restoreDefaultFields()},restoreDefaultFields:function e(){var t=this.getPreset().getPreset("default_filter",true);var i=this.getParam("PRESETS");var s=this.getPreset().getCurrentPresetId();var n={FILTER_ID:this.getParam("FILTER_ID"),GRID_ID:this.getParam("GRID_ID"),action:"SET_FILTER"};var a=t.FIELDS.map(function(e){return e.NAME});var r=a.join(",");i.forEach(function(e,s){if(e.ID==="default_filter"){i[s]=BX.clone(t)}},this);if(BX.type.isArray(this.editablePresets)){this.editablePresets.forEach(function(e,i){if(e.ID==="default_filter"){this.editablePresets[i]=BX.clone(t)}},this)}this.getPreset().applyPreset(s);this.updatePreset(s);this.saveOptions({preset_id:"default_filter",rows:r,save:"Y",apply_filter:"N"},n)},getRestoreFieldsButton:function e(){if(!this.restoreFieldsButton){this.restoreFieldsButton=BX.Filter.Utils.getByClass(this.getFilter(),this.settings.classRestoreFieldsButton)}return this.restoreFieldsButton},restoreFilter:function e(){var t=this.getParam("DEFAULT_PRESETS");var i=this.getParam("PRESETS");var s=false;var n,a,r;if(BX.type.isArray(t)){t.sort(function(e,t){return e.SORT<t.SORT});t.forEach(function(e){s=i.some(function(t,i){if(t.ID===e.ID){n=i;return true}});if(s){i[n]=BX.clone(e)}else{i.push(BX.clone(e))}if(e.ID!=="default_filter"){this.addSidebarItem(e.ID,e.TITLE,e.PINNED);if(e.PINNED){a=e.ID}}},this)}this.saveRestoreFilter();this.disableAddPreset();this.disableEdit();if(!a){a="default_filter"}r=this.getPreset().getPresetNodeById(a);if(r){BX.fireEvent(r,"click")}},saveRestoreFilter:function e(){var t={FILTER_ID:this.getParam("FILTER_ID"),GRID_ID:this.getParam("GRID_ID"),action:"RESTORE_FILTER"};var i=this.getParam("PRESETS");var s={};var n;if(BX.type.isArray(i)){i.forEach(function(e){n=e.FIELDS.map(function(e){return e.NAME});n=n.join(",");s[e.ID]={name:e.TITLE||null,sort:e.SORT,preset_id:e.ID,fields:this.prepareFields(e.FIELDS),rows:n,for_all:e.FOR_ALL}},this);this.saveOptions(s,t)}},prepareFields:function e(t){var i={};var s;if(BX.type.isArray(t)){t.forEach(function(e){if(e.TYPE===this.types.SELECT){i[e.NAME]="VALUE"in e.VALUE?e.VALUE.VALUE:""}if(e.TYPE===this.types.MULTI_SELECT){e.VALUE.forEach(function(t,s){i[e.NAME]=i[e.NAME]||{};i[e.NAME][s]=t.VALUE});i[e.NAME]=i[e.NAME]||""}if(e.TYPE===this.types.DATE||e.TYPE===this.types.NUMBER){s=Object.keys(e.VALUES);s.forEach(function(t){i[e.NAME+t]=e.VALUES[t]});if(e.TYPE===this.types.DATE){i[e.NAME+"_datesel"]="VALUE"in e.SUB_TYPE?e.SUB_TYPE.VALUE:e.SUB_TYPES[0].VALUE}if(e.TYPE===this.types.NUMBER){i[e.NAME+"_numsel"]="VALUE"in e.SUB_TYPE?e.SUB_TYPE.VALUE:e.SUB_TYPES[0].VALUE}}if(e.TYPE===this.types.DEST_SELECTOR){i[e.NAME+"_label"]=e.VALUES._label;i[e.NAME+"_value"]=e.VALUES._value}if(e.TYPE===this.types.CUSTOM_ENTITY){i[e.NAME+"_label"]=e.VALUES._label;i[e.NAME+"_value"]=e.VALUES._value}},this)}return i},getRestoreButton:function e(){if(!BX.type.isDomNode(this.restoreButton)){this.restoreButton=BX.Filter.Utils.getByClass(this.getFilter(),this.settings.classRestoreButton)}return this.restoreButton},_onPresetInputKeydown:function e(t){if(BX.Filter.Utils.isKey(t,"enter")&&t.target.tagName==="INPUT"){BX.fireEvent(this.getSaveButton(),"click")}},_onFieldsContainerKeydown:function e(t){if(BX.Filter.Utils.isKey(t,"enter")&&t.target.tagName==="INPUT"){BX.fireEvent(this.getFindButton(),"click")}},_onFindButtonClick:function e(){var t=this.getPreset();var i=t.getCurrentPresetId();var s;if(i!=="tmp_filter"&&i!=="default_filter"&&!t.isPresetValuesModified(i)){var n=t.getPreset(i);var a=t.getAdditionalValues(i);var r=t.getFields().map(function(e){return BX.data(e,"name")});n.ADDITIONAL=this.preparePresetFields(a,r);n.ADDITIONAL=n.ADDITIONAL.filter(function(e){return!this.getPreset().isEmptyField(e)},this);s=this.applyFilter(false,i);this.closePopup()}else{t.deactivateAllPresets();s=this.applyFilter();this.closePopup()}return s},_onResetButtonClick:function e(){if(this.getParam("VALUE_REQUIRED")){var t=this.getPreset().getCurrentPresetData();if(t.ADDITIONAL.length){this.closePopup()}BX.fireEvent(this.getSearch().getClearButton(),"click")}else{if(this.getParam("RESET_TO_DEFAULT_MODE")){this.getSearch().clearInput();this.getPreset().applyPinnedPreset()}else{this.resetFilter()}this.closePopup()}},resetFilter:function e(t){var i=this.getSearch();var s=this.getPreset();if(!t){i.clearInput()}i.removePreset();s.deactivateAllPresets();s.resetPreset(true);i.hideClearButton();i.adjustPlaceholder();return this.applyFilter(true,true)},_onEditButtonClick:function e(){if(!this.isEditEnabled()){this.enableEdit()}else{this.disableEdit()}},enableFieldsDragAndDrop:function e(){var t=this.getPreset().getFields();this.fieldsList=[];if(BX.type.isArray(t)){this.fieldsList=t.map(this.registerDragItem,this)}},registerDragItem:function e(t){var i=this.getDragButton(t);if(i){i.onbxdragstart=BX.delegate(this._onFieldDragStart,this);i.onbxdragstop=BX.delegate(this._onFieldDragStop,this);i.onbxdrag=BX.delegate(this._onFieldDrag,this);jsDD.registerObject(i);jsDD.registerDest(i)}return t},unregisterDragItem:function e(t){var i=this.getDragButton(t);if(i){jsDD.unregisterObject(i);jsDD.unregisterDest(i)}},_onFieldDragStart:function e(){this.dragItem=this.getFields().getField(jsDD.current_node);this.dragIndex=BX.Filter.Utils.getIndex(this.fieldsList,this.dragItem);this.dragRect=this.dragItem.getBoundingClientRect();this.offset=this.dragRect.height;this.dragStartOffset=jsDD.start_y-(this.dragRect.top+BX.scrollTop(window));BX.Filter.Utils.styleForEach(this.fieldsList,{transition:"100ms"});BX.addClass(this.dragItem,this.settings.classPresetOndrag);BX.bind(document,"mousemove",BX.delegate(this._onMouseMove,this))},_onFieldDragStop:function e(){BX.unbind(document,"mousemove",BX.delegate(this._onMouseMove,this));BX.removeClass(this.dragItem,this.settings.classPresetOndrag);BX.Filter.Utils.styleForEach(this.fieldsList,{transition:"",transform:""});BX.Filter.Utils.collectionSort(this.dragItem,this.targetItem);this.fieldsList=this.getPreset().getFields();this.saveFieldsSort()},_onFieldDrag:function e(){var t=this;var i,s;this.dragOffset=this.realY-this.dragRect.top-this.dragStartOffset;this.sortOffset=t.realY+BX.scrollTop(window);BX.Filter.Utils.styleForEach([this.dragItem],{transition:"0ms",transform:"translate3d(0px, "+this.dragOffset+"px, 0px)"});this.fieldsList.forEach(function(e,n){if(e){i=e.getBoundingClientRect();s=i.top+BX.scrollTop(window)+i.height/2;if(n>t.dragIndex&&t.sortOffset>s&&e.style.transform!=="translate3d(0px, "+-t.offset+"px, 0px)"&&e.style.transform!==""){t.targetItem=e;BX.style(e,"transform","translate3d(0px, "+-t.offset+"px, 0px)");BX.style(e,"transition","300ms")}if(n<t.dragIndex&&t.sortOffset<s&&e.style.transform!=="translate3d(0px, "+t.offset+"px, 0px)"&&e.style.transform!==""){t.targetItem=e;BX.style(e,"transform","translate3d(0px, "+t.offset+"px, 0px)");BX.style(e,"transition","300ms")}if((n<t.dragIndex&&t.sortOffset>s||n>t.dragIndex&&t.sortOffset<s)&&e.style.transform!=="translate3d(0px, 0px, 0px)"){if(e.style.transform!==""){t.targetItem=e}BX.style(e,"transform","translate3d(0px, 0px, 0px)");BX.style(e,"transition","300ms")}}})},disableFieldsDragAndDrop:function e(){if(BX.type.isArray(this.fieldsList)&&this.fieldsList.length){this.fieldsList.map(this.unregisterDragItem,this)}},enablePresetsDragAndDrop:function e(){var t,i,s,n;t=this.getPreset();i=t.getPresets();this.presetsList=[];if(BX.type.isArray(i)&&i.length){i.forEach(function(e){n=t.getPresetId(e);if(!BX.hasClass(e,this.settings.classAddPresetField)&&n!=="default_filter"&&!BX.hasClass(e,this.settings.classDefaultFilter)){s=this.getDragButton(e);s.onbxdragstart=BX.delegate(this._onDragStart,this);s.onbxdragstop=BX.delegate(this._onDragStop,this);s.onbxdrag=BX.delegate(this._onDrag,this);jsDD.registerObject(s);jsDD.registerDest(s);this.presetsList.push(e)}},this)}},getDragButton:function e(t){return BX.Filter.Utils.getByClass(t,this.settings.classPresetDragButton)},disablePresetsDragAndDrop:function e(){if(BX.type.isArray(this.presetsList)&&this.presetsList.length){this.presetsList.forEach(function(e){if(!BX.hasClass(e,this.settings.classAddPresetField)){jsDD.unregisterObject(e);jsDD.unregisterDest(e)}},this)}},_onDragStart:function e(){this.dragItem=this.getPreset().normalizePreset(jsDD.current_node);this.dragIndex=BX.Filter.Utils.getIndex(this.presetsList,this.dragItem);this.dragRect=this.dragItem.getBoundingClientRect();this.offset=this.dragRect.height;this.dragStartOffset=jsDD.start_y-(this.dragRect.top+BX.scrollTop(window));BX.Filter.Utils.styleForEach(this.list,{transition:"100ms"});BX.addClass(this.dragItem,this.settings.classPresetOndrag);BX.bind(document,"mousemove",BX.delegate(this._onMouseMove,this))},_onMouseMove:function e(t){this.realX=t.clientX;this.realY=t.clientY},getDragOffset:function e(){return jsDD.x-this.startDragOffset-this.dragRect.left},_onDragStop:function e(){var t,i;BX.unbind(document,"mousemove",BX.delegate(this._onMouseMove,this));BX.removeClass(this.dragItem,this.settings.classPresetOndrag);BX.Filter.Utils.styleForEach(this.presetsList,{transition:"",transform:""});BX.Filter.Utils.collectionSort(this.dragItem,this.targetItem);t=this.getPreset();i=t.getPresets();this.presetsList=[];if(BX.type.isArray(i)&&i.length){i.forEach(function(e){if(!BX.hasClass(e,this.settings.classAddPresetField)&&!BX.hasClass(e,this.settings.classDefaultFilter)){this.presetsList.push(e)}},this)}},_onDrag:function e(){var t=this;var i,s;this.dragOffset=this.realY-this.dragRect.top-this.dragStartOffset;this.sortOffset=t.realY+BX.scrollTop(window);BX.Filter.Utils.styleForEach([this.dragItem],{transition:"0ms",transform:"translate3d(0px, "+this.dragOffset+"px, 0px)"});this.presetsList.forEach(function(e,n){if(e){i=e.getBoundingClientRect();s=i.top+BX.scrollTop(window)+i.height/2;if(n>t.dragIndex&&t.sortOffset>s&&e.style.transform!=="translate3d(0px, "+-t.offset+"px, 0px)"&&e.style.transform!==""){t.targetItem=e;BX.style(e,"transform","translate3d(0px, "+-t.offset+"px, 0px)");BX.style(e,"transition","300ms")}if(n<t.dragIndex&&t.sortOffset<s&&e.style.transform!=="translate3d(0px, "+t.offset+"px, 0px)"&&e.style.transform!==""){t.targetItem=e;BX.style(e,"transform","translate3d(0px, "+t.offset+"px, 0px)");BX.style(e,"transition","300ms")}if((n<t.dragIndex&&t.sortOffset>s||n>t.dragIndex&&t.sortOffset<s)&&e.style.transform!=="translate3d(0px, 0px, 0px)"){if(e.style.transform!==""){t.targetItem=e}BX.style(e,"transform","translate3d(0px, 0px, 0px)");BX.style(e,"transition","300ms")}}})},getSidebarControlsContainer:function e(){if(!BX.type.isDomNode(this.sidebarControlsContainer)){this.sidebarControlsContainer=BX.Filter.Utils.getByClass(this.getFilter(),this.settings.classSidebarControlsContainer)}return this.sidebarControlsContainer},enableEdit:function e(){var t=this.getPreset();var i=t.getPresets();var s;if(BX.type.isArray(i)&&i.length){i.forEach(function(e){s=t.getPresetId(e);if(!BX.hasClass(e,this.settings.classAddPresetField)&&s!=="default_filter"){BX.addClass(e,this.settings.classPresetEdit)}},this)}this.enablePresetsDragAndDrop();BX.show(this.getButtonsContainer());BX.hide(this.getPresetButtonsContainer());BX.addClass(this.getSidebarControlsContainer(),this.settings.classDisabled);this.editablePresets=BX.clone(this.getParam("PRESETS"));this.isEditEnabledState=true},disableEdit:function e(){var t=this.getPreset();var i=t.getPresets();if(BX.type.isArray(i)&&i.length){i.forEach(function(e){if(!BX.hasClass(e,this.settings.classAddPresetField)){BX.removeClass(e,this.settings.classPresetEdit);this.getPreset().disableEditPresetName(e)}},this)}this.disablePresetsDragAndDrop();if(!this.isAddPresetEnabled()){BX.style(this.getButtonsContainer(),"display","")}BX.show(this.getPresetButtonsContainer());BX.removeClass(this.getSidebarControlsContainer(),this.settings.classDisabled);this.editablePresets=null;this.isEditEnabledState=false;this.applyFilter(null,true)},getPresetButtonsContainer:function e(){if(!BX.type.isDomNode(this.presetButtonsContainer)){this.presetButtonsContainer=BX.Filter.Utils.getByClass(this.getFilter(),this.settings.classPresetButtonsContainer)}return this.presetButtonsContainer},isEditEnabled:function e(){return this.isEditEnabledState},getEditButton:function e(){return BX.Filter.Utils.getByClass(this.getFilter(),this.settings.classEditButton)},getParam:function e(t,i){return t in this.params?this.params[t]:i},getFilter:function e(){return BX.Filter.Utils.getByClass(this.getPopup().contentContainer,this.settings.classFilterContainer)},getSearch:function e(){if(!(this.search instanceof BX.Filter.Search)){this.search=new BX.Filter.Search(this)}return this.search},_onRestoreButtonClick:function e(){var t={CONFIRM:true,CONFIRM_MESSAGE:this.getParam("CONFIRM_MESSAGE"),CONFIRM_APPLY_BUTTON:this.getParam("CONFIRM_APPLY"),CONFIRM_CANCEL_BUTTON:this.getParam("CONFIRM_CANCEL")};this.confirmDialog(t,BX.delegate(this.restoreFilter,this))},confirmDialog:function e(t,i,s){if("CONFIRM"in t&&t.CONFIRM){var n=this.getParam("FILTER_ID")+"-confirm-dialog";var a='<div class="main-ui-filter-confirm-content">'+t.CONFIRM_MESSAGE+"</div>";var r="CONFIRM_TITLE"in t?t.CONFIRM_TITLE:"";var l=new BX.PopupWindowButton({text:t.CONFIRM_APPLY_BUTTON,events:{click:function e(){BX.type.isFunction(i)?i():null;this.popupWindow.close();this.popupWindow.destroy()}}});var o=new BX.PopupWindowButtonLink({text:t.CONFIRM_CANCEL_BUTTON,events:{click:function e(){BX.type.isFunction(s)?s():null;this.popupWindow.close();this.popupWindow.destroy()}}});var u=new BX.PopupWindow(n,null,{content:a,titleBar:r,autoHide:false,zIndex:9999,overlay:.4,offsetTop:-100,closeIcon:true,closeByEsc:true,buttons:[l,o]});BX.addCustomEvent(u,"onPopupClose",BX.delegate(function(){!!this.getSaveForAllCheckbox()&&(this.getSaveForAllCheckbox().checked=null)},this));if(!u.isShown()){u.show();var c=u.popupContainer;BX.removeClass(c,this.settings.classAnimationShow);BX.addClass(c,this.settings.classAnimationShow)}}else{BX.type.isFunction(i)?i():null}},getInitialValue:function e(t){if(BX.type.isString(t)){var i=this.params.INITIAL_FILTER;if(BX.type.isPlainObject(i)){var s=Object.entries(i).reduce(function(e,i){if(i[0].startsWith(t)){e.push(i)}return e},[]);if(s.length===1){return s[0][1]}if(s.length>1){return s.reduce(function(e,i){e[i[0].replace(t,"")]=i[1];return e},{})}}}return""},getField:function e(t){var i=this.getFieldListContainer().querySelector('[data-name="'+t+'"]');return BX.Filter.Field.instances.get(i)}}})();(function(){BX.Main.filterManager={data:{},push:function e(t,i){if(BX.type.isNotEmptyString(t)&&i){this.data[t]=i}},getById:function e(t){var i=null;if(t in this.data){i=this.data[t]}return i}}})();function i(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="main-ui-filter-additional-fields-container"></div>\n\t\t\t']);i=function t(){return e};return e}var s=Symbol("onValueChange");var n=function(e){babelHelpers.inherits(n,e);function n(e){var i;babelHelpers.classCallCheck(this,n);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(n).call(this,e));i.id=e.options.NAME;i.parent=e.parent;i.node=e.node;i.options=babelHelpers.objectSpread({},e.options);i.cache=new t.Cache.MemoryCache;i[s]=i[s].bind(babelHelpers.assertThisInitialized(i));t.Event.bind(i.node,"input",i[s]);t.Event.bind(i.node,"change",i[s]);var a=babelHelpers.toConsumableArray(i.node.querySelectorAll(".main-ui-control-value-delete"));a.forEach(function(e){e.addEventListener("click",function(){setTimeout(function(){i[s]()})})});var r=new MutationObserver(function(){i[s]()});var l=babelHelpers.toConsumableArray(i.node.querySelectorAll(".main-ui-select"));l.forEach(function(e){r.observe(e,{attributeFilter:["data-value"]})});n.instances.set(i.node,babelHelpers.assertThisInitialized(i));return i}babelHelpers.createClass(n,[{key:s,value:function e(){this.emit("BX.Filter.Field:change",{field:this,value:this.getValue()})}},{key:"getAdditionalFieldContainer",value:function e(){return this.cache.remember("additionalFieldsContainer",function(){return t.Tag.render(i())})}},{key:"hasAdditional",value:function e(){return t.Dom.hasClass(this.node,"main-ui-filter-field-with-additional-fields")}},{key:"addAdditionalField",value:function e(i){if(!this.hasAdditional()){t.Dom.addClass(this.node,"main-ui-filter-field-with-additional-fields");t.Dom.append(this.getAdditionalFieldContainer(),this.node)}var s=this.parent.getPreset();var a=this.prepareFieldOptions(i);var r=s.createControl(a);this.appendRenderedField(r);return n.instances.get(r)}},{key:"prepareListItems",value:function e(){var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};if(t.Type.isPlainObject(i)){return Object.entries(i).map(function(e){var t=babelHelpers.slicedToArray(e,2),i=t[0],s=t[1];return{NAME:s,VALUE:i}})}return{}}},{key:"prepareFieldOptions",value:function e(i){var s=this;if(t.Type.isPlainObject(i)){var n=this.parent.params.FIELDS_STUBS;var a=i.type,r=a===void 0?"string":a;var l=n.find(function(e){return e.NAME===r});if(t.Type.isPlainObject(l)){var o=babelHelpers.objectSpread({},l,{NAME:i.id,LABEL:i.name,TYPE:r==="checkbox"?"SELECT":l.TYPE,VALUE_REQUIRED:i.valueRequired===true});if(r==="list"){return babelHelpers.objectSpread({},o,{ITEMS:[].concat(babelHelpers.toConsumableArray(o.ITEMS),[this.prepareListItems(i.items)]),params:{isMulti:function(){if(t.Type.isPlainObject(i.params)){return i.params===true}return false}()}})}if(r==="date"){var u=function(){if(t.Type.isPlainObject(i.value)&&Reflect.has(i.value,"_datesel")){return i.value._datesel}return s.parent.dateTypes.NONE}();return babelHelpers.objectSpread({},o,{SUB_TYPES:function(){if(t.Type.isArray(i.exclude)){return o.SUB_TYPES.filter(function(e){return!i.exclude.includes(e.VALUE)})}return o.SUB_TYPES}(),SUB_TYPE:function(){return o.SUB_TYPES.find(function(e){return e.VALUE===u})}(),VALUES:function(){if(t.Type.isPlainObject(i.value)){return babelHelpers.objectSpread({},i.value)}return o.VALUES}()})}if(r==="string"||r==="custom_date"||r==="number"||r==="checkbox"||r==="custom_entity"){return o}}}return i}},{key:"appendRenderedField",value:function e(i){if(t.Type.isDomNode(i)){var s=this.getAdditionalFieldContainer();t.Dom.append(i,s)}}},{key:"getValue",value:function e(){var t=this.parent.getFilterFieldsValues();var i=this.options,s=i.TYPE,n=i.NAME;if(s==="DATE"||s==="NUMBER"){return Object.entries(t).reduce(function(e,t){var i=babelHelpers.slicedToArray(t,2),s=i[0],a=i[1];if(s.startsWith(n)){e[s.replace(n,"")]=a}return e},{})}if(n in t){return t[n]}return""}},{key:"setValue",value:function e(i){var s=this;var n=this.options.TYPE;if(n==="DATE"||n==="NUMBER"){if(t.Type.isPlainObject(i)){var a=this.parent.getFieldListContainer();Object.entries(i).forEach(function(e){var i=babelHelpers.slicedToArray(e,2),n=i[0],r=i[1];var l=a.querySelector('[data-name="'.concat(s.id,'"] [data-name="').concat(s.id).concat(n,'"], [data-name="').concat(s.id,'"] [name="').concat(s.id).concat(n,'"]'));if(l){if(t.Dom.hasClass(l,"main-ui-select")){var o=t.Dom.attr(l,"data-items");if(t.Type.isArray(o)){var u=o.find(function(e){return e.VALUE===r});if(t.Type.isPlainObject(u)){t.Dom.attr(l,"data-value",u);var c=l.querySelector(".main-ui-select-name");if(c){c.innerText=u.NAME}l.click();var h=BX.Main.ui.Factory.get(l);if(t.Type.isPlainObject(h)){BX.onCustomEvent(window,"UI::Select::Change",[h.instance,u])}}}}else if(l.tagName==="INPUT"){l.value=r}}})}}}}]);return n}(t.Event.EventEmitter);babelHelpers.defineProperty(n,"instances",new WeakMap);var a=function(){function e(t){babelHelpers.classCallCheck(this,e);this.parent=t}babelHelpers.createClass(e,[{key:"setFields",value:function e(i){if(t.Type.isPlainObject(i)){this.parent.getPopup();var s=this.parent.getPreset();s.deactivateAllPresets();var n={preset_id:"tmp_filter",fields:i};this.parent.updateParams(n);s.applyPreset("tmp_filter")}}},{key:"setFilter",value:function e(i){if(t.Type.isObject(i)){this.parent.updateParams(i);this.parent.getPreset().deactivateAllPresets();this.parent.getPreset().activatePreset(i.preset_id);this.parent.getPreset().applyPreset(i.preset_id);if(!i.checkFields||!this.parent.getPreset().isPresetValuesModified(i.preset_id)){this.parent.applyFilter(false,i.preset_id)}else{var s={};if(t.Type.isPlainObject(i.fields)){s=Object.assign({},i.fields)}if(t.Type.isPlainObject(i.additional)){s=Object.assign({},i.additional)}this.parent.getPreset().deactivateAllPresets();this.setFields(s);this.apply()}}}},{key:"extendFilter",value:function e(i){var s=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;if(t.Type.isObject(i)){Object.keys(i).forEach(function(e){if(t.Type.isNumber(i[e])){i[e]=String(i[e])}});var n=this.parent.getPreset().getCurrentPresetId();if(s||n==="tmp_filter"||n==="default_filter"){var a=Object.assign({},this.parent.getFilterFieldsValues(),i);this.setFields(a);this.apply();return}var r=this.parent.getPreset().getAdditionalValues(n);if(t.Type.isPlainObject(r)&&Object.keys(r).length){i=Object.assign({},r,i)}this.setFilter({preset_id:n,additional:i,checkFields:true})}}},{key:"apply",value:function e(){if(!this.parent.isEditEnabled()){if(!this.parent.isEditEnabled()){this.parent.applyFilter()}this.parent.closePopup();if(this.parent.isAddPresetEnabled()){this.parent.disableAddPreset()}}}},{key:"getEmitter",value:function e(){return this.parent.emitter}}]);return e}();function r(e){return{block:"main-ui-control-field",type:e.type,dragButton:false,content:{block:"main-ui-date",mix:["filter-type-single"],calendarButton:true,valueDelete:true,placeholder:e.placeholder,name:e.name,tabindex:e.tabindex,value:e.value,enableTime:e.enableTime}}}function l(e){return{block:"main-ui-control-field",type:e.type,dragButton:false,content:{block:"main-ui-number",mix:["filter-type-single"],valueDelete:true,placeholder:e.placeholder,name:e.name,tabindex:e.tabindex,value:e.value}}}function o(){return{block:"main-ui-filter-field-line",content:{block:"main-ui-filter-field-line-item",tag:"span"}}}function u(e){return{block:"main-ui-control-field",dragButton:false,content:{block:"main-ui-select",tabindex:e.tabindex,value:e.value,items:e.items,name:e.name,valueDelete:false}}}function c(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div \n\t\t\t\tclass="main-ui-filter-error-message" \n\t\t\t\ttitle="','">\n\t\t\t\t',"\n\t\t\t</div>\n\t\t"]);c=function t(){return e};return e}var h=new WeakMap;var d=new WeakMap;var p=new WeakMap;var f=function(){function e(t){babelHelpers.classCallCheck(this,e);this.parent=null;this.init(t)}babelHelpers.createClass(e,[{key:"init",value:function e(t){this.parent=t;BX.addCustomEvent(window,"UI::Select::change",this._onDateTypeChange.bind(this))}},{key:"deleteField",value:function e(i){t.Dom.remove(i)}},{key:"isFieldDelete",value:function e(i){return t.Dom.hasClass(i,this.parent.settings.classFieldDelete)}},{key:"isFieldValueDelete",value:function e(i){return t.Dom.hasClass(i,this.parent.settings.classValueDelete)||t.Dom.hasClass(i.parentNode,this.parent.settings.classValueDelete)}},{key:"isDragButton",value:function e(i){return i&&t.Dom.hasClass(i,this.parent.settings.classPresetDragButton)}},{key:"clearFieldValue",value:function e(i){if(i){var s=babelHelpers.toConsumableArray(i.querySelectorAll(".main-ui-control"));var n=babelHelpers.toConsumableArray(i.querySelectorAll(".main-ui-square"));n.forEach(function(e){return t.Dom.remove(e)});s.forEach(function(e){if(Reflect.has(e,"value")){e.value=""}})}}},{key:"getField",value:function e(i){if(t.Type.isDomNode(i)){return i.closest(".main-ui-control-field, .main-ui-control-field-group")}return null}},{key:"render",value:function e(i,s){if(t.Type.isString(i)&&t.Type.isPlainObject(s)){var n=Object.entries(s).reduce(function(e,t){var i=babelHelpers.slicedToArray(t,2),s=i[0],n=i[1];return e.replace(new RegExp("{{".concat(s,"}}"),"g"),n)},i);var a=t.Dom.create("div",{html:n});var r=a.querySelector(".main-ui-control-field-group");if(r){return r}var l=a.querySelector(".main-ui-control-field");if(l){return l}var o=a.querySelector(".main-ui-filter-field-line");if(o){return o}}return null}},{key:"createInputText",value:function e(i){var s={block:"main-ui-control-field",mix:this.parent.getParam("ENABLE_LABEL")?[this.parent.settings.classFieldWithLabel]:null,deleteButton:true,valueDelete:true,name:i.NAME,type:i.TYPE,label:this.parent.getParam("ENABLE_LABEL")?i.LABEL:"",dragTitle:this.parent.getParam("MAIN_UI_FILTER__DRAG_FIELD_TITLE"),deleteTitle:this.parent.getParam("MAIN_UI_FILTER__REMOVE_FIELD"),content:[{block:"main-ui-control-string",name:i.NAME,placeholder:i.PLACEHOLDER||"",value:t.Type.isString(i.VALUE)||t.Type.isNumber(i.VALUE)?i.VALUE:"",tabindex:i.TABINDEX}]};var a=BX.decl(s);this.parent.getEmitter().emit("BX.Filter.Field:init",{field:new n({parent:this.parent,options:babelHelpers.objectSpread({},i),node:a})});return a}},{key:"createTextarea",value:function e(i){var s=BX.decl({block:"main-ui-control-field",mix:this.parent.getParam("ENABLE_LABEL")?[this.parent.settings.classFieldWithLabel]:null,deleteButton:true,valueDelete:true,name:i.NAME,type:i.TYPE,label:this.parent.getParam("ENABLE_LABEL")?i.LABEL:"",dragTitle:this.parent.getParam("MAIN_UI_FILTER__DRAG_FIELD_TITLE"),deleteTitle:this.parent.getParam("MAIN_UI_FILTER__REMOVE_FIELD"),content:[{block:"main-ui-control-textarea",name:i.NAME,placeholder:i.PLACEHOLDER||"",value:t.Type.isString(i.VALUE)||t.Type.isNumber(i.VALUE)?i.VALUE:"",tabindex:i.TABINDEX}]});var a=s.querySelector("textarea");var r=function e(){t.Dom.style(a,"height","1px");t.Dom.style(a,"height","".concat(a.scrollHeight,"px"))};t.Event.bind(a,"input",r);t.Event.bind(a,"change",r);t.Event.bind(a,"keyup",r);t.Event.bind(a,"cut",r);t.Event.bind(a,"paste",r);this.parent.getEmitter().emit("BX.Filter.Field:init",{field:new n({parent:this.parent,options:babelHelpers.objectSpread({},i),node:s})});return s}},{key:"createDestSelector",value:function e(i){var s={block:"main-ui-control-field",mix:this.parent.getParam("ENABLE_LABEL")?[this.parent.settings.classFieldWithLabel]:null,deleteButton:true,valueDelete:true,name:i.NAME,type:i.TYPE,label:this.parent.getParam("ENABLE_LABEL")?i.LABEL:"",dragTitle:this.parent.getParam("MAIN_UI_FILTER__DRAG_FIELD_TITLE"),deleteTitle:this.parent.getParam("MAIN_UI_FILTER__REMOVE_FIELD"),content:{block:"main-ui-control-entity",mix:"main-ui-control",attrs:{"data-multiple":JSON.stringify(i.MULTIPLE)},content:[]}};if("_label"in i.VALUES&&!!i.VALUES._label){if(i.MULTIPLE){var a=i.VALUES._label?i.VALUES._label:[];if(t.Type.isPlainObject(a)){a=Object.keys(a).map(function(e){return a[e]})}if(!t.Type.isArray(a)){a=[a]}var r=i.VALUES._value?i.VALUES._value:[];if(t.Type.isPlainObject(r)){r=Object.keys(r).map(function(e){return r[e]})}if(!t.Type.isArray(r)){r=[r]}a.forEach(function(e,t){s.content.content.push({block:"main-ui-square",tag:"span",name:e,item:{_label:e,_value:r[t]}})})}else{s.content.content.push({block:"main-ui-square",tag:"span",name:"_label"in i.VALUES?i.VALUES._label:"",item:i.VALUES})}}s.content.content.push({block:"main-ui-square-search",tag:"span",content:{block:"main-ui-control-string",name:"".concat(i.NAME,"_label"),tabindex:i.TABINDEX,type:"text",placeholder:i.PLACEHOLDER||""}},{block:"main-ui-control-string",name:i.NAME,type:"hidden",placeholder:i.PLACEHOLDER||"",value:"_value"in i.VALUES?i.VALUES._value:"",tabindex:i.TABINDEX});s=BX.decl(s);var l=BX.Filter.Utils.getBySelector(s,'.main-ui-control-string[type="text"]');BX.addClass(l,"main-ui-square-search-item");t.Event.bind(l,"focus",function(e){BX.fireEvent(e.currentTarget,"click")});t.Event.bind(l,"click",BX.proxy(this._onCustomEntityInputClick,this));if(!this.bindDocument){t.Event.bind(document,"click",BX.proxy(this._onCustomEntityBlur,this));document.addEventListener("focus",BX.proxy(this._onDocumentFocus,this),true);this.bindDocument=true}t.Event.bind(l,"keydown",BX.proxy(this._onCustomEntityKeydown,this));t.Event.bind(s,"click",BX.proxy(this._onCustomEntityFieldClick,this));BX.ready(BX.proxy(function(){BX.Filter.DestinationSelector.create(i.NAME,{filterId:this.parent.getParam("FILTER_ID"),fieldId:i.NAME})},this));this.parent.getEmitter().emit("BX.Filter.Field:init",{field:new n({parent:this.parent,options:babelHelpers.objectSpread({},i),node:s})});return s}},{key:"createCustomEntity",value:function e(i){var s={block:"main-ui-control-field",mix:this.parent.getParam("ENABLE_LABEL")?[this.parent.settings.classFieldWithLabel]:null,deleteButton:true,valueDelete:true,name:i.NAME,type:i.TYPE,label:this.parent.getParam("ENABLE_LABEL")?i.LABEL:"",dragTitle:this.parent.getParam("MAIN_UI_FILTER__DRAG_FIELD_TITLE"),deleteTitle:this.parent.getParam("MAIN_UI_FILTER__REMOVE_FIELD"),content:{block:"main-ui-control-entity",mix:"main-ui-control",attrs:{"data-multiple":JSON.stringify(i.MULTIPLE)},content:[]}};if("_label"in i.VALUES&&!!i.VALUES._label){if(i.MULTIPLE){var a=i.VALUES._label?i.VALUES._label:[];if(t.Type.isPlainObject(a)){a=Object.keys(a).map(function(e){return a[e]})}if(!t.Type.isArray(a)){a=[a]}var r=i.VALUES._value?i.VALUES._value:[];if(t.Type.isPlainObject(r)){r=Object.keys(r).map(function(e){return r[e]})}if(!t.Type.isArray(r)){r=[r]}a.forEach(function(e,t){s.content.content.push({block:"main-ui-square",tag:"span",name:e,item:{_label:e,_value:r[t]}})})}else{s.content.content.push({block:"main-ui-square",tag:"span",name:"_label"in i.VALUES?i.VALUES._label:"",item:i.VALUES})}}s.content.content.push({block:"main-ui-square-search",tag:"span",content:{block:"main-ui-control-string",name:"".concat(i.NAME,"_label"),tabindex:i.TABINDEX,type:"text",placeholder:i.PLACEHOLDER||""}},{block:"main-ui-control-string",name:i.NAME,type:"hidden",placeholder:i.PLACEHOLDER||"",value:"_value"in i.VALUES?i.VALUES._value:"",tabindex:i.TABINDEX});s=BX.decl(s);var l=BX.Filter.Utils.getBySelector(s,'.main-ui-control-string[type="text"]');BX.addClass(l,"main-ui-square-search-item");t.Event.bind(l,"focus",BX.proxy(this._onCustomEntityInputFocus,this));t.Event.bind(l,"click",BX.proxy(this._onCustomEntityInputClick,this));if(!this.bindDocument){t.Event.bind(document,"click",BX.proxy(this._onCustomEntityBlur,this));document.addEventListener("focus",BX.proxy(this._onDocumentFocus,this),true);this.bindDocument=true}t.Event.bind(l,"keydown",BX.proxy(this._onCustomEntityKeydown,this));t.Event.bind(s,"click",BX.proxy(this._onCustomEntityFieldClick,this));this.parent.getEmitter().emit("BX.Filter.Field:init",{field:new n({parent:this.parent,options:babelHelpers.objectSpread({},i),node:s})});return s}},{key:"_onCustomEntityInputFocus",value:function e(t){BX.fireEvent(t.currentTarget,"click")}},{key:"_onCustomEntityInputClick",value:function e(t){t.preventDefault();t.stopPropagation();if(t.isTrusted){this.trustTimestamp=t.timeStamp;this.notTrustTimestamp=this.notTrustTimestamp||t.timeStamp}else{this.notTrustTimestamp=t.timeStamp}var i=new Date(this.trustTimestamp);var s=new Date(this.notTrustTimestamp);var n="".concat(i.getMinutes(),":").concat(i.getSeconds());var a="".concat(s.getMinutes(),":").concat(s.getSeconds());if(n!==a){this._onCustomEntityFocus(t)}}},{key:"_onDocumentFocus",value:function e(t){var i=this.getCustomEntityInstance();var s=i.getPopupContainer();var n=i.getLabelNode()===t.target;var a=!!s&&s.contains(t.target);if(!n&&!a){this._onCustomEntityBlur(t)}}},{key:"_onCustomEntityKeydown",value:function e(i){var s=i.target,n=i.currentTarget;var a=s.parentNode.parentNode;var r=a.querySelectorAll(".main-ui-square");var l=r[r.length-1];if(!t.Type.isDomNode(l)){return}if(BX.Filter.Utils.isKey(i,"backspace")&&n.selectionStart===0){if(t.Dom.hasClass(l,"main-ui-square-selected")){var o=a.querySelector('input[type="hidden"]');if(t.Type.isDomNode(o)){o.value="";BX.fireEvent(o,"input")}t.Dom.remove(l);return}t.Dom.addClass(l,"main-ui-square-selected");return}t.Dom.removeClass(l,"main-ui-square-selected")}},{key:"_onCustomEntityFieldClick",value:function e(i){var s=i.target;if(t.Dom.hasClass(s,"main-ui-square-delete")){var n=s.closest(".main-ui-square");if(t.Type.isDomNode(n)){var a=this.getCustomEntityInstance();BX.onCustomEvent(window,"BX.Main.Filter:customEntityRemove",[a]);t.Dom.remove(n)}return}var r=s.querySelector('input[type="text"]');if(t.Type.isDomNode(r)){BX.fireEvent(r,"focus")}}},{key:"_onCustomEntityBlur",value:function e(i){var s={stopBlur:false};BX.onCustomEvent(window,"BX.Main.Filter:onGetStopBlur",[i,s]);if(typeof s.stopBlur==="undefined"||!s.stopBlur){var n=this.getCustomEntityInstance();BX.onCustomEvent(window,"BX.Main.Filter:customEntityBlur",[n]);t.Event.unbind(n.getPopupContainer(),"click",this._stopPropagation);t.Dom.removeClass(n.getField(),"main-ui-focus")}}},{key:"_stopPropagation",value:function e(t){t.stopPropagation()}},{key:"getCustomEntityInstance",value:function e(){if(!(this.customEntityInstance instanceof BX.Main.ui.CustomEntity)){this.customEntityInstance=new BX.Main.ui.CustomEntity}return this.customEntityInstance}},{key:"_onCustomEntityFocus",value:function e(i){i.stopPropagation();var s=i.currentTarget;var n=s.closest(".main-ui-control-entity");var a=this.getCustomEntityInstance();a.setField(n);BX.onCustomEvent("BX.Main.Filter:customEntityFocus",[a]);var r=a.getPopupContainer();if(t.Type.isElementNode(r)){t.Event.bind(r,"click",this._stopPropagation)}t.Dom.addClass(n,"main-ui-focus")}},{key:"createCustom",value:function e(i){var s=BX.decl({block:"main-ui-control-field",mix:this.parent.getParam("ENABLE_LABEL")?[this.parent.settings.classFieldWithLabel]:null,name:i.NAME,type:i.TYPE,deleteButton:true,label:this.parent.getParam("ENABLE_LABEL")?i.LABEL:"",dragTitle:this.parent.getParam("MAIN_UI_FILTER__DRAG_FIELD_TITLE"),deleteTitle:this.parent.getParam("MAIN_UI_FILTER__REMOVE_FIELD"),content:{block:"main-ui-custom",mix:["main-ui-control","main-ui-custom-style"],attrs:{"data-name":i.NAME},content:""}});if(t.Type.isString(i.VALUE)){var a=function(){if(Reflect.has(i,"_VALUE")){return i._VALUE}return""}();var r=t.Text.decode(i.VALUE).replace('name="'.concat(i.NAME,'"'),'name="'.concat(i.NAME,'" value="').concat(a,'"'));var l=s.querySelector(".main-ui-custom");t.Runtime.html(l,r)}this.parent.getEmitter().emit("BX.Filter.Field:init",{field:new n({parent:this.parent,options:babelHelpers.objectSpread({},i),node:s})});return s}},{key:"createSelect",value:function e(t){var i=BX.decl({block:"main-ui-control-field",mix:this.parent.getParam("ENABLE_LABEL")?[this.parent.settings.classFieldWithLabel]:null,name:t.NAME,type:t.TYPE,deleteButton:true,label:this.parent.getParam("ENABLE_LABEL")?t.LABEL:"",dragTitle:this.parent.getParam("MAIN_UI_FILTER__DRAG_FIELD_TITLE"),deleteTitle:this.parent.getParam("MAIN_UI_FILTER__REMOVE_FIELD"),content:{block:this.parent.settings.classSelect,name:t.NAME,items:t.ITEMS,value:"VALUE"in t?t.VALUE:t.ITEMS[0],params:t.PARAMS,tabindex:t.TABINDEX,valueDelete:false}});this.parent.getEmitter().emit("BX.Filter.Field:init",{field:new n({parent:this.parent,options:babelHelpers.objectSpread({},t),node:i})});return i}},{key:"createMultiSelect",value:function e(t){var i=BX.decl({block:"main-ui-control-field",mix:this.parent.getParam("ENABLE_LABEL")?[this.parent.settings.classFieldWithLabel]:null,name:t.NAME,type:t.TYPE,deleteButton:true,label:this.parent.getParam("ENABLE_LABEL")?t.LABEL:"",dragTitle:this.parent.getParam("MAIN_UI_FILTER__DRAG_FIELD_TITLE"),deleteTitle:this.parent.getParam("MAIN_UI_FILTER__REMOVE_FIELD"),content:{block:"main-ui-multi-select",name:t.NAME,tabindex:"TABINDEX"in t?t.TABINDEX:"",placeholder:!this.parent.getParam("ENABLE_LABEL")&&"PLACEHOLDER"in t?t.PLACEHOLDER:"",items:"ITEMS"in t?t.ITEMS:[],value:"VALUE"in t?t.VALUE:[],params:"PARAMS"in t?t.PARAMS:{isMulti:true},valueDelete:true}});this.parent.getEmitter().emit("BX.Filter.Field:init",{field:new n({parent:this.parent,options:babelHelpers.objectSpread({},t),node:i})});return i}},{key:"createCustomDate",value:function e(i){var s={block:"main-ui-control-field-group",type:i.TYPE,mix:this.parent.getParam("ENABLE_LABEL")?[this.parent.settings.classFieldWithLabel,"main-ui-filter-date-group"]:["main-ui-filter-date-group"],label:this.parent.getParam("ENABLE_LABEL")?i.LABEL:"",dragTitle:this.parent.getParam("MAIN_UI_FILTER__DRAG_FIELD_TITLE"),deleteTitle:this.parent.getParam("MAIN_UI_FILTER__REMOVE_FIELD"),tabindex:"TABINDEX"in i?i.TABINDEX:"",name:"NAME"in i?i.NAME:"",deleteButton:true,content:[]};if(t.Type.isPlainObject(i.VALUE.days)){i.VALUE.days=Object.keys(i.VALUE.days).map(function(e){return i.VALUE.days[e]})}var a=i.DAYS.filter(function(e){return i.VALUE.days.some(function(t){return t===e.VALUE})});var r={block:"main-ui-control-field",mix:["main-ui-control-custom-date"],placeholder:i.DAYS_PLACEHOLDER,dragButton:false,content:{block:"main-ui-multi-select",name:"".concat(i.NAME,"_days"),tabindex:"TABINDEX"in i?i.TABINDEX:"",items:i.DAYS,value:a,params:"PARAMS"in i?i.PARAMS:{isMulti:true},valueDelete:true,attrs:{"data-placeholder":i.DAYS_PLACEHOLDER}}};if(t.Type.isPlainObject(i.VALUE.months)){i.VALUE.months=Object.keys(i.VALUE.months).map(function(e){return i.VALUE.months[e]})}var l=i.MONTHS.filter(function(e){return i.VALUE.months.some(function(t){return t===e.VALUE})});var o={block:"main-ui-control-field",mix:["main-ui-control-custom-date"],dragButton:false,content:{block:"main-ui-multi-select",name:"".concat(i.NAME,"_months"),tabindex:"TABINDEX"in i?i.TABINDEX:"",items:i.MONTHS,value:l,params:"PARAMS"in i?i.PARAMS:{isMulti:true},valueDelete:true,attrs:{"data-placeholder":i.MONTHS_PLACEHOLDER}}};if(t.Type.isPlainObject(i.VALUE.years)){i.VALUE.years=Object.keys(i.VALUE.years).map(function(e){return i.VALUE.years[e]})}var u=i.YEARS.filter(function(e){return i.VALUE.years.some(function(t){return t===e.VALUE})});var c={block:"main-ui-control-field",mix:["main-ui-control-custom-date"],dragButton:false,content:{block:"main-ui-multi-select",name:"".concat(i.NAME,"_years"),tabindex:"TABINDEX"in i?i.TABINDEX:"",items:i.YEARS,value:u,params:"PARAMS"in i?i.PARAMS:{isMulti:true},valueDelete:true,attrs:{"data-placeholder":i.YEARS_PLACEHOLDER}}};s.content.push(r);s.content.push(o);s.content.push(c);var h=BX.decl(s);this.parent.getEmitter().emit("BX.Filter.Field:init",{field:new n({parent:this.parent,options:babelHelpers.objectSpread({},i),node:h})});return h}},{key:"_onDateTypeChange",value:function e(i,s){var n=this;if(this.parent.getPopup().contentContainer.contains(i.node)){var a={};var r=null;var l;var o;var u;if(t.Type.isPlainObject(s)&&Reflect.has(s,"VALUE")){var c=i.getNode();var h=i.getParams();var d=c.dataset.name;if(!t.Type.isPlainObject(h)&&(d.endsWith("_datesel")||d.endsWith("_numsel"))){var p=c.parentNode.parentNode;a.TABINDEX=i.getInput().getAttribute("tabindex");a.SUB_TYPES=i.getItems();a.SUB_TYPE=s;a.NAME=p.dataset.name;a.TYPE=p.dataset.type;a.VALUE_REQUIRED=p.dataset.valueRequired==="true";var f=this.parent.getPreset().getCurrentPresetData();if(t.Type.isArray(f.FIELDS)){var m=f.FIELDS.find(function(e){return e.NAME===a.NAME});if(t.Type.isNil(m)){m=this.parent.params.FIELDS_STUBS.find(function(e){return e.TYPE===a.TYPE})}if(!t.Type.isNil(m)){if(d.endsWith("_datesel")){a.MONTHS=m.MONTHS;a.MONTH=m.MONTH;a.YEARS=m.YEARS;a.YEAR=m.YEAR;a.QUARTERS=m.QUARTERS;a.QUARTER=m.QUARTER;a.ENABLE_TIME=m.ENABLE_TIME;a.YEARS_SWITCHER=m.YEARS_SWITCHER}a.VALUES=m.VALUES;a.REQUIRED=m.REQUIRED}}if(this.parent.getParam("ENABLE_LABEL")){l=p.querySelector(".main-ui-control-field-label");a.LABEL=l.innerText}if(d.endsWith("_datesel")){r=this.createDate(a)}else{r=this.createNumber(a)}if(t.Type.isArray(this.parent.fieldsList)){u=this.parent.fieldsList.indexOf(p);if(u!==-1){this.parent.fieldsList[u]=r;this.parent.registerDragItem(r)}}this.parent.unregisterDragItem(p);o=babelHelpers.toConsumableArray(r.querySelectorAll(".main-ui-control-field"));if(t.Type.isArray(o)&&o.length){o.forEach(function(e){e.FieldController=new BX.Filter.FieldController(e,n.parent)})}t.Dom.insertAfter(r,p);t.Dom.remove(p)}}}}},{key:"createNumber",value:function e(t){var i=this.parent.numberTypes;var s=this.parent.params.ENABLE_LABEL;var a=t.SUB_TYPE,r=a===void 0?{}:a,l=t.SUB_TYPES,o=l===void 0?[]:l,u=t.TABINDEX,c=u===void 0?"":u,h=t.VALUES,d=h===void 0?{_from:"",_to:""}:h,p=t.LABEL,f=p===void 0?"":p,m=t.TYPE;var E=r.VALUE||i.SINGLE;var g=r.PLACEHOLDER||"";var B=t.NAME.replace("_numsel","");var y=function(){if(s){return["main-ui-filter-wield-with-label","main-ui-filter-number-group"]}return["main-ui-filter-number-group"]}();var v={block:"number-group",type:m,mix:y,label:s?f:"",dragTitle:this.parent.getParam("MAIN_UI_FILTER__DRAG_FIELD_TITLE"),deleteTitle:this.parent.getParam("MAIN_UI_FILTER__REMOVE_FIELD"),tabindex:c,value:r,items:o,name:B,deleteButton:true,content:[]};if(E!==i.LESS){var A={block:"main-ui-control-field",type:m,dragButton:false,content:{block:"main-ui-number",mix:["filter-type-single"],calendarButton:true,valueDelete:true,placeholder:g,name:"".concat(B,"_from"),tabindex:c,value:d._from||""}};v.content.push(A)}if(E===i.RANGE){var P={block:"main-ui-filter-field-line",content:{block:"main-ui-filter-field-line-item",tag:"span"}};v.content.push(P)}if(E===i.RANGE||E===i.LESS){var _={block:"main-ui-control-field",type:m,dragButton:false,content:{block:"main-ui-number",calendarButton:true,valueDelete:true,name:"".concat(B,"_to"),tabindex:c,value:d._to||""}};v.content.push(_)}var S=BX.decl(v);this.parent.getEmitter().emit("BX.Filter.Field:init",{field:new n({parent:this.parent,options:babelHelpers.objectSpread({},t),node:S})});return S}},{key:"createDate",value:function e(i){var s=this;var a=this.parent,c=a.dateTypes,h=a.additionalDateTypes;var d=i.SUB_TYPE,p=d===void 0?{}:d,f=i.SUB_TYPES,m=f===void 0?[]:f,E=i.PLACEHOLDER,g=E===void 0?"":E,B=i.VALUES,y=B===void 0?{_from:"",_to:"",_quarter:"",_days:"",_month:"",_year:"",_allow_year:""}:B,v=i.TABINDEX,A=v===void 0?"":v,P=i.ENABLE_TIME,_=P===void 0?false:P,S=i.LABEL,L=S===void 0?"":S,b=i.TYPE,X=i.VALUE_REQUIRED,T=X===void 0?false:X,I=i.REQUIRED,F=I===void 0?false:I;var D=this.parent.params.ENABLE_LABEL;var C=p.VALUE||c.NONE;var U=i.NAME.replace("_datesel","");var N=function(){if(D){return["main-ui-filter-wield-with-label","main-ui-filter-date-group"]}return["main-ui-filter-date-group"]}();var R={block:"date-group",type:b,mix:N,label:D?L:"",dragTitle:this.parent.getParam("MAIN_UI_FILTER__DRAG_FIELD_TITLE"),deleteTitle:this.parent.getParam("MAIN_UI_FILTER__REMOVE_FIELD"),tabindex:A,value:p,items:m,name:U,enableTime:_,deleteButton:true,content:[]};if(C===c.EXACT){var k=r({type:b,name:"".concat(U.NAME,"_from"),placeholder:g,tabindex:A,value:y._from||"",enableTime:_});R.content.push(k)}if(C===c.NEXT_DAYS||C===c.PREV_DAYS||C===h.PREV_DAY||C===h.NEXT_DAY||C===h.MORE_THAN_DAYS_AGO||C===h.AFTER_DAYS){var O=l({type:b,name:"".concat(U,"_days"),tabindex:A,value:y._days||"",placeholder:g});R.content.push(O)}if(C===c.RANGE){var M={block:"main-ui-filter-range-group",content:[r({type:b,name:"".concat(U,"_from"),placeholder:g,tabindex:A,value:y._from||"",enableTime:_}),o(),r({type:b,name:"".concat(U,"_to"),placeholder:g,tabindex:A,value:y._to||"",enableTime:_})]};R.content.push(M)}if(C===c.MONTH){var V=i.MONTHS,x=i.MONTH,w=i.YEARS,q=i.YEAR;var j=V.find(function(e){return e.VALUE===y._month})||x||V[0];var Y=w.find(function(e){return e.VALUE===y._year})||q||w[0];R.content.push(u({name:"".concat(U,"_month"),value:j,items:V,tabindex:A}),u({name:"".concat(U,"_year"),value:Y,items:w,tabindex:A}))}if(C===c.QUARTER){var H=i.YEARS,G=i.YEAR,W=i.QUARTERS,Q=i.QUARTER,K=i.PARAMS;var J=H.find(function(e){return e.VALUE===y._year})||G||H[0];var z=W.find(function(e){return e.VALUE===y._quarter})||Q||W[0];R.content.push(u({name:"".concat(U,"_year"),value:J,items:H,tabindex:A}),u({name:"".concat(U,"_quarter"),value:z,items:W,tabindex:A,params:K}))}if(C===c.YEAR){var Z=i.YEARS,$=i.YEAR;var ee=Z.find(function(e){return e.VALUE===y._year})||$||Z[0];R.content.push(u({name:"".concat(U,"_year"),value:ee,items:Z,tabindex:A}))}if(C==="CUSTOM_DATE"){var te=m.find(function(e){return e.VALUE==="CUSTOM_DATE"});if(te){var ie=t.Runtime.clone(te.DECL);if(t.Type.isArray(y._days)){ie.VALUE.days=y._days}if(t.Type.isArray(y._month)){ie.VALUE.months=y._month}if(t.Type.isArray(y._year)){ie.VALUE.years=y._year}ie.mix=ie.filter(function(e){return e!=="main-ui-filter-wield-with-label"});var se=this.createCustomDate(ie);var ne=babelHelpers.toConsumableArray(se.querySelectorAll(".main-ui-item-icon-container, .main-ui-filter-icon-grab"));ne.forEach(function(e){return t.Dom.remove(e)});R.content.push(se);R.push("main-ui-filter-custom-date-group")}}if(C!==c.NONE&&C!==h.CUSTOM_DATE&&i.YEARS_SWITCHER){var ae=t.Runtime.clone(i.YEARS_SWITCHER);var re=ae.ITEMS;ae.VALUE=re.reduce(function(e,t){return t.VALUE===y._allow_year?t:e});var le=this.createSelect(ae);t.Dom.addClass(le,["main-ui-filter-year-switcher","main-ui-filter-with-padding"]);t.Dom.removeClass(le,"main-ui-filter-wield-with-label");var oe=babelHelpers.toConsumableArray(le.querySelectorAll(".main-ui-item-icon-container, .main-ui-filter-icon-grab"));oe.forEach(function(e){return t.Dom.remove(e)});var ue=R.content.length-1;var ce=R.content[ue];if(t.Type.isPlainObject(ce)){if(!t.Type.isArray(ce.mix)){ce.mix=[]}ce.mix.push("main-ui-filter-remove-margin-right")}if(t.Type.isDomNode(ce)){t.Dom.addClass(ce,"main-ui-filter-remove-margin-right")}requestAnimationFrame(function(){t.Dom.addClass(le.previousElementSibling,"main-ui-filter-remove-margin-right")});R.content.push(le);R.mix.push("main-ui-filter-date-with-years-switcher")}var he=BX.decl(R);var de=t.Runtime.debounce(this.onDateChange,500,this);var pe=babelHelpers.toConsumableArray(he.querySelectorAll(".main-ui-date-input"));pe.forEach(function(e){e.addEventListener("change",de);e.addEventListener("input",de);var t=e.parentNode;var i=t.querySelector(".main-ui-control-value-delete");if(i){i.addEventListener("click",function(){setTimeout(function(){s.onDateChange({target:e})})})}});if(T){he.dataset.valueRequired=true;var fe=[].concat(babelHelpers.toConsumableArray(pe),babelHelpers.toConsumableArray(he.querySelectorAll(".main-ui-number-input")));fe.forEach(function(e){e.addEventListener("change",s.checkRequiredDateValue.bind(s));e.addEventListener("input",s.checkRequiredDateValue.bind(s));var i=e.parentNode;var n=i.querySelector(".main-ui-control-value-delete");if(n){n.addEventListener("click",function(){setTimeout(function(){s.checkRequiredDateValue({target:e})})})}t.Event.bindOnce(e,"mouseout",function(){s.checkRequiredDateValue({target:e})})})}if(F){var me=he.querySelector(".main-ui-filter-field-delete");if(me){BX.remove(me)}}var Ee={};this.parent.prepareControlDateValue(Ee,U,he);Object.entries(Ee).forEach(function(e){var t=babelHelpers.slicedToArray(e,2),i=t[0],s=t[1];Ee[i.replace(U,"")]=s;delete Ee[i]});this.parent.getEmitter().emit("BX.Filter.Field:init",{field:new n({parent:this.parent,options:babelHelpers.objectSpread({},i,{VALUES:Ee}),node:he})});return he}},{key:"checkRequiredDateValue",value:function e(t){if(t.target.value===""){this.showError({id:"valueError",target:t.target,text:this.parent.params.MAIN_UI_FILTER__VALUE_REQUIRED});return}this.hideError({id:"valueError",target:t.target})}},{key:"onDateChange",value:function e(t){var i=this;if(p.get(t.target)===t.target.value){return}p.set(t.target,t.target.value);if(t.target.value===""){this.hideError({id:"formatError",target:t.target});return}BX.ajax.runComponentAction("bitrix:main.ui.filter","checkDateFormat",{mode:"ajax",data:{value:t.target.value,format:BX.message("FORMAT_DATETIME")}}).then(function(e){if(!e.data.result){i.showError({id:"formatError",target:t.target});return}i.hideError({id:"formatError",target:t.target})})}},{key:"showError",value:function e(i){var s=i.id,n=i.target,a=i.text,r=a===void 0?null:a;t.Dom.style(n,"border-color","#FF5752");if(h.has(n)&&d.get(n)===s){t.Dom.remove(h.get(n))}var l=this.parent.params,o=l.MAIN_UI_FILTER__DATE_ERROR_TITLE,u=l.MAIN_UI_FILTER__DATE_ERROR_LABEL;var p=r||"".concat(u," ").concat(t.Loc.getMessage("FORMAT_DATE"));var f=t.Tag.render(c(),o,p);h.set(n,f);d.set(n,s);t.Dom.insertAfter(f,n);t.Dom.attr(n,"is-valid","false")}},{key:"hideError",value:function e(i){var s=i.id,n=i.target;t.Dom.style(n,"border-color",null);if(h.has(n)&&d.get(n)===s){t.Dom.remove(h.get(n))}t.Dom.attr(n,"is-valid","true")}}]);return e}();var m=function(){function e(t){babelHelpers.classCallCheck(this,e);this.parent=null;this.presets=null;this.container=null;this.init(t)}babelHelpers.createClass(e,[{key:"init",value:function e(t){this.parent=t}},{key:"bindOnPresetClick",value:function e(){var i=this;(this.getPresets()||[]).forEach(function(e){t.Event.bind(e,"click",BX.delegate(i._onPresetClick,i))})}},{key:"getAddPresetField",value:function e(){return this.getContainer().querySelector(".main-ui-filter-new-filter")}},{key:"getAddPresetFieldInput",value:function e(){return this.getAddPresetField().querySelector(".main-ui-filter-sidebar-edit-control")}},{key:"clearAddPresetFieldInput",value:function e(){var i=this.getAddPresetFieldInput();if(t.Type.isDomNode(i)){i.value=""}}},{key:"normalizePreset",value:function e(t){return t.closest(".main-ui-filter-sidebar-item")}},{key:"deactivateAllPresets",value:function e(){this.getPresets().forEach(function(e){t.Dom.removeClass(e,"main-ui-filter-current-item")})}},{key:"createSidebarItem",value:function e(i,s,n){return BX.decl({block:"sidebar-item",text:t.Text.decode(s),id:i,pinned:n,noEditPinTitle:this.parent.getParam("MAIN_UI_FILTER__IS_SET_AS_DEFAULT_PRESET"),editNameTitle:this.parent.getParam("MAIN_UI_FILTER__EDIT_PRESET_TITLE"),removeTitle:this.parent.getParam("MAIN_UI_FILTER__REMOVE_PRESET"),editPinTitle:this.parent.getParam("MAIN_UI_FILTER__SET_AS_DEFAULT_PRESET"),dragTitle:this.parent.getParam("MAIN_UI_FILTER__DRAG_TITLE")})}},{key:"activatePreset",value:function e(i){var s=this;this.deactivateAllPresets();var n=function(){if(t.Type.isString(i)){return s.getPresetNodeById(i)}return i}();if(t.Type.isDomNode(n)){t.Dom.addClass(n,"main-ui-filter-current-item")}}},{key:"getPresetNodeById",value:function e(i){return this.getPresets().find(function(e){return t.Dom.attr(e,"data-id")===i})}},{key:"getPresetId",value:function e(i){return t.Dom.attr(i,"data-id")}},{key:"updatePresetName",value:function e(i,s){if(t.Type.isDomNode(i)&&t.Type.isString(s)&&s!==""){var n=this.getPresetNameNode(i);if(t.Type.isDomNode(n)){t.Runtime.html(n,s)}}}},{key:"removePreset",value:function e(t,i,s){var n=this.getCurrentPresetId();var a=[];var r={preset_id:i,is_default:s};var l={FILTER_ID:this.parent.getParam("FILTER_ID"),action:"REMOVE_FILTER"};this.parent.saveOptions(r,l);BX.remove(t);if(BX.type.isArray(this.parent.params.PRESETS)){a=this.parent.params.PRESETS.filter(function(e){return e.ID!==i},this);this.parent.params.PRESETS=a}if(BX.type.isArray(this.parent.editablePresets)){a=this.parent.editablePresets.filter(function(e){return e.ID!==i},this);this.parent.editablePresets=a}if(i===n){this.parent.getSearch().removePreset();this.resetPreset()}}},{key:"pinPreset",value:function e(i){if(!BX.type.isNotEmptyString(i)){i="default_filter"}var s=this.getPresetNodeById(i);if(this.parent.getParam("VALUE_REQUIRED_MODE")){if(i==="default_filter"){return}}var n={FILTER_ID:this.parent.getParam("FILTER_ID"),GRID_ID:this.parent.getParam("GRID_ID"),action:"PIN_PRESET"};var a={preset_id:i};this.getPresets().forEach(function(e){t.Dom.removeClass(e,this.parent.settings.classPinnedPreset)},this);BX.addClass(s,this.parent.settings.classPinnedPreset);this.parent.saveOptions(a,n)}},{key:"_onPresetClick",value:function e(i){var s;var n;var a;var r;var l;var o;var u;i.preventDefault();u=this.parent;o=u.settings;l=i.target;s=i.currentTarget;n=this.getPresetId(s);a=this.getPreset(n);if(t.Dom.hasClass(l,o.classPinButton)){if(this.parent.isEditEnabled()){if(t.Dom.hasClass(s,o.classPinnedPreset)){this.pinPreset("default_filter")}else{this.pinPreset(n)}}}if(t.Dom.hasClass(l,o.classPresetEditButton)){this.enableEditPresetName(s)}if(t.Dom.hasClass(l,o.classPresetDeleteButton)){r="IS_DEFAULT"in a?a.IS_DEFAULT:false;this.removePreset(s,n,r);return false}if(!t.Dom.hasClass(l,o.classPresetDragButton)&&!t.Dom.hasClass(l,o.classAddPresetFieldInput)){if(this.parent.isEditEnabled()){this.updateEditablePreset(this.getCurrentPresetId())}var c=this.getPreset(this.getCurrentPresetId());var h=this.getPreset(n);c.ADDITIONAL=[];h.ADDITIONAL=[];this.activatePreset(s);this.applyPreset(n);if(!this.parent.isEditEnabled()){u.applyFilter(null,true);if(i.isTrusted){u.closePopup()}if(u.isAddPresetEnabled()){u.disableAddPreset()}}}}},{key:"applyPinnedPreset",value:function e(){var t=this.parent;var i=this.isPinned(this.getCurrentPresetId());var s;if(this.parent.getParam("VALUE_REQUIRED")&&this.getPinnedPresetId()==="default_filter"){this.applyPreset("default_filter");this.deactivateAllPresets();s=this.parent.applyFilter()}else if(!i){var n=this.getPinnedPresetId();var a=this.getPinnedPresetNode();var r=false;var l=true;this.deactivateAllPresets();this.activatePreset(a);this.applyPreset(n);s=t.applyFilter(r,l);t.closePopup()}else{s=t.resetFilter()}return s}},{key:"updateEditablePreset",value:function e(t){var i=this.parent.getFilterFieldsValues();var s=this.getFields().map(function(e){return BX.data(e,"name")});var n=this.parent.preparePresetFields(i,s);var a=this.getPreset(t);a.FIELDS=n;a.TITLE=this.getPresetInput(this.getPresetNodeById(t)).value;a.ROWS=s}},{key:"getPresetInput",value:function e(t){return BX.Filter.Utils.getByClass(t,this.parent.settings.classPresetEditInput)}},{key:"enableEditPresetName",value:function e(i){var s=this.getPresetInput(i);BX.addClass(i,this.parent.settings.classPresetNameEdit);s.focus();s.value=BX.util.htmlspecialcharsback(s.value);t.Event.bind(s,"input",BX.delegate(this._onPresetNameInput,this))}},{key:"_onPresetNameInput",value:function e(t){var i=this.parent.getSearch();var s=t.currentTarget.value;var n=BX.findParent(t.currentTarget,{className:this.parent.settings.classPreset},true,false);var a=this.getPresetId(n);var r=this.getCurrentPresetId();var l={ID:a,TITLE:s};if(a===r){i.updatePreset(l)}}},{key:"getPresetNameNode",value:function e(t){return BX.Filter.Utils.getByClass(t,this.parent.settings.classPresetName)}},{key:"disableEditPresetName",value:function e(i){var s=this.getPresetInput(i);t.Dom.removeClass(i,this.parent.settings.classPresetNameEdit);if(BX.type.isDomNode(s)){s.blur();BX.unbind(s,"input",BX.delegate(this._onPresetNameInput,this))}}},{key:"getPreset",value:function e(t,i){var s=this.parent.getParam(i?"DEFAULT_PRESETS":"PRESETS",[]);if(this.parent.isEditEnabled()&&!i){s=this.parent.editablePresets}var n=s.filter(function(e){return e.ID===t});if(t==="tmp_filter"&&!n.length){var a=BX.clone(this.getPreset("default_filter"));a.ID="tmp_filter";s.push(a);n.push(a)}return n.length!==0?n[0]:null}},{key:"getPresetField",value:function e(t,i){var s=this.getPreset(t);var n=null;if(BX.type.isPlainObject(s)&&"FIELDS"in s&&BX.type.isArray(s.FIELDS)){n=s.FIELDS.filter(function(e){return e.NAME===i});n=n.length?n[0]:null}return n}},{key:"applyPreset",value:function e(t,i){t=i?"default_filter":t||"default_filter";var s=this.getPreset(t);if(t!=="default_preset"){s=this.extendPreset(s)}this.parent.getSearch().updatePreset(s);this.updatePresetFields(s,i)}},{key:"extendPreset",value:function e(t){var i=BX.clone(this.getPreset("default_filter"));if(BX.type.isPlainObject(t)){t=BX.clone(t);t.FIELDS.forEach(function(e){var t;var s=i.FIELDS.some(function(i,s){var n=false;if(i.NAME===e.NAME){t=s;n=true}return n},this);if(s&&t||s&&t===0){i.FIELDS[t]=e}else if(!this.isEmptyField(e)){i.FIELDS.push(e)}},this);t.FIELDS=i.FIELDS}return t}},{key:"isEmptyField",value:function e(t){var i=true;if(t.TYPE===this.parent.types.STRING){if(t.VALUE&&t.VALUE.length){i=false}}if(t.TYPE===this.parent.types.SELECT){if(BX.type.isPlainObject(t.VALUE)&&"VALUE"in t.VALUE&&t.VALUE.VALUE){i=false}}if(t.TYPE===this.parent.types.MULTI_SELECT){if(BX.type.isArray(t.VALUE)&&t.VALUE.length){i=false}}if(t.TYPE===this.parent.types.CUSTOM_DATE){if(BX.type.isArray(t.VALUE.days)&&t.VALUE.days.length||BX.type.isArray(t.VALUE.months)&&t.VALUE.months.length||BX.type.isArray(t.VALUE.years)&&t.VALUE.years.length){i=false}}if(t.TYPE===this.parent.types.CUSTOM_ENTITY||t.TYPE===this.parent.types.DEST_SELECTOR){if(BX.type.isPlainObject(t.VALUES)){if(BX.type.isNotEmptyString(t.VALUES._label)&&BX.type.isNotEmptyString(t.VALUES._value)){i=false}if(BX.type.isPlainObject(t.VALUES._label)&&BX.type.isPlainObject(t.VALUES._value)&&Object.keys(t.VALUES._label).length&&Object.keys(t.VALUES._value).length){i=false}if(BX.type.isArray(t.VALUES._label)&&BX.type.isArray(t.VALUES._value)&&t.VALUES._label.length&&t.VALUES._value.length){i=false}if((BX.type.isArray(t.VALUES._label)&&t.VALUES._label.length||BX.type.isPlainObject(t.VALUES._label)&&Object.keys(t.VALUES._label).length)&&(BX.type.isArray(t.VALUES._value)&&t.VALUES._value.length||BX.type.isPlainObject(t.VALUES._value)&&Object.keys(t.VALUES._value).length)){i=false}}}if(t.TYPE===this.parent.types.DATE){var s="_datesel"in t.VALUES?t.VALUES._datesel:t.SUB_TYPE.VALUE;if(BX.type.isPlainObject(t.VALUES)&&(t.VALUES._from||t.VALUES._to||t.VALUES._quarter||t.VALUES._month&&!BX.type.isArray(t.VALUES._month)||t.VALUES._year&&!BX.type.isArray(t.VALUES._year)||t.VALUES._days&&!BX.type.isArray(t.VALUES._days))||BX.type.isArray(t.VALUES._days)&&t.VALUES._days.length||BX.type.isArray(t.VALUES._month)&&t.VALUES._month.length||BX.type.isArray(t.VALUES._year)&&t.VALUES._year.length||s===this.parent.dateTypes.CURRENT_DAY||s===this.parent.dateTypes.CURRENT_WEEK||s===this.parent.dateTypes.CURRENT_MONTH||s===this.parent.dateTypes.CURRENT_QUARTER||s===this.parent.dateTypes.LAST_7_DAYS||s===this.parent.dateTypes.LAST_30_DAYS||s===this.parent.dateTypes.LAST_60_DAYS||s===this.parent.dateTypes.LAST_90_DAYS||s===this.parent.dateTypes.LAST_WEEK||s===this.parent.dateTypes.LAST_MONTH||s===this.parent.dateTypes.TOMORROW||s===this.parent.dateTypes.YESTERDAY||s===this.parent.dateTypes.NEXT_WEEK||s===this.parent.dateTypes.NEXT_MONTH){i=false}}if(t.TYPE===this.parent.types.NUMBER){if(BX.type.isPlainObject(t.VALUES)&&(t.VALUES._from||t.VALUES._to)){i=false}}if(t.TYPE===this.parent.types.CHECKBOX){if(BX.type.isPlainObject(t.VALUE)&&t.VALUE.VALUE){i=false}}return i}},{key:"resetPreset",value:function e(t){this.applyPreset("",t)}},{key:"getFields",value:function e(){var t=this.parent.getFieldListContainer();var i=null;if(BX.type.isDomNode(t)){i=BX.Filter.Utils.getBySelector(t.parentNode,".".concat(this.parent.settings.classFileldControlList," > div"),true)}return i}},{key:"getField",value:function e(t){var i=this.getFields();var s=null;var n;var a;if(BX.type.isArray(i)&&i.length){a=i.filter(function(e){if(BX.type.isDomNode(e)){n=BX.data(e,"name")}return n===t.NAME},this);s=a.length>0?a[0]:null}return s}},{key:"removeField",value:function e(t,i){var s;var n;i=i||false;if(BX.type.isPlainObject(t)){n=t.NAME;t=this.getField(t);if(BX.type.isArray(this.parent.fieldsList)){s=this.parent.fieldsList.indexOf(t);if(s!==-1){delete this.parent.fieldsList[s]}}this.parent.unregisterDragItem(t)}if(BX.type.isDomNode(t)){n=BX.data(t,"name");this.parent.getFields().deleteField(t)}if(!this.parent.isEditEnabled()&&!this.parent.isAddPresetEnabled()){var a=this.getCurrentPresetId();var r=this.getPresetField(a,n);if(r&&!this.isEmptyField(r)){this.deactivateAllPresets();this.parent.applyFilter()}}if(!i){this.parent.saveFieldsSort()}}},{key:"removeFields",value:function e(t){t.forEach(function(e){this.removeField(e,true)},this);this.parent.saveFieldsSort()}},{key:"addField",value:function e(t){var i;var s;var n;if(BX.type.isPlainObject(t)){i=this.parent.getFieldListContainer();n=this.parent.getControls();s=BX.type.isArray(n)?n[n.length-1]:null;if(BX.type.isDomNode(s)){if(s.nodeName!=="INPUT"){s=BX.Filter.Utils.getByTag(s,"input")}if(BX.type.isDomNode(s)){t.TABINDEX=parseInt(s.getAttribute("tabindex"))+1}}else{t.TABINDEX=2}if(BX.type.isDomNode(i)){s=this.createControl(t);if(BX.type.isDomNode(s)){BX.append(s,i);if(BX.type.isArray(this.parent.fieldsList)){this.parent.fieldsList.push(s)}this.parent.registerDragItem(s)}}}if(!this.parent.isEditEnabled()&&!this.parent.isAddPresetEnabled()){var a=this.getCurrentPresetId();var r=this.getPresetField(a,t.NAME);if(r&&!this.isEmptyField(r)){this.parent.updatePreset("tmp_filter");this.deactivateAllPresets();this.parent.getSearch().updatePreset(this.getPreset("tmp_filter"))}}this.parent.saveFieldsSort()}},{key:"createControl",value:function e(t){var i;switch(t.TYPE){case this.parent.types.STRING:{i=this.parent.getFields().createInputText(t);break}case this.parent.types.TEXTAREA:{i=this.parent.getFields().createTextarea(t);break}case this.parent.types.SELECT:{i=this.parent.getFields().createSelect(t);break}case this.parent.types.MULTI_SELECT:{i=this.parent.getFields().createMultiSelect(t);break}case this.parent.types.NUMBER:{i=this.parent.getFields().createNumber(t);break}case this.parent.types.DATE:{i=this.parent.getFields().createDate(t);break}case this.parent.types.CUSTOM_DATE:{i=this.parent.getFields().createCustomDate(t);break}case this.parent.types.DEST_SELECTOR:{i=this.parent.getFields().createDestSelector(t);break}case this.parent.types.CUSTOM:{i=this.parent.getFields().createCustom(t);break}case this.parent.types.CUSTOM_ENTITY:{i=this.parent.getFields().createCustomEntity(t);break}default:{break}}if(BX.type.isDomNode(i)){i.dataset.name=t.NAME;i.FieldController=new BX.Filter.FieldController(i,this.parent);if(t.REQUIRED){var s=i.querySelector(".main-ui-filter-field-delete");if(s){BX.remove(s)}}}return i}},{key:"removeNotCompareVariables",value:function e(t,i){if(BX.type.isPlainObject(t)){var s=this.parent.dateTypes;var n=this.parent.additionalDateTypes;if("FIND"in t){delete t.FIND}if(!i){Object.keys(t).forEach(function(e){if(e.indexOf("_numsel")!==-1){delete t[e]}if(e.indexOf("_datesel")!==-1){var i=t[e];if(i===s.EXACT||i===s.RANGE||i===n.PREV_DAY||i===n.NEXT_DAY||i===n.MORE_THAN_DAYS_AGO||i===n.AFTER_DAYS||i===s.PREV_DAYS||i===s.NEXT_DAYS||i===s.YEAR||i===s.MONTH||i===s.QUARTER||i===s.NONE||i===s.CUSTOM_DATE){delete t[e]}}var a=this.parent.getFieldByName(e);if(t[e]===""&&(!a||!a.STRICT)){delete t[e]}},this)}}}},{key:"isPresetValuesModified",value:function e(t){var i=this.getPreset(t);var s=this.parent.preparePresetSettingsFields(i.FIELDS);var n=this.parent.getFilterFieldsValues();this.removeNotCompareVariables(s);this.removeNotCompareVariables(n);var a=BX.Filter.Utils.sortObject(s);var r=BX.Filter.Utils.sortObject(n);return!Object.keys(a).every(function(e){return a[e]===r[e]||(BX.type.isPlainObject(a[e])||BX.type.isArray(a[e]))&&BX.Filter.Utils.objectsIsEquals(a[e],r[e])})}},{key:"getAdditionalValues",value:function e(t){var i=this.getPreset(t);var s=i.FIELDS.filter(function(e){return!this.isEmptyField(e)},this);var n=this.parent.preparePresetSettingsFields(s);var a=this.parent.getFilterFieldsValues();this.removeNotCompareVariables(n,true);this.removeNotCompareVariables(a,true);this.removeSameProperties(a,n);return a}},{key:"removeSameProperties",value:function e(t,i){if(BX.type.isPlainObject(t)&&BX.type.isPlainObject(i)){Object.keys(i).forEach(function(e){if(e in t){delete t[e]}})}}},{key:"removeAdditionalField",value:function e(t){var i=this.getPreset(this.getCurrentPresetId());if(BX.type.isArray(i.ADDITIONAL)){i.ADDITIONAL=i.ADDITIONAL.filter(function(e){return e.NAME!==t})}}},{key:"updatePresetFields",value:function e(t,i){var s=this;var n;var a;var r=[];if(BX.type.isPlainObject(t)&&"FIELDS"in t){n=t.FIELDS;if(BX.type.isArray(t.ADDITIONAL)){t.ADDITIONAL.filter(function(e){return s.parent.params.FIELDS.some(function(t){return e.NAME===t.NAME})}).forEach(function(e){var t=false;e.IS_PRESET_FIELD=true;n.forEach(function(i,s){if(e.NAME===i.NAME){n[s]=e;t=true}});if(!t){n.push(e)}})}(n||[]).filter(function(e){return s.parent.params.FIELDS.some(function(t){return e.NAME===t.NAME})}).forEach(function(e,t){e.TABINDEX=t+1;if(i){switch(e.TYPE){case this.parent.types.SELECT:{e.VALUE=e.ITEMS[0];break}case this.parent.types.MULTI_SELECT:{e.VALUE=[];break}case this.parent.types.DATE:{e.SUB_TYPE=e.SUB_TYPES[0];e.VALUES={_from:"",_to:"",_days:""};break}case this.parent.types.CUSTOM_DATE:{e.VALUE={days:[],months:[],years:[]};break}case this.parent.types.NUMBER:{e.SUB_TYPE=e.SUB_TYPES[0];e.VALUES={_from:"",_to:""};break}case this.parent.types.CUSTOM_ENTITY:{e.VALUES={_label:"",_value:""};break}case this.parent.types.CUSTOM:{e._VALUE="";break}default:{if("VALUE"in e){if(BX.type.isArray(e.VALUE)){e.VALUE=[]}else{e.VALUE=""}}break}}}r.push(this.createControl(e))},this);this.parent.disableFieldsDragAndDrop();a=this.parent.getFieldListContainer();BX.cleanNode(a);if(r.length){r.forEach(function(e,i){if(BX.type.isDomNode(e)){if(t.ID!=="tmp_filter"&&t.ID!=="default_filter"&&!("IS_PRESET_FIELD"in n[i])&&!this.isEmptyField(n[i])){BX.addClass(e,this.parent.settings.classPresetField)}BX.append(e,a);if(BX.type.isString(n[i].HTML)){var s=BX.create("div");this.parent.getHiddenElement().appendChild(s);BX.html(s,n[i].HTML)}}},this);this.parent.enableFieldsDragAndDrop()}}}},{key:"showCurrentPresetFields",value:function e(){var t=this.getCurrentPresetData();this.updatePresetFields(t)}},{key:"getCurrentPreset",value:function e(){return BX.Filter.Utils.getByClass(this.getContainer(),this.parent.settings.classPresetCurrent)}},{key:"getCurrentPresetId",value:function e(){var t=this.getCurrentPreset();var i=null;if(BX.type.isDomNode(t)){i=this.getPresetId(t)}else{i="tmp_filter"}return i}},{key:"getCurrentPresetData",value:function e(){var t=this.getCurrentPresetId();var i=null;if(BX.type.isNotEmptyString(t)){i=this.getPreset(t);i=this.extendPreset(i)}return i}},{key:"getContainer",value:function e(){return BX.Filter.Utils.getByClass(this.parent.getFilter(),this.parent.settings.classPresetsContainer)}},{key:"getPresets",value:function e(){return BX.Filter.Utils.getByClass(this.getContainer(),this.parent.settings.classPreset,true)}},{key:"getDefaultPresets",value:function e(){return BX.Filter.Utils.getByClass(this.getContainer(),this.parent.settings.classDefaultFilter,true)}},{key:"getPinnedPresetNode",value:function e(){return BX.Filter.Utils.getByClass(this.getContainer(),this.parent.settings.classPinnedPreset)}},{key:"isPinned",value:function e(t){return this.getPinnedPresetId()===t}},{key:"getPinnedPresetId",value:function e(){var t=this.getPinnedPresetNode();var i="default_filter";if(t){var s=BX.data(t,"id");i=s||i}return i}}]);return e}();e.Field=n;e.Api=a;e.Fields=f;e.Presets=m})(this.BX.Filter=this.BX.Filter||{},BX);
/* End */
;
; /* Start:"a:4:{s:4:"full";s:84:"/bitrix/components/bitrix/crm.kanban/templates/.default/script.min.js?15753007507230";s:6:"source";s:65:"/bitrix/components/bitrix/crm.kanban/templates/.default/script.js";s:3:"min";s:69:"/bitrix/components/bitrix/crm.kanban/templates/.default/script.min.js";s:3:"map";s:69:"/bitrix/components/bitrix/crm.kanban/templates/.default/script.map.js";}"*/
BX.namespace("Crm.KanbanComponent");BX.Crm.KanbanComponent.currentPopupItem=null;BX.Crm.KanbanComponent.currentPopup=null;BX.Crm.KanbanComponent.currentData=null;BX.Crm.KanbanComponent.successClosePopup=false;BX.Crm.KanbanComponent.dropConfirmed=false;BX.Crm.KanbanComponent.returnItem=function(e){var t=e.getLastPosition();var n=e.getData();var o=e.getGrid();var r=parseFloat(n.price);n.columnId=t.columnId;n.targetId=t.targetId;e.getColumn().decPrice(r);o.getColumn(n.columnId).incPrice(r);o.updateItem(e.getId(),n);o.unhideItem(e)};BX.Crm.KanbanComponent.clearPopup=function(e){var t=BX.findChild(BX(e),{className:"crm-kanban-popup-field"},true,true);if(t&&t.length>0){for(var n=0,o=t.length;n<o;n++){var r=BX.data(t[n],"default");t[n].value=r?r:""}}};BX.Crm.KanbanComponent.collectFieldsPopup=function(e){var t=BX.findChild(BX(e),{className:"crm-kanban-popup-field"},true,true);var n={};if(t&&t.length>0){for(var o=0,r=t.length;o<r;o++){var i=BX.data(t[o],"field");if(i){n[i]=t[o].value}}}return n};BX.Crm.KanbanComponent.showPopup=function(e,t,n){if(e==="crm_kanban_lead_win"){var o=t.item.getData();var r=BX.findChildren(BX(e),{className:"kanban-converttype"},true,true);for(var i=0,a=r.length;i<a;i++){if(o.return){r[i].style.display=BX.data(r[i],"type")==="deal"?"block":"none"}else{r[i].style.display="block"}}}BX.Crm.KanbanComponent.currentPopupItem=t.item;this.currentPopup=new BX.PopupWindow("kanban_column_popup",window.body,{closeIcon:true,offsetLeft:0,lightShadow:true,overlay:true,titleBar:{content:BX.create("span",{html:""})},draggable:true,contentColor:"white",closeByEsc:true,events:{onPopupClose:function(){if(!this.successClosePopup){this.returnItem(t.item)}this.dropConfirmed=false}.bind(this)},buttons:[e!=="crm_kanban_lead_win"?new BX.PopupWindowButton({text:BX.data(BX(e),"deletetitle")?BX.data(BX(e),"deletetitle"):BX.message("CRM_KANBAN_POPUP_PARAMS_SAVE"),className:"popup-window-button-accept",events:{click:function(){if(n.toLowerCase()==="column"){var o=t.item.getGrid();o.setAjaxParams(this.collectFieldsPopup(e));o.onItemMoved(t.item,t.targetColumn,t.beforeItem,true);this.successClosePopup=true}else if(n.toLowerCase()==="dropzone"){var r=t.getItem();var o=r.getGrid();var i=t.getDropZone();o.setAjaxParams(this.collectFieldsPopup(e));o.unhideItem(r);i.captureItem(r);this.successClosePopup=true}this.currentPopup.close()}.bind(this)}}):null,new BX.PopupWindowButton({text:BX.message("CRM_KANBAN_POPUP_PARAMS_CANCEL"),className:"popup-window-button-decline",events:{click:function(){this.returnItem(t.item);this.currentPopup.close()}.bind(this)}})]});this.clearPopup(e);this.currentPopup.setContent(BX(e));this.currentPopup.setTitleBar(BX.data(BX(e),"title"));this.currentPopup.show()};BX.Crm.KanbanComponent.leadConvert=function(e){var t=this.currentData;if(!t||!t.item){return}var n=t.item.getId();this.successClosePopup=true;this.currentPopup.close();if(e==="SELECT"){BX.CrmLeadConverter.getCurrent().openEntitySelector(function(e){BX.Crm.KanbanComponent.currentPopupItem=null;BX.CrmLeadConverter.getCurrent().convert(n,e.config,"",e.data)})}else{BX.CrmLeadConverter.getCurrent().convert(n,BX.CrmLeadConversionScheme.createConfig(e),"")}};BX.Crm.KanbanComponent.columnPopup=function(e){var t=e.grid;var n=t.getData();var o=e.item;var r=o.getData();var i=e.targetColumn;var a=i?i.getId():0;BX.Crm.KanbanComponent.currentData=e;if(i&&a!==r.columnId){var s=i.getData();if(s.type==="WIN"&&n.entityType==="LEAD"){BX.Crm.KanbanComponent.showPopup("crm_kanban_lead_win",e,"column");e.skip=true}else if(n.entityType==="INVOICE"){if(s.type==="WIN"){BX.Crm.KanbanComponent.showPopup("crm_kanban_invoice_win",e,"column");e.skip=true}else if(s.type==="LOOSE"){BX.Crm.KanbanComponent.showPopup("crm_kanban_invoice_loose",e,"column");e.skip=true}}}};BX.Crm.KanbanComponent.dropPopup=function(e,t){var n=e.getData();var o=t.getDropZone();var r=o.getData();var i=t.getItem();if(BX.Crm.KanbanComponent.dropConfirmed!==false){return}else{BX.Crm.KanbanComponent.dropConfirmed=true}if(n.entityType==="LEAD"){if(r.type==="WIN"){e.hideItem(i);BX.Crm.KanbanComponent.currentData={grid:e,item:i,targetColumn:null,beforeItem:null};BX.Crm.KanbanComponent.showPopup("crm_kanban_lead_win",t,"dropzone");t.denyAction()}}else if(n.entityType==="INVOICE"){e.hideItem(i);BX.Crm.KanbanComponent.currentData={grid:e,item:i,targetColumn:null,beforeItem:null};if(r.type==="WIN"){BX.Crm.KanbanComponent.showPopup("crm_kanban_invoice_win",t,"dropzone")}else{BX.Crm.KanbanComponent.showPopup("crm_kanban_invoice_loose",t,"dropzone")}t.denyAction()}};BX.Crm.KanbanComponent.onPopupClose=function(e){if(e&&typeof e.uniquePopupId!=="undefined"&&e.uniquePopupId==="CRM-lead_converter-popup"&&BX.Crm.KanbanComponent.currentPopupItem!==null){setTimeout(function(){if(BX.Crm.KanbanComponent.currentPopupItem!==null){BX.Crm.KanbanComponent.returnItem(BX.Crm.KanbanComponent.currentPopupItem)}},300)}};BX.Crm.KanbanComponent.onSpecialItemDraw=function(e,t){[].slice.call(t.querySelectorAll(".crm-kanban-sidepanel")).forEach(function(t){BX.bind(t,"click",BX.delegate(function(t){var n=e.getGrid().getData();var o=BX.data(this,"url").toString().toLowerCase();if(typeof n.linksPath[o]!=="undefined"){var r=BX.data(this,"skipslider")||n.linksPath[o].skipslider;if(parseInt(r)==1){window.location.href=n.linksPath[o].url}else{BX.SidePanel.Instance.open(n.linksPath[o].url,n.linksPath[o].params||{})}}t.preventDefault()}))})};if(typeof BX.Crm.EntityEditorUserSelector==="undefined"&&typeof BX.SocNetLogDestination!=="undefined"){BX.Crm.EntityEditorUserSelector=function(){this._id="";this._settings={}};BX.Crm.EntityEditorUserSelector.prototype={initialize:function(e,t){this._id=e;this._settings=t?t:{};this._isInitialized=false},getId:function(){return this._id},open:function(e){if(this._mainWindow&&this._mainWindow===BX.SocNetLogDestination.containerWindow){return}if(!this._isInitialized){BX.SocNetLogDestination.init({name:this._id,groupCode:"users",extranetUser:false,bindMainPopup:{node:e,offsetTop:"5px",offsetLeft:"15px"},callback:{select:BX.delegate(this.onSelect,this)},showSearchInput:true,departmentSelectDisable:true,items:{users:BX.Crm.EntityEditorUserSelector.users,groups:{},sonetgroups:{},department:BX.Crm.EntityEditorUserSelector.department,departmentRelation:BX.SocNetLogDestination.buildDepartmentRelation(BX.Crm.EntityEditorUserSelector.department)},itemsLast:BX.Crm.EntityEditorUserSelector.last,itemsSelected:{},isCrmFeed:false,useClientDatabase:false,destSort:{},allowAddUser:false,allowSearchCrmEmailUsers:false,allowUserSearch:true});this._isInitialized=true}BX.SocNetLogDestination.openDialog(this._id,{bindNode:e});this._mainWindow=BX.SocNetLogDestination.containerWindow},close:function(){if(this._mainWindow&&this._mainWindow===BX.SocNetLogDestination.containerWindow){BX.SocNetLogDestination.closeDialog();this._mainWindow=null;this._isInitialized=false}},onSelect:function(e,t,n,o){if(t!=="users"){return}var r=BX.prop.getFunction(this._settings,"callback",null);if(r){r(this,e)}}};BX.Crm.EntityEditorUserSelector.items={};BX.Crm.EntityEditorUserSelector.create=function(e,t){var n=new BX.Crm.EntityEditorUserSelector(e,t);n.initialize(e,t);this.items[n.getId()]=n;return n}}
/* End */
;
; /* Start:"a:4:{s:4:"full";s:93:"/bitrix/components/bitrix/crm.entity.editor/templates/.default/script.min.js?1575300751505963";s:6:"source";s:72:"/bitrix/components/bitrix/crm.entity.editor/templates/.default/script.js";s:3:"min";s:76:"/bitrix/components/bitrix/crm.entity.editor/templates/.default/script.min.js";s:3:"map";s:76:"/bitrix/components/bitrix/crm.entity.editor/templates/.default/script.map.js";}"*/
BX.namespace("BX.Crm");if(typeof BX.Crm.EntityEditor==="undefined"){BX.Crm.EntityEditor=function(){this._id="";this._settings={};this._entityTypeId=0;this._entityId=0;this._userFieldManager=null;this._dupControlManager=null;this._bizprocManager=null;this._attributeManager=null;this._container=null;this._buttonContainer=null;this._createSectionButton=null;this._configMenuButton=null;this._configIcon=null;this._pageTitle=null;this._pageTitleInput=null;this._buttonWrapper=null;this._editPageTitleButton=null;this._copyPageUrlButton=null;this._formElement=null;this._ajaxForm=null;this._afterFormSubmitHandler=BX.delegate(this.onAfterFormSubmit,this);this._cancelFormSubmitHandler=BX.delegate(this.onCancelFormSubmit,this);this._controllers=null;this._controls=null;this._activeControls=null;this._toolPanel=null;this._model=null;this._scheme=null;this._config=null;this._context=null;this._contextId="";this._externalContextId="";this._mode=BX.Crm.EntityEditorMode.intermediate;this._isNew=false;this._readOnly=false;this._enableRequiredUserFieldCheck=true;this._enableAjaxForm=true;this._enableSectionEdit=false;this._enableSectionCreation=false;this._enableModeToggle=true;this._enableVisibilityPolicy=true;this._enablePageTitleContols=true;this._enableToolPanel=true;this._enableBottomPanel=true;this._enableFieldsContextMenu=true;this._showEmptyFields=false;this._serviceUrl="";this._htmlEditorConfigs=null;this._areAvailableSchemeElementsChanged=false;this._availableSchemeElements=null;this._dragPlaceHolder=null;this._dragContainerController=null;this._dropHandler=BX.delegate(this.onDrop,this);this._pageTitleExternalClickHandler=BX.delegate(this.onPageTitleExternalClick,this);this._pageTitleKeyPressHandler=BX.delegate(this.onPageTitleKeyPress,this);this._modeChangeNotifier=null;this._controlChangeNotifier=null;this._validators=null;this._modeSwitch=null;this._delayedSaveHandle=0;this._isEmbedded=false;this._isRequestRunning=false;this._isConfigMenuShown=false;this._isReleased=false;this._enableCloseConfirmation=true;this._closeConfirmationHandler=BX.delegate(this.onCloseConfirmButtonClick,this);this._cancelConfirmationHandler=BX.delegate(this.onCancelConfirmButtonClick,this);this._sliderOpenHandler=BX.delegate(this.onSliderOpen,this);this._sliderCloseHandler=BX.delegate(this.onSliderClose,this);this._entityUpdateHandler=BX.delegate(this.onEntityUpdate,this);this._helpWrapper=null;this._dragConfig={}};BX.Crm.EntityEditor.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._model=BX.prop.get(this._settings,"model",null);this._scheme=BX.prop.get(this._settings,"scheme",null);this._config=BX.prop.get(this._settings,"config",null);this._serviceUrl=BX.prop.getString(this._settings,"serviceUrl","");this._entityTypeId=BX.prop.getInteger(this._settings,"entityTypeId",0);this._entityId=BX.prop.getInteger(this._settings,"entityId",0);this._isNew=this._entityId<=0;this._isEmbedded=BX.prop.getBoolean(this._settings,"isEmbedded",false);var i=BX.prop.get(this._settings,"container");if(!BX.type.isElementNode(i)){i=BX(BX.prop.get(this._settings,"containerId"))}this._container=i;if(!BX.type.isElementNode(i)){throw"Crm.EntityEditor: Could not find settings param 'container'."}this._parentContainer=BX.findParent(this._container,{className:"crm-entity-section"},false);this._buttonContainer=BX(BX.prop.get(this._settings,"buttonContainerId"));this._createSectionButton=BX(BX.prop.get(this._settings,"createSectionButtonId"));this._configMenuButton=BX(BX.prop.get(this._settings,"configMenuButtonId"));this._configIcon=BX(BX.prop.get(this._settings,"configIconId"));this._enableVisibilityPolicy=BX.prop.getBoolean(this._settings,"enableVisibilityPolicy",true);this._enablePageTitleContols=BX.prop.getBoolean(this._settings,"enablePageTitleControls",true);if(this._enablePageTitleContols){this._pageTitle=BX("pagetitle");this._buttonWrapper=BX("pagetitle_btn_wrapper");this._editPageTitleButton=BX("pagetitle_edit");this._copyPageUrlButton=BX("page_url_copy_btn")}this.adjustSize();this.adjustTitle();this._formElement=BX.create("form",{props:{name:this._id+"_form"}});this._container.appendChild(this._formElement);this._enableRequiredUserFieldCheck=BX.prop.getBoolean(this._settings,"enableRequiredUserFieldCheck",true);this._enableAjaxForm=BX.prop.getBoolean(this._settings,"enableAjaxForm",true);if(this._enableAjaxForm){this.initializeAjaxForm()}var n=BX.prop.getObject(this._settings,"duplicateControl",{});if(this._ajaxForm){n["form"]=this._ajaxForm}this._dupControlManager=BX.Crm.EntityEditorDupManager.create(this._id.toLowerCase()+"_dup",n);this._context=BX.prop.getObject(this._settings,"context",{});this._contextId=BX.prop.getString(this._settings,"contextId","");this._externalContextId=BX.prop.getString(this._settings,"externalContextId","");this._readOnly=BX.prop.getBoolean(this._settings,"readOnly",false);if(this._readOnly){this._enableSectionEdit=this._enableSectionCreation=false}else{this._enableSectionEdit=BX.prop.getBoolean(this._settings,"enableSectionEdit",false);this._enableSectionCreation=BX.prop.getBoolean(this._settings,"enableSectionCreation",false)}this._userFieldManager=BX.prop.get(this._settings,"userFieldManager",null);this._bizprocManager=BX.prop.get(this._settings,"bizprocManager",null);if(this._bizprocManager){this._bizprocManager._editor=this}this._restPlacementTabManager=BX.prop.get(this._settings,"restPlacementTabManager",null);if(this._restPlacementTabManager){this._restPlacementTabManager._editor=this}this._modeChangeNotifier=BX.CrmNotifier.create(this);this._controlChangeNotifier=BX.CrmNotifier.create(this);this._availableSchemeElements=this._scheme.getAvailableElements();this._controllers=[];this._controls=[];this._activeControls=[];this._modeSwitch=BX.Crm.EntityEditorModeSwitch.create(this._id,{editor:this});this._htmlEditorConfigs=BX.prop.getObject(this._settings,"htmlEditorConfigs",{});var r=this._scheme.getElements();var o=BX.Crm.EntityEditorMode.view;if(!this._readOnly){o=BX.Crm.EntityEditorMode.parse(BX.prop.getString(this._settings,"initialMode",""))}this._mode=o!==BX.Crm.EntityEditorMode.intermediate?o:BX.Crm.EntityEditorMode.view;this._enableModeToggle=false;if(!this._readOnly){this._enableModeToggle=BX.prop.getBoolean(this._settings,"enableModeToggle",true)}if(this._isNew&&!this._readOnly){this._mode=BX.Crm.EntityEditorMode.edit}var s,a;var l=BX.prop.getArray(this._settings,"controllers",[]);for(s=0,a=l.length;s<a;s++){var d=this.createController(l[s]);if(d){this._controllers.push(d)}}var h,p;for(s=0,a=r.length;s<a;s++){h=r[s];p=this.createControl(h.getType(),h.getName(),{schemeElement:h,mode:BX.Crm.EntityEditorMode.view});if(!p){continue}this._controls.push(p)}if(this._mode===BX.Crm.EntityEditorMode.edit&&this._controls.length>0){for(s=0,a=this._controls.length;s<a;s++){p=this._controls[s];var u=p.getEditPriority();if(u===BX.Crm.EntityEditorPriority.high){p.setMode(BX.Crm.EntityEditorMode.edit,{notify:false})}}if(this.getActiveControlCount()===0){this._controls[0].setMode(BX.Crm.EntityEditorMode.edit,{notify:false})}}this._validators=[];var c=BX.prop.getArray(this._settings,"validators",[]);for(s=0,a=c.length;s<a;s++){var m=this.createValidator(c[s]);if(m){this._validators.push(m)}}this._modeChangeNotifier.notify([this]);this._enableToolPanel=BX.prop.getBoolean(this._settings,"enableToolPanel",true);if(this._enableToolPanel){this._toolPanel=BX.Crm.EntityEditorToolPanel.create(this._id,{container:this._isEmbedded?this._formElement:document.body,editor:this,visible:false})}this._enableBottomPanel=BX.prop.getBoolean(this._settings,"enableBottomPanel",true);this._enableFieldsContextMenu=BX.prop.getBoolean(this._settings,"enableFieldsContextMenu",true);this._showEmptyFields=BX.prop.getBoolean(this._settings,"showEmptyFields",false);BX.addCustomEvent(window,"Crm.InterfaceToolbar.MenuBuild",BX.delegate(this.onInterfaceToolbarMenuBuild,this));this._dragConfig={};var y={};y[BX.Crm.EntityEditorMode.names.view]=y[BX.Crm.EntityEditorMode.names.edit]=BX.prop.getBoolean(this._settings,"enableSectionDragDrop",true);this._dragConfig[BX.Crm.EditorDragObjectType.section]={scope:BX.Crm.EditorDragScope.form,modes:y};var g={};g[BX.Crm.EntityEditorMode.names.view]=g[BX.Crm.EntityEditorMode.names.edit]=BX.prop.getBoolean(this._settings,"enableFieldDragDrop",true);this._dragConfig[BX.Crm.EditorDragObjectType.field]={scope:BX.Crm.EditorDragScope.form,modes:g};if(this.canChangeScheme()){this._dragContainerController=BX.Crm.EditorDragContainerController.create("editor_"+this.getId(),{charge:BX.Crm.EditorSectionDragContainer.create({editor:this}),node:this._formElement});this._dragContainerController.addDragFinishListener(this._dropHandler)}this.layout();BX.bind(window,"resize",BX.debounce(BX.delegate(this.onResize,this),50));BX.addCustomEvent("SidePanel.Slider:onOpenComplete",this._sliderOpenHandler);BX.addCustomEvent("SidePanel.Slider:onClose",this._sliderCloseHandler);BX.addCustomEvent("onCrmEntityUpdate",this._entityUpdateHandler);var f={id:this._id,externalContext:this._externalContextId,context:this._contextId,entityTypeId:this._entityTypeId,entityId:this._entityId,model:this._model};BX.onCustomEvent(window,"BX.Crm.EntityEditor:onInit",[this,f])},release:function(){if(this._dragContainerController){this._dragContainerController.removeDragFinishListener(this._dropHandler);this._dragContainerController.release();this._dragContainerController=null}for(var t=0,e=this._controls.length;t<e;t++){this._controls[t].clearLayout()}BX.removeCustomEvent("onCrmEntityUpdate",this._entityUpdateHandler);BX.removeCustomEvent("SidePanel.Slider:onOpenComplete",this._sliderOpenHandler);BX.removeCustomEvent("SidePanel.Slider:onClose",this._sliderCloseHandler);this.releaseAjaxForm();this._container=BX.remove(this._container);this._isReleased=true},clone:function(t){var e=BX(BX.prop.get(t,"wrapper"));if(!BX.type.isElementNode(e)){throw"Crm.EntityEditor: Could not find param 'wrapper'."}var i=BX.prop.getString(t,"id","");if(i===""){i=BX.util.getRandomString(4)}var n=BX.create("DIV",{props:{id:i.toLowerCase()+"_container",className:"crm-entity-card-container-content"}});e.appendChild(n);var r=BX.clone(this._settings);delete r["containerId"];r["container"]=n;return BX.Crm.EntityEditor.create(i,r)},onSliderOpen:function(t){this._enableCloseConfirmation=true;var e={id:this._id,externalContext:this._externalContextId,context:this._contextId,entityTypeId:this._entityTypeId,entityId:this._entityId,model:this._model};BX.onCustomEvent(window,"BX.Crm.EntityEditor:onOpen",[this,e])},onSliderClose:function(t){if(!this._enableCloseConfirmation){return}var e=top.BX.SidePanel.Instance.getSliderByWindow(window);if(e!==t.getSlider()){return}if(!e.isOpen()){return}if(!this.hasChangedControls()&&!this.hasChangedControllers()){return}t.denyAction();if(BX.Crm.EditorAuxiliaryDialog.isItemOpened("close_confirmation")){return}BX.Crm.EditorAuxiliaryDialog.create("close_confirmation",{title:BX.message("CRM_EDITOR_CONFIRMATION"),content:BX.message("CRM_EDITOR_CLOSE_CONFIRMATION"),zIndex:100,buttons:[{id:"close",type:BX.Crm.DialogButtonType.accept,text:BX.message("JS_CORE_WINDOW_CLOSE"),callback:this._closeConfirmationHandler},{id:"cancel",type:BX.Crm.DialogButtonType.cancel,text:BX.message("JS_CORE_WINDOW_CANCEL"),callback:this._closeConfirmationHandler}]}).open()},onCloseConfirmButtonClick:function(t){t.getDialog().close();if(t.getId()==="close"){this._enableCloseConfirmation=false;top.BX.SidePanel.Instance.getSliderByWindow(window).close()}},onCancelConfirmButtonClick:function(t){t.getDialog().close();if(t.getId()==="yes"){this.innerCancel()}},onEntityUpdate:function(t){if(this._isReleased){return}if(this._entityTypeId===BX.prop.getInteger(t,"entityTypeId",0)&&this._entityId===BX.prop.getInteger(t,"entityId",0)&&this!==BX.prop.get(t,"sender",0)){var e=BX.prop.getObject(t,"entityData",null);if(e){this._model.setData(e,{enableNotification:false});this.adjustTitle();this.adjustSize();this.refreshLayout({reset:true})}}},initializeAjaxForm:function(){if(this._ajaxForm){return}this._ajaxForm=BX.Crm.AjaxForm.create(this._id,{elementNode:this._formElement,config:{url:this._serviceUrl,method:"POST",dataType:"json",processData:true,onsuccess:BX.delegate(this.onSaveSuccess,this),data:{ACTION:"SAVE",ACTION_ENTITY_ID:this._entityId,ACTION_ENTITY_TYPE:BX.CrmEntityType.resolveAbbreviation(BX.CrmEntityType.resolveName(this._entityTypeId)),ENABLE_REQUIRED_USER_FIELD_CHECK:this._enableRequiredUserFieldCheck?"Y":"N"}}});this._formElement.setAttribute("onsubmit","return false;");BX.addCustomEvent(this._ajaxForm,"onAfterSubmit",this._afterFormSubmitHandler);BX.addCustomEvent(this._ajaxForm,"onSubmitCancel",this._cancelFormSubmitHandler)},releaseAjaxForm:function(){if(!this._ajaxForm){return}BX.removeCustomEvent(this._ajaxForm,"onAfterSubmit",this._afterFormSubmitHandler);BX.removeCustomEvent(this._ajaxForm,"onSubmitCancel",this._cancelFormSubmitHandler);this._ajaxForm=null},getId:function(){return this._id},getEntityTypeId:function(){return this._entityTypeId},getEntityTypeName:function(){return BX.CrmEntityType.resolveName(this._entityTypeId)},getEntityId:function(){return this._entityId},getOwnerInfo:function(){return this._model.getOwnerInfo()},getMode:function(){return this._mode},getModel:function(){return this._model},getContextId:function(){return this._contextId},getContext:function(){return this._context},getExternalContextId:function(){return this._externalContextId},getScheme:function(){return this._scheme},isVisible:function(){return this._container.offsetParent!==null},isVisibilityPolicyEnabled:function(){return this._enableVisibilityPolicy},isSectionEditEnabled:function(){return this._enableSectionEdit},isSectionCreationEnabled:function(){return this._enableSectionCreation&&this.canChangeScheme()},isFieldsContextMenuEnabled:function(){return this._enableFieldsContextMenu},isModeToggleEnabled:function(){return this._enableModeToggle},isNew:function(){return this._isNew},isReadOnly:function(){return this._readOnly},isEmbedded:function(){return this._isEmbedded},isEditInViewEnabled:function(){return this._entityId>0},isNeedToDisplayEmptyFields:function(){return this._showEmptyFields},getEntityCreateUrl:function(t){if(t===BX.CrmEntityType.names.contact){return BX.prop.getString(this._settings,"contactCreateUrl","")}else if(t===BX.CrmEntityType.names.company){return BX.prop.getString(this._settings,"companyCreateUrl","")}return""},getEntityEditUrl:function(t,e){var i="";if(t===BX.CrmEntityType.names.contact){i=BX.prop.getString(this._settings,"contactEditUrl","")}else if(t===BX.CrmEntityType.names.company){i=BX.prop.getString(this._settings,"companyEditUrl","")}if(i!==""){i=i.replace("#id#",e,"gi")}return i},getEntityRequisiteSelectUrl:function(t,e){var i="";if(t===BX.CrmEntityType.names.contact){i=BX.prop.getString(this._settings,"contactRequisiteSelectUrl","").replace(/#contact_id#/gi,e)}else if(t===BX.CrmEntityType.names.company){i=BX.prop.getString(this._settings,"companyRequisiteSelectUrl","").replace(/#company_id#/gi,e)}return i},getRequisiteEditUrl:function(t){return BX.prop.getString(this._settings,"requisiteEditUrl","").replace(/#requisite_id#/gi,t)},getDetailManager:function(){if(typeof BX.Crm.EntityDetailManager==="undefined"){return null}return BX.Crm.EntityDetailManager.get(BX.prop.getString(this._settings,"detailManagerId",""))},getUserFieldManager:function(){return this._userFieldManager},getBizprocManager:function(){return this._bizprocManager},getAttributeManager:function(){if(!this._attributeManager){var t=this.getAttributeManagerSettings();if(t){this._attributeManager=BX.Crm.EntityFieldAttributeManager.create(this._id,{entityTypeId:this.getEntityTypeId(),entityScope:BX.prop.getString(t,"ENTITY_SCOPE",""),isPermitted:BX.prop.getBoolean(t,"IS_PERMITTED",true),lockScript:BX.prop.getString(t,"LOCK_SCRIPT",""),captions:BX.prop.getObject(t,"CAPTIONS",{})})}}return this._attributeManager},getHtmlEditorConfig:function(t){return BX.prop.getObject(this._htmlEditorConfigs,t,null)},createValidator:function(t){t["editor"]=this;return BX.Crm.EntityEditorValidatorFactory.create(BX.prop.getString(t,"type",""),t)},getControlByIndex:function(t){return t>=0&&t<this._controls.length?this._controls[t]:null},getControlIndex:function(t){for(var e=0,i=this._controls.length;e<i;e++){if(this._controls[e]===t){return e}}return-1},getControls:function(){return this._controls},getControlCount:function(){return this._controls.length},createControl:function(t,e,i){i["serviceUrl"]=this._serviceUrl;i["container"]=this._formElement;i["model"]=this._model;i["editor"]=this;return BX.Crm.EntityEditorControlFactory.create(t,e,i)},addControlAt:function(t,e){var i={};if(e<this._controls.length){i["anchor"]=this._controls[e].getWrapper();this._controls.splice(e,0,t)}else{this._controls.push(t)}t.layout(i)},moveControl:function(t,e){var i=this._controls.length;var n=i-1;if(e<0||e>i){e=n}var r=this.getControlIndex(t);if(r<0||r===e){return false}t.clearLayout();this._controls.splice(r,1);i--;var o=e<i?this._controls[e].getWrapper():null;if(e<i){this._controls.splice(e,0,t)}else{this._controls.push(t)}if(o){t.layout({anchor:o})}else{t.layout()}this._config.moveSchemeElement(t.getSchemeElement(),e)},removeControl:function(t){var e=this.getControlIndex(t);if(e<0){return false}this.processControlRemove(t);t.clearLayout();this._controls.splice(e,1)},getControlById:function(t){for(var e=0,i=this._controls.length;e<i;e++){var n=this._controls[e];if(n.getId()===t){return n}var r=n.getChildById(t);if(r){return r}}return null},getControlByIdRecursive:function(t,e){var i;if(!e){e=this.getControls()}for(var n=0;n<e.length;n++){if(!e[n]instanceof BX.Crm.EntityEditorControl){continue}if(e[n].getId()===t){return e[n]}else if(e[n]instanceof BX.Crm.EntityEditorSection){if(i=this.getControlByIdRecursive(t,e[n].getChildren())){return i}}}return null},getAllControls:function(t){var e=[],i;if(!t){t=this.getControls()}for(var n=0;n<t.length;n++){if(t[n]instanceof BX.Crm.EntityEditorControl){if(t[n]instanceof BX.Crm.EntityEditorSection){if(i=this.getAllControls(t[n].getChildren())){e=e.concat(i)}}else{e.push(t[n])}}}return e},getActiveControlCount:function(){return this._activeControls.length},getActiveControlIndex:function(t){var e=this._activeControls.length;if(e===0){return-1}for(var i=0;i<e;i++){if(this._activeControls[i]===t){return i}}return-1},getActiveControlById:function(t,e){e=!!e;var i=this._activeControls.length;if(i===0){return null}for(var n=0;n<i;n++){var r=this._activeControls[n];if(r.getId()===t){return r}if(e){var o=r.getChildById(t);if(o){return o}}}return null},getActiveControlByIndex:function(t){return t>=0&&t<this._activeControls.length?this._activeControls[t]:null},registerActiveControl:function(t){var e=this.getActiveControlIndex(t);if(e>=0){return}this._activeControls.push(t);t.setActive(true);if(this._mode!==BX.Crm.EntityEditorMode.edit){this._mode=BX.Crm.EntityEditorMode.edit;this._modeChangeNotifier.notify([this])}},unregisterActiveControl:function(t){var e=this.getActiveControlIndex(t);if(e<0){return}this._activeControls.splice(e,1);t.setActive(false);if(this._activeControls.length===0&&this._mode!==BX.Crm.EntityEditorMode.view){this._mode=BX.Crm.EntityEditorMode.view;this._modeChangeNotifier.notify([this])}},releaseActiveControls:function(t){var e={id:this._id,externalContext:this._externalContextId,context:this._contextId,entityTypeId:this._entityTypeId,entityId:this._entityId,model:this._model};BX.onCustomEvent(window,"BX.Crm.EntityEditor:onRelease",[this,e]);for(var i=0,n=this._activeControls.length;i<n;i++){var r=this._activeControls[i];r.setActive(false);r.toggleMode(false,t)}this._activeControls=[]},hasChangedControls:function(){for(var t=0,e=this._activeControls.length;t<e;t++){if(this._activeControls[t].isChanged()){return true}}return false},hasChangedControllers:function(){for(var t=0,e=this._controllers.length;t<e;t++){if(this._controllers[t].isChanged()){return true}}return false},isWaitingForInput:function(){if(this._mode!==BX.Crm.EntityEditorMode.edit){return false}for(var t=0,e=this._activeControls.length;t<e;t++){if(this._activeControls[t].isWaitingForInput()){return true}}return false},processControlModeChange:function(t){if(t.getMode()===BX.Crm.EntityEditorMode.edit){this.registerActiveControl(t)}else{this.unregisterActiveControl(t)}if(this.getActiveControlCount()>0){this.showToolPanel()}else{this.hideToolPanel()}},processControlChange:function(t,e){if(!this._enableCloseConfirmation){this._enableCloseConfirmation=true}this.showToolPanel();this._controlChangeNotifier.notify([e])},processControlAdd:function(t){this.removeAvailableSchemeElement(t.getSchemeElement())},processControlMove:function(t){},processControlRemove:function(t){if(t instanceof BX.Crm.EntityEditorField||t instanceof BX.Crm.EntityEditorSubsection){this.addAvailableSchemeElement(t.getSchemeElement())}else if(t instanceof BX.Crm.EntityEditorSection){var e=t.getChildren();for(var i=0,n=e.length;i<n;i++){this.addAvailableSchemeElement(e[i].getSchemeElement())}}},getAvailableSchemeElements:function(){return this._availableSchemeElements},addAvailableSchemeElement:function(t){this._availableSchemeElements.push(t);this._areAvailableSchemeElementsChanged=true;this.notifyAvailableSchemeElementsChanged()},removeAvailableSchemeElement:function(t){var e=this.getAvailableSchemeElementIndex(t);if(e<0){return}this._availableSchemeElements.splice(e,1);this._areAvailableSchemeElementsChanged=true;this.notifyAvailableSchemeElementsChanged()},getAvailableSchemeElementIndex:function(t){var e=this._availableSchemeElements;for(var i=0,n=e.length;i<n;i++){if(e[i]===t){return i}}return-1},getAvailableSchemeElementByName:function(t){var e=this._availableSchemeElements;for(var i=0,n=e.length;i<n;i++){var r=e[i];if(r.getName()===t){return r}}return null},hasAvailableSchemeElements:function(){return this._availableSchemeElements.length>0},getSchemeElementByName:function(t){return this._scheme.findElementByName(t,{isRecursive:true})},notifyAvailableSchemeElementsChanged:function(){for(var t=0,e=this._controls.length;t<e;t++){this._controls[t].processAvailableSchemeElementsChange()}},createController:function(t){return BX.Crm.EntityEditorControllerFactory.create(BX.prop.getString(t,"type",""),BX.prop.getString(t,"name",""),{config:BX.prop.getObject(t,"config",{}),model:this._model,editor:this})},processControllerChange:function(t){if(!this._enableCloseConfirmation){this._enableCloseConfirmation=true}this.showToolPanel()},getContainer:function(){return this._container},prepareContextDataLayout:function(t,e){for(var i in t){if(!t.hasOwnProperty(i)){continue}var n=t[i];var r=i;if(BX.type.isNotEmptyString(e)){r=e+"["+r+"]"}if(BX.type.isPlainObject(n)){this.prepareContextDataLayout(n,r)}else{this._formElement.appendChild(BX.create("input",{props:{type:"hidden",name:r,value:n}}))}}},layout:function(){this.prepareContextDataLayout(this._context,"");if(this._toolPanel){this._toolPanel.layout()}if(this._createSectionButton){if(this.isSectionCreationEnabled()){BX.bind(this._createSectionButton,"click",BX.delegate(this.onCreateSectionButtonClick,this))}else{this._createSectionButton.style.display="none"}}if(this._configMenuButton){BX.bind(this._configMenuButton,"click",BX.delegate(this.onConfigMenuButtonClick,this))}var t=BX.prop.getBoolean(this._settings,"enableInlineEditSpotlight",false);var e={edit:BX.Crm.EntityUserFieldLayoutLoader.create(this._id,{mode:BX.Crm.EntityEditorMode.edit,enableBatchMode:true,owner:this}),view:BX.Crm.EntityUserFieldLayoutLoader.create(this._id,{mode:BX.Crm.EntityEditorMode.view,enableBatchMode:true,owner:this})};var i,n,r;for(i=0,n=this._controls.length;i<n;i++){r=this._controls[i];var o=r.getMode();var s={userFieldLoader:e[BX.Crm.EntityEditorMode.getName(o)],enableFocusGain:!this._isEmbedded};if(i===0&&t&&o===BX.Crm.EntityEditorMode.view){s["lighting"]={id:BX.prop.getString(this._settings,"inlineEditSpotlightId",""),text:this.getMessage("inlineEditHint")}}r.layout(s);if(o===BX.Crm.EntityEditorMode.edit){this.registerActiveControl(r)}}for(var a in e){if(e.hasOwnProperty(a)){e[a].runBatch()}}if(this.getActiveControlCount()>0){this.showToolPanel()}if(this._model.isCaptionEditable()){BX.bind(this._pageTitle,"click",BX.delegate(this.onPageTileClick,this));if(this._editPageTitleButton){BX.bind(this._editPageTitleButton,"click",BX.delegate(this.onPageTileClick,this))}}if(this._mode===BX.Crm.EntityEditorMode.edit&&this._dupControlManager.isEnabled()){this._dupControlManager.search()}if(this._enableBottomPanel&&this._buttonContainer){this._buttonContainer.style.display=""}this.adjustButtons();BX.onCustomEvent(window,"BX.Crm.EntityEditor:onLayout",[this])},refreshLayout:function(t){var e={edit:BX.Crm.EntityUserFieldLayoutLoader.create(this._id,{mode:BX.Crm.EntityEditorMode.edit,enableBatchMode:true,owner:this}),view:BX.Crm.EntityUserFieldLayoutLoader.create(this._id,{mode:BX.Crm.EntityEditorMode.view,enableBatchMode:true,owner:this})};if(!BX.type.isPlainObject(t)){t={}}for(var i=0,n=this._controls.length;i<n;i++){var r=this._controls[i];var o=r.getMode();var s=BX.mergeEx(t,{userFieldLoader:e[BX.Crm.EntityEditorMode.getName(o)],enableFocusGain:!this._isEmbedded});r.refreshLayout(s)}for(var a in e){if(e.hasOwnProperty(a)){e[a].runBatch()}}this.adjustButtons();BX.onCustomEvent(window,"BX.Crm.EntityEditor:onRefreshLayout",[this])},switchControlMode:function(t,e,i){if(!this.isModeToggleEnabled()){return}if(e===BX.Crm.EntityEditorMode.view){if(t.checkModeOption(BX.Crm.EntityEditorModeOptions.saveOnExit)){this._modeSwitch.getQueue().add(t,BX.Crm.EntityEditorMode.view);this._modeSwitch.run()}else{t.setMode(e,{options:i,notify:true});t.refreshLayout()}}else{if(!BX.Crm.EntityEditorModeOptions.check(i,BX.Crm.EntityEditorModeOptions.exclusive)){t.setMode(BX.Crm.EntityEditorMode.edit,{options:i,notify:true});t.refreshLayout()}else{var n=0;for(var r=0,o=this._activeControls.length;r<o;r++){var s=this._activeControls[r];if(s.checkModeOption(BX.Crm.EntityEditorModeOptions.saveOnExit)){this._modeSwitch.getQueue().add(s,BX.Crm.EntityEditorMode.view,i);n++}}if(n>0){this._modeSwitch.getQueue().add(t,BX.Crm.EntityEditorMode.edit,i);this._modeSwitch.run()}else{t.setMode(BX.Crm.EntityEditorMode.edit,{options:i,notify:true});t.refreshLayout()}}}},switchToViewMode:function(t){this.releaseActiveControls(t);this.hideToolPanel()},switchTitleMode:function(t){if(t===BX.Crm.EntityEditorMode.edit){this._pageTitle.style.display="none";if(this._buttonWrapper){this._buttonWrapper.style.display="none"}this._pageTitleInput=BX.create("input",{props:{type:"text",className:"pagetitle-item",value:this._model.getCaption()}});this._pageTitle.parentNode.insertBefore(this._pageTitleInput,this._pageTitle);this._pageTitleInput.focus();window.setTimeout(BX.delegate(function(){BX.bind(document,"click",this._pageTitleExternalClickHandler);BX.bind(this._pageTitleInput,"keyup",this._pageTitleKeyPressHandler)},this),300)}else{if(this._pageTitleInput){this._pageTitleInput=BX.remove(this._pageTitleInput)}this._pageTitle.innerHTML=BX.util.htmlspecialchars(this._model.getCaption());this._pageTitle.style.display="";if(this._buttonWrapper){this._buttonWrapper.style.display=""}BX.unbind(document,"click",this._pageTitleExternalClickHandler);BX.unbind(this._pageTitleInput,"keyup",this._pageTitleKeyPressHandler);this.adjustTitle()}},adjustTitle:function(){if(!this._enablePageTitleContols){return}if(!this._buttonWrapper){return}var t=this._model.getCaption().trim();var e="";document.title=t;if(BX.getClass("BX.SidePanel.Instance.updateBrowserTitle")){BX.SidePanel.Instance.updateBrowserTitle()}var i=t.match(/\s+\S+\s*$/);if(i){e=t.substr(i["index"]);t=t.substr(0,i["index"])}else{e=t;t=""}BX.cleanNode(this._buttonWrapper);if(e!==""){this._buttonWrapper.appendChild(document.createTextNode(e))}if(this._editPageTitleButton){this._buttonWrapper.appendChild(this._editPageTitleButton)}if(this._copyPageUrlButton){this._buttonWrapper.appendChild(this._copyPageUrlButton)}this._pageTitle.innerHTML=BX.util.htmlspecialchars(t)},adjustSize:function(){if(!this._enablePageTitleContols){return}if(!this._pageTitle){return}var t=this._pageTitle.parentNode?this._pageTitle.parentNode:this._pageTitle;var e=t.offsetWidth<=480&&this._model.getCaption().length>=40;if(e&&!BX.hasClass(t,"pagetitle-narrow")){BX.addClass(t,"pagetitle-narrow")}else if(!e&&BX.hasClass(t,"pagetitle-narrow")){BX.removeClass(t,"pagetitle-narrow")}},adjustButtons:function(){if(this._config.isScopeToggleEnabled()&&!this._enableBottomPanel&&this._controls.length>0){this._controls[this._controls.length-1].ensureButtonPanelWrapperCreated().appendChild(BX.create("span",{props:{className:this._config.getScope()===BX.Crm.EntityConfigScope.common?"crm-entity-card-common":"crm-entity-card-private"},events:{click:BX.delegate(this.onConfigMenuButtonClick,this)}}))}},showToolPanel:function(){if(!this._toolPanel||this._toolPanel.isVisible()){return}this._toolPanel.setVisible(true);if(this._parentContainer){this._parentContainer.style.paddingBottom="50px";document.body.style.paddingBottom="60px";document.body.style.height="auto"}},hideToolPanel:function(){if(!this._toolPanel||!this._toolPanel.isVisible()){return}this._toolPanel.setVisible(false);if(this._parentContainer){this._parentContainer.style.paddingBottom="";document.body.style.paddingBottom="";document.body.style.height=""}},showMessageDialog:function(t,e,i){var n=BX.Crm.EditorAuxiliaryDialog.create(t,{title:e,content:i,buttons:[{id:"continue",type:BX.Crm.DialogButtonType.accept,text:BX.message("CRM_EDITOR_CONTINUE"),callback:function(t){t.getDialog().close()}}]});n.open()},addModeChangeListener:function(t){this._modeChangeNotifier.addListener(t)},removeModeChangeListener:function(t){this._modeChangeNotifier.removeListener(t)},addControlChangeListener:function(t){this._controlChangeNotifier.addListener(t)},removeControlChangeListener:function(t){this._controlChangeNotifier.removeListener(t)},getMessage:function(t){var e=BX.Crm.EntityEditor.messages;return e.hasOwnProperty(t)?e[t]:t},getFormElement:function(){return this._formElement},isChanged:function(){return this._isNew||this.hasChangedControls()||this.hasChangedControllers()},savePageTitle:function(){if(!this._pageTitleInput){return}var t=BX.util.trim(this._pageTitleInput.value);if(t===""){return}this._model.setCaption(t);var e={ACTION:"SAVE",ACTION_ENTITY_ID:this._entityId,ACTION_ENTITY_TYPE:BX.CrmEntityType.resolveAbbreviation(BX.CrmEntityType.resolveName(this._entityTypeId)),PARAMS:BX.prop.getObject(this._context,"PARAMS",{})};this._model.prepareCaptionData(e);for(var i=0,n=this._controllers.length;i<n;i++){e=this._controllers[i].onBeforesSaveControl(e)}BX.ajax({url:this._serviceUrl,method:"POST",dataType:"json",data:e,onsuccess:BX.delegate(this.onSaveSuccess,this)})},saveChanged:function(){if(!this._isNew&&!this.hasChangedControls()&&!this.hasChangedControllers()&&!this.isWaitingForInput()){this._modeSwitch.reset();this.releaseActiveControls();this.refreshLayout({reset:true});this.hideToolPanel()}else{this._modeSwitch.reset();this._modeSwitch.getQueue().addBatch(this._activeControls,BX.Crm.EntityEditorMode.view);this._modeSwitch.run()}},saveDelayed:function(t){if(typeof t==="undefined"){t=0}if(this._delayedSaveHandle>0){window.clearTimeout(this._delayedSaveHandle)}this._delayedSaveHandle=window.setTimeout(BX.delegate(this.save,this),t)},save:function(){if(this._toolPanel){this._toolPanel.setLocked(true)}var t=BX.Crm.EntityValidationResult.create();this.validate(t).then(BX.delegate(function(){if(this._bizprocManager){return this._bizprocManager.onBeforeSave(t)}var e=new BX.Promise;window.setTimeout(function(){e.fulfill()},0);return e},this)).then(BX.delegate(function(){if(t.getStatus()){this.innerSave();if(this._bizprocManager){this._bizprocManager.onAfterSave()}}else{if(this.isVisible()){var e=t.getTopmostField();if(e){e.focus()}}if(this._toolPanel){this._toolPanel.setLocked(false)}BX.onCustomEvent(window,"BX.Crm.EntityEditor:onFailedValidation",[this,t])}},this));if(this._delayedSaveHandle>0){this._delayedSaveHandle=0}},saveControl:function(t){if(this._entityId<=0){return}var e=BX.Crm.EntityValidationResult.create();t.validate(e);if(!e.getStatus()){return}var i={ACTION:"SAVE",ACTION_ENTITY_ID:this._entityId,ACTION_ENTITY_TYPE:BX.CrmEntityType.resolveAbbreviation(BX.CrmEntityType.resolveName(this._entityTypeId))};i=BX.mergeEx(i,this._context);t.save();t.prepareSaveData(i);for(var n=0,r=this._controllers.length;n<r;n++){i=this._controllers[n].onBeforesSaveControl(i)}BX.ajax({method:"POST",dataType:"json",url:this._serviceUrl,data:i,onsuccess:BX.delegate(this.onSaveSuccess,this)})},saveData:function(t){if(this._entityId<=0){return}t=BX.mergeEx(t,this._context);t=BX.mergeEx(t,{ACTION:"SAVE",ACTION_ENTITY_ID:this._entityId,ACTION_ENTITY_TYPE:BX.CrmEntityType.resolveAbbreviation(BX.CrmEntityType.resolveName(this._entityTypeId))});BX.ajax({method:"POST",dataType:"json",url:this._serviceUrl,data:t,onsuccess:BX.delegate(this.onSaveSuccess,this)})},validate:function(t){for(var e=0,i=this._activeControls.length;e<i;e++){this._activeControls[e].validate(t)}var n=new BX.Promise;this._userFieldManager.validate(t).then(BX.delegate(function(){n.fulfill()},this));return n},isRequestRunning:function(){return this._isRequestRunning},innerSave:function(){if(this._isRequestRunning){return}var t,e;for(t=0,e=this._controllers.length;t<e;t++){this._controllers[t].onBeforeSubmit()}for(t=0,e=this._activeControls.length;t<e;t++){var i=this._activeControls[t];i.save();i.onBeforeSubmit();if(i.isSchemeChanged()){this._config.updateSchemeElement(i.getSchemeElement())}}if(this._areAvailableSchemeElementsChanged){this._scheme.setAvailableElements(this._availableSchemeElements);this._areAvailableSchemeElementsChanged=false}if(this._config&&this._config.isChanged()){this._config.save(false)}var n={id:this._id,externalContext:this._externalContextId,context:this._contextId,entityTypeId:this._entityTypeId,entityId:this._entityId,model:this._model,cancel:false};BX.onCustomEvent(window,"BX.Crm.EntityEditor:onSave",[this,n]);var r=BX.prop.getBoolean(n,"enableCloseConfirmation",null);if(BX.type.isBoolean(r)){this._enableCloseConfirmation=r}if(n["cancel"]){return}if(this._ajaxForm){var o=this.getDetailManager();if(o){var s=o.prepareAnalyticParams(this._entityId>0?"update":"create",{embedded:this.isEmbedded()?"Y":"N"});if(s){this._ajaxForm.addUrlParams(s)}}this._ajaxForm.submit()}},cancel:function(){var t={id:this._id,externalContext:this._externalContextId,context:this._contextId,entityTypeId:this._entityTypeId,entityId:this._entityId,model:this._model,cancel:false};BX.onCustomEvent(window,"BX.Crm.EntityEditor:onCancel",[this,t]);var e=BX.prop.getBoolean(t,"enableCloseConfirmation",null);if(BX.type.isBoolean(e)){this._enableCloseConfirmation=e}if(t["cancel"]){return}if(this.hasChangedControls()||this.hasChangedControllers()){window.setTimeout(BX.delegate(this.openCancellationConfirmationDialog,this),250);return}this.innerCancel()},innerCancel:function(){var t,e;for(t=0,e=this._controllers.length;t<e;t++){this._controllers[t].innerCancel()}this.rollback();if(this._isNew){this.refreshLayout();if(typeof top.BX.SidePanel!=="undefined"){this._enableCloseConfirmation=false;window.setTimeout(function(){var t=top.BX.SidePanel.Instance.getSliderByWindow(window);if(t&&t.isOpen()){t.close(false)}},250)}}else{this.switchToViewMode({refreshLayout:false});this.refreshLayout()}},openCancellationConfirmationDialog:function(){BX.Crm.EditorAuxiliaryDialog.create("cancel_confirmation",{title:BX.message("CRM_EDITOR_CONFIRMATION"),content:BX.message("CRM_EDITOR_CANCEL_CONFIRMATION"),buttons:[{id:"yes",type:BX.Crm.DialogButtonType.accept,text:BX.message("CRM_EDITOR_YES"),callback:this._cancelConfirmationHandler},{id:"no",type:BX.Crm.DialogButtonType.cancel,text:BX.message("CRM_EDITOR_NO"),callback:this._cancelConfirmationHandler}]}).open()},rollback:function(){this._model.rollback();var t,e;for(t=0,e=this._controllers.length;t<e;t++){this._controllers[t].rollback()}for(t=0,e=this._activeControls.length;t<e;t++){this._activeControls[t].rollback()}if(this._areAvailableSchemeElementsChanged){this._availableSchemeElements=this._scheme.getAvailableElements();this._areAvailableSchemeElementsChanged=false}},addSchemeElementAt:function(t,e){if(this._config){this._config.addSchemeElementAt(t,e)}},updateSchemeElement:function(t){if(this._config){this._config.updateSchemeElement(t)}},removeSchemeElement:function(t){if(this._config){this._config.removeSchemeElement(t)}},canChangeScheme:function(){return this._config&&this._config.isChangeable()},isSchemeChanged:function(){return this._config&&this._config.isChanged()},saveScheme:function(){return this._config&&this._config.save(false)},saveSchemeChanges:function(){this.commitSchemeChanges();return this._config&&this._config.save(false)},commitSchemeChanges:function(){for(var t=0,e=this._controls.length;t<e;t++){this._controls[t].commitSchemeChanges()}if(this._areAvailableSchemeElementsChanged){this._scheme.setAvailableElements(this._availableSchemeElements);this._areAvailableSchemeElementsChanged=false}},onSaveSuccess:function(t){this._isRequestRunning=false;if(this._enableCloseConfirmation){this._enableCloseConfirmation=false}if(this._toolPanel){this._toolPanel.setLocked(false);this._toolPanel.clearErrors()}var e=BX.prop.getObject(t,"EVENT_PARAMS",{});e["entityTypeId"]=this._entityTypeId;var i=BX.prop.getObject(t,"ENTITY_INFO",null);if(i){e["entityInfo"]=i}var n=BX.Crm.Page.getTopSlider();if(n){e["sliderUrl"]=n.getUrl()}var r=BX.prop.getObject(t,"CHECK_ERRORS",null);var o=BX.prop.getString(t,"ERROR","");if(r||o!==""){if(r){var s=null;var a=[];for(var l in r){if(!r.hasOwnProperty(l)){return}var d=this.getActiveControlById(l,true);if(d){d.showError(r[l]);if(!s){s=d}}else{a.push(r[l])}}if(s){s.scrollAnimate()}o=a.join("<br/>")}if(o!==""&&this._toolPanel){this._toolPanel.addError(o)}e["checkErrors"]=r;e["error"]=o;if(this._isNew){BX.onCustomEvent(window,"onCrmEntityCreateError",[e])}else{e["entityId"]=this._entityId;BX.onCustomEvent(window,"onCrmEntityUpdateError",[e])}this.releaseAjaxForm();this.initializeAjaxForm();return}var h=BX.prop.getObject(t,"ENTITY_DATA",null);e["entityData"]=h;e["isCancelled"]=false;if(this._isNew){this._entityId=BX.prop.getInteger(t,"ENTITY_ID",0);if(this._entityId<=0){if(this._toolPanel){this._toolPanel.addError(this.getMessage("couldNotFindEntityIdError"))}return}BX.Crm.EntityEvent.fireCreate(this._entityTypeId,this._entityId,this._externalContextId,e);e["sender"]=this;e["entityId"]=this._entityId;BX.onCustomEvent(window,"onCrmEntityCreate",[e]);if(BX.prop.getBoolean(e,"isCancelled",true)){this._entityId=0;this.rollback();this.releaseAjaxForm();this.initializeAjaxForm();return}this._isNew=false}else{BX.Crm.EntityEvent.fireUpdate(this._entityTypeId,this._entityId,this._externalContextId,e);e["sender"]=this;e["entityId"]=this._entityId;BX.onCustomEvent(window,"onCrmEntityUpdate",[e]);if(BX.prop.getBoolean(e,"isCancelled",true)){this.rollback();this.releaseAjaxForm();this.initializeAjaxForm();return}}var p=BX.prop.getString(t,"REDIRECT_URL","");var u=BX.prop.getObject(t,"EVENT_PARAMS",null);if(u){var c=BX.prop.getString(u,"name","");var m=BX.prop.getObject(u,"args",null);if(c!==""&&m!==null){if(p!==""){m["redirectUrl"]=p}BX.localStorage.set(c,m,10)}}if(this._isReleased){return}if(p!==""&&!this._isEmbedded){window.location.replace(BX.util.add_url_param(p,{IFRAME:"Y",IFRAME_TYPE:"SIDE_SLIDER"}))}else{if(BX.type.isPlainObject(h)){this._model.setData(h,{enableNotification:false})}this.adjustTitle();this.adjustSize();this.releaseAjaxForm();this.initializeAjaxForm();for(var y=0,g=this._controllers.length;y<g;y++){this._controllers[y].onAfterSave()}if(this._modeSwitch.isRunning()){this._modeSwitch.complete()}else{this.switchToViewMode({refreshLayout:false})}this.refreshLayout({reset:true});this.hideToolPanel()}},formatMoney:function(t,e,i){BX.ajax({url:BX.prop.getString(this._settings,"serviceUrl",""),method:"POST",dataType:"json",data:{ACTION:"GET_FORMATTED_SUM",CURRENCY_ID:e,SUM:t},onsuccess:i})},findOption:function(t,e){for(var i=0,n=e.length;i<n;i++){if(t===e[i].VALUE){return e[i].NAME}}return t},prepareConfigMenuItems:function(){var t=[];var e=BX.delegate(this.onMenuItemClick,this);t.push({id:"switchToPersonalConfig",text:this.getMessage("switchToPersonalConfig"),onclick:e,className:this._config.getScope()===BX.Crm.EntityConfigScope.personal?"menu-popup-item-accept":"menu-popup-item-none"});t.push({id:"switchToCommonConfig",text:this.getMessage("switchToCommonConfig"),onclick:e,className:this._config.getScope()===BX.Crm.EntityConfigScope.common?"menu-popup-item-accept":"menu-popup-item-none"});if(this.canChangeScheme()){t.push({delimiter:true});t.push({id:"resetConfig",text:this.getMessage("resetConfig"),onclick:e,className:"menu-popup-item-none"});if(BX.prop.getBoolean(this._settings,"enableSettingsForAll",false)){t.push({id:"forceCommonConfigForAllUsers",text:this.getMessage("forceCommonConfigForAllUsers"),onclick:e,className:"menu-popup-item-none"})}}return t},getServiceUrl:function(){return this._serviceUrl},loadCustomHtml:function(t,e,i){e["ACTION"]=t;e["ACTION_ENTITY_ID"]=this._entityId;BX.ajax({url:this._serviceUrl,method:"POST",dataType:"html",data:e,onsuccess:i})},onAfterFormSubmit:function(t,e){this._isRequestRunning=true;if(this._toolPanel){this._toolPanel.setLocked(true)}},onCancelFormSubmit:function(t,e){this._isRequestRunning=false;if(this._toolPanel){this._toolPanel.setLocked(false)}},isDuplicateControlEnabled:function(){return this._dupControlManager.isEnabled()},getDuplicateManager:function(){return this._dupControlManager},onResize:function(t){this.adjustSize()},onPageTileClick:function(t){if(this._readOnly){return}if(this.isChanged()){this.showMessageDialog("titleEditDenied",this.getMessage("titleEdit"),this.getMessage("titleEditUnsavedChanges"));return}this.switchTitleMode(BX.Crm.EntityEditorMode.edit)},onCreateSectionButtonClick:function(t){if(!this.isSectionCreationEnabled()){return}var e=this.getControlCount();var i="user_"+BX.util.getRandomString(8).toLowerCase();var n=BX.Crm.EntitySchemeElement.create({type:"section",name:i,title:this.getMessage("newSectionTitle")});this.addSchemeElementAt(n,e);var r=this.createControl("section",i,{schemeElement:n,model:this._model,container:this._formElement});this.addControlAt(r,e);this.saveScheme();r.setMode(BX.Crm.EntityEditorMode.edit,{notify:false});r.refreshLayout();r.setTitleMode(BX.Crm.EntityEditorMode.edit);this.registerActiveControl(r)},onConfigMenuButtonClick:function(t){if(this._isConfigMenuShown){return}var e=this.prepareConfigMenuItems();if(e.length>0){BX.PopupMenu.show(this._id+"_config_menu",BX.getEventTarget(t),e,{angle:false,autoHide:true,closeByEsc:true,events:{onPopupShow:function(){this._isConfigMenuShown=true}.bind(this),onPopupClose:function(){BX.PopupMenu.destroy(this._id+"_config_menu")}.bind(this),onPopupDestroy:function(){this._isConfigMenuShown=false}.bind(this)}})}},onPageTitleExternalClick:function(t){var e=BX.getEventTarget(t);if(e!==this._pageTitleInput){this.savePageTitle();this.switchTitleMode(BX.Crm.EntityEditorMode.view)}},onPageTitleKeyPress:function(t){var e=t.keyCode;if(e===13){this.savePageTitle();this.switchTitleMode(BX.Crm.EntityEditorMode.view)}else if(e===27){this.switchTitleMode(BX.Crm.EntityEditorMode.view)}},onInterfaceToolbarMenuBuild:function(t,e){var i=BX.prop.getArray(e,"items",null);if(!i){return}var n=this.prepareConfigMenuItems();if(n.length>0){if(i.length>0){i.push({delimiter:true})}for(var r=0,o=n.length;r<o;r++){i.push(n[r])}}},onMenuItemClick:function(t,e){var i=BX.prop.getString(e,"id","");if(i==="resetConfig"){this.resetConfig()}else if(i==="switchToPersonalConfig"){this.setConfigScope(BX.Crm.EntityConfigScope.personal)}else if(i==="switchToCommonConfig"){this.setConfigScope(BX.Crm.EntityConfigScope.common)}else if(i==="forceCommonConfigForAllUsers"){this.forceCommonConfigScopeForAll()}if(e.menuWindow){e.menuWindow.close()}},setConfigScope:function(t){if(this._config.getScope()===t){return}this._config.setScope(t).then(function(){var e={id:this._id,scope:t,enableReload:true};BX.onCustomEvent(window,"BX.Crm.EntityEditor:onConfigScopeChange",[this,e]);if(e["enableReload"]&&!this._isEmbedded){window.location.reload(true)}}.bind(this))},forceCommonConfigScopeForAll:function(){this._config.forceCommonScopeForAll().then(function(){var t=this._config.getScope();var e={id:this._id,scope:t,enableReload:true};BX.onCustomEvent(window,"BX.Crm.EntityEditor:onForceCommonConfigScopeForAll",[this,e]);if(e["enableReload"]&&!this._isEmbedded&&t!==BX.Crm.EntityConfigScope.common){window.location.reload(true)}}.bind(this))},resetConfig:function(){this._config.reset(false).then(function(){var t=this._config.getScope();var e={id:this._id,scope:t,enableReload:true};BX.onCustomEvent(window,"BX.Crm.EntityEditor:onConfigReset",[this,e]);if(e["enableReload"]&&!this._isEmbedded){window.location.reload(true)}}.bind(this))},getConfigOption:function(t,e){return this._config.getOption(t,e)},setConfigOption:function(t,e){return this._config.setOption(t,e)},getAttributeManagerSettings:function(){return BX.prop.getObject(this._settings,"attributeConfig",null)},getOption:function(t,e){return BX.prop.getString(this._settings["options"],t,e)},setOption:function(t,e){if(typeof e==="undefined"||e===null){return}if(BX.prop.getString(this._settings["options"],t,null)===e){return}this._settings["options"][t]=e},getDragConfig:function(t){return BX.prop.getObject(this._dragConfig,t,{})},hasPlaceHolder:function(){return!!this._dragPlaceHolder},createPlaceHolder:function(t){var e=this.getControlCount();if(t<0||t>e){t=e>0?e:0}if(this._dragPlaceHolder){if(this._dragPlaceHolder.getIndex()===t){return this._dragPlaceHolder}this._dragPlaceHolder.clearLayout();this._dragPlaceHolder=null}this._dragPlaceHolder=BX.Crm.EditorDragSectionPlaceholder.create({container:this._formElement,anchor:t<e?this._controls[t].getWrapper():null,index:t});this._dragPlaceHolder.layout();return this._dragPlaceHolder},getPlaceHolder:function(){return this._dragPlaceHolder},removePlaceHolder:function(){if(this._dragPlaceHolder){this._dragPlaceHolder.clearLayout();this._dragPlaceHolder=null}},processDraggedItemDrop:function(t,e){var i=t.getCharge();if(!(i instanceof BX.Crm.EditorSectionDragContainer&&i.getEditor()===this)){return}var n=e.getContextData();var r=BX.type.isNotEmptyString(n["contextId"])?n["contextId"]:"";if(r!==BX.Crm.EditorSectionDragItem.contextId){return}var o=typeof n["charge"]!=="undefined"?n["charge"]:null;if(!(o instanceof BX.Crm.EditorSectionDragItem)){return}var s=o.getControl();if(!s){return}var a=this.getControlIndex(s);if(a<0){return}var l=this.getPlaceHolder();var d=l?l.getIndex():-1;if(d<0){return}var h=d<=a?d:d-1;if(h!==a){this.moveControl(s,h);this.saveScheme()}},onDrop:function(t,e,i,n){this.processDraggedItemDrop(t,e)},canCreateContact:function(){return BX.prop.getBoolean(this._settings,"canCreateContact",false)},canCreateCompany:function(){return BX.prop.getBoolean(this._settings,"canCreateCompany",false)},addHelpLink:function(t){if(!this._helpWrapper){this._helpWrapper=BX.create("DIV",{props:{className:"crm-entity-card-widget-help"}});this._container.append(this._helpWrapper);var e=BX.create("A",{props:{className:"crm-entity-card-widget-help-link"},text:BX.prop.getString(t,"text","For Your information")});var i=BX.prop.getString(t,"url","");if(i!==""){e.href=helpUrl;e.target="_blank"}else{e.href="#";BX.bind(e,"click",function(e){window.top.BX.Helper.show("redirect=detail&code="+BX.prop.getString(t,"code",""));e.preventDefault()})}this._helpWrapper.appendChild(e)}},getConfigScope:function(){return this._config.getScope()}};BX.Crm.EntityEditor.defaultInstance=null;BX.Crm.EntityEditor.items={};BX.Crm.EntityEditor.get=function(t){return this.items.hasOwnProperty(t)?this.items[t]:null};if(typeof BX.Crm.EntityEditor.messages==="undefined"){BX.Crm.EntityEditor.messages={}}BX.Crm.EntityEditor.setDefault=function(t){BX.Crm.EntityEditor.defaultInstance=t};BX.Crm.EntityEditor.getDefault=function(){return BX.Crm.EntityEditor.defaultInstance};BX.Crm.EntityEditor.create=function(t,e){var i=new BX.Crm.EntityEditor;i.initialize(t,e);this.items[i.getId()]=i;return i}}if(typeof BX.Crm.EntityEditorModeQueue==="undefined"){BX.Crm.EntityEditorModeQueue=function(){this._id="";this._settings={};this._items=[]};BX.Crm.EntityEditorModeQueue.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{}},findIndex:function(t){for(var e=0,i=this._items.length;e<i;e++){if(this._items[e]["control"]===t){return e}}return-1},getLength:function(){return this._items.length},add:function(t,e,i){if(typeof i==="undefined"){i=BX.Crm.EntityEditorModeOptions.none}var n=this.findIndex(t);if(n>=0){this._items[n]={control:t,mode:e,options:i}}else{this._items.push({control:t,mode:e,options:i})}},addBatch:function(t,e,i){for(var n=0,r=t.length;n<r;n++){this.add(t[n],e,i)}},remove:function(t){var e=this.findIndex(t);if(e>=0){this._items.splice(e,1)}},clear:function(){this._items=[]},process:function(){var t=this._items.length;if(t===0){return 0}for(var e=0;e<t;e++){var i=this._items[e];i["control"].setMode(i["mode"],{options:i["options"],notify:true})}return t}};BX.Crm.EntityEditorModeQueue.create=function(t,e){var i=new BX.Crm.EntityEditorModeQueue;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorModeSwitch==="undefined"){BX.Crm.EntityEditorModeSwitch=function(){this._id="";this._settings={};this._queue=null;this._isRunning=false;this._runHandle=0};BX.Crm.EntityEditorModeSwitch.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._editor=BX.prop.get(this._settings,"editor");this._queue=BX.Crm.EntityEditorModeQueue.create(this._id,{})},getQueue:function(){return this._queue},reset:function(){this._queue.clear();this._isRunning=false},isRunning:function(){return this._isRunning},run:function(){if(this._isRunning){return}if(this._runHandle>0){window.clearTimeout(this._runHandle)}this._runHandle=window.setTimeout(BX.delegate(this.doRun,this),50)},doRun:function(){this._editor.saveDelayed();this._isRunning=true;this._runHandle=0},complete:function(){this._queue.process();this.reset()}};BX.Crm.EntityEditorModeSwitch.create=function(t,e){var i=new BX.Crm.EntityEditorModeSwitch;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorMode==="undefined"){BX.Crm.EntityEditorMode={intermediate:0,edit:1,view:2,names:{view:"view",edit:"edit"},getName:function(t){if(t===this.edit){return this.names.edit}else if(t===this.view){return this.names.view}return""},parse:function(t){t=t.toLowerCase();if(t===this.names.edit){return this.edit}else if(t===this.names.view){return this.view}return this.intermediate}}}if(typeof BX.Crm.EntityEditorModeOptions==="undefined"){BX.Crm.EntityEditorModeOptions={none:0,exclusive:1,individual:2,saveOnExit:64,check:function(t,e){return(t&e)===e}}}if(typeof BX.Crm.EntityEditorControlOptions==="undefined"){BX.Crm.EntityEditorControlOptions={none:0,showAlways:1,check:function(t,e){return(t&e)===e}}}if(typeof BX.Crm.EntityEditorPriority==="undefined"){BX.Crm.EntityEditorPriority={undefined:0,normal:1,high:2}}if(typeof BX.Crm.EntityEditorModeSwitchType==="undefined"){BX.Crm.EntityEditorModeSwitchType={none:0,common:1,button:2,content:4,check:function(t,e){return(t&e)===e}}}if(typeof BX.Crm.EditorDialogButton==="undefined"){BX.Crm.EditorDialogButton=function(){this._id="";this._type=BX.Crm.DialogButtonType.undefined;this._settings={};this._dialog=null;this._keyPressHandler=BX.delegate(this.onKeyPress,this)};BX.Crm.EditorDialogButton.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._type=BX.prop.getInteger(this._settings,"type",BX.Crm.DialogButtonType.undefined);this._dialog=BX.prop.get(this._settings,"dialog",null)},bind:function(){if(this._type===BX.Crm.DialogButtonType.accept){BX.bind(document,"keydown",this._keyPressHandler)}},unbind:function(){if(this._type===BX.Crm.DialogButtonType.accept){BX.unbind(document,"keydown",this._keyPressHandler)}},onKeyPress:function(t){if(this._type!==BX.Crm.DialogButtonType.accept){return}t=t||window.event;if(t.keyCode===13){this.onClick(t)}},getId:function(){return this._id},getDialog:function(){return this._dialog},prepareContent:function(){if(this._type===BX.Crm.DialogButtonType.accept){return new BX.UI.SaveButton({text:BX.prop.getString(this._settings,"text",this._id),events:{click:BX.delegate(this.onClick,this)}})}else if(this._type===BX.Crm.DialogButtonType.cancel){return new BX.UI.CancelButton({text:BX.prop.getString(this._settings,"text",this._id),events:{click:BX.delegate(this.onClick,this)}})}else{return new BX.UI.Button({text:BX.prop.getString(this._settings,"text",this._id),events:{click:BX.delegate(this.onClick,this)}})}},onClick:function(t){var e=BX.prop.getFunction(this._settings,"callback",null);if(e){e(this)}}};BX.Crm.EditorDialogButton.create=function(t,e){var i=new BX.Crm.EditorDialogButton;i.initialize(t,e);return i}}if(typeof BX.Crm.EditorAuxiliaryDialog==="undefined"){BX.Crm.EditorAuxiliaryDialog=function(){this._id="";this._settings={};this._popup=null;this._buttons=null};BX.Crm.EditorAuxiliaryDialog.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{}},getSetting:function(t,e){return BX.prop.get(this._settings,t,e)},getId:function(){return this._id},open:function(){this._popup=new BX.PopupWindow(this._id,BX.prop.getElementNode(this._settings,"anchor",null),{autoHide:false,draggable:false,closeByEsc:true,offsetLeft:0,offsetTop:0,zIndex:BX.prop.getInteger(this._settings,"zIndex",0),bindOptions:{forceBindPosition:true},titleBar:BX.prop.getString(this._settings,"title","No title"),content:BX.prop.getString(this._settings,"content",""),buttons:this.prepareButtons(),events:{onPopupShow:BX.delegate(this.onPopupShow,this),onPopupClose:BX.delegate(this.onPopupClose,this),onPopupDestroy:BX.delegate(this.onPopupDestroy,this)}});this._popup.show()},close:function(){if(this._popup){this._popup.close()}},isOpen:function(){return this._popup&&this._popup.isShown()},prepareButtons:function(){var t=[];this._buttons=[];var e=BX.prop.getArray(this._settings,"buttons",[]);for(var i=0,n=e.length;i<n;i++){var r=e[i];r["dialog"]=this;var o=BX.Crm.EditorDialogButton.create(BX.prop.getString(r,"id",""),r);this._buttons.push(o);t.push(o.prepareContent())}return t},bind:function(){for(var t=0,e=this._buttons.length;t<e;t++){this._buttons[t].bind()}},unbind:function(){for(var t=0,e=this._buttons.length;t<e;t++){this._buttons[t].unbind()}},onPopupShow:function(){this.bind()},onPopupClose:function(){this.unbind();if(this._popup){this._popup.destroy()}},onPopupDestroy:function(){if(this._popup){this._popup=null}delete BX.Crm.EditorAuxiliaryDialog.items[this.getId()]}};BX.Crm.EditorAuxiliaryDialog.items={};BX.Crm.EditorAuxiliaryDialog.isItemOpened=function(t){return this.items.hasOwnProperty(t)&&this.items[t].isOpen()};BX.Crm.EditorAuxiliaryDialog.hasOpenItems=function(){for(var t in this.items){if(!this.items.hasOwnProperty(t)){continue}if(this.items[t].isOpen()){return true}}return false};BX.Crm.EditorAuxiliaryDialog.create=function(t,e){var i=new BX.Crm.EditorAuxiliaryDialog;i.initialize(t,e);this.items[i.getId()]=i;return i}}if(typeof BX.Crm.EditorFileStorageType==="undefined"){BX.Crm.EditorFileStorageType={undefined:0,file:1,webdav:2,diskfile:3}}if(typeof BX.Crm.EntityValidator==="undefined"){BX.Crm.EntityValidator=function(){this._settings={};this._editor=null;this._data=null};BX.Crm.EntityValidator.prototype={initialize:function(t){this._settings=t?t:{};this._editor=BX.prop.get(this._settings,"editor",null);this._data=BX.prop.getObject(this._settings,"data",{});this.doInitialize()},doInitialize:function(){},release:function(){},getData:function(){return this._data},getDataStringParam:function(t,e){return BX.prop.getString(this._data,t,e)},getErrorMessage:function(){return BX.prop.getString(this._settings,"message","")},validate:function(t){return true},processControlChange:function(t){}}}if(typeof BX.Crm.EntityPersonValidator==="undefined"){BX.Crm.EntityPersonValidator=function(){BX.Crm.EntityPersonValidator.superclass.constructor.apply(this)};BX.extend(BX.Crm.EntityPersonValidator,BX.Crm.EntityValidator);BX.Crm.EntityPersonValidator.prototype.doInitialize=function(){this._nameField=this._editor.getControlById(this.getDataStringParam("nameField",""));if(this._nameField){this._nameField.addValidator(this)}this._lastNameField=this._editor.getControlById(this.getDataStringParam("lastNameField",""));if(this._lastNameField){this._lastNameField.addValidator(this)}};BX.Crm.EntityPersonValidator.prototype.release=function(){if(this._nameField){this._nameField.removeValidator(this)}if(this._lastNameField){this._lastNameField.removeValidator(this)}};BX.Crm.EntityPersonValidator.prototype.validate=function(t){var e=this._nameField.isActive();var i=this._lastNameField.isActive();if(!e&&!i){return true}var n=e?this._nameField.getRuntimeValue():this._nameField.getValue();var r=i?this._lastNameField.getRuntimeValue():this._lastNameField.getValue();if(n!==""||r!==""){return true}if(n===""&&e){t.addError(BX.Crm.EntityValidationError.create({field:this._nameField}));this._nameField.showError(this.getErrorMessage())}if(r===""&&i){t.addError(BX.Crm.EntityValidationError.create({field:this._lastNameField}));this._lastNameField.showError(this.getErrorMessage())}return false};BX.Crm.EntityPersonValidator.prototype.processFieldChange=function(t){if(t!==this._nameField&&t!==this._lastNameField){return}if(this._nameField){this._nameField.clearError()}if(this._lastNameField){this._lastNameField.clearError()}};BX.Crm.EntityPersonValidator.create=function(t){var e=new BX.Crm.EntityPersonValidator;e.initialize(t);return e}}if(typeof BX.Crm.EntityValidationError==="undefined"){BX.Crm.EntityValidationError=function(){this._settings={};this._field=null;this._message=""};BX.Crm.EntityValidationError.prototype={initialize:function(t){this._settings=t?t:{};this._field=BX.prop.get(this._settings,"field",null);this._message=BX.prop.getString(this._settings,"message","")},getField:function(){return this._field},getMessage:function(){return this._message}};BX.Crm.EntityValidationError.create=function(t){var e=new BX.Crm.EntityValidationError;e.initialize(t);return e}}if(typeof BX.Crm.EntityValidationResult==="undefined"){BX.Crm.EntityValidationResult=function(){this._settings={};this._errors=[]};BX.Crm.EntityValidationResult.prototype={initialize:function(t){this._settings=t?t:{}},getStatus:function(){return this._errors.length===0},addError:function(t){this._errors.push(t)},getErrors:function(){return this._errors},addResult:function(t){var e=t.getErrors();for(var i=0,n=e.length;i<n;i++){this._errors.push(e[i])}},getTopmostField:function(){var t=null;var e=null;for(var i=0,n=this._errors.length;i<n;i++){var r=this._errors[i].getField();if(!t){t=r;e=r.getPosition()["top"];continue}var o=r.getPosition();if(!o){continue}var s=r.getPosition()["top"];if(s<e){t=r;e=s}}return t}};BX.Crm.EntityValidationResult.create=function(t){var e=new BX.Crm.EntityValidationResult;e.initialize(t);return e}}if(typeof BX.Crm.EntityConfigScope==="undefined"){BX.Crm.EntityConfigScope={undefined:"",personal:"P",common:"C"};if(typeof BX.Crm.EntityConfigScope.captions==="undefined"){BX.Crm.EntityConfigScope.captions={}}BX.Crm.EntityConfigScope.setCaptions=function(t){if(BX.type.isPlainObject(t)){this.captions=t}};BX.Crm.EntityConfigScope.getCaption=function(t){return BX.prop.getString(this.captions,t,t)}}if(typeof BX.Crm.EntityConfig==="undefined"){BX.Crm.EntityConfig=function(){this._id="";this._settings={};this._scope=BX.Crm.EntityConfigScope.undefined;this._enableScopeToggle=true;this._canUpdatePersonalConfiguration=true;this._canUpdateCommonConfiguration=false;this._data={};this._items=[];this._options={};this._serviceUrl="";this._isChanged=false};BX.Crm.EntityConfig.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._scope=BX.prop.getString(this._settings,"scope",BX.Crm.EntityConfigScope.personal);this._enableScopeToggle=BX.prop.getBoolean(this._settings,"enableScopeToggle",true);this._canUpdatePersonalConfiguration=BX.prop.getBoolean(this._settings,"canUpdatePersonalConfiguration",true);this._canUpdateCommonConfiguration=BX.prop.getBoolean(this._settings,"canUpdateCommonConfiguration",false);this._data=BX.prop.getArray(this._settings,"data",[]);this._items=[];for(var i=0,n=this._data.length;i<n;i++){var r=this._data[i];var o=BX.prop.getString(r,"type","");if(o==="section"){this._items.push(BX.Crm.EntityConfigSection.create({data:r}))}else{this._items.push(BX.Crm.EntityConfigField.create({data:r}))}}this._options=BX.prop.getObject(this._settings,"options",{});this._serviceUrl=BX.prop.getString(this._settings,"serviceUrl","")},findItemByName:function(t){for(var e=0,i=this._items.length;e<i;e++){var n=this._items[e];if(n.getName()===t){return n}}return null},findItemIndexByName:function(t){for(var e=0,i=this._items.length;e<i;e++){var n=this._items[e];if(n.getName()===t){return e}}return-1},toJSON:function(){var t=[];for(var e=0,i=this._items.length;e<i;e++){t.push(this._items[e].toJSON())}return t},addSchemeElementAt:function(t,e){var i=t.createConfigItem();var n=t.getType()==="section"?BX.Crm.EntityConfigSection.create({data:i}):BX.Crm.EntityConfigField.create({data:i});if(e>=0&&e<this._items.length){this._items.splice(e,0,n)}else{this._items.push(n)}this._isChanged=true},moveSchemeElement:function(t,e){var i=this._items.length;var n=i-1;if(e<0||e>i){e=n}var r=this.findItemIndexByName(t.getName());if(r<0||r===e){return}var o=this._items[r];this._items.splice(r,1);i--;if(e<i){this._items.splice(e,0,o)}else{this._items.push(o)}this._isChanged=true},updateSchemeElement:function(t){var e;var i=t.getParent();if(i){var n=this.findItemByName(i.getName());if(n){e=n.findFieldIndexByName(t.getName());if(e>=0){n.setField(BX.Crm.EntityConfigField.create({data:t.createConfigItem()}),e);this._isChanged=true}}}else{e=this.findItemIndexByName(t.getName());if(e>=0){if(t.getType()==="section"){this._items[e]=BX.Crm.EntityConfigSection.create({data:t.createConfigItem()})}else{this._items[e]=BX.Crm.EntityConfigField.create({data:t.createConfigItem()})}this._isChanged=true}}},removeSchemeElement:function(t){var e=this.findItemIndexByName(t.getName());if(e<0){return}this._items.splice(e,1);this._isChanged=true},isChangeable:function(){if(this._scope===BX.Crm.EntityConfigScope.common){return this._canUpdateCommonConfiguration}else if(this._scope===BX.Crm.EntityConfigScope.personal){return this._canUpdatePersonalConfiguration}return false},isChanged:function(){return this._isChanged},isScopeToggleEnabled:function(){return this._enableScopeToggle},getScope:function(){return this._scope},setScope:function(t){var e=new BX.Promise;if(!this._enableScopeToggle||this._scope===t){window.setTimeout(function(){e.fulfill()},0);return e}this._scope=t;this._data=[];this._items=[];BX.ajax.post(this._serviceUrl,{guid:this._id,action:"setScope",scope:this._scope},function(){e.fulfill()});return e},registerField:function(t){var e=t.getParent();if(!e){return}var i=this.findItemByName(e.getName());if(!i){return}i.addField(BX.Crm.EntityConfigField.create({data:t.createConfigItem()}));this.save()},unregisterField:function(t){var e=t.getParent();if(!e){return}var i=this.findItemByName(e.getName());if(!i){return}var n=i.findFieldByName(t.getName());if(!n){return}i.removeFieldByIndex(n.getIndex());this.save()},save:function(t,e){t=!!t;e=!!e;var i=new BX.Promise;if(!this._isChanged&&!t){window.setTimeout(function(){i.fulfill()},0);return i}var n={guid:this._id,action:"save",scope:this._scope,config:this.toJSON()};if(e){n["options"]=this._options}if(this._scope===BX.Crm.EntityConfigScope.personal&&t){n["forAllUsers"]="Y";n["delete"]="Y"}BX.ajax.post(this._serviceUrl,n,function(){i.fulfill()});this._isChanged=false;return i},reset:function(t){var e={guid:this._id,action:"reset",scope:this._scope,config:this.toJSON()};if(t){e["forAllUsers"]="Y"}var i=new BX.Promise;BX.ajax.post(this._serviceUrl,e,function(){i.fulfill()});return i},forceCommonScopeForAll:function(){var t=new BX.Promise;BX.ajax.post(this._serviceUrl,{guid:this._id,action:"forceCommonScopeForAll"},function(){t.fulfill()});return t},getOption:function(t,e){return BX.prop.getString(this._options,t,e)},setOption:function(t,e){if(typeof e==="undefined"||e===null){return}if(BX.prop.getString(this._options,t,null)===e){return}this._options[t]=e;if(this._scope===BX.Crm.EntityConfigScope.common){BX.userOptions.save("crm.entity.editor",this._id+"_common_opts",t,e,true)}else{BX.userOptions.save("crm.entity.editor",this._id+"_opts",t,e,false)}}};BX.Crm.EntityConfig.create=function(t,e){var i=new BX.Crm.EntityConfig;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityConfigItem==="undefined"){BX.Crm.EntityConfigItem=function(){this._settings={};this._data={};this._name="";this._title=""};BX.Crm.EntityConfigItem.prototype={initialize:function(t){this._settings=t?t:{};this._data=BX.prop.getObject(this._settings,"data",[]);this._name=BX.prop.getString(this._data,"name","");this._title=BX.prop.getString(this._data,"title","");this.doInitialize()},doInitialize:function(){},getType:function(){return""},getName:function(){return this._name},getTitle:function(){return this._title},toJSON:function(){return{}}}}if(typeof BX.Crm.EntityConfigSection==="undefined"){BX.Crm.EntityConfigSection=function(){BX.Crm.EntityConfigSection.superclass.constructor.apply(this);this._fields=[]};BX.extend(BX.Crm.EntityConfigSection,BX.Crm.EntityConfigItem);BX.Crm.EntityConfigSection.prototype.doInitialize=function(){this._fields=[];var t=BX.prop.getArray(this._data,"elements",[]);for(var e=0,i=t.length;e<i;e++){var n=BX.Crm.EntityConfigField.create({data:t[e]});n.setIndex(e);this._fields.push(n)}};BX.Crm.EntityConfigSection.prototype.getType=function(){return"section"};BX.Crm.EntityConfigSection.prototype.getFields=function(){return this._fields};BX.Crm.EntityConfigSection.prototype.findFieldByName=function(t){var e=this.findFieldIndexByName(t);return e>=0?this._fields[e]:null};BX.Crm.EntityConfigSection.prototype.findFieldIndexByName=function(t){for(var e=0,i=this._fields.length;e<i;e++){var n=this._fields[e];if(n.getName()===t){return e}}return-1};BX.Crm.EntityConfigSection.prototype.addField=function(t){this._fields.push(t)};BX.Crm.EntityConfigSection.prototype.setField=function(t,e){this._fields[e]=t};BX.Crm.EntityConfigSection.prototype.removeFieldByIndex=function(t){var e=this._fields.length;if(t<0||t>=e){return false}this._fields.splice(t,1);return true};BX.Crm.EntityConfigSection.prototype.toJSON=function(){var t={name:this._name,title:this._title,type:"section",elements:[]};for(var e=0,i=this._fields.length;e<i;e++){t.elements.push(this._fields[e].toJSON())}return t};BX.Crm.EntityConfigSection.create=function(t){var e=new BX.Crm.EntityConfigSection;e.initialize(t);return e}}if(typeof BX.Crm.EntityConfigField==="undefined"){BX.Crm.EntityConfigField=function(){BX.Crm.EntityConfigField.superclass.constructor.apply(this);this._index=-1;this._optionFlags=0};BX.extend(BX.Crm.EntityConfigField,BX.Crm.EntityConfigItem);BX.Crm.EntityConfigField.prototype.doInitialize=function(){this._optionFlags=BX.prop.getInteger(this._data,"optionFlags",0)};BX.Crm.EntityConfigField.prototype.toJSON=function(){var t={name:this._name};if(this._title!==""){t["title"]=this._title}if(this._optionFlags>0){t["optionFlags"]=this._optionFlags}return t};BX.Crm.EntityConfigField.prototype.getIndex=function(){return this._index};BX.Crm.EntityConfigField.prototype.setIndex=function(t){this._index=t};BX.Crm.EntityConfigField.create=function(t){var e=new BX.Crm.EntityConfigField;e.initialize(t);return e}}if(typeof BX.Crm.EntityScheme==="undefined"){BX.Crm.EntityScheme=function(){this._id="";this._settings={};this._elements=null;this._availableElements=null};BX.Crm.EntityScheme.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._elements=[];this._availableElements=[];var i,n;var r=BX.prop.getArray(this._settings,"current",[]);for(i=0,n=r.length;i<n;i++){this._elements.push(BX.Crm.EntitySchemeElement.create(r[i]))}var o=BX.prop.getArray(this._settings,"available",[]);for(i=0,n=o.length;i<n;i++){this._availableElements.push(BX.Crm.EntitySchemeElement.create(o[i]))}},getId:function(){return this._id},getElements:function(){return[].concat(this._elements)},findElementByName:function(t,e){var i=BX.prop.getBoolean(e,"isRecursive",false);for(var n=0,r=this._elements.length;n<r;n++){var o=this._elements[n];if(o.getName()===t){return o}if(!i){continue}var s=o.findElementByName(t);if(s!==null){return s}}return null},getAvailableElements:function(){return[].concat(this._availableElements)},setAvailableElements:function(t){this._availableElements=BX.type.isArray(t)?t:[]}};BX.Crm.EntityScheme.create=function(t,e){var i=new BX.Crm.EntityScheme;i.initialize(t,e);return i}}if(typeof BX.Crm.EntitySchemeElement==="undefined"){BX.Crm.EntitySchemeElement=function(){this._settings={};this._name="";this._type="";this._title="";this._originalTitle="";this._optionFlags=0;this._isEditable=true;this._isTransferable=true;this._isContextMenuEnabled=true;this._isRequired=false;this._isRequiredConditionally=false;this._isHeading=false;this._visibilityPolicy=BX.Crm.EntityEditorVisibilityPolicy.always;this._data=null;this._elements=null;this._parent=null};BX.Crm.EntitySchemeElement.prototype={initialize:function(t){this._settings=t?t:{};this._name=BX.prop.getString(this._settings,"name","");this._type=BX.prop.getString(this._settings,"type","");this._data=BX.prop.getObject(this._settings,"data",{});this._isEditable=BX.prop.getBoolean(this._settings,"editable",true);this._isTransferable=BX.prop.getBoolean(this._settings,"transferable",true);this._isContextMenuEnabled=BX.prop.getBoolean(this._settings,"enabledMenu",true);this._isTitleEnabled=BX.prop.getBoolean(this._settings,"enableTitle",true)&&this.getDataBooleanParam("enableTitle",true);this._isDragEnabled=BX.prop.getBoolean(this._settings,"isDragEnabled",true);this._isRequired=BX.prop.getBoolean(this._settings,"required",false);this._isRequiredConditionally=BX.prop.getBoolean(this._settings,"requiredConditionally",false);this._isHeading=BX.prop.getBoolean(this._settings,"isHeading",false);this._visibilityPolicy=BX.Crm.EntityEditorVisibilityPolicy.parse(BX.prop.getString(this._settings,"visibilityPolicy",""));var e=BX.prop.getString(this._settings,"title","");var i=BX.prop.getString(this._settings,"originalTitle","");if(e!==""&&i===""){i=e}else if(i!==""&&e===""){e=i}this._title=e;this._originalTitle=i;this._optionFlags=BX.prop.getInteger(this._settings,"optionFlags",0);this._elements=[];var n=BX.prop.getArray(this._settings,"elements",[]);for(var r=0,o=n.length;r<o;r++){this._elements.push(BX.Crm.EntitySchemeElement.create(n[r]))}},mergeSettings:function(t){this.initialize(BX.mergeEx(this._settings,t))},getName:function(){return this._name},getType:function(){return this._type},getTitle:function(){return this._title},setTitle:function(t){this._title=this._settings["title"]=t},getOriginalTitle:function(){return this._originalTitle},hasCustomizedTitle:function(){return this._title!==""&&this._title!==this._originalTitle},resetOriginalTitle:function(){this._originalTitle=this._title},getOptionFlags:function(){return this._optionFlags},setOptionFlags:function(t){this._optionFlags=this._settings["optionFlags"]=t},areAttributesEnabled:function(){return BX.prop.getBoolean(this._settings,"enableAttributes",true)},isEditable:function(){return this._isEditable},isTransferable:function(){return this._isTransferable},isRequired:function(){return this._isRequired},isRequiredConditionally:function(){return this._isRequiredConditionally},isContextMenuEnabled:function(){return this._isContextMenuEnabled},isTitleEnabled:function(){return this._isTitleEnabled},isDragEnabled:function(){return this._isDragEnabled},isHeading:function(){return this._isHeading},getCreationPlaceholder:function(){return BX.prop.getString(BX.prop.getObject(this._settings,"placeholders",null),"creation","")},getVisibilityPolicy:function(){return this._visibilityPolicy},getData:function(){return this._data},setData:function(t){this._data=t},getDataParam:function(t,e){return BX.prop.get(this._data,t,e)},setDataParam:function(t,e){this._data[t]=e},getDataStringParam:function(t,e){return BX.prop.getString(this._data,t,e)},getDataIntegerParam:function(t,e){return BX.prop.getInteger(this._data,t,e)},getDataBooleanParam:function(t,e){return BX.prop.getBoolean(this._data,t,e)},getDataObjectParam:function(t,e){return BX.prop.getObject(this._data,t,e)},getDataArrayParam:function(t,e){return BX.prop.getArray(this._data,t,e)},getElements:function(){return this._elements},setElements:function(t){this._elements=t},findElementByName:function(t){for(var e=0,i=this._elements.length;e<i;e++){var n=this._elements[e];if(n.getName()===t){return n}}return null},getAffectedFields:function(){var t=this.getDataArrayParam("affectedFields",[]);if(t.length===0){t.push(this._name)}return t},getParent:function(){return this._parent},setParent:function(t){this._parent=t instanceof BX.Crm.EntitySchemeElement?t:null},hasAttributeConfiguration:function(t){return!!this.getAttributeConfiguration(t)},getAttributeConfiguration:function(t){var e=this.getData();var i=BX.prop.getArray(e,"attrConfigs",null);if(!i){return null}for(var n=0,r=i.length;n<r;n++){var o=i[n];if(BX.prop.getInteger(o,"typeId",BX.Crm.EntityFieldAttributeType.undefined)===t){return BX.clone(o)}}return null},setAttributeConfiguration:function(t){var e=BX.prop.getInteger(t,"typeId",BX.Crm.EntityFieldAttributeType.undefined);if(typeof this._data["attrConfigs"]==="undefined"){this._data["attrConfigs"]=[]}var i=-1;for(var n=0,r=this._data["attrConfigs"].length;n<r;n++){if(BX.prop.getInteger(this._data["attrConfigs"][n],"typeId",BX.Crm.EntityFieldAttributeType.undefined)===e){i=n;break}}if(i>=0){this._data["attrConfigs"].splice(i,1,t)}else{this._data["attrConfigs"].push(t)}},removeAttributeConfiguration:function(t){if(typeof this._data["attrConfigs"]==="undefined"){return}for(var e=0,i=this._data["attrConfigs"].length;e<i;e++){if(BX.prop.getInteger(this._data["attrConfigs"][e],"typeId",BX.Crm.EntityFieldAttributeType.undefined)===t){this._data["attrConfigs"].splice(e,1);return}}},createConfigItem:function(){var t={name:this._name};if(this._type==="section"){t["type"]="section";if(this._title!==""){t["title"]=this._title}t["elements"]=[];for(var e=0,i=this._elements.length;e<i;e++){t["elements"].push(this._elements[e].createConfigItem())}}else{if(this._title!==""&&this._title!==this._originalTitle){t["title"]=this._title}if(this._optionFlags>0){t["optionFlags"]=this._optionFlags}}return t},clone:function(){return BX.Crm.EntitySchemeElement.create(BX.clone(this._settings))}};BX.Crm.EntitySchemeElement.create=function(t){var e=new BX.Crm.EntitySchemeElement;e.initialize(t);return e}}if(typeof BX.Crm.EntityEditorValidatorFactory==="undefined"){BX.Crm.EntityEditorValidatorFactory={create:function(t,e){if(t==="person"){return BX.Crm.EntityPersonValidator.create(e)}return null}}}if(typeof BX.Crm.EntityEditorControlFactory==="undefined"){BX.Crm.EntityEditorControlFactory={initialized:false,methods:{},isInitialized:function(){return this.initialized},initialize:function(){if(this.initialized){return}var t={methods:{}};BX.onCustomEvent(window,"BX.Crm.EntityEditorControlFactory:onInitialize",[this,t]);for(var e in t.methods){if(t.methods.hasOwnProperty(e)){this.registerFactoryMethod(e,t.methods[e])}}this.initialized=true},registerFactoryMethod:function(t,e){if(BX.type.isFunction(e)){this.methods[t]=e}},create:function(t,e,i){if(!this.initialized){this.initialize()}if(t==="section"){return BX.Crm.EntityEditorSection.create(e,i)}else if(t==="text"){return BX.Crm.EntityEditorText.create(e,i)}else if(t==="number"){return BX.Crm.EntityEditorNumber.create(e,i)}else if(t==="datetime"){return BX.Crm.EntityEditorDatetime.create(e,i)}else if(t==="boolean"){return BX.Crm.EntityEditorBoolean.create(e,i)}else if(t==="list"){return BX.Crm.EntityEditorList.create(e,i)}else if(t==="multilist"){return BX.Crm.EntityEditorMultiList.create(e,i)}else if(t==="html"){return BX.Crm.EntityEditorHtml.create(e,i)}else if(t==="money"){return BX.Crm.EntityEditorMoney.create(e,i)}else if(t==="image"){return BX.Crm.EntityEditorImage.create(e,i)}else if(t==="user"){return BX.Crm.EntityEditorUser.create(e,i)}else if(t==="multiple_user"){return BX.Crm.EntityEditorMultipleUser.create(e,i)}else if(t==="address"){return BX.Crm.EntityEditorAddress.create(e,i)}else if(t==="crm_entity"){return BX.Crm.EntityEditorEntity.create(e,i)}else if(t==="file_storage"){return BX.Crm.EntityEditorFileStorage.create(e,i)}else if(t==="client"){return BX.Crm.EntityEditorClient.create(e,i)}else if(t==="client_light"){return BX.Crm.EntityEditorClientLight.create(e,i)}else if(t==="multifield"){return BX.Crm.EntityEditorMultifield.create(e,i)}else if(t==="product_row_summary"){return BX.Crm.EntityEditorProductRowSummary.create(e,i)}else if(t==="requisite_selector"){return BX.Crm.EntityEditorRequisiteSelector.create(e,i)}else if(t==="requisite_list"){return BX.Crm.EntityEditorRequisiteList.create(e,i)}else if(t==="userField"){return BX.Crm.EntityEditorUserField.create(e,i)}else if(t==="userFieldConfig"){return BX.Crm.EntityEditorUserFieldConfigurator.create(e,i)}else if(t==="recurring"){return BX.Crm.EntityEditorRecurring.create(e,i)}else if(t==="recurring_custom_row"){return BX.Crm.EntityEditorRecurringCustomRowField.create(e,i)}else if(t==="recurring_single_row"){return BX.Crm.EntityEditorRecurringSingleField.create(e,i)}else if(t==="custom"){return BX.Crm.EntityEditorCustom.create(e,i)}else if(t==="shipment"){return BX.Crm.EntityEditorShipment.create(e,i)}else if(t==="payment"){return BX.Crm.EntityEditorPayment.create(e,i)}else if(t==="payment_status"){return BX.Crm.EntityEditorPaymentStatus.create(e,i)}else if(t==="payment_check"){return BX.Crm.EntityEditorPaymentCheck.create(e,i)}else if(t==="order_subsection"){return BX.Crm.EntityEditorSubsection.create(e,i)}else if(t==="order_property_wrapper"){return BX.Crm.EntityEditorOrderPropertyWrapper.create(e,i)}else if(t==="order_property_subsection"){return BX.Crm.EntityEditorOrderPropertySubsection.create(e,i)}else if(t==="order_property_file"){return BX.Crm.EntityEditorOrderPropertyFile.create(e,i)}else if(t==="order_product_property"){return BX.Crm.EntityEditorOrderProductProperty.create(e,i)}else if(t==="order_person_type"){return BX.Crm.EntityEditorOrderPersonType.create(e,i)}else if(t==="order_quantity"){return BX.Crm.EntityEditorOrderQuantity.create(e,i)}else if(t==="order_user"){return BX.Crm.EntityEditorOrderUser.create(e,i)}else if(t==="order_client"){return BX.Crm.EntityEditorOrderClient.create(e,i)}else if(t==="hidden"){return BX.Crm.EntityEditorHidden.create(e,i)}else if(t==="delivery_selector"){return BX.Crm.EntityEditorDeliverySelector.create(e,i)}else if(t==="shipment_extra_services"){return BX.Crm.EntityEditorShipmentExtraServices.create(e,i)}for(var n in this.methods){if(!this.methods.hasOwnProperty(n)){continue}var r=this.methods[n](t,e,i);if(r){return r}}return null}}}if(typeof BX.Crm.EntityEditorControllerFactory==="undefined"){BX.Crm.EntityEditorControllerFactory={create:function(t,e,i){if(t==="product_row_proxy"){return BX.Crm.EntityEditorProductRowProxy.create(e,i)}else if(t==="order_controller"){return BX.Crm.EntityEditorOrderController.create(e,i)}else if(t==="order_shipment_controller"){return BX.Crm.EntityEditorOrderShipmentController.create(e,i)}else if(t==="order_payment_controller"){return BX.Crm.EntityEditorOrderPaymentController.create(e,i)}else if(t==="order_product_controller"){return BX.Crm.EntityEditorOrderProductController.create(e,i)}return null}}}if(typeof BX.Crm.EntityEditorModelFactory==="undefined"){BX.Crm.EntityEditorModelFactory={create:function(t,e,i){if(t===BX.CrmEntityType.enumeration.lead){return BX.Crm.LeadModel.create(e,i)}else if(t===BX.CrmEntityType.enumeration.contact){return BX.Crm.ContactModel.create(e,i)}else if(t===BX.CrmEntityType.enumeration.company){return BX.Crm.CompanyModel.create(e,i)}else if(t===BX.CrmEntityType.enumeration.deal){return BX.Crm.DealModel.create(e,i)}else if(t===BX.CrmEntityType.enumeration.dealrecurring){return BX.Crm.DealRecurringModel.create(e,i)}else if(t===BX.CrmEntityType.enumeration.quote){return BX.Crm.QuoteModel.create(e,i)}else if(t===BX.CrmEntityType.enumeration.order){return BX.Crm.OrderModel.create(e,i)}else if(t===BX.CrmEntityType.enumeration.orderpayment){return BX.Crm.OrderPaymentModel.create(e,i)}else if(t===BX.CrmEntityType.enumeration.ordershipment){return BX.Crm.OrderShipmentModel.create(e,i)}return BX.Crm.EntityModel.create(e,i)}}}if(typeof BX.Crm.EntityModel==="undefined"){BX.Crm.EntityModel=function(){this._id="";this._settings={};this._data=null;this._initData=null;this._lockedFields=null;this._changeNotifier=null;this._lockNotifier=null};BX.Crm.EntityModel.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._data=BX.prop.getObject(this._settings,"data",{});this._initData=BX.clone(this._data);this._lockedFields={};this._changeNotifier=BX.CrmNotifier.create(this);this._lockNotifier=BX.CrmNotifier.create(this);this.doInitialize()},doInitialize:function(){},getEntityTypeId:function(){return BX.CrmEntityType.enumeration.undefined},getEntityId:function(){return BX.prop.getInteger(this._data,"ID",0)},getOwnerInfo:function(){return{ownerID:this.getEntityId(),ownerType:BX.CrmEntityType.resolveName(this.getEntityTypeId())}},getField:function(t,e){if(e===undefined){e=null}return BX.prop.get(this._data,t,e)},getStringField:function(t,e){if(e===undefined){e=null}return BX.prop.getString(this._data,t,e)},getIntegerField:function(t,e){if(e===undefined){e=null}return BX.prop.getInteger(this._data,t,e)},getNumberField:function(t,e){if(e===undefined){e=null}return BX.prop.getNumber(this._data,t,e)},getArrayField:function(t,e){if(e===undefined){e=null}return BX.prop.getArray(this._data,t,e)},registerNewField:function(t,e){this._data[t]=e;this._initData[t]=e},setField:function(t,e,i){if(this._data.hasOwnProperty(t)&&this._data[t]===e){return}this._data[t]=e;if(!BX.type.isPlainObject(i)){i={}}if(BX.prop.getBoolean(i,"enableNotification",true)){this._changeNotifier.notify([{name:t,originator:BX.prop.get(i,"originator",null)}]);BX.onCustomEvent(window,"Crm.EntityModel.Change",[this,{entityTypeId:this.getEntityTypeId(),entityId:this.getEntityId(),fieldName:t}])}},getData:function(){return this._data},setData:function(t,e){this._data=BX.type.isPlainObject(t)?t:{};this._initData=BX.clone(this._data);if(BX.prop.getBoolean(e,"enableNotification",true)){this._changeNotifier.notify([{forAll:true,originator:BX.prop.get(e,"originator",null)}]);BX.onCustomEvent(window,"Crm.EntityModel.Change",[this,{entityTypeId:this.getEntityTypeId(),entityId:this.getEntityId(),forAll:true}])}},updateData:function(t,e){if(!BX.type.isPlainObject(t)){return}this._data=BX.mergeEx(this._data,t);if(BX.prop.getBoolean(e,"enableNotification",true)){this._changeNotifier.notify([{forAll:true,originator:BX.prop.get(e,"originator",null)}]);BX.onCustomEvent(window,"Crm.EntityModel.Change",[this,{entityTypeId:this.getEntityTypeId(),entityId:this.getEntityId(),forAll:true}])}},getSchemeField:function(t,e,i){return this.getField(t.getDataStringParam(e,""),i)},setSchemeField:function(t,e,i){var n=t.getDataStringParam(e,"");if(n!==""){this.setField(n,i)}},getMappedField:function(t,e,i){var n=BX.prop.getString(t,e,"");return n!==""?this.getField(n,i):i},setMappedField:function(t,e,i){var n=BX.prop.getString(t,e,"");if(n!==""){this.setField(n,i)}},save:function(){},rollback:function(){this._data=BX.clone(this._initData)},lockField:function(t){if(this._lockedFields.hasOwnProperty(t)){return}this._lockedFields[t]=true;this._lockNotifier.notify([{name:name,isLocked:true}])},unlockField:function(t){if(!this._lockedFields.hasOwnProperty(t)){return}delete this._lockedFields[t];this._lockNotifier.notify([{name:name,isLocked:false}])},isFieldLocked:function(t){return this._lockedFields.hasOwnProperty(t)},addChangeListener:function(t){this._changeNotifier.addListener(t)},removeChangeListener:function(t){this._changeNotifier.removeListener(t)},addLockListener:function(t){this._lockNotifier.addListener(t)},removeLockListener:function(t){this._lockNotifier.removeListener(t)},isCaptionEditable:function(){return false},getCaption:function(){return""},setCaption:function(t){},prepareCaptionData:function(t){}};BX.Crm.EntityModel.create=function(t,e){var i=new BX.Crm.EntityModel;i.initialize(t,e);return i}}if(typeof BX.Crm.LeadModel==="undefined"){BX.Crm.LeadModel=function(){BX.Crm.LeadModel.superclass.constructor.apply(this)};BX.extend(BX.Crm.LeadModel,BX.Crm.EntityModel);BX.Crm.LeadModel.prototype.doInitialize=function(){BX.addCustomEvent(window,"Crm.EntityProgress.Change",BX.delegate(this.onEntityProgressChange,this))};BX.Crm.LeadModel.prototype.onEntityProgressChange=function(t,e){if(BX.prop.getInteger(e,"entityTypeId",0)!==this.getEntityTypeId()||BX.prop.getInteger(e,"entityId",0)!==this.getEntityId()){return}var i=BX.prop.getString(e,"currentStepId","");if(i!==this.getField("STATUS_ID","")){this.setField("STATUS_ID",i)}};BX.Crm.LeadModel.prototype.getEntityTypeId=function(){return BX.CrmEntityType.enumeration.lead};BX.Crm.LeadModel.prototype.isCaptionEditable=function(){return true};BX.Crm.LeadModel.prototype.getCaption=function(){var t=this.getField("TITLE");return BX.type.isString(t)?t:""};BX.Crm.LeadModel.prototype.setCaption=function(t){this.setField("TITLE",t)};BX.Crm.LeadModel.prototype.prepareCaptionData=function(t){t["TITLE"]=this.getField("TITLE","")};BX.Crm.LeadModel.create=function(t,e){var i=new BX.Crm.LeadModel;i.initialize(t,e);return i}}if(typeof BX.Crm.ContactModel==="undefined"){BX.Crm.ContactModel=function(){BX.Crm.ContactModel.superclass.constructor.apply(this)};BX.extend(BX.Crm.ContactModel,BX.Crm.EntityModel);BX.Crm.ContactModel.prototype.getEntityTypeId=function(){return BX.CrmEntityType.enumeration.contact};BX.Crm.ContactModel.prototype.getCaption=function(){return this.getField("FORMATTED_NAME","")};BX.Crm.ContactModel.create=function(t,e){var i=new BX.Crm.ContactModel;i.initialize(t,e);return i}}if(typeof BX.Crm.CompanyModel==="undefined"){BX.Crm.CompanyModel=function(){BX.Crm.CompanyModel.superclass.constructor.apply(this)};BX.extend(BX.Crm.CompanyModel,BX.Crm.EntityModel);BX.Crm.CompanyModel.prototype.isCaptionEditable=function(){return true};BX.Crm.CompanyModel.prototype.getEntityTypeId=function(){return BX.CrmEntityType.enumeration.company};BX.Crm.CompanyModel.prototype.getCaption=function(){return this.getField("TITLE","")};BX.Crm.CompanyModel.prototype.setCaption=function(t){this.setField("TITLE",t)};BX.Crm.CompanyModel.prototype.prepareCaptionData=function(t){t["TITLE"]=this.getField("TITLE","")};BX.Crm.CompanyModel.create=function(t,e){var i=new BX.Crm.CompanyModel;i.initialize(t,e);return i}}if(typeof BX.Crm.DealModel==="undefined"){BX.Crm.DealModel=function(){BX.Crm.DealModel.superclass.constructor.apply(this)};BX.extend(BX.Crm.DealModel,BX.Crm.EntityModel);BX.Crm.DealModel.prototype.doInitialize=function(){BX.addCustomEvent(window,"Crm.EntityProgress.Saved",BX.delegate(this.onEntityProgressSave,this))};BX.Crm.DealModel.prototype.onEntityProgressSave=function(t,e){if(BX.prop.getInteger(e,"entityTypeId",0)!==this.getEntityTypeId()||BX.prop.getInteger(e,"entityId",0)!==this.getEntityId()){return}var i=BX.prop.getString(e,"currentStepId","");if(i!==this.getField("STAGE_ID","")){this.setField("STAGE_ID",i)}};BX.Crm.DealModel.prototype.getEntityTypeId=function(){return BX.CrmEntityType.enumeration.deal};BX.Crm.DealModel.prototype.isCaptionEditable=function(){return true};BX.Crm.DealModel.prototype.getCaption=function(){var t=this.getField("TITLE");return BX.type.isString(t)?t:""};BX.Crm.DealModel.prototype.setCaption=function(t){this.setField("TITLE",t)};BX.Crm.DealModel.prototype.prepareCaptionData=function(t){t["TITLE"]=this.getField("TITLE","")};BX.Crm.DealModel.create=function(t,e){var i=new BX.Crm.DealModel;i.initialize(t,e);return i}}if(typeof BX.Crm.DealRecurringModel==="undefined"){BX.Crm.DealRecurringModel=function(){BX.Crm.DealRecurringModel.superclass.constructor.apply(this)};BX.extend(BX.Crm.DealRecurringModel,BX.Crm.DealModel);BX.Crm.DealRecurringModel.create=function(t,e){var i=new BX.Crm.DealRecurringModel;i.initialize(t,e);return i}}if(typeof BX.Crm.QuoteModel==="undefined"){BX.Crm.QuoteModel=function(){BX.Crm.QuoteModel.superclass.constructor.apply(this)};BX.extend(BX.Crm.QuoteModel,BX.Crm.EntityModel);BX.Crm.QuoteModel.prototype.doInitialize=function(){BX.addCustomEvent(window,"Crm.EntityProgress.Change",BX.delegate(this.onEntityProgressChange,this))};BX.Crm.QuoteModel.prototype.onEntityProgressChange=function(t,e){if(BX.prop.getInteger(e,"entityTypeId",0)!==this.getEntityTypeId()||BX.prop.getInteger(e,"entityId",0)!==this.getEntityId()){return}var i=BX.prop.getString(e,"currentStepId","");if(i!==this.getField("STATUS_ID","")){this.setField("STATUS_ID",i)}};BX.Crm.QuoteModel.prototype.getEntityTypeId=function(){return BX.CrmEntityType.enumeration.quote};BX.Crm.QuoteModel.prototype.isCaptionEditable=function(){return true};BX.Crm.QuoteModel.prototype.getCaption=function(){var t=this.getField("TITLE");return BX.type.isString(t)?t:""};BX.Crm.QuoteModel.prototype.setCaption=function(t){this.setField("TITLE",t)};BX.Crm.QuoteModel.prototype.prepareCaptionData=function(t){t["TITLE"]=this.getField("TITLE","")};BX.Crm.QuoteModel.create=function(t,e){var i=new BX.Crm.QuoteModel;i.initialize(t,e);return i}}if(typeof BX.Crm.EditorDragScope==="undefined"){BX.Crm.EditorDragScope={intermediate:0,parent:1,form:2,getDefault:function(){return this.form}}}if(typeof BX.Crm.EditorDragObjectType==="undefined"){BX.Crm.EditorDragObjectType={intermediate:"",field:"F",section:"S"}}if(typeof BX.Crm.EditorDragItem==="undefined"){BX.Crm.EditorDragItem=function(){};BX.Crm.EditorDragItem.prototype={getType:function(){return BX.Crm.EditorDragObjectType.intermediate},getContextId:function(){return""},createGhostNode:function(){return null},processDragStart:function(){},processDragPositionChange:function(t,e){},processDragStop:function(){}}}if(typeof BX.Crm.EditorFieldDragItem==="undefined"){BX.Crm.EditorFieldDragItem=function(){BX.Crm.EditorFieldDragItem.superclass.constructor.apply(this);this._scope=BX.Crm.EditorDragScope.undefined;this._control=null;this._contextId=""};BX.extend(BX.Crm.EditorFieldDragItem,BX.Crm.EditorDragItem);BX.Crm.EditorFieldDragItem.prototype.initialize=function(t){this._control=BX.prop.get(t,"control");if(!this._control){throw"Crm.EditorFieldDragItem: The 'control' parameter is not defined in settings or empty."}this._scope=BX.prop.getInteger(t,"scope",BX.Crm.EditorDragScope.getDefault());this._contextId=BX.prop.getString(t,"contextId","")};BX.Crm.EditorFieldDragItem.prototype.getType=function(){return BX.Crm.EditorDragObjectType.field};BX.Crm.EditorFieldDragItem.prototype.getControl=function(){return this._control};BX.Crm.EditorFieldDragItem.prototype.getContextId=function(){return this._contextId!==""?this._contextId:BX.Crm.EditorFieldDragItem.contextId};BX.Crm.EditorFieldDragItem.prototype.createGhostNode=function(){return this._control.createGhostNode()};BX.Crm.EditorFieldDragItem.prototype.processDragStart=function(){window.setTimeout(function(){BX.Crm.EditorDragContainerController.enable(BX.Crm.EditorFieldDragItem.contextId,true);BX.Crm.EditorDragContainerController.enable(BX.Crm.EditorSectionDragItem.contextId,false);BX.Crm.EditorDragContainerController.refreshAll()});this._control.getWrapper().style.opacity="0.2"};BX.Crm.EditorFieldDragItem.prototype.processDragPositionChange=function(t,e){var i=this._scope===BX.Crm.EditorDragScope.parent?this._control.getParentPosition():this._control.getRootContainerPosition();if(t.y<i.top){t.y=i.top}if(t.y+e.height>i.bottom){t.y=i.bottom-e.height}if(t.x<i.left){t.x=i.left}if(t.x+e.width>i.right){t.x=i.right-e.width}};BX.Crm.EditorFieldDragItem.prototype.processDragStop=function(){window.setTimeout(function(){BX.Crm.EditorDragContainerController.enable(BX.Crm.EditorSectionDragItem.contextId,true);BX.Crm.EditorDragContainerController.refreshAll()});this._control.getWrapper().style.opacity="1"};BX.Crm.EditorFieldDragItem.contextId="editor_field";BX.Crm.EditorFieldDragItem.create=function(t){var e=new BX.Crm.EditorFieldDragItem;e.initialize(t);return e}}if(typeof BX.Crm.EditorSectionDragItem==="undefined"){BX.Crm.EditorSectionDragItem=function(){BX.Crm.EditorSectionDragItem.superclass.constructor.apply(this);this._control=null};BX.extend(BX.Crm.EditorSectionDragItem,BX.Crm.EditorDragItem);BX.Crm.EditorSectionDragItem.prototype.initialize=function(t){this._control=BX.prop.get(t,"control");if(!this._control){throw"Crm.EditorSectionDragItem: The 'control' parameter is not defined in settings or empty."}};BX.Crm.EditorSectionDragItem.prototype.getType=function(){return BX.Crm.EditorDragObjectType.section};BX.Crm.EditorSectionDragItem.prototype.getControl=function(){return this._control};BX.Crm.EditorSectionDragItem.prototype.getContextId=function(){return BX.Crm.EditorSectionDragItem.contextId};BX.Crm.EditorSectionDragItem.prototype.createGhostNode=function(){return this._control.createGhostNode()};BX.Crm.EditorSectionDragItem.prototype.processDragStart=function(){BX.addClass(document.body,"crm-entity-widgets-drag");var t=this._control;t.getWrapper().style.opacity="0.2";window.setTimeout(function(){BX.Crm.EditorDragContainerController.enable(BX.Crm.EditorSectionDragItem.contextId,true);BX.Crm.EditorDragContainerController.enable(BX.Crm.EditorFieldDragItem.contextId,false);BX.Crm.EditorDragContainerController.refreshAll();window.setTimeout(function(){var e=t.getSiblingByIndex(0);if(e!==null&&e!==t){e.getWrapper().scrollIntoView()}},200)})};BX.Crm.EditorSectionDragItem.prototype.processDragStop=function(){BX.removeClass(document.body,"crm-entity-widgets-drag");window.setTimeout(function(){BX.Crm.EditorDragContainerController.enable(BX.Crm.EditorFieldDragItem.contextId,true);BX.Crm.EditorDragContainerController.refreshAll()});var t=this._control;t.getWrapper().style.opacity="1";window.setTimeout(function(){t.getWrapper().scrollIntoView()},150)};BX.Crm.EditorSectionDragItem.contextId="editor_section";BX.Crm.EditorSectionDragItem.create=function(t){var e=new BX.Crm.EditorSectionDragItem;e.initialize(t);return e}}if(typeof BX.Crm.EditorDragItemController==="undefined"){BX.Crm.EditorDragItemController=function(){BX.Crm.EditorDragItemController.superclass.constructor.apply(this);this._charge=null;this._preserveDocument=true};BX.extend(BX.Crm.EditorDragItemController,BX.CrmCustomDragItem);BX.Crm.EditorDragItemController.prototype.doInitialize=function(){this._charge=this.getSetting("charge");if(!this._charge){throw"Crm.EditorDragItemController: The 'charge' parameter is not defined in settings or empty."}this._startNotifier=BX.CrmNotifier.create(this);this._stopNotifier=BX.CrmNotifier.create(this);this._ghostOffset={x:0,y:-40}};BX.Crm.EditorDragItemController.prototype.addStartListener=function(t){this._startNotifier.addListener(t)};BX.Crm.EditorDragItemController.prototype.removeStartListener=function(t){this._startNotifier.removeListener(t)};BX.Crm.EditorDragItemController.prototype.addStopListener=function(t){this._stopNotifier.addListener(t)};BX.Crm.EditorDragItemController.prototype.removeStopListener=function(t){this._stopNotifier.removeListener(t)};BX.Crm.EditorDragItemController.prototype.getCharge=function(){return this._charge};BX.Crm.EditorDragItemController.prototype.createGhostNode=function(){if(this._ghostNode){return this._ghostNode}this._ghostNode=this._charge.createGhostNode();document.body.appendChild(this._ghostNode)};BX.Crm.EditorDragItemController.prototype.getGhostNode=function(){return this._ghostNode};BX.Crm.EditorDragItemController.prototype.removeGhostNode=function(){if(this._ghostNode){document.body.removeChild(this._ghostNode);this._ghostNode=null}};BX.Crm.EditorDragItemController.prototype.getContextId=function(){return this._charge.getContextId()};BX.Crm.EditorDragItemController.prototype.getContextData=function(){return{contextId:this._charge.getContextId(),charge:this._charge}};BX.Crm.EditorDragItemController.prototype.processDragStart=function(){BX.Crm.EditorDragItemController.current=this;this._charge.processDragStart();BX.Crm.EditorDragContainerController.refresh(this._charge.getContextId());this._startNotifier.notify([])};BX.Crm.EditorDragItemController.prototype.processDrag=function(t,e){};BX.Crm.EditorDragItemController.prototype.processDragPositionChange=function(t){this._charge.processDragPositionChange(t,BX.pos(this.getGhostNode()))};BX.Crm.EditorDragItemController.prototype.processDragStop=function(){BX.Crm.EditorDragItemController.current=null;this._charge.processDragStop();BX.Crm.EditorDragContainerController.refreshAfter(this._charge.getContextId(),300);this._stopNotifier.notify([])};BX.Crm.EditorDragItemController.current=null;BX.Crm.EditorDragItemController.create=function(t,e){var i=new BX.Crm.EditorDragItemController;i.initialize(t,e);return i}}if(typeof BX.Crm.EditorDragContainer==="undefined"){BX.Crm.EditorDragContainer=function(){};BX.Crm.EditorDragContainer.prototype={getContextId:function(){return""},getPriority:function(){return 100},hasPlaceHolder:function(){return false},createPlaceHolder:function(t){return null},getPlaceHolder:function(){return null},removePlaceHolder:function(){},getChildNodes:function(){return[]},getChildNodeCount:function(){return 0}}}if(typeof BX.Crm.EditorFieldDragContainer==="undefined"){BX.Crm.EditorFieldDragContainer=function(){BX.Crm.EditorFieldDragContainer.superclass.constructor.apply(this);this._section=null;this._context=""};BX.extend(BX.Crm.EditorFieldDragContainer,BX.Crm.EditorDragContainer);BX.Crm.EditorFieldDragContainer.prototype.initialize=function(t){this._section=BX.prop.get(t,"section");if(!this._section){throw"Crm.EditorSectionDragContainer: The 'section' parameter is not defined in settings or empty."}this._context=BX.prop.getString(t,"context","")};BX.Crm.EditorFieldDragContainer.prototype.getSection=function(){return this._section};BX.Crm.EditorFieldDragContainer.prototype.getContextId=function(){return this._context!==""?this._context:BX.Crm.EditorFieldDragItem.contextId};BX.Crm.EditorFieldDragContainer.prototype.getPriority=function(){return 10};BX.Crm.EditorFieldDragContainer.prototype.hasPlaceHolder=function(){return this._section.hasPlaceHolder()};BX.Crm.EditorFieldDragContainer.prototype.createPlaceHolder=function(t){return this._section.createPlaceHolder(t)};BX.Crm.EditorFieldDragContainer.prototype.getPlaceHolder=function(){return this._section.getPlaceHolder()};BX.Crm.EditorFieldDragContainer.prototype.removePlaceHolder=function(){this._section.removePlaceHolder()};BX.Crm.EditorFieldDragContainer.prototype.getChildNodes=function(){var t=[];var e=this._section.getChildren();for(var i=0,n=e.length;i<n;i++){t.push(e[i].getWrapper())}return t};BX.Crm.EditorFieldDragContainer.prototype.getChildNodeCount=function(){return this._section.getChildCount()};BX.Crm.EditorFieldDragContainer.create=function(t){var e=new BX.Crm.EditorFieldDragContainer;e.initialize(t);return e}}if(typeof BX.Crm.EditorSectionDragContainer==="undefined"){BX.Crm.EditorSectionDragContainer=function(){BX.Crm.EditorSectionDragContainer.superclass.constructor.apply(this);this._editor=null};BX.extend(BX.Crm.EditorSectionDragContainer,BX.Crm.EditorDragContainer);BX.Crm.EditorSectionDragContainer.prototype.initialize=function(t){this._editor=BX.prop.get(t,"editor");if(!this._editor){throw"Crm.EditorSectionDragContainer: The 'editor' parameter is not defined in settings or empty."}};BX.Crm.EditorSectionDragContainer.prototype.getEditor=function(){return this._editor};BX.Crm.EditorSectionDragContainer.prototype.getContextId=function(){return BX.Crm.EditorSectionDragItem.contextId};BX.Crm.EditorSectionDragContainer.prototype.getPriority=function(){return 20};BX.Crm.EditorSectionDragContainer.prototype.hasPlaceHolder=function(){return this._editor.hasPlaceHolder()};BX.Crm.EditorSectionDragContainer.prototype.createPlaceHolder=function(t){return this._editor.createPlaceHolder(t)};BX.Crm.EditorSectionDragContainer.prototype.getPlaceHolder=function(){return this._editor.getPlaceHolder()};BX.Crm.EditorSectionDragContainer.prototype.removePlaceHolder=function(){this._editor.removePlaceHolder()};BX.Crm.EditorSectionDragContainer.prototype.getChildNodes=function(){var t=[];var e=this._editor.getControls();for(var i=0,n=e.length;i<n;i++){t.push(e[i].getWrapper())}return t};BX.Crm.EditorSectionDragContainer.prototype.getChildNodeCount=function(){return this._editor.getControlCount()};BX.Crm.EditorSectionDragContainer.create=function(t){var e=new BX.Crm.EditorSectionDragContainer;e.initialize(t);return e}}if(typeof BX.Crm.EditorDragContainerController==="undefined"){BX.Crm.EditorDragContainerController=function(){BX.Crm.EditorDragContainerController.superclass.constructor.apply(this);this._charge=null};BX.extend(BX.Crm.EditorDragContainerController,BX.CrmCustomDragContainer);BX.Crm.EditorDragContainerController.prototype.doInitialize=function(){this._charge=this.getSetting("charge");if(!this._charge){throw"Crm.EditorDragContainerController: The 'charge' parameter is not defined in settings or empty."}};BX.Crm.EditorDragContainerController.prototype.getCharge=function(){return this._charge};BX.Crm.EditorDragContainerController.prototype.createPlaceHolder=function(t){var e=BX.pos(BX.Crm.EditorDragItemController.current.getGhostNode());var i=e.top,n=e.top+40;var r=Math.floor((i+n)/2);var o,s;var a=this._charge.getPlaceHolder();if(a){o=a.getPosition();s=Math.floor((o.top+o.bottom)/2);if(i<=o.bottom&&i>=o.top||n>=o.top&&n<=o.bottom||Math.abs(r-s)<=8){if(!a.isActive()){a.setActive(true)}return}}var l=this._charge.getChildNodes();for(var d=0;d<l.length;d++){o=BX.pos(l[d]);s=Math.floor((o.top+o.bottom)/2);if(i<=o.bottom&&i>=o.top||n>=o.top&&n<=o.bottom||Math.abs(r-s)<=8){this._charge.createPlaceHolder(r-s<=0?d:d+1).setActive(true);return}}this._charge.createPlaceHolder(-1).setActive(true);this.refresh()};BX.Crm.EditorDragContainerController.prototype.removePlaceHolder=function(){if(!this._charge.hasPlaceHolder()){return}if(this._charge.getChildNodeCount()>0){this._charge.removePlaceHolder()}else{this._charge.getPlaceHolder().setActive(false)}this.refresh()};BX.Crm.EditorDragContainerController.prototype.getContextId=function(){return this._charge.getContextId()};BX.Crm.EditorDragContainerController.prototype.getPriority=function(){return this._charge.getPriority()};BX.Crm.EditorDragContainerController.prototype.isAllowedContext=function(t){return t===this._charge.getContextId()};BX.Crm.EditorDragContainerController.refresh=function(t){for(var e in this.items){if(!this.items.hasOwnProperty(e)){continue}var i=this.items[e];if(i.getContextId()===t){i.refresh()}}};BX.Crm.EditorDragContainerController.refreshAfter=function(t,e){e=parseInt(e);if(e>0){window.setTimeout(function(){BX.Crm.EditorDragContainerController.refresh(t)},e)}else{this.refresh(t)}};BX.Crm.EditorDragContainerController.refreshAll=function(){for(var t in this.items){if(!this.items.hasOwnProperty(t)){continue}this.items[t].refresh()}};BX.Crm.EditorDragContainerController.enable=function(t,e){for(var i in this.items){if(!this.items.hasOwnProperty(i)){continue}var n=this.items[i];if(n.getContextId()===t){n.enable(e)}}};BX.Crm.EditorDragContainerController.items={};BX.Crm.EditorDragContainerController.create=function(t,e){var i=new BX.Crm.EditorDragContainerController;i.initialize(t,e);this.items[i.getId()]=i;return i}}if(typeof BX.Crm.EditorDragPlaceholder==="undefined"){BX.Crm.EditorDragPlaceholder=function(){this._settings=null;this._container=null;this._node=null;this._isDragOver=false;this._isActive=false;this._index=-1;this._timeoutId=null};BX.Crm.EditorDragPlaceholder.prototype={initialize:function(t){this._settings=t?t:{};this._container=this.getSetting("container",null);this._isActive=this.getSetting("isActive",false);this._index=parseInt(this.getSetting("index",-1))},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getContainer:function(){return this._container},setContainer:function(t){this._container=t},isDragOver:function(){return this._isDragOver},isActive:function(){return this._isActive},setActive:function(t,e){if(this._timeoutId!==null){window.clearTimeout(this._timeoutId);this._timeoutId=null}e=parseInt(e);if(e>0){var i=this;window.setTimeout(function(){if(i._timeoutId===null)return;i._timeoutId=null;i.setActive(t,0)},e);return}t=!!t;if(this._isActive===t){return}this._isActive=t;if(this._node){}},getIndex:function(){return this._index},prepareNode:function(){return null},layout:function(){this._node=this.prepareNode();var t=this.getSetting("anchor",null);if(t){this._container.insertBefore(this._node,t)}else{this._container.appendChild(this._node)}BX.bind(this._node,"dragover",BX.delegate(this._onDragOver,this));BX.bind(this._node,"dragleave",BX.delegate(this._onDragLeave,this))},clearLayout:function(){if(this._node){this._node.style.height=0;setTimeout(BX.proxy(function(){this._node=BX.remove(this._node)},this),100)}},getPosition:function(){return BX.pos(this._node)},_onDragOver:function(t){t=t||window.event;this._isDragOver=true;return BX.eventReturnFalse(t)},_onDragLeave:function(t){t=t||window.event;this._isDragOver=false;return BX.eventReturnFalse(t)}}}if(typeof BX.Crm.EditorDragFieldPlaceholder==="undefined"){BX.Crm.EditorDragFieldPlaceholder=function(){};BX.extend(BX.Crm.EditorDragFieldPlaceholder,BX.Crm.EditorDragPlaceholder);BX.Crm.EditorDragFieldPlaceholder.prototype.prepareNode=function(){return BX.create("div",{attrs:{className:"crm-entity-widget-content-block-place"}})};BX.Crm.EditorDragFieldPlaceholder.create=function(t){var e=new BX.Crm.EditorDragFieldPlaceholder;e.initialize(t);return e}}if(typeof BX.Crm.EditorDragSectionPlaceholder==="undefined"){BX.Crm.EditorDragSectionPlaceholder=function(){};BX.extend(BX.Crm.EditorDragSectionPlaceholder,BX.Crm.EditorDragPlaceholder);BX.Crm.EditorDragSectionPlaceholder.prototype.prepareNode=function(){return BX.create("div",{attrs:{className:"crm-entity-card-widget crm-entity-card-widget-place"}})};BX.Crm.EditorDragSectionPlaceholder.create=function(t){var e=new BX.Crm.EditorDragSectionPlaceholder;e.initialize(t);return e}}if(typeof BX.Crm.EntityUserFieldType==="undefined"){BX.Crm.EntityUserFieldType={string:"string",integer:"integer",double:"double",boolean:"boolean",money:"money",date:"date",datetime:"datetime",enumeration:"enumeration",employee:"employee",crm:"crm",crmStatus:"crm_status",file:"file",url:"url"}}if(typeof BX.Crm.EntityUserFieldManager==="undefined"){BX.Crm.EntityUserFieldManager=function(){this._id="";this._settings={};this._entityId=0;this._fieldEntityId="";this._enableCreation=false;this._creationSignature="";this._creationUrl="";this._activeFields={};this._validationResult=null;this._validationPromise=null;this._config=null};BX.Crm.EntityUserFieldManager.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._entityId=BX.prop.getInteger(this._settings,"entityId",0);this._fieldEntityId=BX.prop.getString(this._settings,"fieldEntityId","");this._enableCreation=BX.prop.getBoolean(this._settings,"enableCreation",false);this._creationSignature=BX.prop.getString(this._settings,"creationSignature","");this._creationPageUrl=BX.prop.getString(this._settings,"creationPageUrl","")},isCreationEnabled:function(){return this._enableCreation},isModificationEnabled:function(){return this._enableCreation},getDefaultFieldLabel:function(t){if(t==="string"){return this.getMessage("stringLabel")}else if(t==="double"){return this.getMessage("doubleLabel")}else if(t==="money"){return this.getMessage("moneyLabel")}else if(t==="datetime"){return this.getMessage("datetimeLabel")}else if(t==="enumeration"){return this.getMessage("enumerationLabel")}else if(t==="file"){return this.getMessage("fileLabel")}return this.getMessage("label")},getMessage:function(t){var e=BX.Crm.EntityUserFieldManager.messages;return e.hasOwnProperty(t)?e[t]:t},getAdditionalTypeList:function(){return BX.Crm.EntityUserFieldManager.additionalTypeList},getTypeInfos:function(){var t=[];t.push({name:"string",title:this.getMessage("stringTitle"),legend:this.getMessage("stringLegend")});t.push({name:"enumeration",title:this.getMessage("enumerationTitle"),legend:this.getMessage("enumerationLegend")});t.push({name:"datetime",title:this.getMessage("datetimeTitle"),legend:this.getMessage("datetimeLegend")});t.push({name:"address",title:this.getMessage("addressTitle"),legend:this.getMessage("addressLegend")});if(this._fieldEntityId==="CRM_LEAD"||this._fieldEntityId==="CRM_DEAL"){t.push({name:"resourcebooking",title:this.getMessage("resourcebookingTitle"),legend:this.getMessage("resourcebookingLegend")})}t.push({name:"url",title:this.getMessage("urlTitle"),legend:this.getMessage("urlLegend")});t.push({name:"file",title:this.getMessage("fileTitle"),legend:this.getMessage("fileLegend")});t.push({name:"money",title:this.getMessage("moneyTitle"),legend:this.getMessage("moneyLegend")});t.push({name:"boolean",title:this.getMessage("booleanTitle"),legend:this.getMessage("booleanLegend")});t.push({name:"double",title:this.getMessage("doubleTitle"),legend:this.getMessage("doubleLegend")});var e=this.getAdditionalTypeList();for(var i=0;i<e.length;i++){t.push({name:e[i].USER_TYPE_ID,title:e[i].TITLE,legend:e[i].LEGEND})}t.push({name:"custom",title:this.getMessage("customTitle"),legend:this.getMessage("customLegend")});return t},getCreationPageUrl:function(){return this._creationPageUrl},createField:function(t,e){if(!this._enableCreation){return}var i=BX.prop.getString(t,"USER_TYPE_ID","");if(i===""){i=BX.Crm.EntityUserFieldType.string}if(!BX.type.isNotEmptyString(t["EDIT_FORM_LABEL"])){t["EDIT_FORM_LABEL"]=this.getDefaultFieldLabel(i)}if(!BX.type.isNotEmptyString(t["LIST_COLUMN_LABEL"])){t["LIST_COLUMN_LABEL"]=t["EDIT_FORM_LABEL"]}if(!BX.type.isNotEmptyString(t["LIST_FILTER_LABEL"])){t["LIST_FILTER_LABEL"]=t["LIST_COLUMN_LABEL"]}this.addFieldLabel("EDIT_FORM_LABEL",t["EDIT_FORM_LABEL"],t);this.addFieldLabel("LIST_COLUMN_LABEL",t["LIST_COLUMN_LABEL"],t);this.addFieldLabel("LIST_FILTER_LABEL",t["LIST_FILTER_LABEL"],t);var n=new BX.Promise;var r=function(t){n.fulfill(t)};if(!BX.type.isNotEmptyString(t["FIELD"])){t["FIELD"]="UF_CRM_"+(new Date).getTime().toString()}t["ENTITY_ID"]=this._fieldEntityId;t["SIGNATURE"]=this._creationSignature;if(!BX.type.isNotEmptyString(t["MULTIPLE"])){t["MULTIPLE"]="N"}if(!BX.type.isNotEmptyString(t["MANDATORY"])){t["MANDATORY"]="N"}if(i===BX.Crm.EntityUserFieldType.file){t["SHOW_FILTER"]="N";t["SHOW_IN_LIST"]="N"}else{if(i===BX.Crm.EntityUserFieldType.employee||i===BX.Crm.EntityUserFieldType.crm||i===BX.Crm.EntityUserFieldType.crmStatus){t["SHOW_FILTER"]="I"}else{t["SHOW_FILTER"]="E"}t["SHOW_IN_LIST"]="Y"}if(i===BX.Crm.EntityUserFieldType.enumeration){if(!t.hasOwnProperty("SETTINGS")){t["SETTINGS"]={}}t["SETTINGS"]["DISPLAY"]="UI"}if(i===BX.Crm.EntityUserFieldType.boolean){if(!t.hasOwnProperty("SETTINGS")){t["SETTINGS"]={}}t["SETTINGS"]["LABEL_CHECKBOX"]=t["EDIT_FORM_LABEL"]}if(i===BX.Crm.EntityUserFieldType.double){if(!t.hasOwnProperty("SETTINGS")){t["SETTINGS"]={}}t["SETTINGS"]["PRECISION"]=2}if(e===BX.Crm.EntityEditorMode.view){BX.Main.UF.ViewManager.add({FIELDS:[t]},r)}else{BX.Main.UF.EditManager.add({FIELDS:[t]},r)}return n},updateField:function(t,e){t["ENTITY_ID"]=this._fieldEntityId;t["SIGNATURE"]=this._creationSignature;if(BX.type.isNotEmptyString(t["EDIT_FORM_LABEL"])){this.addFieldLabel("EDIT_FORM_LABEL",t["EDIT_FORM_LABEL"],t)}if(BX.type.isNotEmptyString(t["LIST_COLUMN_LABEL"])){this.addFieldLabel("LIST_COLUMN_LABEL",t["LIST_COLUMN_LABEL"],t)}if(BX.type.isNotEmptyString(t["LIST_FILTER_LABEL"])){this.addFieldLabel("LIST_FILTER_LABEL",t["LIST_FILTER_LABEL"],t)}var i=new BX.Promise;var n=function(t){i.fulfill(t)};if(e===BX.Crm.EntityEditorMode.view){BX.Main.UF.ViewManager.update({FIELDS:[t]},n)}else{BX.Main.UF.EditManager.update({FIELDS:[t]},n)}return i},resolveFieldName:function(t){return BX.prop.getString(t,"FIELD","")},addFieldLabel:function(t,e,i){var n=BX.prop.getArray(this._settings,"languages",[]);if(n.length===0){i[t]=e;return}i[t]={};for(var r=0,o=n.length;r<o;r++){var s=n[r];i[t][s["LID"]]=e}},prepareSchemeElementSettings:function(t){var e=BX.prop.getString(t,"FIELD","");if(e===""){return null}if(BX.prop.getString(t,"USER_TYPE_ID","")===""){t["USER_TYPE_ID"]="string"}if(BX.prop.getString(t,"ENTITY_ID","")===""){t["ENTITY_ID"]=this._fieldEntityId}if(BX.prop.getInteger(t,"ENTITY_VALUE_ID",0)<=0){t["ENTITY_VALUE_ID"]=this._entityId}return{name:e,originalTitle:BX.prop.getString(t,"EDIT_FORM_LABEL",e),title:BX.prop.getString(t,"EDIT_FORM_LABEL",e),type:"userField",required:BX.prop.getString(t,"MANDATORY","N")==="Y",data:{fieldInfo:t}}},createSchemeElement:function(t){return BX.Crm.EntitySchemeElement.create(this.prepareSchemeElementSettings(t))},updateSchemeElement:function(t,e){var i=this.prepareSchemeElementSettings(e);i["title"]=t.getTitle();t.mergeSettings(i)},registerActiveField:function(t){var e=t.getName();this._activeFields[e]=t;BX.Main.UF.EditManager.registerField(e,t.getFieldInfo(),t.getFieldNode())},unregisterActiveField:function(t){var e=t.getName();if(this._activeFields.hasOwnProperty(e)){delete this._activeFields[e]}BX.Main.UF.EditManager.unRegisterField(e)},validate:function(t){var e=[];for(var i in this._activeFields){if(this._activeFields.hasOwnProperty(i)){e.push(i)}}if(e.length>0){this._validationResult=t;BX.Main.UF.EditManager.validate(e,BX.delegate(this.onValidationComplete,this))}else{window.setTimeout(BX.delegate(function(){if(this._validationPromise){this._validationPromise.fulfill();this._validationPromise=null}},this),0)}this._validationPromise=new BX.Promise;return this._validationPromise},onValidationComplete:function(t){var e;for(e in this._activeFields){if(this._activeFields.hasOwnProperty(e)){this._activeFields[e].clearError()}}for(e in t){if(!t.hasOwnProperty(e)){continue}if(this._activeFields.hasOwnProperty(e)){var i=this._activeFields[e];i.showError(t[e]);this._validationResult.addError(BX.Crm.EntityValidationError.create({field:i}))}}if(this._validationPromise){this._validationPromise.fulfill()}this._validationResult=null;this._validationPromise=null}};if(typeof BX.Crm.EntityUserFieldManager.messages==="undefined"){BX.Crm.EntityUserFieldManager.messages={}}BX.Crm.EntityUserFieldManager.items={};BX.Crm.EntityUserFieldManager.create=function(t,e){var i=new BX.Crm.EntityUserFieldManager;i.initialize(t,e);this.items[t]=i;return i}}if(typeof BX.Crm.EntityUserFieldLayoutLoader==="undefined"){BX.Crm.EntityUserFieldLayoutLoader=function(){this._id="";this._settings={};this._mode=BX.Crm.EntityEditorMode.view;this._enableBatchMode=true;this._owner=null;this._items=[]};BX.Crm.EntityUserFieldLayoutLoader.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._mode=BX.prop.getInteger(this._settings,"mode",BX.Crm.EntityEditorMode.view);this._enableBatchMode=BX.prop.getBoolean(this._settings,"enableBatchMode",true);this._owner=BX.prop.get(this._settings,"owner",null)},getId:function(){return this._id},getOwner:function(){return this._owner},addItem:function(t){this._items.push(t)},run:function(){if(!this._enableBatchMode){this.startRequest()}},runBatch:function(){if(this._enableBatchMode){this.startRequest()}},startRequest:function(){if(this._items.length===0){return}var t=[];for(var e=0,i=this._items.length;e<i;e++){if(BX.prop.getString(this._items[e],"name","")!==""){t.push(BX.prop.getObject(this._items[e],"field",{}))}}if(t.length===0){return}var n={FIELDS:t,FORM:this._id,CONTEXT:"CRM_EDITOR"};if(this._mode===BX.Crm.EntityEditorMode.view){BX.Main.UF.Manager.getView(n,BX.delegate(this.onRequestComplete,this))}else{BX.Main.UF.Manager.getEdit(n,BX.delegate(this.onRequestComplete,this))}},onRequestComplete:function(t){for(var e=0,i=this._items.length;e<i;e++){var n=this._items[e];var r=BX.prop.getString(n,"name","");var o=BX.prop.getFunction(n,"callback",null);if(r!==""&&o!==null){o(BX.prop.getObject(t,r,{}))}}}};BX.Crm.EntityUserFieldLayoutLoader.create=function(t,e){var i=new BX.Crm.EntityUserFieldLayoutLoader;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorDupManager==="undefined"){BX.Crm.EntityEditorDupManager=function(){this._id="";this._settings=null;this._groupInfos=null;this._isEnabled=false;this._serviceUrl="";this._entityTypeName="";this._form=null;this._controller=null};BX.Crm.EntityEditorDupManager.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._isEnabled=BX.prop.getBoolean(this._settings,"enabled","");if(!this._isEnabled){return}this._groupInfos=BX.prop.getObject(this._settings,"groups",{});this._serviceUrl=BX.prop.getString(this._settings,"serviceUrl","");this._entityTypeName=BX.prop.getString(this._settings,"entityTypeName","");this._form=BX.prop.get(this._settings,"form",null);this._controller=BX.CrmDupController.create(this._id,{serviceUrl:this._serviceUrl,entityTypeName:this._entityTypeName,form:this._form,searcSummaryPosition:"right"})},isEnabled:function(){return this._isEnabled},search:function(){this._controller.initialSearch()},getGroupInfo:function(t){return this._groupInfos.hasOwnProperty(t)?this._groupInfos[t]:null},getGroup:function(t){return this._isEnabled?this._controller.getGroup(t):null},ensureGroupRegistered:function(t){if(!this._isEnabled){return null}var e=this.getGroup(t);if(!e){e=this._controller.registerGroup(t,this.getGroupInfo(t))}return e},registerField:function(t){if(!this._isEnabled){return null}var e=BX.prop.getString(t,"groupId","");var i=BX.prop.getObject(t,"field",null);if(e===""||!i){return null}var n=this.ensureGroupRegistered(e);if(!n){return null}return n.registerField(i)},unregisterField:function(t){if(!this._isEnabled){return}var e=BX.prop.getString(t,"groupId","");var i=BX.prop.getObject(t,"field",null);if(e===""||!i){return}var n=this.getGroup(e);if(!n){return}n.unregisterField(i)}};BX.Crm.EntityEditorDupManager.create=function(t,e){var i=new BX.Crm.EntityEditorDupManager;i.initialize(t,e);return i}}if(typeof BX.Crm.EditorTextHelper==="undefined"){BX.Crm.EditorTextHelper=function(){};BX.Crm.EditorTextHelper.prototype={selectAll:function(t){if(!(BX.type.isElementNode(t)&&t.value.length>0)){return}if(BX.type.isFunction(t.setSelectionRange)){t.setSelectionRange(0,t.value.length)}else{t.select()}},setPositionAtEnd:function(t){if(BX.type.isElementNode(t)&&t.value.length>0){BX.setCaretPosition(t,t.value.length)}}};BX.Crm.EditorTextHelper._current=null;BX.Crm.EditorTextHelper.getCurrent=function(){if(!this._current){this._current=new BX.Crm.EditorTextHelper}return this._current}}if(typeof BX.Crm.EntityEditorVisibilityPolicy==="undefined"){BX.Crm.EntityEditorVisibilityPolicy={always:0,view:1,edit:2,parse:function(t){t=t.toLowerCase();if(t==="view"){return this.view}else if(t==="edit"){return this.edit}return this.always},checkVisibility:function(t){var e=t.getMode();var i=t.getVisibilityPolicy();if(i===this.view){return e===BX.Crm.EntityEditorMode.view}else if(i===this.edit){return e===BX.Crm.EntityEditorMode.edit}return true}}}if(typeof BX.Crm.EntityEditorControl==="undefined"){BX.Crm.EntityEditorControl=function(){this._id="";this._settings={};this._editor=null;this._parent=null;this._mode=BX.Crm.EntityEditorMode.intermediate;this._modeOptions=BX.Crm.EntityEditorModeOptions.none;this._model=null;this._schemeElement=null;this._container=null;this._wrapper=null;this._dragButton=null;this._dragItem=null;this._hasLayout=false;this._isValidLayout=false;this._isVisible=true;this._isActive=false;this._isChanged=false;this._isSchemeChanged=false;this._changeHandler=BX.delegate(this.onChange,this);this._modeChangeNotifier=null;this._contextMenuButton=null;this._isContextMenuOpened=false;this._draggableContextId=""};BX.Crm.EntityEditorControl.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._editor=BX.prop.get(this._settings,"editor",null);this._parent=BX.prop.get(this._settings,"parent",null);this._model=BX.prop.get(this._settings,"model",null);this._schemeElement=BX.prop.get(this._settings,"schemeElement",null);this._container=BX.prop.getElementNode(this._settings,"container",null);var i=BX.prop.getInteger(this._settings,"mode",BX.Crm.EntityEditorMode.view);if(i===BX.Crm.EntityEditorMode.edit&&this._schemeElement&&!this._schemeElement.isEditable()){i=BX.Crm.EntityEditorMode.view}this._mode=i;this.doInitialize();this.bindModel()},doInitialize:function(){},bindModel:function(){},unbindModel:function(){},getMessage:function(t){var e=BX.Crm.EntityEditorControl.messages;return e.hasOwnProperty(t)?e[t]:t},getId:function(){return this._id},getEditor:function(){return this._editor},setEditor:function(t){this._editor=t},getParentPosition:function(){var t=this.getParent();return t?t.getPosition():{top:0,right:0,bottom:0,left:0,width:0,height:0}},getParent:function(){return this._parent},setParent:function(t){this._parent=t},getSiblingByIndex:function(t){return this._editor?this._editor.getControlByIndex(t):null},getChildCount:function(){return 0},getChildById:function(t){return null},editChild:function(t){},removeChild:function(t){},getChildren:function(){return[]},editChildConfiguration:function(t){},areAttributesEnabled:function(){return this._schemeElement&&this._schemeElement.areAttributesEnabled()},getType:function(){return this._schemeElement?this._schemeElement.getType():""},getName:function(){return this._schemeElement?this._schemeElement.getName():""},getTitle:function(){if(!this._schemeElement){return""}var t=this._schemeElement.getTitle();if(t===""){t=this._schemeElement.getName()}return t},setTitle:function(t){if(!this._schemeElement){return}this._schemeElement.setTitle(t);this.refreshTitleLayout()},getOptionFlags:function(){return this._schemeElement?this._schemeElement.getOptionFlags():BX.Crm.EntityEditorControlOptions.none},setOptionFlags:function(t){if(this._schemeElement){this._schemeElement.setOptionFlags(t)}},toggleOptionFlag:function(t){var e=this.getOptionFlags();if(BX.Crm.EntityEditorControlOptions.check(e,t)){e&=~t}else{e|=t}this.setOptionFlags(e)},checkOptionFlag:function(t){return BX.Crm.EntityEditorControlOptions.check(this.getOptionFlags(),t)},getData:function(){return this._schemeElement?this._schemeElement.getData():{}},isVisible:function(){if(!this._isVisible){return false}if(this.checkOptionFlag(BX.Crm.EntityEditorControlOptions.showAlways)){return true}return BX.Crm.EntityEditorVisibilityPolicy.checkVisibility(this)},setVisible:function(t){t=!!t;if(this._isVisible===t){return}this._isVisible=t;if(this._hasLayout){this._wrapper.style.display=this._isVisible?"":"none"}},isActive:function(){return this._isActive},setActive:function(t){t=!!t;if(this._isActive===t){return}this._isActive=t;this.doSetActive()},doSetActive:function(){},isEditable:function(){return this._schemeElement&&this._schemeElement.isEditable()},isRequired:function(){return this._schemeElement&&this._schemeElement.isRequired()},isRequiredConditionally:function(){return this._schemeElement&&this._schemeElement.isRequiredConditionally()},isHeading:function(){return this._schemeElement&&this._schemeElement.isHeading()},getCreationPlaceholder:function(){return this._schemeElement?this._schemeElement.getCreationPlaceholder():""},isReadOnly:function(){return this._editor&&this._editor.isReadOnly()},getVisibilityPolicy:function(){if(this._editor&&!this._editor.isVisibilityPolicyEnabled()){return BX.Crm.EntityEditorVisibilityPolicy.always}return this._schemeElement&&this._schemeElement.getVisibilityPolicy()},getEditPriority:function(){return BX.Crm.EntityEditorPriority.normal},getPosition:function(){return BX.pos(this._wrapper)},focus:function(){},save:function(){},validate:function(t){return true},rollback:function(){},isDragEnabled:function(){if(!this._editor){return false}if(!this._editor.canChangeScheme()){return false}return BX.prop.getBoolean(BX.prop.getObject(this._editor.getDragConfig(this.getDragObjectType()),"modes",{}),BX.Crm.EntityEditorMode.getName(this._mode),false)},isContextMenuEnabled:function(){if(this._editor&&!(this._editor.isFieldsContextMenuEnabled()&&this._editor.canChangeScheme())){return false}return this._schemeElement.isContextMenuEnabled()},getMode:function(){return this._mode},setMode:function(t,e){if(!this.canChangeMode(t)){return}var i=BX.prop.getInteger(e,"options",BX.Crm.EntityEditorModeOptions.none);if(this._mode===t&&this._modeOptions===i){return}this.onBeforeModeChange();this._mode=t;this._modeOptions=i;this.doSetMode(this._mode);this.onAfterModeChange();if(BX.prop.getBoolean(e,"notify",false)){if(this._parent){this._parent.processChildControlModeChange(this)}else if(this._editor){this._editor.processControlModeChange(this)}}this._isSchemeChanged=false;this._isChanged=false;if(this._hasLayout){this._isValidLayout=false}},getModeChangeNotifier:function(){if(!this._modeChangeNotifier){this._modeChangeNotifier=BX.CrmNotifier.create(this)}return this._modeChangeNotifier},onBeforeModeChange:function(){},doSetMode:function(t){},onAfterModeChange:function(){if(this._modeChangeNotifier){this._modeChangeNotifier.notify()}},canChangeMode:function(t){if(t===BX.Crm.EntityEditorMode.edit){return this.isEditable()}return true},isModeToggleEnabled:function(){return this._editor.isModeToggleEnabled()},toggleMode:function(t,e){if(!this.isModeToggleEnabled()){return false}this.setMode(this._mode===BX.Crm.EntityEditorMode.view?BX.Crm.EntityEditorMode.edit:BX.Crm.EntityEditorMode.view,{notify:t});if(BX.prop.getBoolean(e,"refreshLayout",true)){this.refreshLayout()}return true},isEditInViewEnabled:function(){return this._editor&&this._editor.isEditInViewEnabled()&&this.getDataBooleanParam("enableEditInView",false)},isSingleEditEnabled:function(){return this.isModeToggleEnabled()&&this.isEditable()&&!this.getDataBooleanParam("enableEditInView",false)&&this.getDataBooleanParam("enableSingleEdit",true)},isInSingleEditMode:function(){if(!this.isInEditMode()){return false}return this.checkModeOption(BX.Crm.EntityEditorModeOptions.exclusive)||this.checkModeOption(BX.Crm.EntityEditorModeOptions.individual)},isInEditMode:function(){return this._mode===BX.Crm.EntityEditorMode.edit},isInViewMode:function(){return this._mode===BX.Crm.EntityEditorMode.view},checkModeOption:function(t){return BX.Crm.EntityEditorModeOptions.check(this._modeOptions,t)},getContextId:function(){return this._editor?this._editor.getContextId():""},getExternalContextId:function(){return this._editor?this._editor.getExternalContextId():""},processAvailableSchemeElementsChange:function(){},processChildControlModeChange:function(t){},processChildControlChange:function(t,e){},isChanged:function(){return this._isChanged},markAsChanged:function(t){if(typeof t==="undefined"){t={}}var e=BX.prop.get(t,"control",null);if(!(e&&e instanceof BX.Crm.EntityEditorControl)){e=t["control"]=this}if(!e.isInEditMode()){return}if(!this._isChanged){this._isChanged=true}this.notifyChanged(t)},isSchemeChanged:function(){return this._isSchemeChanged},markSchemeAsChanged:function(){if(this._isSchemeChanged){return}this._isSchemeChanged=true},saveScheme:function(){if(!this._isSchemeChanged){return}this.commitSchemeChanges();return this._editor.saveScheme()},commitSchemeChanges:function(){if(!this._isSchemeChanged){return}this._editor.updateSchemeElement(this._schemeElement);this._isSchemeChanged=false},getRootContainer:function(){return this._editor?this._editor.getContainer():null},getRootContainerPosition:function(){return BX.pos(this.getRootContainer())},getContainer:function(){return this._container},setContainer:function(t){this._container=t;if(this._hasLayout){this._hasLayout=false}},getWrapper:function(){return this._wrapper},enablePointerEvents:function(t){if(this._wrapper){this._wrapper.style.pointerEvents=t?"":"none"}},getModel:function(){return this._model},getSchemeElement:function(){return this._schemeElement},hasScheme:function(){return!!this._schemeElement},getDataBooleanParam:function(t,e){return this._schemeElement?this._schemeElement.getDataBooleanParam(t,e):e},hasLayout:function(){return this._hasLayout},layout:function(t){},registerLayout:function(t){if(!this._wrapper){return}this._wrapper.setAttribute("data-cid",this.getId());if(this.isInViewMode()&&this._parent&&this._parent.isInEditMode()){BX.addClass(this._wrapper,"crm-entity-widget-content-block-field-readonly")}else{BX.removeClass(this._wrapper,"crm-entity-widget-content-block-field-readonly")}if(typeof t==="undefined"){t={}}if(!BX.prop.getBoolean(t,"preservePosision",false)){var e=BX.prop.getElementNode(t,"anchor",null);if(e){BX.addClass(this._wrapper,"crm-entity-widget-content-hide");this._container.insertBefore(this._wrapper,e);setTimeout(BX.delegate(function(){BX.removeClass(this._wrapper,"crm-entity-widget-content-hide");BX.addClass(this._wrapper,"crm-entity-widget-content-show")},this),1);setTimeout(BX.delegate(function(){BX.removeClass(this._wrapper,"crm-entity-widget-content-show")},this),310)}else{this._container.appendChild(this._wrapper)}}this._isValidLayout=true;this.doRegisterLayout()},doRegisterLayout:function(){},refreshLayout:function(t){if(!this._hasLayout){return}this.closeContextMenu();this.clearLayout({preservePosision:true});if(!BX.type.isPlainObject(t)){t={}}t["preservePosision"]=true;this.layout(t)},clearLayout:function(t){},refreshTitleLayout:function(){},releaseLayout:function(){this._wrapper=null},release:function(){},reset:function(){},hide:function(){if(this.isRequired()||this.isRequiredConditionally()){return}if(this._parent){BX.addClass(this._wrapper,"crm-entity-widget-content-hide");setTimeout(BX.delegate(function(){this._parent.removeChild(this)},this),350)}else{this.clearLayout()}},showMessageDialog:function(t,e,i){if(this._editor){this._editor.showMessageDialog(t,e,i)}},prepareSaveData:function(t){},onBeforeSubmit:function(){},onHideButtonClick:function(t){this.hide()},onContextButtonClick:function(t){if(!this._isContextMenuOpened){this.openContextMenu()}else{this.closeContextMenu()}},openContextMenu:function(){if(this._isContextMenuOpened){return}var t=this.prepareContextMenuItems();if(BX.type.isArray(t)&&t.length>0){var e=BX.delegate(this.onContextMenuItemSelect,this);for(var i=0,n=t.length;i<n;i++){if(typeof t[i]["onclick"]==="undefined"){t[i]["onclick"]=e}}BX.PopupMenu.show(this._id,this._contextMenuButton,t,{angle:false,events:{onPopupShow:BX.delegate(this.onContextMenuShow,this),onPopupClose:BX.delegate(this.onContextMenuClose,this)}})}},prepareContextMenuItems:function(){return[]},processContextMenuCommand:function(t,e){},closeContextMenu:function(){var t=BX.PopupMenu.getMenuById(this._id);if(t){t.popupWindow.close()}},onContextMenuShow:function(){this._isContextMenuOpened=true},onContextMenuClose:function(){BX.PopupMenu.destroy(this._id);this._isContextMenuOpened=false},onContextMenuItemSelect:function(t,e){this.processContextMenuCommand(t,BX.prop.getString(e,"value"))},onChange:function(t){this.markAsChanged()},notifyChanged:function(t){if(typeof t==="undefined"){t={}}if(this._parent){this._parent.processChildControlChange(this,t)}else if(this._editor){this._editor.processControlChange(this,t)}},getDragObjectType:function(){return BX.Crm.EditorDragObjectType.intermediate},getChildDragObjectType:function(){return BX.Crm.EditorDragObjectType.intermediate},getDragScope:function(){if(this._parent){return this._parent.getChildDragScope()}if(!this._editor){return BX.Crm.EditorDragScope.getDefault()}return BX.prop.getInteger(this._editor.getDragConfig(this.getDragObjectType()),"scope",BX.Crm.EditorDragScope.getDefault())},getChildDragScope:function(){if(!this._editor){return BX.Crm.EditorDragScope.getDefault()}return BX.prop.getInteger(this._editor.getDragConfig(this.getChildDragObjectType()),"scope",BX.Crm.EditorDragScope.getDefault())},getDraggableContextId:function(){return this._draggableContextId},setDraggableContextId:function(t){this._draggableContextId=t},createDragButton:function(){return this._dragButton},createHideButton:function(){var t=!this.isRequired()&&!this.isRequiredConditionally();var e=BX.create("div",{props:{className:"crm-entity-widget-content-block-hide-btn",title:this.getHideButtonHint(t)}});if(t){BX.bind(e,"click",BX.delegate(this.onHideButtonClick,this))}return e},createContextMenuButton:function(){this._contextMenuButton=BX.create("div",{props:{className:"crm-entity-widget-content-block-context-menu"},events:{click:BX.delegate(this.onContextButtonClick,this)}});return this._contextMenuButton},createGhostNode:function(){return null},getHideButtonHint:function(t){return""},isWaitingForInput:function(){return false}};if(typeof BX.Crm.EntityEditorControl.messages==="undefined"){BX.Crm.EntityEditorControl.messages={}}}if(typeof BX.Crm.EntityEditorField==="undefined"){BX.Crm.EntityEditorField=function(){BX.Crm.EntityEditorField.superclass.constructor.apply(this);this._titleWrapper=null;this._singleEditButton=null;this._singleEditButtonHandler=BX.delegate(this.onSingleEditBtnClick,this);this._singleEditController=null;this._singleEditTimeoutHandle=0;this._viewController=null;this._validators=null;this._hasError=false;this._errorContainer=null;this._layoutAttributes=null;this._spotlight=null;this._dragObjectType=BX.Crm.EditorDragObjectType.field};BX.extend(BX.Crm.EntityEditorField,BX.Crm.EntityEditorControl);BX.Crm.EntityEditorField.prototype.isNewEntity=function(){return this._editor&&this._editor.isNew()};BX.Crm.EntityEditorField.prototype.configure=function(){if(this._parent){this._parent.editChildConfiguration(this)}};BX.Crm.EntityEditorField.prototype.hasAttributeConfiguration=function(t){return this._schemeElement.hasAttributeConfiguration(t)};BX.Crm.EntityEditorField.prototype.getAttributeConfiguration=function(t){return this._schemeElement.getAttributeConfiguration(t)};BX.Crm.EntityEditorField.prototype.setAttributeConfiguration=function(t){return this._schemeElement.setAttributeConfiguration(t)};BX.Crm.EntityEditorField.prototype.removeAttributeConfiguration=function(t){return this._schemeElement.removeAttributeConfiguration(t)};BX.Crm.EntityEditorField.prototype.getDuplicateControlConfig=function(){return this._schemeElement?this._schemeElement.getDataObjectParam("duplicateControl",null):null};BX.Crm.EntityEditorField.prototype.markAsChanged=function(t){BX.Crm.EntityEditorField.superclass.markAsChanged.apply(this,arguments);if(this.hasError()){this.clearError()}var e=this.getValidators();for(var i=0,n=e.length;i<n;i++){e[i].processFieldChange(this)}};BX.Crm.EntityEditorField.prototype.bindModel=function(){this._model.addChangeListener(BX.delegate(this.onModelChange,this));this._model.addLockListener(BX.delegate(this.onModelLock,this))};BX.Crm.EntityEditorField.prototype.onBeforeModeChange=function(){this._layoutAttributes=null;if(this.isInEditMode()){this._layoutAttributes={animate:"show"}}};BX.Crm.EntityEditorField.prototype.onModelChange=function(t,e){this.processModelChange(e)};BX.Crm.EntityEditorField.prototype.onModelLock=function(t,e){this.processModelLock(e)};BX.Crm.EntityEditorField.prototype.processModelChange=function(t){};BX.Crm.EntityEditorField.prototype.processModelLock=function(t){};BX.Crm.EntityEditorField.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorField.messages;return e.hasOwnProperty(t)?e[t]:BX.Crm.EntityEditorField.superclass.getMessage.apply(this,arguments)};BX.Crm.EntityEditorField.prototype.hasContentWrapper=function(){return this.getContentWrapper()!==null};BX.Crm.EntityEditorField.prototype.getContentWrapper=function(){return null};BX.Crm.EntityEditorField.prototype.getHideButtonHint=function(t){return this.getMessage(t?"hideButtonHint":"hideButtonDisabledHint")};BX.Crm.EntityEditorField.prototype.getEditButton=function(){return this._singleEditButton};BX.Crm.EntityEditorField.prototype.ensureWrapperCreated=function(t){if(!this._wrapper){this._wrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block"}})}var e=BX.prop.getArray(t,"classNames",[]);for(var i=0,n=e.length;i<n;i++){BX.addClass(this._wrapper,e[i])}return this._wrapper};BX.Crm.EntityEditorField.prototype.adjustWrapper=function(){if(!this._wrapper){return}if(this.isInEditMode()&&(this.checkModeOption(BX.Crm.EntityEditorModeOptions.exclusive)||this.checkModeOption(BX.Crm.EntityEditorModeOptions.individual))){BX.addClass(this._wrapper,"crm-entity-widget-content-block-edit")}else{BX.removeClass(this._wrapper,"crm-entity-widget-content-block-edit")}if(this._layoutAttributes){for(var t in this._layoutAttributes){if(this._layoutAttributes.hasOwnProperty(t)){this._wrapper.setAttribute("data-"+t,this._layoutAttributes[t])}}this._layoutAttributes=null}};BX.Crm.EntityEditorField.prototype.createTitleNode=function(t){this._titleWrapper=BX.create("div",{attrs:{className:"crm-entity-widget-content-block-title"}});this.prepareTitleLayout(BX.type.isNotEmptyString(t)?t:this.getTitle());return this._titleWrapper};BX.Crm.EntityEditorField.prototype.prepareTitleLayout=function(t){if(!this._titleWrapper){return}var e=BX.create("span",{attrs:{className:"crm-entity-widget-content-block-title-text"},text:t});var i=this.createTitleMarker();if(i){e.appendChild(i)}this._titleWrapper.appendChild(e);var n=this.createTitleActionControls();if(n.length>0){var r=BX.create("span",{attrs:{className:"crm-entity-widget-content-block-title-actions"}});this._titleWrapper.appendChild(r);for(var o=0,s=n.length;o<s;o++){r.appendChild(n[o])}}};BX.Crm.EntityEditorField.prototype.refreshTitleLayout=function(){if(!this._titleWrapper){return}BX.cleanNode(this._titleWrapper);this.prepareTitleLayout(this.getTitle())};BX.Crm.EntityEditorField.prototype.createTitleMarker=function(){if(this._mode===BX.Crm.EntityEditorMode.view){return null}if(this.isRequired()){return BX.create("span",{style:{color:"#f00",verticalAlign:"super"},text:"*"})}else if(this.isRequiredConditionally()){return BX.create("span",{text:"*"})}return null};BX.Crm.EntityEditorField.prototype.createEditButton=function(){if(!(this.isInViewMode()&&this.isSingleEditEnabled())){return null}if(!this._singleEditButton){this._singleEditButton=BX.create("span",{props:{className:"crm-entity-card-widget-title-edit-icon"}})}return this._singleEditButton};BX.Crm.EntityEditorField.prototype.createTitleActionControls=function(){return[]};BX.Crm.EntityEditorField.prototype.createDragButton=function(){if(!this._dragButton){this._dragButton=BX.create("div",{props:{className:"crm-entity-widget-content-block-draggable-btn-container"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-draggable-btn"}})]})}return this._dragButton};BX.Crm.EntityEditorField.prototype.createGhostNode=function(){if(!this._wrapper){return null}var t=BX.pos(this._wrapper);var e=this._wrapper.cloneNode(true);BX.addClass(e,"crm-entity-widget-content-block-drag");e.style.width=t.width+"px";e.style.height=t.height+"px";return e};BX.Crm.EntityEditorField.prototype.clearLayout=function(t){if(!this._hasLayout){return}this.releaseLightingAbilities();BX.Crm.EntityEditorField.superclass.clearLayout.apply(this,arguments);if(!BX.type.isPlainObject(t)){t={}}this.releaseDragDropAbilities();this.releaseSwitchingAbilities();if(!BX.prop.getBoolean(t,"preservePosision",false)){this._wrapper=BX.remove(this._wrapper)}else{BX.removeClass(this._wrapper,"crm-entity-widget-content-block-click-editable");BX.removeClass(this._wrapper,"crm-entity-widget-content-block-click-empty");this._wrapper=BX.cleanNode(this._wrapper);if(this.hasError()){this.clearError()}}if(this._singleEditButton){this._singleEditButton=null}this.doClearLayout(t);this._hasLayout=false};BX.Crm.EntityEditorField.prototype.doClearLayout=function(t){};BX.Crm.EntityEditorField.prototype.registerLayout=function(t){var e=this.isVisible();var i=this.isNeedToDisplay();this._wrapper.style.display=e&&i?"":"none";this.initializeSwitchingAbilities();if(this.isInEditMode()&&this.checkModeOption(BX.Crm.EntityEditorModeOptions.individual)){window.setTimeout(BX.delegate(this.focus,this),0)}BX.Crm.EntityEditorField.superclass.registerLayout.apply(this,arguments);var n=BX.prop.getObject(t,"lighting",null);if(n){window.setTimeout(function(){this.initializeLightingAbilities(n)}.bind(this),1e3)}if(!i&&BX.prop.getBoolean(t,"notifyIfNotDisplayed",false)){BX.UI.Notification.Center.notify({content:this.getMessage("hiddenInViewMode").replace(/#TITLE#/gi,this.getTitle()),position:"top-center",autoHideDelay:5e3})}};BX.Crm.EntityEditorField.prototype.raiseLayoutEvent=function(){BX.onCustomEvent(window,"BX.Crm.EntityEditorField:onLayout",[this])};BX.Crm.EntityEditorField.prototype.hasContentToDisplay=function(){return this.hasValue()};BX.Crm.EntityEditorField.prototype.isNeedToDisplay=function(){return this._mode===BX.Crm.EntityEditorMode.edit||this.checkOptionFlag(BX.Crm.EntityEditorControlOptions.showAlways)||this.hasContentToDisplay()||this._editor&&this._editor.isNeedToDisplayEmptyFields()};BX.Crm.EntityEditorField.prototype.isWaitingForInput=function(){return this.isInEditMode()&&this.isRequired()&&!this.hasValue()};BX.Crm.EntityEditorField.prototype.hide=function(){if(!(this.isRequired()||this.isRequiredConditionally())){BX.Crm.EntityEditorField.superclass.hide.apply(this,arguments)}else{this.showMessageDialog("operationDenied",this.getMessage("hideDeniedDlgTitle"),this.getMessage("hideDeniedDlgContent"))}};BX.Crm.EntityEditorField.prototype.getEditPriority=function(){var t=this.hasValue();if(!t&&(this.isRequired()||this.isRequiredConditionally())){return BX.Crm.EntityEditorPriority.high}if(!this._editor.isNew()){return BX.Crm.EntityEditorPriority.normal}return t?BX.Crm.EntityEditorPriority.high:this.doGetEditPriority()};BX.Crm.EntityEditorField.prototype.doGetEditPriority=function(){return BX.Crm.EntityEditorPriority.normal};BX.Crm.EntityEditorField.prototype.checkIfNotEmpty=function(t){return BX.util.trim(t)!==""};BX.Crm.EntityEditorField.prototype.setupFromModel=function(t,e){if(!t||!this._model){return}var i=this.getRelatedModelData(t);this._model.updateData(i,e)};BX.Crm.EntityEditorField.prototype.getRelatedModelData=function(t){if(!t){t=this._model}if(!t){return{}}var e={};var i=this.getRelatedDataKeys();for(var n=0,r=i.length;n<r;n++){var o=i[n];if(o!==""){e[o]=t.getField(o,null)}}return e};BX.Crm.EntityEditorField.prototype.getRelatedDataKeys=function(){return[this.getDataKey()]};BX.Crm.EntityEditorField.prototype.hasValue=function(){return this.checkIfNotEmpty(this.getValue())};BX.Crm.EntityEditorField.prototype.getValue=function(t){if(!this._model){return""}return this._model.getField(this.getDataKey(),t!==undefined?t:"")};BX.Crm.EntityEditorField.prototype.getStringValue=function(t){return this._model?this._model.getStringField(this.getName(),t):""};BX.Crm.EntityEditorField.prototype.getRuntimeValue=function(){return""};BX.Crm.EntityEditorField.prototype.getDataKey=function(){return this.getName()};BX.Crm.EntityEditorField.prototype.prepareSaveData=function(t){t[this.getDataKey()]=this.getValue()};BX.Crm.EntityEditorField.prototype.findValidatorIndex=function(t){if(!this._validators){return-1}for(var e=0,i=this._validators.length;e<i;e++){if(this._validators[e]===t){return e}}return-1};BX.Crm.EntityEditorField.prototype.addValidator=function(t){if(t&&this.findValidatorIndex(t)<0){if(!this._validators){this._validators=[]}this._validators.push(t)}};BX.Crm.EntityEditorField.prototype.removeValidator=function(t){if(!this._validators||!t){return}var e=this.findValidatorIndex(t);if(e>=0){this._validators.splice(e,1)}};BX.Crm.EntityEditorField.prototype.getValidators=function(){return this._validators?this._validators:[]};BX.Crm.EntityEditorField.prototype.hasValidators=function(){return this._validators&&this._validators.length>0};BX.Crm.EntityEditorField.prototype.executeValidators=function(t){if(!this._validators){return true}var e=true;for(var i=0,n=this._validators.length;i<n;i++){if(!this._validators[i].validate(t)){e=false}}return e};BX.Crm.EntityEditorField.prototype.hasError=function(){return this._hasError};BX.Crm.EntityEditorField.prototype.showError=function(t,e){if(!this._errorContainer){this._errorContainer=BX.create("div",{attrs:{className:"crm-entity-widget-content-error-text"}})}this._errorContainer.innerHTML=t;this._wrapper.appendChild(this._errorContainer);BX.addClass(this._wrapper,"crm-entity-widget-content-error");this._hasError=true};BX.Crm.EntityEditorField.prototype.showRequiredFieldError=function(t){this.showError(this.getMessage("requiredFieldError"),t)};BX.Crm.EntityEditorField.prototype.clearError=function(){if(!this._hasError){return}if(this._errorContainer&&this._errorContainer.parentNode){this._errorContainer.parentNode.removeChild(this._errorContainer)}BX.removeClass(this._wrapper,"crm-entity-widget-content-error");this._hasError=false};BX.Crm.EntityEditorField.prototype.scrollAnimate=function(){var t=BX.GetDocElement(document);var e=this._wrapper;window.setTimeout(function(){new BX.easing({duration:300,start:{position:t.scrollTop},finish:{position:BX.pos(e).top-10},step:function(e){t.scrollTop=e.position}}).animate()},0)};BX.Crm.EntityEditorField.prototype.setDragObjectType=function(t){this._dragObjectType=t};BX.Crm.EntityEditorField.prototype.getDragObjectType=function(){return this._dragObjectType};BX.Crm.EntityEditorField.prototype.initializeDragDropAbilities=function(){if(this._dragItem){return}this._dragItem=BX.Crm.EditorDragItemController.create("field_"+this.getId(),{charge:BX.Crm.EditorFieldDragItem.create({control:this,contextId:this._draggableContextId,scope:this.getDragScope()}),node:this.createDragButton(),showControlInDragMode:false,ghostOffset:{x:0,y:0}})};BX.Crm.EntityEditorField.prototype.releaseDragDropAbilities=function(){if(this._dragItem){this._dragItem.release();this._dragItem=null}};BX.Crm.EntityEditorField.prototype.initializeSwitchingAbilities=function(){if(this.isInViewMode()){if(this.isSingleEditEnabled()){BX.addClass(this._wrapper,"crm-entity-widget-content-block-click-editable");if(!this.hasContentToDisplay()){BX.addClass(this._wrapper,"crm-entity-widget-content-block-click-empty")}if(this._singleEditButton){BX.bind(this._singleEditButton,"click",this._singleEditButtonHandler)}}if(this.hasContentWrapper()&&BX.Crm.EntityEditorModeSwitchType.check(this.getModeSwitchType(BX.Crm.EntityEditorMode.edit),BX.Crm.EntityEditorModeSwitchType.content)){this._viewController=BX.Crm.EditorFieldViewController.create(this._id,{field:this,wrapper:this.getContentWrapper()})}}else if(this.checkModeOption(BX.Crm.EntityEditorModeOptions.exclusive)){this._singleEditController=BX.Crm.EditorFieldSingleEditController.create(this._id,{field:this})}};BX.Crm.EntityEditorField.prototype.releaseSwitchingAbilities=function(){if(this._singleEditButton){BX.unbind(this._singleEditButton,"click",this._singleEditButtonHandler)}if(this._viewController){this._viewController.release();this._viewController=null}if(this._singleEditController){this._singleEditController.release();this._singleEditController=null}};BX.Crm.EntityEditorField.prototype.initializeLightingAbilities=function(t){var e=BX.prop.getString(t,"text","");if(!BX.type.isNotEmptyString(e)){return}var i=this.getContentWrapper();if(!i){return}this._spotlight=new BX.SpotLight({id:BX.prop.getString(t,"id",""),targetElement:i,autoSave:true,content:e,targetVertex:"middle-left",zIndex:200});this._spotlight.show();var n=BX.prop.getObject(t,"events",{});for(var r in n){if(n.hasOwnProperty(r)){BX.addCustomEvent(this._spotlight,r,n[r])}}};BX.Crm.EntityEditorField.prototype.releaseLightingAbilities=function(){if(this._spotlight){this._spotlight.close();this._spotlight=null}};BX.Crm.EntityEditorField.prototype.prepareContextMenuItems=function(){var t=[];t.push({value:"hide",text:this.getMessage("hide")});t.push({value:"configure",text:this.getMessage("configure")});if(this._parent&&this._parent.hasAdditionalMenu()){var e=this._parent.getAdditionalMenu();for(var i=0;i<e.length;i++){t.push(e[i])}}t.push({value:"showAlways",text:'<label class="crm-context-menu-item-hide-empty-wrap">'+'<input type="checkbox"'+(this.checkOptionFlag(BX.Crm.EntityEditorControlOptions.showAlways)?' checked = "true"':"")+' class="crm-context-menu-item-hide-empty-input">'+'<span class="crm-context-menu-item-hide-empty-text">'+this.getMessage("showAlways")+"</span></label>"});this.doPrepareContextMenuItems(t);return t};BX.Crm.EntityEditorField.prototype.doPrepareContextMenuItems=function(t){};BX.Crm.EntityEditorField.prototype.processContextMenuCommand=function(t,e){if(e==="showAlways"){var i=BX.getEventTarget(t);if(i&&i.tagName==="INPUT"){this.toggleOptionFlag(BX.Crm.EntityEditorControlOptions.showAlways);if(this._parent){this._parent.processChildControlSchemeChange(this)}if(!this.isNeedToDisplay()){window.setTimeout(BX.delegate(this.clearLayout,this),500);BX.UI.Notification.Center.notify({content:this.getMessage("isHiddenDueToShowAlwaysChanged").replace(/#TITLE#/gi,this.getTitle()),position:"top-center",autoHideDelay:5e3});this.closeContextMenu()}}return}if(e==="hide"){window.setTimeout(BX.delegate(this.hide,this),500)}else if(e==="configure"){this.configure()}else if(this._parent&&this._parent.hasAdditionalMenu()){this._parent.processChildAdditionalMenuCommand(this,e)}this.closeContextMenu()};BX.Crm.EntityEditorField.prototype.onSingleEditBtnClick=function(t){if(!(this.isSingleEditEnabled()&&this._editor)){return}if(this._singleEditTimeoutHandle>0){window.clearTimeout(this._singleEditTimeoutHandle);this._singleEditTimeoutHandle=0}this._singleEditTimeoutHandle=window.setTimeout(BX.delegate(this.switchToSingleEditMode,this),250);BX.eventCancelBubble(t)};BX.Crm.EntityEditorField.prototype.getModeSwitchType=function(t){var e=BX.Crm.EntityEditorModeSwitchType.common;if(t===BX.Crm.EntityEditorMode.edit){e|=BX.Crm.EntityEditorModeSwitchType.button}return e};BX.Crm.EntityEditorField.prototype.switchToSingleEditMode=function(t){if(!(this.isSingleEditEnabled()&&this._editor)){return}this._singleEditTimeoutHandle=0;if(this._editor){this._editor.switchControlMode(this,BX.Crm.EntityEditorMode.edit,BX.Crm.EntityEditorModeOptions.individual)}};if(typeof BX.Crm.EntityEditorField.messages==="undefined"){BX.Crm.EntityEditorField.messages={}}}if(typeof BX.Crm.EntityEditorSection==="undefined"){BX.Crm.EntityEditorSection=function(){BX.Crm.EntityEditorSection.superclass.constructor.apply(this);this._fields=null;this._fieldConfigurator=null;this._userFieldConfigurator=null;this._mandatoryConfigurator=null;this._titleWrapper=null;this._titleEditButton=null;this._titleEditHandler=BX.delegate(this.onTitleEditButtonClick,this);this._titleView=null;this._titleInput=null;this._titleMode=BX.Crm.EntityEditorMode.intermediate;this._titleInputKeyHandler=BX.delegate(this.onTitleInputKeyPress,this);this._documentClickHandler=BX.delegate(this.onExternalClick,this);this._enableToggling=true;this._toggleButton=null;this._buttonPanelWrapper=null;this._addChildButton=null;this._addChildButtonHandler=BX.delegate(this.onAddChildBtnClick,this);this._createChildButton=null;this._createChildButtonHandler=BX.delegate(this.onCreateUserFieldBtnClick,this);this._deleteButton=null;this._deleteButtonHandler=BX.delegate(this.onDeleteSectionBtnClick,this);this._detetionConfirmDlgId="section_deletion_confirm";this._childSelectMenu=null;this._fieldTypeSelectMenu=null;this._dragContainerController=null;this._dragPlaceHolder=null;this._dropHandler=BX.delegate(this.onDrop,this);this._titleActions=null;this._fieldSelector=null;this._stub=null};BX.extend(BX.Crm.EntityEditorSection,BX.Crm.EntityEditorControl);BX.Crm.EntityEditorSection.prototype.doSetActive=function(){for(var t=0,e=this._fields.length;t<e;t++){this._fields[t].setActive(this._isActive)}};BX.Crm.EntityEditorSection.prototype.initialize=function(t,e){BX.Crm.EntityEditorSection.superclass.initialize.call(this,t,e);this._draggableContextId=BX.Crm.EditorFieldDragItem.contextId;if(this.getChildDragScope()===BX.Crm.EditorDragScope.parent){this._draggableContextId+="_"+this.getId()}this.initializeFromModel()};BX.Crm.EntityEditorSection.prototype.initializeFromModel=function(){var t,e;if(this._fields){for(t=0,e=this._fields.length;t<e;t++){this._fields[t].release()}}this._fields=[];var i=this._schemeElement.getElements();for(t=0,e=i.length;t<e;t++){var n=i[t];var r=this._editor.createControl(n.getType(),n.getName(),{schemeElement:n,model:this._model,parent:this});if(!r){continue}n.setParent(this._schemeElement);r.setMode(this._mode,{notify:false});this._fields.push(r)}};BX.Crm.EntityEditorSection.prototype.createDragButton=function(){if(!this._dragButton){this._dragButton=BX.create("div",{props:{className:"crm-entity-card-widget-draggable-btn-container"},children:[BX.create("div",{props:{className:"crm-entity-card-widget-draggable-btn"}})]})}return this._dragButton};BX.Crm.EntityEditorSection.prototype.createGhostNode=function(){if(!this._wrapper){return null}var t=BX.pos(this._wrapper);var e=BX.create("div",{props:{className:"crm-entity-card-widget-edit"},children:[BX.create("div",{props:{className:"crm-entity-card-widget-draggable-btn-container"},children:[BX.create("div",{props:{className:"crm-entity-card-widget-draggable-btn"},children:[BX.create("div",{props:{className:"crm-entity-card-widget-draggable-btn-inner"}})]})]}),BX.create("div",{props:{className:"crm-entity-card-widget-title"},children:[BX.create("span",{props:{className:"crm-entity-card-widget-title-text"},text:this._schemeElement.getTitle()})]})]});BX.addClass(e,"crm-entity-widget-card-drag");e.style.width=t.width+"px";return e};BX.Crm.EntityEditorSection.prototype.getEditPriority=function(){for(var t=0,e=this._fields.length;t<e;t++){if(this._fields[t].getEditPriority()===BX.Crm.EntityEditorPriority.high){return BX.Crm.EntityEditorPriority.high}}return BX.Crm.EntityEditorPriority.normal};BX.Crm.EntityEditorSection.prototype.layout=function(t){var e,i;var n=this._schemeElement.getTitle();this._contentContainer=BX.create("div",{props:{className:"crm-entity-widget-content"}});var r=this._mode===BX.Crm.EntityEditorMode.view;var o=r?"crm-entity-card-widget":"crm-entity-card-widget-edit";this._enableToggling=this.isModeToggleEnabled()&&this._schemeElement.getDataBooleanParam("enableToggling",true);this._toggleButton=BX.create("span",{attrs:{className:"crm-entity-widget-hide-btn"},events:{click:BX.delegate(this.onToggleBtnClick,this)},text:this.getMessage(r?"change":"cancel")});if(!this._enableToggling){this._toggleButton.style.display="none"}this._titleMode=BX.Crm.EntityEditorMode.view;this._wrapper=BX.create("div",{props:{className:o}});if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}if(this._schemeElement.isTitleEnabled()){this._titleEditButton=BX.create("span",{props:{className:"crm-entity-card-widget-title-edit-icon"},events:{click:this._titleEditHandler}});if(!this._editor.isSectionEditEnabled()||!this._editor.canChangeScheme()){this._titleEditButton.style.display="none"}this._titleView=BX.create("span",{props:{className:"crm-entity-card-widget-title-text"},text:n});this._titleInput=BX.create("input",{props:{className:"crm-entity-card-widget-title-text"},style:{display:"none"}});this._titleActions=BX.create("div",{props:{className:"crm-entity-widget-actions-block"},children:[this._toggleButton]});this._titleWrapper=BX.create("div",{props:{className:"crm-entity-card-widget-title"},children:[BX.create("div",{style:{maxWidth:"calc(100% - 30px)",minWidth:0,flex:1},children:[this._titleView,this._titleInput,this._titleEditButton]}),this._titleActions]});this._wrapper.appendChild(this._titleWrapper)}this._wrapper.appendChild(this._contentContainer);if(!BX.type.isPlainObject(t)){t={}}var s=BX.prop.getElementNode(t,"anchor",null);if(s){this._container.insertBefore(this._wrapper,s)}else{this._container.appendChild(this._wrapper)}if(r&&this._fields.length===0){this._contentContainer.appendChild(this.createStub())}var a=BX.prop.getBoolean(t,"reset",false);var l=BX.prop.get(t,"userFieldLoader",null);if(!l){l=BX.Crm.EntityUserFieldLayoutLoader.create(this._id,{mode:this._mode,enableBatchMode:true,owner:this})}var d=BX.prop.getObject(t,"lighting",null);var h=BX.prop.getBoolean(t,"enableFocusGain",true);var p=false;for(e=0,i=this._fields.length;e<i;e++){var u=this._fields[e];u.setContainer(this._contentContainer);u.setDraggableContextId(this._draggableContextId);u.releaseLayout();if(a){u.reset()}var c={userFieldLoader:l};if(!p&&d&&u.isVisible()&&u.isNeedToDisplay()){c["lighting"]=d;p=true}u.layout(c);if(h&&!r&&u.isHeading()){u.focus()}}if(l.getOwner()===this){l.runBatch()}this._addChildButton=this._createChildButton=this._deleteButton=null;if(this._editor.canChangeScheme()&&this._schemeElement.getDataBooleanParam("showButtonPanel",true)){this._buttonPanelWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block"}});if(this._schemeElement.getDataBooleanParam("isChangeable",true)){this._addChildButton=BX.create("span",{props:{className:"crm-entity-widget-content-block-edit-action-btn"},text:this.getMessage("selectField"),events:{click:this._addChildButtonHandler}});if(!this._editor.hasAvailableSchemeElements()){this._addChildButton.style.display="none"}this._buttonPanelWrapper.appendChild(this._addChildButton);if(this._editor.getUserFieldManager().isCreationEnabled()){this._createChildButton=BX.create("span",{props:{className:"crm-entity-widget-content-block-edit-action-btn"},text:this.getMessage("createField"),events:{click:this._createChildButtonHandler}});this._buttonPanelWrapper.appendChild(this._createChildButton)}}if(this._schemeElement.getDataBooleanParam("isRemovable",true)){var m="crm-entity-widget-content-block-edit-remove-btn";if(this.isRequired()||this.isRequiredConditionally()){m="crm-entity-widget-content-block-edit-remove-btn-disabled"}this._deleteButton=BX.create("span",{props:{className:m},text:this.getMessage("deleteSection")});this._buttonPanelWrapper.appendChild(this._deleteButton);BX.bind(this._deleteButton,"click",this._deleteButtonHandler)}this._contentContainer.appendChild(this._buttonPanelWrapper)}if(this.isDragEnabled()){this._dragContainerController=BX.Crm.EditorDragContainerController.create("section_"+this.getId(),{charge:BX.Crm.EditorFieldDragContainer.create({section:this,context:this._draggableContextId}),node:this._wrapper});this._dragContainerController.addDragFinishListener(this._dropHandler);this.initializeDragDropAbilities()}var y=this._editor._controls.indexOf(this);var g={id:this._id,customNodes:[],serialNumber:y};BX.onCustomEvent(window,"BX.Crm.EntityEditorSection:onLayout",[this,g]);if(this._titleActions&&BX.type.isArray(g["customNodes"])){for(e=0,i=g["customNodes"].length;e<i;e++){var f=g["customNodes"][e];if(BX.type.isElementNode(f)){this._titleActions.appendChild(f)}}}this._hasLayout=true};BX.Crm.EntityEditorSection.prototype.clearLayout=function(){if(!this._hasLayout){return}if(this._dragContainerController){this._dragContainerController.removeDragFinishListener(this._dropHandler);this._dragContainerController.release();this._dragContainerController=null}this.releaseDragDropAbilities();for(var t=0,e=this._fields.length;t<e;t++){var i=this._fields[t];i.clearLayout();i.setContainer(null);i.setDraggableContextId("")}if(this._addChildButton){BX.unbind(this._addChildButton,"click",this._addChildButtonHandler);this._addChildButton=BX.remove(this._addChildButton)}if(this._createChildButton){BX.unbind(this._createChildButton,"click",this._createChildButtonHandler);this._createChildButton=BX.remove(this._createChildButton)}if(this._deleteButton){BX.unbind(this._deleteButton,"click",this._deleteButtonHandler);this._deleteButton=BX.remove(this._deleteButton)}if(this._buttonPanelWrapper){this._buttonPanelWrapper=BX.remove(this._buttonPanelWrapper)}this._stub=null;this._titleWrapper=null;this._wrapper=BX.remove(this._wrapper);this._hasLayout=false};BX.Crm.EntityEditorSection.prototype.refreshLayout=function(t){t=BX.type.isPlainObject(t)?BX.mergeEx({},t):{};var e=BX.prop.getFunction(t,"callback",null);delete t["callback"];delete t["anchor"];if(this._wrapper&&this._wrapper.nextSibling){t["anchor"]=this._wrapper.nextSibling}this.clearLayout();this.layout(t);if(e){e()}};BX.Crm.EntityEditorSection.prototype.createStub=function(){this._stub=BX.create("div",{props:{className:"crm-entity-widget-content-block"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-nothing-selected"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-nothing-selected-text"},text:this.getMessage("nothingSelected")})]})]});if(this.isModeToggleEnabled()){BX.bind(this._stub,"click",BX.delegate(this.onStubClick,this))}return this._stub};BX.Crm.EntityEditorSection.prototype.onStubClick=function(t){this.toggle()};BX.Crm.EntityEditorSection.prototype.hasAdditionalMenu=function(t){return false};BX.Crm.EntityEditorSection.prototype.getAdditionalMenu=function(t){return[]};BX.Crm.EntityEditorSection.prototype.processChildAdditionalMenuCommand=function(t,e){};BX.Crm.EntityEditorSection.prototype.ensureButtonPanelWrapperCreated=function(){if(!this._hasLayout){throw"EntityEditorSection: Control does not have layout."}if(!this._buttonPanelWrapper){this._buttonPanelWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block"}});this._contentContainer.appendChild(this._buttonPanelWrapper)}return this._buttonPanelWrapper};BX.Crm.EntityEditorSection.prototype.setTitleMode=function(t){if(this._titleMode===t){return}this._titleMode=t;if(!this._schemeElement.isTitleEnabled()){return}if(this._titleMode===BX.Crm.EntityEditorMode.view){this._titleView.style.display="";this._titleInput.style.display="none";this._titleEditButton.style.display="";var e=this._titleInput.value;this._titleView.innerHTML=BX.util.htmlspecialchars(e);this._schemeElement.setTitle(e);this.markSchemeAsChanged();this.saveScheme();BX.unbind(this._titleInput,"keyup",this._titleInputKeyHandler);BX.unbind(window.document,"click",this._documentClickHandler)}else{this._titleView.style.display="none";this._titleInput.style.display="";this._titleEditButton.style.display="none";this._titleInput.value=this._schemeElement.getTitle();BX.bind(this._titleInput,"keyup",this._titleInputKeyHandler);this._titleInput.focus();window.setTimeout(BX.delegate(function(){BX.bind(window.document,"click",this._documentClickHandler)},this),100)}};BX.Crm.EntityEditorSection.prototype.toggleTitleMode=function(){this.setTitleMode(this._titleMode===BX.Crm.EntityEditorMode.view?BX.Crm.EntityEditorMode.edit:BX.Crm.EntityEditorMode.view)};BX.Crm.EntityEditorSection.prototype.onTitleEditButtonClick=function(t){if(this._editor.isSectionEditEnabled()){this.toggleTitleMode()}};BX.Crm.EntityEditorSection.prototype.onTitleInputKeyPress=function(t){if(!t){t=window.event}if(t.keyCode===13){this.toggleTitleMode()}};BX.Crm.EntityEditorSection.prototype.onExternalClick=function(t){if(!t){t=window.event}if(this._titleInput!==BX.getEventTarget(t)){this.toggleTitleMode()}};BX.Crm.EntityEditorSection.prototype.enableToggling=function(t){t=!!t;if(this._enableToggling===t){return}this._enableToggling=t;if(this._hasLayout){this._toggleButton.style.display=this._enableToggling?"":"none"}};BX.Crm.EntityEditorSection.prototype.toggle=function(){if(this._enableToggling&&this._editor){this._editor.switchControlMode(this,this._mode===BX.Crm.EntityEditorMode.view?BX.Crm.EntityEditorMode.edit:BX.Crm.EntityEditorMode.view)}};BX.Crm.EntityEditorSection.prototype.onToggleBtnClick=function(t){this.toggle()};BX.Crm.EntityEditorSection.prototype.onBeforeModeChange=function(){this.removeFieldConfigurator();this.removeUserFieldConfigurator()};BX.Crm.EntityEditorSection.prototype.doSetMode=function(t){if(this._titleMode===BX.Crm.EntityEditorMode.edit){this.toggleTitleMode()}for(var e=0,i=this._fields.length;e<i;e++){this._fields[e].setMode(t,{notify:false})}};BX.Crm.EntityEditorSection.prototype.processAvailableSchemeElementsChange=function(){if(this._hasLayout&&BX.type.isDomNode(this._addChildButton)){this._addChildButton.style.display=this._editor.hasAvailableSchemeElements()?"":"none"}};BX.Crm.EntityEditorSection.prototype.validate=function(t){if(this._mode!==BX.Crm.EntityEditorMode.edit){return true}var e=BX.Crm.EntityValidationResult.create();for(var i=0,n=this._fields.length;i<n;i++){var r=this._fields[i];if(r.getMode()!==BX.Crm.EntityEditorMode.edit){continue}r.validate(e)}t.addResult(e);return e.getStatus()};BX.Crm.EntityEditorSection.prototype.commitSchemeChanges=function(){if(this._isSchemeChanged){var t=[];for(var e=0,i=this._fields.length;e<i;e++){var n=this._fields[e].getSchemeElement();if(n){t.push(n)}}this._schemeElement.setElements(t)}return BX.Crm.EntityEditorSection.superclass.commitSchemeChanges.call(this)};BX.Crm.EntityEditorSection.prototype.save=function(){for(var t=0,e=this._fields.length;t<e;t++){this._fields[t].save()}};BX.Crm.EntityEditorSection.prototype.rollback=function(){for(var t=0,e=this._fields.length;t<e;t++){this._fields[t].rollback()}if(this._isChanged){this.initializeFromModel();this._isChanged=false}};BX.Crm.EntityEditorSection.prototype.onBeforeSubmit=function(){for(var t=0,e=this._fields.length;t<e;t++){this._fields[t].onBeforeSubmit()}};BX.Crm.EntityEditorSection.prototype.getChildIndex=function(t){for(var e=0,i=this._fields.length;e<i;e++){if(this._fields[e]===t){return e}}return-1};BX.Crm.EntityEditorSection.prototype.addChild=function(t,e){if(!BX.type.isPlainObject(e)){e={}}var i=null;var n=BX.prop.getInteger(e,"index",-1);if(n>=0){this._fields.splice(n,0,t);if(n<this._fields.length-1){i=this._fields[n+1]}}else{this._fields.push(t);i=BX.prop.get(e,"related",null)}if(t.getParent()!==this){t.setParent(this)}if(t.hasScheme()){t.getSchemeElement().setParent(this._schemeElement)}t.setActive(this._isActive);if(this._hasLayout){t.setContainer(this._contentContainer);t.setDraggableContextId(this._draggableContextId);var r=BX.prop.getObject(e,"layout",{});if(i){r["anchor"]=i.getWrapper()}else{r["anchor"]=this._buttonPanelWrapper}if(BX.prop.getBoolean(r,"forceDisplay",false)&&!t.isNeedToDisplay()&&!t.checkOptionFlag(BX.Crm.EntityEditorControlOptions.showAlways)){t.toggleOptionFlag(BX.Crm.EntityEditorControlOptions.showAlways)}t.layout(r)}if(t.hasScheme()){this._editor.processControlAdd(t);this.markSchemeAsChanged();if(BX.prop.getBoolean(e,"enableSaving",true)){this.saveScheme()}}};BX.Crm.EntityEditorSection.prototype.removeChild=function(t,e){if(!BX.type.isPlainObject(e)){e={}}var i=this.getChildIndex(t);if(i<0){return}if(t.isActive()){t.setActive(false)}this._fields.splice(i,1);var n=t.hasScheme();if(n){t.getSchemeElement().setParent(null)}if(this._hasLayout){t.clearLayout();t.setContainer(null);t.setDraggableContextId("")}if(n){this._editor.processControlRemove(t);this.markSchemeAsChanged();if(BX.prop.getBoolean(e,"enableSaving",true)){this.saveScheme()}}};BX.Crm.EntityEditorSection.prototype.moveChild=function(t,e,i){if(!BX.type.isPlainObject(i)){i={}}var n=this.getChildCount();var r=n-1;if(e<0||e>n){e=r}var o=this.getChildIndex(t);if(o<0||o===e){return false}if(this._hasLayout){t.clearLayout()}this._fields.splice(o,1);n--;var s=null;if(this._hasLayout){s=e<n?this._fields[e].getWrapper():this._buttonPanelWrapper}if(e<n){this._fields.splice(e,0,t)}else{this._fields.push(t)}if(this._hasLayout){if(s){t.layout({anchor:s})}else{t.layout()}}this._editor.processControlMove(t);this.markSchemeAsChanged();if(BX.prop.getBoolean(i,"enableSaving",true)){this.saveScheme()}return true};BX.Crm.EntityEditorSection.prototype.editChild=function(t){if(this._mode===BX.Crm.EntityEditorMode.edit){t.focus()}else if(!this.isReadOnly()){var e=true;for(var i=0,n=this._fields.length;i<n;i++){if(this._fields[i].getMode()!==this._mode){e=false;break}}if(e){this.setMode(BX.Crm.EntityEditorMode.edit,{notify:true});this.refreshLayout({callback:function(){t.focus()}})}}};BX.Crm.EntityEditorSection.prototype.getChildById=function(t){for(var e=0,i=this._fields.length;e<i;e++){var n=this._fields[e];if(n.getId()===t){return n}}return null};BX.Crm.EntityEditorSection.prototype.getChildCount=function(){return this._fields.length};BX.Crm.EntityEditorSection.prototype.getChildren=function(){return this._fields};BX.Crm.EntityEditorSection.prototype.processChildControlModeChange=function(t){if(!this.isActive()&&this._editor){this._editor.processControlModeChange(t)}};BX.Crm.EntityEditorSection.prototype.processChildControlChange=function(t,e){if(!t.isInEditMode()){return}if(typeof e==="undefined"){e={}}if(!BX.prop.get(e,"control",null)){e["control"]=t}this.markAsChanged(e);this.enableToggling(false)};BX.Crm.EntityEditorSection.prototype.processChildControlSchemeChange=function(t){this.markSchemeAsChanged();this.saveScheme()};BX.Crm.EntityEditorSection.prototype.openAddChildMenu=function(){var t=this._editor.getAvailableSchemeElements();var e=t.length;if(e===0){return}var i=[];for(var n=0;n<e;n++){var r=t[n];i.push({text:r.getTitle(),value:r.getName()})}i.push({delimiter:true});i.push({text:this.getMessage("selectFieldFromOtherSection"),value:"ACTION.TRANSFER"});var o={id:this._id,menuItems:i,button:this._addChildButton,cancel:false};BX.onCustomEvent(window,"BX.Crm.EntityEditorSection:onOpenChildMenu",[this,o]);if(o["cancel"]){return}if(this._childSelectMenu){this._childSelectMenu.setupItems(i)}else{this._childSelectMenu=BX.CmrSelectorMenu.create(this._id,{items:i});this._childSelectMenu.addOnSelectListener(BX.delegate(this.onChildSelect,this))}this._childSelectMenu.open(this._addChildButton)};BX.Crm.EntityEditorSection.prototype.onAddChildBtnClick=function(t){this.openAddChildMenu()};BX.Crm.EntityEditorSection.prototype.openTransferDialog=function(){if(!this._fieldSelector){this._fieldSelector=BX.Crm.EntityEditorFieldSelector.create(this._id,{scheme:this._editor.getScheme(),excludedNames:[this.getSchemeElement().getName()],title:this.getMessage("transferDialogTitle")});this._fieldSelector.addClosingListener(BX.delegate(this.onTransferFieldSelect,this))}this._fieldSelector.open()};BX.Crm.EntityEditorSection.prototype.onTransferFieldSelect=function(t,e){if(BX.prop.getBoolean(e,"isCanceled")){return}var i=BX.prop.getArray(e,"items");if(i.length===0){return}for(var n=0,r=i.length;n<r;n++){var o=i[n];var s=BX.prop.getString(o,"sectionName","");var a=BX.prop.getString(o,"fieldName","");var l=this._editor.getControlById(s);if(!l){continue}var d=l.getChildById(a);if(!d){continue}var h=d.getSchemeElement();l.removeChild(d,{enableSaving:false});var p=this._editor.createControl(h.getType(),h.getName(),{schemeElement:h,model:this._model,parent:this,mode:this._mode});this.addChild(p,{layout:{forceDisplay:true},enableSaving:false})}this._editor.saveSchemeChanges()};BX.Crm.EntityEditorSection.prototype.onChildSelect=function(t,e){var i={id:this._id,item:e,button:this._addChildButton,cancel:false};BX.onCustomEvent(window,"BX.Crm.EntityEditorSection:onChildMenuItemSelect",[this,i]);if(i["cancel"]){return}var n=e.getValue();if(n==="ACTION.TRANSFER"){this.openTransferDialog();return}var r=this._editor.getAvailableSchemeElementByName(n);if(!r){return}var o=this._editor.createControl(r.getType(),r.getName(),{schemeElement:r,model:this._model,parent:this,mode:this._mode});if(o){this.addChild(o,{layout:{forceDisplay:true}})}};BX.Crm.EntityEditorSection.prototype.onCreateUserFieldBtnClick=function(t){if(!this._fieldTypeSelectMenu){var e=this._editor.getUserFieldManager().getTypeInfos();var i=[];for(var n=0,r=e.length;n<r;n++){var o=e[n];i.push({value:o.name,text:o.title,legend:o.legend})}this._fieldTypeSelectMenu=BX.Crm.UserFieldTypeMenu.create(this._id,{items:i,callback:BX.delegate(this.onUserFieldTypeSelect,this)})}this._fieldTypeSelectMenu.open(this._createChildButton)};BX.Crm.EntityEditorSection.prototype.onUserFieldTypeSelect=function(t,e){this._fieldTypeSelectMenu.close();var i=e.getValue();if(i===""){return}if(i==="custom"){window.open(this._editor.getUserFieldManager().getCreationPageUrl())}else{this.removeFieldConfigurator();this.removeUserFieldConfigurator();this.createUserFieldConfigurator({typeId:i})}};BX.Crm.EntityEditorSection.prototype.createUserFieldConfigurator=function(t){if(!BX.type.isPlainObject(t)){throw"EntityEditorSection: The 'params' argument must be object."}var e="";var i=BX.prop.get(t,"field",null);if(i){if(!(i instanceof BX.Crm.EntityEditorUserField)){throw"EntityEditorSection: The 'field' param must be EntityEditorUserField."}e=i.getFieldType();i.setVisible(false)}else{e=BX.prop.get(t,"typeId",BX.Crm.EntityUserFieldType.string)}if(e==="resourcebooking"){this._userFieldConfigurator=BX.Calendar.UserField.EntityEditorUserFieldConfigurator.create("",{editor:this._editor,schemeElement:null,model:this._model,mode:BX.Crm.EntityEditorMode.edit,parent:this,typeId:e,field:i,showAlways:true})}else{var n=this._editor.getAttributeManager();if(n){this._mandatoryConfigurator=n.createFieldConfigurator(i,BX.Crm.EntityFieldAttributeType.required)}this._userFieldConfigurator=BX.Crm.EntityEditorUserFieldConfigurator.create("",{editor:this._editor,schemeElement:null,model:this._model,mode:BX.Crm.EntityEditorMode.edit,parent:this,typeId:e,field:i,mandatoryConfigurator:this._mandatoryConfigurator,showAlways:true})}this.addChild(this._userFieldConfigurator,{related:i});BX.addCustomEvent(this._userFieldConfigurator,"onSave",BX.delegate(this.onUserFieldConfigurationSave,this));BX.addCustomEvent(this._userFieldConfigurator,"onCancel",BX.delegate(this.onUserFieldConfigurationCancel,this))};BX.Crm.EntityEditorSection.prototype.removeUserFieldConfigurator=function(){if(this._userFieldConfigurator){var t=this._userFieldConfigurator.getField();if(t){t.setVisible(true)}this.removeChild(this._userFieldConfigurator);this._userFieldConfigurator=null}};BX.Crm.EntityEditorSection.prototype.onUserFieldConfigurationSave=function(t,e){if(t!==this._userFieldConfigurator){return}this._userFieldConfigurator.setLocked(true);var i=BX.prop.getString(e,"typeId");if(i===BX.Crm.EntityUserFieldType.datetime&&!BX.prop.getBoolean(e,"enableTime",false)){i=BX.Crm.EntityUserFieldType.date}var n={USER_TYPE_ID:i};if(this._mandatoryConfigurator&&this._mandatoryConfigurator.isPermitted()&&this._mandatoryConfigurator.isEnabled()&&this._mandatoryConfigurator.isCustomized()){if(this._mandatoryConfigurator.isChanged()){this._mandatoryConfigurator.acceptChanges()}n["MANDATORY"]="N"}else{n["MANDATORY"]=BX.prop.getBoolean(e,"mandatory",false)?"Y":"N"}var r=BX.prop.get(e,"settings",null);if(r){n["SETTINGS"]=r}var o=BX.prop.getBoolean(e,"showAlways",null);var s=BX.prop.getString(e,"label","");var a=BX.prop.get(e,"field",null);if(a){var l=a.getTitle();if(s!==""||o!==null){a.setTitle(s);if(o!==null&&o!==a.checkOptionFlag(BX.Crm.EntityEditorControlOptions.showAlways)){a.toggleOptionFlag(BX.Crm.EntityEditorControlOptions.showAlways)}this.markSchemeAsChanged();this.saveScheme()}n["FIELD"]=a.getName();n["ENTITY_VALUE_ID"]=a.getEntityValueId();if(this._editor.getConfigScope()===BX.Crm.EntityConfigScope.common&&l!==s){n["EDIT_FORM_LABEL"]=n["LIST_COLUMN_LABEL"]=n["LIST_FILTER_LABEL"]=s}n["VALUE"]=a.getFieldValue();if(i===BX.Crm.EntityUserFieldType.enumeration){n["ENUM"]=BX.prop.getArray(e,"enumeration",[])}a.adjustFieldParams(n,false);this._editor.getUserFieldManager().updateField(n,a.getMode()).then(BX.delegate(this.onUserFieldUpdate,this))}else{if(o!==null){this._editor.setOption("show_always",o?"Y":"N")}n["EDIT_FORM_LABEL"]=n["LIST_COLUMN_LABEL"]=n["LIST_FILTER_LABEL"]=BX.prop.getString(e,"label");n["MULTIPLE"]=BX.prop.getBoolean(e,"multiple",false)?"Y":"N";if(i===BX.Crm.EntityUserFieldType.enumeration){n["ENUM"]=BX.prop.getArray(e,"enumeration",[])}this._editor.getUserFieldManager().createField(n,this._mode).then(BX.delegate(this.onUserFieldCreate,this))}};BX.Crm.EntityEditorSection.prototype.onUserFieldConfigurationCancel=function(t,e){if(t!==this._userFieldConfigurator){return}this.removeUserFieldConfigurator();if(this._mandatoryConfigurator){this._mandatoryConfigurator=null}};BX.Crm.EntityEditorSection.prototype.onUserFieldCreate=function(t){if(!BX.type.isPlainObject(t)){return}this.removeUserFieldConfigurator();var e=this._editor.getUserFieldManager();for(var i in t){if(!t.hasOwnProperty(i)){continue}var n=t[i];var r=BX.prop.getObject(n,"FIELD",null);if(!r){continue}var o=e.createSchemeElement(r);if(!o){continue}this._model.registerNewField(o.getName(),{VALUE:"",SIGNATURE:BX.prop.getString(r,"SIGNATURE","")});var s=this._editor.createControl(o.getType(),o.getName(),{schemeElement:o,model:this._model,parent:this,mode:this._mode});if(this._mandatoryConfigurator&&this._mandatoryConfigurator.isPermitted()&&this._mandatoryConfigurator.isEnabled()&&this._mandatoryConfigurator.isCustomized()){var a=this._mandatoryConfigurator.getConfiguration();this._editor.getAttributeManager().saveConfiguration(a,o.getName());s.setAttributeConfiguration(a)}var l=this._editor.getOption("show_always","Y")==="Y";if(l!==s.checkOptionFlag(BX.Crm.EntityEditorControlOptions.showAlways)){s.toggleOptionFlag(BX.Crm.EntityEditorControlOptions.showAlways)}this.addChild(s,{layout:{notifyIfNotDisplayed:true,html:BX.prop.getString(n,"HTML","")}});break}if(this._mandatoryConfigurator){this._mandatoryConfigurator=null}};BX.Crm.EntityEditorSection.prototype.onUserFieldUpdate=function(t){if(!BX.type.isPlainObject(t)){return}this.removeUserFieldConfigurator();var e=this._editor.getUserFieldManager();for(var i in t){if(!t.hasOwnProperty(i)){continue}var n=t[i];var r=BX.prop.getObject(n,"FIELD",null);if(!r){continue}var o=this.getChildById(i);if(!o){continue}var s=o.getSchemeElement();if(!s){continue}if(this._mandatoryConfigurator&&this._mandatoryConfigurator.isPermitted()){if(this._mandatoryConfigurator.isEnabled()&&this._mandatoryConfigurator.isCustomized()){var a=this._mandatoryConfigurator.getConfiguration();this._editor.getAttributeManager().saveConfiguration(a,s.getName());o.setAttributeConfiguration(a)}else{var l=this._mandatoryConfigurator.getTypeId();this._editor.getAttributeManager().removeConfiguration(l,s.getName());o.removeAttributeConfiguration(l)}}e.updateSchemeElement(s,r);var d={};var h=BX.prop.getString(n,"HTML","");if(h!==""){d["html"]=h}o.refreshLayout(d);break}if(this._mandatoryConfigurator){this._mandatoryConfigurator=null}};BX.Crm.EntityEditorSection.prototype.editChildConfiguration=function(t){this.removeFieldConfigurator();this.removeUserFieldConfigurator();if(t.getType()==="userField"&&this._editor.getUserFieldManager().isModificationEnabled()){this.createUserFieldConfigurator({field:t})}else{this.createFieldConfigurator(t)}};BX.Crm.EntityEditorSection.prototype.createFieldConfigurator=function(t){t.setVisible(false);var e=this._editor.getAttributeManager();if(e){this._mandatoryConfigurator=e.createFieldConfigurator(t,BX.Crm.EntityFieldAttributeType.required)}this._fieldConfigurator=BX.Crm.EntityEditorFieldConfigurator.create("",{editor:this._editor,schemeElement:null,model:this._model,mode:BX.Crm.EntityEditorMode.edit,parent:this,field:t,mandatoryConfigurator:this._mandatoryConfigurator});this.addChild(this._fieldConfigurator,{related:t});BX.addCustomEvent(this._fieldConfigurator,"onSave",BX.delegate(this.onFieldConfigurationSave,this));BX.addCustomEvent(this._fieldConfigurator,"onCancel",BX.delegate(this.onFieldConfigurationCancel,this))};BX.Crm.EntityEditorSection.prototype.removeFieldConfigurator=function(){if(this._fieldConfigurator){var t=this._fieldConfigurator.getField();if(t){t.setVisible(true)}this.removeChild(this._fieldConfigurator);this._fieldConfigurator=null}};BX.Crm.EntityEditorSection.prototype.onFieldConfigurationSave=function(t,e){if(t!==this._fieldConfigurator){return}var i=BX.prop.get(e,"field",null);if(!i){throw"EntityEditorSection. Could not find target field."}var n=BX.prop.getString(e,"label","");var r=BX.prop.getBoolean(e,"showAlways",null);if(n===""&&r===null){this.removeFieldConfigurator();if(this._mandatoryConfigurator){this._mandatoryConfigurator=null}return}this._fieldConfigurator.setLocked(true);i.setTitle(n);if(r!==null&&r!==i.checkOptionFlag(BX.Crm.EntityEditorControlOptions.showAlways)){i.toggleOptionFlag(BX.Crm.EntityEditorControlOptions.showAlways)}this.markSchemeAsChanged();this.saveScheme().then(BX.delegate(function(){if(this._mandatoryConfigurator){if(this._mandatoryConfigurator.isPermitted()&&i.areAttributesEnabled()&&!i.isRequired()){if(this._mandatoryConfigurator.isEnabled()){if(this._mandatoryConfigurator.isChanged()){this._mandatoryConfigurator.acceptChanges()}var t=this._mandatoryConfigurator.getConfiguration();this._editor.getAttributeManager().saveConfiguration(t,i.getName());i.setAttributeConfiguration(t)}else{var e=this._mandatoryConfigurator.getTypeId();this._editor.getAttributeManager().removeConfiguration(e,i.getName());i.removeAttributeConfiguration(e)}}this._mandatoryConfigurator=null}this.removeFieldConfigurator()},this))};BX.Crm.EntityEditorSection.prototype.onFieldConfigurationCancel=function(t,e){if(t!==this._fieldConfigurator){return}var i=BX.prop.get(e,"field",null);if(!i){throw"EntityEditorSection. Could not find target field."}this.removeFieldConfigurator();if(this._mandatoryConfigurator){this._mandatoryConfigurator=null}};BX.Crm.EntityEditorSection.prototype.enablePointerEvents=function(t){if(!this._fields){return}t=!!t;for(i=0,length=this._fields.length;i<length;i++){this._fields[i].enablePointerEvents(t)}};BX.Crm.EntityEditorSection.prototype.onDeleteConfirm=function(t){if(BX.prop.getBoolean(t,"cancel",true)){return}this._editor.removeSchemeElement(this.getSchemeElement());this._editor.removeControl(this);this._editor.saveScheme()};BX.Crm.EntityEditorSection.prototype.onDeleteSectionBtnClick=function(t){if(this.isRequired()||this.isRequiredConditionally()){this.showMessageDialog("operationDenied",this.getMessage("deleteSection"),this.getMessage("deleteSectionDenied"));return}var e=BX.Crm.ConfirmationDialog.get(this._detetionConfirmDlgId);if(!e){e=BX.Crm.ConfirmationDialog.create(this._detetionConfirmDlgId,{title:this.getMessage("deleteSection"),content:this.getMessage("deleteSectionConfirm")})}e.open().then(BX.delegate(this.onDeleteConfirm,this))};BX.Crm.EntityEditorSection.prototype.getDragObjectType=function(){return BX.Crm.EditorDragObjectType.section};BX.Crm.EntityEditorSection.prototype.getChildDragObjectType=function(){return BX.Crm.EditorDragObjectType.field};BX.Crm.EntityEditorSection.prototype.hasPlaceHolder=function(){return!!this._dragPlaceHolder};BX.Crm.EntityEditorSection.prototype.createPlaceHolder=function(t){this.enablePointerEvents(false);var e=this.getChildCount();if(t<0||t>e){t=e>0?e:0}if(this._dragPlaceHolder){if(this._dragPlaceHolder.getIndex()===t){return this._dragPlaceHolder}this._dragPlaceHolder.clearLayout();this._dragPlaceHolder=null}this._dragPlaceHolder=BX.Crm.EditorDragFieldPlaceholder.create({container:this._contentContainer,anchor:t<e?this._fields[t].getWrapper():this._buttonPanelWrapper,index:t});this._dragPlaceHolder.layout();return this._dragPlaceHolder};BX.Crm.EntityEditorSection.prototype.getPlaceHolder=function(){return this._dragPlaceHolder};BX.Crm.EntityEditorSection.prototype.removePlaceHolder=function(){this.enablePointerEvents(true);if(this._dragPlaceHolder){this._dragPlaceHolder.clearLayout();this._dragPlaceHolder=null}};BX.Crm.EntityEditorSection.prototype.processDraggedItemDrop=function(t,e){var i=t.getCharge();if(!(i instanceof BX.Crm.EditorFieldDragContainer&&i.getSection()===this)){return}var n=e.getContextData();var r=BX.type.isNotEmptyString(n["contextId"])?n["contextId"]:"";if(r!==this.getDraggableContextId()){return}var o=this.getPlaceHolder();var s=o?o.getIndex():-1;if(s<0){return}var a=typeof n["charge"]!=="undefined"?n["charge"]:null;if(!(a instanceof BX.Crm.EditorFieldDragItem)){return}var l=a.getControl();if(!l){return}var d=l.getParent();if(d===this){var h=this.getChildIndex(l);if(h<0){return}var p=s<=h?s:s-1;if(p===h){return}this.moveChild(l,p,{enableSaving:false});this._editor.saveSchemeChanges()}else{var u=l.getSchemeElement();d.removeChild(l,{enableSaving:false});var c=this._editor.createControl(u.getType(),u.getName(),{schemeElement:u,model:this._model,parent:this,mode:this._mode});if(this._mode===BX.Crm.EntityEditorMode.view&&!c.hasContentToDisplay()&&!c.checkOptionFlag(BX.Crm.EntityEditorControlOptions.showAlways)){c.toggleOptionFlag(BX.Crm.EntityEditorControlOptions.showAlways)}this.addChild(c,{index:s,enableSaving:false});this._editor.saveSchemeChanges()}};BX.Crm.EntityEditorSection.prototype.onDrop=function(t,e,i,n){this.processDraggedItemDrop(t,e)};BX.Crm.EntityEditorSection.prototype.initializeDragDropAbilities=function(){if(this._dragItem){return}this._dragItem=BX.Crm.EditorDragItemController.create("section_"+this.getId(),{charge:BX.Crm.EditorSectionDragItem.create({control:this}),node:this.createDragButton(),showControlInDragMode:false,ghostOffset:{x:0,y:0}})};BX.Crm.EntityEditorSection.prototype.releaseDragDropAbilities=function(){if(this._dragItem){this._dragItem.release();this._dragItem=null}};BX.Crm.EntityEditorSection.prototype.isWaitingForInput=function(){for(var t=0,e=this._fields.length;t<e;t++){if(this._fields[t].isWaitingForInput()){return true}}return false};BX.Crm.EntityEditorSection.prototype.isRequired=function(){for(var t=0,e=this._fields.length;t<e;t++){if(this._fields[t].isRequired()){return true}}return false};BX.Crm.EntityEditorSection.prototype.isRequiredConditionally=function(){for(var t=0,e=this._fields.length;t<e;t++){if(this._fields[t].isRequiredConditionally()){return true}}return false};BX.Crm.EntityEditorSection.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorSection.messages;return e.hasOwnProperty(t)?e[t]:t};if(typeof BX.Crm.EntityEditorSection.messages==="undefined"){BX.Crm.EntityEditorSection.messages={}}BX.Crm.EntityEditorSection.create=function(t,e){var i=new BX.Crm.EntityEditorSection;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorText==="undefined"){BX.Crm.EntityEditorText=function(){BX.Crm.EntityEditorText.superclass.constructor.apply(this);this._input=null;this._innerWrapper=null};BX.extend(BX.Crm.EntityEditorText,BX.Crm.EntityEditorField);BX.Crm.EntityEditorText.prototype.getModeSwitchType=function(t){var e=BX.Crm.EntityEditorModeSwitchType.common;if(t===BX.Crm.EntityEditorMode.edit){e|=BX.Crm.EntityEditorModeSwitchType.button|BX.Crm.EntityEditorModeSwitchType.content}return e};BX.Crm.EntityEditorText.prototype.getContentWrapper=function(){return this._innerWrapper};BX.Crm.EntityEditorText.prototype.focus=function(){if(!this._input){return}BX.focus(this._input);BX.Crm.EditorTextHelper.getCurrent().setPositionAtEnd(this._input)};BX.Crm.EntityEditorText.prototype.getLineCount=function(){return this._schemeElement.getDataIntegerParam("lineCount",1)};BX.Crm.EntityEditorText.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated({classNames:["crm-entity-widget-content-block-field-text"]});this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}var e=this.getName();var i=this.getTitle();var n=this.getValue();this._input=null;this._innerWrapper=null;if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}if(this._mode===BX.Crm.EntityEditorMode.edit){this._wrapper.appendChild(this.createTitleNode(i));var r=this.getLineCount();if(r>1){this._input=BX.create("textarea",{props:{className:"crm-entity-widget-content-textarea",name:e,rows:r,value:n}})}else{this._input=BX.create("input",{attrs:{name:e,className:"crm-entity-widget-content-input",type:"text",value:n}})}if(this.isNewEntity()){var o=this.getCreationPlaceholder();if(o!==""){this._input.setAttribute("placeholder",o)}}BX.bind(this._input,"input",this._changeHandler);this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-field-container"},children:[this._input]})]});if(this._editor.isDuplicateControlEnabled()){var s=this.getDuplicateControlConfig();if(s){if(!BX.type.isPlainObject(s["field"])){s["field"]={}}s["field"]["id"]=this.getId();s["field"]["element"]=this._input;this._editor.getDuplicateManager().registerField(s)}}}else{this._wrapper.appendChild(this.createTitleNode(i));if(this.hasContentToDisplay()){if(this.getLineCount()>1){this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-text"},html:BX.util.nl2br(BX.util.htmlspecialchars(n))})]})}else{this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-text"},text:n})]})}}else{this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},text:this.getMessage("isEmpty")})}}this._wrapper.appendChild(this._innerWrapper);if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorText.prototype.doClearLayout=function(t){if(this._editor.isDuplicateControlEnabled()){var e=this.getDuplicateControlConfig();if(e){if(!BX.type.isPlainObject(e["field"])){e["field"]={}}e["field"]["id"]=this.getId();this._editor.getDuplicateManager().unregisterField(e)}}this._input=null;this._innerWrapper=null};BX.Crm.EntityEditorText.prototype.refreshLayout=function(){if(!this._hasLayout){return}if(!this._isValidLayout){BX.Crm.EntityEditorText.superclass.refreshLayout.apply(this,arguments);return}if(this._mode===BX.Crm.EntityEditorMode.edit&&this._input){this._input.value=this.getValue()}else if(this._mode===BX.Crm.EntityEditorMode.view&&this._innerWrapper){this._innerWrapper.innerHTML=BX.util.htmlspecialchars(this.getValue())}};BX.Crm.EntityEditorText.prototype.getRuntimeValue=function(){return this._mode===BX.Crm.EntityEditorMode.edit&&this._input?BX.util.trim(this._input.value):""};BX.Crm.EntityEditorText.prototype.validate=function(t){if(!(this._mode===BX.Crm.EntityEditorMode.edit&&this._input)){throw"BX.Crm.EntityEditorText. Invalid validation context"}this.clearError();if(this.hasValidators()){return this.executeValidators(t)}var e=!this.isRequired()||BX.util.trim(this._input.value)!=="";if(!e){t.addError(BX.Crm.EntityValidationError.create({field:this}));this.showRequiredFieldError(this._input)}return e};BX.Crm.EntityEditorText.prototype.showError=function(t,e){BX.Crm.EntityEditorText.superclass.showError.apply(this,arguments);if(this._input){BX.addClass(this._input,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorText.prototype.clearError=function(){BX.Crm.EntityEditorText.superclass.clearError.apply(this);if(this._input){BX.removeClass(this._input,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorText.prototype.save=function(){if(this._input){this._model.setField(this.getName(),this._input.value,{originator:this})}};BX.Crm.EntityEditorText.prototype.processModelChange=function(t){if(BX.prop.get(t,"originator",null)===this){return}if(!BX.prop.getBoolean(t,"forAll",false)&&BX.prop.getString(t,"name","")!==this.getName()){return}this.refreshLayout()};BX.Crm.EntityEditorText.create=function(t,e){var i=new BX.Crm.EntityEditorText;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorNumber==="undefined"){BX.Crm.EntityEditorNumber=function(){BX.Crm.EntityEditorNumber.superclass.constructor.apply(this);this._input=null;this._innerWrapper=null};BX.extend(BX.Crm.EntityEditorNumber,BX.Crm.EntityEditorField);BX.Crm.EntityEditorNumber.prototype.getModeSwitchType=function(t){var e=BX.Crm.EntityEditorModeSwitchType.common;if(t===BX.Crm.EntityEditorMode.edit){e|=BX.Crm.EntityEditorModeSwitchType.button|BX.Crm.EntityEditorModeSwitchType.content}return e};BX.Crm.EntityEditorNumber.prototype.getContentWrapper=function(){return this._innerWrapper};BX.Crm.EntityEditorNumber.prototype.focus=function(){if(!this._input){return}BX.focus(this._input);BX.Crm.EditorTextHelper.getCurrent().selectAll(this._input)};BX.Crm.EntityEditorNumber.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated({classNames:["crm-entity-widget-content-block-field-number"]});this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}var e=this.getName();var i=this.getTitle();var n=this.getValue();if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}this._input=null;if(this._mode===BX.Crm.EntityEditorMode.edit){this._input=BX.create("input",{attrs:{name:e,className:"crm-entity-widget-content-input",type:"text",value:n}});BX.bind(this._input,"input",this._changeHandler);this._wrapper.appendChild(this.createTitleNode(i));this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner crm-entity-widget-content-block-field-half-width"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-field-container"},children:[this._input]})]})}else{this._wrapper.appendChild(this.createTitleNode(i));if(!this.hasContentToDisplay()){n=this.getMessage("isEmpty")}this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-text"},text:n})]})}this._wrapper.appendChild(this._innerWrapper);if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorNumber.prototype.doClearLayout=function(t){this._input=null;this._innerWrapper=null};BX.Crm.EntityEditorNumber.prototype.getRuntimeValue=function(){return this._mode===BX.Crm.EntityEditorMode.edit&&this._input?BX.util.trim(this._input.value):""};BX.Crm.EntityEditorNumber.prototype.validate=function(t){if(!(this._mode===BX.Crm.EntityEditorMode.edit&&this._input)){throw"BX.Crm.EntityEditorNumber. Invalid validation context"}this.clearError();if(this.hasValidators()){return this.executeValidators(t)}var e=!this.isRequired()||BX.util.trim(this._input.value)!=="";if(!e){t.addError(BX.Crm.EntityValidationError.create({field:this}));this.showRequiredFieldError(this._input)}return e};BX.Crm.EntityEditorNumber.prototype.showError=function(t,e){BX.Crm.EntityEditorNumber.superclass.showError.apply(this,arguments);if(this._input){BX.addClass(this._input,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorNumber.prototype.clearError=function(){BX.Crm.EntityEditorNumber.superclass.clearError.apply(this);if(this._input){BX.removeClass(this._input,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorNumber.prototype.save=function(){if(this._input){this._model.setField(this.getName(),this._input.value)}};BX.Crm.EntityEditorNumber.create=function(t,e){var i=new BX.Crm.EntityEditorNumber;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorDatetime==="undefined"){BX.Crm.EntityEditorDatetime=function(){BX.Crm.EntityEditorDatetime.superclass.constructor.apply(this);this._input=null;this._inputClickHandler=BX.delegate(this.onInputClick,this);this._innerWrapper=null};BX.extend(BX.Crm.EntityEditorDatetime,BX.Crm.EntityEditorField);BX.Crm.EntityEditorDatetime.prototype.getModeSwitchType=function(t){var e=BX.Crm.EntityEditorModeSwitchType.common;if(t===BX.Crm.EntityEditorMode.edit){e|=BX.Crm.EntityEditorModeSwitchType.button|BX.Crm.EntityEditorModeSwitchType.content}return e};BX.Crm.EntityEditorDatetime.prototype.getContentWrapper=function(){return this._innerWrapper};BX.Crm.EntityEditorDatetime.prototype.focus=function(){if(this._input){BX.focus(this._input);BX.Crm.EditorTextHelper.getCurrent().selectAll(this._input)}};BX.Crm.EntityEditorDatetime.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated({classNames:["crm-entity-widget-content-block-field-date"]});this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}var e=this.getName();var i=this.getTitle();var n=this.getValue();this._input=null;this._innerWrapper=null;if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}if(this._mode===BX.Crm.EntityEditorMode.edit){this._input=BX.create("input",{attrs:{name:e,className:"crm-entity-widget-content-input",type:"text",value:n}});BX.bind(this._input,"click",this._inputClickHandler);BX.bind(this._input,"change",this._changeHandler);BX.bind(this._input,"input",this._changeHandler);this._wrapper.appendChild(this.createTitleNode(i));this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner crm-entity-widget-content-block-field-half-width"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-field-container"},children:[this._input]})]})}else{n=BX.date.format("j F Y",BX.parseDate(n));this._wrapper.appendChild(this.createTitleNode(i));if(!this.hasContentToDisplay()){n=this.getMessage("isEmpty")}this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-text"},text:n})]})}this._wrapper.appendChild(this._innerWrapper);if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorDatetime.prototype.doRegisterLayout=function(){if(this.isInEditMode()&&this.checkModeOption(BX.Crm.EntityEditorModeOptions.individual)&&this._input){window.setTimeout(BX.delegate(this.showCalendar,this),100)}};BX.Crm.EntityEditorDatetime.prototype.doClearLayout=function(t){this._input=null;this._innerWrapper=null};BX.Crm.EntityEditorDatetime.prototype.getRuntimeValue=function(){return this._mode===BX.Crm.EntityEditorMode.edit&&this._input?BX.util.trim(this._input.value):""};BX.Crm.EntityEditorDatetime.prototype.onInputClick=function(t){this.showCalendar()};BX.Crm.EntityEditorDatetime.prototype.showCalendar=function(){BX.calendar({node:this._input,field:this._input,bTime:false,bSetFocus:false})};BX.Crm.EntityEditorDatetime.prototype.validate=function(t){if(!(this._mode===BX.Crm.EntityEditorMode.edit&&this._input)){throw"BX.Crm.EntityEditorDatetime. Invalid validation context"}this.clearError();if(this.hasValidators()){return this.executeValidators(t)}var e=!this.isRequired()||BX.util.trim(this._input.value)!=="";if(!e){t.addError(BX.Crm.EntityValidationError.create({field:this}));this.showRequiredFieldError(this._input)}return e};BX.Crm.EntityEditorDatetime.prototype.showError=function(t,e){BX.Crm.EntityEditorDatetime.superclass.showError.apply(this,arguments);if(this._input){BX.addClass(this._input,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorDatetime.prototype.clearError=function(){BX.Crm.EntityEditorDatetime.superclass.clearError.apply(this);if(this._input){BX.removeClass(this._input,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorDatetime.prototype.save=function(){if(this._input){this._model.setField(this.getName(),this._input.value)}};BX.Crm.EntityEditorDatetime.create=function(t,e){var i=new BX.Crm.EntityEditorDatetime;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorBoolean==="undefined"){BX.Crm.EntityEditorBoolean=function(){BX.Crm.EntityEditorBoolean.superclass.constructor.apply(this);this._input=null;this._innerWrapper=null};BX.extend(BX.Crm.EntityEditorBoolean,BX.Crm.EntityEditorField);BX.Crm.EntityEditorBoolean.prototype.doInitialize=function(){BX.Crm.EntityEditorBoolean.superclass.doInitialize.apply(this);this._selectedValue=this._model.getField(this._schemeElement.getName())};BX.Crm.EntityEditorBoolean.prototype.areAttributesEnabled=function(){return false};BX.Crm.EntityEditorBoolean.prototype.getModeSwitchType=function(t){var e=BX.Crm.EntityEditorModeSwitchType.common;if(t===BX.Crm.EntityEditorMode.edit){e|=BX.Crm.EntityEditorModeSwitchType.button|BX.Crm.EntityEditorModeSwitchType.content}return e};BX.Crm.EntityEditorBoolean.prototype.getContentWrapper=function(){return this._innerWrapper};BX.Crm.EntityEditorBoolean.prototype.hasValue=function(){return BX.util.trim(this.getValue())!==""};BX.Crm.EntityEditorBoolean.prototype.getValue=function(t){if(!this._model){return""}if(t===undefined){t="N"}var e=this._model.getStringField(this.getName(),t);if(e!=="Y"&&e!=="N"){e="N"}return e};BX.Crm.EntityEditorBoolean.prototype.getRuntimeValue=function(){if(this._mode!==BX.Crm.EntityEditorMode.edit||!this._input)return"";var t=BX.util.trim(this._input.value);if(t!=="Y"&&t!=="N"){t="N"}return t};BX.Crm.EntityEditorBoolean.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated({classNames:["crm-entity-widget-content-block-field-checkbox"]});this.adjustWrapper();var e=this.getName();var i=this.getTitle();var n=this.getValue();this._input=null;this._innerWrapper=null;if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}if(this._mode===BX.Crm.EntityEditorMode.edit){this._wrapper.appendChild(BX.create("input",{attrs:{name:e,type:"hidden",value:"N"}}));this._input=BX.create("input",{attrs:{className:"crm-entity-widget-content-checkbox",name:e,type:"checkbox",value:"Y",checked:n==="Y"}});BX.bind(this._input,"change",this._changeHandler);this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-field-container"},children:[BX.create("label",{attrs:{className:"crm-entity-widget-content-block-checkbox-label"},children:[this._input,BX.create("span",{props:{className:"crm-entity-widget-content-block-checkbox-description"},text:i})]})]})]})}else{this._wrapper.appendChild(this.createTitleNode(i));this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-text"},text:this.getMessage(n==="Y"?"yes":"no")})]})}this._wrapper.appendChild(this._innerWrapper);if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorBoolean.prototype.doClearLayout=function(t){this._input=null;this._innerWrapper=null};BX.Crm.EntityEditorBoolean.prototype.validate=function(t){if(!(this._mode===BX.Crm.EntityEditorMode.edit&&this._input)){throw"BX.Crm.EntityEditorBoolean. Invalid validation context"}if(this.hasValidators()){return this.executeValidators(t)}var e=!this.isRequired()||BX.util.trim(this._input.value)!=="";if(!e){t.addError(BX.Crm.EntityValidationError.create({field:this}));BX.addClass(this._input,"crm-entity-widget-content-error");this.showRequiredFieldError(this._input)}else{BX.removeClass(this._input,"crm-entity-widget-content-error");this.clearError()}return e};BX.Crm.EntityEditorBoolean.prototype.showError=function(t,e){BX.Crm.EntityEditorBoolean.superclass.showError.apply(this,arguments);if(this._input){BX.addClass(this._input,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorBoolean.prototype.clearError=function(){BX.Crm.EntityEditorBoolean.superclass.clearError.apply(this);if(this._input){BX.removeClass(this._input,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorBoolean.prototype.save=function(){if(this._input){this._model.setField(this.getName(),this._input.checked?"Y":"N",{originator:this})}};BX.Crm.EntityEditorBoolean.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorBoolean.messages;return e.hasOwnProperty(t)?e[t]:BX.Crm.EntityEditorBoolean.superclass.getMessage.apply(this,arguments)};if(typeof BX.Crm.EntityEditorBoolean.messages==="undefined"){BX.Crm.EntityEditorBoolean.messages={}}BX.Crm.EntityEditorBoolean.create=function(t,e){var i=new BX.Crm.EntityEditorBoolean;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorList==="undefined"){BX.Crm.EntityEditorList=function(){BX.Crm.EntityEditorList.superclass.constructor.apply(this);this._items=null;this._input=null;this._selectContainer=null;this._selectedValue="";this._selectorClickHandler=BX.delegate(this.onSelectorClick,this);this._innerWrapper=null;this._isOpened=false};BX.extend(BX.Crm.EntityEditorList,BX.Crm.EntityEditorField);BX.Crm.EntityEditorList.prototype.getModeSwitchType=function(t){var e=BX.Crm.EntityEditorModeSwitchType.common;if(t===BX.Crm.EntityEditorMode.edit){e|=BX.Crm.EntityEditorModeSwitchType.button|BX.Crm.EntityEditorModeSwitchType.content}return e};BX.Crm.EntityEditorList.prototype.getContentWrapper=function(){return this._innerWrapper};BX.Crm.EntityEditorList.prototype.checkIfNotEmpty=function(t){return t!==""&&t!=="0"};BX.Crm.EntityEditorList.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated({classNames:["crm-entity-widget-content-block-field-select"]});this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}var e=this.getName();var i=this.getTitle();var n=this.getValue();var r=this.getItemByValue(n);var o=this.getDataBooleanParam("isHtml",false);var s={};if(!r){r=this.getFirstItem();if(r){n=r["VALUE"]}}this._selectedValue=n;this._selectContainer=null;this._input=null;this._innerWrapper=null;if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}if(this._mode===BX.Crm.EntityEditorMode.edit){this._wrapper.appendChild(this.createTitleNode(i));this._input=BX.create("input",{attrs:{name:e,type:"hidden",value:n}});this._wrapper.appendChild(this._input);s={props:{className:"crm-entity-widget-content-select"}};if(o){s.html=r?r["NAME"]:n}else{s.text=r?r["NAME"]:n}this._selectContainer=BX.create("div",s);BX.bind(this._selectContainer,"click",this._selectorClickHandler);this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-field-container"},children:[this._selectContainer]})]})}else{this._wrapper.appendChild(this.createTitleNode(i));var a="";if(!this.hasContentToDisplay()){a=this.getMessage("isEmpty")}else if(r){a=r["NAME"]}else{a=n}var s={props:{className:"crm-entity-widget-content-block-inner-text"}};if(o){s.html=a}else{s.text=a}this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",s)]})}this._wrapper.appendChild(this._innerWrapper);if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorList.prototype.doRegisterLayout=function(){if(this.isInEditMode()&&this.checkModeOption(BX.Crm.EntityEditorModeOptions.individual)&&this._selectContainer){window.setTimeout(BX.delegate(this.openMenu,this),100)}};BX.Crm.EntityEditorList.prototype.doClearLayout=function(t){this.closeMenu();this._input=null;this._selectContainer=null;this._innerWrapper=null};BX.Crm.EntityEditorList.prototype.refreshLayout=function(){if(!this._hasLayout){return}if(!this._isValidLayout){BX.Crm.EntityEditorMoney.superclass.refreshLayout.apply(this,arguments);return}var t=this.getValue();var e=this.getItemByValue(t);var i=e?BX.prop.getString(e,"NAME",t):t;if(this._mode===BX.Crm.EntityEditorMode.edit){this._selectedValue=t;if(this._input){this._input.value=t}if(this._selectContainer){this._selectContainer.innerHTML=this.getDataBooleanParam("isHtml",false)?i:BX.util.htmlspecialchars(i)}}else if(this._mode===BX.Crm.EntityEditorMode.view&&this._innerWrapper){this._innerWrapper.innerHTML=this.getDataBooleanParam("isHtml",false)?i:BX.util.htmlspecialchars(i)}};BX.Crm.EntityEditorList.prototype.validate=function(t){if(this._mode!==BX.Crm.EntityEditorMode.edit){throw"BX.Crm.EntityEditorList. Invalid validation context"}if(!this.isEditable()){return true}this.clearError();if(this.hasValidators()){return this.executeValidators(t)}var e=!this.isRequired()||BX.util.trim(this._input.value)!=="";if(!e){t.addError(BX.Crm.EntityValidationError.create({field:this}));this.showRequiredFieldError(this._input)}return e};BX.Crm.EntityEditorList.prototype.showError=function(t,e){BX.Crm.EntityEditorList.superclass.showError.apply(this,arguments);if(this._input){BX.addClass(this._input,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorList.prototype.clearError=function(){BX.Crm.EntityEditorList.superclass.clearError.apply(this);if(this._input){BX.removeClass(this._input,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorList.prototype.onSelectorClick=function(t){if(!this._isOpened){this.openMenu()}else{this.closeMenu()}};BX.Crm.EntityEditorList.prototype.openMenu=function(){if(this._isOpened){return}var t=[];var e=this.getItems();for(var i=0,n=e.length;i<n;i++){var r=e[i];if(!BX.prop.getBoolean(r,"IS_EDITABLE",true)){continue}var o=BX.prop.getString(r,"VALUE",i);var s=BX.prop.getString(r,"NAME",o);t.push({text:this.getDataBooleanParam("isHtml",false)?s:BX.util.htmlspecialchars(s),value:o,onclick:BX.delegate(this.onItemSelect,this)})}BX.PopupMenu.show(this._id,this._selectContainer,t,{angle:false,width:this._selectContainer.offsetWidth+"px",events:{onPopupShow:BX.delegate(this.onMenuShow,this),onPopupClose:BX.delegate(this.onMenuClose,this)}});BX.PopupMenu.currentItem.popupWindow.setWidth(BX.pos(this._selectContainer)["width"])};BX.Crm.EntityEditorList.prototype.closeMenu=function(){var t=BX.PopupMenu.getMenuById(this._id);if(t){t.popupWindow.close()}};BX.Crm.EntityEditorList.prototype.onMenuShow=function(){BX.addClass(this._selectContainer,"active");this._isOpened=true};BX.Crm.EntityEditorList.prototype.onMenuClose=function(){BX.PopupMenu.destroy(this._id);BX.removeClass(this._selectContainer,"active");this._isOpened=false};BX.Crm.EntityEditorList.prototype.onItemSelect=function(t,e){this.closeMenu();this._selectedValue=this._input.value=e.value;var i=BX.prop.getString(this.getItemByValue(this._selectedValue),"NAME",this._selectedValue);this._selectContainer.innerHTML=this.getDataBooleanParam("isHtml",false)?i:BX.util.htmlspecialchars(i);this.markAsChanged();BX.PopupMenu.destroy(this._id)};BX.Crm.EntityEditorList.prototype.getItems=function(){if(!this._items){this._items=BX.prop.getArray(this._schemeElement.getData(),"items",[])}return this._items};BX.Crm.EntityEditorList.prototype.getItemByValue=function(t){var e=this.getItems();for(var i=0,n=e.length;i<n;i++){var r=e[i];if(t===BX.prop.getString(r,"VALUE","")){return r}}return null};BX.Crm.EntityEditorList.prototype.getFirstItem=function(){var t=this.getItems();return t.length>0?t[0]:null};BX.Crm.EntityEditorList.prototype.save=function(){if(!this.isEditable()){return}this._model.setField(this.getName(),this._selectedValue)};BX.Crm.EntityEditorList.prototype.processModelChange=function(t){if(BX.prop.get(t,"originator",null)===this){return}if(!BX.prop.getBoolean(t,"forAll",false)&&BX.prop.getString(t,"name","")!==this.getName()){return}this.refreshLayout()};BX.Crm.EntityEditorList.prototype.getRuntimeValue=function(){return this._mode===BX.Crm.EntityEditorMode.edit&&this._input?this._selectedValue:""};BX.Crm.EntityEditorList.create=function(t,e){var i=new BX.Crm.EntityEditorList;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorHtml==="undefined"){BX.Crm.EntityEditorHtml=function(){BX.Crm.EntityEditorHtml.superclass.constructor.apply(this);this._htmlEditorContainer=null;this._htmlEditor=null;this._isEditorInitialized=false;this._focusOnLoad=false;this._input=null;this._innerWrapper=null;this._editorInitializationHandler=BX.delegate(this.onEditorInitialized,this);this._viewClickHandler=BX.delegate(this.onViewClick,this)};BX.extend(BX.Crm.EntityEditorHtml,BX.Crm.EntityEditorField);BX.Crm.EntityEditorHtml.prototype.getModeSwitchType=function(t){var e=BX.Crm.EntityEditorModeSwitchType.common;if(t===BX.Crm.EntityEditorMode.edit){e|=BX.Crm.EntityEditorModeSwitchType.button|BX.Crm.EntityEditorModeSwitchType.content}return e};BX.Crm.EntityEditorHtml.prototype.getContentWrapper=function(){return this._innerWrapper};BX.Crm.EntityEditorHtml.prototype.checkIfNotEmpty=function(t){return BX.Crm.EntityEditorHtml.isNotEmptyValue(t)};BX.Crm.EntityEditorHtml.prototype.focus=function(){if(this._htmlEditor&&this._isEditorInitialized){this._htmlEditor.Focus(true)}else{this._focusOnLoad=true}};BX.Crm.EntityEditorHtml.prototype.layout=function(t){if(this._hasLayout){return}this.release();this.ensureWrapperCreated({classNames:["crm-entity-widget-content-block-field-comment"]});this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}var e=this.getName();var i=this.getTitle();var n=this.getValue();this._input=null;this._innerWrapper=null;if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}if(this._mode===BX.Crm.EntityEditorMode.edit){if(!this._editor){throw"BX.Crm.EntityEditorHtml: Editor instance is required for create layout."}var r=this._editor.getHtmlEditorConfig(e);if(!r){throw"BX.Crm.EntityEditorHtml: Could not find HTML editor config."}this._htmlEditorContainer=BX(BX.prop.getString(r,"containerId"));if(!BX.type.isElementNode(this._htmlEditorContainer)){throw"BX.Crm.EntityEditorHtml: Could not find HTML editor container."}this._htmlEditor=BXHtmlEditor.Get(BX.prop.getString(r,"id"));if(!this._htmlEditor){throw"BX.Crm.EntityEditorHtml: Could not find HTML editor instance."}this._wrapper.appendChild(this.createTitleNode(i));this._input=BX.create("input",{attrs:{name:e,type:"hidden",value:n}});this._wrapper.appendChild(this._input);this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-field-container"},children:[this._htmlEditorContainer]})]})}else{this._wrapper.appendChild(this.createTitleNode(i));this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"}});if(this.hasContentToDisplay()){this._innerWrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block-field-container"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-comment"},html:n})]}));if(n.length>200){BX.addClass(this._wrapper,"crm-entity-widget-content-block-field-comment-collapsed");this._innerWrapper.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-widget-content-block-field-comment-expand-btn-container"},children:[BX.create("A",{attrs:{className:"crm-entity-widget-content-block-field-comment-expand-btn",href:"#"},events:{click:BX.delegate(this.onExpandButtonClick,this)},text:this.getMessage("expand")})]}));this._isCollapsed=true}}else{this._innerWrapper.appendChild(document.createTextNode(this.getMessage("isEmpty")))}this._wrapper.appendChild(this._innerWrapper);BX.bindDelegate(this._wrapper,"mousedown",BX.delegate(this.filterViewNode,this),this._viewClickHandler)}this._wrapper.appendChild(this._innerWrapper);if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);if(this._mode===BX.Crm.EntityEditorMode.edit){this._isEditorInitialized=!!this._htmlEditor.inited;if(this._isEditorInitialized){this.prepareEditor()}else{BX.addCustomEvent(this._htmlEditor,"OnCreateIframeAfter",this._editorInitializationHandler);this._htmlEditor.Init()}window.top.setTimeout(BX.delegate(this.bindChangeEvent,this),1e3);this.initializeDragDropAbilities()}this._hasLayout=true};BX.Crm.EntityEditorHtml.prototype.doClearLayout=function(t){this.release();this._input=null;this._innerWrapper=null};BX.Crm.EntityEditorHtml.prototype.onExpandButtonClick=function(t){if(!this._wrapper){return BX.PreventDefault(t)}if(this._hasFiles&&BX.type.isDomNode(this._commentWrapper)&&!this._textLoaded){this._textLoaded=true;this.loadContent(this._commentWrapper,"GET_TEXT")}var e=this._wrapper.querySelector(".crm-entity-widget-content-block-inner-comment");if(this._isCollapsed){BX.defer(function(){e.style.maxHeight=e.scrollHeight+130+"px"})();setTimeout(BX.delegate(function(){BX.removeClass(this._wrapper,"crm-entity-widget-content-block-field-comment-collapsed");BX.addClass(this._wrapper,"crm-entity-widget-content-block-field-comment-expand");e.style.maxHeight=""},this),200)}else{BX.defer(function(){e.style.maxHeight=e.clientHeight+"px"})();BX.defer(function(){BX.removeClass(this._wrapper,"crm-entity-widget-content-block-field-comment-expand");BX.addClass(this._wrapper,"crm-entity-widget-content-block-field-comment-collapsed")},this)();setTimeout(function(){e.style.maxHeight=""},200)}this._isCollapsed=!this._isCollapsed;var i=this._wrapper.querySelector("a.crm-entity-widget-content-block-field-comment-expand-btn");if(i){i.innerHTML=this.getMessage(this._isCollapsed?"expand":"collapse")}return BX.PreventDefault(t)};BX.Crm.EntityEditorHtml.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorHtml.messages;return e.hasOwnProperty(t)?e[t]:BX.Crm.EntityEditorHtml.superclass.getMessage.apply(this,arguments)};BX.Crm.EntityEditorHtml.prototype.filterViewNode=function(t){return true};BX.Crm.EntityEditorHtml.prototype.onViewClick=function(t){var e=null;var i=BX.getEventTarget(t);if(i.tagName==="A"){e=i}else{e=BX.findParent(i,{tagName:"a"},this._wrapper)}if(e&&e.target!=="_blank"){e.target="_blank"}};BX.Crm.EntityEditorHtml.prototype.onEditorInitialized=function(){this._isEditorInitialized=true;BX.removeCustomEvent(this._htmlEditor,"OnCreateIframeAfter",this._editorInitializationHandler);this.prepareEditor()};BX.Crm.EntityEditorHtml.prototype.prepareEditor=function(){this._htmlEditorContainer.style.display="";this._htmlEditor.CheckAndReInit();this._htmlEditor.ResizeSceleton("100%",200);this._htmlEditor.SetContent(this.getStringValue(""),true);if(this._focusOnLoad){this._htmlEditor.Focus(true);this._focusOnLoad=false}};BX.Crm.EntityEditorHtml.prototype.release=function(){if(this._htmlEditorContainer){var t=BX.create("DIV",{style:{height:this._htmlEditorContainer.offsetHeight+"px",border:"1px solid #bbc4cd",boxSizing:"border-box"}});this._htmlEditorContainer.parentNode.insertBefore(t,this._htmlEditorContainer);document.body.appendChild(this._htmlEditorContainer);this._htmlEditorContainer.style.display="none";this._htmlEditorContainer=null}if(this._htmlEditor){this.unbindChangeEvent();this._htmlEditor.SetContent("");this._htmlEditor=null;this._isEditorInitialized=false}this._focusOnLoad=false};BX.Crm.EntityEditorHtml.prototype.bindChangeEvent=function(){if(this._htmlEditor){BX.addCustomEvent(this._htmlEditor,"OnContentChanged",this._changeHandler)}};BX.Crm.EntityEditorHtml.prototype.unbindChangeEvent=function(){if(this._htmlEditor){BX.removeCustomEvent(this._htmlEditor,"OnContentChanged",this._changeHandler)}};BX.Crm.EntityEditorHtml.prototype.validate=function(t){if(!(this._mode===BX.Crm.EntityEditorMode.edit&&this._htmlEditor)){throw"BX.Crm.EntityEditorHtml. Invalid validation context"}this.clearError();if(this.hasValidators()){return this.executeValidators(t)}var e=!this.isRequired()||BX.Crm.EntityEditorHtml.isNotEmptyValue(this._htmlEditor.GetContent());if(!e){t.addError(BX.Crm.EntityValidationError.create({field:this}));this.showRequiredFieldError(this._htmlEditorContainer)}return e};BX.Crm.EntityEditorHtml.prototype.showError=function(t,e){BX.Crm.EntityEditorHtml.superclass.showError.apply(this,arguments);if(this._htmlEditorContainer){BX.addClass(this._htmlEditorContainer,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorHtml.prototype.clearError=function(){BX.Crm.EntityEditorHtml.superclass.clearError.apply(this);if(this._htmlEditorContainer){BX.removeClass(this._htmlEditorContainer,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorHtml.prototype.save=function(){if(this._htmlEditor){var t=this._input.value=this._htmlEditor.GetContent();this._model.setField(this.getName(),t)}};BX.Crm.EntityEditorHtml.prototype.getRuntimeValue=function(){return this._mode===BX.Crm.EntityEditorMode.edit&&this._input?this._htmlEditor.GetContent():""};BX.Crm.EntityEditorHtml.isNotEmptyValue=function(t){return BX.util.trim(t.replace(/<br\/?>|&nbsp;/gi,""))!==""};BX.Crm.EntityEditorHtml.create=function(t,e){var i=new BX.Crm.EntityEditorHtml;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorMoney==="undefined"){BX.Crm.EntityEditorMoney=function(){BX.Crm.EntityEditorMoney.superclass.constructor.apply(this);this._currencyEditor=null;this._amountInput=null;this._currencyInput=null;this._sumElement=null;this._selectContainer=null;this._inputWrapper=null;this._innerWrapper=null;this._selectedCurrencyValue="";this._selectorClickHandler=BX.delegate(this.onSelectorClick,this);this._isCurrencyMenuOpened=false};BX.extend(BX.Crm.EntityEditorMoney,BX.Crm.EntityEditorField);BX.Crm.EntityEditorMoney.prototype.getModeSwitchType=function(t){var e=BX.Crm.EntityEditorModeSwitchType.common;if(t===BX.Crm.EntityEditorMode.edit){e|=BX.Crm.EntityEditorModeSwitchType.button|BX.Crm.EntityEditorModeSwitchType.content}return e};BX.Crm.EntityEditorMoney.prototype.getContentWrapper=function(){return this._innerWrapper};BX.Crm.EntityEditorMoney.prototype.focus=function(){if(this._amountInput){BX.focus(this._amountInput);BX.Crm.EditorTextHelper.getCurrent().selectAll(this._amountInput)}};BX.Crm.EntityEditorMoney.prototype.getValue=function(t){if(!this._model){return""}return this._model.getStringField(this.getAmountFieldName(),t!==undefined?t:"")};BX.Crm.EntityEditorMoney.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated({classNames:["crm-entity-widget-content-block-field-money"]});this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}var e=this.getTitle();var i=this.getData();var n=BX.prop.getString(i,"amount");var r=BX.prop.getString(BX.prop.getObject(i,"currency"),"name");var o=this._model.getField(BX.prop.getString(BX.prop.getObject(i,"currency"),"name",""));if(!BX.type.isNotEmptyString(o)){o=BX.Currency.Editor.getBaseCurrencyId()}this._selectedCurrencyValue=o;var s=this._editor.findOption(o,BX.prop.getArray(BX.prop.getObject(i,"currency"),"items"));var a=this.getAmountFieldName();var l=this.getCurrencyFieldName();var d=this._model.getField(a,"");var h=this._model.getField(BX.prop.getString(i,"formatted"),"");this._amountValue=null;this._amountInput=null;this._currencyInput=null;this._selectContainer=null;this._innerWrapper=null;this._sumElement=null;if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}if(this._mode===BX.Crm.EntityEditorMode.edit){this._wrapper.appendChild(this.createTitleNode(e));this._amountValue=BX.create("input",{attrs:{name:n,type:"hidden",value:d}});this._amountInput=BX.create("input",{attrs:{className:"crm-entity-widget-content-input",type:"text",value:h}});BX.bind(this._amountInput,"input",this._changeHandler);if(this._model.isFieldLocked(a)){this._amountInput.disabled=true}this._currencyInput=BX.create("input",{attrs:{name:r,type:"hidden",value:o}});this._selectContainer=BX.create("div",{props:{className:"crm-entity-widget-content-select"},text:s});if(this._model.isFieldLocked(l)){this._selectContainer.disabled=true}else{BX.bind(this._selectContainer,"click",this._selectorClickHandler)}this._inputWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-field-container crm-entity-widget-content-block-field-container-double"},children:[this._amountValue,this._amountInput,this._currencyInput,BX.create("div",{props:{className:"crm-entity-widget-content-block-select"+(this._selectContainer.disabled?"-disabled":"")},children:[this._selectContainer]})]});this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[this._inputWrapper]});this._currencyEditor=new BX.Currency.Editor({input:this._amountInput,currency:o,callback:BX.delegate(this.onAmountValueChange,this)});this._currencyEditor.changeValue()}else{this._wrapper.appendChild(this.createTitleNode(e));if(this.hasContentToDisplay()){this._sumElement=BX.create("span",{props:{className:"crm-entity-widget-content-block-wallet"}});this._sumElement.innerHTML=this.renderMoney();this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-text"},children:[this._sumElement]})]})}else{this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},text:this.getMessage("isEmpty")})}}this._wrapper.appendChild(this._innerWrapper);if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorMoney.prototype.doClearLayout=function(t){BX.PopupMenu.destroy(this._id);if(this._currencyEditor){this._currencyEditor.clean();this._currencyEditor=null}this._amountValue=null;this._amountInput=null;this._currencyInput=null;this._sumElement=null;this._selectContainer=null;this._inputWrapper=null;this._innerWrapper=null};BX.Crm.EntityEditorMoney.prototype.refreshLayout=function(t){if(!this._hasLayout){return}if(!this._isValidLayout){BX.Crm.EntityEditorMoney.superclass.refreshLayout.apply(this,arguments);return}if(this._mode===BX.Crm.EntityEditorMode.edit&&this._amountInput){var e=this._currencyEditor?this._currencyEditor.currency:this._model.getField(this.getCurrencyFieldName());if(!BX.type.isNotEmptyString(e)){e=BX.Currency.Editor.getBaseCurrencyId()}var i=this.getAmountFieldName();this._amountValue.value=this._model.getField(i);this._amountInput.value=BX.Currency.Editor.getFormattedValue(this._model.getField(i,""),e);this._amountInput.disabled=this._model.isFieldLocked(i)}else if(this._mode===BX.Crm.EntityEditorMode.view&&this._sumElement){this._sumElement.innerHTML=this.renderMoney()}};BX.Crm.EntityEditorMoney.prototype.onAmountValueChange=function(t){if(this._amountValue){this._amountValue.value=t}};BX.Crm.EntityEditorMoney.prototype.getAmountFieldName=function(){return this._schemeElement.getDataStringParam("amount","")};BX.Crm.EntityEditorMoney.prototype.getCurrencyFieldName=function(){return BX.prop.getString(this._schemeElement.getDataObjectParam("currency",{}),"name","")};BX.Crm.EntityEditorMoney.prototype.onSelectorClick=function(t){this.openCurrencyMenu()};BX.Crm.EntityEditorMoney.prototype.openCurrencyMenu=function(){if(this._isCurrencyMenuOpened){return}var t=this._schemeElement.getData();var e=BX.prop.getArray(BX.prop.getObject(t,"currency"),"items");var i=0;var n=[];while(i<e.length){n.push({text:e[i]["NAME"],value:e[i]["VALUE"],onclick:BX.delegate(this.onCurrencySelect,this)});i++}BX.PopupMenu.show(this._id,this._selectContainer,n,{angle:false,width:this._selectContainer.offsetWidth+"px",events:{onPopupShow:BX.delegate(this.onCurrencyMenuOpen,this),onPopupClose:BX.delegate(this.onCurrencyMenuClose,this)}})};BX.Crm.EntityEditorMoney.prototype.closeCurrencyMenu=function(){if(!this._isCurrencyMenuOpened){return}var t=BX.PopupMenu.getMenuById(this._id);if(t){t.popupWindow.close()}};BX.Crm.EntityEditorMoney.prototype.onCurrencyMenuOpen=function(){BX.addClass(this._selectContainer,"active");this._isCurrencyMenuOpened=true};BX.Crm.EntityEditorMoney.prototype.onCurrencyMenuClose=function(){BX.PopupMenu.destroy(this._id);BX.removeClass(this._selectContainer,"active");this._isCurrencyMenuOpened=false};BX.Crm.EntityEditorMoney.prototype.onCurrencySelect=function(t,e){this.closeCurrencyMenu();this._selectedCurrencyValue=this._currencyInput.value=e.value;this._selectContainer.innerHTML=BX.util.htmlspecialchars(e.text);if(this._currencyEditor){this._currencyEditor.setCurrency(this._selectedCurrencyValue)}this.markAsChanged({fieldName:this.getCurrencyFieldName(),fieldValue:this._selectedCurrencyValue})};BX.Crm.EntityEditorMoney.prototype.processModelChange=function(t){if(BX.prop.get(t,"originator",null)===this){return}if(!BX.prop.getBoolean(t,"forAll",false)&&BX.prop.getString(t,"name","")!==this.getAmountFieldName()){return}this.refreshLayout()};BX.Crm.EntityEditorMoney.prototype.processModelLock=function(t){var e=BX.prop.getString(t,"name","");if(this.getAmountFieldName()===e){this.refreshLayout()}};BX.Crm.EntityEditorMoney.prototype.validate=function(t){if(!(this._mode===BX.Crm.EntityEditorMode.edit&&this._amountInput&&this._amountValue)){throw"BX.Crm.EntityEditorMoney. Invalid validation context"}this.clearError();if(this.hasValidators()){return this.executeValidators(t)}var e=!this.isRequired()||BX.util.trim(this._amountValue.value)!=="";if(!e){t.addError(BX.Crm.EntityValidationError.create({field:this}));this.showRequiredFieldError(this._inputWrapper)}return e};BX.Crm.EntityEditorMoney.prototype.showError=function(t,e){BX.Crm.EntityEditorMoney.superclass.showError.apply(this,arguments);if(this._amountInput){BX.addClass(this._amountInput,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorMoney.prototype.clearError=function(){BX.Crm.EntityEditorMoney.superclass.clearError.apply(this);if(this._amountInput){BX.removeClass(this._amountInput,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorMoney.prototype.getRuntimeValue=function(){var t=[];if(this._mode===BX.Crm.EntityEditorMode.edit){if(this._amountValue){t[BX.prop.getString(t,"amount")]=this._amountValue.value}t[BX.prop.getString(t,"currency")]=this._selectedCurrencyValue;return t}return""};BX.Crm.EntityEditorMoney.prototype.save=function(){var t=this._schemeElement.getData();this._model.setField(BX.prop.getString(BX.prop.getObject(t,"currency"),"name"),this._selectedCurrencyValue,{originator:this});if(this._amountValue){this._model.setField(BX.prop.getString(t,"amount"),this._amountValue.value,{originator:this});this._model.setField(BX.prop.getString(t,"formatted"),"",{originator:this});this._editor.formatMoney(this._amountValue.value,this._selectedCurrencyValue,BX.delegate(this.onMoneyFormatRequestSuccess,this))}};BX.Crm.EntityEditorMoney.prototype.onMoneyFormatRequestSuccess=function(t){var e=this._schemeElement.getData();var i=BX.type.isNotEmptyString(t["FORMATTED_SUM_WITH_CURRENCY"])?t["FORMATTED_SUM_WITH_CURRENCY"]:"";this._model.setField(BX.prop.getString(e,"formattedWithCurrency"),i);var n=BX.type.isNotEmptyString(t["FORMATTED_SUM"])?t["FORMATTED_SUM"]:"";this._model.setField(BX.prop.getString(e,"formatted"),n,{originator:this});if(this._sumElement){while(this._sumElement.firstChild){this._sumElement.removeChild(this._sumElement.firstChild)}this._sumElement.innerHTML=this.renderMoney()}};BX.Crm.EntityEditorMoney.prototype.renderMoney=function(){var t=this._schemeElement.getData();var e=this._model.getField(BX.prop.getString(t,"formattedWithCurrency"),"");var i=this._model.getField(BX.prop.getString(t,"formatted"),"");var n=BX.Currency.Editor.trimTrailingZeros(i,this._selectedCurrencyValue);return e.replace(i,'<span class="crm-entity-widget-content-block-colums-right">'+n+"</span>")};BX.Crm.EntityEditorMoney.create=function(t,e){var i=new BX.Crm.EntityEditorMoney;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorImage==="undefined"){BX.Crm.EntityEditorImage=function(){BX.Crm.EntityEditorImage.superclass.constructor.apply(this);this._innerWrapper=null;this._dialogShowHandler=BX.delegate(this.onDialogShow,this);this._dialogCloseHandler=BX.delegate(this.onDialogClose,this);this._fileChangeHandler=BX.delegate(this.onFileChange,this)};BX.extend(BX.Crm.EntityEditorImage,BX.Crm.EntityEditorField);BX.Crm.EntityEditorImage.prototype.getModeSwitchType=function(t){var e=BX.Crm.EntityEditorModeSwitchType.common;if(t===BX.Crm.EntityEditorMode.edit){e|=BX.Crm.EntityEditorModeSwitchType.button|BX.Crm.EntityEditorModeSwitchType.content}return e};BX.Crm.EntityEditorImage.prototype.getContentWrapper=function(){return this._innerWrapper};BX.Crm.EntityEditorImage.prototype.hasContentToDisplay=function(){return this._mode===BX.Crm.EntityEditorMode.edit||this._model.getSchemeField(this._schemeElement,"showUrl","")!==""};BX.Crm.EntityEditorImage.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated({classNames:["crm-entity-widget-content-block-field-file"]});this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}var e=this.getName();var i=this.getTitle();this._innerWrapper=null;if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}if(this._mode===BX.Crm.EntityEditorMode.edit){this._wrapper.appendChild(this.createTitleNode(i));this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"}});this._editor.loadCustomHtml("RENDER_IMAGE_INPUT",{FIELD_NAME:e},BX.delegate(this.onEditorHtmlLoad,this))}else{this._wrapper.appendChild(this.createTitleNode(i));this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"}});if(this.hasContentToDisplay()){this._innerWrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-box"},children:[BX.create("img",{props:{className:"crm-entity-widget-content-block-photo",src:this._model.getSchemeField(this._schemeElement,"showUrl","")}})]}))}else{this._innerWrapper.appendChild(document.createTextNode(this.getMessage("isEmpty")))}}this._wrapper.appendChild(this._innerWrapper);if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorImage.prototype.doClearLayout=function(t){if(this._innerWrapper){BX.removeCustomEvent(window,"onAfterPopupShow",this._dialogShowHandler);BX.removeCustomEvent(window,"onPopupClose",this._dialogCloseHandler);BX.cleanNode(this._innerWrapper);this._innerWrapper=null}this.unbindFileEvents()};BX.Crm.EntityEditorImage.prototype.onEditorHtmlLoad=function(t){if(this._mode===BX.Crm.EntityEditorMode.edit&&this._innerWrapper){this._innerWrapper.innerHTML=t;BX.addCustomEvent(window,"onAfterPopupShow",this._dialogShowHandler);BX.addCustomEvent(window,"onPopupClose",this._dialogCloseHandler);window.setTimeout(BX.delegate(this.bindFileEvents,this),500)}};BX.Crm.EntityEditorImage.prototype.bindFileEvents=function(){var t=BX.MFInput?BX.MFInput.get(this.getName().toLowerCase()+"_uploader"):null;if(t){BX.addCustomEvent(t,"onAddFile",this._fileChangeHandler);BX.addCustomEvent(t,"onDeleteFile",this._fileChangeHandler)}};BX.Crm.EntityEditorImage.prototype.unbindFileEvents=function(){var t=BX.MFInput?BX.MFInput.get(this.getName().toLowerCase()+"_uploader"):null;if(t){BX.removeCustomEvent(t,"onAddFile",this._fileChangeHandler);BX.removeCustomEvent(t,"onDeleteFile",this._fileChangeHandler)}};BX.Crm.EntityEditorImage.prototype.onDialogShow=function(t){if(t.uniquePopupId.indexOf("popupavatarEditor")!==0){return}BX.addCustomEvent(window,"onApply",this._fileChangeHandler);if(this._singleEditController){this._singleEditController.setActiveDelayed(false)}BX.bind(t.popupContainer,"click",function(t){BX.eventCancelBubble(t)})};BX.Crm.EntityEditorImage.prototype.onDialogClose=function(t){if(BX.prop.getString(t,"uniquePopupId","").indexOf("popupavatarEditor")!==0){return}BX.removeCustomEvent(window,"onApply",this._fileChangeHandler);if(this._singleEditController){this._singleEditController.setActiveDelayed(true)}};BX.Crm.EntityEditorImage.prototype.onFileChange=function(t){this.markAsChanged()};BX.Crm.EntityEditorImage.create=function(t,e){var i=new BX.Crm.EntityEditorImage;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorUser==="undefined"){BX.Crm.EntityEditorUser=function(){BX.Crm.EntityEditorUser.superclass.constructor.apply(this);this._input=null;this._editButton=null;this._photoElement=null;this._nameElement=null;this._positionElement=null;this._userSelector=null;this._selectedData={};this._editButtonClickHandler=BX.delegate(this.onEditBtnClick,this)};BX.extend(BX.Crm.EntityEditorUser,BX.Crm.EntityEditorField);BX.Crm.EntityEditorUser.prototype.isSingleEditEnabled=function(){return true};BX.Crm.EntityEditorUser.prototype.getRelatedDataKeys=function(){return[this.getDataKey(),this._schemeElement.getDataStringParam("formated",""),this._schemeElement.getDataStringParam("position",""),this._schemeElement.getDataStringParam("showUrl",""),this._schemeElement.getDataStringParam("photoUrl","")]};BX.Crm.EntityEditorUser.prototype.hasContentToDisplay=function(){return true};BX.Crm.EntityEditorUser.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated();this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}var e=this._schemeElement.getName();var i=this._schemeElement.getTitle();var n=this._model.getField(e);var r=this._model.getSchemeField(this._schemeElement,"formated","");var o=this._model.getSchemeField(this._schemeElement,"position","");var s=this._model.getSchemeField(this._schemeElement,"showUrl","","");var a=this._model.getSchemeField(this._schemeElement,"photoUrl","");this._photoElement=BX.create("a",{props:{className:"crm-widget-employee-avatar-container",target:"_blank"},style:{backgroundImage:BX.type.isNotEmptyString(a)?"url('"+a+"')":"",backgroundSize:BX.type.isNotEmptyString(a)?"30px":""}});this._nameElement=BX.create("a",{props:{className:"crm-widget-employee-name",target:"_blank"},text:r});if(s!==""){this._photoElement.href=s;this._nameElement.href=s}this._positionElement=BX.create("SPAN",{props:{className:"crm-widget-employee-position"},text:o});if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}this._wrapper.appendChild(this.createTitleNode(i));var l=BX.create("div",{props:{className:"crm-widget-employee-container"}});this._editButton=null;this._input=null;if(this._mode===BX.Crm.EntityEditorMode.edit||this.isEditInViewEnabled()&&!this.isReadOnly()){this._input=BX.create("input",{attrs:{name:e,type:"hidden",value:n}});this._wrapper.appendChild(this._input);this._editButton=BX.create("span",{props:{className:"crm-widget-employee-change"},text:this.getMessage("change")});BX.bind(this._editButton,"click",this._editButtonClickHandler);l.appendChild(this._editButton)}l.appendChild(this._photoElement);l.appendChild(BX.create("span",{props:{className:"crm-widget-employee-info"},children:[this._nameElement,this._positionElement]}));this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[l]}));if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorUser.prototype.doRegisterLayout=function(){if(this.isInEditMode()&&this.checkModeOption(BX.Crm.EntityEditorModeOptions.individual)){window.setTimeout(BX.delegate(this.openSelector,this),0)}};BX.Crm.EntityEditorUser.prototype.doClearLayout=function(t){this._input=null;this._editButton=null;this._photoElement=null;this._nameElement=null;this._positionElement=null};BX.Crm.EntityEditorUser.prototype.onEditBtnClick=function(t){if(this._mode===BX.Crm.EntityEditorMode.view&&this.isEditInViewEnabled()&&this.getEditor().isChanged()){this.switchToSingleEditMode()}else{this.openSelector()}};BX.Crm.EntityEditorUser.prototype.openSelector=function(){if(!this._userSelector){this._userSelector=BX.Crm.EntityEditorUserSelector.create(this._id,{callback:BX.delegate(this.processItemSelect,this)})}this._userSelector.open(this._editButton)};BX.Crm.EntityEditorUser.prototype.processItemSelect=function(t,e){var i=this._mode===BX.Crm.EntityEditorMode.view;var n=this.isEditInViewEnabled();if(i&&!n){return}this._selectedData={id:BX.prop.getInteger(e,"entityId",0),photoUrl:BX.prop.getString(e,"avatar",""),formattedNameHtml:BX.prop.getString(e,"name",""),positionHtml:BX.prop.getString(e,"desc","")};this._input.value=this._selectedData["id"];this._photoElement.style.backgroundImage=this._selectedData["photoUrl"]!==""?"url('"+this._selectedData["photoUrl"]+"')":"";this._photoElement.style.backgroundSize=this._selectedData["photoUrl"]!==""?"30px":"";this._nameElement.innerHTML=this._selectedData["formattedNameHtml"];this._positionElement.innerHTML=this._selectedData["positionHtml"];this._userSelector.close();if(!i){this.markAsChanged()}else{this._editor.saveControl(this)}};BX.Crm.EntityEditorUser.prototype.save=function(){var t=this._schemeElement.getData();if(this._selectedData["id"]>0){var e=this._selectedData["id"];this._model.setField(BX.prop.getString(t,"formated"),BX.util.htmlspecialcharsback(this._selectedData["formattedNameHtml"]));this._model.setField(BX.prop.getString(t,"position"),this._selectedData["positionHtml"]!=="&nbsp;"?BX.util.htmlspecialcharsback(this._selectedData["positionHtml"]):"");this._model.setField(BX.prop.getString(t,"showUrl"),BX.prop.getString(t,"pathToProfile").replace(/#user_id#/gi,e));this._model.setField(BX.prop.getString(t,"photoUrl"),this._selectedData["photoUrl"]);this._model.setField(this.getName(),e)}};BX.Crm.EntityEditorUser.prototype.processModelChange=function(t){if(BX.prop.get(t,"originator",null)===this){return}if(!BX.prop.getBoolean(t,"forAll",false)&&BX.prop.getString(t,"name","")!==this.getName()){return}this.refreshLayout()};BX.Crm.EntityEditorUser.prototype.getRuntimeValue=function(){if(this._mode===BX.Crm.EntityEditorMode.edit&&this._selectedData["id"]>0){return this._selectedData["id"]}return""};BX.Crm.EntityEditorUser.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorUser.messages;return e.hasOwnProperty(t)?e[t]:BX.Crm.EntityEditorUser.superclass.getMessage.apply(this,arguments)};if(typeof BX.Crm.EntityEditorUser.messages==="undefined"){BX.Crm.EntityEditorUser.messages={}}BX.Crm.EntityEditorUser.create=function(t,e){var i=new BX.Crm.EntityEditorUser;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorAddress==="undefined"){BX.Crm.EntityEditorAddress=function(){BX.Crm.EntityEditorAddress.superclass.constructor.apply(this);this._innerWrapper=null};BX.extend(BX.Crm.EntityEditorAddress,BX.Crm.EntityEditorField);BX.Crm.EntityEditorAddress.prototype.getModeSwitchType=function(t){var e=BX.Crm.EntityEditorModeSwitchType.common;if(t===BX.Crm.EntityEditorMode.edit){e|=BX.Crm.EntityEditorModeSwitchType.button|BX.Crm.EntityEditorModeSwitchType.content}return e};BX.Crm.EntityEditorAddress.prototype.getContentWrapper=function(){return this._innerWrapper};BX.Crm.EntityEditorAddress.prototype.hasContentToDisplay=function(){return this._mode===BX.Crm.EntityEditorMode.edit||this.getViewHtml()!==""};BX.Crm.EntityEditorAddress.prototype.getViewHtml=function(){var t=this._schemeElement.getDataStringParam("view","");if(t===""){t=this._schemeElement.getName()+"_HML"}return this._model.getStringField(t,"")};BX.Crm.EntityEditorAddress.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated();this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}var e=this._schemeElement.getName();var i=this.getTitle();var n=this._schemeElement.getDataObjectParam("fields",{});var r=this._schemeElement.getDataObjectParam("labels",{});this._innerWrapper=null;if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}this._wrapper.appendChild(this.createTitleNode(i));if(this._mode===BX.Crm.EntityEditorMode.edit){var o=BX.create("div",{attrs:{className:"crm-entity-widget-content-block-inner-address"}});this._innerWrapper=BX.create("div",{attrs:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-field-container"},children:[o]})]});for(var s in n){if(!n.hasOwnProperty(s)){return}var a=n[s];var l=BX.prop.getString(r,s,s);this.layoutField(s,a,l,o)}BX.bindDelegate(o,"bxchange",{tag:["input","textarea"]},this._changeHandler)}else{if(this.hasContentToDisplay()){this._innerWrapper=BX.create("div",{attrs:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{attrs:{className:"crm-entity-widget-content-block-inner-text"},html:this.getViewHtml()})]})}else{this._innerWrapper=BX.create("div",{attrs:{className:"crm-entity-widget-content-block-inner"},text:this.getMessage("isEmpty")})}}this._wrapper.appendChild(this._innerWrapper);if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorAddress.prototype.layoutField=function(t,e,i,n){var r=BX.prop.getString(e,"NAME",t);var o=this._model.getStringField(r,"");n.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block-title"},children:[BX.create("span",{attrs:{className:"crm-entity-widget-content-block-title-text"},text:i})]}));if(BX.prop.getBoolean(e,"IS_MULTILINE",false)){n.appendChild(BX.create("textarea",{props:{className:"crm-entity-widget-content-input",name:r,value:o}}))}else{n.appendChild(BX.create("input",{props:{className:"crm-entity-widget-content-input",name:r,type:"text",value:o}}))}};BX.Crm.EntityEditorAddress.prototype.doClearLayout=function(t){this._innerWrapper=null};BX.Crm.EntityEditorAddress.create=function(t,e){var i=new BX.Crm.EntityEditorAddress;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorMultifieldItem==="undefined"){BX.Crm.EntityEditorMultifieldItem=function(){this._id="";this._settings={};this._parent=null;this._editor=null;this._mode=BX.Crm.EntityEditorMode.view;this._data=null;this._typeId="";this._valueTypeItems=null;this._container=null;this._wrapper=null;this._valueInput=null;this._valueTypeInput=null;this._valueTypeSelector=null;this._deleteButton=null;this._deleteButtonHandler=BX.delegate(this.onDeleteButtonClick,this);this._isJunked=false;this._hasLayout=false};BX.Crm.EntityEditorMultifieldItem.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._parent=BX.prop.get(this._settings,"parent",null);this._editor=this._parent.getEditor();this._mode=BX.prop.getInteger(this._settings,"mode",BX.Crm.EntityEditorMode.view);this._typeId=BX.prop.getString(this._settings,"typeId","");this._data=BX.prop.getObject(this._settings,"data",{});this._valueTypeItems=BX.prop.getArray(this._settings,"valueTypeItems",[]);this._container=BX.prop.getElementNode(this._settings,"container",null)},getId:function(){return this._id},isEmpty:function(){return BX.util.trim(this.getValue())===""},getTypeId:function(){return this._typeId},getValue:function(){return BX.prop.getString(this._data,"VALUE","")},getValueId:function(){return BX.prop.getString(this._data,"ID","")},getValueTypeId:function(){var t=BX.prop.getString(this._data,"VALUE_TYPE","");return t!==""?t:this.getDefaultValueTypeId()},getDefaultValueTypeId:function(){return this._valueTypeItems.length>0?BX.prop.getString(this._valueTypeItems[0],"VALUE"):""},getViewData:function(){return BX.prop.getObject(this._data,"VIEW_DATA",{})},resolveValueTypeName:function(t){if(t===""){return""}for(var e=0,i=this._valueTypeItems.length;e<i;e++){var n=this._valueTypeItems[e];if(t===BX.prop.getString(n,"VALUE","")){return BX.prop.getString(n,"NAME",t)}}return t},prepareControlName:function(t){return this.getTypeId()+"["+this.getValueId()+"]"+"["+t+"]"},getMode:function(){return this._mode},setMode:function(t){this._mode=t},getContainer:function(){return this._container},setContainer:function(t){this._container=t;if(this._hasLayout){this.clearLayout()}},focus:function(){if(this._valueInput){BX.focus(this._valueInput);BX.Crm.EditorTextHelper.getCurrent().selectAll(this._valueInput)}},layout:function(){if(this._hasLayout){return}this._valueInput=null;this._valueTypeInput=null;this._valueTypeSelector=null;this._deleteButton=null;var t=this.getValueTypeId();var e=this.getValue();this._wrapper=BX.create("div");this._container.appendChild(this._wrapper);if(this._mode===BX.Crm.EntityEditorMode.edit){BX.addClass(this._wrapper,"crm-entity-widget-content-block-field-container crm-entity-widget-content-block-field-container-double");this._valueInput=BX.create("input",{attrs:{className:"crm-entity-widget-content-input",name:this.prepareControlName("VALUE"),type:"text",value:e}});BX.bind(this._valueInput,"input",BX.delegate(this.onValueChange,this));this._wrapper.appendChild(this._valueInput);this._valueTypeInput=BX.create("input",{attrs:{name:this.prepareControlName("VALUE_TYPE"),type:"hidden",value:t}});this._wrapper.appendChild(this._valueTypeInput);this._valueTypeSelector=BX.create("div",{props:{className:"crm-entity-widget-content-select"},text:this.resolveValueTypeName(t),events:{click:BX.delegate(this.onValueTypeSelectorClick,this)}});this._wrapper.appendChild(BX.create("div",{attrs:{className:"crm-entity-widget-content-block-select"},children:[this._valueTypeSelector]}));this._deleteButton=BX.create("div",{attrs:{className:"crm-entity-widget-content-remove-block"}});this._wrapper.appendChild(this._deleteButton);BX.bind(this._deleteButton,"click",this._deleteButtonHandler);if(this._editor.isDuplicateControlEnabled()){var i=this._parent.getDuplicateControlConfig();if(i){if(!BX.type.isPlainObject(i["field"])){i["field"]={}}i["field"]["id"]=this.getValueId();i["field"]["element"]=this._valueInput;this._editor.getDuplicateManager().registerField(i)}}}else if(this._mode===BX.Crm.EntityEditorMode.view&&!this.isEmpty()){BX.addClass(this._wrapper,"crm-entity-widget-content-block-mutlifield");var n=this.getViewData();var r=BX.prop.getString(n,"value","");if(r===""){r=BX.util.htmlspecialchars(e)}this._wrapper.appendChild(BX.create("span",{attrs:{className:"crm-entity-widget-content-block-mutlifield-type"},text:this.resolveValueTypeName(t)}));var o=BX.create("span",{attrs:{className:"crm-entity-widget-content-block-mutlifield-value"},html:r});this._wrapper.appendChild(o);if(this._parent.getMultifieldType()==="EMAIL"){var s=o.querySelector("a.crm-entity-email");if(s){BX.bind(s,"click",BX.delegate(this.onEmailClick,this))}}}this._hasLayout=true},clearLayout:function(){if(!this._hasLayout){return}if(this._editor.isDuplicateControlEnabled()){var t=this._parent.getDuplicateControlConfig();if(t){if(!BX.type.isPlainObject(t["field"])){t["field"]={}}t["field"]["id"]=this.getValueId();this._editor.getDuplicateManager().unregisterField(t)}}this._wrapper=BX.remove(this._wrapper);this._hasLayout=false},adjust:function(){if(this._hasLayout){this._wrapper.style.display=this._isJunked?"none":""}},onValueChange:function(t){this._parent.processItemChange(this)},onValueTypeSelectorClick:function(t){var e=[];for(var i=0,n=this._valueTypeItems.length;i<n;i++){var r=this._valueTypeItems[i];e.push({text:r["NAME"],value:r["VALUE"],onclick:BX.delegate(this.onValueTypeSelect,this)})}BX.addClass(this._valueTypeSelector,"active");BX.PopupMenu.destroy(this._id);BX.PopupMenu.show(this._id,this._valueTypeSelector,e,{angle:false,width:this._valueTypeSelector.offsetWidth+"px",events:{onPopupClose:BX.delegate(this.onValueTypeMenuClose,this)}});BX.PopupMenu.currentItem.popupWindow.setWidth(BX.pos(this._valueTypeSelector)["width"])},onValueTypeMenuClose:function(t){BX.removeClass(this._valueTypeSelector,"active")},onValueTypeSelect:function(t,e){BX.removeClass(this._valueTypeSelector,"active");this._valueTypeInput.value=e.value;this._valueTypeSelector.innerHTML=BX.util.htmlspecialchars(e.text);this._parent.processItemChange(this);BX.PopupMenu.destroy(this._id)},isJunked:function(){return this._isJunked},markAsJunked:function(t){t=!!t;if(this._isJunked!==t){this._isJunked=t;if(this._isJunked){this._valueInput.value=""}this.adjust()}},onEmailClick:function(t){if(BX.CrmActivityEditor){var e=this._editor.getOwnerInfo();var i={ownerType:e["ownerType"],ownerID:e["ownerID"],communications:[{entityType:e["ownerType"],entityId:e["ownerID"],type:"EMAIL",value:this.getValue()}]};BX.CrmActivityEditor.addEmail(i)}return BX.PreventDefault(t)},onDeleteButtonClick:function(t){this._parent.processItemDeletion(this)}};BX.Crm.EntityEditorMultifieldItem.create=function(t,e){var i=new BX.Crm.EntityEditorMultifieldItem;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorMultifieldItemPhone==="undefined"){BX.Crm.EntityEditorMultifieldItemPhone=function(){BX.Crm.EntityEditorMultifieldItemPhone.superclass.constructor.apply(this);this._maskedPhone=null;this._maskedValueInput=null;this._countryFlagNode=null};BX.extend(BX.Crm.EntityEditorMultifieldItemPhone,BX.Crm.EntityEditorMultifieldItem);BX.Crm.EntityEditorMultifieldItemPhone.prototype.layout=function(){var t=this;if(this._hasLayout){return}this._valueInput=null;this._valueTypeInput=null;this._valueTypeSelector=null;var e=this.getValueTypeId();var i=this.getValue();this._wrapper=BX.create("div");this._container.appendChild(this._wrapper);if(this._mode===BX.Crm.EntityEditorMode.edit){BX.addClass(this._wrapper,"crm-entity-widget-content-block-field-container crm-entity-widget-content-block-field-container-double");this._valueInput=BX.create("input",{attrs:{name:this.prepareControlName("VALUE"),type:"hidden",value:i}});this._wrapper.appendChild(this._valueInput);this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-input-phone-wrapper"},children:[this._countryFlagNode=BX.create("span",{props:{className:"crm-entity-widget-content-country-flag"}}),this._maskedValueInput=BX.create("input",{attrs:{className:"crm-entity-widget-content-input crm-entity-widget-content-input-phone",type:"text",value:i}})]}));this._maskedPhone=new BX.PhoneNumber.Input({node:this._maskedValueInput,flagNode:this._countryFlagNode,flagSize:24,onChange:function(e){t._valueInput.value=e.value;t.onValueChange()}});this._valueTypeInput=BX.create("input",{attrs:{name:this.prepareControlName("VALUE_TYPE"),type:"hidden",value:e}});this._wrapper.appendChild(this._valueTypeInput);this._valueTypeSelector=BX.create("div",{props:{className:"crm-entity-widget-content-select"},text:this.resolveValueTypeName(e),events:{click:BX.delegate(this.onValueTypeSelectorClick,this)}});this._wrapper.appendChild(BX.create("div",{attrs:{className:"crm-entity-widget-content-block-select"},children:[this._valueTypeSelector]}));this._deleteButton=BX.create("div",{attrs:{className:"crm-entity-widget-content-remove-block"}});this._wrapper.appendChild(this._deleteButton);BX.bind(this._deleteButton,"click",this._deleteButtonHandler);if(this._editor.isDuplicateControlEnabled()){var n=this._parent.getDuplicateControlConfig();if(n){if(!BX.type.isPlainObject(n["field"])){n["field"]={}}n["field"]["id"]=this.getValueId();n["field"]["element"]=this._maskedValueInput;this._editor.getDuplicateManager().registerField(n)}}}else if(this._mode===BX.Crm.EntityEditorMode.view&&!this.isEmpty()){BX.addClass(this._wrapper,"crm-entity-widget-content-block-mutlifield");var r=this.getViewData();var o=BX.prop.getString(r,"value","");if(o===""){o=BX.util.htmlspecialchars(i)}this._wrapper.appendChild(BX.create("span",{attrs:{className:"crm-entity-widget-content-block-mutlifield-type"},text:this.resolveValueTypeName(e)}));this._wrapper.appendChild(BX.create("span",{attrs:{className:"crm-entity-widget-content-block-mutlifield-value"},html:o}))}this._hasLayout=true};BX.Crm.EntityEditorMultifieldItemPhone.prototype.focus=function(){if(this._maskedValueInput){BX.focus(this._maskedValueInput);BX.Crm.EditorTextHelper.getCurrent().selectAll(this._maskedValueInput)}};BX.Crm.EntityEditorMultifieldItemPhone.create=function(t,e){var i=new BX.Crm.EntityEditorMultifieldItemPhone;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorMultifield==="undefined"){BX.Crm.EntityEditorMultifield=function(){BX.Crm.EntityEditorMultifield.superclass.constructor.apply(this);this._items=null;this._itemWrapper=null};BX.extend(BX.Crm.EntityEditorMultifield,BX.Crm.EntityEditorField);BX.Crm.EntityEditorMultifield.prototype.doInitialize=function(){this.initializeItems()};BX.Crm.EntityEditorMultifield.prototype.initializeItems=function(){var t=this.getName();var e=this._model.getField(t,[]);if(e.length===0){e.push({ID:"n0"})}for(var i=0,n=e.length;i<n;i++){this.addItem(e[i])}};BX.Crm.EntityEditorMultifield.prototype.findItemIndex=function(t){if(!this._items){return-1}for(var e=0,i=this._items.length;e<i;e++){if(this._items[e]===t){return e}}return-1};BX.Crm.EntityEditorMultifield.prototype.resetItems=function(){if(this._hasLayout){for(var t=0,e=this._items.length;t<e;t++){this._items[t].clearLayout()}}this._items=[]};BX.Crm.EntityEditorMultifield.prototype.deleteItem=function(t){if(!this._items){return}var e=this.findItemIndex(t);if(e>=0){this._items[e].markAsJunked(true)}};BX.Crm.EntityEditorMultifield.prototype.reset=function(){this.resetItems();this.initializeItems()};BX.Crm.EntityEditorMultifield.prototype.hasContentToDisplay=function(){if(this._mode===BX.Crm.EntityEditorMode.edit){return true}var t=this._items.length;if(t===0){return false}for(var e=0;e<t;e++){if(!this._items[e].isEmpty()){return true}}return false};BX.Crm.EntityEditorMultifield.prototype.getModeSwitchType=function(t){var e=BX.Crm.EntityEditorModeSwitchType.common;if(t===BX.Crm.EntityEditorMode.edit){e|=BX.Crm.EntityEditorModeSwitchType.button|BX.Crm.EntityEditorModeSwitchType.content}return e};BX.Crm.EntityEditorMultifield.prototype.getContentWrapper=function(){return this._itemWrapper};BX.Crm.EntityEditorMultifield.prototype.processModelChange=function(t){if(BX.prop.get(t,"originator",null)===this){return}if(!BX.prop.getBoolean(t,"forAll",false)&&BX.prop.getString(t,"name","")!==this.getName()){return}this.refreshLayout()};BX.Crm.EntityEditorMultifield.prototype.prepareItemsLayout=function(){for(var t=0,e=this._items.length;t<e;t++){var i=this._items[t];i.setMode(this._mode);i.setContainer(this._itemWrapper);i.layout()}};BX.Crm.EntityEditorMultifield.prototype.getModeSwitchType=function(t){var e=BX.Crm.EntityEditorModeSwitchType.common;if(t===BX.Crm.EntityEditorMode.edit){e|=BX.Crm.EntityEditorModeSwitchType.button|BX.Crm.EntityEditorModeSwitchType.content}return e};BX.Crm.EntityEditorMultifield.prototype.getContentWrapper=function(){return this._itemWrapper};BX.Crm.EntityEditorMultifield.prototype.focus=function(){if(this._items&&this._items.length>0){this._items[this._items.length-1].focus()}};BX.Crm.EntityEditorMultifield.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated({classNames:["crm-entity-widget-content-block-field-multifield"]});this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}this._itemWrapper=null;if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}this._wrapper.appendChild(this.createTitleNode(this.getTitle()));this._itemWrapper=BX.create("div",{attrs:{className:"crm-entity-widget-content-block-inner"}});this._wrapper.appendChild(this._itemWrapper);if(this.hasContentToDisplay()){this.prepareItemsLayout()}else if(this._mode===BX.Crm.EntityEditorMode.view){this._itemWrapper.appendChild(document.createTextNode(this.getMessage("isEmpty")))}if(this._mode===BX.Crm.EntityEditorMode.edit){this._wrapper.appendChild(BX.create("div",{attrs:{className:"crm-entity-widget-content-block-add-field"},children:[BX.create("span",{attrs:{className:"crm-entity-widget-content-add-field"},text:this.getMessage("add"),events:{click:BX.delegate(this.onAddButtonClick,this)}})]}))}if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorMultifield.prototype.doClearLayout=function(t){for(var e=0,i=this._items.length;e<i;e++){var n=this._items[e];n.clearLayout();n.setContainer(null)}this._itemWrapper=null};BX.Crm.EntityEditorMultifield.prototype.refreshLayout=function(t){if(!this._hasLayout){return}if(!this._isValidLayout){BX.Crm.EntityEditorMoney.superclass.refreshLayout.apply(this,arguments);return}this.resetItems();this.initializeItems();this.prepareItemsLayout()};BX.Crm.EntityEditorMultifield.prototype.getMultifieldType=function(){return this._schemeElement.getDataStringParam("type","")};BX.Crm.EntityEditorMultifield.prototype.addItem=function(t){var e;var i=this._schemeElement.getName();if(i==="PHONE"){e=BX.Crm.EntityEditorMultifieldItemPhone.create("",{parent:this,typeId:this._schemeElement.getName(),valueTypeItems:this._schemeElement.getDataArrayParam("items",[]),data:t})}else{e=BX.Crm.EntityEditorMultifieldItem.create("",{parent:this,typeId:this._schemeElement.getName(),valueTypeItems:this._schemeElement.getDataArrayParam("items",[]),data:t})}if(this._items===null){this._items=[]}this._items.push(e);if(this._hasLayout){e.setMode(this._mode);e.setContainer(this._itemWrapper);e.layout()}return e};BX.Crm.EntityEditorMultifield.prototype.onAddButtonClick=function(t){this.addItem({ID:"n"+this._items.length.toString()})};BX.Crm.EntityEditorMultifield.prototype.processItemChange=function(t){this.markAsChanged()};BX.Crm.EntityEditorMultifield.prototype.processItemDeletion=function(t){this.deleteItem(t);this.markAsChanged()};BX.Crm.EntityEditorMultifield.create=function(t,e){var i=new BX.Crm.EntityEditorMultifield;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorClientMode==="undefined"){BX.Crm.EntityEditorClientMode={undefined:0,select:1,create:2,edit:3}}if(typeof BX.Crm.EntityEditorClientSearchBox==="undefined"){BX.Crm.EntityEditorClientSearchBox=function(){this._id="";this._settings={};this._editor=null;this._container=null;this._wrapper=null;this._badgeElement=null;this._editButton=null;this._changeButton=null;this._deleteButton=null;this._parentField=null;this._entityInfo=null;this._entityTypeName="";this._externalEditorPages=null;this._searchInput=null;this._searchControl=null;this._loaderConfig=null;this._changeNotifier=null;this._titleChangeNotifier=null;this._resetNotifier=null;this._deletionNotifier=null;this._enableDeletion=true;this._editButtonHandler=BX.delegate(this.onEditButtonClick,this);this._changeButtonHandler=BX.delegate(this.onChangeButtonClick,this);this._deleteButtonHandler=BX.delegate(this.onDeleteButtonClick,this);this._inputFocusHandler=BX.delegate(this.onInputFocus,this);this._inputBlurHandler=BX.delegate(this.onInputBlur,this);this._inputDblClickHandler=BX.delegate(this.onInputDblClick,this);this._mode=BX.Crm.EntityEditorClientMode.undefined;this._multifieldChangeNotifier=null;this._maskedPhone=null;this._emailInput=null;this._phoneId="";this._emailId="";this._enableQuickEdit=true;this._hasFocus=false;this._hasLayout=false;this._hasMultifieldLayout=false};BX.Crm.EntityEditorClientSearchBox.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._editor=BX.prop.get(this._settings,"editor",null);this._parentField=BX.prop.get(this._settings,"parentField",null);this._container=BX.prop.getElementNode(this._settings,"container",null);var i=BX.prop.get(this._settings,"entityInfo",null);if(i){this._entityInfo=i;this._entityTypeName=i.getTypeName()}else{this._entityTypeName=BX.prop.getString(this._settings,"entityTypeName","")}this._mode=BX.prop.getInteger(this._settings,"mode",BX.Crm.EntityEditorClientMode.select);if(this._mode===BX.Crm.EntityEditorClientMode.edit&&!(this._entityInfo&&this._entityInfo.canUpdate())){this._mode=BX.Crm.EntityEditorClientMode.select}this._enableQuickEdit=BX.prop.getBoolean(this._settings,"enableQuickEdit",true);this._enableDeletion=BX.prop.getBoolean(this._settings,"enableDeletion",true);this._loaderConfig=BX.prop.get(this._settings,"loaderConfig",null);this._changeNotifier=BX.CrmNotifier.create(this);this._titleChangeNotifier=BX.CrmNotifier.create(this);this._deletionNotifier=BX.CrmNotifier.create(this);this._resetNotifier=BX.CrmNotifier.create(this);this._multifieldChangeNotifier=BX.CrmNotifier.create(this)},getMessage:function(t){return BX.prop.getString(BX.Crm.EntityEditorClientSearchBox.messages,t)},getEntity:function(){return this._entityInfo},setEntityTypeName:function(t){if(this._entityTypeName!==t){this._entityTypeName=t}},setEntity:function(t,e){var i=this._entityInfo;this._entityInfo=t;if(t){this._entityTypeName=t.getTypeName()}if(this._entityInfo&&this._entityInfo.getId()===0){this.setMode(BX.Crm.EntityEditorClientMode.create)}else{this.setMode(BX.Crm.EntityEditorClientMode.select)}this.clearMultifieldLayout();this.adjust();if(e){this._changeNotifier.notify([this._entityInfo,i])}},setupEntity:function(t,e){if(e<=0){return}this.setEntityTypeName(t);this.loadEntityInfo(e)},hasEntity:function(){return!!this._entityInfo},isNewEntity:function(){return this._entityInfo&&this._entityInfo.getId()===0},canUpdateEntity:function(){return this._entityInfo&&this._entityInfo.canUpdate()},getMode:function(){return this._mode},setMode:function(t){if(!BX.type.isNumber(t)){t=parseInt(t);if(!BX.type.isNumber(t)){throw"EntityEditorClientSearchBox: Argument must be integer."}}if(this._mode===t){return}this._mode=t},layout:function(t){if(this._hasLayout){return}if(!BX.type.isPlainObject(t)){t={}}this._wrapper=BX.create("div",{props:{className:"crm-entity-widget-content-search-row"}});this.innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-search-inner"}});var e=BX.prop.getElementNode(t,"anchor",null);if(e){this._container.insertBefore(this._wrapper,e)}else{this._container.appendChild(this._wrapper)}this._wrapper.appendChild(this.innerWrapper);var i=BX.create("div",{props:{className:"crm-entity-widget-content-search-box"}});this.innerWrapper.appendChild(i);var n=BX.create("div",{props:{className:"crm-entity-widget-img-box"}});if(this._entityTypeName===BX.CrmEntityType.names.company){BX.addClass(n,"crm-entity-widget-img-company")}else if(this._entityTypeName===BX.CrmEntityType.names.contact){BX.addClass(n,"crm-entity-widget-img-contact")}i.appendChild(n);this._searchInput=BX.create("input",{props:{type:"text",placeholder:BX.prop.getString(this._settings,"placeholder",""),className:"crm-entity-widget-content-input crm-entity-widget-content-search-input",autocomplete:"nope"}});i.appendChild(this._searchInput);BX.bind(this._searchInput,"focus",this._inputFocusHandler);BX.bind(this._searchInput,"blur",this._inputBlurHandler);BX.bind(this._searchInput,"dblclick",this._inputDblClickHandler);this._badgeElement=BX.create("div",{props:{className:"crm-entity-widget-badge"}});i.appendChild(this._badgeElement);this._editButton=BX.create("div",{props:{className:"crm-entity-widget-btn-edit"}});i.appendChild(this._editButton);BX.bind(this._editButton,"click",this._editButtonHandler);this._changeButton=BX.create("div",{props:{className:"crm-entity-widget-btn-select",title:this.getMessage(this._entityTypeName.toLowerCase()+"ChangeButtonHint")}});i.appendChild(this._changeButton);BX.bind(this._changeButton,"click",this._changeButtonHandler);if(this._entityInfo){this._searchInput.value=this._entityInfo.getTitle()}this._searchControl=new BX.UI.Dropdown({searchAction:"crm.api.entity.search",searchOptions:{types:[this._entityTypeName],scope:"index"},searchResultRenderer:null,targetElement:this._searchInput,items:BX.prop.getArray(this._settings,"lastEntityInfos",[]),enableCreation:BX.prop.getBoolean(this._settings,"enableCreation",false),enableCreationOnBlur:this._enableQuickEdit,messages:{creationLegend:this.getMessage(this._entityTypeName.toLowerCase()+"ToCreateLegend"),notFound:this.getMessage("notFound")},events:{onSelect:this.onEntitySelect.bind(this),onAdd:this.onEntityAdd.bind(this),onReset:this.onEntityReset.bind(this)}});this._deleteButton=BX.create("div",{props:{className:"crm-entity-widget-btn-close"}});if(!this._enableDeletion){this._deleteButton.style.display="none"}this.innerWrapper.appendChild(this._deleteButton);BX.bind(this._deleteButton,"click",this._deleteButtonHandler);window.setTimeout(function(){this.adjust(t)}.bind(this),0);this._hasLayout=true},clearLayout:function(){if(!this._hasLayout){return}this.clearMultifieldLayout();BX.unbind(this._editButton,"click",this._editButtonHandler);BX.unbind(this._deleteButton,"click",this._deleteButtonHandler);BX.unbind(this._changeButton,"click",this._changeButtonHandler);this._deleteButton=this._changeButton=this._searchControl=this._badgeElement=null;this._wrapper=BX.remove(this._wrapper);this._hasLayout=false},prepareMultifieldLayout:function(){if(this._hasMultifieldLayout){return}this._multifieldContainer=BX.create("div",{props:{className:"crm-entity-widget-content-multifield"}});this._wrapper.appendChild(this._multifieldContainer);this._phoneInput=BX.create("input",{props:{type:"hidden"}});this._countryFlagNode=BX.create("span",{props:{className:"crm-entity-widget-content-country-flag"}});this._maskedPhoneInput=BX.create("input",{props:{type:"text",placeholder:BX.message("CRM_EDITOR_PHONE"),className:"crm-entity-widget-content-input crm-entity-widget-content-input-phone",autocomplete:"nope"}});this._multifieldContainer.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-multifield-item"},children:[this._countryFlagNode,this._maskedPhoneInput,this._phoneInput]}));this._maskedPhone=new BX.PhoneNumber.Input({node:this._maskedPhoneInput,flagNode:this._countryFlagNode,flagSize:24,onChange:BX.delegate(this.onPhoneChange,this)});this._emailInput=BX.create("input",{props:{type:"text",placeholder:BX.message("CRM_EDITOR_EMAIL"),className:"crm-entity-widget-content-input",autocomplete:"nope"}});BX.bind(this._emailInput,"input",BX.delegate(this.onEmailChange,this));this._multifieldContainer.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-multifield-item"},children:[this._emailInput]}));var t="",e="",i=0;this._phoneId=this._emailId="";if(this._entityInfo){var n=this._entityInfo.getPhones();if(n.length===0){this._maskedPhone.setValue(this._phoneInput.value="")}else{this._phoneId=BX.prop.getString(n[0],"ID","");e=this.parseMultifieldPseudoId(this._phoneId);if(e>=0){i=e+1}this._maskedPhone.setValue(this._phoneInput.value=BX.prop.getString(n[0],"VALUE",""))}var r=this._entityInfo.getEmails();if(r.length===0){this._emailInput.value=""}else{this._emailId=BX.prop.getString(r[0],"ID","");t=this.parseMultifieldPseudoId(this._emailId);if(t>=0){i=t+1}this._emailInput.value=BX.prop.getString(r[0],"VALUE","")}}else{this._emailInput.value="";this._maskedPhone.setValue(this._phoneInput.value="")}if(this._phoneId===""){this._phoneId=this.prepareMultifieldPseudoId(i);i++}if(this._emailId===""){this._emailId=this.prepareMultifieldPseudoId(i)}this._hasMultifieldLayout=true},clearMultifieldLayout:function(){if(!this._hasMultifieldLayout){return}this._multifieldContainer=BX.remove(this._multifieldContainer);this._phoneInput=this._maskedPhone=this._emailInput=null;this._phoneId=this._emailId="";this._hasMultifieldLayout=false},prepareMultifieldPseudoId:function(t){return"n"+t.toString()},parseMultifieldPseudoId:function(t){var e=t.match(/^n(\d+)/);return BX.type.isArray(e)&&e.length>1?parseInt(e[1]):-1},isNeedToSave:function(){return this._mode===BX.Crm.EntityEditorClientMode.create||this._mode===BX.Crm.EntityEditorClientMode.edit},save:function(){if(this._mode!==BX.Crm.EntityEditorClientMode.create&&this._mode!==BX.Crm.EntityEditorClientMode.edit){return}if(!this._entityInfo){return}if(this._searchInput&&this._searchInput.value!==this._entityInfo.getTitle()){this._entityInfo.setTitle(this._searchInput.value)}if(this._phoneInput){this._entityInfo.setMultifieldById({ID:this._phoneId,TYPE_ID:"PHONE",VALUE:this._phoneInput.value},this._phoneId)}if(this._emailInput){this._entityInfo.setMultifieldById({ID:this._emailId,TYPE_ID:"EMAIL",VALUE:this._emailInput.value},this._emailId)}},focus:function(){if(this._searchInput){this._searchInput.focus()}},hasValue:function(){return!!this._entityInfo},addMultifieldChangeListener:function(t){this._multifieldChangeNotifier.addListener(t)},removeMultifieldChangeListener:function(t){this._multifieldChangeNotifier.removeListener(t)},addTitleChangeListener:function(t){this._titleChangeNotifier.addListener(t)},removeTitleChangeListener:function(t){this._titleChangeNotifier.removeListener(t)},addChangeListener:function(t){this._changeNotifier.addListener(t)},removeChangeListener:function(t){this._changeNotifier.removeListener(t)},addDeletionListener:function(t){this._deletionNotifier.addListener(t)},removeDeletionListener:function(t){this._deletionNotifier.removeListener(t)},addResetListener:function(t){this._resetNotifier.addListener(t)},removeResetListener:function(t){this._resetNotifier.removeListener(t)},isQuickEditEnabled:function(){return this._enableQuickEdit},enableQuickEdit:function(t){t=!!t;if(this._enableQuickEdit===t){return}this._enableQuickEdit=t;if(this._searchControl){this._searchControl.enableCreationOnBlur=this._enableQuickEdit}},enableDeletion:function(t){t=!!t;if(this._enableDeletion===t){return}this._enableDeletion=t;if(this._hasLayout){this._deleteButton.style.display=t?"":"none"}},adjust:function(t){if(!this._hasLayout){return}if(!BX.type.isPlainObject(t)){t={}}if(this._hasFocus){BX.removeClass(this._wrapper,"crm-entity-widget-content-block-complete");BX.addClass(this._wrapper,"crm-entity-widget-content-block-inprogress")}else{BX.removeClass(this._wrapper,"crm-entity-widget-content-block-inprogress");BX.addClass(this._wrapper,"crm-entity-widget-content-block-complete")}if(this.hasEntity()){if(this._mode===BX.Crm.EntityEditorClientMode.create||this._mode===BX.Crm.EntityEditorClientMode.edit){this._badgeElement.innerHTML=this.getMessage(this._mode===BX.Crm.EntityEditorClientMode.create?this._entityTypeName.toLowerCase()+"ToCreateTag":"entityEditTag");BX.removeClass(this._wrapper,"crm-entity-widget-content-block-selection-mode");BX.addClass(this._wrapper,this._mode===BX.Crm.EntityEditorClientMode.create?"crm-entity-widget-content-block-new-mode":"crm-entity-widget-content-block-edit-mode");if(this._searchInput.value.length<0){BX.removeClass(this._wrapper,"crm-entity-widget-content-block-textreset")}else{BX.addClass(this._wrapper,"crm-entity-widget-content-block-textreset")}this.prepareMultifieldLayout();if(this._searchControl){this._searchControl.isDisabled=true}}else if(this._mode===BX.Crm.EntityEditorClientMode.select){BX.removeClass(this._wrapper,"crm-entity-widget-content-block-badge");BX.addClass(this._wrapper,"crm-entity-widget-content-block-selection-mode");this.clearMultifieldLayout();if(this._searchControl){this._searchControl.isDisabled=false}}if(this._searchInput.value.length>0){BX.addClass(this._wrapper,"crm-entity-widget-content-block-textreset")}else{BX.removeClass(this._wrapper,"crm-entity-widget-content-block-textreset")}}else{BX.removeClass(this._wrapper,"crm-entity-widget-content-block-new-mode");BX.removeClass(this._wrapper,"crm-entity-widget-content-block-edit-mode");BX.removeClass(this._wrapper,"crm-entity-widget-content-block-selection-mode");BX.removeClass(this._wrapper,"crm-entity-widget-content-block-textreset");BX.removeClass(this._wrapper,"crm-entity-widget-content-block-complete");BX.removeClass(this._wrapper,"crm-entity-widget-content-block-inprogress");this.clearMultifieldLayout();if(this._searchControl){this._searchControl.isDisabled=false}}},getParentContextId:function(){return this._parentField.getContextId()},getEntityCreateUrl:function(t){return this._parentField.getEntityCreateUrl(t)},getEntityEditUrl:function(t,e){return this._parentField.getEntityEditUrl(t,e)},openEntityCreatePage:function(t){var e=this.getEntityCreateUrl(this._entityTypeName);if(e===""){return}var i=this.getParentContextId()+"_"+BX.util.getRandomString(6).toUpperCase();var n=BX.prop.getObject(t,"urlParams",{});n["external_context_id"]=i;e=BX.util.add_url_param(e,n);if(!this._externalEventHandler){this._externalEventHandler=BX.delegate(this.onExternalEvent,this);BX.addCustomEvent(window,"onLocalStorageSet",this._externalEventHandler)}if(!this._externalEditorPages){this._externalEditorPages={}}this._externalEditorPages[i]=e;BX.Crm.Page.open(e)},openEntityEditPage:function(t){var e=this.getEntityEditUrl(this._entityTypeName,BX.prop.getInteger(t,"entityId",0));if(e===""){return}var i=this.getParentContextId()+"_"+BX.util.getRandomString(6).toUpperCase();var n=BX.prop.getObject(t,"urlParams",{});n["external_context_id"]=i;e=BX.util.add_url_param(e,n);if(!this._externalEventHandler){this._externalEventHandler=BX.delegate(this.onExternalEvent,this);BX.addCustomEvent(window,"onLocalStorageSet",this._externalEventHandler)}if(!this._externalEditorPages){this._externalEditorPages={}}this._externalEditorPages[i]=e;BX.Crm.Page.open(e)},onExternalEvent:function(t){var e=BX.prop.getString(t,"key","");if(e!=="onCrmEntityCreate"&&e!=="onCrmEntityUpdate"){return}var i=BX.prop.getObject(t,"value",{});var n=BX.prop.getString(i,"context","");if(BX.prop.getString(this._externalEditorPages,n,"")===""){return}var r=BX.prop.getString(i,"entityTypeName","");var o=BX.prop.getInteger(i,"entityId",0);if(this._entityTypeName!==r){return}if(e==="onCrmEntityUpdate"&&!(this._entityInfo&&this._entityInfo.getId()===o)){return}this.setupEntity(this._entityTypeName,o);window.setTimeout(function(){BX.Crm.Page.close(this._externalEditorPages[n],{identity:{key:"external_context_id",value:n}});delete this._externalEditorPages[n]}.bind(this),100)},onPhoneChange:function(t){if(!this._phoneInput){return}if(this._phoneInput.value!==t.value){this._phoneInput.value=t.value;this._multifieldChangeNotifier.notify()}},onEmailChange:function(t){this._multifieldChangeNotifier.notify()},onEditButtonClick:function(){if(this.isNewEntity()||!this.canUpdateEntity()||this.getMode()===BX.Crm.EntityEditorClientMode.edit){return}if(this._searchControl){this._searchControl.destroyPopupWindow()}if(!this.isQuickEditEnabled()){this.openEntityEditPage({entityId:this._entityInfo.getId(),urlParams:{init_mode:"edit"}});return}this.setMode(BX.Crm.EntityEditorClientMode.edit);this.clearMultifieldLayout();this.adjust()},onChangeButtonClick:function(t){this.setMode(BX.Crm.EntityEditorClientMode.select);if(this._searchInput){this._searchInput.focus()}if(this._searchControl){this._searchControl.getPopupWindow().show()}},onDeleteButtonClick:function(t){if(this._enableDeletion){this._deletionNotifier.notify([this._entityInfo])}},onInputFocus:function(t){this._hasFocus=true;window.setTimeout(BX.delegate(this.adjust,this),150)},onInputBlur:function(t){this._hasFocus=false;window.setTimeout(BX.delegate(this.adjust,this),300);if(this._mode===BX.Crm.EntityEditorClientMode.edit&&this._searchInput.value!==this._entityInfo.getTitle()){this._titleChangeNotifier.notify([])}},onInputDblClick:function(t){},onEntityAdd:function(t,e){var i=BX.prop.getString(e,"title","");if(i===""){return}if(this._searchControl){this._searchControl.destroyPopupWindow()}if(!this.isQuickEditEnabled()){this.openEntityCreatePage({urlParams:{title:i}});return}var n={typeName:this._entityTypeName,title:i};if(BX.validation.checkIfEmail(i)){n["title"]=this.getMessage(this._entityTypeName===BX.CrmEntityType.names.contact?"unnamed":"untitled");n["advancedInfo"]={multiFields:[{ID:this.prepareMultifieldPseudoId(0),TYPE_ID:"EMAIL",VALUE:i}]}}else if(BX.validation.checkIfPhone(i)){n["title"]=this.getMessage(this._entityTypeName===BX.CrmEntityType.names.contact?"unnamed":"untitled");n["advancedInfo"]={multiFields:[{ID:this.prepareMultifieldPseudoId(0),TYPE_ID:"PHONE",VALUE:i}]}}if(this._searchInput.value!==n["title"]){this._searchInput.value=n["title"]}this.setEntity(BX.CrmEntityInfo.create(n),true);this._searchControl.destroyPopupWindow()},onEntityReset:function(){this.reset();this._searchControl.destroyPopupWindow()},onEntitySelect:function(t,e){var i=BX.prop.getString(e,"type","");var n=BX.prop.getInteger(e,"id",0);var r=BX.prop.getString(e,"title","");this.setEntityTypeName(i);if(n<=0){return}this.loadEntityInfo(n);this._searchInput.value=r;this._searchControl.destroyPopupWindow()},onEntityInfoLoad:function(t,e){var i=BX.prop.getObject(e,"DATA",null);if(i){this.setEntity(BX.CrmEntityInfo.create(i),true);if(this._hasLayout){var n=this._wrapper.nextSibling;this.clearLayout();this.layout({anchor:n})}}},reset:function(){this._searchInput.value="";var t=this._entityInfo;this._entityInfo=null;this._resetNotifier.notify([t]);window.setTimeout(BX.delegate(this.adjust,this),150)},loadEntityInfo:function(t){var e=BX.prop.getObject(this._loaderConfig,this._entityTypeName,null);if(!e){return}BX.CrmDataLoader.create(this._id,{serviceUrl:e["url"],action:e["action"],params:{ENTITY_TYPE_NAME:this._entityTypeName,ENTITY_ID:t,NORMALIZE_MULTIFIELDS:"Y"}}).load(BX.delegate(this.onEntityInfoLoad,this))}};if(typeof BX.Crm.EntityEditorClientSearchBox.messages==="undefined"){BX.Crm.EntityEditorClientSearchBox.messages={}}BX.Crm.EntityEditorClientSearchBox.create=function(t,e){var i=new BX.Crm.EntityEditorClientSearchBox;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorClientLayoutType==="undefined"){BX.Crm.EntityEditorClientLayoutType={undefined:0,contactCompany:1,companyContact:2,contact:3,company:4,names:{contactCompany:"CONTACT_COMPANY",companyContact:"COMPANY_CONTACT",contact:"CONTACT",company:"COMPANY"},resolveId:function(t){t=t.toUpperCase();if(this.names.contactCompany===t){return this.contactCompany}else if(this.names.companyContact===t){return this.companyContact}else if(this.names.contact===t){return this.contact}else if(this.names.company===t){return this.company}return this.undefined}}}if(typeof BX.Crm.EntityEditorClientLight==="undefined"){BX.Crm.EntityEditorClientLight=function(){BX.Crm.EntityEditorClientLight.superclass.constructor.apply(this);this._map=null;this._info=null;this._primaryLoaderConfig=null;this._secondaryLoaderConfig=null;this._dataElements=null;this._companyInfos=null;this._contactInfos=null;this._enableCompanyMultiplicity=false;this._companyTitleWrapper=null;this._contactTitleWrapper=null;this._companySearchBoxes=null;this._contactSearchBoxes=null;this._companyPanels=null;this._contactPanels=null;this._companyWrapper=null;this._contactWrapper=null;this._addCompanyButton=null;this._addContactButton=null;this._innerWrapper=null;this._layoutType=BX.Crm.EntityEditorClientLayoutType.undefined;this._enableLayoutTypeChange=false;this._enableQuickEdit=null;this._companyNameChangeHandler=BX.delegate(this.onCompanyNameChange,this);this._companyChangeHandler=BX.delegate(this.onCompanyChange,this);this._companyDeletionHandler=BX.delegate(this.onCompanyDelete,this);this._companyResetHandler=BX.delegate(this.onCompanyReset,this);this._contactNameChangeHandler=BX.delegate(this.onContactNameChange,this);this._contactChangeHandler=BX.delegate(this.onContactChange,this);this._contactDeletionHandler=BX.delegate(this.onContactDelete,this);this._contactResetHandler=BX.delegate(this.onContactReset,this);this._requisiteChangeHandler=BX.delegate(this.onRequisiteChange,this);this._multifieldChangeHandler=BX.delegate(this.onMultifieldChange,this)};BX.extend(BX.Crm.EntityEditorClientLight,BX.Crm.EntityEditorField);BX.Crm.EntityEditorClientLight.prototype.doInitialize=function(){BX.Crm.EntityEditorClientLight.superclass.doInitialize.apply(this);this._map=this._schemeElement.getDataObjectParam("map",{});this.initializeFromModel()};BX.Crm.EntityEditorClientLight.prototype.initializeFromModel=function(){this._companyInfos=BX.Collection.create();this._contactInfos=BX.Collection.create();this._info=this._model.getSchemeField(this._schemeElement,"info",{});this.initializeEntityInfos(BX.prop.getArray(this._info,"COMPANY_DATA",[]),this._companyInfos);this.initializeEntityInfos(BX.prop.getArray(this._info,"CONTACT_DATA",[]),this._contactInfos);this._enableCompanyMultiplicity=this._schemeElement.getDataBooleanParam("enableCompanyMultiplicity",false);var t=this._schemeElement.getDataObjectParam("loaders",{});this._primaryLoaderConfig=BX.prop.getObject(t,"primary",{});this._secondaryLoaderConfig=BX.prop.getObject(t,"secondary",{});this._enableLayoutTypeChange=true;var e=this._schemeElement.getDataStringParam("fixedLayoutType","");if(e!==""){var i=BX.Crm.EntityEditorClientLayoutType.resolveId(e);if(i!==BX.Crm.EntityEditorClientLayoutType.undefined){this._layoutType=i;this._enableLayoutTypeChange=false}}};BX.Crm.EntityEditorClientLight.prototype.initializeEntityInfos=function(t,e){for(var i=0,n=t.length;i<n;i++){var r=BX.CrmEntityInfo.create(t[i]);if(r.getId()>0){e.add(r)}}};BX.Crm.EntityEditorClientLight.prototype.createDataElement=function(t,e){var i=BX.prop.getString(this._map,t,"");if(i===""){return}var n=BX.create("input",{attrs:{name:i,type:"hidden"}});if(BX.type.isNotEmptyString(e)){n.value=e}if(!this._dataElements){this._dataElements={}}this._dataElements[t]=n;if(this._wrapper){this._wrapper.appendChild(n)}};BX.Crm.EntityEditorClientLight.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorClientLight.messages;return e.hasOwnProperty(t)?e[t]:BX.Crm.EntityEditorClientLight.superclass.getMessage.apply(this,arguments)};BX.Crm.EntityEditorClientLight.prototype.getOwnerTypeName=function(){return this._editor.getEntityTypeName()};BX.Crm.EntityEditorClientLight.prototype.getOwnerTypeId=function(){return this._editor.getEntityTypeId()};BX.Crm.EntityEditorClientLight.prototype.getOwnerId=function(){return this._editor.getEntityId()};BX.Crm.EntityEditorClientLight.prototype.hasCompanies=function(){return this._companyInfos!==null&&this._companyInfos.length()>0};BX.Crm.EntityEditorClientLight.prototype.hasContacts=function(){return this._contactInfos!==null&&this._contactInfos.length()>0};BX.Crm.EntityEditorClientLight.prototype.addCompany=function(t){if(t instanceof BX.CrmEntityInfo){if(!this._companyInfos){this._companyInfos=BX.Collection.create()}this._companyInfos.add(t)}};BX.Crm.EntityEditorClientLight.prototype.removeCompany=function(t){if(this._companyInfos&&t instanceof BX.CrmEntityInfo){this._companyInfos.remove(t)}};BX.Crm.EntityEditorClientLight.prototype.addContact=function(t){if(t instanceof BX.CrmEntityInfo){if(!this._contactInfos){this._contactInfos=BX.Collection.create()}this._contactInfos.add(t)}};BX.Crm.EntityEditorClientLight.prototype.removeContact=function(t){if(this._contactInfos&&t instanceof BX.CrmEntityInfo){this._contactInfos.remove(t)}};BX.Crm.EntityEditorClientLight.prototype.hasContentToDisplay=function(){return this.hasCompanies()||this._contactInfos!==null&&this._contactInfos.length()>0};BX.Crm.EntityEditorClientLight.prototype.getContentWrapper=function(){return this._innerWrapper};BX.Crm.EntityEditorClientLight.prototype.getModeSwitchType=function(t){var e=BX.Crm.EntityEditorModeSwitchType.common;if(t===BX.Crm.EntityEditorMode.edit){e|=BX.Crm.EntityEditorModeSwitchType.button|BX.Crm.EntityEditorModeSwitchType.content}return e};BX.Crm.EntityEditorClientLight.prototype.reset=function(){this.initializeFromModel()};BX.Crm.EntityEditorClientLight.prototype.rollback=function(){if(this.isChanged()){this.initializeFromModel()}};BX.Crm.EntityEditorClientLight.prototype.getEntityCreateUrl=function(t){return this._editor.getEntityCreateUrl(t)};BX.Crm.EntityEditorClientLight.prototype.getEntityEditUrl=function(t,e){return this._editor.getEntityEditUrl(t,e)};BX.Crm.EntityEditorClientLight.prototype.doSetMode=function(t){this.rollback()};BX.Crm.EntityEditorClientLight.prototype.doPrepareContextMenuItems=function(t){t.push({delimiter:true});if(this._enableLayoutTypeChange){var e=this.getLayoutType();if(e===BX.Crm.EntityEditorClientLayoutType.companyContact||e===BX.Crm.EntityEditorClientLayoutType.contactCompany){t.push({value:"set_layout_contact",text:this.getMessage("disableCompany")});t.push({value:"set_layout_company",text:this.getMessage("disableContact")})}else if(e===BX.Crm.EntityEditorClientLayoutType.company){t.push({value:"set_layout_company_contact",text:this.getMessage("enableContact")})}else if(e===BX.Crm.EntityEditorClientLayoutType.contact){t.push({value:"set_layout_contact_company",text:this.getMessage("enableCompany")})}if(e===BX.Crm.EntityEditorClientLayoutType.companyContact){t.push({delimiter:true});t.push({value:"set_layout_contact_company",text:this.getMessage("displayContactAtFirst")})}else if(e===BX.Crm.EntityEditorClientLayoutType.contactCompany){t.push({delimiter:true});t.push({value:"set_layout_company_contact",text:this.getMessage("displayCompanyAtFirst")})}t.push({delimiter:true})}if(this.isQuickEditEnabled()){t.push({value:"disable_quick_edit",text:this.getMessage("disableQuickEdit")})}else{t.push({value:"enable_quick_edit",text:this.getMessage("enableQuickEdit")})}};BX.Crm.EntityEditorClientLight.prototype.processContextMenuCommand=function(t,e){if(e==="set_layout_contact_company"){window.setTimeout(function(){this.setLayoutType(BX.Crm.EntityEditorClientLayoutType.contactCompany)}.bind(this),100)}else if(e==="set_layout_company_contact"){window.setTimeout(function(){this.setLayoutType(BX.Crm.EntityEditorClientLayoutType.companyContact)}.bind(this),100)}else if(e==="set_layout_contact"){window.setTimeout(function(){this.setLayoutType(BX.Crm.EntityEditorClientLayoutType.contact)}.bind(this),100)}else if(e==="set_layout_company"){window.setTimeout(function(){this.setLayoutType(BX.Crm.EntityEditorClientLayoutType.company)}.bind(this),100)}else if(e==="disable_quick_edit"){this.enableQuickEdit(false)}else if(e==="enable_quick_edit"){this.enableQuickEdit(true)}BX.Crm.EntityEditorClientLight.superclass.processContextMenuCommand.apply(this,arguments)};BX.Crm.EntityEditorClientLight.prototype.isQuickEditEnabled=function(){if(this._enableQuickEdit===null){this._enableQuickEdit=this._editor.getConfigOption("enableQuickEdit","Y")==="Y"}return this._enableQuickEdit};BX.Crm.EntityEditorClientLight.prototype.enableQuickEdit=function(t){t=!!t;if(this._enableQuickEdit===null){this._enableQuickEdit=this._editor.getConfigOption("enableQuickEdit","Y")==="Y"}if(this._enableQuickEdit===t){return}this._enableQuickEdit=t;this._editor.setConfigOption("enableQuickEdit",t?"Y":"N");var e,i;if(this._companySearchBoxes){for(e=0,i=this._companySearchBoxes.length;e<i;e++){this._companySearchBoxes[e].enableQuickEdit(t)}}if(this._contactSearchBoxes){for(e=0,i=this._contactSearchBoxes.length;e<i;e++){this._contactSearchBoxes[e].enableQuickEdit(t)}}};BX.Crm.EntityEditorClientLight.prototype.isCompanyEnabled=function(){var t=this.getLayoutType();return t===BX.Crm.EntityEditorClientLayoutType.contactCompany||t===BX.Crm.EntityEditorClientLayoutType.companyContact||t===BX.Crm.EntityEditorClientLayoutType.company};BX.Crm.EntityEditorClientLight.prototype.isContactEnabled=function(){var t=this.getLayoutType();return t===BX.Crm.EntityEditorClientLayoutType.contactCompany||t===BX.Crm.EntityEditorClientLayoutType.companyContact||t===BX.Crm.EntityEditorClientLayoutType.contact};BX.Crm.EntityEditorClientLight.prototype.getLayoutType=function(){if(this._layoutType<=0){var t=this._editor.getConfigOption("client_layout","");var e=parseInt(t);if(isNaN(e)||e<=0){e=BX.Crm.EntityEditorClientLayoutType.companyContact}this._layoutType=e}return this._layoutType};BX.Crm.EntityEditorClientLight.prototype.setLayoutType=function(t){if(!BX.type.isNumber(t)){t=parseInt(t)}if(isNaN(t)||t<=0){return}if(t===this._layoutType){return}this._layoutType=t;this._editor.setConfigOption("client_layout",t);this.refreshLayout()};BX.Crm.EntityEditorClientLight.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated();this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}this._wrapper.appendChild(this.createTitleNode(this.getTitle()));if(!this.hasContentToDisplay()&&this.isInViewMode()){this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-inner"},text:this.getMessage("isEmpty")});this._wrapper.appendChild(this._innerWrapper)}else{this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"}});this._wrapper.appendChild(this._innerWrapper);var e=this.getLayoutType();if(this.isInEditMode()){var i=BX.create("div",{props:{className:"crm-entity-widget-content-block-field-container"}});this._innerWrapper.appendChild(i);this._innerContainer=BX.create("div",{props:{className:"crm-entity-widget-content-block-field-container-inner"}});i.appendChild(this._innerContainer)}else{BX.addClass(this._wrapper,"crm-entity-widget-participants-block");BX.addClass(this._innerWrapper,"crm-entity-widget-inner")}if(this.isContactEnabled()&&this.isCompanyEnabled()){if(e===BX.Crm.EntityEditorClientLayoutType.contactCompany){this.renderContact();this.renderCompany()}else if(e===BX.Crm.EntityEditorClientLayoutType.companyContact){this.renderCompany();this.renderContact()}}else{if(this.isContactEnabled()){this.renderContact()}if(this.isCompanyEnabled()){this.renderCompany()}}}if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._entityEditParams={};this._hasLayout=true};BX.Crm.EntityEditorClientLight.prototype.switchToSingleEditMode=function(t){this._entityEditParams={};if(this.isInViewMode()&&this.isQuickEditEnabled()&&BX.type.isElementNode(t)){var e=false;if(BX.isParentForNode(this._companyTitleWrapper,t)){e=true;this._entityEditParams["enableCompany"]=true;this._entityEditParams["companyIndex"]=0}if(!e&&BX.isParentForNode(this._contactTitleWrapper,t)){e=true;this._entityEditParams["enableContact"]=true;this._entityEditParams["contactIndex"]=0}var i,n;if(!e&&this._companyPanels!==null){for(i=0,n=this._companyPanels.length;i<n;i++){if(this._companyPanels[i].checkOwership(t)){e=true;this._entityEditParams["enableCompany"]=true;this._entityEditParams["companyIndex"]=i;break}}}if(!e&&this._contactPanels!==null){for(i=0,n=this._contactPanels.length;i<n;i++){if(this._contactPanels[i].checkOwership(t)){e=true;this._entityEditParams["enableContact"]=true;this._entityEditParams["contactIndex"]=i;break}}}if(!BX.prop.getBoolean(this._entityEditParams,"enableCompany",false)&&!BX.prop.getBoolean(this._entityEditParams,"enableContact",false)){var r=this.getLayoutType();if(r===BX.Crm.EntityEditorClientLayoutType.contact||r===BX.Crm.EntityEditorClientLayoutType.contactCompany){this._entityEditParams["enableContact"]=true;this._entityEditParams["contactIndex"]=0}else if(r===BX.Crm.EntityEditorClientLayoutType.company||r===BX.Crm.EntityEditorClientLayoutType.companyContact){this._entityEditParams["enableCompany"]=true}}}BX.Crm.EntityEditorClientLight.superclass.switchToSingleEditMode.apply(this,arguments)};BX.Crm.EntityEditorClientLight.prototype.getEntityInitialMode=function(t){if(!this.isQuickEditEnabled()){return BX.Crm.EntityEditorClientMode.select}if(!this.checkModeOption(BX.Crm.EntityEditorModeOptions.individual)){return BX.Crm.EntityEditorClientMode.edit}return BX.prop.getBoolean(this._entityEditParams,t===BX.CrmEntityType.enumeration.contact?"enableContact":"enableCompany",false)?BX.Crm.EntityEditorClientMode.edit:BX.Crm.EntityEditorClientMode.select};BX.Crm.EntityEditorClientLight.prototype.renderContact=function(){var t=this._schemeElement.getDataStringParam("contactLegend","");if(t===""){t=BX.CrmEntityType.getCaptionByName(BX.CrmEntityType.names.contact)}if(this.isInEditMode()){this._contactWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-inner-row"}});this._innerContainer.appendChild(this._contactWrapper);this._contactTitleWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-title"},children:[BX.create("span",{props:{className:"crm-entity-widget-content-block-title-text"},text:t})]});this._contactWrapper.appendChild(this._contactTitleWrapper);this._addContactButton=BX.create("span",{props:{className:"crm-entity-widget-actions-btn-add"},text:this.getMessage("addParticipant")});this._contactWrapper.appendChild(this._addContactButton);BX.bind(this._addContactButton,"click",BX.delegate(this.onContactAddButtonClick,this));this._contactSearchBoxes=[];if(this._contactInfos.length()>0){var e=this.getEntityInitialMode(BX.CrmEntityType.enumeration.contact);var i=e===BX.Crm.EntityEditorClientMode.edit?BX.prop.getInteger(this._entityEditParams,"contactIndex",-1):-1;for(var n=0,r=this._contactInfos.length();n<r;n++){var o=e;if(o===BX.Crm.EntityEditorClientMode.edit&&!(i===n||i===-1)){o=BX.Crm.EntityEditorClientMode.select}this.addContactSearchBox(this.createContactSearchBox({entityInfo:this._contactInfos.get(n),mode:o}))}}else{this.addContactSearchBox(this.createContactSearchBox())}}else if(this._contactInfos.length()>0&&this.isContactEnabled()){this._contactTitleWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-title"}});var s=BX.create("span",{props:{className:"crm-entity-widget-content-subtitle-text"},children:[BX.create("span",{text:t})]});this._contactTitleWrapper.appendChild(s);if(!this.isReadOnly()){s.appendChild(BX.create("span",{props:{className:"crm-entity-card-widget-title-edit-icon"}}))}this._innerWrapper.appendChild(this._contactTitleWrapper);this._contactPanels=[];for(n=0,r=this._contactInfos.length();n<r;n++){var a=this._contactInfos.get(n);var l={editor:this,entityInfo:a,enableEntityTypeCaption:false,enableRequisite:false,mode:BX.Crm.EntityEditorMode.view};var d=n===0&&!(this.isCompanyEnabled()&&this.hasCompanies());if(d){l["enableRequisite"]=true;l["requisiteBinding"]=this._model.getField("REQUISITE_BINDING",{});l["requisiteSelectUrl"]=this._editor.getEntityRequisiteSelectUrl(BX.CrmEntityType.names.contact,a.getId());l["requisiteMode"]=BX.Crm.EntityEditorMode.edit}var h=BX.Crm.ClientEditorEntityPanel.create(this._id+"_"+a.getId().toString(),l);this._contactPanels.push(h);h.setContainer(this._innerWrapper);h.layout();if(d){h.addRequisiteChangeListener(this._requisiteChangeHandler)}}}};BX.Crm.EntityEditorClientLight.prototype.renderCompany=function(){var t=this._schemeElement.getDataStringParam("companyLegend","");if(t===""){t=BX.CrmEntityType.getCaptionByName(BX.CrmEntityType.names.company)}if(this.isInEditMode()){this._companyWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-inner-row"}});this._innerContainer.appendChild(this._companyWrapper);this._companyTitleWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-title"},children:[BX.create("span",{props:{className:"crm-entity-widget-content-block-title-text"},text:t})]});this._companyWrapper.appendChild(this._companyTitleWrapper);if(this._enableCompanyMultiplicity){this._addCompanyButton=BX.create("span",{props:{className:"crm-entity-widget-actions-btn-add"},text:this.getMessage("addParticipant")});this._companyWrapper.appendChild(this._addCompanyButton);BX.bind(this._addCompanyButton,"click",BX.delegate(this.onCompanyAddButtonClick,this))}this._companySearchBoxes=[];if(this._companyInfos.length()>0){var e=this.getEntityInitialMode(BX.CrmEntityType.enumeration.company);var i=e===BX.Crm.EntityEditorClientMode.edit?BX.prop.getInteger(this._entityEditParams,"companyIndex",-1):-1;for(var n=0,r=this._companyInfos.length();n<r;n++){var o=e;if(o===BX.Crm.EntityEditorClientMode.edit&&!(i===n||i===-1)){o=BX.Crm.EntityEditorClientMode.select}this.addCompanySearchBox(this.createCompanySearchBox({entityInfo:this._companyInfos.get(n),mode:o}))}}else{this.addCompanySearchBox(this.createCompanySearchBox())}}else if(this.isCompanyEnabled()&&this._companyInfos.length()>0){this._companyTitleWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-title"}});var s=BX.create("span",{props:{className:"crm-entity-widget-content-subtitle-text"},children:[BX.create("span",{text:t})]});this._companyTitleWrapper.appendChild(s);if(!this.isReadOnly()){s.appendChild(BX.create("span",{props:{className:"crm-entity-card-widget-title-edit-icon"}}))}this._innerWrapper.appendChild(this._companyTitleWrapper);this._companyPanels=[];for(n=0,r=this._companyInfos.length();n<r;n++){var a=this._companyInfos.get(n);var l={editor:this,entityInfo:a,enableEntityTypeCaption:false,enableRequisite:false,mode:BX.Crm.EntityEditorMode.view};var d=n===0;if(d){l["enableRequisite"]=true;l["requisiteBinding"]=this._model.getField("REQUISITE_BINDING",{});l["requisiteSelectUrl"]=this._editor.getEntityRequisiteSelectUrl(BX.CrmEntityType.names.company,a.getId());l["requisiteMode"]=BX.Crm.EntityEditorMode.edit}var h=BX.Crm.ClientEditorEntityPanel.create(this._id+"_"+a.getId().toString(),l);this._companyPanels.push(h);h.setContainer(this._innerWrapper);h.layout();if(d){h.addRequisiteChangeListener(this._requisiteChangeHandler)}}}};BX.Crm.EntityEditorClientLight.prototype.createCompanySearchBox=function(t){var e=BX.prop.get(t,"entityInfo",null);if(e!==null&&!(e instanceof BX.CrmEntityInfo)){e=null}var i=this._editor.canCreateCompany();if(i){i=BX.prop.getBoolean(this._schemeElement.getDataObjectParam("creation",{}),BX.CrmEntityType.names.company.toLowerCase(),true)}return BX.Crm.EntityEditorClientSearchBox.create(this._id,{entityTypeName:BX.CrmEntityType.names.company,entityInfo:e,enableCreation:i,enableDeletion:false,enableQuickEdit:this.isQuickEditEnabled(),mode:BX.prop.getInteger(t,"mode",BX.Crm.EntityEditorClientMode.select),editor:this._editor,loaderConfig:this._primaryLoaderConfig,lastEntityInfos:this._model.getSchemeField(this._schemeElement,"lastCompanyInfos",[]),container:this._companyWrapper,placeholder:this.getMessage("companySearchPlaceholder"),parentField:this})};BX.Crm.EntityEditorClientLight.prototype.addCompanySearchBox=function(t,e){if(!BX.type.isPlainObject(e)){e={}}this._companySearchBoxes.push(t);var i=BX.prop.getObject(e,"layoutOptions",{});if(this._addCompanyButton){i["anchor"]=this._addCompanyButton}t.layout(i);t.addResetListener(this._companyResetHandler);t.addTitleChangeListener(this._companyNameChangeHandler);t.addChangeListener(this._companyChangeHandler);t.addDeletionListener(this._companyDeletionHandler);t.addMultifieldChangeListener(this._multifieldChangeHandler);var n=this._companySearchBoxes.length>1;for(var r=0,o=this._companySearchBoxes.length;r<o;r++){this._companySearchBoxes[r].enableDeletion(n)}return t};BX.Crm.EntityEditorClientLight.prototype.removeCompanySearchBox=function(t){var e=this.findCompanySearchBoxIndex(t);if(e<0){return}t.removeResetListener(this._companyResetHandler);t.removeTitleChangeListener(this._companyNameChangeHandler);t.removeChangeListener(this._companyChangeHandler);t.removeDeletionListener(this._companyDeletionHandler);t.removeMultifieldChangeListener(this._multifieldChangeHandler);t.clearLayout();this._companySearchBoxes.splice(e,1);var i=this._companySearchBoxes.length>1;for(var n=0,r=this._companySearchBoxes.length;n<r;n++){this._companySearchBoxes[n].enableDeletion(i)}};BX.Crm.EntityEditorClientLight.prototype.findCompanySearchBoxIndex=function(t){for(var e=0,i=this._companySearchBoxes.length;e<i;e++){if(t===this._companySearchBoxes[e]){return e}}return-1};BX.Crm.EntityEditorClientLight.prototype.createContactSearchBox=function(t){var e=BX.prop.get(t,"entityInfo",null);if(e!==null&&!(e instanceof BX.CrmEntityInfo)){e=null}var i=this._editor.canCreateContact();if(i){i=BX.prop.getBoolean(this._schemeElement.getDataObjectParam("creation",{}),BX.CrmEntityType.names.contact.toLowerCase(),true)}return BX.Crm.EntityEditorClientSearchBox.create(this._id,{entityTypeName:BX.CrmEntityType.names.contact,entityInfo:e,enableCreation:i,enableDeletion:BX.prop.getBoolean(t,"enableDeletion",true),enableQuickEdit:this.isQuickEditEnabled(),mode:BX.prop.getInteger(t,"mode",BX.Crm.EntityEditorClientMode.select),editor:this._editor,loaderConfig:this._primaryLoaderConfig,lastEntityInfos:this._model.getSchemeField(this._schemeElement,"lastContactInfos",[]),container:this._contactWrapper,placeholder:this.getMessage("contactSearchPlaceholder"),parentField:this})};BX.Crm.EntityEditorClientLight.prototype.addContactSearchBox=function(t,e){if(!BX.type.isPlainObject(e)){e={}}this._contactSearchBoxes.push(t);var i=BX.prop.getObject(e,"layoutOptions",{});if(this._addContactButton){i["anchor"]=this._addContactButton}t.layout(i);t.addResetListener(this._contactResetHandler);t.addTitleChangeListener(this._contactNameChangeHandler);t.addChangeListener(this._contactChangeHandler);t.addDeletionListener(this._contactDeletionHandler);t.addMultifieldChangeListener(this._multifieldChangeHandler);var n=this._contactSearchBoxes.length>1;for(var r=0,o=this._contactSearchBoxes.length;r<o;r++){this._contactSearchBoxes[r].enableDeletion(n)}return t};BX.Crm.EntityEditorClientLight.prototype.removeContactSearchBox=function(t){var e=this.findContactSearchBoxIndex(t);if(e<0){return}t.removeResetListener(this._contactResetHandler);t.removeTitleChangeListener(this._contactNameChangeHandler);t.removeChangeListener(this._contactChangeHandler);t.removeDeletionListener(this._contactDeletionHandler);t.removeMultifieldChangeListener(this._multifieldChangeHandler);t.clearLayout();this._contactSearchBoxes.splice(e,1);var i=this._contactSearchBoxes.length>1;for(var n=0,r=this._contactSearchBoxes.length;n<r;n++){this._contactSearchBoxes[n].enableDeletion(i)}};BX.Crm.EntityEditorClientLight.prototype.removeContactAllSearchBoxes=function(){for(var t=0,e=this._contactSearchBoxes.length;t<e;t++){var i=this._contactSearchBoxes[t];i.removeResetListener(this._contactResetHandler);i.removeChangeListener(this._contactChangeHandler);i.removeDeletionListener(this._contactDeletionHandler);i.clearLayout()}this._contactSearchBoxes=[]};BX.Crm.EntityEditorClientLight.prototype.findContactSearchBoxIndex=function(t){for(var e=0,i=this._contactSearchBoxes.length;e<i;e++){if(t===this._contactSearchBoxes[e]){return e}}return-1};BX.Crm.EntityEditorClientLight.prototype.save=function(){this._info["COMPANY_DATA"]=this.saveEntityInfos(this._companySearchBoxes,this._companyInfos);this._info["CONTACT_DATA"]=this.saveEntityInfos(this._contactSearchBoxes,this._contactInfos)};BX.Crm.EntityEditorClientLight.prototype.saveEntityInfos=function(t,e){var i,n;if(t!==null){for(i=0,n=t.length;i<n;i++){if(t[i].isNeedToSave()){t[i].save()}}}var r=[];if(e!==null){var o=e.getItems();for(i=0,n=o.length;i<n;i++){r.push(o[i].getSettings())}}return r};BX.Crm.EntityEditorClientLight.prototype.onContactAddButtonClick=function(t){this.addContactSearchBox(this.createContactSearchBox()).focus()};BX.Crm.EntityEditorClientLight.prototype.onCompanyAddButtonClick=function(t){if(this._enableCompanyMultiplicity){this.addCompanySearchBox(this.createCompanySearchBox()).focus()}};BX.Crm.EntityEditorClientLight.prototype.onCompanyReset=function(t,e){if(e){this.removeCompany(e);this.markAsChanged()}};BX.Crm.EntityEditorClientLight.prototype.onCompanyNameChange=function(t){this.markAsChanged()};BX.Crm.EntityEditorClientLight.prototype.onCompanyChange=function(t,e,i){var n=false;if(i){this.removeCompany(i);n=true}if(e){this.addCompany(e);n=true}if(!n){return}this.markAsChanged();if(!this._enableCompanyMultiplicity){if(e.getId()>0){var r=BX.prop.getObject(this._secondaryLoaderConfig,BX.CrmEntityType.names.company,null);if(r){BX.CrmDataLoader.create(this._id,{serviceUrl:r["url"],action:r["action"],params:{PRIMARY_TYPE_NAME:BX.CrmEntityType.names.company,PRIMARY_ID:e.getId(),SECONDARY_TYPE_NAME:BX.CrmEntityType.names.contact,OWNER_TYPE_NAME:this.getOwnerTypeName()}}).load(BX.delegate(this.onContactInfosLoad,this))}}}};BX.Crm.EntityEditorClientLight.prototype.onCompanyDelete=function(t,e){if(e){this._companyInfos.remove(e);this.markAsChanged()}this.removeCompanySearchBox(t)};BX.Crm.EntityEditorClientLight.prototype.onContactChange=function(t,e,i){var n=false;if(i){this.removeContact(i);n=true}if(e){this.addContact(e);n=true}if(n){this.markAsChanged()}};BX.Crm.EntityEditorClientLight.prototype.onContactNameChange=function(t){this.markAsChanged()};BX.Crm.EntityEditorClientLight.prototype.onContactDelete=function(t,e){if(e){this._contactInfos.remove(e);this.markAsChanged()}this.removeContactSearchBox(t)};BX.Crm.EntityEditorClientLight.prototype.onContactReset=function(t,e){if(e){this.removeContact(e);this.markAsChanged()}};BX.Crm.EntityEditorClientLight.prototype.onContactInfosLoad=function(t,e){var i,n;var r=[];var o=BX.type.isArray(e["ENTITY_INFOS"])?e["ENTITY_INFOS"]:[];for(i=0,n=o.length;i<n;i++){r.push(BX.CrmEntityInfo.create(o[i]))}this._contactInfos.removeAll();for(i=0,n=r.length;i<n;i++){this._contactInfos.add(r[i])}this.markAsChanged();this.removeContactAllSearchBoxes();if(r.length>0){for(i=0,n=r.length;i<n;i++){this.addContactSearchBox(this.createContactSearchBox({entityInfo:r[i]}))}}else{this.addContactSearchBox(this.createContactSearchBox())}};BX.Crm.EntityEditorClientLight.prototype.onRequisiteChange=function(t,e){if(this.isInEditMode()){this.markAsChanged()}else{this._editor.saveData({REQUISITE_ID:BX.prop.getInteger(e,"requisiteId",0),BANK_DETAIL_ID:BX.prop.getInteger(e,"bankDetailId",0)})}};BX.Crm.EntityEditorClientLight.prototype.onMultifieldChange=function(t){this.markAsChanged()};BX.Crm.EntityEditorClientLight.prototype.prepareEntitySubmitData=function(t){if(!BX.type.isArray(t)){return[]}var e=[];for(var i=0,n=t.length;i<n;i++){var r=t[i].getEntity();if(!r){continue}var o={};var s=t[i].getMode();if(s===BX.Crm.EntityEditorClientMode.select||s===BX.Crm.EntityEditorClientMode.edit&&r.getTitle()!==""){o["id"]=r.getId()}if(s===BX.Crm.EntityEditorClientMode.create||s===BX.Crm.EntityEditorClientMode.edit&&r.getTitle()!==""){o["title"]=r.getTitle();o["multifields"]=r.getMultifields()}e.push(o)}return e};BX.Crm.EntityEditorClientLight.prototype.onBeforeSubmit=function(){var t={};if(this.isCompanyEnabled()){t["COMPANY_DATA"]=this.prepareEntitySubmitData(this._companySearchBoxes)}if(this.isContactEnabled()){t["CONTACT_DATA"]=this.prepareEntitySubmitData(this._contactSearchBoxes)}this.createDataElement("data",JSON.stringify(t))};if(typeof BX.Crm.EntityEditorClientLight.messages==="undefined"){BX.Crm.EntityEditorClientLight.messages={}}BX.Crm.EntityEditorClientLight.create=function(t,e){var i=new BX.Crm.EntityEditorClientLight;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorClient==="undefined"){BX.Crm.EntityEditorClient=function(){BX.Crm.EntityEditorClient.superclass.constructor.apply(this);this._info=null;this._enablePrimaryEntity=true;this._primaryEntityTypeName="";this._primaryEntityInfo=null;this._primaryEntityBindingInfos=null;this._primaryEntityEditor=null;this._secondaryEntityTypeName="";this._secondaryEntityInfos=null;this._secondaryEntityEditor=null;this._dataElements=null;this._map=null;this._bindingTracker=null;this._innerWrapper=null};BX.extend(BX.Crm.EntityEditorClient,BX.Crm.EntityEditorField);BX.Crm.EntityEditorClient.prototype.doInitialize=function(){BX.Crm.EntityEditorClient.superclass.doInitialize.apply(this);this._map=this._schemeElement.getDataObjectParam("map",{});this.initializeFromModel()};BX.Crm.EntityEditorClient.prototype.initializeFromModel=function(){this._info=this._model.getSchemeField(this._schemeElement,"info",{});this._enablePrimaryEntity=this._schemeElement.getDataBooleanParam("enablePrimaryEntity",true);if(this._enablePrimaryEntity){var t=BX.prop.getObject(this._info,"PRIMARY_ENTITY_DATA",null);var e=t?BX.CrmEntityInfo.create(t):null;if(e){this.setPrimaryEntity(e)}else{this.setPrimaryEntityTypeName(this._schemeElement.getDataStringParam("primaryEntityTypeName",BX.CrmEntityType.names.company))}}this.setSecondaryEntityTypeName(this._schemeElement.getDataStringParam("secondaryEntityTypeName",BX.CrmEntityType.names.contact));var i=null;var n=this._schemeElement.getDataStringParam("secondaryEntityInfo","");if(n!==""){i=this._model.getField(n,[])}else{i=BX.prop.getArray(this._info,"SECONDARY_ENTITY_DATA",[])}this._secondaryEntityInfos=BX.Collection.create();this._primaryEntityBindingInfos=BX.Collection.create();var r=e&&e.getTypeName()===BX.CrmEntityType.names.company?e.getId():0;var o,s,a;for(o=0,s=i.length;o<s;o++){a=BX.CrmEntityInfo.create(i[o]);if(a.getId()<=0){continue}if(r>0&&a.checkEntityBinding(BX.CrmEntityType.names.company,r)){this._primaryEntityBindingInfos.add(a)}else{this._secondaryEntityInfos.add(a)}}this._bindingTracker=BX.Crm.EntityBindingTracker.create()};BX.Crm.EntityEditorClient.prototype.hasContentToDisplay=function(){return this._primaryEntityInfo!==null||this._secondaryEntityInfos!==null&&this._secondaryEntityInfos.length()>0};BX.Crm.EntityEditorClient.prototype.getModeSwitchType=function(t){var e=BX.Crm.EntityEditorModeSwitchType.common;if(t===BX.Crm.EntityEditorMode.edit){e|=BX.Crm.EntityEditorModeSwitchType.button|BX.Crm.EntityEditorModeSwitchType.content}return e};BX.Crm.EntityEditorClient.prototype.getContentWrapper=function(){return this._innerWrapper};BX.Crm.EntityEditorClient.prototype.getEntityCreateUrl=function(t){return this._editor.getEntityCreateUrl(t)};BX.Crm.EntityEditorClient.prototype.getEntityRequisiteSelectUrl=function(t,e){return this._editor.getEntityRequisiteSelectUrl(t,e)};BX.Crm.EntityEditorClient.prototype.reset=function(){this.initializeFromModel()};BX.Crm.EntityEditorClient.prototype.rollback=function(){if(this.isChanged()){this.initializeFromModel()}};BX.Crm.EntityEditorClient.prototype.doSetMode=function(t){this.rollback()};BX.Crm.EntityEditorClient.prototype.createDataElement=function(t,e){var i=BX.prop.getString(this._map,t,"");if(i===""){return}var n=BX.create("input",{attrs:{name:i,type:"hidden",value:e}});if(!this._dataElements){this._dataElements={}}this._dataElements[t]=n;if(this._wrapper){this._wrapper.appendChild(n)}};BX.Crm.EntityEditorClient.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated();this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}var e=this._schemeElement.getTitle();if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}this._dataElements={};if(!this.hasContentToDisplay()&&this.isInViewMode()){this._wrapper.appendChild(this.createTitleNode(e));this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},text:this.getMessage("isEmpty")})}else{this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-clients-block"}});this._innerWrapper.appendChild(this.createTitleNode(e));if(this.isInEditMode()){if(this._enablePrimaryEntity){this.createDataElement("primaryEntityType",this.getPrimaryEntityTypeName());this.createDataElement("primaryEntityId",this.getPrimaryEntityId());this.createDataElement("unboundSecondaryEntityIds","");this.createDataElement("boundSecondaryEntityIds","")}this.createDataElement("secondaryEntityType",this.getSecondaryEntityTypeName());this.createDataElement("secondaryEntityIds",this.getAllSecondaryEntityIds().join(","))}var i=BX.create("div",{props:{className:this.isInEditMode()?"crm-entity-widget-content-block-clients":""}});this._innerWrapper.appendChild(i);var n=BX.create("div",{});i.appendChild(n);var r=this._schemeElement.getDataObjectParam("loaders",{});var o=BX.prop.getObject(r,"primary",{});var s=BX.prop.getObject(r,"secondary",{});if(this._enablePrimaryEntity){this._primaryEntityEditor=BX.Crm.PrimaryClientEditor.create(this._id+"_PRIMARY",{entityInfo:this._primaryEntityInfo,entityTypeName:this._primaryEntityTypeName,lastEntityInfos:this._model.getSchemeField(this._schemeElement,"lastPrimaryEntityInfos",[]),loaderConfig:o,requisiteBinding:this._model.getField("REQUISITE_BINDING",{}),editor:this,mode:this._mode,onChange:BX.delegate(this.onPrimaryEntityChange,this),onDelete:BX.delegate(this.onPrimaryEntityDelete,this),onBindingAdd:BX.delegate(this.onPrimaryEntityBindingAdd,this),onBindingDelete:BX.delegate(this.onPrimaryEntityBindingDelete,this),onBindingRelease:BX.delegate(this.onPrimaryEntityBindingRelease,this),container:i,achor:n});this._primaryEntityEditor.layout()}var a=BX.create("div",{props:{className:"crm-entity-widget-participants-container"}});i.appendChild(a);this._secondaryEntityEditor=BX.Crm.SecondaryClientEditor.create(this._id+"_SECONDARY",{entityInfos:this._secondaryEntityInfos.getItems(),entityTypeName:this._secondaryEntityTypeName,entityLegend:this._schemeElement.getDataStringParam("secondaryEntityLegend",""),lastEntityInfos:this._model.getSchemeField(this._schemeElement,"lastSecondaryEntityInfos",[]),primaryLoader:o,secondaryLoader:s,mode:this._mode,onAdd:BX.delegate(this.onSecondaryEntityAdd,this),onDelete:BX.delegate(this.onSecondaryEntityDelete,this),onBeforeAdd:BX.delegate(this.onSecondaryEntityBeforeAdd,this),editor:this,container:a});this._secondaryEntityEditor.layout();if(this._primaryEntityEditor){if(this.isInEditMode()){this._secondaryEntityEditor.setVisible(this._primaryEntityInfo!==null)}else{this._secondaryEntityEditor.setVisible(this._secondaryEntityInfos.length()>0)}}}this._wrapper.appendChild(this._innerWrapper);if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorClient.prototype.doClearLayout=function(t){if(this._primaryEntityEditor){this._primaryEntityEditor.clearLayout();this._primaryEntityEditor=null}if(this._secondaryEntityEditor){this._secondaryEntityEditor.clearLayout();this._secondaryEntityEditor=null}for(var e in this._dataElements){if(this._dataElements.hasOwnProperty(e)){BX.remove(this._dataElements[e])}}this._dataElements=null;this._innerWrapper=null};BX.Crm.EntityEditorClient.prototype.getOwnerTypeName=function(){return this._editor.getEntityTypeName()};BX.Crm.EntityEditorClient.prototype.getOwnerTypeId=function(){return this._editor.getEntityTypeId()};BX.Crm.EntityEditorClient.prototype.getOwnerId=function(){return this._editor.getEntityId()};BX.Crm.EntityEditorClient.prototype.getPrimaryEntityTypeName=function(){return this._primaryEntityTypeName};BX.Crm.EntityEditorClient.prototype.setPrimaryEntityTypeName=function(t){if(this._primaryEntityTypeName!==t){this._primaryEntityTypeName=t}};BX.Crm.EntityEditorClient.prototype.getPrimaryEntityId=function(){return this._primaryEntityInfo?this._primaryEntityInfo.getId():0};BX.Crm.EntityEditorClient.prototype.getPrimaryEntity=function(){return this._primaryEntityInfo};BX.Crm.EntityEditorClient.prototype.setPrimaryEntity=function(t){if(t instanceof BX.CrmEntityInfo){this._primaryEntityInfo=t;this.setPrimaryEntityTypeName(t.getTypeName())}else{this._primaryEntityInfo=null}this.markAsChanged()};BX.Crm.EntityEditorClient.prototype.getPrimaryEntityBindings=function(){return this._primaryEntityBindingInfos};BX.Crm.EntityEditorClient.prototype.getSecondaryEntityTypeName=function(){return this._secondaryEntityTypeName};BX.Crm.EntityEditorClient.prototype.setSecondaryEntityTypeName=function(t){if(this._secondaryEntityTypeName!==t){this._secondaryEntityTypeName=t}};BX.Crm.EntityEditorClient.prototype.getSecondaryEntities=function(){return this._secondaryEntityInfos.getItems()};BX.Crm.EntityEditorClient.prototype.getSecondaryEntityById=function(t){if(!this._secondaryEntityInfos){return null}return this._secondaryEntityInfos.search(function(e){return e.getId()===t})};BX.Crm.EntityEditorClient.prototype.removeSecondaryEntity=function(t){if(this._secondaryEntityInfos){this._secondaryEntityInfos.remove(t);this.markAsChanged()}};BX.Crm.EntityEditorClient.prototype.addSecondaryEntity=function(t){if(this._secondaryEntityInfos){this._secondaryEntityInfos.add(t);this.markAsChanged()}};BX.Crm.EntityEditorClient.prototype.onSecondaryEntityDelete=function(t,e){this.removeSecondaryEntity(e)};BX.Crm.EntityEditorClient.prototype.onSecondaryEntityBeforeAdd=function(t,e,i){if(this._primaryEntityEditor&&this._primaryEntityInfo&&this._primaryEntityInfo.getTypeName()===BX.CrmEntityType.names.company){var n=this._primaryEntityInfo.getId();if(e.checkEntityBinding(BX.CrmEntityType.names.company,n)&&!this._bindingTracker.isUnbound(e)){this._primaryEntityEditor.addBinding(this._primaryEntityEditor.createBinding(e));i["cancel"]=true}}};BX.Crm.EntityEditorClient.prototype.onSecondaryEntityAdd=function(t,e){this.addSecondaryEntity(e)};BX.Crm.EntityEditorClient.prototype.onSecondaryEntityBind=function(t,e){this._secondaryEntityEditor.removeItem(this._secondaryEntityEditor.getItemById(e.getId()));if(this._primaryEntityEditor){this._primaryEntityEditor.addBinding(this._primaryEntityEditor.createBinding(e))}this._bindingTracker.bind(e)};BX.Crm.EntityEditorClient.prototype.getAllSecondaryEntityIds=function(){var t=this.getAllSecondaryEntityInfos();var e=[];for(var i=0,n=t.length;i<n;i++){e.push(t[i].getId())}return e};BX.Crm.EntityEditorClient.prototype.getAllSecondaryEntityInfos=function(){return[].concat(this._primaryEntityBindingInfos.getItems(),this._secondaryEntityInfos.getItems())};BX.Crm.EntityEditorClient.prototype.getPrimaryEntityBindings=function(){return this._primaryEntityBindingInfos.getItems()};BX.Crm.EntityEditorClient.prototype.getPrimaryEntityBindingById=function(t){if(!this._primaryEntityBindingInfos){return null}return this._primaryEntityBindingInfos.search(function(e){return e.getId()===t})};BX.Crm.EntityEditorClient.prototype.addPrimaryEntityBinding=function(t){if(this._primaryEntityBindingInfos){this._primaryEntityBindingInfos.add(t);this.markAsChanged()}};BX.Crm.EntityEditorClient.prototype.removePrimaryEntityBinding=function(t){if(this._primaryEntityBindingInfos){this._primaryEntityBindingInfos.remove(t);this.markAsChanged()}};BX.Crm.EntityEditorClient.prototype.onPrimaryEntityBindingAdd=function(t,e){this.addPrimaryEntityBinding(e)};BX.Crm.EntityEditorClient.prototype.onPrimaryEntityBindingDelete=function(t,e){this.removePrimaryEntityBinding(e)};BX.Crm.EntityEditorClient.prototype.onPrimaryEntityBindingRelease=function(t,e){this._bindingTracker.unbind(e);this._secondaryEntityEditor.addItem(this._secondaryEntityEditor.createItem(e))};BX.Crm.EntityEditorClient.prototype.onPrimaryEntityDelete=function(t,e){var i=[].concat(this._primaryEntityBindingInfos.getItems(),this._secondaryEntityInfos.getItems());this._secondaryEntityInfos=BX.Collection.create();this._primaryEntityBindingInfos=BX.Collection.create();var n=null;if(i.length>0){n=i.shift()}this.setPrimaryEntity(n);this._primaryEntityEditor.setEntity(n);this._secondaryEntityEditor.setEntities(i);this._secondaryEntityEditor.setVisible(n!==null)};BX.Crm.EntityEditorClient.prototype.onPrimaryEntityChange=function(t,e){this.setPrimaryEntity(e);if(this._primaryEntityTypeName===BX.CrmEntityType.names.company){this._bindingTracker.reset();this._primaryEntityBindingInfos=BX.Collection.create();this._secondaryEntityInfos=BX.Collection.create();this._secondaryEntityEditor.clearItems();this._secondaryEntityEditor.reloadEntities()}this._secondaryEntityEditor.setVisible(true)};BX.Crm.EntityEditorClient.prototype.save=function(){var t,e,i;var n=this._schemeElement.getDataObjectParam("map",{});if(this._enablePrimaryEntity){this._model.setMappedField(n,"primaryEntityType",this._primaryEntityTypeName);var r=this._primaryEntityInfo?this._primaryEntityInfo.getId():0;this._model.setMappedField(n,"primaryEntityId",r);if(this._primaryEntityInfo){this._info["PRIMARY_ENTITY_DATA"]=this._primaryEntityInfo.getSettings()}else{delete this._info["PRIMARY_ENTITY_DATA"]}if(r>0){var o=this._bindingTracker.getUnboundEntities();var s=[];for(t=0,e=o.length;t<e;t++){s.push(o[t].getId())}if(s.length>0){for(t=0,e=s.length;t<e;t++){i=this.getSecondaryEntityById(s[t]);if(i){i.removeEntityBinding(this._primaryEntityTypeName,r)}}}this._model.setMappedField(n,"unboundSecondaryEntityIds",s.join(","));var a=this._bindingTracker.getBoundEntities();var l=[];for(t=0,e=a.length;t<e;t++){l.push(a[t].getId())}if(l.length>0){for(t=0,e=l.length;t<e;t++){i=this.getPrimaryEntityBindingById(l[t]);if(i){i.addEntityBinding(this._primaryEntityTypeName,r)}}}this._model.setMappedField(n,"boundSecondaryEntityIds",l.join(","));this._bindingTracker.reset()}}this._model.setMappedField(n,"secondaryEntityType",this._secondaryEntityTypeName);var d=this.getAllSecondaryEntityInfos();var h=[];var p=[];for(t=0,e=d.length;t<e;t++){i=d[t];h.push(i.getSettings());p.push(i.getId())}this._model.setMappedField(n,"secondaryEntityIds",p.join(","));this._info["SECONDARY_ENTITY_DATA"]=h};BX.Crm.EntityEditorClient.prototype.onBeforeSubmit=function(){if(!this._dataElements){return}for(var t in this._dataElements){if(!this._dataElements.hasOwnProperty(t)){continue}var e=BX.prop.getString(this._map,t,"");if(e!==""){this._dataElements[t].value=this._model.getField(e,"")}}};BX.Crm.EntityEditorClient.create=function(t,e){var i=new BX.Crm.EntityEditorClient;i.initialize(t,e);return i}}if(typeof BX.Crm.PrimaryClientEditor==="undefined"){BX.Crm.PrimaryClientEditor=function(){this._id="";this._settings={};this._editor=null;this._mode=BX.Crm.EntityEditorMode.intermediate;this._entityInfo=null;this._entityTypeName="";this._container=null;this._wrapper=null;this._bindingWrapper=null;this._externalEventHandler=null;this._externalContext=null;this._entityBindSelector=null;this._searchWrapper=null;this._searchInput=null;this._searchControl=null;this._item=null;this._itemBindings=null;this._skeleton=null;this._loaderConfig=null;this._hasLayout=false};BX.Crm.PrimaryClientEditor.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._editor=BX.prop.get(this._settings,"editor");this._mode=BX.prop.getInteger(this._settings,"mode",0);this._container=BX.prop.getElementNode(this._settings,"container",null);this._entityInfo=BX.prop.get(this._settings,"entityInfo",null);if(this._entityInfo){this.setEntity(this._entityInfo)}else{this._entityTypeName=BX.prop.getString(this._settings,"entityTypeName","")}this._loaderConfig=BX.prop.getObject(this._settings,"loaderConfig",{})},layout:function(){var t=this._mode===BX.Crm.EntityEditorMode.view;this._wrapper=BX.create("div",{props:{className:"crm-entity-widget-clients-container"}});this._bindingWrapper=null;if(!t){this._searchWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-search-box"}});this._wrapper.appendChild(this._searchWrapper);this.prepareSearchLayout();this.adjustSearchLayout()}this._wrapper.appendChild(BX.create("div",{style:{clear:"both"}}));if(this._item){this._item.setContainer(this._wrapper);this._item.layout();this._bindingWrapper=BX.create("div",{props:{className:"crm-entity-widget-client-block-children"}});this._wrapper.appendChild(this._bindingWrapper);var e=this._editor.getPrimaryEntityBindings();this._itemBindings=[];var i,n;for(i=0,n=e.length;i<n;i++){var r=e[i];var o=BX.Crm.ClientEditorEntityBindingPanel.create(this._id+"_"+r.getId().toString(),{entityInfo:r,editor:this._editor,mode:this._mode,container:this._bindingWrapper,onChange:BX.delegate(this.onItemBindingChange,this)});o.layout();this._itemBindings.push(o)}}var s=BX.prop.getElementNode(this._settings,"achor",null);if(s){this._container.insertBefore(this._wrapper,s)}else{this._container.appendChild(this._wrapper)}this._hasLayout=true},adjustLayout:function(){},clearLayout:function(){if(this._item){this._item.clearLayout()}if(this._itemBindings){for(var t=0,e=this._itemBindings.length;t<e;t++){this._itemBindings[t].clearLayout()}this._itemBindings=null}this._wrapper=BX.remove(this._wrapper);this._searchWrapper=null;this._bindingWrapper=null;this._entityCreateButton=null;this._hasLayout=false},prepareSearchLayout:function(){this._searchInput=BX.create("input",{props:{id:"dropdown-input",className:"crm-entity-widget-content-input crm-entity-widget-content-search-input"},attrs:{autocomplete:"nope"}});this._searchWrapper.appendChild(this._searchInput);this._searchControl=new BX.UI.Dropdown({searchAction:"crm.api.entity.search",searchOptions:{types:[BX.CrmEntityType.names.contact,BX.CrmEntityType.names.company]},searchResultRenderer:null,targetElement:this._searchInput,items:BX.prop.getArray(this._settings,"lastEntityInfos",[]),footerItems:[{caption:this.getMessage("create"),buttons:[{type:"create",caption:BX.CrmEntityType.getCaption(BX.CrmEntityType.enumeration.contact),events:{click:BX.delegate(function(){this.createEntity(BX.CrmEntityType.names.contact);this._searchControl.destroyPopupWindow()},this)}},{type:"create",caption:BX.CrmEntityType.getCaption(BX.CrmEntityType.enumeration.company),events:{click:BX.delegate(function(){this.createEntity(BX.CrmEntityType.names.company);this._searchControl.destroyPopupWindow()},this)}}]}],events:{onSelect:this.onEntitySelect.bind(this),onSearch:function(t){}}})},adjustSearchLayout:function(){if(this._searchWrapper){this._searchWrapper.style.display=this._item?"none":""}},getEntityTypeName:function(){return this._entityTypeName},setEntityTypeName:function(t){if(this._entityTypeName===t){return}this._entityTypeName=t},setEntity:function(t){if(this._item){if(this._hasLayout){this._item.clearLayout()}this._item=null}if(!(t instanceof BX.CrmEntityInfo)){this._entityInfo=null}else{this._entityInfo=t;this.setEntityTypeName(this._entityInfo.getTypeName());this._item=BX.Crm.ClientEditorEntityPanel.create(this._id+"_"+this._entityInfo.getId().toString(),{editor:this._editor,entityInfo:this._entityInfo,enableEntityTypeCaption:true,enableRequisite:true,requisiteBinding:BX.prop.getObject(this._settings,"requisiteBinding",{}),mode:this._mode,onDelete:BX.delegate(this.onItemDelete,this)});if(this._hasLayout){this._item.setContainer(this._wrapper);this._item.layout()}}if(this._itemBindings){for(var e=0,i=this._itemBindings.length;e<i;e++){this._itemBindings[e].clearLayout()}this._itemBindings=null}this.adjustSearchLayout()},setupEntity:function(t){if(this._entityInfo&&this._entityInfo.getId()===t){return}this.setEntity(null);var e=BX.prop.getFunction(this._settings,"onChange");if(e){e(this,this._entityInfo)}var i=BX.prop.getObject(this._loaderConfig,this._entityTypeName,null);if(i){this.showSkeleton();BX.CrmDataLoader.create(this._id,{serviceUrl:i["url"],action:i["action"],params:{ENTITY_TYPE_NAME:this._entityTypeName,ENTITY_ID:t}}).load(BX.delegate(this.onEntityInfoLoad,this))}},showSkeleton:function(){if(!this._skeleton){this._skeleton=BX.Crm.ClientEditorEntitySkeleton.create(this._id,{container:this._wrapper})}this._skeleton.layout()},hideSkeleton:function(){if(this._skeleton){this._skeleton.clearLayout()}},onEntityInfoLoad:function(t,e){var i=BX.prop.getObject(e,"DATA",null);if(i){var n=this._hasLayout;if(n){this.clearLayout()}this.hideSkeleton();var r=BX.CrmEntityInfo.create(i);this.setEntity(r);var o=BX.prop.getFunction(this._settings,"onChange");if(o){o(this,this._entityInfo)}if(n){this.layout()}}},getEntityCreateUrl:function(t){return this._editor.getEntityCreateUrl(t)},createEntity:function(t){var e=this.getEntityCreateUrl(t);if(e===""){return""}var i=this._editor.getContextId();e=BX.util.add_url_param(e,{external_context_id:i});if(!this._externalEventHandler){this._externalEventHandler=BX.delegate(this.onExternalEvent,this);BX.addCustomEvent(window,"onLocalStorageSet",this._externalEventHandler)}if(!this._externalContext){this._externalContext={}}this._externalContext[i]=e;BX.Crm.Page.open(e)},onEntitySelect:function(t,e){this._entityTypeName=BX.prop.getString(e,"type","");var i=BX.prop.getInteger(e,"id",0);if(i>0){this.setupEntity(i);this._searchControl.destroyPopupWindow()}},onExternalEvent:function(t){if(BX.prop.getString(t,"key","")!=="onCrmEntityCreate"){return}var e=BX.prop.getObject(t,"value",{});var i=BX.prop.getString(e,"context","");if(this._externalContext&&typeof this._externalContext[i]!=="undefined"){var n=BX.prop.getString(e,"entityTypeName","");var r=BX.prop.getInteger(e,"entityId",0);if(this._entityTypeName!==n){this._entityTypeName=n}this.setupEntity(r);BX.Crm.Page.close(this._externalContext[i]);delete this._externalContext[i]}},onItemBindingChange:function(t,e){if(e==="unbind"){var i=BX.prop.getFunction(this._settings,"onBindingRelease");if(i){i(this,t.getEntity())}this.removeBinding(t)}else if(e==="delete"){this.removeBinding(t)}},onItemDelete:function(t){var e=this._entityInfo;var i=this._hasLayout;if(i){this.clearLayout()}this.setEntity(null);if(i){this.layout()}var n=BX.prop.getFunction(this._settings,"onDelete");if(n){n(this,e)}},getBindings:function(){return this._itemBindings},createBinding:function(t){return BX.Crm.ClientEditorEntityBindingPanel.create(this._id+"_"+t.getId().toString(),{entityInfo:t,editor:this._editor,mode:this._mode,onChange:BX.delegate(this.onItemBindingChange,this)})},findBindingById:function(t){for(var e=0,i=this._itemBindings.length;e<i;e++){var n=this._itemBindings[e];if(n.getEntity().getId()===t){return n}}return null},getBindingIndex:function(t){for(var e=0,i=this._itemBindings.length;e<i;e++){if(this._itemBindings[e]===t){return e}}return-1},addBinding:function(t){this._itemBindings.push(t);if(this._hasLayout){t.setContainer(this._bindingWrapper);t.layout()}var e=BX.prop.getFunction(this._settings,"onBindingAdd");if(e){e(this,t.getEntity())}},removeBinding:function(t){var e=this.getBindingIndex(t);if(e<0){return}t.clearLayout();this._itemBindings.splice(e,1);var i=BX.prop.getFunction(this._settings,"onBindingDelete");if(i){i(this,t.getEntity())}},getBindingEntities:function(){var t=[];if(this._itemBindings){for(var e=0,i=this._itemBindings.length;e<i;e++){t.push(this._itemBindings[e].getEntity())}}return t}};BX.Crm.PrimaryClientEditor.prototype.getMessage=function(t){var e=BX.Crm.PrimaryClientEditor.messages;return e.hasOwnProperty(t)?e[t]:t};if(typeof BX.Crm.PrimaryClientEditor.messages==="undefined"){BX.Crm.PrimaryClientEditor.messages={}}BX.Crm.PrimaryClientEditor.create=function(t,e){var i=new BX.Crm.PrimaryClientEditor;i.initialize(t,e);return i}}if(typeof BX.Crm.SecondaryClientEditor==="undefined"){BX.Crm.SecondaryClientEditor=function(){this._id="";this._settings={};this._mode=BX.Crm.EntityEditorMode.intermediate;this._container=null;this._wrapper=null;this._entityTypeName="";this._entityInfos=null;this._items=null;this._externalEventHandler=null;this._externalContext=null;this._isMultiple=true;this._primaryLoaderConfig=null;this._secondaryLoaderConfig=null;this._editor=null;this._searchWrapper=null;this._searchInput=null;this._searchControl=null;this._addButton=null;this._addButtonHandler=BX.delegate(this.onAddButtonClick,this);this._bindButton=null;this._bindButtonClickHandler=BX.delegate(this.onBindButtonClick,this);this._bindingSelector=null;this._bindingSelectHandler=BX.delegate(this.onBindingSelect,this);this._isVisible=true;this._hasLayout=false};BX.Crm.SecondaryClientEditor.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._mode=BX.prop.getInteger(this._settings,"mode",0);this._editor=BX.prop.get(this._settings,"editor",null);this._container=BX.prop.getElementNode(this._settings,"container",null);this._entityTypeName=BX.prop.getString(this._settings,"entityTypeName","");this._entityInfos=BX.prop.getArray(this._settings,"entityInfos","");this._isMultiple=BX.prop.getBoolean(this._settings,"isMultiple",true);this._items=[];var i=this._entityInfos.length;if(!this._isMultiple&&i>1){i=1}for(var n=0;n<i;n++){var r=this.createItem(this._entityInfos[n]);this._items.push(r)}this._primaryLoaderConfig=BX.prop.getObject(this._settings,"primaryLoader",{});this._secondaryLoaderConfig=BX.prop.getObject(this._settings,"secondaryLoader",{})},getMessage:function(t){var e=BX.Crm.SecondaryClientEditor.messages;return e.hasOwnProperty(t)?e[t]:t},getEntityTypeName:function(){return this._entityTypeName},getEntities:function(){return this._entityInfos},setEntities:function(t){this._entityInfos=t;this.clearItems();var e=this._entityInfos.length;if(!this._isMultiple&&e>1){e=1}for(var i=0;i<e;i++){this.addItem(this.createItem(this._entityInfos[i]))}},findItemIndex:function(t){for(var e=0,i=this._items.length;e<i;e++){if(this._items[e]===t){return e}}return-1},getFirstItem:function(){return this._items.length>0?this._items[0]:null},getItemById:function(t){for(var e=0,i=this._items.length;e<i;e++){var n=this._items[e];if(n.getEntity().getId()===t){return n}}return null},getItems:function(){return this._items},getItemCount:function(){return this._items.length},createItem:function(t){return BX.Crm.ClientEditorEntityPanel.create(this._id+"_"+t.getId().toString(),{editor:this._editor,entityInfo:t,mode:this._mode,onDelete:BX.delegate(this.onItemDelete,this)})},clearItems:function(){for(var t=0,e=this._items.length;t<e;t++){var i=this._items[t];i.clearLayout();i.setContainer(null)}this._items=[]},addItemById:function(t){var e=BX.prop.getObject(this._primaryLoaderConfig,this._entityTypeName,null);if(!e){return}BX.CrmDataLoader.create(this._id,{serviceUrl:e["url"],action:e["action"],params:{ENTITY_TYPE_NAME:this._entityTypeName,ENTITY_ID:t}}).load(BX.delegate(this.onEntityInfoLoad,this))},addItem:function(t){var e=BX.prop.getFunction(this._settings,"onBeforeAdd");if(e){var i={cancel:false};e(this,t.getEntity(),i);if(i["cancel"]){return false}}if(!this._isMultiple){this.clearItems()}this._items.push(t);if(this._hasLayout){t.setContainer(this._itemsWrapper);t.layout()}var n=BX.prop.getFunction(this._settings,"onAdd");if(n){n(this,t.getEntity())}this.adjustLayout();return true},removeItem:function(t){var e=this.findItemIndex(t);if(e<0){return}this._items.splice(e,1);if(this._hasLayout){t.clearLayout();t.setContainer(null)}var i=BX.prop.getFunction(this._settings,"onDelete");if(i){i(this,t.getEntity())}this.adjustLayout()},reloadEntities:function(){if(!this._editor){return}var t=this._editor.getPrimaryEntity();if(!t){return}var e=BX.prop.getObject(this._secondaryLoaderConfig,t.getTypeName(),null);if(e){BX.CrmDataLoader.create(this._id,{serviceUrl:e["url"],action:e["action"],params:{PRIMARY_TYPE_NAME:t.getTypeName(),PRIMARY_ID:t.getId(),SECONDARY_TYPE_NAME:this._entityTypeName,OWNER_TYPE_NAME:this._editor.getOwnerTypeName()}}).load(BX.delegate(this.onEntityInfosReload,this))}},setVisible:function(t){t=!!t;if(this._isVisible===t){return}this._isVisible=t;if(this._wrapper){this._wrapper.style.display=t?"":"none"}},layout:function(){var t=this._mode===BX.Crm.EntityEditorMode.view;this._wrapper=BX.create("div",{});if(!this._isVisible){this._wrapper.style.display="none"}this._container.appendChild(this._wrapper);var e=BX.prop.getString(this._settings,"entityLegend","");this._addButton=null;this._bindButton=null;if(t){this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block-title"},children:[BX.create("span",{attrs:{className:"crm-entity-widget-content-block-title-text"},text:e})]}))}else{this._bindButton=BX.create("span",{props:{className:"crm-entity-widget-actions-btn-bind"},text:this.getMessage("bind"),events:{click:this._bindButtonClickHandler}});this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-participants-title"},children:[BX.create("div",{props:{className:"crm-entity-widget-clients-actions-block"},children:[BX.create("span",{props:{className:"crm-entity-widget-actions-btn-participants"},children:[BX.create("span",{props:{className:"crm-entity-widget-participants-title-text"},text:e})]}),this._bindButton]})]}))}this._searchWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-search-box"}});this._searchWrapper.style.display="none";this._itemsWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-item-container"}});this._wrapper.appendChild(this._searchWrapper);this._wrapper.appendChild(this._itemsWrapper);if(!t){this._addButton=BX.create("span",{props:{className:"crm-entity-widget-actions-btn-add"},text:this.getMessage("addParticipant"),events:{click:this._addButtonHandler}});this._wrapper.appendChild(this._addButton)}this.prepareSearchLayout();for(var i=0,n=this._items.length;i<n;i++){this._items[i].setContainer(this._itemsWrapper);this._items[i].layout()}this.adjustLayout();this._hasLayout=true},clearLayout:function(){for(var t=0,e=this._items.length;t<e;t++){this._items[t].clearLayout();this._items[t].setContainer(null)}this._addButton=null;this._bindButton=null;this._wrapper=BX.remove(this._wrapper);this._hasLayout=false},adjustLayout:function(){if(!this._bindButton){return}this._bindButton.style.display=this._editor.getPrimaryEntityTypeName()===BX.CrmEntityType.names.company&&BX.util.array_diff(this._editor.getSecondaryEntities(),this._editor.getPrimaryEntityBindings(),BX.CrmEntityInfo.getHashCode).length>0?"":"none"},prepareSearchLayout:function(){var t=BX.CrmEntityType.resolveId(this._entityTypeName);this._searchInput=BX.create("input",{props:{id:"dropdown-input",className:"crm-entity-widget-content-input crm-entity-widget-content-search-input"},attrs:{autocomplete:"nope"}});this._searchWrapper.appendChild(this._searchInput);this._searchControl=new BX.UI.Dropdown({searchAction:"crm.api.entity.search",searchOptions:{types:[this._entityTypeName]},searchResultRenderer:null,targetElement:this._searchInput,items:BX.prop.getArray(this._settings,"lastEntityInfos",[]),footerItems:[{caption:this.getMessage("create"),buttons:[{type:"create",caption:BX.CrmEntityType.getCaption(t),events:{click:BX.delegate(function(){this.createEntity();this._searchControl.destroyPopupWindow()},this)}}]}],events:{onSelect:this.onItemSelect.bind(this),onSearch:function(t){}}})},onAddButtonClick:function(t){this._searchWrapper.style.display=this._searchWrapper.style.display==="none"?"":"none"},onBindButtonClick:function(t){if(this._bindingSelector&&this._bindingSelector.isOpened()){this._bindingSelector.close();return}if(!this._bindingSelector){this._bindingSelector=BX.CmrSelectorMenu.create(this._id,{items:[]});this._bindingSelector.addOnSelectListener(this._bindingSelectHandler)}var e=this._editor.getPrimaryEntityBindings();var i=[];var n,r;for(n=0,r=e.length;n<r;n++){i.push(e[n])}var o=BX.util.array_diff(this._editor.getSecondaryEntities(),i,BX.CrmEntityInfo.getHashCode);var s=[];for(n=0,r=o.length;n<r;n++){var a=o[n];s.push({text:a.getTitle(),value:a.getId()})}this._bindingSelector.setupItems(s);this._bindingSelector.open(this._bindButton)},onBindingSelect:function(t,e){this._editor.onSecondaryEntityBind(this,this._editor.getSecondaryEntityById(e.getValue()))},onItemSelect:function(t,e){var i=BX.prop.getInteger(e,"id",0);if(i>0){this.addItemById(i);this._searchWrapper.style.display="none";this._searchControl.destroyPopupWindow()}},onItemDelete:function(t){this.removeItem(t)},onEntityInfoLoad:function(t,e){var i=BX.prop.getObject(e,"DATA",null);if(!i){return}var n=BX.CrmEntityInfo.create(i);if(this.getItemById(n.getId())!==null){return}this.addItem(this.createItem(n))},onEntityInfosReload:function(t,e){var i=BX.type.isArray(e["ENTITY_INFOS"])?e["ENTITY_INFOS"]:[];var n=[];for(var r=0;r<i.length;r++){n.push(BX.CrmEntityInfo.create(i[r]))}this.setEntities(n)},getEntityCreateUrl:function(t){return this._editor.getEntityCreateUrl(t)},createEntity:function(){var t=this.getEntityCreateUrl(this.getEntityTypeName());if(t===""){return}var e=this._editor.getContextId();t=BX.util.add_url_param(t,{external_context_id:e});var i=this._editor.getOwnerTypeName();var n=this._editor.getOwnerId();if(n>0&&i===BX.CrmEntityType.names.company){t=BX.util.add_url_param(t,{company_id:n})}if(!this._externalEventHandler){this._externalEventHandler=BX.delegate(this.onExternalEvent,this);BX.addCustomEvent(window,"onLocalStorageSet",this._externalEventHandler)}if(!this._externalContext){this._externalContext={}}this._externalContext[e]=t;BX.Crm.Page.open(t)},onExternalEvent:function(t){if(!this._externalContext){return}var e=BX.type.isNotEmptyString(t["key"])?t["key"]:"";if(e!=="onCrmEntityCreate"){return}var i=BX.prop.getObject(t,"value",{});if(BX.prop.getString(i,"entityTypeName","")!==this.getEntityTypeName()){return}var n=BX.prop.getInteger(i,"entityId",0);var r=BX.prop.getString(i,"context","");if(typeof this._externalContext[r]!=="undefined"){this.addItemById(n);BX.Crm.Page.close(this._externalContext[r]);delete this._externalContext[r]}}};if(typeof BX.Crm.SecondaryClientEditor.messages==="undefined"){BX.Crm.SecondaryClientEditor.messages={}}BX.Crm.SecondaryClientEditor.create=function(t,e){var i=new BX.Crm.SecondaryClientEditor;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorEntity==="undefined"){BX.Crm.EntityEditorEntity=function(){BX.Crm.EntityEditorEntity.superclass.constructor.apply(this);this._entityTypeName="";this._entityInfo=null;this._entitySelectClickHandler=BX.delegate(this.onEntitySelectClick,this);this._entitySelectButton=null;this._entitySelector=null;this._entityWrapper=null;this._dataInput=null;this._skeleton=null};BX.extend(BX.Crm.EntityEditorEntity,BX.Crm.EntityEditorField);BX.Crm.EntityEditorEntity.prototype.doInitialize=function(){BX.Crm.EntityEditorEntity.superclass.doInitialize.apply(this);this._loaderConfig=this._schemeElement.getDataObjectParam("loader",{});this.initializeFromModel()};BX.Crm.EntityEditorEntity.prototype.initializeFromModel=function(){var t=this._model.getSchemeField(this._schemeElement,"info",null);if(t){this.setEntity(BX.CrmEntityInfo.create(t))}else{this.setEntityTypeName(this._schemeElement.getDataStringParam("entityTypeName",""))}};BX.Crm.EntityEditorEntity.prototype.getOwnerTypeName=function(){return this._editor.getEntityTypeName()};BX.Crm.EntityEditorEntity.prototype.getOwnerTypeId=function(){return this._editor.getEntityTypeId()};BX.Crm.EntityEditorEntity.prototype.getOwnerId=function(){return this._editor.getEntityId()};BX.Crm.EntityEditorEntity.prototype.getEntityTypeName=function(){return this._entityTypeName};BX.Crm.EntityEditorEntity.prototype.setEntityTypeName=function(t){if(this._entityTypeName===t){return}this._entityTypeName=t;if(this._entitySelector){this._entitySelector=null}};BX.Crm.EntityEditorEntity.prototype.setEntity=function(t){if(this._item){if(this._hasLayout){this._item.clearLayout()}this._item=null}if(!(t instanceof BX.CrmEntityInfo)){this._entityInfo=null}else{this._entityInfo=t;this.setEntityTypeName(this._entityInfo.getTypeName());this._item=BX.Crm.ClientEditorEntityPanel.create(this._id+"_"+this._entityInfo.getId().toString(),{editor:this,entityInfo:this._entityInfo,enableEntityTypeCaption:false,enableRequisite:true,mode:this._mode,onDelete:BX.delegate(this.onItemDelete,this)});if(this._hasLayout){this._item.setContainer(this._entityWrapper);this._item.layout()}}};BX.Crm.EntityEditorEntity.prototype.setupEntity=function(t){if(this._entityInfo&&this._entityInfo.getId()===t){return}this.setEntity(null);var e=BX.prop.getObject(this._loaderConfig,this._entityTypeName,null);if(e){this.showSkeleton();BX.CrmDataLoader.create(this._id,{serviceUrl:e["url"],action:e["action"],params:{ENTITY_TYPE_NAME:this._entityTypeName,ENTITY_ID:t}}).load(BX.delegate(this.onEntityInfoLoad,this))}};BX.Crm.EntityEditorEntity.prototype.showSkeleton=function(){if(!this._skeleton){this._skeleton=BX.Crm.ClientEditorEntitySkeleton.create(this._id,{container:this._entityWrapper})}this._skeleton.layout()};BX.Crm.EntityEditorEntity.prototype.hideSkeleton=function(){if(this._skeleton){this._skeleton.clearLayout()}};BX.Crm.EntityEditorEntity.prototype.onEntityInfoLoad=function(t,e){var i=BX.prop.getObject(e,"DATA",null);if(i){this.hideSkeleton();var n=BX.CrmEntityInfo.create(i);this.setEntity(n)}};BX.Crm.EntityEditorEntity.prototype.onItemDelete=function(t){this.setEntity(null)};BX.Crm.EntityEditorEntity.prototype.reset=function(){this.initializeFromModel()};BX.Crm.EntityEditorEntity.prototype.rollback=function(){if(this.isChanged()){this.initializeFromModel()}};BX.Crm.EntityEditorEntity.prototype.doSetMode=function(t){this.rollback();if(this._item){this._item.setMode(t)}};BX.Crm.EntityEditorEntity.prototype.layout=function(t){if(this._hasLayout){return}var e=this.getName();var i=this._schemeElement.getTitle();var n=this.getValue();var r=this._mode===BX.Crm.EntityEditorMode.view;this._wrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block"}});if(r&&!this._item){this.registerLayout(t);this._hasLayout=true;return}var o=BX.create("div",{props:{className:"crm-entity-widget-clients-block"}});this._wrapper.appendChild(o);o.appendChild(this.createTitleNode(i));var s=BX.create("div",{props:{className:!r?"crm-entity-widget-content-block-clients":""}});o.appendChild(s);this._entityWrapper=BX.create("div",{props:{className:"crm-entity-widget-clients-container"}});s.appendChild(this._entityWrapper);if(!r){this._entitySelectButton=BX.create("span",{props:{className:"crm-entity-widget-actions-btn-select"},text:this.getMessage("select"),events:{click:this._entitySelectClickHandler}});var a=BX.create("div",{props:{className:"crm-entity-widget-clients-actions-block"},children:[this._entitySelectButton]});this._entityWrapper.appendChild(a);this._dataInput=BX.create("input",{attrs:{name:e,type:"hidden",value:n}});this._entityWrapper.appendChild(this._dataInput)}if(this._item){this._item.setContainer(this._entityWrapper);this._item.layout()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorEntity.prototype.clearLayout=function(){if(this._item){this._item.clearLayout()}this._wrapper=BX.remove(this._wrapper);this._entityWrapper=null;this._dataInput=null;if(this._entitySelector){if(this._entitySelector.isOpened()){this._entitySelector.close()}this._entitySelector=null}this._hasLayout=false};BX.Crm.EntityEditorEntity.prototype.onEntitySelectClick=function(t){if(this._entitySelector&&this._entitySelector.isOpened()){this._entitySelector.close();return}if(!this._entitySelector){this._entitySelector=BX.Crm.EntityEditorCrmSelector.create(this._id,{entityTypeIds:[BX.CrmEntityType.resolveId(this._entityTypeName)],enableMyCompanyOnly:this._schemeElement.getDataBooleanParam("enableMyCompanyOnly",false),callback:BX.delegate(this.onEntitySelect,this)})}this._entitySelector.open(this._entitySelectButton)};BX.Crm.EntityEditorEntity.prototype.onEntitySelect=function(t,e){var i=BX.prop.getInteger(e,"entityId",0);if(this._entityInfo&&this._entityInfo.getId()===i){return}this._entitySelector.close();this.setupEntity(i)};BX.Crm.EntityEditorEntity.prototype.save=function(){this._model.setField(this.getName(),this._entityInfo?this._entityInfo.getId():0)};BX.Crm.EntityEditorEntity.prototype.onBeforeSubmit=function(){if(this._dataInput){this._dataInput.value=this._model.getField(this.getName(),"")}};BX.Crm.EntityEditorEntity.prototype.getMessage=function(t){return BX.prop.getString(BX.Crm.EntityEditorEntity.messages,t,t)};if(typeof BX.Crm.EntityEditorEntity.messages==="undefined"){BX.Crm.EntityEditorEntity.messages={}}BX.Crm.EntityEditorEntity.create=function(t,e){var i=new BX.Crm.EntityEditorEntity;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorFieldConfigurator==="undefined"){BX.Crm.EntityEditorFieldConfigurator=function(){BX.Crm.EntityEditorFieldConfigurator.superclass.constructor.apply(this);this._field=null;this._name=null;this._isLocked=false;this._labelInput=null;this._isRequiredCheckBox=null;this._showAlwaysCheckBox=null;this._saveButton=null;this._cancelButton=null;this._optionWrapper=null;this._mandatoryConfigurator=null};BX.extend(BX.Crm.EntityEditorFieldConfigurator,BX.Crm.EntityEditorControl);BX.Crm.EntityEditorFieldConfigurator.prototype.doInitialize=function(){BX.Crm.EntityEditorFieldConfigurator.superclass.doInitialize.apply(this);this._field=BX.prop.get(this._settings,"field",null);this._name=BX.prop.getString(this._fieldData,"name","");this._mandatoryConfigurator=BX.prop.get(this._settings,"mandatoryConfigurator",null)};BX.Crm.EntityEditorFieldConfigurator.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorFieldConfigurator.messages;return e.hasOwnProperty(t)?e[t]:t};BX.Crm.EntityEditorFieldConfigurator.prototype.layout=function(t){if(this._hasLayout){return}if(this._mode===BX.Crm.EntityEditorMode.view){throw"EntityEditorFieldConfigurator. View mode is not supported by this control type."}this._wrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-new-fields"}});this._labelInput=BX.create("input",{attrs:{className:"crm-entity-widget-content-input",type:"text",value:this._field.getTitle()}});this._saveButton=BX.create("span",{props:{className:"ui-btn ui-btn-primary"},text:BX.message("CRM_EDITOR_SAVE"),events:{click:BX.delegate(this.onSaveButtonClick,this)}});this._cancelButton=BX.create("span",{props:{className:"ui-btn ui-btn-light-border"},text:BX.message("CRM_EDITOR_CANCEL"),events:{click:BX.delegate(this.onCancelButtonClick,this)}});this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-title"},children:[BX.create("span",{attrs:{className:"crm-entity-widget-content-block-title-text"},text:this.getMessage("labelField")})]}),BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-field-container"},children:[this._labelInput]})]})]}));this._optionWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"}});this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block crm-entity-widget-content-block-checkbox"},children:[this._optionWrapper]}));if(this._field.areAttributesEnabled()&&!this._field.isRequired()&&this._mandatoryConfigurator){this._isRequiredCheckBox=this.createOption({caption:this._mandatoryConfigurator.getTitle()+":",labelSettings:{props:{className:"crm-entity-new-field-addiction-label"}},containerSettings:{style:{alignItems:"center"}},elements:this._mandatoryConfigurator.getButton().prepareLayout()});this._isRequiredCheckBox.checked=!this._mandatoryConfigurator.isEmpty();this._mandatoryConfigurator.setSwitchCheckBox(this._isRequiredCheckBox);this._mandatoryConfigurator.setLabel(this._isRequiredCheckBox.nextSibling);this._mandatoryConfigurator.setEnabled(this._isRequiredCheckBox.checked);this._mandatoryConfigurator.adjust()}this._showAlwaysCheckBox=this.createOption({caption:this.getMessage("showAlways"),help:{code:"7046149"}});this._showAlwaysCheckBox.checked=this._field.checkOptionFlag(BX.Crm.EntityEditorControlOptions.showAlways);this._wrapper.appendChild(BX.create("hr",{props:{className:"crm-entity-widget-hr"}}));this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block-new-fields-btn-container"},children:[this._saveButton,this._cancelButton]}));this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorFieldConfigurator.prototype.clearLayout=function(){if(!this._hasLayout){return}this._wrapper=BX.remove(this._wrapper);this._labelInput=null;this._isRequiredCheckBox=null;this._showAlwaysCheckBox=null;this._saveButton=null;this._cancelButton=null;this._optionWrapper=null;this._hasLayout=false};BX.Crm.EntityEditorFieldConfigurator.prototype.onSaveButtonClick=function(t){if(this._isLocked){return}if(this._mandatoryConfigurator){if(this._mandatoryConfigurator.isChanged()){this._mandatoryConfigurator.acceptChanges()}this._mandatoryConfigurator.close()}var e={field:this._field,label:this._labelInput.value,showAlways:this._showAlwaysCheckBox.checked};BX.onCustomEvent(this,"onSave",[this,e])};BX.Crm.EntityEditorFieldConfigurator.prototype.onCancelButtonClick=function(t){if(this._isLocked){return}var e={field:this._field};BX.onCustomEvent(this,"onCancel",[this,e])};BX.Crm.EntityEditorFieldConfigurator.prototype.setLocked=function(t){t=!!t;if(this._isLocked===t){return}this._isLocked=t;if(this._isLocked){BX.addClass(this._saveButton,"ui-btn-clock")}else{BX.removeClass(this._saveButton,"ui-btn-clock")}};BX.Crm.EntityEditorFieldConfigurator.prototype.getField=function(){return this._field};BX.Crm.EntityEditorFieldConfigurator.prototype.createOption=function(t){var e=BX.create("input",{props:{type:"checkbox"}});var i=BX.create("label",{children:[e,BX.create("span",{text:BX.prop.getString(t,"caption","")})]});var n=BX.prop.getObject(t,"labelSettings",null);if(n){BX.adjust(i,n)}var r=BX.prop.getObject(t,"help",null);if(r){var o=BX.create("a",{props:{className:"crm-entity-new-field-helper-icon"}});var s=BX.prop.getString(r,"url","");if(s!==""){o.href=s;o.target="_blank"}else{o.href="#";BX.bind(o,"click",function(t){window.top.BX.Helper.show("redirect=detail&code="+BX.prop.getString(r,"code",""));t.preventDefault()})}i.appendChild(o)}var a=[i];var l=BX.prop.getArray(t,"elements",[]);for(var d=0,h=l.length;d<h;d++){a.push(l[d])}var p=BX.create("div",{props:{className:"crm-entity-widget-content-block-field-container"},children:a});var u=BX.prop.getObject(t,"containerSettings",null);if(u){BX.adjust(p,u)}this._optionWrapper.appendChild(p);return e};if(typeof BX.Crm.EntityEditorFieldConfigurator.messages==="undefined"){BX.Crm.EntityEditorFieldConfigurator.messages={}}BX.Crm.EntityEditorFieldConfigurator.create=function(t,e){var i=new BX.Crm.EntityEditorFieldConfigurator;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorUserFieldConfigurator==="undefined"){BX.Crm.EntityEditorUserFieldConfigurator=function(){BX.Crm.EntityEditorUserFieldConfigurator.superclass.constructor.apply(this);this._field=null;this._typeId="";this._isLocked=false;this._labelInput=null;this._saveButton=null;this._cancelButton=null;this._isTimeEnabledCheckBox=null;this._isRequiredCheckBox=null;this._isMultipleCheckBox=null;this._showAlwaysCheckBox=null;this._enumItemWrapper=null;this._enumItemContainer=null;this._enumButtonWrapper=null;this._optionWrapper=null;this._enumItems=null;this._mandatoryConfigurator=null};BX.extend(BX.Crm.EntityEditorUserFieldConfigurator,BX.Crm.EntityEditorControl);BX.Crm.EntityEditorUserFieldConfigurator.prototype.doInitialize=function(){BX.Crm.EntityEditorUserFieldConfigurator.superclass.doInitialize.apply(this);this._field=BX.prop.get(this._settings,"field",null);if(this._field&&!(this._field instanceof BX.Crm.EntityEditorUserField)){throw"EntityEditorUserFieldConfigurator. The 'field' param must be EntityEditorUserField."}this._mandatoryConfigurator=BX.prop.get(this._settings,"mandatoryConfigurator",null);this._typeId=BX.prop.getString(this._settings,"typeId","");this._enumItems=[]};BX.Crm.EntityEditorUserFieldConfigurator.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorUserFieldConfigurator.messages;return e.hasOwnProperty(t)?e[t]:t};BX.Crm.EntityEditorUserFieldConfigurator.prototype.layout=function(t){if(this._hasLayout){return}if(this._mode===BX.Crm.EntityEditorMode.view){throw"EntityEditorUserFieldConfigurator. View mode is not supported by this control type."}var e=this._field===null;var i=this.getMessage("labelField");var n=this._editor.getUserFieldManager();var r=this._field?this._field.getTitle():n.getDefaultFieldLabel(this._typeId);this._wrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-new-fields"}});this._labelInput=BX.create("input",{attrs:{className:"crm-entity-widget-content-input",type:"text",value:r}});this._saveButton=BX.create("span",{props:{className:"ui-btn ui-btn-primary"},text:BX.message("CRM_EDITOR_SAVE"),events:{click:BX.delegate(this.onSaveButtonClick,this)}});this._cancelButton=BX.create("span",{props:{className:"ui-btn ui-btn-light-border"},text:BX.message("CRM_EDITOR_CANCEL"),events:{click:BX.delegate(this.onCancelButtonClick,this)}});this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-title"},children:[BX.create("span",{attrs:{className:"crm-entity-widget-content-block-title-text"},text:i})]}),BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-field-container"},children:[this._labelInput]})]})]}));if(this._typeId==="enumeration"){this._wrapper.appendChild(BX.create("hr",{props:{className:"crm-entity-widget-hr"}}));this._enumItemWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block"}});this._wrapper.appendChild(this._enumItemWrapper);this._enumItemWrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block-title"},children:[BX.create("span",{attrs:{className:"crm-entity-widget-content-block-title-text"},text:this.getMessage("enumItems")})]}));this._enumItemContainer=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"}});this._enumItemWrapper.appendChild(this._enumItemContainer);this._enumButtonWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-add-field"}});this._enumItemWrapper.appendChild(this._enumButtonWrapper);this._enumButtonWrapper.appendChild(BX.create("span",{props:{className:"crm-entity-widget-content-add-field"},events:{click:BX.delegate(this.onEnumerationItemAddButtonClick,this)},text:this.getMessage("add")}));if(this._field){var o=this._field.getFieldInfo();var s=BX.prop.getArray(o,"ENUM",[]);for(var a=0,l=s.length;a<l;a++){this.createEnumerationItem(s[a])}}this.createEnumerationItem()}this._optionWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"}});this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block crm-entity-widget-content-block-checkbox"},children:[this._optionWrapper]}));var d=0;if(e&&(this._typeId==="datetime"||this._typeId==="date")){this._isTimeEnabledCheckBox=this.createOption({caption:this.getMessage("enableTime")});d++}if(this._typeId!=="boolean"){if(this._mandatoryConfigurator){this._isRequiredCheckBox=this.createOption({caption:this._mandatoryConfigurator.getTitle()+":",labelSettings:{props:{className:"crm-entity-new-field-addiction-label"}},containerSettings:{style:{alignItems:"center"}},elements:this._mandatoryConfigurator.getButton().prepareLayout()});this._isRequiredCheckBox.checked=this._field&&this._field.isRequired()||this._mandatoryConfigurator.isCustomized();this._mandatoryConfigurator.setSwitchCheckBox(this._isRequiredCheckBox);this._mandatoryConfigurator.setLabel(this._isRequiredCheckBox.nextSibling);this._mandatoryConfigurator.setEnabled(this._isRequiredCheckBox.checked);this._mandatoryConfigurator.adjust()}else{this._isRequiredCheckBox=this.createOption({caption:this.getMessage("isRequiredField")});this._isRequiredCheckBox.checked=this._field&&this._field.isRequired()}d++;if(e){this._isMultipleCheckBox=this.createOption({caption:this.getMessage("isMultipleField")});d++}}this._showAlwaysCheckBox=this.createOption({caption:this.getMessage("showAlways"),help:{code:"7046149"}});this._showAlwaysCheckBox.checked=e?BX.prop.getBoolean(this._settings,"showAlways",true):this._field.checkOptionFlag(BX.Crm.EntityEditorControlOptions.showAlways);d++;if(d>0){this._wrapper.appendChild(BX.create("hr",{props:{className:"crm-entity-widget-hr"}}))}this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block-new-fields-btn-container"},children:[this._saveButton,this._cancelButton]}));this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorUserFieldConfigurator.prototype.clearLayout=function(){if(!this._hasLayout){return}this._wrapper=BX.remove(this._wrapper);this._labelInput=null;this._saveButton=null;this._cancelButton=null;this._isTimeEnabledCheckBox=null;this._isRequiredCheckBox=null;this._isMultipleCheckBox=null;this._showAlwaysCheckBox=null;this._enumItemWrapper=null;this._enumButtonWrapper=null;this._enumItemContainer=null;this._optionWrapper=null;this._enumItems=[];this._hasLayout=false};BX.Crm.EntityEditorUserFieldConfigurator.prototype.onEnumerationItemAddButtonClick=function(t){this.createEnumerationItem().focus()};BX.Crm.EntityEditorUserFieldConfigurator.prototype.createEnumerationItem=function(t){var e=BX.Crm.EntityEditorUserFieldListItem.create("",{configurator:this,container:this._enumItemContainer,data:t});this._enumItems.push(e);e.layout();return e};BX.Crm.EntityEditorUserFieldConfigurator.prototype.removeEnumerationItem=function(t){for(var e=0,i=this._enumItems.length;e<i;e++){if(this._enumItems[e]===t){this._enumItems[e].clearLayout();this._enumItems.splice(e,1);break}}};BX.Crm.EntityEditorUserFieldConfigurator.prototype.createOption=function(t){var e=BX.create("input",{props:{type:"checkbox"}});var i=BX.create("label",{children:[e,BX.create("span",{text:BX.prop.getString(t,"caption","")})]});var n=BX.prop.getObject(t,"labelSettings",null);if(n){BX.adjust(i,n)}var r=BX.prop.getObject(t,"help",null);if(r){var o=BX.create("a",{props:{className:"crm-entity-new-field-helper-icon"}});var s=BX.prop.getString(r,"url","");if(s!==""){o.href=s;o.target="_blank"}else{o.href="#";BX.bind(o,"click",function(t){window.top.BX.Helper.show("redirect=detail&code="+BX.prop.getString(r,"code",""));t.preventDefault()})}i.appendChild(o)}var a=[i];var l=BX.prop.getArray(t,"elements",[]);for(var d=0,h=l.length;d<h;d++){a.push(l[d])}var p=BX.create("div",{props:{className:"crm-entity-widget-content-block-field-container"},children:a});var u=BX.prop.getObject(t,"containerSettings",null);if(u){BX.adjust(p,u)}this._optionWrapper.appendChild(p);return e};BX.Crm.EntityEditorUserFieldConfigurator.prototype.onSaveButtonClick=function(t){if(this._isLocked){return}if(this._mandatoryConfigurator){if(this._mandatoryConfigurator.isChanged()){this._mandatoryConfigurator.acceptChanges()}this._mandatoryConfigurator.close()}var e={typeId:this._typeId,label:this._labelInput.value};if(this._field){e["field"]=this._field;if(this._isRequiredCheckBox){e["mandatory"]=this._isRequiredCheckBox.checked}}else{if(this._typeId==="boolean"){e["multiple"]=false}else{if(this._isMultipleCheckBox){e["multiple"]=this._isMultipleCheckBox.checked}e["mandatory"]=this._isRequiredCheckBox.checked}if(this._typeId==="datetime"){e["enableTime"]=this._isTimeEnabledCheckBox.checked}}if(this._typeId==="enumeration"){e["enumeration"]=[];var i=[];for(var n=0,r=this._enumItems.length;n<r;n++){var o=this._enumItems[n].prepareData();if(!o){continue}var s=BX.util.hashCode(o["VALUE"]);if(BX.util.in_array(s,i)){continue}i.push(s);o["SORT"]=(e["enumeration"].length+1)*100;e["enumeration"].push(o)}}e["showAlways"]=this._showAlwaysCheckBox.checked;BX.onCustomEvent(this,"onSave",[this,e])};BX.Crm.EntityEditorUserFieldConfigurator.prototype.onCancelButtonClick=function(t){if(this._isLocked){return}var e={typeId:this._typeId};if(this._field){e["field"]=this._field}BX.onCustomEvent(this,"onCancel",[this,e])};BX.Crm.EntityEditorUserFieldConfigurator.prototype.setLocked=function(t){t=!!t;if(this._isLocked===t){return}this._isLocked=t;if(this._isLocked){BX.addClass(this._saveButton,"ui-btn-clock")}else{BX.removeClass(this._saveButton,"ui-btn-clock")}};BX.Crm.EntityEditorUserFieldConfigurator.prototype.getField=function(){return this._field};if(typeof BX.Crm.EntityEditorUserFieldConfigurator.messages==="undefined"){BX.Crm.EntityEditorUserFieldConfigurator.messages={}}BX.Crm.EntityEditorUserFieldConfigurator.create=function(t,e){var i=new BX.Crm.EntityEditorUserFieldConfigurator;i.initialize(t,e);return i};BX.onCustomEvent(window,"BX.Crm.EntityEditorUserFieldConfigurator:onDefine")}if(typeof BX.Crm.EntityEditorUserFieldListItem==="undefined"){BX.Crm.EntityEditorUserFieldListItem=function(){this._id="";this._settings=null;this._data=null;this._configurator=null;this._container=null;this._labelInput=null;this._hasLayout=false};BX.Crm.EntityEditorUserFieldListItem.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=BX.type.isPlainObject(e)?e:{};this._data=BX.prop.getObject(this._settings,"data",{});this._configurator=BX.prop.get(this._settings,"configurator");this._container=BX.prop.getElementNode(this._settings,"container")},layout:function(){if(this._hasLayout){return}this._wrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-field-container"}});this._labelInput=BX.create("input",{props:{className:"crm-entity-widget-content-input",type:"input",value:BX.prop.getString(this._data,"VALUE","")}});this._wrapper.appendChild(this._labelInput);this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-remove-block"},events:{click:BX.delegate(this.onDeleteButtonClick,this)}}));var t=BX.prop.getElementNode(this._settings,"anchor");if(t){this._container.insertBefore(this._wrapper,t)}else{this._container.appendChild(this._wrapper)}this._hasLayout=true},clearLayout:function(){if(!this._hasLayout){return}this._wrapper=BX.remove(this._wrapper);this._hasLayout=false},focus:function(){if(this._labelInput){this._labelInput.focus()}},prepareData:function(){var t=this._labelInput?BX.util.trim(this._labelInput.value):"";if(t===""){return null}var e={VALUE:t};var i=BX.prop.getInteger(this._data,"ID",0);if(i>0){e["ID"]=i}var n=BX.prop.getString(this._data,"XML_ID","");if(i>0){e["XML_ID"]=n}return e},onDeleteButtonClick:function(t){this._configurator.removeEnumerationItem(this)}};BX.Crm.EntityEditorUserFieldListItem.create=function(t,e){var i=new BX.Crm.EntityEditorUserFieldListItem;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorUserField==="undefined"){BX.Crm.EntityEditorUserField=function(){BX.Crm.EntityEditorUserField.superclass.constructor.apply(this);this._innerWrapper=null;this._isLoaded=false;this._focusOnLoad=false};BX.extend(BX.Crm.EntityEditorUserField,BX.Crm.EntityEditorField);BX.Crm.EntityEditorUserField.prototype.doInitialize=function(){BX.Crm.EntityEditorUserField.superclass.doInitialize.apply(this);this._manager=this._editor.getUserFieldManager()};BX.Crm.EntityEditorUserField.prototype.getModeSwitchType=function(t){var e=BX.Crm.EntityEditorModeSwitchType.common;if(t===BX.Crm.EntityEditorMode.edit){e|=BX.Crm.EntityEditorModeSwitchType.button|BX.Crm.EntityEditorModeSwitchType.content}return e};BX.Crm.EntityEditorUserField.prototype.getContentWrapper=function(){return this._innerWrapper};BX.Crm.EntityEditorUserField.prototype.getFieldInfo=function(){return this._schemeElement.getDataParam("fieldInfo",{})};BX.Crm.EntityEditorUserField.prototype.getFieldType=function(){return BX.prop.getString(this.getFieldInfo(),"USER_TYPE_ID","")};BX.Crm.EntityEditorUserField.prototype.getFieldSettings=function(){return BX.prop.getObject(this.getFieldInfo(),"SETTINGS",{})};BX.Crm.EntityEditorUserField.prototype.isMultiple=function(){return BX.prop.getString(this.getFieldInfo(),"MULTIPLE","N")==="Y"};BX.Crm.EntityEditorUserField.prototype.getEntityValueId=function(){return BX.prop.getString(this.getFieldInfo(),"ENTITY_VALUE_ID","")};BX.Crm.EntityEditorUserField.prototype.getFieldValue=function(){var t=this.getValue();var e=BX.prop.getArray(t,"VALUE",null);if(e===null){e=BX.prop.getString(t,"VALUE","")}return e};BX.Crm.EntityEditorUserField.prototype.getFieldSignature=function(){return BX.prop.getString(this.getValue(),"SIGNATURE","")};BX.Crm.EntityEditorUserField.prototype.isTitleEnabled=function(){var t=this.getFieldInfo();var e=BX.prop.getString(t,"USER_TYPE_ID","");if(e!=="boolean"){return true}return BX.prop.getString(BX.prop.getObject(t,"SETTINGS",{}),"DISPLAY","")!=="CHECKBOX"};BX.Crm.EntityEditorUserField.prototype.getFieldNode=function(){return this._innerWrapper};BX.Crm.EntityEditorUserField.prototype.doGetEditPriority=function(){return BX.prop.get(BX.prop.getObject(this.getFieldInfo(),"SETTINGS"),"DEFAULT_VALUE")?BX.Crm.EntityEditorPriority.high:BX.Crm.EntityEditorPriority.normal};BX.Crm.EntityEditorUserField.prototype.checkIfNotEmpty=function(t){if(BX.prop.getBoolean(t,"IS_EMPTY",false)){return false}var e;if(this.getFieldType()===BX.Crm.EntityUserFieldType.boolean){e=BX.prop.getString(t,"VALUE","");return e!==""}e=BX.prop.getArray(t,"VALUE",null);if(e===null){e=BX.prop.getString(t,"VALUE","")}return BX.type.isArray(e)?e.length>0:e!==""};BX.Crm.EntityEditorUserField.prototype.getValue=function(t){if(t===undefined){t=null}if(!this._model){return t}return this._model.getField(this.getName(),t)};BX.Crm.EntityEditorUserField.prototype.hasContentToDisplay=function(){if(this._mode===BX.Crm.EntityEditorMode.edit){return true}return this.checkIfNotEmpty(this.getValue())};BX.Crm.EntityEditorUserField.prototype.layout=function(t){if(this._hasLayout){return}var e=this.getName();var i=this.getTitle();var n=this.getFieldInfo();var r=this.getValue();var o=BX.prop.getString(r,"SIGNATURE","");this.ensureWrapperCreated();this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}var s=this.getFieldType();if(s===BX.Crm.EntityUserFieldType.string){BX.addClass(this._wrapper,"crm-entity-widget-content-block-field-custom-text")}else if(s===BX.Crm.EntityUserFieldType.integer||s===BX.Crm.EntityUserFieldType.double){BX.addClass(this._wrapper,"crm-entity-widget-content-block-field-custom-number")}else if(s===BX.Crm.EntityUserFieldType.money){BX.addClass(this._wrapper,"crm-entity-widget-content-block-field-custom-money")}else if(s===BX.Crm.EntityUserFieldType.date||s===BX.Crm.EntityUserFieldType.datetime){BX.addClass(this._wrapper,"crm-entity-widget-content-block-field-custom-date")}else if(s===BX.Crm.EntityUserFieldType.boolean){BX.addClass(this._wrapper,"crm-entity-widget-content-block-field-custom-checkbox")}else if(s===BX.Crm.EntityUserFieldType.enumeration){BX.addClass(this._wrapper,this.isMultiple()?"crm-entity-widget-content-block-field-custom-multiselect":"crm-entity-widget-content-block-field-custom-select")}else if(s===BX.Crm.EntityUserFieldType.file){BX.addClass(this._wrapper,"crm-entity-widget-content-block-field-custom-file")}else if(s===BX.Crm.EntityUserFieldType.url){BX.addClass(this._wrapper,"crm-entity-widget-content-block-field-custom-link")}this._innerWrapper=null;if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}if(this._mode===BX.Crm.EntityEditorMode.edit){if(this.isTitleEnabled()){this._wrapper.appendChild(this.createTitleNode(i))}this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"}})}else{this._wrapper.appendChild(this.createTitleNode(i));this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"}})}this._wrapper.appendChild(this._innerWrapper);if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);if(this.hasContentToDisplay()){var a=BX.prop.getString(t,"html","");if(a===""){a=BX.prop.getString(BX.prop.getObject(r,"HTML",{}),BX.Crm.EntityEditorMode.getName(this._mode).toUpperCase(),"")}if(a!==""){this.setupContentHtml(a);this._hasLayout=true}else{this._isLoaded=false;var l=null;if(!this.isInSingleEditMode()){l=BX.prop.get(t,"userFieldLoader",null)}if(!l){l=BX.Crm.EntityUserFieldLayoutLoader.create(this._id,{mode:this._mode,enableBatchMode:false})}var d=BX.clone(n);d["SIGNATURE"]=o;if(s===BX.Crm.EntityUserFieldType.file&&BX.type.isObject(d["ADDITIONAL"])){var h=BX.prop.getString(this._schemeElement.getDataParam("extras",{}),"OWNER_TOKEN","");if(h!==""){d["ADDITIONAL"]["URL_TEMPLATE"]+="&owner_token="+encodeURIComponent(h)}}if(this.checkIfNotEmpty(r)){var p=BX.prop.getArray(r,"VALUE",null);if(p===null){p=BX.prop.getString(r,"VALUE","")}d["VALUE"]=p}this.adjustFieldParams(d,true);l.addItem({name:e,field:d,callback:BX.delegate(this.onLayoutLoaded,this)});l.run()}}else{this._innerWrapper.appendChild(document.createTextNode(this.getMessage("isEmpty")));this._hasLayout=true}};BX.Crm.EntityEditorUserField.prototype.doRegisterLayout=function(){};BX.Crm.EntityEditorUserField.prototype.adjustFieldParams=function(t,e){var i=this.getFieldType();if(i===BX.Crm.EntityUserFieldType.boolean){if(!BX.type.isPlainObject(t["SETTINGS"])){t["SETTINGS"]={}}t["SETTINGS"]["LABEL_CHECKBOX"]=this.getTitle()}if(e&&typeof t["VALUE"]!=="undefined"&&this._mode===BX.Crm.EntityEditorMode.edit&&BX.prop.getInteger(t,"ENTITY_VALUE_ID")<=0){t["ENTITY_VALUE_ID"]=1}};BX.Crm.EntityEditorUserField.prototype.doClearLayout=function(t){this._innerWrapper=null};BX.Crm.EntityEditorUserField.prototype.validate=function(){return true};BX.Crm.EntityEditorUserField.prototype.save=function(){};BX.Crm.EntityEditorUserField.prototype.focus=function(){if(this._mode!==BX.Crm.EntityEditorMode.edit){return}if(this._isLoaded){this.doFocus()}else{this._focusOnLoad=true}};BX.Crm.EntityEditorUserField.prototype.doFocus=function(){BX.Main.UF.Factory.focus(this.getName())};BX.Crm.EntityEditorUserField.prototype.setupContentHtml=function(t){if(this._innerWrapper){BX.html(this._innerWrapper,t).then(function(){this.onLayoutSuccess();this._isLoaded=true;if(this._focusOnLoad===true){this.doFocus();this._focusOnLoad=false}}.bind(this))}};BX.Crm.EntityEditorUserField.prototype.doSetActive=function(){if(!this._isActive){this._manager.unregisterActiveField(this)}};BX.Crm.EntityEditorUserField.prototype.rollback=function(){this._manager.unregisterActiveField(this)};BX.Crm.EntityEditorUserField.prototype.onLayoutSuccess=function(){if(this._isActive){this._manager.registerActiveField(this)}window.setTimeout(function(){BX.bindDelegate(this._innerWrapper,"bxchange",{tag:["input","select","textarea"]},this._changeHandler)}.bind(this),200);var t=this.getFieldType();if(t===BX.Crm.EntityUserFieldType.employee){var e=this._innerWrapper.querySelector(".feed-add-destination-link");if(e){BX.bind(e,"click",BX.delegate(this.onEmployeeSelectorOpen,this))}}if(t===BX.Crm.EntityUserFieldType.boolean){if(this._mode===BX.Crm.EntityEditorMode.edit&&!this.checkIfNotEmpty(this.getValue())){this.markAsChanged()}}if(!this._hasLayout){this._hasLayout=true}BX.addCustomEvent(window,"onCrmEntityEditorUserFieldExternalChanged",BX.proxy(function(t){if(t==this._id&&BX.type.isFunction(this._changeHandler)){this._changeHandler()}},this));BX.addCustomEvent(window,"onCrmEntityEditorUserFieldSetValidator",BX.proxy(function(t,e){if(t==this._id&&BX.type.isFunction(e)){this.validate=e}},this))};BX.Crm.EntityEditorUserField.prototype.onLayoutLoaded=function(t){var e=BX.prop.getString(t,"HTML","");if(e!==""){this.setupContentHtml(e);this._hasLayout=true;this.raiseLayoutEvent()}};BX.Crm.EntityEditorUserField.prototype.onEmployeeSelectorOpen=function(t){var e=BX.getEventTarget(t);if(!e){return}var i=e.id.match(/^add_user_([a-z_0-9-]+)/i);if(BX.type.isArray(i)&&i.length>1){var n=BX.Intranet.UserFieldEmployee.instance(i[1]);if(n){BX.addCustomEvent(n,"onUpdateValue",this._changeHandler)}}};BX.Crm.EntityEditorUserField.create=function(t,e){var i=new BX.Crm.EntityEditorUserField;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorProductRowSummary==="undefined"){BX.Crm.EntityEditorProductRowSummary=function(){BX.Crm.EntityEditorProductRowSummary.superclass.constructor.apply(this);this._loader=null;this._table=null;this._itemCount=0;this._totalCount=0;this._moreButton=null;this._moreButtonRow=null;this._moreButtonClickHandler=BX.delegate(this._onMoreButtonClick,this)};BX.extend(BX.Crm.EntityEditorProductRowSummary,BX.Crm.EntityEditorField);BX.Crm.EntityEditorProductRowSummary.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorProductRowSummary.messages;return e.hasOwnProperty(t)?e[t]:t};BX.Crm.EntityEditorProductRowSummary.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated({});this.adjustWrapper();var e=this.getValue();if(!BX.type.isPlainObject(e)){return}var i=this.getTitle();var n=BX.prop.getArray(e,"items",[]);this._totalCount=BX.prop.getInteger(e,"count",0);if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}this._wrapper.appendChild(this.createTitleNode(i));this._table=BX.create("table",{props:{className:"crm-entity-widget-content-block-products-list"}});var r=this._itemCount=n.length;var o=0;if(r>5){o=this._totalCount-5;r=5}for(var s=0;s<r;s++){this.addProductRow(n[s],-1)}var a,l;this._moreButton=null;if(o>0){a=this._moreButtonRow=this._table.insertRow(-1);a.className="crm-entity-widget-content-block-products-item";l=a.insertCell(-1);l.className="crm-entity-widget-content-block-products-item-name";this._moreButton=BX.create("span",{attrs:{className:"crm-entity-widget-content-block-products-show-more"},events:{click:this._moreButtonClickHandler},text:this.getMessage("notShown").replace(/#COUNT#/gi,o.toString())});l.appendChild(this._moreButton);l=a.insertCell(-1);l.className="crm-entity-widget-content-block-products-price"}a=this._table.insertRow(-1);a.className="crm-entity-widget-content-block-products-item";l=a.insertCell(-1);l.className="crm-entity-widget-content-block-products-item-name";l.innerHTML=this.getMessage("total");l=a.insertCell(-1);l.className="crm-entity-widget-content-block-products-price";l.appendChild(BX.create("div",{attrs:{className:"crm-entity-widget-content-block-products-price-value"},html:e["total"]}));this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block-products"},children:[this._table]}));if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorProductRowSummary.prototype._onMoreButtonClick=function(t){if(this._totalCount>10){BX.onCustomEvent(window,"OpenEntityDetailTab",["tab_products"]);return}this._moreButtonRow.style.display="none";var e=this.getValue();var i=BX.prop.getArray(e,"items",[]);for(var n=5;n<this._itemCount;n++){this.addProductRow(i[n],n)}};BX.Crm.EntityEditorProductRowSummary.prototype.clearLayout=function(){if(!this._hasLayout){return}this._table=null;this._moreButton=null;this._moreButtonRow=null;this._wrapper=BX.remove(this._wrapper);this._hasLayout=false};BX.Crm.EntityEditorProductRowSummary.prototype.addProductRow=function(t,e){if(typeof e==="undefined"){e=-1}var i,n;i=this._table.insertRow(e);i.className="crm-entity-widget-content-block-products-item";n=i.insertCell(-1);n.className="crm-entity-widget-content-block-products-item-name";var r=BX.prop.getString(t,"URL","");if(r!==""){n.appendChild(BX.create("a",{attrs:{target:"_blank",href:r},text:t["PRODUCT_NAME"]}))}else{n.innerHTML=BX.util.htmlspecialchars(t["PRODUCT_NAME"])}n=i.insertCell(-1);n.className="crm-entity-widget-content-block-products-price";n.appendChild(BX.create("div",{attrs:{className:"crm-entity-widget-content-block-products-price-value"},html:t["SUM"]}))};if(typeof BX.Crm.EntityEditorProductRowSummary.messages==="undefined"){BX.Crm.EntityEditorProductRowSummary.messages={}}BX.Crm.EntityEditorProductRowSummary.create=function(t,e){var i=new BX.Crm.EntityEditorProductRowSummary;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorRequisiteSelector==="undefined"){BX.Crm.EntityEditorRequisiteSelector=function(){BX.Crm.EntityEditorRequisiteSelector.superclass.constructor.apply(this);this._requisiteId=0;this._bankDetailId=0;this._itemWrappers={};this._itemButtons={};this._itemBankDetailButtons={}};BX.extend(BX.Crm.EntityEditorRequisiteSelector,BX.Crm.EntityEditorField);BX.Crm.EntityEditorRequisiteSelector.prototype.doInitialize=function(){this._requisiteId=this._model.getIntegerField("REQUISITE_ID",0);this._bankDetailId=this._model.getIntegerField("BANK_DETAIL_ID",0)};BX.Crm.EntityEditorRequisiteSelector.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorRequisiteSelector.messages;return e.hasOwnProperty(t)?e[t]:t};BX.Crm.EntityEditorRequisiteSelector.prototype.getPrefix=function(){return this._id.toLowerCase()+"_"};BX.Crm.EntityEditorRequisiteSelector.prototype.layout=function(t){if(this._hasLayout){return}var e=this.getData();this._requisiteInfo=BX.CrmEntityRequisiteInfo.create({requisiteId:this._requisiteId,bankDetailId:this._bankDetailId,data:BX.prop.getArray(e,"data",{})});var i=this._requisiteInfo.getItems();this._wrapper=BX.create("div",{props:{className:"crm-entity-requisites-slider-wrapper"}});var n=BX.create("div",{props:{className:"crm-entity-requisites-slider-content"}});this._wrapper.appendChild(n);var r=BX.create("div",{props:{className:"crm-entity-requisites-slider-widget-content"}});n.appendChild(r);var o=BX.create("div",{props:{className:"crm-entity-requisites-select-container"}});r.appendChild(o);for(var s=0,a=i.length;s<a;s++){o.appendChild(this.prepareItemLayout(i[s]))}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorRequisiteSelector.prototype.getItemData=function(t){var e=this._requisiteInfo.getItems();for(var i=0,n=e.length;i<n;i++){var r=e[i];if(t===BX.prop.getInteger(r,"requisiteId",0)){return r}}return null};BX.Crm.EntityEditorRequisiteSelector.prototype.prepareItemLayout=function(t){var e=BX.prop.getObject(t,"viewData",null);if(!e){return}var i=BX.prop.getBoolean(t,"selected",false);var n=this.getPrefix();var r=BX.prop.getInteger(t,"requisiteId",0);var o=BX.create("label",{props:{className:"crm-entity-requisites-select-item"}});o.appendChild(BX.create("strong",{text:BX.prop.getString(e,"title","")}));if(i){BX.addClass(o,"crm-entity-requisites-select-item-selected")}this._itemWrappers[r]=o;var s,a;var l=BX.prop.getArray(e,"fields",[]);for(s=0,a=l.length;s<a;s++){var d=l[s];var h=BX.prop.getString(d,"title","");var p=BX.prop.getString(d,"textValue","");if(h!==""&&p!==""){o.appendChild(BX.create("br"));o.appendChild(BX.create("span",{text:h+": "+p}))}}var u=BX.create("input",{props:{type:"radio",name:n+"requisite",checked:i,className:"crm-entity-requisites-select-item-field"},attrs:{"data-requisiteid":r}});o.appendChild(u);this._itemButtons[r]=u;BX.bind(u,"change",BX.delegate(this.onItemChange,this));var c=BX.prop.getArray(t,"bankDetailViewDataList",[]);if(c.length>0){var m=BX.create("span",{props:{className:"crm-entity-requisites-select-item-bank-requisites-container"}});o.appendChild(m);m.appendChild(BX.create("span",{props:{className:"crm-entity-requisites-select-item-bank-requisites-title"},html:this.getMessage("bankDetails")}));var y=BX.create("span",{props:{className:"crm-entity-requisites-select-item-bank-requisites-field-container"}});m.appendChild(y);this._itemBankDetailButtons[r]={};for(s=0,a=c.length;s<a;s++){var g=c[s];var f=BX.prop.getInteger(g,"pseudoId",0);var _=BX.prop.getObject(g,"viewData",null);if(!_){continue}var E=i&&BX.prop.getBoolean(g,"selected",false);var C=BX.create("label",{props:{className:"crm-entity-requisites-select-item-bank-requisites-field-item"}});y.appendChild(C);var B=BX.create("input",{props:{type:"radio",name:n+"bankrequisite"+r,checked:E,className:"crm-entity-requisites-select-item-bank-requisites-field"},attrs:{"data-requisiteid":r,"data-bankdetailid":f}});C.appendChild(B);BX.bind(B,"change",BX.delegate(this.onItemBankDetailChange,this));this._itemBankDetailButtons[r][f]=B;C.appendChild(document.createTextNode(BX.prop.getString(_,"title","")))}o.appendChild(BX.create("span",{style:{display:"block",clear:"both"}}))}return o};BX.Crm.EntityEditorRequisiteSelector.prototype.clearLayout=function(){if(!this._hasLayout){return}this._wrapper=BX.remove(this._wrapper);this._itemWrappers={};this._itemButtons={};this._itemBankDetailButtons={};this._hasLayout=false};BX.Crm.EntityEditorRequisiteSelector.prototype.save=function(){this._model.setField("REQUISITE_ID",this._requisiteId,{originator:this});this._model.setField("BANK_DETAIL_ID",this._bankDetailId,{originator:this})};BX.Crm.EntityEditorRequisiteSelector.prototype.onItemChange=function(t){var e=BX.getEventTarget(t);if(!e.checked){return}var i=parseInt(e.getAttribute("data-requisiteid"));if(isNaN(i)||i<=0){return}this._requisiteId=i;this._bankDetailId=0;var n=this.getItemData(this._requisiteId);var r=BX.prop.getArray(n,"bankDetailViewDataList",[]);for(var o=0,s=r.length;o<s;o++){var a=r[o];var l=BX.prop.getInteger(a,"pseudoId",0);if(l>0&&BX.prop.getBoolean(a,"selected",false)){this._bankDetailId=l;break}}for(var d in this._itemWrappers){if(!this._itemWrappers.hasOwnProperty(d)){continue}var h=this._itemWrappers[d];var p=this._requisiteId===parseInt(d);if(p){BX.addClass(h,"crm-entity-requisites-select-item-selected")}else{BX.removeClass(h,"crm-entity-requisites-select-item-selected")}if(this._itemButtons.hasOwnProperty(d)){var u=this._itemButtons[d];if(u.checked!==p){u.checked=p}}if(this._itemBankDetailButtons.hasOwnProperty(d)){var c=this._itemBankDetailButtons[d];for(var m in c){if(!c.hasOwnProperty(m)){continue}var y=p&&this._bankDetailId===parseInt(m);var g=c[m];if(g.checked!==y){g.checked=y}}}}this.markAsChanged()};BX.Crm.EntityEditorRequisiteSelector.prototype.onItemBankDetailChange=function(t){var e=BX.getEventTarget(t);if(!e.checked){return}var i=parseInt(e.getAttribute("data-requisiteid"));if(isNaN(i)||i<=0){return}if(this._requisiteId!==i){return}var n=parseInt(e.getAttribute("data-bankdetailid"));if(isNaN(n)||n<=0){return}this._bankDetailId=n};if(typeof BX.Crm.EntityEditorRequisiteSelector.messages==="undefined"){BX.Crm.EntityEditorRequisiteSelector.messages={}}BX.Crm.EntityEditorRequisiteSelector.create=function(t,e){var i=new BX.Crm.EntityEditorRequisiteSelector;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorRequisiteListItem==="undefined"){BX.Crm.EntityEditorRequisiteListItem=function(){this._id="";this._settings=null;this._owner=null;this._mode=BX.Crm.EntityEditorMode.intermediate;this._data=null;this._requisiteId=0;this._container=null;this._wrapper=null;this._innerWrapper=null;this._editButton=null;this._deleteButton=null;this._hasLayout=false};BX.Crm.EntityEditorRequisiteListItem.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=BX.type.isPlainObject(e)?e:{};this._owner=BX.prop.get(this._settings,"owner",null);this._mode=BX.prop.getInteger(this._settings,"mode",BX.Crm.EntityEditorMode.intermediate);this._data=BX.prop.getObject(this._settings,"data",{});this._requisiteId=BX.prop.getInteger(this._data,"requisiteId",0);this._container=BX.prop.getElementNode(this._settings,"container")},getId:function(){return this._id},getMessage:function(t){return BX.prop.getString(BX.Crm.EntityEditorRequisiteListItem.messages,t,t)},getRequisiteId:function(){return this._requisiteId},getData:function(){return this._data},setData:function(t){this._data=t},layout:function(t){if(this._hasLayout){return}var e=BX.prop.getObject(this._data,"viewData",null);if(!e){e={}}var i=this._mode===BX.Crm.EntityEditorMode.view;this._wrapper=BX.create("div",{props:{className:"crm-entity-widget-client-requisites-container crm-entity-widget-client-requisites-container-opened"}});this._innerWrapper=BX.create("dl",{props:{className:"crm-entity-widget-client-requisites-list"}});this.prepareViewLayout(e,["RQ_ADDR"]);this.prepareFieldViewLayout(e,"RQ_ADDR");var n=BX.prop.getArray(this._data,"bankDetailViewDataList",[]);for(var r=0,o=n.length;r<o;r++){var s=n[r];if(!BX.prop.getBoolean(s,"isDeleted",false)){this.prepareViewLayout(BX.prop.getObject(s,"viewData",null),[])}}if(!i){this._deleteButton=BX.create("span",{props:{className:"crm-entity-widget-client-requisites-remove-icon"},events:{click:BX.delegate(this.onRemoveButtonClick,this)}});this._editButton=BX.create("span",{props:{className:"crm-entity-widget-client-requisites-edit-icon"},events:{click:BX.delegate(this.onEditButtonClick,this)}})}this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-client-requisites-inner-container"},children:[this._deleteButton,this._editButton,this._innerWrapper]}));var a=BX.prop.getElementNode(t,"anchor",null);if(a){this._container.insertBefore(this._wrapper,a)}else{this._container.appendChild(this._wrapper)}this._hasLayout=true},prepareViewLayout:function(t,e){if(!t){return}var i=BX.prop.getString(t,"title","");if(i!==""){this._innerWrapper.appendChild(BX.create("dt",{props:{className:"crm-entity-widget-client-requisites-name"},text:i}))}var n,r;var o={};if(BX.type.isArray(e)){for(n=0,r=e.length;n<r;n++){o[e[n]]=true}}var s=[];var a=BX.prop.getArray(t,"fields",[]);for(n=0,r=a.length;n<r;n++){var l=a[n];var d=BX.prop.getString(l,"name","");if(o.hasOwnProperty(d)){continue}var h=BX.prop.getString(l,"title","");var p=BX.prop.getString(l,"textValue","");if(h!==""&&p!==""){s.push(h+": "+p)}}this._innerWrapper.appendChild(BX.create("dd",{props:{className:"crm-entity-widget-client-requisites-value"},text:s.join(", ")}))},prepareFieldViewLayout:function(t,e){if(!t){return}var i=BX.prop.getArray(t,"fields",[]);for(var n=0,r=i.length;n<r;n++){var o=i[n];var s=BX.prop.getString(o,"name","");if(s!==e){continue}var a=BX.prop.getString(o,"title","");var l=BX.prop.getString(o,"textValue","");if(a===""||l===""){continue}this._innerWrapper.appendChild(BX.create("dt",{props:{className:"crm-entity-widget-client-requisites-name"},text:a}));this._innerWrapper.appendChild(BX.create("dd",{props:{className:"crm-entity-widget-client-requisites-value"},text:l}))}},clearLayout:function(){if(!this._hasLayout){return}this._wrapper=BX.remove(this._wrapper);this._innerWrapper=null;this._editButton=null;this._deleteButton=null;this._hasLayout=false},getContainer:function(){return this._container},setContainer:function(t){this._container=t},getWrapper:function(){return this._wrapper},prepareData:function(){var t=this._labelInput?BX.util.trim(this._labelInput.value):"";if(t===""){return null}var e={VALUE:t};var i=BX.prop.getInteger(this._data,"ID",0);if(i>0){e["ID"]=i}var n=BX.prop.getString(this._data,"XML_ID","");if(i>0){e["XML_ID"]=n}return e},onEditButtonClick:function(t){this._owner.onEditItem(this)},onRemoveButtonClick:function(t){var e=BX.Crm.EditorAuxiliaryDialog.create(this._id,{title:this.getMessage("deleteTitle"),content:this.getMessage("deleteConfirm"),buttons:[{id:"accept",type:BX.Crm.DialogButtonType.accept,text:BX.message("CRM_EDITOR_DELETE"),callback:BX.delegate(this.onRemovalConfirmationDialogButtonClick,this)},{id:"cancel",type:BX.Crm.DialogButtonType.cancel,text:BX.message("CRM_EDITOR_CANCEL"),callback:BX.delegate(this.onRemovalConfirmationDialogButtonClick,this)}]});e.open();this._owner.onOpenItemRemovalConfirmation(this)},onRemovalConfirmationDialogButtonClick:function(t){var e=t.getDialog();if(t.getId()==="accept"){this._owner.onRemoveItem(this)}e.close();this._owner.onCloseItemRemovalConfirmation(this)}};if(typeof BX.Crm.EntityEditorRequisiteListItem.messages==="undefined"){BX.Crm.EntityEditorRequisiteListItem.messages={}}BX.Crm.EntityEditorRequisiteListItem.create=function(t,e){var i=new BX.Crm.EntityEditorRequisiteListItem;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorRequisiteList==="undefined"){BX.Crm.EntityEditorRequisiteList=function(){BX.Crm.EntityEditorRequisiteList.superclass.constructor.apply(this);this._items=null;this._data=null;this._externalContext=null;this._externalEventHandler=null;this._createButton=null;this._dataInputs={};this._dataSignInputs={};this._itemWrapper=null;this._dataWrapper=null;this._isPresetMenuOpened=false;this._newItemIndex=-1;this._sliderUrls={}};BX.extend(BX.Crm.EntityEditorRequisiteList,BX.Crm.EntityEditorField);BX.Crm.EntityEditorRequisiteList.prototype.doInitialize=function(){this.initializeFromModel()};BX.Crm.EntityEditorRequisiteList.prototype.initializeFromModel=function(){var t=this.getValue();this._data=BX.type.isArray(t)?BX.clone(t,true):[];var e,i;for(e=0,i=this._data.length;e<i;e++){this.prepareRequisiteData(this._data[e])}this._requisiteInfo=BX.CrmEntityRequisiteInfo.create({requisiteId:0,bankDetailId:0,data:this._data})};BX.Crm.EntityEditorRequisiteList.prototype.processModelChange=function(t){if(BX.prop.get(t,"originator",null)===this){return}if(!BX.prop.getBoolean(t,"forAll",false)&&BX.prop.getString(t,"name","")!==this.getName()){return}this.initializeFromModel();this.refreshLayout()};BX.Crm.EntityEditorRequisiteList.prototype.reset=function(){this.initializeFromModel();for(var t in this._sliderUrls){if(this._sliderUrls.hasOwnProperty(t)){BX.Crm.Page.closeSlider(this._sliderUrls[t])}}this._sliderUrls={}};BX.Crm.EntityEditorRequisiteList.prototype.rollback=function(){if(this.isChanged()){this.reset()}};BX.Crm.EntityEditorRequisiteList.prototype.doSetMode=function(t){this.rollback()};BX.Crm.EntityEditorRequisiteList.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorRequisiteList.messages;return e.hasOwnProperty(t)?e[t]:BX.Crm.EntityEditorRequisiteList.superclass.getMessage.apply(this,arguments)};BX.Crm.EntityEditorRequisiteList.prototype.prepareDataInputName=function(t,e){return this.getName()+"["+t.toString()+"]"+"["+e+"]"};BX.Crm.EntityEditorRequisiteList.prototype.prepareRequisiteData=function(t){var e=BX.prop.getInteger(t,"requisiteId",0);var i=BX.prop.getString(t,"pseudoId","");if(e>0){t["key"]=e.toString();t["isNew"]=false;t["isChanged"]=BX.prop.getBoolean(t,"isChanged",false)}else{t["key"]=i;t["isNew"]=true;t["isChanged"]=BX.prop.getBoolean(t,"isChanged",true)}t["isDeleted"]=false};BX.Crm.EntityEditorRequisiteList.prototype.findRequisiteDataIndexByKey=function(t){for(var e=0,i=this._data.length;e<i;e++){if(BX.prop.getString(this._data[e],"key",0)===t){return e}}return-1};BX.Crm.EntityEditorRequisiteList.prototype.getRequisiteDataByKey=function(t){var e=this.findRequisiteDataIndexByKey(t);return e>=0?this._data[e]:null};BX.Crm.EntityEditorRequisiteList.prototype.setupRequisiteData=function(t){var e=BX.prop.getString(t,"key","");if(e===""){return}var i=this.findRequisiteDataIndexByKey(e);if(i>=0){this._data[i]=t}else{this._data.push(t)}this._requisiteInfo=BX.CrmEntityRequisiteInfo.create({requisiteId:0,bankDetailId:0,data:this._data})};BX.Crm.EntityEditorRequisiteList.prototype.refreshRequisiteDataInputs=function(){if(!this._hasLayout){return}BX.cleanNode(this._dataWrapper);for(var t=0,e=this._data.length;t<e;t++){var i=this._data[t];var n=BX.prop.getString(i,"key","");if(n===""){continue}var r=BX.prop.getBoolean(i,"isChanged",false);var o=BX.prop.getBoolean(i,"isDeleted",false);if(!r&&!o){continue}if(o){this._dataWrapper.appendChild(BX.create("input",{props:{type:"hidden",name:this.prepareDataInputName(n,"DELETED"),value:"Y"}}))}else{var s=BX.prop.getString(i,"requisiteDataSign","");if(s!==""){this._dataWrapper.appendChild(BX.create("input",{props:{type:"hidden",name:this.prepareDataInputName(n,"SIGN"),value:s}}))}var a=BX.prop.getString(i,"requisiteData","");if(a!==""){this._dataWrapper.appendChild(BX.create("input",{props:{type:"hidden",name:this.prepareDataInputName(n,"DATA"),value:a}}))}}}};BX.Crm.EntityEditorRequisiteList.prototype.hasContentToDisplay=function(){if(this._mode===BX.Crm.EntityEditorMode.edit){return true}return this._requisiteInfo&&this._requisiteInfo.getItems().length>0};BX.Crm.EntityEditorRequisiteList.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated();this.adjustWrapper();this._items=[];if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}var e,i;var n=this._requisiteInfo.getItems();for(e=0,i=n.length;e<i;e++){var r=n[e];var o=BX.Crm.EntityEditorRequisiteListItem.create(BX.prop.getString(r,"key",""),{owner:this,mode:this._mode,data:r});this._items.push(o)}if(this.isInEditMode()){this._dataWrapper=BX.create("div");this._wrapper.appendChild(this._dataWrapper);this._wrapper.appendChild(this.createTitleNode(this.getTitle()));this._itemWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner crm-entity-widget-content-block-requisites"}});this._wrapper.appendChild(this._itemWrapper);for(e=0,i=this._items.length;e<i;e++){this._items[e].setContainer(this._itemWrapper);this._items[e].layout()}this._createButton=BX.create("span",{props:{className:"crm-entity-widget-client-requisites-add-btn"},text:BX.message("CRM_EDITOR_ADD")});this._itemWrapper.appendChild(this._createButton);BX.bind(this._createButton,"click",BX.delegate(this.onCreateButtonClick,this))}else{this._wrapper.appendChild(this.createTitleNode(this.getTitle()));this._itemWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-colums-block"}});this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[this._itemWrapper]}));this._wrapper.appendChild(this._itemWrapper);for(e=0,i=this._items.length;e<i;e++){this._items[e].setContainer(this._itemWrapper);this._items[e].layout()}}if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorRequisiteList.prototype.doClearLayout=function(t){if(this._items){for(var e=0,i=this._items.length;e<i;e++){this._items[e].clearLayout()}}this._items=[];this._itemWrapper=null;this._createButton=null};BX.Crm.EntityEditorRequisiteList.prototype.getItemByIndex=function(t){return t>=0&&t<=this._items.length-1?this._items[t]:null};BX.Crm.EntityEditorRequisiteList.prototype.getItemById=function(t){for(var e=0,i=this._items.length;e<i;e++){var n=this._items[e];if(n.getId()===t){return n}}return null};BX.Crm.EntityEditorRequisiteList.prototype.getItemCount=function(){return this._items.length};BX.Crm.EntityEditorRequisiteList.prototype.getItemIndex=function(t){for(var e=0,i=this._items.length;e<i;e++){if(this._items[e]===t){return e}}return-1};BX.Crm.EntityEditorRequisiteList.prototype.removeItemByIndex=function(t){if(t<this._items.length){this._items.splice(t,1)}};BX.Crm.EntityEditorRequisiteList.prototype.removeItem=function(t){var e=this.getItemIndex(t);if(e<0){return}var i=this.getRequisiteDataByKey(t.getId());if(i){i["isDeleted"]=true}t.clearLayout();this.removeItemByIndex(e);this.refreshRequisiteDataInputs();this.markAsChanged()};BX.Crm.EntityEditorRequisiteList.prototype.openEditor=function(t){var e=BX.prop.getInteger(t,"requisiteId",0);var i=this._editor.getContextId();var n={etype:this._editor.getEntityTypeId(),eid:this._editor.getEntityId(),external_context_id:i};var r=BX.prop.getInteger(t,"presetId",0);if(r>0){n["pid"]=r}var o="";if(e<=0){this._newItemIndex++;o="n"+this._newItemIndex.toString();n["pseudo_id"]=o}var s=BX.util.add_url_param(this._editor.getRequisiteEditUrl(e),n);if(!this._externalEventHandler){this._externalEventHandler=BX.delegate(this.onExternalEvent,this);BX.addCustomEvent(window,"onLocalStorageSet",this._externalEventHandler)}if(!this._externalContext){this._externalContext={}}if(e>0){this._externalContext[e]={requisiteId:e,url:s}}else{this._externalContext[o]={pseudoId:o,url:s}}if(e>0){this._sliderUrls[e]=s}BX.Crm.Page.openSlider(s,{width:950})};BX.Crm.EntityEditorRequisiteList.prototype.onEditItem=function(t){this.openEditor({requisiteId:t.getRequisiteId()})};BX.Crm.EntityEditorRequisiteList.prototype.onRemoveItem=function(t){this.removeItem(t)};BX.Crm.EntityEditorRequisiteList.prototype.onOpenItemRemovalConfirmation=function(t){if(this._singleEditController){this._singleEditController.setActiveDelayed(false)}};BX.Crm.EntityEditorRequisiteList.prototype.onCloseItemRemovalConfirmation=function(t){if(this._singleEditController){this._singleEditController.setActiveDelayed(true)}};BX.Crm.EntityEditorRequisiteList.prototype.onExternalEvent=function(t){var e=BX.type.isNotEmptyString(t["key"])?t["key"]:"";if(e!=="BX.Crm.RequisiteSliderEditor:onSave"){return}var i=BX.type.isPlainObject(t["value"])?t["value"]:{};var n=BX.prop.getString(i,"context","");if(n!==this._editor.getContextId()){return}var r=BX.prop.getInteger(i,"presetId",0);var o=BX.prop.getString(i,"pseudoId","");var s=BX.prop.getInteger(i,"requisiteId",0);var a=BX.prop.getString(i,"requisiteDataSign","");var l=BX.prop.getString(i,"requisiteData","");var d={entityTypeId:this._editor.getEntityTypeId(),entityId:this._editor.getEntityId(),presetId:r,pseudoId:o,requisiteId:s,requisiteData:l,requisiteDataSign:a,isChanged:true};this.prepareRequisiteData(d);this.setupRequisiteData(d);this.refreshRequisiteDataInputs();this.markAsChanged();var h=BX.prop.getString(d,"key","");var p=BX.prop.getObject(this._externalContext,h,null);if(!p){return}var u=this.getItemById(h);var c;if(u){u.setData(d);u.clearLayout();c={};var m=this.getItemIndex(u);if(m<this.getItemCount()-1){c["anchor"]=this.getItemByIndex(m+1).getWrapper()}else if(this._createButton){c["anchor"]=this._createButton}u.layout(c)}else{u=BX.Crm.EntityEditorRequisiteListItem.create(h,{owner:this,mode:this._mode,data:d,container:this._itemWrapper});this._items.push(u);c={};if(this._createButton){c["anchor"]=this._createButton}u.layout(c)}var y=BX.prop.getString(p,"url","");if(y!==""){BX.Crm.Page.closeSlider(y,true)}delete this._externalContext[s]};BX.Crm.EntityEditorRequisiteList.prototype.onCreateButtonClick=function(t){this.togglePresetMenu()};BX.Crm.EntityEditorRequisiteList.prototype.togglePresetMenu=function(){if(this._isPresetMenuOpened){this.closePresetMenu()}else{this.openPresetMenu()}};BX.Crm.EntityEditorRequisiteList.prototype.openPresetMenu=function(){if(this._isPresetMenuOpened){return}var t=[];var e=BX.prop.getArray(this._schemeElement.getData(),"presets");for(var i=0,n=e.length;i<n;i++){var r=e[i];var o=BX.prop.getString(r,"VALUE",i);var s=BX.prop.getString(r,"NAME",o);t.push({text:s,value:o,onclick:BX.delegate(this.onPresetSelect,this)})}BX.PopupMenu.show(this._id,this._createButton,t,{angle:false,events:{onPopupShow:BX.delegate(this.onPresetMenuShow,this),onPopupClose:BX.delegate(this.onPresetMenuClose,this)}})};BX.Crm.EntityEditorRequisiteList.prototype.closePresetMenu=function(){if(!this._isPresetMenuOpened){return}var t=BX.PopupMenu.getMenuById(this._id);if(t){t.popupWindow.close()}};BX.Crm.EntityEditorRequisiteList.prototype.onPresetMenuShow=function(){this._isPresetMenuOpened=true};BX.Crm.EntityEditorRequisiteList.prototype.onPresetMenuClose=function(){BX.PopupMenu.destroy(this._id);this._isPresetMenuOpened=false};BX.Crm.EntityEditorRequisiteList.prototype.onPresetSelect=function(t,e){this.openEditor({presetId:e.value});this.closePresetMenu()};BX.Crm.EntityEditorRequisiteList.prototype.save=function(){};if(typeof BX.Crm.EntityEditorRequisiteList.messages==="undefined"){BX.Crm.EntityEditorRequisiteList.messages={}}BX.Crm.EntityEditorRequisiteList.create=function(t,e){var i=new BX.Crm.EntityEditorRequisiteList;i.initialize(t,e);return i}}if(typeof BX.Crm.ClientEditorEntityRequisitePanel==="undefined"){BX.Crm.ClientEditorEntityRequisitePanel=function(){this._id="";this._settings={};this._editor=null;this._entityInfo=null;this._requisiteInfo=null;this._mode=BX.Crm.EntityEditorMode.intermediate;this._selectedRequisiteId=0;this._selectedBankDetailId=0;this._container=null;this._wrapper=null;this._contentWrapper=null;this._requisiteInput=null;this._bankDetailInput=null;this._toggleButton=null;this._editButton=null;this._toggleButtonHandler=BX.delegate(this.onToggleButtonClick,this);this._editButtonHandler=BX.delegate(this.onEditButtonClick,this);this._isExpanded=false;this._hasLayout=false;this._externalEventHandler=BX.delegate(this.onExternalEvent,this);this._changeNotifier=null};BX.Crm.ClientEditorEntityRequisitePanel.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._editor=BX.prop.get(this._settings,"editor");this._container=BX.prop.getElementNode(this._settings,"container",null);this._mode=BX.prop.getInteger(this._settings,"mode",0);this._entityInfo=BX.prop.get(this._settings,"entityInfo",null);this._requisiteInfo=BX.prop.get(this._settings,"requisiteInfo",null);this._selectedRequisiteId=this._requisiteInfo.getRequisiteId();this._selectedBankDetailId=this._requisiteInfo.getBankDetailId();this._changeNotifier=BX.CrmNotifier.create(this);if(BX.Crm.ClientEditorEntityRequisitePanel.options.hasOwnProperty(this._id)){this._isExpanded=BX.prop.getBoolean(BX.Crm.ClientEditorEntityRequisitePanel.options[this._id],"expanded",false)}},getMessage:function(t){var e=BX.Crm.ClientEditorEntityRequisitePanel.messages;return e.hasOwnProperty(t)?e[t]:t},getContainer:function(){return this._container},setContainer:function(t){this._container=t},isExpanded:function(){return this._isExpanded},setExpanded:function(t){t=!!t;if(this._isExpanded===t){return}this._isExpanded=t;if(!BX.Crm.ClientEditorEntityRequisitePanel.options.hasOwnProperty(this._id)){BX.Crm.ClientEditorEntityRequisitePanel.options[this._id]={}}BX.Crm.ClientEditorEntityRequisitePanel.options[this._id]["expanded"]=this._isExpanded;if(t){BX.addClass(this._wrapper,"crm-entity-widget-client-requisites-container-opened")}else{BX.removeClass(this._wrapper,"crm-entity-widget-client-requisites-container-opened")}},toggle:function(){this.setExpanded(!this._isExpanded)},addChangeListener:function(t){this._changeNotifier.addListener(t)},removeChangeListener:function(t){this._changeNotifier.removeListener(t)},layout:function(){if(this._hasLayout){return}var t=null;var e=null;var i=this._selectedRequisiteId;var n=this._selectedBankDetailId;if(i>0){t=this._requisiteInfo.getItemById(i)}if(!t){t=this._requisiteInfo.getSelectedItem()}if(!t){t=this._requisiteInfo.getFirstItem()}if(t){if(n>0){e=this._requisiteInfo.getItemBankDetailById(i,n)}if(!e){e=this._requisiteInfo.getSelectedItemBankDetail(i)}if(!e){e=this._requisiteInfo.getFirstItemBankDetail(i)}}var r=this._mode===BX.Crm.EntityEditorMode.view;this._wrapper=BX.create("div",{props:{className:"crm-entity-widget-client-requisites-container"}});this._container.appendChild(this._wrapper);if(this._isExpanded){BX.addClass(this._wrapper,"crm-entity-widget-client-requisites-container-opened")}if(!r){this._requisiteInput=BX.create("input",{props:{type:"hidden",name:"REQUISITE_ID",value:i}});this._wrapper.appendChild(this._requisiteInput);this._bankDetailInput=BX.create("input",{props:{type:"hidden",name:"BANK_DETAIL_ID",value:n}});this._wrapper.appendChild(this._bankDetailInput)}if(t){this._toggleButton=BX.create("a",{props:{className:"crm-entity-widget-client-requisites-show-btn"},text:this.getMessage("toggle").toLowerCase()});this._wrapper.appendChild(this._toggleButton);BX.bind(this._toggleButton,"click",this._toggleButtonHandler);var o=BX.create("div",{props:{className:"crm-entity-widget-client-requisites-inner-container"}});this._wrapper.appendChild(o);if(!r){this._editButton=BX.create("span",{props:{className:"crm-entity-widget-client-requisites-edit-icon"}});this._editButton.setAttribute("data-editor-control-type","button");o.appendChild(this._editButton);BX.bind(this._editButton,"click",this._editButtonHandler)}this._contentWrapper=BX.create("dl",{props:{className:"crm-entity-widget-client-requisites-list"}});o.appendChild(this._contentWrapper);var s=BX.prop.getObject(t,"viewData",null);this.prepareItemView(s,["RQ_ADDR"]);this.prepareItemFieldView(s,"RQ_ADDR");if(e){this.prepareItemView(BX.prop.getObject(e,"viewData",null))}}this._hasLayout=true},prepareItemView:function(t,e){if(!t){return}var i=BX.prop.getString(t,"title","");if(i!==""){this._contentWrapper.appendChild(BX.create("dt",{props:{className:"crm-entity-widget-client-requisites-name"},text:i}))}var n,r;var o={};if(BX.type.isArray(e)){for(n=0,r=e.length;n<r;n++){o[e[n]]=true}}var s=[];var a=BX.prop.getArray(t,"fields",[]);for(n=0,r=a.length;n<r;n++){var l=a[n];var d=BX.prop.getString(l,"name","");if(o.hasOwnProperty(d)){continue}var h=BX.prop.getString(l,"title","");var p=BX.prop.getString(l,"textValue","");if(h!==""&&p!==""){s.push(h+": "+p)}}this._contentWrapper.appendChild(BX.create("dd",{props:{className:"crm-entity-widget-client-requisites-value"},text:s.join(", ")}))},prepareItemFieldView:function(t,e){if(!t){return}var i=BX.prop.getArray(t,"fields",[]);for(var n=0,r=i.length;n<r;n++){var o=i[n];var s=BX.prop.getString(o,"name","");if(s!==e){continue}var a=BX.prop.getString(o,"title","");var l=BX.prop.getString(o,"textValue","");if(a===""||l===""){continue}this._contentWrapper.appendChild(BX.create("dt",{props:{className:"crm-entity-widget-client-requisites-name"},text:a}));this._contentWrapper.appendChild(BX.create("dd",{props:{className:"crm-entity-widget-client-requisites-value"},text:l}))}},clearLayout:function(){if(!this._hasLayout){return}if(this._toggleButton){BX.unbind(this._toggleButton,"click",this._toggleButtonHandler);this._toggleButton=null}if(this._editButton){BX.unbind(this._editButton,"click",this._editButtonHandler);this._editButton=null}this._isExpanded=false;this._requisiteInput=null;this._bankDetailInput=null;this._contentWrapper=null;this._wrapper=BX.remove(this._wrapper);this._hasLayout=false},refreshLayout:function(){var t=this.isExpanded();this.clearLayout();this.layout();this.setExpanded(t)},getRuntimeValue:function(){return{REQUISITE_ID:this._selectedRequisiteId,BANK_DETAIL_ID:this._selectedBankDetailId}},onToggleButtonClick:function(t){this.toggle();return BX.eventReturnFalse(t)},onEditButtonClick:function(t){if(!this._editor){return}var e=BX.prop.getString(this._settings,"requisiteSelectUrl","");if(e===""&&BX.type.isFunction(this._editor.getEntityRequisiteSelectUrl)){e=this._editor.getEntityRequisiteSelectUrl(this._entityInfo.getTypeName(),this._entityInfo.getId())}if(e!==""){e=BX.util.add_url_param(e,{external_context_id:this._editor.getContextId(),requisite_id:this._selectedRequisiteId,bank_detail_id:this._selectedBankDetailId});BX.Crm.Page.openSlider(e);BX.addCustomEvent(window,"onLocalStorageSet",this._externalEventHandler)}BX.eventCancelBubble(t)},onExternalEvent:function(t){if(this._mode===BX.Crm.EntityEditorMode.view){return}var e=BX.type.isNotEmptyString(t["key"])?t["key"]:"";var i=BX.type.isPlainObject(t["value"])?t["value"]:{};if(!(this._editor&&this._editor.getContextId()===BX.prop.getString(i,"context"))){return}if(e==="BX.Crm.EntityRequisiteSelector:onCancel"){BX.removeCustomEvent(window,"onLocalStorageSet",this._externalEventHandler)}else if(e==="BX.Crm.EntityRequisiteSelector:onSave"){BX.removeCustomEvent(window,"onLocalStorageSet",this._externalEventHandler);var n=BX.prop.getInteger(i,"requisiteId");if(n>0){this._selectedRequisiteId=n;if(this._requisiteInput){this._requisiteInput.value=this._selectedRequisiteId}}var r=BX.prop.getInteger(i,"bankDetailId");if(r){this._selectedBankDetailId=r;if(this._bankDetailInput){this._bankDetailInput.value=this._selectedBankDetailId}}this._changeNotifier.notify([{requisiteId:this._selectedRequisiteId,bankDetailId:this._selectedBankDetailId}]);this.refreshLayout()}}};if(typeof BX.Crm.ClientEditorEntityRequisitePanel.messages==="undefined"){BX.Crm.ClientEditorEntityRequisitePanel.messages={}}BX.Crm.ClientEditorEntityRequisitePanel.options={};BX.Crm.ClientEditorEntityRequisitePanel.create=function(t,e){var i=new BX.Crm.ClientEditorEntityRequisitePanel;i.initialize(t,e);return i}}if(typeof BX.Crm.RequisiteNavigator==="undefined"){BX.Crm.RequisiteNavigator=function(){this._id=null;this._settings={};this._requisite=null;this._bankDetail=null;this._bankDetailList=null;this._closingNotifier=null;this._nextButton=null;this._nextButtonHandler=BX.delegate(this.onNextButtonClick,this);this._wrapper=null;this._innerWrapper=null;this._titleContainer=null;this._contentContainer=null;this._bankDetailContainer=null;this._popup=null;this._isOpened=false;this._isExpanded=true;this._hasLayout=false};BX.Crm.RequisiteNavigator.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._requisiteInfo=BX.prop.get(e,"requisiteInfo");var i=this._requisiteInfo.getRequisiteId();var n=this._requisiteInfo.getBankDetailId();this._requisite=i>0?this._requisiteInfo.getItemById(i):null;if(!this._requisite){this._requisite=this._requisiteInfo.getSelectedItem()}if(!this._requisite){this._requisite=this._requisiteInfo.getFirstItem()}if(this._requisite){this._bankDetailList=this._requisiteInfo.getItemBankDetailList(i);if(this._bankDetailList){if(n>0){this._bankDetail=this._bankDetailList.getItemById(n)}if(!this._bankDetail){this._bankDetail=this._bankDetailList.getSelectedItem()}if(!this._bankDetail){this._bankDetail=this._bankDetailList.getFirstItem()}}}this._closingNotifier=BX.CrmNotifier.create(this)},getId:function(){return this._id},getMessage:function(t){return BX.prop.getString(BX.Crm.RequisiteNavigator.messages,t,t)},addClosingListener:function(t){this._closingNotifier.addListener(t)},removeClosingListener:function(t){this._closingNotifier.removeListener(t)},isOpened:function(){return this._isOpened},open:function(t){if(this._isOpened){return}var e=0,i=0;if(BX.type.isElementNode(t)){e=t.offsetWidth+15;i=-(t.offsetHeight+30)}this._popup=new BX.PopupWindow(this._id,t,{autoHide:true,draggable:false,offsetLeft:e,offsetTop:i,noAllPaddings:true,bindOptions:{forceBindPosition:true},closeByEsc:true,events:{onPopupShow:BX.delegate(this.onPopupShow,this),onPopupClose:BX.delegate(this.onPopupClose,this),onPopupDestroy:BX.delegate(this.onPopupDestroy,this)},content:this.prepareContent()});this._popup.show()},close:function(){if(!this._isOpened){return}if(this._popup){this._popup.close()}},prepareContent:function(){this._wrapper=BX.create("div",{props:{className:"crm-entity-widget-client-requisites-wrap"}});this._titleContainer=BX.create("div",{props:{className:"crm-entity-widget-client-requisites-info-box"}});this._wrapper.appendChild(this._titleContainer);this._requisiteTitleWrapper=BX.create("div",{props:{className:"crm-entity-widget-client-requisites-info-wrapper"}});this._titleContainer.appendChild(this._requisiteTitleWrapper);this._nextButton=BX.create("div",{props:{className:"crm-entity-widget-client-requisites-arrow-right"},children:[BX.create("div",{props:{className:"crm-entity-widget-client-requisites-arrow-right-item"}})]});this._titleContainer.appendChild(this._nextButton);BX.bind(this._nextButton,"click",this._nextButtonHandler);this._contentWrapper=BX.create("div",{props:{className:"crm-entity-widget-client-requisites-box crm-entity-widget-client-requisites-box-active"}});this._wrapper.appendChild(this._contentWrapper);this._contentInnerWrapper=BX.create("div",{props:{className:"crm-entity-widget-client-requisites-box-inner"}});this._contentWrapper.appendChild(this._contentInnerWrapper);this._requisiteWrapper=BX.create("div",{props:{className:"crm-entity-widget-client-requisites-list-container"}});this._contentInnerWrapper.appendChild(this._requisiteWrapper);this._bankDetailWrapper=BX.create("div",{props:{className:"crm-entity-widget-client-requisites-list-container"}});this._contentInnerWrapper.appendChild(this._bankDetailWrapper);this.renderRequisites();return this._wrapper},renderTitleFields:function(t,e){for(var i=0,n=t.length;i<n;i++){var r=t[i];var o=BX.prop.getString(r,"title","");var s=BX.prop.getString(r,"textValue","");if(o===""||s===""){continue}e.appendChild(BX.create("div",{props:{className:"crm-entity-widget-client-requisites-info-desc"},text:o}));e.appendChild(BX.create("div",{props:{className:"crm-entity-widget-client-requisites-info-content"},children:[BX.create("div",{props:{className:"crm-entity-widget-client-requisites-info-content-item"},text:s})]}))}},renderContentFields:function(t,e,i){var n=BX.create("div",{props:{className:"crm-entity-widget-client-requisites-list"}});i.appendChild(n);var r=BX.create("div",{props:{className:"crm-entity-widget-client-requisites-item"}});n.appendChild(r);r.appendChild(BX.create("div",{props:{className:"crm-entity-widget-client-requisites-name"},text:e}));var o=[];for(var s=0,a=t.length;s<a;s++){var l=t[s];var d=BX.prop.getString(l,"title","");var h=BX.prop.getString(l,"textValue","");if(d!==""&&h!==""){o.push(d+": "+h)}}if(o.length>0){r.appendChild(BX.create("div",{props:{className:"crm-entity-widget-client-requisites-value"},text:o.join(", ")}))}else{BX.addClass(n,"crm-entity-widget-client-requisites-empty-value");r.appendChild(document.createTextNode(this.getMessage("stub")))}},renderRequisites:function(){BX.cleanNode(this._requisiteTitleWrapper);BX.cleanNode(this._requisiteWrapper);this._nextButton.style.display=this._requisiteInfo.getItemCount()>1?"":"none";if(this._requisite){var t=BX.prop.getObject(this._requisite,"viewData",{});var e=BX.prop.getArray(t,"fields",[]);var i=[];var n=[];for(var r=0,o=e.length;r<o;r++){var s=e[r];var a=BX.prop.getString(s,"name","");if(a==="RQ_ADDR"){i.push(s)}else{n.push(s)}}this._requisiteTitleWrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-client-requisites-info-title"},text:BX.prop.getString(t,"title","")}));this.renderTitleFields(i,this._requisiteTitleWrapper);this.renderContentFields(n,"",this._requisiteWrapper);this.renderBankDetails()}},renderBankDetails:function(){BX.cleanNode(this._bankDetailWrapper);if(this._bankDetailList&&this._bankDetail){var t=BX.prop.getObject(this._bankDetail,"viewData",{});this.renderContentFields(BX.prop.getArray(t,"fields",[]),BX.prop.getString(t,"title",""),this._bankDetailWrapper);var e=this._bankDetailList.getItemCount();if(e>1){var i=BX.create("div",{props:{className:"crm-entity-widget-client-requisites-control-box"}});this._bankDetailWrapper.appendChild(i);i.appendChild(BX.create("div",{props:{className:"crm-entity-widget-client-requisites-control-value"},text:this.getMessage("legend").replace(/#NUMBER#/gi,this._bankDetailList.getItemIndex(this._bankDetail)+1).toString().replace(/#TOTAL#/gi,e.toString())}));i.appendChild(BX.create("div",{props:{className:"crm-entity-widget-client-requisites-control-btn"},html:this.getMessage("next")+"&rarr;",events:{click:BX.delegate(this.onNextBankDetailButtonClick,this)}}))}}},getSelectedItemId:function(){return this._requisite?BX.CrmEntityRequisiteInfo.resolveItemId(this._requisite):0},getSelectedBankDetailId:function(){return this._bankDetail?BX.CrmEntityBankDetailList.resolveItemId(this._bankDetail):0},showNextItem:function(){if(!(this._requisiteInfo&&this._requisite)){return}var t=this._requisiteInfo.getItemCount();if(t===0){return}var e=this._requisiteInfo.getItemIndex(this._requisite);if(e<0){e=0}e++;if(e===t){e=0}this._requisite=this._requisiteInfo.getItemByIndex(e);if(this._requisite){var i=BX.CrmEntityRequisiteInfo.resolveItemId(this._requisite);this._bankDetailList=this._requisiteInfo.getItemBankDetailList(i);if(this._bankDetailList){this._bankDetail=this._bankDetailList.getSelectedItem();if(!this._bankDetail){this._bankDetail=this._bankDetailList.getFirstItem()}}}this.renderRequisites()},showNextBankDetail:function(){if(!(this._bankDetailList&&this._bankDetail)){return}var t=this._bankDetailList.getItemCount();if(t===0){return}var e=this._bankDetailList.getItemIndex(this._bankDetail);if(e<0){e=0}e++;if(e===t){e=0}this._bankDetail=this._bankDetailList.getItemByIndex(e);this.renderBankDetails()},onPopupShow:function(){this._isOpened=true},onPopupClose:function(){if(this._popup){this._popup.destroy()}this._closingNotifier.notify([{requisiteId:this.getSelectedItemId(),bankDetailId:this.getSelectedBankDetailId()}])},onPopupDestroy:function(){this._isOpened=false;this._wrapper=null;this._innerWrapper=null;this._popup=null},onNextButtonClick:function(t){this.showNextItem()},onNextBankDetailButtonClick:function(t){this.showNextBankDetail()}};BX.Crm.RequisiteNavigator.options={};if(typeof BX.Crm.RequisiteNavigator.messages==="undefined"){BX.Crm.RequisiteNavigator.messages={}}BX.Crm.RequisiteNavigator.create=function(t,e){var i=new BX.Crm.RequisiteNavigator;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorFileStorage==="undefined"){BX.Crm.EntityEditorFileStorage=function(){BX.Crm.EntityEditorFileStorage.superclass.constructor.apply(this);this._uploaderName="entity_editor_storage_"+this._id.toLowerCase();this._dataContainer=null;this._uploaderContainer=null};BX.extend(BX.Crm.EntityEditorFileStorage,BX.Crm.EntityEditorField);BX.Crm.EntityEditorFileStorage.prototype.getStorageTypeId=function(){return this._model.getIntegerField("STORAGE_TYPE_ID",BX.Crm.EditorFileStorageType.undefined)};BX.Crm.EntityEditorFileStorage.prototype.getStorageElementInfos=function(){var t=this.getStorageTypeId();if(t===BX.Crm.EditorFileStorageType.diskfile){return this._model.getArrayField(this._schemeElement.getDataStringParam("diskFileInfo","DISK_FILES"),[])}return[]};BX.Crm.EntityEditorFileStorage.prototype.hasContentToDisplay=function(){return this.getStorageElementInfos().length>0};BX.Crm.EntityEditorFileStorage.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated({classNames:["crm-entity-widget-content-block-field-filestorage"]});this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}this._wrapper.appendChild(this.createTitleNode(this.getTitle()));if(this._mode===BX.Crm.EntityEditorMode.edit){this._dataContainer=BX.create("DIV",{});this._wrapper.appendChild(this._dataContainer)}this._uploaderContainer=BX.create("DIV",{attrs:{className:"bx-crm-dialog-activity-webdav-container"}});this._wrapper.appendChild(this._uploaderContainer);var e=this.getStorageTypeId();if(e===BX.Crm.EditorFileStorageType.diskfile){var i=this.prepareDiskUploader();i.setMode(this._mode);i.clearValues();i.setValues(this.getStorageElementInfos());i.layout(this._uploaderContainer)}if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorFileStorage.prototype.doClearLayout=function(t){this._dataContainer=this._uploaderContainer=null};BX.Crm.EntityEditorFileStorage.prototype.prepareDiskUploader=function(){var t=null;if(typeof BX.CrmDiskUploader!=="undefined"&&typeof BX.CrmDiskUploader.items[this._uploaderName]!=="undefined"){t=BX.CrmDiskUploader.items[this._uploaderName]}if(t){t.cleanLayout()}else{t=BX.CrmDiskUploader.create(this._uploaderName,{msg:{diskAttachFiles:this.getMessage("diskAttachFiles"),diskAttachedFiles:this.getMessage("diskAttachedFiles"),diskSelectFile:this.getMessage("diskSelectFile"),diskSelectFileLegend:this.getMessage("diskSelectFileLegend"),diskUploadFile:this.getMessage("diskUploadFile"),diskUploadFileLegend:this.getMessage("diskUploadFileLegend")}})}return t};BX.Crm.EntityEditorFileStorage.prototype.getDiskUploaderValues=function(){var t=BX.CrmDiskUploader.items[this._uploaderName];return t?t.getFileIds():[]};BX.Crm.EntityEditorFileStorage.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorFileStorage.messages;return e.hasOwnProperty(t)?e[t]:BX.Crm.EntityEditorFileStorage.superclass.getMessage.apply(this,arguments)};BX.Crm.EntityEditorFileStorage.prototype.save=function(){var t=this.getStorageTypeId();if(t===BX.Crm.EditorFileStorageType.diskfile){this._model.setField(this._schemeElement.getDataStringParam("storageElementIds","STORAGE_ELEMENT_IDS"),this.getDiskUploaderValues())}};BX.Crm.EntityEditorFileStorage.prototype.onBeforeSubmit=function(){if(!this._dataContainer){return}BX.cleanNode(this._dataContainer,false);this._dataContainer.appendChild(BX.create("INPUT",{attrs:{type:"hidden",name:this._schemeElement.getDataStringParam("storageTypeId","STORAGE_TYPE_ID"),value:this.getStorageTypeId()}}));var t=this._schemeElement.getDataStringParam("storageElementIds","STORAGE_ELEMENT_IDS");var e=this._model.getArrayField(t,[]);if(e.length>0){for(var i=0,n=e.length;i<n;i++){this._dataContainer.appendChild(BX.create("INPUT",{attrs:{type:"hidden",name:t+"[]",value:e[i]}}))}}else{this._dataContainer.appendChild(BX.create("INPUT",{attrs:{type:"hidden",name:t,value:""}}))}};if(typeof BX.Crm.EntityEditorFileStorage.messages==="undefined"){BX.Crm.EntityEditorFileStorage.messages={}}BX.Crm.EntityEditorFileStorage.create=function(t,e){var i=new BX.Crm.EntityEditorFileStorage;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorCustom==="undefined"){BX.Crm.EntityEditorCustom=function(){BX.Crm.EntityEditorCustom.superclass.constructor.apply(this);this._innerWrapper=null;this._runtimeValue=null};BX.extend(BX.Crm.EntityEditorCustom,BX.Crm.EntityEditorField);BX.Crm.EntityEditorCustom.prototype.hasContentToDisplay=function(){return this.getHtmlContent()!==""};BX.Crm.EntityEditorCustom.prototype.doClearLayout=function(t){this.setRuntimeValue(this.getValue())};BX.Crm.EntityEditorCustom.prototype.getModeSwitchType=function(t){var e=BX.Crm.EntityEditorModeSwitchType.common;if(t===BX.Crm.EntityEditorMode.edit){e|=BX.Crm.EntityEditorModeSwitchType.button|BX.Crm.EntityEditorModeSwitchType.content}return e};BX.Crm.EntityEditorCustom.prototype.layout=function(t){if(this._hasLayout){return}var e=this._schemeElement.getDataArrayParam("classNames",[]);e.push("crm-entity-widget-content-block-field-custom");this.ensureWrapperCreated({classNames:e});this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}this._wrapper.appendChild(this.createTitleNode(this.getTitle()));this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"}});this._wrapper.appendChild(this._innerWrapper);if(this._mode===BX.Crm.EntityEditorMode.edit){BX.addClass(this._innerWrapper,"crm-entity-widget-content-block-inner-edit-mode")}var i=this.getHtmlContent();if(this._mode!==BX.Crm.EntityEditorMode.edit&&!BX.type.isNotEmptyString(i)){i=this._model.getSchemeField(this._schemeElement,"empty","")}setTimeout(BX.delegate(function(){BX.html(this._innerWrapper,i);if(this._mode===BX.Crm.EntityEditorMode.edit){BX.bindDelegate(this._innerWrapper,"bxchange",{tag:["input","select","textarea"]},this._changeHandler)}},this),0);if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorCustom.prototype.getContentWrapper=function(){return this._innerWrapper};BX.Crm.EntityEditorCustom.prototype.processModelChange=function(t){if(BX.prop.get(t,"originator",null)===this){return}if(!BX.prop.getBoolean(t,"forAll",false)&&BX.prop.getString(t,"name","")!==this.getName()){return}this.refreshLayout()};BX.Crm.EntityEditorCustom.prototype.getHtmlContent=function(){return this._model.getSchemeField(this._schemeElement,this.isInEditMode()?"edit":"view","")};BX.Crm.EntityEditorCustom.prototype.setRuntimeValue=function(t){this._runtimeValue=t};BX.Crm.EntityEditorCustom.prototype.getRuntimeValue=function(){return this._mode===BX.Crm.EntityEditorMode.edit?this._runtimeValue:""};BX.Crm.EntityEditorCustom.create=function(t,e){var i=new BX.Crm.EntityEditorCustom;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorHidden==="undefined"){BX.Crm.EntityEditorHidden=function(){BX.Crm.EntityEditorHidden.superclass.constructor.apply(this);this._input=null;this._view=null};BX.extend(BX.Crm.EntityEditorHidden,BX.Crm.EntityEditorText);BX.Crm.EntityEditorHidden.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated({classNames:["crm-entity-widget-content-block-field-text"]});this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}var e=this.getName();var i=this.getTitle();var n=this.getValue();this._input=null;this._innerWrapper=null;if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}this._wrapper.appendChild(this.createTitleNode(i));if(this.hasContentToDisplay()){if(this.getLineCount()>1){this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},html:BX.util.nl2br(BX.util.htmlspecialchars(n))})}else{this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},text:n})}}else{this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},text:this.getMessage("isEmpty")})}if(this._mode===BX.Crm.EntityEditorMode.edit){this._input=BX.create("input",{props:{id:"crm-entity-widget-content-input",name:e,type:"hidden",value:n}});this._innerWrapper.appendChild(this._input)}this._wrapper.appendChild(this._innerWrapper);if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorHidden.create=function(t,e){var i=new BX.Crm.EntityEditorHidden;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityBindingTracker==="undefined"){BX.Crm.EntityBindingTracker=function(){this._id="";this._settings={};this._boundEntityInfos=null;this._unboundEntityInfos=null};BX.Crm.EntityBindingTracker.prototype={initialize:function(){this._boundEntityInfos=[];this._unboundEntityInfos=[]},bind:function(t){if(this.findIndex(t,this._boundEntityInfos)>=0){return}var e=this.findIndex(t,this._unboundEntityInfos);if(e>=0){this._unboundEntityInfos.splice(e,1)}else{this._boundEntityInfos.push(t)}},unbind:function(t){if(this.findIndex(t,this._unboundEntityInfos)>=0){return}var e=this.findIndex(t,this._boundEntityInfos);if(e>=0){this._boundEntityInfos.splice(e,1)}else{this._unboundEntityInfos.push(t)}},getBoundEntities:function(){return this._boundEntityInfos},getUnboundEntities:function(){return this._unboundEntityInfos},isBound:function(t){return this.findIndex(t,this._boundEntityInfos)>=0},isUnbound:function(t){return this.findIndex(t,this._unboundEntityInfos)>=0},reset:function(){this._boundEntityInfos=[];this._unboundEntityInfos=[]},findIndex:function(t,e){var i=t.getId();for(var n=0,r=e.length;n<r;n++){if(i===e[n].getId()){return n}}return-1}};BX.Crm.EntityBindingTracker.create=function(){var t=new BX.Crm.EntityBindingTracker;t.initialize();return t}}if(typeof BX.Crm.ClientEditorEntitySkeleton==="undefined"){BX.Crm.ClientEditorEntitySkeleton=function(){this._id="";this._settings={};this._container=null;this._wrapper=null;this._hasLayout=false};BX.Crm.ClientEditorEntitySkeleton.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._container=BX.prop.getElementNode(this._settings,"container",null)},layout:function(){this._wrapper=BX.create("div",{props:{className:"crm-entity-widget-client-block crm-entity-widget-client-block-skeleton"},children:[BX.create("div",{props:{className:"crm-entity-widget-client-box"}})]});this._container.appendChild(this._wrapper);this._hasLayout=true},clearLayout:function(){this._wrapper=BX.remove(this._wrapper);this._hasLayout=false}};BX.Crm.ClientEditorEntitySkeleton.create=function(t,e){var i=new BX.Crm.ClientEditorEntitySkeleton;i.initialize(t,e);return i}}if(typeof BX.Crm.ClientEditorEntityPanel==="undefined"){BX.Crm.ClientEditorEntityPanel=function(){this._id="";this._settings={};this._editor=null;this._entityInfo=null;this._requisiteInfo=null;this._requisiteNavigator=null;this._mode=BX.Crm.EntityEditorMode.intermediate;this._communicationButtons=null;this._deleteButton=null;this._container=null;this._wrapper=null;this._deleteButtonHandler=BX.delegate(this.onDeleteButtonClick,this);this._requisiteChangeHandler=BX.delegate(this.onRequisiteChange,this);this._requisiteChangeNotifier=null;this._hasLayout=false};BX.Crm.ClientEditorEntityPanel.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._container=BX.prop.getElementNode(this._settings,"container",null);this._editor=BX.prop.get(this._settings,"editor");this._entityInfo=BX.prop.get(this._settings,"entityInfo",null);this._mode=BX.prop.getInteger(this._settings,"mode",0);this._isRequisiteEnabled=this._entityInfo.hasRequisites()&&BX.prop.getBoolean(this._settings,"enableRequisite",false);this._requisiteChangeNotifier=BX.CrmNotifier.create(this)},getContainer:function(){return this._container},setContainer:function(t){this._container=t},getEntity:function(){return this._entityInfo},getMode:function(){return this._mode},setMode:function(t){this._mode=t},isRequisiteEnabled:function(){return this._isRequisiteEnabled},addRequisiteChangeListener:function(t){this._requisiteChangeNotifier.addListener(t)},removeRequisiteChangeListener:function(t){this._requisiteChangeNotifier.removeListener(t)},layout:function(){var t=this._mode===BX.Crm.EntityEditorMode.view;this._wrapper=BX.create("div",{props:{className:"crm-entity-widget-client-block"}});this._container.appendChild(this._wrapper);var e=BX.create("div",{props:{className:"crm-entity-widget-client-box"}});this._wrapper.appendChild(e);if(BX.prop.getBoolean(this._settings,"enableEntityTypeCaption",false)){e.appendChild(BX.create("div",{props:{className:"crm-entity-widget-client-box-type"},text:this._entityInfo.getTypeCaption()}))}this._deleteButton=null;if(!t){this._deleteButton=BX.create("div",{props:{className:"crm-entity-widget-client-block-remove"},events:{click:this._deleteButtonHandler}});e.appendChild(this._deleteButton)}var i=BX.create("div",{props:{className:"crm-entity-widget-client-box-name-container"}});e.appendChild(i);var n=BX.create("div",{props:{className:"crm-entity-widget-client-actions-container"}});var r=this._entityInfo.getShowUrl();if(r!==""){var o=BX.create("a",{props:{className:"crm-entity-widget-client-box-name",href:this._entityInfo.getShowUrl()},text:this._entityInfo.getTitle()});if(this.isRequisiteEnabled()){BX.bind(o,"mouseover",BX.debounce(this.onMouseOver,300,this));BX.bind(o,"mouseout",BX.debounce(this.onMouseOut,300,this))}i.appendChild(BX.create("div",{props:{className:"crm-entity-widget-client-box-name-row"},children:[o,n]}))}else{var s=BX.create("span",{props:{className:"crm-entity-widget-client-box-name"},text:this._entityInfo.getTitle()});i.appendChild(BX.create("div",{props:{className:"crm-entity-widget-client-box-name-row"},children:[s,n]}))}this._communicationButtons=[];var a=["PHONE","EMAIL","IM"];for(var l=0,d=a.length;l<d;l++){var h=a[l];var p=BX.Crm.ClientEditorCommunicationButton.create(this._id+"_"+h,{entityInfo:this._entityInfo,type:h,ownerTypeId:this._editor.getOwnerTypeId(),ownerId:this._editor.getOwnerId(),container:n});p.layout();this._communicationButtons.push(p)}var u=this._entityInfo.getDescription();if(u!==""){e.appendChild(BX.create("div",{props:{className:"crm-entity-widget-client-box-position"},text:u}))}var c=this._entityInfo.getPhones();var m=this._entityInfo.getEmails();if(c.length>0||m.length>0){var y=BX.create("div",{props:{className:"crm-entity-widget-client-contact"}});e.appendChild(y);if(c.length>0){y.appendChild(BX.create("div",{props:{className:"crm-entity-widget-client-contact-item crm-entity-widget-client-contact-phone"},attrs:{"x-ms-format-detection":"none"},text:c[0]["VALUE_FORMATTED"]}))}if(m.length>0){y.appendChild(BX.create("div",{props:{className:"crm-entity-widget-client-contact-item crm-entity-widget-client-contact-email"},text:m[0]["VALUE_FORMATTED"]}))}}var g=BX.prop.getFunction(this._settings,"onLayout",null);if(g){g(this,this._wrapper)}this._hasLayout=true},clearLayout:function(){if(this._requisiteNavigator){this._requisiteNavigator.removeClosingListener(this._requisiteChangeHandler);this._requisiteNavigator.close();this._requisiteNavigator=null}this._wrapper=BX.remove(this._wrapper);this._hasLayout=false},checkOwership:function(t){return this._wrapper&&BX.isParentForNode(this._wrapper,t)},onMouseOver:function(t){if(this._requisiteHandle>0){window.clearTimeout(this._requisiteHandle);this._requisiteHandle=0}this._requisiteHandle=window.setTimeout(BX.delegate(this.openRequisiteNavigator,this),300)},onMouseOut:function(t){if(this._requisiteHandle>0){window.clearTimeout(this._requisiteHandle);this._requisiteHandle=0}},openRequisiteNavigator:function(){if(!this.isRequisiteEnabled()){return}if(this._requisiteHandle===0){return}this._requisiteHandle=0;if(!this._requisiteNavigator){if(!this._requisiteInfo){var t=BX.prop.getObject(this._settings,"requisiteBinding",{});this._requisiteInfo=BX.CrmEntityRequisiteInfo.create({requisiteId:BX.prop.getInteger(t,"REQUISITE_ID",0),bankDetailId:BX.prop.getInteger(t,"BANK_DETAIL_ID",0),data:this._entityInfo.getRequisites()})}this._requisiteNavigator=BX.Crm.RequisiteNavigator.create(this._id,{requisiteInfo:this._requisiteInfo});this._requisiteNavigator.addClosingListener(this._requisiteChangeHandler)}this._requisiteNavigator.open(this._wrapper)},closeRequisiteNavigator:function(){if(this._requisiteHandle===0){return}this._requisiteHandle=0;if(this._requisiteNavigator){this._requisiteNavigator.close()}},onDeleteButtonClick:function(t){var e=BX.prop.getFunction(this._settings,"onDelete");if(e){e(this)}},onRequisiteChange:function(t,e){var i=BX.prop.getInteger(e,"requisiteId",0);var n=BX.prop.getInteger(e,"bankDetailId",0);if(!this._requisiteInfo||this._requisiteInfo.getRequisiteId()!==i||this._requisiteInfo.getBankDetailId()!==n){this._requisiteChangeNotifier.notify([e])}}};BX.Crm.ClientEditorEntityPanel.create=function(t,e){var i=new BX.Crm.ClientEditorEntityPanel;i.initialize(t,e);return i}}if(typeof BX.Crm.ClientEditorEntityBindingPanel==="undefined"){BX.Crm.ClientEditorEntityBindingPanel=function(){this._id="";this._settings={};this._container=null;this._entityInfo=null;this._editor=null;this._mode=BX.Crm.EntityEditorMode.intermediate;this._item=null};BX.Crm.ClientEditorEntityBindingPanel.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._container=BX.prop.getElementNode(this._settings,"container",null);this._editor=BX.prop.get(this._settings,"editor");this._entityInfo=BX.prop.get(this._settings,"entityInfo",null);this._mode=BX.prop.getInteger(this._settings,"mode",0);this._item=BX.Crm.ClientEditorEntityPanel.create(this._id+"_"+this._entityInfo.getId().toString(),{editor:this._editor,entityInfo:this._entityInfo,mode:this._mode,onLayout:BX.delegate(this.onItemLayout,this),onDelete:BX.delegate(this.onItemDelete,this)})},getEntity:function(){return this._entityInfo},getContainer:function(){return this._container},setContainer:function(t){this._container=t},layout:function(){this._button=BX.create("div",{props:{className:"crm-entity-widget-client-child-link"},events:{click:BX.delegate(this.onButtonClick,this)}});this._item.setContainer(this._container);this._item.layout()},onItemLayout:function(t,e){BX.addClass(e,"crm-entity-widget-client-block-child");var i=e.firstChild;if(i){e.insertBefore(this._button,i)}else{e.appendChild(this._button)}},clearLayout:function(){this._item.clearLayout()},onItemDelete:function(t){if(this._mode!==BX.Crm.EntityEditorMode.edit){return}var e=BX.prop.getFunction(this._settings,"onChange",null);if(e){e(this,"delete")}},onButtonClick:function(t){if(this._mode!==BX.Crm.EntityEditorMode.edit){return}var e=BX.prop.getFunction(this._settings,"onChange",null);if(e){e(this,"unbind")}}};BX.Crm.ClientEditorEntityBindingPanel.create=function(t,e){var i=new BX.Crm.ClientEditorEntityBindingPanel;i.initialize(t,e);return i}}if(typeof BX.Crm.ClientEditorCommunicationButton==="undefined"){BX.Crm.ClientEditorCommunicationButton=function(){this._id="";this._settings={};this._entityInfo=null;this._type="";this._items=null;this._container=null;this._wrapper=null;this._menu=null};BX.Crm.ClientEditorCommunicationButton.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._entityInfo=BX.prop.get(this._settings,"entityInfo",null);this._type=BX.prop.getString(this._settings,"type","");this._container=BX.prop.getElementNode(this._settings,"container","");if(this._type===""){this._type="PHONE"}this._items=this._entityInfo.getMultiFieldsByType(this._type)},layout:function(){var t="";if(this._type==="EMAIL"){t="crm-entity-widget-client-action-mail"}else if(this._type==="IM"){t="crm-entity-widget-client-action-im"}else{t="crm-entity-widget-client-action-call"}if(this._items.length>0){t+=" crm-entity-widget-client-action-available"}this._wrapper=BX.create("a",{props:{className:t}});BX.bind(this._wrapper,"click",BX.delegate(this.onClick,this));this._container.appendChild(this._wrapper)},onClick:function(t){if(this._items.length===0){return BX.eventReturnFalse(t)}if(this._items.length===1){var e=this._items[0];var i=BX.prop.getString(e,"VALUE");if(i!==""){if(this._type==="PHONE"){this.addCall(i)}else if(this._type==="EMAIL"){this.addEmail(i)}else if(this._type==="IM"){this.openChat(i)}}return BX.eventReturnFalse(t)}this.toggleMenu();BX.eventReturnFalse(t)},toggleMenu:function(){if(!this._menu){var t=[];for(var e=0,i=this._items.length;e<i;e++){var n=BX.prop.getString(this._items[e],"VALUE");var r=BX.prop.getString(this._items[e],"VALUE_FORMATTED");var o=BX.prop.getString(this._items[e],"COMPLEX_NAME");var s=(o?o+": ":"")+(r?r:n);if(n!==""){t.push({id:n,text:s})}}this._menu=BX.Crm.ClientEditorMenu.create(this._id.toLowerCase()+"_menu",{anchor:this._wrapper,items:t,callback:BX.delegate(this.onMenuItemSelect,this)})}this._menu.toggle()},onMenuItemSelect:function(t,e){if(this._type==="EMAIL"){this.addEmail(e["id"])}else if(this._type==="IM"){this.openChat(e["id"])}else{this.addCall(e["id"])}this._menu.close()},addCall:function(t){if(typeof window.top["BXIM"]==="undefined"){window.alert(this.getMessage("telephonyNotSupported"));return}var e={ENTITY_TYPE_NAME:this._entityInfo.getTypeName(),ENTITY_ID:this._entityInfo.getId(),AUTO_FOLD:true};var i=BX.prop.getInteger(this._settings,"ownerTypeId",0);var n=BX.prop.getInteger(this._settings,"ownerId",0);if(i!==this._entityInfo.getTypeId()||n!==this._entityInfo.getId()){e["BINDINGS"]=[{OWNER_TYPE_NAME:BX.CrmEntityType.resolveName(i),OWNER_ID:n}]}window.top["BXIM"].phoneTo(t,e)},addEmail:function(t){BX.CrmActivityEditor.addEmail({communicationsLoaded:true,communications:[{type:"EMAIL",entityType:this._entityInfo.getTypeName(),entityId:this._entityInfo.getId(),value:t}]})},openChat:function(t){if(typeof window.top["BXIM"]==="undefined"){window.alert(this.getMessage("messagingNotSupported"));return}window.top["BXIM"].openMessengerSlider(t,{RECENT:"N",MENU:"N"})}};BX.Crm.ClientEditorCommunicationButton.prototype.getMessage=function(t){var e=BX.Crm.ClientEditorCommunicationButton.messages;return e.hasOwnProperty(t)?e[t]:t};if(typeof BX.Crm.ClientEditorCommunicationButton.messages==="undefined"){BX.Crm.ClientEditorCommunicationButton.messages={}}BX.Crm.ClientEditorCommunicationButton.create=function(t,e){var i=new BX.Crm.ClientEditorCommunicationButton;i.initialize(t,e);return i}}if(typeof BX.Crm.ClientEditorMenu==="undefined"){BX.Crm.ClientEditorMenu=function(){this._id=null;this._settings={};this._items=null;this._isOpened=false;this._popup=null};BX.Crm.ClientEditorMenu.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._items=BX.prop.getArray(this._settings,"items",[]);for(var i=0,n=this._items.length;i<n;i++){this._items[i]["onclick"]=BX.delegate(this.onItemSelect,this)}},onItemSelect:function(t,e){var i=BX.prop.getFunction(this._settings,"callback",null);if(i){i(this,e)}},isOpened:function(){return this._isOpened},open:function(){if(this._isOpened){return}BX.PopupMenu.show(this._id,BX.prop.getElementNode(this._settings,"anchor",null),this._items,{offsetTop:0,offsetLeft:0,events:{onPopupShow:BX.delegate(this.onPopupShow,this),onPopupClose:BX.delegate(this.onPopupClose,this),onPopupDestroy:BX.delegate(this.onPopupDestroy,this)}});this._popup=BX.PopupMenu.currentItem},close:function(){if(!this._isOpened){return}if(this._popup){if(this._popup.popupWindow){this._popup.popupWindow.close()}}},toggle:function(){if(!this._isOpened){this.open()}else{this.close()}},onPopupShow:function(){this._isOpened=true},onPopupClose:function(){if(this._popup&&this._popup.popupWindow){this._popup.popupWindow.destroy()}},onPopupDestroy:function(){this._isOpened=false;this._popup=null;if(typeof BX.PopupMenu.Data[this._id]!=="undefined"){delete BX.PopupMenu.Data[this._id]}}};BX.Crm.ClientEditorMenu.create=function(t,e){var i=new BX.Crm.ClientEditorMenu;i.initialize(t,e);return i}}if(typeof BX.Crm.UserFieldTypeMenu==="undefined"){BX.Crm.UserFieldTypeMenu=function(){this._id=null;this._settings={};this._items=null;this._isOpened=false;this._wrapper=null;this._innerWrapper=null;this._topScrollButton=null;this._bottomScrollButton=null;this._bottomButtonMouseOverHandler=BX.delegate(this.onBottomButtonMouseOver,this);this._bottomButtonMouseOutHandler=BX.delegate(this.onBottomButtonMouseOut,this);this._topButtonMouseOverHandler=BX.delegate(this.onTopButtonMouseOver,this);this._topButtonMouseOutHandler=BX.delegate(this.onTopButtonMouseOut,this);this._scrollHandler=BX.throttle(this.onScroll,100,this);this._enableScrollToBottom=false;this._enableScrollToTop=false;this._popup=null};BX.Crm.UserFieldTypeMenu.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._items=[];var i=BX.prop.getArray(e,"items");for(var n=0,r=i.length;n<r;n++){var o=i[n];o["menu"]=this;this._items.push(BX.Crm.UserFieldTypeMenuItem.create(BX.prop.getString(o,"value"),o))}},getId:function(){return this._id},isOpened:function(){return this._isOpened},open:function(t){if(this._isOpened){return}this._popup=new BX.PopupWindow(this._id,t,{autoHide:true,draggable:false,offsetLeft:0,offsetTop:0,noAllPaddings:true,bindOptions:{forceBindPosition:true},closeByEsc:true,events:{onPopupShow:BX.delegate(this.onPopupShow,this),onPopupClose:BX.delegate(this.onPopupClose,this),onPopupDestroy:BX.delegate(this.onPopupDestroy,this)},content:this.prepareContent()});this._popup.show()},close:function(){if(!this._isOpened){return}if(this._popup){this._popup.close()}},prepareContent:function(){this._wrapper=BX.create("div",{props:{className:"crm-entity-card-widget-create-field-popup"}});var t='<svg xmlns="http://www.w3.org/2000/svg" width="42" height="13" viewBox="0 0 42 13">\n'+'  <polyline fill="none" stroke="#CACDD1" stroke-width="2" points="274 98 284 78.614 274 59" transform="rotate(90 186 -86.5)" stroke-linecap="round" stroke-linejoin="round"/>\n'+"</svg>\n";this._topScrollButton=BX.create("div",{props:{className:"crm-entity-card-widget-popup-scroll-control-top"},html:t});this._wrapper.appendChild(this._topScrollButton);this._bottomScrollButton=BX.create("div",{props:{className:"crm-entity-card-widget-popup-scroll-control-bottom"},html:t});this._wrapper.appendChild(this._bottomScrollButton);this._innerWrapper=BX.create("div",{props:{className:"crm-entity-card-widget-create-field-list"}});this._wrapper.appendChild(this._innerWrapper);for(var e=0,i=this._items.length;e<i;e++){this._innerWrapper.appendChild(this._items[e].prepareContent())}return this._wrapper},adjust:function(){var t=this._innerWrapper.offsetHeight;var e=this._innerWrapper.scrollTop;var i=this._innerWrapper.scrollHeight;if(e===0){BX.addClass(this._topScrollButton,"control-hide")}else{BX.removeClass(this._topScrollButton,"control-hide")}if(e+t===i){BX.addClass(this._bottomScrollButton,"control-hide")}else{BX.removeClass(this._bottomScrollButton,"control-hide")}},onItemSelect:function(t){var e=BX.prop.getFunction(this._settings,"callback",null);if(e){e(this,t)}},onPopupShow:function(){this._isOpened=true;BX.bind(this._bottomScrollButton,"mouseover",this._bottomButtonMouseOverHandler);BX.bind(this._bottomScrollButton,"mouseout",this._bottomButtonMouseOutHandler);BX.bind(this._topScrollButton,"mouseover",this._topButtonMouseOverHandler);BX.bind(this._topScrollButton,"mouseout",this._topButtonMouseOutHandler);BX.bind(this._innerWrapper,"scroll",this._scrollHandler);window.setTimeout(this.adjust.bind(this),100)},onPopupClose:function(){if(this._popup){this._popup.destroy()}},onPopupDestroy:function(){this._isOpened=false;BX.unbind(this._bottomScrollButton,"mouseover",this._bottomButtonMouseOverHandler);BX.unbind(this._bottomScrollButton,"mouseout",this._bottomButtonMouseOutHandler);BX.unbind(this._topScrollButton,"mouseover",this._topButtonMouseOverHandler);BX.unbind(this._topScrollButton,"mouseout",this._topButtonMouseOutHandler);BX.unbind(this._innerWrapper,"scroll",this._scrollHandler);this._wrapper=null;this._innerWrapper=null;this._topScrollButton=null;this._bottomScrollButton=null;this._popup=null},onBottomButtonMouseOver:function(t){if(this._enableScrollToBottom){return}this._enableScrollToBottom=true;this._enableScrollToTop=false;(function t(){if(!this._enableScrollToBottom){return}var e=this._innerWrapper;if(e.scrollTop+e.offsetHeight!==e.scrollHeight){e.scrollTop+=3}if(e.scrollTop+e.offsetHeight===e.scrollHeight){this._enableScrollToBottom=false}else{window.setTimeout(t.bind(this),20)}}).bind(this)()},onBottomButtonMouseOut:function(){this._enableScrollToBottom=false},onTopButtonMouseOver:function(t){if(this._enableScrollToTop){return}this._enableScrollToBottom=false;this._enableScrollToTop=true;(function t(){if(!this._enableScrollToTop){return}var e=this._innerWrapper;if(e.scrollTop>0){e.scrollTop-=3}if(e.scrollTop===0){this._enableScrollToTop=false}else{window.setTimeout(t.bind(this),20)}}).bind(this)()},onTopButtonMouseOut:function(){this._enableScrollToTop=false},onScroll:function(t){this.adjust()}};BX.Crm.UserFieldTypeMenu.create=function(t,e){var i=new BX.Crm.UserFieldTypeMenu;i.initialize(t,e);return i}}if(typeof BX.Crm.UserFieldTypeMenuItem==="undefined"){BX.Crm.UserFieldTypeMenuItem=function(){this._id="";this._settings=null;this._menu="";this._value="";this._text="";this._legend=""};BX.Crm.UserFieldTypeMenuItem.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._menu=BX.prop.get(e,"menu");this._value=BX.prop.getString(e,"value");this._text=BX.prop.getString(e,"text");this._legend=BX.prop.getString(e,"legend")},getId:function(){return this._id},getValue:function(){return this._value},getText:function(){return this._text},getLegend:function(){return this._legend},prepareContent:function(){var t=BX.create("span",{props:{className:"crm-entity-card-widget-create-field-item"},events:{click:BX.delegate(this.onClick,this)}});t.appendChild(BX.create("span",{props:{className:"crm-entity-card-widget-create-field-item-title"},text:this._text}));t.appendChild(BX.create("span",{props:{className:"crm-entity-card-widget-create-field-item-desc"},text:this._legend}));return t},onClick:function(t){this._menu.onItemSelect(this)}};BX.Crm.UserFieldTypeMenuItem.create=function(t,e){var i=new BX.Crm.UserFieldTypeMenuItem;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorSubsection==="undefined"){BX.Crm.EntityEditorSubsection=function(){BX.Crm.EntityEditorSubsection.superclass.constructor.apply(this)};BX.extend(BX.Crm.EntityEditorSubsection,BX.Crm.EntityEditorSection);BX.Crm.EntityEditorSubsection.prototype.initialize=function(t,e){BX.Crm.EntityEditorSubsection.superclass.initialize.call(this,t,e);this.initializeFromModel()};BX.Crm.EntityEditorSubsection.prototype.ensureWrapperCreated=function(t){if(!this._wrapper){this._wrapper=BX.create("div")}return this._wrapper};BX.Crm.EntityEditorSubsection.prototype.layout=function(t){this._contentContainer=BX.create("div");var e=this._mode===BX.Crm.EntityEditorMode.view;this.ensureWrapperCreated();this.layoutTitle();this._wrapper.appendChild(this._contentContainer);for(var i=0,n=this._fields.length;i<n;i++){this.layoutChild(this._fields[i])}this._addChildButton=this._createChildButton=null;if(this.isDragEnabled()){this._dragContainerController=BX.Crm.EditorDragContainerController.create("section_"+this.getId(),{charge:BX.Crm.EditorFieldDragContainer.create({section:this,context:this._draggableContextId}),node:this._wrapper});this._dragContainerController.addDragFinishListener(this._dropHandler);this.initializeDragDropAbilities()}this._addChildButton=this._createChildButton=null;if(!e){this.createButtonPanel();this._contentContainer.appendChild(this._buttonPanelWrapper)}this._hasLayout=true;this.registerLayout(t)};BX.Crm.EntityEditorSubsection.prototype.getChildDragScope=function(){return BX.Crm.EditorDragScope.parent};BX.Crm.EntityEditorSubsection.prototype.createButtonPanel=function(){this._buttonPanelWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block"}})};BX.Crm.EntityEditorSubsection.prototype.layoutChild=function(t){t.setContainer(this._contentContainer);t.setDraggableContextId(this._draggableContextId);this.setChildVisible(t);t.releaseLayout();t.layout();if(this._mode!==BX.Crm.EntityEditorMode.view&&t.isHeading()){t.focus()}};BX.Crm.EntityEditorSubsection.prototype.setChildVisible=function(t){t.setVisible(BX.prop.getBoolean(t._schemeElement._settings,"isVisible",true))};BX.Crm.EntityEditorSubsection.prototype.isDragEnabled=function(){return false};BX.Crm.EntityEditorSubsection.prototype.layoutTitle=function(){};BX.Crm.EntityEditorSubsection.prototype.isCreationEnabled=function(){return false};BX.Crm.EntityEditorSubsection.prototype.isContextMenuEnabled=function(){return false};BX.Crm.EntityEditorSubsection.prototype.isRequired=function(){return true};BX.Crm.EntityEditorSubsection.prototype.getRuntimeValue=function(){var t=[];for(var e=0;e<this.getChildCount();e++){var i=this._fields[e].getRuntimeValue();if(BX.type.isArray(i)){for(var n in i){if(i.hasOwnProperty(n)){t[n]=i[n]}}}else{t[this._fields[e].getName()]=i}}return t};BX.Crm.EntityEditorSubsection.prototype.createDragButton=function(){if(!this._dragButton){this._dragButton=BX.create("div",{props:{className:"crm-entity-widget-content-block-draggable-btn-container"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-draggable-btn"}})]})}return this._dragButton};BX.Crm.EntityEditorSubsection.prototype.initializeDragDropAbilities=function(){if(this._dragItem){return}this._dragItem=BX.Crm.EditorDragItemController.create("field_"+this.getId(),{charge:BX.Crm.EditorFieldDragItem.create({control:this,contextId:this._draggableContextId,scope:this.getDragScope()}),node:this.createDragButton(),showControlInDragMode:false,ghostOffset:{x:0,y:0}})};BX.Crm.EntityEditorSubsection.prototype.processChildControlChange=function(t,e){if(this._isChanged){return}this.markAsChanged(e)};BX.Crm.EntityEditorSubsection.create=function(t,e){var i=new BX.Crm.EntityEditorSubsection;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorRecurring==="undefined"){BX.Crm.EntityEditorRecurring=function(){BX.Crm.EntityEditorRecurring.superclass.constructor.apply(this)};BX.extend(BX.Crm.EntityEditorRecurring,BX.Crm.EntityEditorSubsection);BX.Crm.EntityEditorRecurring.prototype.initialize=function(t,e){BX.Crm.EntityEditorRecurring.superclass.initialize.call(this,t,e);var i=this._schemeElement.getData();this._schemeFieldData=BX.prop.getObject(i,"fieldData",{});this._enableRecurring=BX.prop.getBoolean(this._schemeElement._settings,"enableRecurring",true);this._recurringModel=this._model.getField(this.getName())};BX.Crm.EntityEditorRecurring.prototype.initializeFromModel=function(){BX.Crm.EntityEditorRecurring.superclass.initializeFromModel.call(this);var t=this;for(var e=0,i=this._fields.length;e<i;e++){this._fields[e].getValue=function(e){if(!BX.type.isNotEmptyString(e)){e=this.getName()}return t.getRecurringFieldValue(e)}}};BX.Crm.EntityEditorRecurring.prototype.getRecurringModel=function(){var t=this.getParent();if(t instanceof BX.Crm.EntityEditorRecurring){return t.getRecurringModel()}return this._recurringModel};BX.Crm.EntityEditorRecurring.prototype.isContextMenuEnabled=function(){return BX.Crm.EntityEditorSubsection.superclass.isContextMenuEnabled.call(this)};BX.Crm.EntityEditorRecurring.prototype.isNeedToDisplay=function(){return false};BX.Crm.EntityEditorRecurring.prototype.isRequired=function(){return this._schemeElement&&this._schemeElement.isRequired()};BX.Crm.EntityEditorRecurring.prototype.prepareContextMenuItems=function(){var t=[];t.push({value:"hide",text:this.getMessage("hide")});return t};BX.Crm.EntityEditorRecurring.prototype.processContextMenuCommand=function(t,e){if(e==="hide"){window.setTimeout(BX.delegate(this.hide,this),500)}else if(this._parent&&this._parent.hasAdditionalMenu()){this._parent.processChildAdditionalMenuCommand(this,e)}this.closeContextMenu()};BX.Crm.EntityEditorRecurring.prototype.isDragEnabled=function(){return BX.Crm.EntityEditorSubsection.superclass.isDragEnabled.call(this)};BX.Crm.EntityEditorRecurring.prototype.getDragObjectType=function(){return BX.Crm.EditorDragObjectType.field};BX.Crm.EntityEditorRecurring.prototype.hasContentToDisplay=function(){return true};BX.Crm.EntityEditorRecurring.prototype.getRecurringMode=function(){var t=this.getParent();if(t instanceof BX.Crm.EntityEditorRecurring){return t.getRecurringMode()}return this.getRecurringFieldValue("RECURRING[MODE]")};BX.Crm.EntityEditorRecurring.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorRecurring.messages;return e.hasOwnProperty(t)?e[t]:t};BX.Crm.EntityEditorRecurring.prototype.processChildControlChange=function(t,e){var i=t.getName();var n=false;var r=t.getValue();var o=t.getRuntimeValue();if(r!==o){switch(i){case"RECURRING[MODE]":case"RECURRING[MULTIPLE_TYPE_LIMIT]":case"RECURRING[BEGINDATE_TYPE]":case"RECURRING[CLOSEDATE_TYPE]":n=true;break;case"RECURRING[MULTIPLE_TYPE]":if(r===this.getSchemeFieldValue("MULTIPLE_CUSTOM")||o===this.getSchemeFieldValue("MULTIPLE_CUSTOM")){n=true}}}var s=this.getRecurringModel();this.setChangedValue(i,o,s);BX.Crm.EntityEditorRecurring.superclass.processChildControlChange.call(this,t,e);if(n){this.refreshLayout()}};BX.Crm.EntityEditorRecurring.prototype.setChangedValue=function(t,e,i){if(typeof e==="object"){for(var n in e){if(e.hasOwnProperty(n)){this.setChangedValue(n,e[n],i)}}}else{i[t]=e}};BX.Crm.EntityEditorRecurring.prototype.layout=function(t){this._contentContainer=BX.create("div");if(this.isMainSubsection()){this._contentContainer.classList.add("crm-entity-widget-content")}var e=this._mode===BX.Crm.EntityEditorMode.view;this.ensureWrapperCreated();this.layoutTitle();this._wrapper.appendChild(this._contentContainer);if(e){var i=BX.create("div",{props:{className:"crm-entity-widget-content-block crm-entity-widget-content-block-click-editable"},children:[this.createTitleNode(this.getTitle())]});this._contentContainer.appendChild(i);var n=BX.create("div");var r=this._schemeElement.getData();if(this._schemeElement._promise instanceof BX.Promise){this.loadViewText();this._schemeElement._promise.then(BX.proxy(function(){n.classList="crm-entity-widget-content-block-inner";n.innerHTML=BX.util.htmlspecialchars(r.view.text);i.innerHTML="";i.appendChild(n);this._schemeElement._promise=null},this))}else if(BX.type.isNotEmptyString(r.view.text)){n.classList="crm-entity-widget-content-block-inner";n.innerHTML=r.view.text;i.appendChild(n)}if(this._enableRecurring){BX.bind(n,"click",BX.delegate(this.toggle,this))}if(this.isContextMenuEnabled()){i.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){i.appendChild(this.createDragButton());this.initializeDragDropAbilities()}}else if(!this._enableRecurring){var i=BX.create("div",{props:{className:"crm-entity-widget-content-block"},children:[this.createTitleNode(this.getMessage("modeTitle"))]});var o=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{type:"text",props:{className:"crm-entity-widget-content-input",disabled:"disabled"},text:this.getMessage("notRepeat"),events:{click:BX.delegate(this.showLicencePopup,this)}})]});i.appendChild(o);var s=BX.create("button",{props:{className:"crm-entity-widget-content-block-locked-icon"},events:{click:BX.delegate(this.showLicencePopup,this)}});i.appendChild(s);this._contentContainer.appendChild(i)}else{for(var a=0,l=this._fields.length;a<l;a++){this._fields[a].isDragEnabled=function(){return false};this.layoutChild(this._fields[a])}}this._addChildButton=this._createChildButton=null;this._hasLayout=true;this.registerLayout(t)};BX.Crm.EntityEditorRecurring.prototype.createTitleNode=function(t){var e=BX.create("div",{attrs:{className:"crm-entity-widget-content-block-title"},children:[BX.create("span",{attrs:{className:"crm-entity-widget-content-block-title-text"},text:t})]});return e};BX.Crm.EntityEditorRecurring.prototype.setChildVisible=function(t){var e=false;var i=t.getName();var n=this.getRecurringMode();if(i==="RECURRING[MODE]"){e=true}else if(n===this.getSchemeFieldValue("SINGLE_EXECUTION")){switch(i){case"SINGLE_PARAMS":case"RECURRING[BEGINDATE_TYPE]":case"RECURRING[CLOSEDATE_TYPE]":case"SUBTITLE_NEW_ORDER_PARAMS":case"NEW_BEGINDATE":case"NEW_CLOSEDATE":case"RECURRING[CATEGORY_ID]":e=true;break;case"OFFSET_BEGINDATE":if(this.getRecurringFieldValue("RECURRING[BEGINDATE_TYPE]")===this.getSchemeFieldValue("CALCULATED_FIELD_VALUE")){e=true}break;case"OFFSET_CLOSEDATE":if(this.getRecurringFieldValue("RECURRING[CLOSEDATE_TYPE]")===this.getSchemeFieldValue("CALCULATED_FIELD_VALUE")){e=true}break}}else if(n===this.getSchemeFieldValue("MULTIPLE_EXECUTION")){switch(i){case"MULTIPLE_PARAMS":case"RECURRING[MULTIPLE_TYPE]":case"RECURRING[CATEGORY_ID]":case"RECURRING[MULTIPLE_DATE_START]":case"MULTIPLE_LIMIT":case"RECURRING[MULTIPLE_TYPE_LIMIT]":case"SUBTITLE_NEW_ORDER_PARAMS":case"NEW_BEGINDATE":case"NEW_CLOSEDATE":case"RECURRING[BEGINDATE_TYPE]":case"RECURRING[CLOSEDATE_TYPE]":e=true;break;case"MULTIPLE_CUSTOM":if(this.getRecurringFieldValue("RECURRING[MULTIPLE_TYPE]")===this.getSchemeFieldValue("MULTIPLE_CUSTOM")){e=true}break;case"RECURRING[MULTIPLE_DATE_LIMIT]":if(this.getRecurringFieldValue("RECURRING[MULTIPLE_TYPE_LIMIT]")===this.getSchemeFieldValue("LIMITED_BY_DATE")){e=true}break;case"RECURRING[MULTIPLE_TIMES_LIMIT]":if(this.getRecurringFieldValue("RECURRING[MULTIPLE_TYPE_LIMIT]")===this.getSchemeFieldValue("LIMITED_BY_TIMES")){e=true}break;case"OFFSET_BEGINDATE":if(this.getRecurringFieldValue("RECURRING[BEGINDATE_TYPE]")===this.getSchemeFieldValue("CALCULATED_FIELD_VALUE")){e=true}break;case"OFFSET_CLOSEDATE":if(this.getRecurringFieldValue("RECURRING[CLOSEDATE_TYPE]")===this.getSchemeFieldValue("CALCULATED_FIELD_VALUE")){e=true}break}}t.setVisible(e)};BX.Crm.EntityEditorRecurring.prototype.getRecurringFieldValue=function(t){return BX.prop.get(this.getRecurringModel(),t)};BX.Crm.EntityEditorRecurring.prototype.getSchemeFieldValue=function(t){return BX.prop.get(this._schemeFieldData,t,"")};BX.Crm.EntityEditorRecurring.prototype.isMainSubsection=function(){return!(this.getParent()instanceof BX.Crm.EntityEditorRecurring)};BX.Crm.EntityEditorRecurring.prototype.onBeforeSubmit=function(){if(this.isMainSubsection()){this._wrapper.appendChild(BX.create("input",{props:{type:"hidden",name:"IS_RECURRING",value:this._model.getStringField("IS_RECURRING")==="Y"?"Y":"N"}}))}};BX.Crm.EntityEditorRecurring.prototype.save=function(){if(this.isMainSubsection()){this._schemeElement._promise=new BX.Promise}};BX.Crm.EntityEditorRecurring.prototype.loadViewText=function(){var t=this._schemeElement.getData();if(BX.type.isPlainObject(t.loaders)&&BX.type.isNotEmptyString(t.loaders["url"])&&BX.type.isNotEmptyString(t.loaders["action"])){BX.ajax({url:t.loaders["url"],method:"POST",dataType:"json",data:{ACTION:t.loaders["action"],PARAMS:{ID:this._model.getField("ID")}},onsuccess:BX.delegate(this.onEntityHintLoad,this)})}};BX.Crm.EntityEditorRecurring.prototype.onEntityHintLoad=function(t){var e=BX.prop.getObject(t,"DATA",null);if(!e){return}if(BX.type.isNotEmptyString(e.HINT)){this._schemeElement._data.view.text=e.HINT}if(this._schemeElement._promise instanceof BX.Promise){this._schemeElement._promise.fulfill();this._schemeElement._promise=null}};BX.Crm.EntityEditorRecurring.prototype.showLicencePopup=function(e){e.preventDefault();if(!B24||!B24["licenseInfoPopup"]){return}var layoutData=this._schemeElement.getData();var restrictionScript=layoutData.restrictScript;if(BX.type.isNotEmptyString(restrictionScript)){eval(restrictionScript)}};BX.Crm.EntityEditorRecurring.create=function(t,e){var i=new BX.Crm.EntityEditorRecurring;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorRecurringCustomRowField==="undefined"){BX.Crm.EntityEditorRecurringCustomRowField=function(){BX.Crm.EntityEditorRecurringCustomRowField.superclass.constructor.apply(this);this._amountInput=null;this._selectInput=null;this._sumElement=null;this._selectContainer=null;this._inputWrapper=null;this._innerWrapper=null;this._selectedValue="";this._selectClickHandler=BX.delegate(this.onSelectorClick,this);this._isMesureMenuOpened=false};BX.extend(BX.Crm.EntityEditorRecurringCustomRowField,BX.Crm.EntityEditorField);BX.Crm.EntityEditorRecurringCustomRowField.prototype.getModeSwitchType=function(t){var e=BX.Crm.EntityEditorModeSwitchType.common;if(t===BX.Crm.EntityEditorMode.edit){e|=BX.Crm.EntityEditorModeSwitchType.button|BX.Crm.EntityEditorModeSwitchType.content}return e};BX.Crm.EntityEditorRecurringCustomRowField.prototype.getContentWrapper=function(){return this._innerWrapper};BX.Crm.EntityEditorRecurringCustomRowField.prototype.focus=function(){if(this._amountInput){BX.focus(this._amountInput);BX.Crm.EditorTextHelper.getCurrent().selectAll(this._amountInput)}};BX.Crm.EntityEditorRecurringCustomRowField.prototype.getValue=function(t){if(!this._model){return""}return this._model.getStringField(this.getAmountFieldName(),t!==undefined?t:"")};BX.Crm.EntityEditorRecurringCustomRowField.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated({classNames:["crm-entity-widget-content-block-field-recurring-custom"]});this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}var e=this.getTitle();var i=this.getData();var n=this.getSelectFieldName();this._selectedValue=this.getValue(n);var r=BX.prop.getArray(BX.prop.getObject(i,"select"),"items");var o="";if(!this._selectedValue){var s=r.length>0?r[0]:null;if(s){this._selectedValue=s["VALUE"];o=s["NAME"]}}else{o=this._editor.findOption(this._selectedValue,r)}var a=this.getAmountFieldName();var l=this.getValue(a);this._amountInput=null;this._selectInput=null;this._selectContainer=null;this._innerWrapper=null;this._sumElement=null;if(this._mode===BX.Crm.EntityEditorMode.edit){this._wrapper.appendChild(this.createTitleNode(e));this._amountInput=BX.create("input",{attrs:{className:"crm-entity-widget-content-input",name:a,type:"text",value:l}});BX.bind(this._amountInput,"input",this._changeHandler);this._selectInput=BX.create("input",{attrs:{name:n,type:"hidden",value:this._selectedValue}});this._selectContainer=BX.create("div",{props:{className:"crm-entity-widget-content-select"},text:o});BX.bind(this._selectContainer,"click",this._selectClickHandler);this._inputWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-input-wrapper"},children:[this._amountInput,this._selectInput,BX.create("div",{props:{className:"crm-entity-widget-content-block-select"},children:[this._selectContainer]})]});this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner crm-entity-widget-content-block-colums-input"},children:[this._inputWrapper]})}this._wrapper.appendChild(this._innerWrapper);this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorRecurringCustomRowField.prototype.doClearLayout=function(t){BX.PopupMenu.destroy(this._id);this._amountInput=null;this._selectInput=null;this._sumElement=null;this._selectContainer=null;this._inputWrapper=null;this._innerWrapper=null};BX.Crm.EntityEditorRecurringCustomRowField.prototype.getAmountFieldName=function(){return this._schemeElement.getDataStringParam("amount","")};BX.Crm.EntityEditorRecurringCustomRowField.prototype.getSelectFieldName=function(){return BX.prop.getString(this._schemeElement.getDataObjectParam("select",{}),"name","")};BX.Crm.EntityEditorRecurringCustomRowField.prototype.onSelectorClick=function(t){this.openListMenu()};BX.Crm.EntityEditorRecurringCustomRowField.prototype.openListMenu=function(){if(this._isListMenuOpened){return}var t=this._schemeElement.getData();var e=BX.prop.getArray(BX.prop.getObject(t,"select"),"items");var i=0;var n=[];while(i<e.length){n.push({text:e[i]["NAME"],value:e[i]["VALUE"],onclick:BX.delegate(this.onSelectItem,this)});i++}BX.PopupMenu.show(this._id,this._selectContainer,n,{angle:false,width:this._selectContainer.offsetWidth+"px",events:{onPopupShow:BX.delegate(this.onListMenuOpen,this),onPopupClose:BX.delegate(this.onListMenuClose,this)}});BX.PopupMenu.currentItem.popupWindow.setWidth(BX.pos(this._selectContainer)["width"])};BX.Crm.EntityEditorRecurringCustomRowField.prototype.closeListMenu=function(){if(!this._isListMenuOpened){return}var t=BX.PopupMenu.getMenuById(this._id);if(t){t.popupWindow.close()}};BX.Crm.EntityEditorRecurringCustomRowField.prototype.onListMenuOpen=function(){BX.addClass(this._selectContainer,"active");this._isListMenuOpened=true};BX.Crm.EntityEditorRecurringCustomRowField.prototype.onListMenuClose=function(){BX.PopupMenu.destroy(this._id);BX.removeClass(this._selectContainer,"active");this._isListMenuOpened=false};BX.Crm.EntityEditorRecurringCustomRowField.prototype.onSelectItem=function(t,e){this.closeListMenu();this._selectedValue=this._selectInput.value=e.value;this._selectContainer.innerHTML=BX.util.htmlspecialchars(e.text);this.markAsChanged({fieldName:this.getSelectFieldName(),fieldValue:this._selectedValue})};BX.Crm.EntityEditorRecurringCustomRowField.prototype.getRuntimeValue=function(){var t=[];if(this._mode===BX.Crm.EntityEditorMode.edit){if(this._amountInput){t[this.getAmountFieldName()]=this._amountInput.value}t[this.getSelectFieldName()]=this._selectedValue;return t}return""};BX.Crm.EntityEditorRecurringCustomRowField.prototype.save=function(){this._model.setField(this.getSelectFieldName(),this._selectedValue);if(this._amountInput){this._model.setField(this.getAmountFieldName(),this._amountInput.value)}};BX.Crm.EntityEditorRecurringCustomRowField.create=function(t,e){var i=new BX.Crm.EntityEditorRecurringCustomRowField;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorRecurringSingleField==="undefined"){BX.Crm.EntityEditorRecurringSingleField=function(){BX.Crm.EntityEditorRecurringSingleField.superclass.constructor.apply(this);this._dateInput=null};BX.extend(BX.Crm.EntityEditorRecurringSingleField,BX.Crm.EntityEditorRecurringCustomRowField);BX.Crm.EntityEditorRecurringSingleField.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated({classNames:["crm-entity-widget-content-block-field-recurring-single"]});this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}var e=this.getTitle();var i=this.getData();var n=this.getAmountFieldName();var r=this.getValue(n);var o=this.getSelectFieldName();this._selectedValue=this.getValue(o);var s=this.getDateFieldName();this._dateValue=this.getValue(s);var a=BX.prop.getArray(BX.prop.getObject(i,"select"),"items");var l="";if(!this._selectedValue){var d=a.length>0?a[0]:null;if(d){this._selectedValue=d["VALUE"];l=d["NAME"]}}else{l=this._editor.findOption(this._selectedValue,a)}this._amountInput=null;this._selectInput=null;this._selectContainer=null;this._innerWrapper=null;this._sumElement=null;if(this._mode===BX.Crm.EntityEditorMode.edit){this._wrapper.appendChild(this.createTitleNode(e));this._amountInput=BX.create("input",{attrs:{className:"crm-entity-widget-content-input",name:n,type:"text",value:r}});BX.bind(this._amountInput,"input",this._changeHandler);this._selectInput=BX.create("input",{attrs:{name:o,type:"hidden",value:this._selectedValue}});this._selectContainer=BX.create("div",{props:{className:"crm-entity-widget-content-select"},text:l});this._dateInput=BX.create("input",{style:{display:"inline-block"},props:{name:s,className:"crm-entity-widget-content-input crm-entity-widget-content-input-date",value:this._dateValue},events:{click:function(){BX.calendar({node:this,field:this,bTime:false})},change:BX.delegate(function(t){this.markAsChanged()},this)}});BX.bind(this._selectContainer,"click",this._selectClickHandler);this._inputWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-input-wrapper"},children:[this._amountInput,this._selectInput,BX.create("div",{props:{className:"crm-entity-widget-content-block-select"},children:[this._selectContainer]}),BX.create("span",{text:this.getMessage("until")}),this._dateInput]});this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner crm-entity-widget-content-block-colums-input"},children:[this._inputWrapper]})}this._wrapper.appendChild(this._innerWrapper);this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorRecurringCustomRowField.prototype.getDateFieldName=function(){return this._schemeElement.getDataStringParam("date","")};BX.Crm.EntityEditorRecurringSingleField.prototype.getRuntimeValue=function(){var t=[];if(this._mode===BX.Crm.EntityEditorMode.edit){if(this._amountInput){t[this.getAmountFieldName()]=this._amountInput.value}t[this.getSelectFieldName()]=this._selectedValue;t[this.getDateFieldName()]=this._dateInput.value;return t}return""};BX.Crm.EntityEditorRecurringSingleField.prototype.save=function(){var t=this._schemeElement.getData();this._model.setField(BX.prop.getString(BX.prop.getObject(t,"select"),"name"),this._selectedValue);if(this._amountInput){this._model.setField(BX.prop.getString(t,"amount"),this._amountInput.value)}if(this._dateInput){this._model.setField(BX.prop.getString(t,"date"),this._dateInput.value)}};BX.Crm.EntityEditorRecurringSingleField.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorRecurringSingleField.messages;return e.hasOwnProperty(t)?e[t]:t};BX.Crm.EntityEditorRecurringSingleField.create=function(t,e){var i=new BX.Crm.EntityEditorRecurringSingleField;i.initialize(t,e);return i}}if(typeof BX.Crm.EditorFieldSingleEditController==="undefined"){BX.Crm.EditorFieldSingleEditController=function(){this._id="";this._settings=null;this._field=null;this._wrapper=null;this._fieldWrapperHandler=BX.delegate(this.onFieldWrapperClick,this);this._documentHandler=BX.delegate(this.onDocumentClick,this);this._documentTimeoutHandle=0;this._isInitialized=false;this._isActive=false};BX.Crm.EditorFieldSingleEditController.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._time=(new Date).toString();this._field=BX.prop.get(this._settings,"field");if(!(this._field instanceof BX.Crm.EntityEditorField)){throw"EditorFieldSingleEditController: The 'field' param must be EntityEditorField."}this._wrapper=this._field.getWrapper();if(!BX.type.isElementNode(this._wrapper)){throw"EditorFieldSingleEditController: Could not find the wrapper element."}window.setTimeout(BX.delegate(this.bind,this),100);this._isActive=this._isInitialized=true},isActive:function(){return this._isActive},setActive:function(t){this._isActive=!!t},setActiveDelayed:function(t,e){if(typeof e==="undefined"){e=0}window.setTimeout(BX.delegate(function(){this.setActive(t)},this),e)},release:function(){this._isActive=this._isInitialized=false;this.unbind()},bind:function(){if(this._isInitialized){BX.bind(this._wrapper,"click",this._fieldWrapperHandler);BX.bind(document,"click",this._documentHandler)}},unbind:function(){BX.unbind(this._wrapper,"click",this._fieldWrapperHandler);BX.unbind(document,"click",this._documentHandler)},saveControl:function(){if(!this._isActive){return}var t=this._field.getEditor();if(t){t.switchControlMode(this._field,BX.Crm.EntityEditorMode.view,BX.Crm.EntityEditorModeOptions.none)}this._isActive=false},onFieldWrapperClick:function(t){BX.eventCancelBubble(t)},onDocumentClick:function(t){if(this._documentTimeoutHandle>0){window.clearTimeout(this._documentTimeoutHandle);this._documentTimeoutHandle=0}this._documentTimeoutHandle=window.setTimeout(BX.delegate(this.saveControl,this),400)}};BX.Crm.EditorFieldSingleEditController.create=function(t,e){var i=new BX.Crm.EditorFieldSingleEditController;i.initialize(t,e);return i}}if(typeof BX.Crm.EditorFieldViewController==="undefined"){BX.Crm.EditorFieldViewController=function(){this._id="";this._settings=null;this._field=null;this._wrapper=null;this._timeoutHandle=0;this._time=0;this._pos={x:0,y:0};this._mouseDownHandler=BX.delegate(this.onMouseDown,this);this._mouseUpHandler=BX.delegate(this.onMouseUp,this);this._isInitialized=false;this._isActive=false};BX.Crm.EditorFieldViewController.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._field=BX.prop.get(this._settings,"field");if(!(this._field instanceof BX.Crm.EntityEditorField)){throw"EditorFieldViewController: The 'field' param must be EntityEditorField."}this._wrapper=BX.prop.getElementNode(this._settings,"wrapper");if(!BX.type.isElementNode(this._wrapper)){throw"EditorFieldSingleEditController: Could not find the wrapper element."}window.setTimeout(BX.delegate(this.bind,this),100);this._isActive=this._isInitialized=true},release:function(){this._isActive=this._isInitialized=false;this.unbind()},bind:function(){if(this._isInitialized){BX.bind(this._wrapper,"mousedown",this._mouseDownHandler);BX.bind(this._wrapper,"mouseup",this._mouseUpHandler)}},unbind:function(){BX.unbind(this._wrapper,"mousedown",this._mouseDownHandler);BX.unbind(this._wrapper,"mouseup",this._mouseUpHandler)},onMouseDown:function(t){if(this._timeoutHandle>0){window.clearTimeout(this._timeoutHandle);this._timeoutHandle=0}if(!this.isHandleableEvent(t)){return}this._time=(new Date).valueOf();this._pos={x:t.clientX,y:t.clientY}},onMouseUp:function(t){if(this._timeoutHandle>0){window.clearTimeout(this._timeoutHandle);this._timeoutHandle=0}if(!this.isHandleableEvent(t)){return}if((new Date).valueOf()-this._time<400||Math.abs(this._pos.x-t.clientX)<2){this._timeoutHandle=window.setTimeout(function(){this.switchTo(BX.getEventTarget(t))}.bind(this),0)}this._time=0},isHandleableEvent:function(t){var e=BX.getEventTarget(t);if(e.tagName==="A"){return false}if(e.getAttribute("data-editor-control-type")==="button"){return false}return!BX.findParent(e,{tagName:"a"},this._wrapper)},switchTo:function(t){this._field.switchToSingleEditMode(t)}};BX.Crm.EditorFieldViewController.create=function(t,e){var i=new BX.Crm.EditorFieldViewController;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorController==="undefined"){BX.Crm.EntityEditorController=function(){this._id="";this._settings={};this._editor=null;this._model=null;this._config=null;this._isChanged=false};BX.Crm.EntityEditorController.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._editor=BX.prop.get(this._settings,"editor",null);this._model=BX.prop.get(this._settings,"model",null);this._config=BX.prop.getObject(this._settings,"config",{});this.doInitialize()},doInitialize:function(){},getConfig:function(){return this._config},getConfigStringParam:function(t,e){return BX.prop.getString(this._config,t,e)},isChanged:function(){return this._isChanged},markAsChanged:function(){if(this._isChanged){return}this._isChanged=true;if(this._editor){this._editor.processControllerChange(this)}},rollback:function(){},innerCancel:function(){},onBeforeSubmit:function(){},onAfterSave:function(){if(this._isChanged){this._isChanged=false}},onBeforesSaveControl:function(t){return t}}}if(typeof BX.Crm.EntityEditorProductRowProxy==="undefined"){BX.Crm.EntityEditorProductRowProxy=function(){BX.Crm.EntityEditorProductRowProxy.superclass.constructor.apply(this);this._externalEditor=null;this._editorCreateHandler=null;this._sumTotalChangeHandler=null;this._productAddHandler=null;this._productChangeHandler=null;this._productRemoveHandler=null;this._editorModeChangeHandler=BX.delegate(this.onEditorModeChange,this);this._editorControlChangeHandler=BX.delegate(this.onEditorControlChange,this);this._currencyId=""};BX.extend(BX.Crm.EntityEditorProductRowProxy,BX.Crm.EntityEditorController);BX.Crm.EntityEditorProductRowProxy.prototype.doInitialize=function(){BX.Crm.EntityEditorProductRowProxy.superclass.doInitialize.apply(this);this._sumTotalChangeHandler=BX.delegate(this.onSumTotalChange,this);this._productAddHandler=BX.delegate(this.onProductAdd,this);this._productChangeHandler=BX.delegate(this.onProductChange,this);this._productRemoveHandler=BX.delegate(this.onProductRemove,this);var t=typeof BX.CrmProductEditor!=="undefined"?BX.CrmProductEditor.get(this.getExternalEditorId()):null;if(t){this.setExternalEditor(t)}else{this._editorCreateHandler=BX.delegate(this.onEditorCreate,this);BX.addCustomEvent(window,"ProductRowEditorCreated",this._editorCreateHandler)}this._editor.addModeChangeListener(this._editorModeChangeHandler);BX.addCustomEvent(window,"onEntityDetailsTabShow",BX.delegate(this.onTabShow,this))};BX.Crm.EntityEditorProductRowProxy.prototype.onTabShow=function(t){if(t.getId()!=="tab_products"){return}if(this._externalEditor&&!this._externalEditor.hasLayout()){this._externalEditor.layout()}};BX.Crm.EntityEditorProductRowProxy.prototype.getExternalEditorId=function(){return this.getConfigStringParam("editorId","")};BX.Crm.EntityEditorProductRowProxy.prototype.setExternalEditor=function(t){if(this._externalEditor===t){return}if(this._externalEditor){this._externalEditor.setForm(null);BX.removeCustomEvent(this._externalEditor,"sumTotalChange",this._sumTotalChangeHandler);BX.removeCustomEvent(this._externalEditor,"productAdd",this._productAddHandler);BX.removeCustomEvent(this._externalEditor,"productChange",this._productChangeHandler);BX.removeCustomEvent(this._externalEditor,"productRemove",this._productRemoveHandler)}this._externalEditor=t;if(this._externalEditor){this._externalEditor.setForm(this._editor.getFormElement());BX.addCustomEvent(this._externalEditor,"sumTotalChange",this._sumTotalChangeHandler);BX.addCustomEvent(this._externalEditor,"productAdd",this._productAddHandler);BX.addCustomEvent(this._externalEditor,"productChange",this._productChangeHandler);BX.addCustomEvent(this._externalEditor,"productRemove",this._productRemoveHandler);this.adjustLocks()}};BX.Crm.EntityEditorProductRowProxy.prototype.adjustLocks=function(){if(!this._externalEditor){return}if(this._externalEditor.getProductCount()>0){this._model.lockField("OPPORTUNITY")}else{this._model.unlockField("OPPORTUNITY")}};BX.Crm.EntityEditorProductRowProxy.prototype.adjustTotals=function(t){this._model.setField("FORMATTED_OPPORTUNITY",t["FORMATTED_SUM"],{enableNotification:false});this._model.setField("FORMATTED_OPPORTUNITY_WITH_CURRENCY",t["FORMATTED_SUM_WITH_CURRENCY"],{enableNotification:false});this._model.setField("OPPORTUNITY",t["SUM"],{enableNotification:true})};BX.Crm.EntityEditorProductRowProxy.prototype.onEditorCreate=function(t){if(t.getId()!==this.getExternalEditorId()){return}BX.removeCustomEvent(window,"ProductRowEditorCreated",this._editorCreateHandler);delete this._editorCreateHandler;this.setExternalEditor(t)};BX.Crm.EntityEditorProductRowProxy.prototype.onEditorModeChange=function(t){if(this._editor.getMode()===BX.Crm.EntityEditorMode.edit){this._editor.addControlChangeListener(this._editorControlChangeHandler)}else{this._editor.removeControlChangeListener(this._editorControlChangeHandler)}this._isChanged=false};BX.Crm.EntityEditorProductRowProxy.prototype.onEditorControlChange=function(t,e){if(!this._externalEditor){return}var i=BX.prop.getString(e,"fieldName","");if(i!=="CURRENCY_ID"){return}var n=BX.prop.getString(e,"fieldValue","");if(n!==""){this._currencyId=n;this._externalEditor.setCurrencyId(this._currencyId)}};BX.Crm.EntityEditorProductRowProxy.prototype.onProductAdd=function(t){this.adjustLocks();this.markAsChanged()};BX.Crm.EntityEditorProductRowProxy.prototype.onProductChange=function(t){this.adjustLocks();this.markAsChanged()};BX.Crm.EntityEditorProductRowProxy.prototype.onProductRemove=function(t){this.adjustLocks();this.markAsChanged()};BX.Crm.EntityEditorProductRowProxy.prototype.onSumTotalChange=function(t,e){this.adjustTotals({FORMATTED_SUM_WITH_CURRENCY:e["TOTAL_SUM_FORMATTED"],FORMATTED_SUM:e["TOTAL_SUM_FORMATTED_SHORT"],SUM:e["TOTAL_SUM"]});this.markAsChanged()};BX.Crm.EntityEditorProductRowProxy.prototype.rollback=function(){var t=this._model.getField("CURRENCY_ID","");if(this._currencyId!==t){this._currencyId=t;if(this._externalEditor){this._externalEditor.setCurrencyId(this._currencyId)}}};BX.Crm.EntityEditorProductRowProxy.prototype.onBeforeSubmit=function(){if(this._externalEditor){this._externalEditor.handleFormSubmit()}};BX.Crm.EntityEditorProductRowProxy.prototype.onBeforesSaveControl=function(t){if(this._externalEditor){t=this._externalEditor.handleControlSave(t)}return t};BX.Crm.EntityEditorProductRowProxy.create=function(t,e){var i=new BX.Crm.EntityEditorProductRowProxy;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorToolPanel==="undefined"){BX.Crm.EntityEditorToolPanel=function(){this._id="";this._settings={};this._container=null;this._wrapper=null;this._editor=null;this._isVisible=false;this._isLocked=false;this._hasLayout=false;this._keyPressHandler=BX.delegate(this.onKeyPress,this)};BX.Crm.EntityEditorToolPanel.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._container=BX.prop.getElementNode(this._settings,"container",null);this._editor=BX.prop.get(this._settings,"editor",null);this._isVisible=BX.prop.getBoolean(this._settings,"visible",false)},getId:function(){return this._id},getContainer:function(){return this._container},setContainer:function(t){this._container=t},isVisible:function(){return this._isVisible},setVisible:function(t){t=!!t;if(this._isVisible===t){return}this._isVisible=t;this.adjustLayout()},isLocked:function(){return this._isLocked},setLocked:function(t){t=!!t;if(this._isLocked===t){return}this._isLocked=t;if(t){BX.addClass(this._editButton,"ui-btn-clock")}else{BX.removeClass(this._editButton,"ui-btn-clock")}},disableSaveButton:function(){if(!this._editButton){return}this._editButton.disabled=true;BX.addClass(this._editButton,"ui-btn-disabled")},enableSaveButton:function(){if(!this._editButton){return}this._editButton.disabled=false;BX.removeClass(this._editButton,"ui-btn-disabled")},isSaveButtonEnabled:function(){return this._editButton&&!this._editButton.disabled},layout:function(){this._editButton=BX.create("button",{props:{className:"ui-btn ui-btn-success",title:"[Ctrl+Enter]"},text:BX.message("CRM_EDITOR_SAVE"),events:{click:BX.delegate(this.onSaveButtonClick,this)}});this._cancelButton=BX.create("a",{props:{className:"ui-btn ui-btn-link",title:"[Esc]"},text:BX.message("CRM_EDITOR_CANCEL"),attrs:{href:"#"},events:{click:BX.delegate(this.onCancelButtonClick,this)}});this._errorContainer=BX.create("DIV",{props:{className:"crm-entity-section-control-error-block"}});this._errorContainer.style.maxHeight="0";this._wrapper=BX.create("DIV",{props:{className:"crm-entity-wrap"},children:[BX.create("DIV",{props:{className:"crm-entity-section crm-entity-section-control"},children:[this._editButton,this._cancelButton,this._errorContainer]})]});this._container.appendChild(this._wrapper);this._hasLayout=true;this.adjustLayout()},adjustLayout:function(){if(!this._hasLayout){return}if(!this._isVisible){BX.removeClass(this._wrapper,"crm-section-control-active");BX.unbind(document,"keydown",this._keyPressHandler)}else{BX.addClass(this._wrapper,"crm-section-control-active");BX.bind(document,"keydown",this._keyPressHandler)}},getPosition:function(){return this._hasLayout?BX.pos(this._wrapper):null}};BX.Crm.EntityEditorToolPanel.prototype.onSaveButtonClick=function(t){if(!this._isLocked){this._editor.saveChanged()}};BX.Crm.EntityEditorToolPanel.prototype.onCancelButtonClick=function(t){if(!this._isLocked){this._editor.cancel()}return BX.eventReturnFalse(t)};BX.Crm.EntityEditorToolPanel.prototype.onKeyPress=function(t){if(!this._isVisible){return}if(BX.Crm.EditorAuxiliaryDialog.hasOpenItems()){return}if(BX.type.isFunction(BX.PopupWindowManager.isAnyPopupShown)&&BX.PopupWindowManager.isAnyPopupShown()){return}t=t||window.event;if(t.keyCode==27){this._editor.cancel();BX.eventCancelBubble(t)}else if(t.keyCode==13&&t.ctrlKey){this._editor.saveChanged();BX.eventCancelBubble(t)}};BX.Crm.EntityEditorToolPanel.prototype.addError=function(t){this._errorContainer.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-section-control-error-text"},html:t}));this._errorContainer.style.maxHeight=""};BX.Crm.EntityEditorToolPanel.prototype.clearErrors=function(){this._errorContainer.innerHTML="";this._errorContainer.style.maxHeight="0px"};BX.Crm.EntityEditorToolPanel.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorToolPanel.messages;return e.hasOwnProperty(t)?e[t]:t};if(typeof BX.Crm.EntityEditorToolPanel.messages==="undefined"){BX.Crm.EntityEditorToolPanel.messages={}}BX.Crm.EntityEditorToolPanel.create=function(t,e){var i=new BX.Crm.EntityEditorToolPanel;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorFieldSelector==="undefined"){BX.Crm.EntityEditorFieldSelector=function(){this._id="";this._settings={};this._scheme=null;this._excludedNames=null;this._closingNotifier=null;this._contentWrapper=null;this._popup=null};BX.Crm.EntityEditorFieldSelector.prototype={initialize:function(t,e){this._id=t;this._settings=e?e:{};this._scheme=BX.prop.get(this._settings,"scheme",null);if(!this._scheme){throw"BX.Crm.EntityEditorFieldSelector. Parameter 'scheme' is not found."}this._excludedNames=BX.prop.getArray(this._settings,"excludedNames",[]);this._closingNotifier=BX.CrmNotifier.create(this)},getMessage:function(t){return BX.prop.getString(BX.Crm.EntityEditorFieldSelector.messages,t,t)},isSchemeElementEnabled:function(t){var e=t.getName();for(var i=0,n=this._excludedNames.length;i<n;i++){if(this._excludedNames[i]===e){return false}}return true},addClosingListener:function(t){this._closingNotifier.addListener(t)},removeClosingListener:function(t){this._closingNotifier.removeListener(t)},isOpened:function(){return this._popup&&this._popup.isShown()},open:function(){if(this.isOpened()){return}this._popup=new BX.PopupWindow(this._id,null,{autoHide:false,draggable:true,bindOptions:{forceBindPosition:false},closeByEsc:true,closeIcon:{},zIndex:1,titleBar:BX.prop.getString(this._settings,"title",""),events:{onPopupClose:BX.delegate(this._onPopupClose,this),onPopupDestroy:BX.delegate(this._onPopupDestroy,this)},content:this.prepareContent(),lightShadow:true,contentNoPaddings:true,buttons:[new BX.PopupWindowButton({text:this.getMessage("select"),className:"ui-btn ui-btn-success",events:{click:BX.delegate(this.onAcceptButtonClick,this)}}),new BX.PopupWindowButtonLink({text:this.getMessage("cancel"),className:"ui-btn ui-btn-link",events:{click:BX.delegate(this.onCancelButtonClick,this)}})]});this._popup.show()},close:function(){if(!(this._popup&&this._popup.isShown())){return}this._popup.close()},prepareContent:function(){this._contentWrapper=BX.create("div",{props:{className:"crm-entity-field-selector-window"}});var t=BX.create("div",{props:{className:"crm-entity-field-selector-window-list"}});this._contentWrapper.appendChild(t);var e=this._scheme.getElements();for(var i=0;i<e.length;i++){var n=e[i];if(!this.isSchemeElementEnabled(n)){continue}var r=[];var o=n.getElements();var s;for(var a=0;a<o.length;a++){s=o[a];if(s.isTransferable()&&s.getName()!==""){r.push(s)}}if(r.length===0){continue}var l=n.getName();var d=n.getTitle();t.appendChild(BX.create("div",{attrs:{className:"crm-entity-field-selector-window-list-caption"},text:d}));for(var h=0;h<r.length;h++){s=r[h];var p=s.getName();var u=s.getTitle();var c=l+"\\"+p;var m=BX.create("div",{attrs:{className:"crm-entity-field-selector-window-list-item"}});t.appendChild(m);m.appendChild(BX.create("input",{attrs:{id:c,type:"checkbox",className:"crm-entity-field-selector-window-list-checkbox"}}));m.appendChild(BX.create("label",{attrs:{for:c,className:"crm-entity-field-selector-window-list-label"},text:u}))}}return this._contentWrapper},getSelectedItems:function(){if(!this._contentWrapper){return[]}var t=[];var e=this._contentWrapper.querySelectorAll("input.crm-entity-field-selector-window-list-checkbox");for(var i=0,n=e.length;i<n;i++){var r=e[i];if(r.checked){var o=r.id.split("\\");if(o.length>=2){t.push({sectionName:o[0],fieldName:o[1]})}}}return t},onAcceptButtonClick:function(){this._closingNotifier.notify([{isCanceled:false,items:this.getSelectedItems()}]);this.close()},onCancelButtonClick:function(){this._closingNotifier.notify([{isCanceled:true}]);this.close()},onPopupClose:function(){if(this._popup){this._contentWrapper=null;this._popup.destroy()}},onPopupDestroy:function(){if(!this._popup){return}this._contentWrapper=null;this._popup=null}};if(typeof BX.Crm.EntityEditorFieldSelector.messages==="undefined"){BX.Crm.EntityEditorFieldSelector.messages={}}BX.Crm.EntityEditorFieldSelector.create=function(t,e){var i=new BX.Crm.EntityEditorFieldSelector(t,e);i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorUserSelector==="undefined"){BX.Crm.EntityEditorUserSelector=function(){this._id="";this._settings={}};BX.Crm.EntityEditorUserSelector.prototype={initialize:function(t,e){this._id=t;this._settings=e?e:{};this._isInitialized=false},getId:function(){return this._id},open:function(t){if(this._mainWindow&&this._mainWindow===BX.SocNetLogDestination.containerWindow){return}if(!this._isInitialized){BX.SocNetLogDestination.init({name:this._id,extranetUser:false,bindMainPopup:{node:t,offsetTop:"5px",offsetLeft:"15px"},callback:{select:BX.delegate(this.onSelect,this)},showSearchInput:true,departmentSelectDisable:true,items:{users:BX.Crm.EntityEditorUserSelector.users,groups:{},sonetgroups:{},department:BX.Crm.EntityEditorUserSelector.department,departmentRelation:BX.SocNetLogDestination.buildDepartmentRelation(BX.Crm.EntityEditorUserSelector.department)},itemsLast:BX.Crm.EntityEditorUserSelector.last,itemsSelected:{},isCrmFeed:false,useClientDatabase:false,destSort:{},allowAddUser:false,allowSearchCrmEmailUsers:false,allowUserSearch:true});this._isInitialized=true}BX.SocNetLogDestination.openDialog(this._id,{bindNode:t});this._mainWindow=BX.SocNetLogDestination.containerWindow},close:function(){if(this._mainWindow&&this._mainWindow===BX.SocNetLogDestination.containerWindow){BX.SocNetLogDestination.closeDialog();this._mainWindow=null;this._isInitialized=false}},onSelect:function(t,e,i,n){if(e!=="users"){return}var r=BX.prop.getFunction(this._settings,"callback",null);if(r){r(this,t)}}};BX.Crm.EntityEditorUserSelector.items={};BX.Crm.EntityEditorUserSelector.create=function(t,e){var i=new BX.Crm.EntityEditorUserSelector(t,e);i.initialize(t,e);this.items[i.getId()]=i;return i}}if(typeof BX.Crm.EntityEditorCrmSelector==="undefined"){BX.Crm.EntityEditorCrmSelector=function(){this._id="";this._settings={};this._entityTypeIds=[];this._supportedItemTypes={}};BX.Crm.EntityEditorCrmSelector.prototype={initialize:function(t,e){this._id=t;this._settings=e?e:{};this._isInitialized=false;this._entityTypeIds=BX.prop.getArray(this._settings,"entityTypeIds",[]);this._supportedItemTypes=[];for(var i=0,n=this._entityTypeIds.length;i<n;i++){var r=this._entityTypeIds[i];if(r===BX.CrmEntityType.enumeration.contact){this._supportedItemTypes.push({name:"contacts",altName:"CRMCONTACT"})}else if(r===BX.CrmEntityType.enumeration.company){this._supportedItemTypes.push({name:"companies",altName:"CRMCOMPANY"})}else if(r===BX.CrmEntityType.enumeration.lead){this._supportedItemTypes.push({name:"leads",altName:"CRMLEAD"})}else if(r===BX.CrmEntityType.enumeration.deal){this._supportedItemTypes.push({name:"deals",altName:"CRMDEAL"})}}},getId:function(){return this._id},isOpened:function(){return BX.SocNetLogDestination.isOpenDialog()},open:function(t){if(this.isOpened()){return}if(this._mainWindow&&this._mainWindow===BX.SocNetLogDestination.containerWindow){return}if(!this._isInitialized){var e={};var i={};var n=[];for(var r=0,o=this._supportedItemTypes.length;r<o;r++){var s=this._supportedItemTypes[r];e[s.name]=BX.Crm.EntityEditorCrmSelector[s.name];i[s.name]=BX.Crm.EntityEditorCrmSelector[s.name+"Last"];n.push(s.altName)}i["crm"]={};var a={name:this._id,extranetUser:false,bindMainPopup:{node:t,offsetTop:"20px",offsetLeft:"20px"},callback:{select:BX.delegate(this.onSelect,this)},showSearchInput:true,departmentSelectDisable:true,items:e,itemsLast:i,itemsSelected:{},useClientDatabase:false,destSort:{},allowAddUser:false,allowSearchCrmEmailUsers:false,allowUserSearch:false,isCrmFeed:true,CrmTypes:n};if(BX.prop.getBoolean(this._settings,"enableMyCompanyOnly",false)){a["enableMyCrmCompanyOnly"]=true}BX.SocNetLogDestination.init(a);this._isInitialized=true}BX.SocNetLogDestination.openDialog(this._id,{bindNode:t});this._mainWindow=BX.SocNetLogDestination.containerWindow},close:function(){if(!this.isOpened()){return}if(this._mainWindow&&this._mainWindow===BX.SocNetLogDestination.containerWindow){BX.SocNetLogDestination.closeDialog();this._mainWindow=null}},onSelect:function(t,e,i,n,r,o){if(o!=="select"){return}var s=false;for(var a=0,l=this._supportedItemTypes.length;a<l;a++){var d=this._supportedItemTypes[a];if(d.name===e){s=true;break}}if(!s){return}var h=BX.prop.getFunction(this._settings,"callback",null);if(h){h(this,t)}}};if(typeof BX.Crm.EntityEditorCrmSelector.contacts==="undefined"){BX.Crm.EntityEditorCrmSelector.contacts={}}if(typeof BX.Crm.EntityEditorCrmSelector.contactsLast==="undefined"){BX.Crm.EntityEditorCrmSelector.contactsLast={}}if(typeof BX.Crm.EntityEditorCrmSelector.companies==="undefined"){BX.Crm.EntityEditorCrmSelector.companies={}}if(typeof BX.Crm.EntityEditorCrmSelector.companiesLast==="undefined"){BX.Crm.EntityEditorCrmSelector.companiesLast={}}if(typeof BX.Crm.EntityEditorCrmSelector.leads==="undefined"){BX.Crm.EntityEditorCrmSelector.leads={}}if(typeof BX.Crm.EntityEditorCrmSelector.leadsLast==="undefined"){BX.Crm.EntityEditorCrmSelector.leadsLast={}}if(typeof BX.Crm.EntityEditorCrmSelector.deals==="undefined"){BX.Crm.EntityEditorCrmSelector.deals={}}if(typeof BX.Crm.EntityEditorCrmSelector.dealsLast==="undefined"){BX.Crm.EntityEditorCrmSelector.dealsLast={}}BX.Crm.EntityEditorCrmSelector.items={};BX.Crm.EntityEditorCrmSelector.create=function(t,e){var i=new BX.Crm.EntityEditorCrmSelector(t,e);i.initialize(t,e);this.items[i.getId()]=i;return i}}if(typeof BX.Crm.EntityBizprocManager==="undefined"){BX.Crm.EntityBizprocManager=function(){this._id="";this._settings={};this._moduleId="";this._entity="";this._documentType="";this._autoExecuteType=0;this._containerId=null;this._fieldName=null;this._validParameters=null;this._formInput=null;this._editor=null;this._starter=null};BX.Crm.EntityBizprocManager.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._hasParameters=BX.prop.getBoolean(this._settings,"hasParameters",false);this._moduleId=BX.prop.getString(this._settings,"moduleId","");this._entity=BX.prop.getString(this._settings,"entity","");this._documentType=BX.prop.getString(this._settings,"documentType","");this._autoExecuteType=BX.prop.getInteger(this._settings,"autoExecuteType",0);this._containerId=BX.prop.getString(this._settings,"containerId","");this._fieldName=BX.prop.getString(this._settings,"fieldName","");this._contentNode=this._containerId?BX(this._containerId):null;if(this._hasParameters){this._starter=new BX.Bizproc.Starter({moduleId:this._moduleId,entity:this._entity,documentType:this._documentType})}},onBeforeSave:function(t){var e=new BX.Promise;var i=function(){window.setTimeout(BX.delegate(function(){e.fulfill()},this),0)};if(t.getStatus()&&this._hasParameters&&this._validParameters===null){try{this._starter.showAutoStartParametersPopup(this._autoExecuteType,{contentNode:this._contentNode,callback:this.onFillParameters.bind(this,e)});this._contentNode=null}catch(t){if("console"in window){window.console.log("Error occurred when bizproc popup is going to show",t)}i()}}else{i()}return e},onAfterSave:function(){this._validParameters=null},onFillParameters:function(t,e){this._validParameters=e.parameters;if(!this._formInput&&this._editor){var i=this._editor.getFormElement();this._formInput=BX.create("input",{props:{type:"hidden",name:this._fieldName}});i.appendChild(this._formInput)}if(this._formInput){this._formInput.value=this._validParameters}t.fulfill()}};if(typeof BX.Crm.EntityBizprocManager.messages==="undefined"){BX.Crm.EntityBizprocManager.messages={}}BX.Crm.EntityBizprocManager.items={};BX.Crm.EntityBizprocManager.create=function(t,e){var i=new BX.Crm.EntityBizprocManager;i.initialize(t,e);this.items[t]=i;return i}}if(typeof BX.Crm.EntityRestPlacementManager==="undefined"){BX.Crm.EntityRestPlacementManager=function(){this._id="";this._entity="";this._editor=null};BX.Crm.EntityRestPlacementManager.items={};BX.Crm.EntityRestPlacementManager.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._entity=this.getSetting("entity");var i=BX(this.getSetting("bottom_button_id"));if(i){BX.bind(i,"click",BX.proxy(this.openMarketplace,this))}BX.defer(this.initializeInterface,this)()},openMarketplace:function(){BX.rest.Marketplace.open({PLACEMENT:this.getSetting("placement")})},getSetting:function(t){return BX.prop.getString(this._settings,t,"")},initializeInterface:function(){if(!!BX.rest&&!!BX.rest.AppLayout){var t=BX.rest.AppLayout.initializePlacement("CRM_"+this._entity+"_DETAIL_TAB");var e=this._editor._entityTypeId,i=this._editor._entityId;t.prototype.resizeWindow=function(t,e){var i=BX(this.params.layoutName);t.height=parseInt(t.height);if(!!t.height){i.style.height=t.height+"px"}var n=BX.pos(i);e({width:n.width,height:n.height})};t.prototype.reloadData=function(t,n){BX.Crm.EntityEvent.fireUpdate(e,i,"");n()}}}};BX.Crm.EntityRestPlacementManager.create=function(t,e){var i=new BX.Crm.EntityRestPlacementManager;i.initialize(t,e);this.items[t]=i;return i}}
/* End */
;
; /* Start:"a:4:{s:4:"full";s:96:"/bitrix/components/bitrix/crm.entity.editor/templates/.default/js/control.min.js?157530075111217";s:6:"source";s:76:"/bitrix/components/bitrix/crm.entity.editor/templates/.default/js/control.js";s:3:"min";s:80:"/bitrix/components/bitrix/crm.entity.editor/templates/.default/js/control.min.js";s:3:"map";s:80:"/bitrix/components/bitrix/crm.entity.editor/templates/.default/js/control.map.js";}"*/
BX.namespace("BX.Crm");if(typeof BX.Crm.EntityEditorMultipleUser==="undefined"){BX.Crm.EntityEditorMultipleUser=function(){BX.Crm.EntityEditorMultipleUser.superclass.constructor.apply(this);this._input=null;this._userSelector=null;this._map=null;this._infos=null;this._items=null;this._innerWrapper=null;this._topButton=null;this._bottomButton=null;this._topButtonClickHandler=BX.delegate(this.onTopButtonClick,this);this._bottomButtonClickHandler=BX.delegate(this.onBottomButtonClick,this)};BX.extend(BX.Crm.EntityEditorMultipleUser,BX.Crm.EntityEditorField);BX.Crm.EntityEditorMultipleUser.prototype.isSingleEditEnabled=function(){return true};BX.Crm.EntityEditorMultipleUser.prototype.doInitialize=function(){this._map=this._schemeElement.getDataObjectParam("map",{});this.initializeItems()};BX.Crm.EntityEditorMultipleUser.prototype.initializeItems=function(){this._infos=this._model.getSchemeField(this._schemeElement,"infos",[]);this._items=[];for(var t=0,e=this._infos.length;t<e;t++){this.addItem(this._infos[t])}};BX.Crm.EntityEditorMultipleUser.prototype.getItemCount=function(){return this._items!==null?this._items.length:0};BX.Crm.EntityEditorMultipleUser.prototype.findItemIndexById=function(t){if(!BX.type.isNumber(t)){t=parseInt(t);if(isNaN(t)){t=0}}for(var e=0,i=this._items.length;e<i;e++){if(this._items[e].getValue()===t){return e}}return-1};BX.Crm.EntityEditorMultipleUser.prototype.findItemIndex=function(t){if(!this._items){return-1}for(var e=0,i=this._items.length;e<i;e++){if(this._items[e]===t){return e}}return-1};BX.Crm.EntityEditorMultipleUser.prototype.addItem=function(t){var e=BX.Crm.EntityEditorMultipleUserItem.create("",{parent:this,data:t});if(this._items===null){this._items=[]}this._items.push(e);if(this._hasLayout){e.setMode(this._mode);e.setContainer(this._innerWrapper);e.layout()}return e};BX.Crm.EntityEditorMultipleUser.prototype.deleteItem=function(t){if(!this._items){return}var e=this.findItemIndex(t);if(e>=0){t.clearLayout();t.setContainer(null);this._items.splice(e,1)}};BX.Crm.EntityEditorMultipleUser.prototype.adjust=function(){if(this.isInViewMode()){return}if(this.getItemCount()===0&&this._input===null){this._input=BX.create("input",{attrs:{name:this.getDataKey(),type:"hidden"}});this._wrapper.appendChild(this._input)}else if(this.getItemCount()>0&&this._input!==null){this._input=BX.remove(this._input)}};BX.Crm.EntityEditorMultipleUser.prototype.isSingleEditEnabled=function(){return true};BX.Crm.EntityEditorMultipleUser.prototype.hasContentToDisplay=function(){if(this._mode===BX.Crm.EntityEditorMode.edit){return true}return this._model.getMappedField(this._map,"data",[]).length>0};BX.Crm.EntityEditorMultipleUser.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated();this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}var e=this._schemeElement.getTitle();this._wrapper.appendChild(this.createTitleNode(e));if(this.hasContentToDisplay()){this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"}});this._wrapper.appendChild(this._innerWrapper);for(var i=0,n=this._items.length;i<n;i++){var r=this._items[i];r.setMode(this._mode);r.setContainer(this._innerWrapper);r.layout()}if(this.isInEditMode()){this._bottomButton=BX.create("span",{props:{className:"crm-entity-widget-content-add-employees"},text:BX.prop.getString(this._schemeElement.getDataObjectParam("messages",{}),"addObserver",BX.message("CRM_EDITOR_ADD")),events:{click:this._bottomButtonClickHandler}});this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block-add-field"},children:[this._bottomButton]}))}}else{this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},text:this.getMessage("isEmpty")});this._wrapper.appendChild(this._innerWrapper)}if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.adjust();this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorMultipleUser.prototype.doRegisterLayout=function(){if(this.isInEditMode()&&this.checkModeOption(BX.Crm.EntityEditorModeOptions.individual)){window.setTimeout(function(){this.getSelector().open(this._bottomButton)}.bind(this),500)}};BX.Crm.EntityEditorMultipleUser.prototype.doClearLayout=function(t){this._input=null;for(var e=0,i=this._items.length;e<i;e++){var n=this._items[e];n.clearLayout();n.setContainer(null)}this._innerWrapper=null;if(this._topButton){BX.unbind(this._topButton,"click",this._topButtonClickHandler);this._topButton=null}if(this._bottomButton){BX.unbind(this._bottomButton,"click",this._bottomButtonClickHandler);this._bottomButton=null}};BX.Crm.EntityEditorMultipleUser.prototype.createTitleActionControls=function(){var t=[];if(this.isInViewMode()&&this.isEditInViewEnabled()&&!this.isReadOnly()){this._topButton=BX.create("span",{props:{className:"crm-entity-widget-content-block-title-action-btn"},text:BX.message("CRM_EDITOR_ADD"),events:{click:this._topButtonClickHandler}});t.push(this._topButton)}return t};BX.Crm.EntityEditorMultipleUser.prototype.getDataKey=function(){return BX.prop.getString(this._map,"data",this.getName())};BX.Crm.EntityEditorMultipleUser.prototype.save=function(){var t=[];var e=[];for(var i=0,n=this._items.length;i<n;i++){var r=this._items[i];t.push(r.getValue());e.push(r.getData())}this._infos=e;this._model.setMappedField(this._map,"data",t);this._model.setSchemeField(this._schemeElement,"infos",e)};BX.Crm.EntityEditorMultipleUser.prototype.onTopButtonClick=function(t){if(this._mode===BX.Crm.EntityEditorMode.view&&this.isEditInViewEnabled()&&this.getEditor().isChanged()){this.switchToSingleEditMode()}else{this.getSelector().open(this._topButton)}};BX.Crm.EntityEditorMultipleUser.prototype.onBottomButtonClick=function(t){this.getSelector().open(this._bottomButton)};BX.Crm.EntityEditorMultipleUser.prototype.getSelector=function(){if(!this._userSelector){this._userSelector=BX.Crm.EntityEditorUserSelector.create(this._id,{callback:BX.delegate(this.processItemSelect,this)})}return this._userSelector};BX.Crm.EntityEditorMultipleUser.prototype.processItemSelect=function(t,e){if(!(this.isInEditMode()||this.isEditInViewEnabled()&&!this.isReadOnly())){return}var i=BX.prop.getInteger(e,"entityId",0);if(this.findItemIndexById(i)>=0){this._userSelector.close();return}var n={ID:i,PHOTO_URL:BX.prop.getString(e,"avatar",""),FORMATTED_NAME:BX.util.htmlspecialcharsback(BX.prop.getString(e,"name","")),WORK_POSITION:BX.util.htmlspecialcharsback(BX.prop.getString(e,"desc",""))};n["SHOW_URL"]=this._schemeElement.getDataStringParam("pathToProfile","").replace(/#user_id#/gi,n["ID"]);this.addItem(n);this._userSelector.close();this.adjust();if(this.isInEditMode()){this.markAsChanged()}else{this._editor.saveControl(this)}};BX.Crm.EntityEditorMultipleUser.prototype.processModelChange=function(t){if(BX.prop.get(t,"originator",null)===this){return}if(!BX.prop.getBoolean(t,"forAll",false)&&BX.prop.getString(t,"name","")!==this.getName()){return}this.refreshLayout()};BX.Crm.EntityEditorMultipleUser.prototype.processItemDeletion=function(t){this.deleteItem(t);this.adjust();this.markAsChanged()};BX.Crm.EntityEditorMultipleUser.prototype.getRuntimeValue=function(){if(this._mode===BX.Crm.EntityEditorMode.edit&&this._selectedData["id"]>0){return this._selectedData["id"]}return""};BX.Crm.EntityEditorMultipleUser.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorMultipleUser.messages;return e.hasOwnProperty(t)?e[t]:BX.Crm.EntityEditorMultipleUser.superclass.getMessage.apply(this,arguments)};if(typeof BX.Crm.EntityEditorMultipleUser.messages==="undefined"){BX.Crm.EntityEditorMultipleUser.messages={}}BX.Crm.EntityEditorMultipleUser.create=function(t,e){var i=new BX.Crm.EntityEditorMultipleUser;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorMultipleUserItem==="undefined"){BX.Crm.EntityEditorMultipleUserItem=function(){this._id="";this._settings=null;this._parent=null;this._editor=null;this._mode=BX.Crm.EntityEditorMode.view;this._data=null;this._container=null;this._wrapper=null;this._photoElement=null;this._nameElement=null;this._positionElement=null;this._input=null;this._deleteButton=null;this._deleteButtonHandler=BX.delegate(this.onDeleteButtonClick,this);this._hasLayout=false};BX.Crm.EntityEditorMultipleUserItem.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"";this._settings=e?e:{};this._parent=BX.prop.get(this._settings,"parent",null);this._editor=this._parent.getEditor();this._data=BX.prop.getObject(this._settings,"data",{})},getValue:function(){return BX.prop.getInteger(this._data,"ID",0)},getMode:function(){return this._mode},setMode:function(t){this._mode=t},getData:function(){return this._data},setData:function(t){this._data=t},getContainer:function(){return this._container},setContainer:function(t){this._container=t},getIndex:function(){return this._parent.findItemIndex(this)},layout:function(){if(this._hasLayout){return}var t=BX.prop.getInteger(this._data,"ID",0);var e=BX.prop.getString(this._data,"FORMATTED_NAME","");var i=BX.prop.getString(this._data,"WORK_POSITION","");var n=BX.prop.getString(this._data,"SHOW_URL","");var r=BX.prop.getString(this._data,"PHOTO_URL","");this._photoElement=BX.create("a",{props:{className:"crm-widget-employee-avatar-container",target:"_blank"},style:{backgroundImage:r!==""?"url('"+r+"')":"",backgroundSize:r!==""?"30px":""}});this._nameElement=BX.create("a",{props:{className:"crm-widget-employee-name",target:"_blank"},text:e});if(n!==""){this._photoElement.href=n;this._nameElement.href=n}this._positionElement=BX.create("SPAN",{props:{className:"crm-widget-employee-position"},text:i});this._wrapper=BX.create("div",{props:{className:"crm-widget-employee-container"}});this._deleteButton=null;if(this._mode===BX.Crm.EntityEditorMode.edit){this._deleteButton=BX.create("div",{props:{className:"crm-widget-employee-remove"},text:BX.message("CRM_EDITOR_DELETE")});BX.bind(this._deleteButton,"click",this._deleteButtonHandler);this._wrapper.appendChild(this._deleteButton)}this._wrapper.appendChild(this._photoElement);this._wrapper.appendChild(BX.create("span",{props:{className:"crm-widget-employee-info"},children:[this._nameElement,this._positionElement]}));if(this._parent.isInEditMode()){this._input=BX.create("input",{attrs:{name:this._parent.getDataKey()+"["+this.getIndex()+"]",type:"hidden",value:t}});this._wrapper.appendChild(this._input)}this._container.appendChild(this._wrapper);this._hasLayout=true},clearLayout:function(){if(!this._hasLayout){return}if(this._deleteButton){BX.unbind(this._deleteButton,"click",this._deleteButtonHandler);this._deleteButton=null}this._input=null;this._photoElement=this._nameElement=this._positionElement=null;this._wrapper=BX.remove(this._wrapper);this._hasLayout=false},onDeleteButtonClick:function(t){this._parent.processItemDeletion(this)}};BX.Crm.EntityEditorMultipleUserItem.create=function(t,e){var i=new BX.Crm.EntityEditorMultipleUserItem;i.initialize(t,e);return i}}
/* End */
;; /* /bitrix/components/bitrix/main.interface.buttons/templates/.default/script.min.js?157530074640309*/
; /* /bitrix/components/bitrix/main.interface.buttons/templates/.default/utils.min.js?1575300746575*/
; /* /bitrix/components/bitrix/crm.entity.counter.panel/templates/.default/script.min.js?15753007515274*/
; /* /bitrix/components/bitrix/crm.lead.menu/templates/.default/script.js?1575300750481*/
; /* /bitrix/components/bitrix/crm.interface.toolbar/templates/title/script.min.js?15753007512568*/
; /* /bitrix/components/bitrix/crm.interface.filter/templates/title/script.min.js?15753007512949*/
; /* /bitrix/components/bitrix/main.ui.selector/templates/.default/script.min.js?157530074613009*/
; /* /bitrix/components/bitrix/main.ui.filter/templates/.default/script.min.js?1575300746147320*/
; /* /bitrix/components/bitrix/crm.kanban/templates/.default/script.min.js?15753007507230*/
; /* /bitrix/components/bitrix/crm.entity.editor/templates/.default/script.min.js?1575300751505963*/
; /* /bitrix/components/bitrix/crm.entity.editor/templates/.default/js/control.min.js?157530075111217*/

//# sourceMappingURL=page_03d4640b09d618fcc863a538a3bf2030.map.js